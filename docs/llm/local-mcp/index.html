<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.27.1 by Michael Rose
  Copyright 2013-2025 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->

<html lang="en-US" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>LLM Local MCP - ARCHIVE</title>
<meta name="description" content="">


  <meta name="author" content="hvppyarchive">
  
  <meta property="article:author" content="hvppyarchive">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="ARCHIVE">
<meta property="og:title" content="LLM Local MCP">
<meta property="og:url" content="https://hvppyarchive.github.io/llm/local-mcp/">


  <meta property="og:description" content="">







  <meta property="article:published_time" content="2025-10-17T19:56:32+09:00">





  

  


<link rel="canonical" href="https://hvppyarchive.github.io/llm/local-mcp/">












<!-- end _includes/seo.html -->


<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
  
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css"></noscript>



    <!-- start custom head snippets -->
<!-- hvppyarchive: add fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@200..900&display=swap" rel="stylesheet">

<!-- insert favicons. use https://realfavicongenerator.net/ -->
 <!-- hvppyarchive: add favicons -->
<link rel="icon" type="image/png" href="/assets/favicon/favicon-96x96.png" sizes="96x96" />
<link rel="icon" type="image/svg+xml" href="/assets/favicon/favicon.svg" />
<link rel="shortcut icon" href="/assets/favicon/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon/apple-touch-icon.png" />
<link rel="manifest" href="/assets/favicon/site.webmanifest" />

<!-- end custom head snippets -->

  </head>

  <body class="layout--single" dir="ltr">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          ARCHIVE
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a
                href="/year-archive/"
                
                
              >Posts</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <i class="fas fa-search"></i>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      





<div id="main" role="main">
  


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="LLM Local MCP">
    <meta itemprop="description" content="">
    <meta itemprop="datePublished" content="2025-10-17T19:56:32+09:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">
            <a href="https://hvppyarchive.github.io/llm/local-mcp/" itemprop="url">LLM Local MCP
</a>
          </h1>
          

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <!-- hvppyarchive: remove date icon
        <i class="far fa-calendar-alt" aria-hidden="true"></i> 
        -->
        
        <time datetime="2025-10-17T19:56:32+09:00">2025-10-17</time>
      </span>
    

    

    
  </p>


        </header>
      

      <section class="page__content" itemprop="text">
        
        <p class="chat--user">

LLM MCP 동작 원리

</p>

<p>좋은 질문이에요! “MCP(Model Context Protocol)”는 LLM 앱이 바깥 세계의 데이터와 도구에 안전하게 붙는 표준 대화 규약이에요. 아래처럼 “누가 누구와, 어떤 순서로, 무엇을 주고받는지”를 단계별로 정리해 드릴게요.</p>

<h1 id="한-줄-요약">한 줄 요약</h1>

<p>LLM 앱(호스트)이 <strong>클라이언트</strong> 를 통해 하나 이상의 <strong>MCP 서버</strong> 와 상태 유지 연결을 맺고, JSON-RPC 메시지로 <strong>리소스(Resources)</strong> ·<strong>프롬프트(Prompts)</strong> ·<strong>툴(Tools)</strong>을 발견→호출→결과를 받는 흐름입니다. <a href="https://modelcontextprotocol.io/specification/2025-06-18">Model Context Protocol+1</a></p>

<h1 id="구성요소역할">구성요소(역할)</h1>

<ol>
  <li>
    <p><strong>Host(호스트)</strong> : 채팅앱/IDE처럼 LLM이 뛰는 “컨테이너”. 여러 MCP <strong>클라이언트</strong> 를 만들고 권한·보안을 관리합니다. 전체 대화 맥락도 이쪽이 쥡니다. <a href="https://modelcontextprotocol.io/specification/2025-06-18/architecture">Model Context Protocol</a></p>
  </li>
  <li>
    <p><strong>Client(클라이언트)</strong> : 특정 MCP <strong>서버</strong> 와 1:1 세션을 맺는 커넥터. 기능(캡퍼빌리티) 교섭과 메시지 라우팅을 담당합니다. <a href="https://modelcontextprotocol.io/specification/2025-06-18/architecture">Model Context Protocol</a></p>
  </li>
  <li>
    <p><strong>Server(서버)</strong> : 리소스/프롬프트/툴을 “제공”하는 쪽. 로컬 프로세스일 수도, 원격 서비스일 수도 있어요. <a href="https://modelcontextprotocol.io/specification/2025-06-18/architecture">Model Context Protocol</a></p>
  </li>
</ol>

<h1 id="통신-방식전송">통신 방식(전송)</h1>

<ul>
  <li>메시지 포맷은 <strong>JSON-RPC 2.0</strong>. 전송은 주로 <strong>stdio</strong>(서브프로세스 표준입출력) 또는 <strong>Streamable HTTP</strong>(POST/GET+SSE 옵션) 두 가지가 표준입니다. <a href="https://modelcontextprotocol.io/specification/2025-06-18/basic/transports">Model Context Protocol</a></li>
</ul>

<h1 id="세션-수명주기핵심-단계">세션 수명주기(핵심 단계)</h1>

<ol>
  <li>
    <p><strong>initialize 요청</strong> : 클라이언트가 먼저 “지원 프로토콜 버전+클라이언트 기능”을 보냅니다.</p>
  </li>
  <li>
    <p><strong>initialize 응답</strong> : 서버가 “서버 기능(리소스/프롬프트/툴 등)”과 서버 정보, 선택적 지시문을 돌려줍니다.</p>
  </li>
  <li>
    <p><strong>initialized 알림</strong> : 클라이언트가 준비 완료를 통지하고 이후 정상 운용 단계로 진입합니다.</p>
  </li>
  <li>
    <p><strong>운용(Operation)</strong> : 합의된 기능만 사용합니다(예: tools/list, tools/call 등).</p>
  </li>
  <li>
    <p><strong>종료</strong> : 전송 방식에 맞게 그레이스풀하게 끊습니다. <a href="https://modelcontextprotocol.io/specification/2025-06-18/basic/lifecycle">Model Context Protocol</a></p>
  </li>
</ol>

<h1 id="서버가-제공하는-3가지-기본-프리미티브">서버가 제공하는 3가지 “기본 프리미티브”</h1>

<ul>
  <li>
    <p><strong>Resources(리소스)</strong> : 파일/문서/DB 스키마 같은 참조 데이터. <code class="language-plaintext highlighter-rouge">resources/list</code>로 목록을, <code class="language-plaintext highlighter-rouge">resources/read</code>로 내용을 가져옵니다. URI(file://, https://, git:// 등)로 식별되고 필요하면 구독/변경 알림도 됩니다. <a href="https://modelcontextprotocol.io/specification/2025-06-18/server">Model Context Protocol+1</a></p>
  </li>
  <li>
    <p><strong>Prompts(프롬프트)</strong> : 사용자가 골라 쓰는 템플릿/워크플로. <code class="language-plaintext highlighter-rouge">prompts/list</code>로 발견하고 <code class="language-plaintext highlighter-rouge">prompts/get</code>으로 인자 넣어 받아옵니다. <a href="https://modelcontextprotocol.io/specification/2025-06-18/server/prompts">Model Context Protocol</a></p>
  </li>
  <li>
    <p><strong>Tools(툴)</strong> : 모델이 “호출”하는 함수. JSON Schema로 입력(필수/형)을 선언하고, <code class="language-plaintext highlighter-rouge">tools/list</code>로 발견→<code class="language-plaintext highlighter-rouge">tools/call</code>로 실행→텍스트/이미지/구조화 JSON(옵션) 등으로 결과를 반환합니다. <a href="https://modelcontextprotocol.io/specification/2025-06-18/server/tools">Model Context Protocol</a></p>
  </li>
</ul>

<h1 id="실제-호출-흐름-단계별-예시">실제 호출 흐름, 단계별 예시</h1>

<ol>
  <li>
    <p>사용자가 “레포 이슈 찾아줘”라고 말함 → <strong>호스트</strong> 가 현재 대화·권한을 바탕으로 적절한 MCP <strong>클라이언트</strong> 를 선택. <a href="https://modelcontextprotocol.io/specification/2025-06-18/architecture">Model Context Protocol</a></p>
  </li>
  <li>
    <p>클라이언트↔서버가 <strong>initialize</strong> 로 버전·기능을 교섭(예: 서버는 tools/resources 지원, 클라이언트는 sampling 지원). <a href="https://modelcontextprotocol.io/specification/2025-06-18/basic/lifecycle">Model Context Protocol</a></p>
  </li>
  <li>
    <p>클라이언트가 <code class="language-plaintext highlighter-rouge">tools/list</code>로 사용 가능한 툴을 조회(예: <code class="language-plaintext highlighter-rouge">search_issues</code>). <a href="https://modelcontextprotocol.io/specification/2025-06-18/server/tools">Model Context Protocol</a></p>
  </li>
  <li>
    <p>(필요 시) <code class="language-plaintext highlighter-rouge">resources/list</code>/<code class="language-plaintext highlighter-rouge">resources/read</code>로 현재 프로젝트 파일·설정 등 맥락을 취득. <a href="https://modelcontextprotocol.io/specification/2025-06-18/server/resources">Model Context Protocol</a></p>
  </li>
  <li>
    <p><strong>LLM</strong> 이 툴 설명과 입력 스키마를 이해하고 <code class="language-plaintext highlighter-rouge">tools/call</code>에 맞는 인자를 작성. 호스트 UI가 사용자에게 실행/권한을 확인(“사람-검토” 권장). <a href="https://modelcontextprotocol.io/specification/2025-06-18/server/tools">Model Context Protocol</a></p>
  </li>
  <li>
    <p>서버가 외부 API/DB를 호출하고 결과를 JSON-RPC 응답으로 반환(필요하면 리소스 링크나 구조화 JSON 포함). <a href="https://modelcontextprotocol.io/specification/2025-06-18/server/tools">Model Context Protocol</a></p>
  </li>
  <li>
    <p>호스트는 결과를 대화 맥락에 주입(서버는 전체 대화 기록을 직접 읽지 못하도록 분리). <a href="https://modelcontextprotocol.io/specification/2025-06-18/architecture">Model Context Protocol</a></p>
  </li>
  <li>
    <p>LLM이 최종 답변을 생성하고, 추가 액션이 필요하면 위 사이클을 반복.</p>
  </li>
</ol>

<h1 id="보안신뢰-원칙요점">보안·신뢰 원칙(요점)</h1>

<ul>
  <li>
    <p><strong>명시적 사용자 동의</strong> : 데이터 접근·툴 실행 전 사용자 승인이 필요합니다.</p>
  </li>
  <li>
    <p><strong>최소 공개</strong> : 서버는 필요한 맥락만 보고, 전체 대화/다른 서버의 상태는 볼 수 없게 설계됩니다.</p>
  </li>
  <li>
    <p><strong>툴은 잠재적 코드 실행</strong> 이므로 UI 경고·승인·로깅·취소·타임아웃 등을 권장합니다. <a href="https://modelcontextprotocol.io/specification/2025-06-18">Model Context Protocol+1</a></p>
  </li>
  <li>
    <p>(HTTP 전송 시) <strong>Origin 검증/로컬 바인딩/인증</strong> 등 네트워크 보안 수칙을 지켜야 합니다. <a href="https://modelcontextprotocol.io/specification/2025-06-18/basic/transports">Model Context Protocol</a></p>
  </li>
</ul>

<h1 id="개발자가-기억하면-좋은-포인트">개발자가 기억하면 좋은 포인트</h1>

<ul>
  <li>
    <p><strong>발견(Discovery)</strong> : list 계열 API로 기능을 찾는다 → <strong>호출(Call)</strong> : schema에 맞춰 실행한다 → <strong>콘텐츠 주입(Contexting)</strong> : 결과를 대화에 넣는다(필요시 리소스 링크/구독). <a href="https://modelcontextprotocol.io/specification/2025-06-18/server/tools">Model Context Protocol+1</a></p>
  </li>
  <li>
    <p><strong>버전·기능 교섭</strong> 이 항상 먼저이고, 합의된 것만 쓴다. <a href="https://modelcontextprotocol.io/specification/2025-06-18/basic/lifecycle">Model Context Protocol</a></p>
  </li>
  <li>
    <p>구현은 <strong>stdio</strong> 가 가장 단순하고, <strong>Streamable HTTP</strong> 는 다중 연결·SSE 스트리밍·세션 ID로 확장 가능. <a href="https://modelcontextprotocol.io/specification/2025-06-18/basic/transports">Model Context Protocol</a></p>
  </li>
</ul>

<p>원하시면, 간단한 “Hello Tool” 서버/클라이언트 템플릿(예: Node/Python)으로 <code class="language-plaintext highlighter-rouge">initialize → tools/list → tools/call</code>까지 돌아가는 최소 예제를 바로 만들어 드릴게요.</p>

<p class="chat--user">

나에게 GPT-OSS 를 자체적으로 구동하는 서버가 있어. 여기에 MCP를 사용하도록 하려면?

</p>

<p>좋아요. “자체 GPT-OSS 서버”를 이미 돌리고 계시다면, 거기에 <strong>MCP(모델 컨텍스트 프로토콜)</strong>를 붙이는 방법은 크게 두 가지 시나리오가 있어요. 아래를 <strong>단계별</strong> 로 따라가면 됩니다.</p>

<hr />

<h1 id="시나리오-a-내-gpt-oss-앞에-mcp-호스트브리지를-둔다">시나리오 A) 내 GPT-OSS 앞에 ‘MCP 호스트(브리지)’를 둔다</h1>

<blockquote>
  <p>가장 일반적인 방식. “호스트(Host)=LLM 런타임 + MCP 클라이언트”가 <strong>MCP 서버들의 툴·리소스·프롬프트</strong> 를 발견→호출하고, 그 결과를 GPT-OSS 대화에 주입합니다. (MCP 클라이언트/서버 SDK와 전송 방식은 공식 문서·SDK에 있어요.) <a href="https://modelcontextprotocol.io/docs/develop/build-client">Model Context Protocol+3</a></p>
</blockquote>

<h2 id="0-사전-준비-gpt-oss-서비스를-openai-호환-api로">0) 사전 준비 (GPT-OSS 서비스를 OpenAI 호환 API로)</h2>

<ul>
  <li>vLLM 등으로 GPT-OSS를 <strong>OpenAI Chat Completions 호환</strong> 으로 띄워두면 편합니다. 예:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>uv pip <span class="nb">install</span> <span class="nt">--pre</span> <span class="nv">vllm</span><span class="o">==</span>0.10.1+gptoss <span class="nt">--extra-index-url</span> https://wheels.vllm.ai/gpt-oss/
vllm serve openai/gpt-oss-20b
</code></pre></div>    </div>
  </li>
</ul>

<p>(레포의 가이드를 따르면 자동 다운로드/서빙이 됩니다.) <a href="https://github.com/openai/gpt-oss">GitHub</a></p>

<ul>
  <li>GPT-OSS는 <strong>Harmony 응답 형식</strong> 을 전제로 학습됐습니다. Harmony로 메시지를 꾸미고(예: <code class="language-plaintext highlighter-rouge">openai-harmony</code> 라이브러리), 툴 정의도 시스템 메시지에 넣어야 도구 호출이 올바르게 동작해요. <a href="https://github.com/openai/gpt-oss">GitHub</a></li>
</ul>

<h2 id="1-어떤-mcp-전송transport을-쓸지-결정">1) 어떤 MCP 전송(transport)을 쓸지 결정</h2>

<ul>
  <li>
    <p><strong>동일 머신/로컬</strong> : <code class="language-plaintext highlighter-rouge">stdio</code>(서브프로세스로 서버 실행) → 간단/보안 유리</p>
  </li>
  <li>
    <p><strong>원격/확장</strong> : <strong>Streamable HTTP</strong>(POST/GET+선택적 SSE) → 다중 클라이언트/세션/재연결 지원</p>
  </li>
  <li>
    <p>HTTP 쓸 땐 <strong>Origin 검증, localhost 바인딩, 인증</strong> 을 반드시 설정하세요. (DNS rebinding 등 방지) <a href="https://modelcontextprotocol.io/specification/2025-06-18/basic/transports">Model Context Protocol</a></p>
  </li>
</ul>

<h2 id="2-호스트브리지-구성--최소-루프">2) 호스트(브리지) 구성 — 최소 루프</h2>

<p>핵심은 아래 루프예요.</p>

<ol>
  <li>
    <p><strong>MCP 클라이언트 세션</strong> 을 열고 <code class="language-plaintext highlighter-rouge">tools/list</code>로 사용 가능한 MCP 툴 스키마를 가져옵니다.</p>
  </li>
  <li>
    <p>그 스키마를 <strong>Harmony 포맷의 “tools 정의”</strong>로 시스템 메시지에 주입하고, 사용자 프롬프트와 함께 <strong>GPT-OSS</strong> 에 보냅니다.</p>
  </li>
  <li>
    <p>모델이 <strong>tool_use</strong> 를 생성하면 → 해당 호출을 <strong><code class="language-plaintext highlighter-rouge">tools/call</code></strong>로 MCP 서버에 실행 → 결과를 <strong>tool_result</strong> 로 다시 모델에 전달 → 모델의 최종 답변까지 반복.<br />
TypeScript/Python 양쪽 SDK가 이 흐름을 지원합니다. <a href="https://modelcontextprotocol.io/docs/develop/build-client">Model Context Protocol+1</a></p>
  </li>
</ol>

<blockquote>
  <p>참고: TypeScript SDK README에는 HTTP/stdio 서버 예제와 클라이언트 작성 섹션이, Python SDK에는 <code class="language-plaintext highlighter-rouge">FastMCP</code> 및 <strong>Streamable HTTP를 기존 ASGI 앱에 마운트</strong> 하는 예제가 잘 정리돼 있어요(브라우저 클라이언트용 CORS 노출 헤더 포함). <a href="https://github.com/modelcontextprotocol/typescript-sdk">GitHub+1</a></p>
</blockquote>

<h2 id="3-샘플-아키텍처요지">3) 샘플 아키텍처(요지)</h2>

<ul>
  <li>
    <p><strong>mcp-bridge</strong>(호스트):</p>

    <ul>
      <li>
        <p>mcp Python/TS SDK로 MCP <strong>ClientSession</strong> 생성 → <code class="language-plaintext highlighter-rouge">list_tools</code> → 툴 스키마를 Harmony 시스템 메시지에 삽입</p>
      </li>
      <li>
        <p>GPT-OSS(예: vLLM OpenAI 엔드포인트)에 ChatCompletions <strong>+ Harmony</strong> 로 질의</p>
      </li>
      <li>
        <p>응답 내 <code class="language-plaintext highlighter-rouge">tool_use</code> → <code class="language-plaintext highlighter-rouge">session.call_tool()</code>로 실행 → 결과를 <strong>Harmony <code class="language-plaintext highlighter-rouge">tool_result</code></strong>로 다시 모델에게 전달</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>보안</strong> : MCP HTTP 사용 시 <code class="language-plaintext highlighter-rouge">Mcp-Session-Id</code> 헤더·세션 종료, CORS 헤더(특히 <code class="language-plaintext highlighter-rouge">Mcp-Session-Id</code> 노출) 설정 권장. <a href="https://github.com/modelcontextprotocol/python-sdk">GitHub</a></p>
  </li>
</ul>

<blockquote>
  <p>팁: OpenAI의 <strong>Apps/Agents SDK</strong> 도 MCP 서버 연동 개념을 문서화해 두었고, <strong>OpenAI호환(Chat Completions) 엔드포인트</strong> 면 쉽게 맞물립니다(호스트를 직접 만들 때 개념 참조). <a href="https://developers.openai.com/apps-sdk/concepts/mcp-server/?utm_source=chatgpt.com">OpenAI 개발자</a></p>
</blockquote>

<hr />

<h1 id="시나리오-b-gpt-oss가-mcp-서버-도-겸하도록-확장">시나리오 B) GPT-OSS가 <strong>MCP 서버</strong> 도 겸하도록 확장</h1>

<blockquote>
  <p>특수한 경우: “GPT-OSS가 가진 자체 도구(브라우저 등)를 MCP 서버 형태로 노출”하여 외부 호스트가 붙게 하는 방식.</p>
</blockquote>

<ul>
  <li>
    <p>GPT-OSS 레포에는 <strong>도구(tool)</strong> 개념(예: 브라우저 <code class="language-plaintext highlighter-rouge">search/open/find</code>)과 Harmony에 툴 정의를 넣는 예제가 포함돼 있어, 이를 MCP <strong><code class="language-plaintext highlighter-rouge">tools/list</code>/<code class="language-plaintext highlighter-rouge">tools/call</code></strong>로 매핑해 <strong>MCP 서버</strong> 를 만들 수도 있습니다. (프로덕션용 브라우저 백엔드는 직접 교체 권장) <a href="https://github.com/openai/gpt-oss">GitHub</a></p>
  </li>
  <li>
    <p>서버 구현은 <strong>TypeScript/Python MCP 서버 SDK</strong> 의 템플릿을 사용하면 빠릅니다. (Echo/SQLite 등 예제 포함) <a href="https://github.com/modelcontextprotocol/typescript-sdk">GitHub</a></p>
  </li>
</ul>

<hr />

<h2 id="바로-써먹는-체크리스트-step-by-step">바로 써먹는 체크리스트 (Step-by-Step)</h2>

<ol>
  <li>
    <p><strong>GPT-OSS 엔드포인트 준비</strong></p>

    <ul>
      <li>vLLM로 OpenAI 호환 API 띄우기 → Harmony 적용(예: <code class="language-plaintext highlighter-rouge">openai-harmony</code>) <a href="https://github.com/openai/gpt-oss">GitHub</a></li>
    </ul>
  </li>
  <li>
    <p><strong>MCP 호스트(브리지) 스캐폴딩</strong></p>

    <ul>
      <li>
        <p>(Python) <code class="language-plaintext highlighter-rouge">pip/uv add mcp</code> 또는 (Node) <code class="language-plaintext highlighter-rouge">npm i @modelcontextprotocol/sdk</code></p>
      </li>
      <li>
        <p>MCP <strong>클라이언트</strong> 로 <code class="language-plaintext highlighter-rouge">initialize → tools/list</code>까지 호출되는지 확인 <a href="https://github.com/modelcontextprotocol/python-sdk">GitHub+1</a></p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>툴 스키마 ↔ Harmony 변환기</strong> 작성</p>

    <ul>
      <li>
        <p>MCP <code class="language-plaintext highlighter-rouge">tools/list</code> 결과(JSON Schema)를 Harmony <strong>tools 정의</strong> 로 시스템 메시지에 삽입</p>
      </li>
      <li>
        <p>모델 응답의 <code class="language-plaintext highlighter-rouge">tool_use</code>를 파싱해 <code class="language-plaintext highlighter-rouge">tools/call</code>로 라우팅, 결과를 <code class="language-plaintext highlighter-rouge">tool_result</code>로 재주입 <a href="https://github.com/openai/gpt-oss">GitHub+1</a></p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>전송 선택과 보안</strong></p>

    <ul>
      <li>
        <p>로컬은 <strong>stdio</strong> , 분산/원격은 <strong>Streamable HTTP</strong></p>
      </li>
      <li>
        <p>HTTP 시 <strong>Origin 검증·로컬 바인딩(개발)·인증</strong> ·CORS(<code class="language-plaintext highlighter-rouge">Mcp-Session-Id</code> 노출) 설정 <a href="https://modelcontextprotocol.io/specification/2025-06-18/basic/transports">Model Context Protocol+1</a></p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>테스트 도구 서버 붙이기</strong></p>

    <ul>
      <li>
        <p>예: GitHub 서버(<code class="language-plaintext highlighter-rouge">npx @modelcontextprotocol/server-github</code>), 파일시스템/SQLite/포스트그레스 서버 등</p>
      </li>
      <li>
        <p>커뮤니티 서버 큐레이션(awesome list)도 참고하세요. <a href="https://github.com/modelcontextprotocol/typescript-sdk">GitHub+2</a></p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>운영 가드레일</strong></p>

    <ul>
      <li>툴 실행 시간/빈도 제한, 사용자 확인(UI 승인), 로깅·감사, 타임아웃/취소·리트라이, 비밀키 주입(ENV)</li>
    </ul>
  </li>
</ol>

<hr />

<h2 id="가장-빠른-실습-루트요약">“가장 빠른” 실습 루트(요약)</h2>

<ul>
  <li>
    <p><strong>(1) vLLM로 GPT-OSS 띄우기</strong> → <code class="language-plaintext highlighter-rouge">vllm serve openai/gpt-oss-20b</code> <a href="https://github.com/openai/gpt-oss">GitHub</a></p>
  </li>
  <li>
    <p><strong>(2) TypeScript SDK Quick Start 서버</strong> 하나 켜서 MCP 동작 점검(HTTP/stdio 아무거나) <a href="https://github.com/modelcontextprotocol/typescript-sdk">GitHub</a></p>
  </li>
  <li>
    <p><strong>(3) 간이 브리지</strong> :</p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">list_tools</code> → Harmony 시스템 프롬프트에 삽입 → ChatCompletions 호출</p>
      </li>
      <li>
        <p>응답의 <code class="language-plaintext highlighter-rouge">tool_use</code>를 <code class="language-plaintext highlighter-rouge">tools/call</code>로 실행하고 <code class="language-plaintext highlighter-rouge">tool_result</code>로 되돌려 주기 <a href="https://modelcontextprotocol.io/docs/develop/build-client">Model Context Protocol+1</a></p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>(4) 보안/세션 헤더 설정</strong>(HTTP라면 <code class="language-plaintext highlighter-rouge">Mcp-Session-Id</code>/Origin/CORS) <a href="https://modelcontextprotocol.io/specification/2025-06-18/basic/transports">Model Context Protocol+1</a></p>
  </li>
</ul>

<hr />

<h2 id="함께-쓰면-좋은-레퍼런스">함께 쓰면 좋은 레퍼런스</h2>

<ul>
  <li>
    <p><strong>MCP 전송 스펙(최근판)</strong> : stdio &amp; Streamable HTTP, 보안 주의사항, 세션/재시도 흐름 <a href="https://modelcontextprotocol.io/specification/2025-06-18/basic/transports">Model Context Protocol</a></p>
  </li>
  <li>
    <p><strong>MCP 클라이언트 만들기 튜토리얼</strong>(언어별) <a href="https://modelcontextprotocol.io/docs/develop/build-client">Model Context Protocol</a></p>
  </li>
  <li>
    <p><strong>TS/Python 공식 SDK</strong>(서버·클라이언트, 예제 다수) <a href="https://github.com/modelcontextprotocol/typescript-sdk">GitHub+1</a></p>
  </li>
  <li>
    <p><strong>GPT-OSS 레포</strong> : vLLM 서빙, Harmony/툴 사용법, 브라우저 툴 예시 <a href="https://github.com/openai/gpt-oss">GitHub+1</a></p>
  </li>
  <li>
    <p><strong>커뮤니티 서버 모음</strong> : GitHub/파일/DB/클라우드 등 MCP 서버 카탈로그 <a href="https://github.com/punkpeye/awesome-mcp-servers?utm_source=chatgpt.com">GitHub</a></p>
  </li>
</ul>

<hr />

<p>원하시면, <strong>Python/Node 중 선호하시는 언어로</strong> 최소 브리지 코드(≈100~150줄)까지 바로 작성해 드릴게요. 모델 호출은 <strong>현재 쓰시는 GPT-OSS 엔드포인트</strong>(OpenAI 호환)로 그대로 보내고, MCP 툴 호출 루프를 얹어드립니다.</p>

<p class="chat--user">

시나리오 A를 보자. 그럼 결국 for문 돌리라는 건가?

</p>

<p>짧은 답: <strong>그냥 “for문 한 번”이 아니라 “툴-호출 루프(reactive loop)”</strong>예요.<br />
모델이 <code class="language-plaintext highlighter-rouge">tool_use</code>(=function call)을 내보낼 때마다 해당 MCP 툴을 실행하고, <strong>그 결과를 다시 모델에 먹여서</strong> 다음 응답을 받는 걸 <strong>최대 N회</strong> 반복하다가, 더 이상 툴 호출이 없으면 종료합니다.</p>

<p>아래를 단계별로 보면 감이 딱 와요.</p>

<hr />

<h1 id="step-by-step-호스트브리지-제어-흐름">Step-by-step: 호스트(브리지) 제어 흐름</h1>

<ol>
  <li>
    <p><strong>MCP 서버와 세션</strong> 열기 → <code class="language-plaintext highlighter-rouge">tools/list</code>로 툴 스키마 수집</p>
  </li>
  <li>
    <p><strong>툴 스키마를 모델에 주입</strong></p>

    <ul>
      <li>(예: GPT-OSS는 Harmony 스타일이면 그 규격대로, 일반 OpenAI 호환이면 <code class="language-plaintext highlighter-rouge">tools</code>/<code class="language-plaintext highlighter-rouge">function</code> 형식으로)</li>
    </ul>
  </li>
  <li>
    <p><strong>대화 시작</strong> : <code class="language-plaintext highlighter-rouge">[system(tool정의), user(사용자요청)]</code>로 1차 호출</p>
  </li>
  <li>
    <p><strong>응답 검사</strong></p>

    <ul>
      <li>
        <p>응답에 <code class="language-plaintext highlighter-rouge">tool_use</code>(=tool/function call)가 없다 → <strong>최종 답변</strong> 으로 종료</p>
      </li>
      <li>
        <p>있으면 → 각 호출을 <strong>MCP <code class="language-plaintext highlighter-rouge">tools/call</code></strong>로 실행</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">tool_result</code> 주입</strong>: 각 호출 결과를 모델에 다시 전달 → 3~4를 <strong>반복</strong></p>
  </li>
  <li>
    <p><strong>종료 조건</strong> :</p>

    <ul>
      <li>
        <p>더 이상 <code class="language-plaintext highlighter-rouge">tool_use</code> 없음</p>
      </li>
      <li>
        <p>안전장치(최대 홉 수, 시간 초과, 토큰 한도, 사용자 취소)</p>
      </li>
    </ul>
  </li>
</ol>

<blockquote>
  <p>즉, <strong>“모델 →(요청)→ MCP 실행 →(결과)→ 모델”</strong>이 한 턴을 이루고, 이걸 <strong>while 루프</strong> 로 굴립니다.<br />
 필요하면 한 턴 안의 여러 <code class="language-plaintext highlighter-rouge">tool_use</code>를 <strong>병렬</strong> 로 실행할 수도 있어요.</p>
</blockquote>

<hr />

<h1 id="최소-루프의사코드">최소 루프(의사코드)</h1>

<p>언어/라이브러리 상관없이 <strong>패턴</strong> 만 잡아두면 됩니다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># pseudo: OpenAI 호환 ChatCompletions + MCP client
</span>
<span class="n">mcp</span> <span class="o">=</span> <span class="nf">connect_mcp_server</span><span class="p">(...)</span>                <span class="c1"># 1) MCP 세션
</span><span class="n">tools</span> <span class="o">=</span> <span class="n">mcp</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>                     <span class="c1"># 2) 툴 스키마
</span>
<span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
  <span class="nf">system_msg_from</span><span class="p">(</span><span class="n">tools</span><span class="p">),</span>                    <span class="c1"># 2) 모델에 툴 정의 주입 (Harmony/Tools 등)
</span>  <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_input</span><span class="p">}</span>
<span class="p">]</span>

<span class="n">MAX_HOPS</span> <span class="o">=</span> <span class="mi">8</span>
<span class="k">for</span> <span class="n">hop</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">MAX_HOPS</span><span class="p">):</span>                  <span class="c1"># ← 핵심 루프 (for든 while든 상관 없음)
</span>    <span class="n">resp</span> <span class="o">=</span> <span class="nf">chat_completions</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">messages</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="nf">to_openai_tools</span><span class="p">(</span><span class="n">tools</span><span class="p">))</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">[</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">]</span>

    <span class="n">tool_calls</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">tool_calls</span><span class="p">:</span>
        <span class="c1"># 6) 종료: 최종 답변
</span>        <span class="nf">print</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">])</span>
        <span class="k">break</span>

    <span class="c1"># 4) MCP 툴 실행 (필요 시 병렬)
</span>    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">tool_calls</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">]</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">mcp</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>     <span class="c1"># 4) MCP tools/call
</span>        <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
          <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
          <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span>
          <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="p">})</span>

    <span class="c1"># 5) 모델에 결과 재주입
</span>    <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">([</span><span class="n">msg</span><span class="p">,</span> <span class="o">*</span><span class="n">results</span><span class="p">])</span>
</code></pre></div></div>

<blockquote>
  <p>포인트</p>

  <ul>
    <li>
      <p><strong>id 매칭</strong> : <code class="language-plaintext highlighter-rouge">tool_call_id</code> ↔ MCP 실행 결과를 1:1로 매칭해야 모델이 문맥을 이어받습니다.</p>
    </li>
    <li>
      <p><strong>병렬 실행</strong> : 동일 턴의 여러 <code class="language-plaintext highlighter-rouge">tool_use</code>는 <code class="language-plaintext highlighter-rouge">Promise.all</code>/<code class="language-plaintext highlighter-rouge">asyncio.gather</code>로 병렬 처리 가능.</p>
    </li>
    <li>
      <p><strong>안전장치</strong> : <code class="language-plaintext highlighter-rouge">MAX_HOPS</code>, <code class="language-plaintext highlighter-rouge">timeout</code>, <code class="language-plaintext highlighter-rouge">rate limit</code>, 사용자 확인(UI 승인) 넣기.</p>
    </li>
    <li>
      <p><strong>스트리밍</strong> : 스트리밍 응답이면, 부분 토큰 중간에 <code class="language-plaintext highlighter-rouge">tool_use</code> 신호가 나오기도 하니 파서/이벤트로 처리.</p>
    </li>
  </ul>

</blockquote>

<hr />

<h1 id="typescript-예시요지">TypeScript 예시(요지)</h1>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ts

import OpenAI from "openai";             // GPT-OSS의 OpenAI 호환 엔드포인트로 바꿔주세요
import { connect } from "mcp-client";    // 가상의 MCP 클라이언트 API라고 가정

const client = new OpenAI({
  baseURL: process.env.OSS_BASE_URL,     // 예: http://localhost:8000/v1
  apiKey: process.env.OSS_API_KEY || "dummy"
});

const mcp = await connect({ transport: "stdio" /* 또는 http */ });
const tools = await mcp.listTools();

const messages: any[] = [
  systemMsgFrom(tools),                   // Harmony 또는 tools 정의 삽입
  { role: "user", content: process.argv.slice(2).join(" ") }
];

for (let hop = 0; hop &lt; 8; hop++) {
  const res = await client.chat.completions.create({
    model: "gpt-oss-20b",
    messages,
    tools: toOpenAITools(tools)          // OpenAI function-calling 규격으로 변환
  });

  const msg = res.choices[0].message;
  const calls = msg.tool_calls || [];
  if (!calls.length) {
    console.log(msg.content);
    break;
  }

  const results = await Promise.all(calls.map(async (c) =&gt; {
    const args = JSON.parse(c.function.arguments || "{}");
    const out = await mcp.callTool(c.function.name, args);
    return { role: "tool", tool_call_id: c.id, content: JSON.stringify(out) };
  }));

  messages.push(msg, ...results);
}
</code></pre></div></div>

<hr />

<h2 id="그래서-for문-돌리면-끝의-정확한-답">그래서, “for문 돌리면 끝?”의 정확한 답</h2>

<ul>
  <li>
    <p><strong>개념적으로는 맞아요</strong> : “반복적으로 → 모델 호출 → MCP 툴 실행 → 결과 재주입” 루프를 돕니다.</p>
  </li>
  <li>
    <p><strong>하지만 단순한 for문 이상</strong> 입니다.</p>

    <ul>
      <li>
        <p>(1) <strong>id 매칭/결과 주입 규약</strong></p>
      </li>
      <li>
        <p>(2) <strong>병렬 실행/에러·타임아웃/재시도</strong></p>
      </li>
      <li>
        <p>(3) <strong>최대 홉·토큰/비용 가드</strong></p>
      </li>
      <li>
        <p>(4) <strong>사용자 승인/로깅/권한 스코프</strong></p>
      </li>
      <li>
        <p>(5) (HTTP 전송 시) <strong>세션·CORS·Origin 검증</strong><br />
같은 운영 요소가 들어가야 “프로덕션스러운” 루프가 됩니다.</p>
      </li>
    </ul>
  </li>
</ul>

<p>원하시면, <strong>지금 쓰시는 GPT-OSS 엔드포인트 URL 기준</strong> 으로 돌아가는 최소 브리지 코드를(파이썬/TS 중 선호로) 바로 짜서 드릴게요—툴 정의 변환부터 <code class="language-plaintext highlighter-rouge">tool_result</code> 주입, 병렬 호출/타임아웃까지 넣은 버전으로요.</p>

<p class="chat--user">

그니까 그냥 while문 돌리는거잖아

</p>

<p>맞아요—<strong>본질은 while 루프</strong> 예요.<br />
“모델 → 툴 호출 신호 확인 → MCP <code class="language-plaintext highlighter-rouge">tools/call</code> 실행 → 결과 재주입”을 <strong>툴 호출이 사라질 때까지</strong>(또는 최대 홉 수까지) 반복합니다.</p>

<h3 id="동작을-딱-정리하면">동작을 딱 정리하면</h3>

<ol>
  <li>
    <p><code class="language-plaintext highlighter-rouge">tools/list</code>로 MCP 툴 스키마 수집 → 시스템/툴 정의로 <strong>모델에 주입</strong></p>
  </li>
  <li>
    <p><strong>모델 호출</strong> → 응답에 <code class="language-plaintext highlighter-rouge">tool_use</code>(=function call)가 있는지 확인</p>
  </li>
  <li>
    <p>있으면 그만큼 <strong>MCP<code class="language-plaintext highlighter-rouge">tools/call</code> 실행</strong>(동턴 다건은 병렬 가능)</p>
  </li>
  <li>
    <p>각 결과를 <code class="language-plaintext highlighter-rouge">tool_call_id</code>에 <strong>1:1 매칭</strong> 해 <strong>tool 결과 메시지</strong> 로 <strong>다시 모델에 넣기</strong></p>
  </li>
  <li>
    <p>2–4를 <strong>while</strong> 로 반복 (종료: 더 이상 <code class="language-plaintext highlighter-rouge">tool_use</code> 없음, <code class="language-plaintext highlighter-rouge">MAX_HOPS</code>, 타임아웃 등)</p>
  </li>
</ol>

<h3 id="최소-예파이썬풍">최소 예(파이썬풍)</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">messages</span> <span class="o">=</span> <span class="p">[</span><span class="nf">system_msg_from</span><span class="p">(</span><span class="n">mcp</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()),</span> <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_input</span><span class="p">}]</span>
<span class="n">MAX_HOPS</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">hop</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">while</span> <span class="n">hop</span> <span class="o">&lt;</span> <span class="n">MAX_HOPS</span><span class="p">:</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="nf">chat_completions</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">messages</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="nf">to_openai_tools</span><span class="p">(</span><span class="n">mcp</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()))</span>
    <span class="n">msg</span>  <span class="o">=</span> <span class="n">resp</span><span class="p">[</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">]</span>
    <span class="n">calls</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>                      <span class="c1"># 종료 조건
</span>        <span class="nf">print</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
        <span class="k">break</span>

    <span class="n">tool_results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>                    <span class="c1"># 동턴 다건이면 병렬 처리 권장
</span>        <span class="n">name</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">]</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">]</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">out</span>  <span class="o">=</span> <span class="n">mcp</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>     <span class="c1"># MCP tools/call
</span>        <span class="n">tool_results</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
            <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span>         <span class="c1"># ← 반드시 매칭!
</span>            <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="p">})</span>

    <span class="n">messages</span> <span class="o">+=</span> <span class="p">[</span><span class="n">msg</span><span class="p">,</span> <span class="o">*</span><span class="n">tool_results</span><span class="p">]</span>   <span class="c1"># 응답과 결과를 모두 누적
</span>    <span class="n">hop</span> <span class="o">+=</span> <span class="mi">1</span>
</code></pre></div></div>

<h3 id="실무-팁한-줄씩">실무 팁(한 줄씩)</h3>

<ul>
  <li>
    <p><strong>while</strong> 은 맞는데, <strong>가드레일</strong> 이 핵심: <code class="language-plaintext highlighter-rouge">MAX_HOPS</code>, per-call <strong>timeout/재시도</strong> , 사용자 <strong>승인</strong> , 로깅.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">tool_call_id</code> 매칭 누락/<code class="language-plaintext highlighter-rouge">messages</code> 누적 누락이 가장 흔한 버그.</p>
  </li>
  <li>
    <p>한 턴에 여러 <code class="language-plaintext highlighter-rouge">tool_use</code>는 <strong>병렬</strong> 처리하고, 실패한 것만 선택 재시도.</p>
  </li>
  <li>
    <p>스트리밍이면 중간에 <code class="language-plaintext highlighter-rouge">tool_use</code> 이벤트가 나올 수 있으니 <strong>이벤트 파서</strong> 로 처리.</p>
  </li>
</ul>

<p>결론: 네, <strong>“while문으로 도는 반응형 툴-호출 루프”</strong>라고 이해하시면 정확합니다.</p>

<p class="chat--user">

python에서 AsyncOpenAI 로 client.chat.completions.create 를 통해서 통신을 이미 하고 있거든? 이걸 기반으로 파이썬 코드 한 번 최대한 꼼꼼하게 만들어보자.

</p>

<p>좋습니다. 이미 <strong>AsyncOpenAI</strong> 의 <code class="language-plaintext highlighter-rouge">client.chat.completions.create(...)</code>로 모델을 호출하고 계시니, 그 위에 <strong>MCP 툴 호출 루프(while loop)</strong>를 얹은 <strong>프로덕션용 브리지</strong> 샘플을 드릴게요.<br />
아래 코드는 다음을 모두 포함합니다.</p>

<ul>
  <li>
    <p>MCP 서버 연결(stdio/HTTP 중 택1)</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">tools/list</code> → OpenAI 함수 포맷으로 변환</p>
  </li>
  <li>
    <p>모델 응답의 <code class="language-plaintext highlighter-rouge">tool_calls</code> 병렬 실행(<code class="language-plaintext highlighter-rouge">asyncio.gather</code>)</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">tool_call_id</code> 1:1 매칭으로 <code class="language-plaintext highlighter-rouge">tool</code> 메시지 재주입</p>
  </li>
  <li>
    <p>최대 홉 수, per-call 타임아웃, 재시도, 예외 처리</p>
  </li>
</ul>

<blockquote>
  <p>의존성(예시):<br />
 <code class="language-plaintext highlighter-rouge">pip install openai anyio</code> + (MCP Python SDK: 보유하신 SDK 이름/버전에 맞춰 <code class="language-plaintext highlighter-rouge">mcp</code> 또는 <code class="language-plaintext highlighter-rouge">modelcontextprotocol</code> 계열 패키지를 설치하세요)</p>
</blockquote>

<hr />

<h1 id="파이썬-asyncopenai--mcp-브리지-완성본">파이썬: AsyncOpenAI × MCP 브리지 (완성본)</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="sh">"""</span><span class="s">
mcp_bridge.py

- AsyncOpenAI Chat Completions 기반의 MCP 브리지
- while 루프: 모델 -&gt; MCP tools/call -&gt; 결과 재주입 -&gt; 종료 조건까지 반복
</span><span class="sh">"""</span>

<span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">AsyncOpenAI</span>

<span class="c1"># === MCP SDK 가져오기 ===
# 사용 중인 MCP Python SDK에 맞게 import 경로를 조정하세요.
# 아래는 가장 흔한 네이밍을 가정한 예시입니다.
</span><span class="k">try</span><span class="p">:</span>
    <span class="c1"># 예: 공식 MCP Python SDK
</span>    <span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
    <span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioTransport</span>
    <span class="c1"># (HTTP 클라이언트가 SDK에 있다면 함께 import)
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="n">mcp.client.http</span> <span class="kn">import</span> <span class="n">HttpClientTransport</span>  <span class="c1"># 있을 때만 사용
</span>    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="n">HttpClientTransport</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c1"># type: ignore
</span><span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span>
        <span class="sh">"</span><span class="s">MCP Python SDK import 실패. 설치 및 경로를 확인하세요.</span><span class="se">\n</span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">예: pip install modelcontextprotocol  또는  pip install mcp</span><span class="sh">"</span>
    <span class="p">)</span> <span class="k">from</span> <span class="n">e</span>

<span class="c1"># ------------------------------------------------------------
# 데이터 모델
# ------------------------------------------------------------
</span><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">McpTool</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">description</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">input_schema</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># JSON Schema
</span>
<span class="c1"># ------------------------------------------------------------
# MCP 클라이언트 래퍼
# ------------------------------------------------------------
</span><span class="k">class</span> <span class="nc">SimpleMcpClient</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    MCP 클라이언트를 간단 래핑. SDK의 실제 인터페이스에 맞게 조정하세요.
    </span><span class="sh">"""</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">stdio_cmd</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">stdio_env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">http_url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">http_headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">stdio_cmd</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioTransport</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">stdio_cmd</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">stdio_env</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="k">elif</span> <span class="n">http_url</span> <span class="ow">and</span> <span class="n">HttpClientTransport</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">transport</span> <span class="o">=</span> <span class="nc">HttpClientTransport</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">http_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">http_headers</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">stdio_cmd 또는 http_url 중 하나는 필요합니다.</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ClientSession</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">__aenter__</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="sh">"</span><span class="s">SimpleMcpClient</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">session</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">transport</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">__aenter__</span><span class="p">()</span>  <span class="c1"># 세션/initialize 핸드셰이크
</span>        <span class="k">return</span> <span class="n">self</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">__aexit__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">tb</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">session</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">__aexit__</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">tb</span><span class="p">)</span>

    <span class="c1"># ---- 기능: tools/list ----
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">list_tools</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">McpTool</span><span class="p">]:</span>
        <span class="k">assert</span> <span class="n">self</span><span class="p">.</span><span class="n">session</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">MCP 세션이 열려있지 않습니다.</span><span class="sh">"</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
        <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">McpTool</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
            <span class="n">tools</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span>
                <span class="nc">McpTool</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                    <span class="n">input_schema</span><span class="o">=</span><span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">inputSchema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span> <span class="ow">or</span> <span class="p">{},</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">tools</span>

    <span class="c1"># ---- 기능: tools/call ----
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">call_tool</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">
        MCP tools/call 실행 후 결과를 통일된 dict로 반환합니다.
        SDK마다 resp.content 형태가 다를 수 있으니 여기서 정규화하세요.
        </span><span class="sh">"""</span>
        <span class="k">assert</span> <span class="n">self</span><span class="p">.</span><span class="n">session</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">MCP 세션이 열려있지 않습니다.</span><span class="sh">"</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">arguments</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>

        <span class="c1"># content 정규화 예시:
</span>        <span class="c1"># resp.content가 [{"type":"text","text":"..."}, {"type":"json","json":{...}}] 형태라고 가정
</span>        <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">raw</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span><span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">)</span> <span class="ow">and</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">resp</span><span class="p">.</span><span class="n">content</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">texts</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">json_obj</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
                    <span class="k">elif</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">json_obj</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">texts</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>
                <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">json_obj</span>
                <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">raw</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="p">.</span><span class="n">__dict__</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">.</span><span class="n">content</span><span class="p">]</span>  <span class="c1"># 디버깅용
</span>            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># 혹시 다른 형태면 통으로 감싸서 반환
</span>                <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">raw</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="sh">"</span><span class="s">__dict__</span><span class="sh">"</span><span class="p">,</span> <span class="n">resp</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">raw</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="sh">"</span><span class="s">__dict__</span><span class="sh">"</span><span class="p">,</span> <span class="n">resp</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">out</span>

<span class="c1"># ------------------------------------------------------------
# 유틸: MCP 툴을 OpenAI tools 포맷으로 변환
# ------------------------------------------------------------
</span><span class="k">def</span> <span class="nf">mcp_tools_to_openai_tools</span><span class="p">(</span><span class="n">mcp_tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">McpTool</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="sh">"""</span><span class="s">
    OpenAI Chat Completions `tools` 파라미터 규격:
    [
      {
        </span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">,
        </span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">: {
          </span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="s">: str,
          </span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="s">: str,
          </span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="s">: {JSON Schema}
        }
      }
    ]
    </span><span class="sh">"""</span>
    <span class="n">out</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">mcp_tools</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">[:</span><span class="mi">64</span><span class="p">]</span>  <span class="c1"># OpenAI 제약: 최대 64자 권장
</span>        <span class="n">params</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="n">input_schema</span> <span class="ow">or</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}}</span>
        <span class="k">if</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
            <span class="c1"># 일부 서버가 "object" 생략 시 대비
</span>            <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">}</span>
        <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">description</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">params</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">}</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="c1"># ------------------------------------------------------------
# 브리지: 모델 &lt;-&gt; MCP 호출 루프
# ------------------------------------------------------------
</span><span class="k">class</span> <span class="nc">McpBridge</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">oai</span><span class="p">:</span> <span class="n">AsyncOpenAI</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">mcp</span><span class="p">:</span> <span class="n">SimpleMcpClient</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">max_hops</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
        <span class="n">per_tool_timeout_s</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">30.0</span><span class="p">,</span>
        <span class="n">per_tool_retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">parallel</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">system_prompt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">oai</span> <span class="o">=</span> <span class="n">oai</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">self</span><span class="p">.</span><span class="n">mcp</span> <span class="o">=</span> <span class="n">mcp</span>
        <span class="n">self</span><span class="p">.</span><span class="n">max_hops</span> <span class="o">=</span> <span class="n">max_hops</span>
        <span class="n">self</span><span class="p">.</span><span class="n">per_tool_timeout_s</span> <span class="o">=</span> <span class="n">per_tool_timeout_s</span>
        <span class="n">self</span><span class="p">.</span><span class="n">per_tool_retries</span> <span class="o">=</span> <span class="n">per_tool_retries</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parallel</span> <span class="o">=</span> <span class="n">parallel</span>
        <span class="n">self</span><span class="p">.</span><span class="n">system_prompt</span> <span class="o">=</span> <span class="n">system_prompt</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="sh">"</span><span class="s">You are a careful assistant. </span><span class="sh">"</span>
            <span class="sh">"</span><span class="s">Call tools only when needed, keep arguments minimal and valid JSON.</span><span class="sh">"</span>
        <span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cached_openai_tools</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_ensure_tools</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_cached_openai_tools</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">mcp_tools</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">mcp</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_cached_openai_tools</span> <span class="o">=</span> <span class="nf">mcp_tools_to_openai_tools</span><span class="p">(</span><span class="n">mcp_tools</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_cached_openai_tools</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_call_one_tool_with_retry</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span> <span class="n">call</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="sh">"""</span><span class="s">
        단일 tool_call 실행 + 재시도/타임아웃.
        return: (tool_call_id, tool_result_message)
        </span><span class="sh">"""</span>
        <span class="n">tool_call_id</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">]</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">]</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">func</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">]</span>
        <span class="n">args_str</span> <span class="o">=</span> <span class="n">func</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span>

        <span class="c1"># arguments가 JSON 파싱 불가일 때 관대한 파서
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args_str</span><span class="p">)</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args_str</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">args_str</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="c1"># 모델이 문자열을 그대로 넘길 수 있으니 감싼다
</span>            <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">_</span><span class="sh">"</span><span class="p">:</span> <span class="n">args_str</span><span class="p">}</span>

        <span class="n">last_err</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">Exception</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">per_tool_retries</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># MCP tools/call에 타임아웃 적용
</span>                <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">mcp</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">),</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">per_tool_timeout_s</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="c1"># OpenAI chat.completions에 넣을 tool 메시지 규격
</span>                <span class="n">tool_msg</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">tool_call_id</span><span class="p">,</span>
                    <span class="c1"># 모델이 소비하기 쉽게 문자열 + json 모두 전달
</span>                    <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="n">tool_call_id</span><span class="p">,</span> <span class="n">tool_msg</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">last_err</span> <span class="o">=</span> <span class="n">e</span>
                <span class="k">if</span> <span class="n">attempt</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">per_tool_retries</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="nf">min</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">attempt</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">))</span>  <span class="c1"># 간단 백오프
</span>                    <span class="k">continue</span>
                <span class="c1"># 재시도 실패 시 에러 내용을 tool 결과로 전달(모델이 핸들링하게)
</span>                <span class="n">err_payload</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">e</span><span class="p">.</span><span class="n">__class__</span><span class="p">.</span><span class="n">__name__</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="n">tool_msg</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">tool_call_id</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">err_payload</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="n">tool_call_id</span><span class="p">,</span> <span class="n">tool_msg</span>
        <span class="c1"># 이론상 도달 불가
</span>        <span class="k">raise</span> <span class="n">last_err</span> <span class="ow">or</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">unknown tool call failure</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">user_input</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">
        while 루프를 돌며 MCP 툴 호출을 처리하고 최종 답변 텍스트를 반환합니다.
        </span><span class="sh">"""</span>
        <span class="n">tools</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_tools</span><span class="p">()</span>

        <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">system_prompt</span><span class="p">},</span>
            <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_input</span><span class="p">},</span>
        <span class="p">]</span>

        <span class="n">final_text</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span>
        <span class="k">for</span> <span class="n">hop</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">max_hops</span><span class="p">):</span>
            <span class="c1"># 1) 모델 호출
</span>            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">oai</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span>
                <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
                <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
                <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
                <span class="n">temperature</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">msg</span> <span class="o">=</span> <span class="n">res</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
            <span class="n">tool_calls</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span> <span class="ow">or</span> <span class="p">[]</span>

            <span class="c1"># 2) 툴 호출 없으면 종료
</span>            <span class="k">if</span> <span class="ow">not</span> <span class="n">tool_calls</span><span class="p">:</span>
                <span class="n">final_text</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span>
                <span class="k">break</span>

            <span class="c1"># 3) 툴 호출 실행(동턴 병렬 권장)
</span>            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">parallel</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">tool_calls</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">results</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">gather</span><span class="p">(</span>
                    <span class="o">*</span><span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="nf">_call_one_tool_with_retry</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">tool_calls</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">tool_calls</span><span class="p">:</span>
                    <span class="n">_</span><span class="p">,</span> <span class="n">m</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_call_one_tool_with_retry</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                    <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

            <span class="c1"># 4) 모델에 결과 재주입
</span>            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">role</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span><span class="p">,</span>
                    <span class="p">},</span>
                <span class="p">}</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">tool_calls</span>
            <span class="p">]})</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">final_text</span>

<span class="c1"># ------------------------------------------------------------
# 실행 예시
# ------------------------------------------------------------
</span><span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="sh">"""</span><span class="s">
    사용법:
      export OPENAI_API_KEY=dummy
      # GPT-OSS 엔드포인트를 OpenAI 호환으로 띄웠다면:
      export OPENAI_BASE_URL=http://localhost:8000/v1
      python -m mcp_bridge </span><span class="sh">"</span><span class="s">레포 이슈 요약해줘</span><span class="sh">"</span><span class="s">
    </span><span class="sh">"""</span>
    <span class="n">user_query</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">USER_QUERY</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">간단한 테스트 쿼리</span><span class="sh">"</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">OSS_MODEL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-oss-20b</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># AsyncOpenAI: GPT-OSS의 OpenAI 호환 엔드포인트로 base_url 지정
</span>    <span class="n">client</span> <span class="o">=</span> <span class="nc">AsyncOpenAI</span><span class="p">(</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">http://localhost:8000/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">dummy</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">timeout</span><span class="o">=</span><span class="mf">60.0</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># MCP 서버 연결: stdio 또는 HTTP 중 하나 택1
</span>    <span class="c1"># (1) stdio 예시: 로컬 MCP 서버 바이너리/스크립트를 서브프로세스로 실행
</span>    <span class="n">stdio_cmd</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">MCP_STDIO_CMD</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">stdio_args</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">MCP_STDIO_ARGS</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
    <span class="n">stdio</span> <span class="o">=</span> <span class="p">[</span><span class="n">stdio_cmd</span><span class="p">,</span> <span class="o">*</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">stdio_args</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="p">)</span> <span class="k">if</span> <span class="n">a</span><span class="p">])]</span> <span class="k">if</span> <span class="n">stdio_cmd</span> <span class="k">else</span> <span class="bp">None</span>

    <span class="c1"># (2) HTTP 예시: 원격 MCP 서버
</span>    <span class="n">http_url</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">MCP_HTTP_URL</span><span class="sh">"</span><span class="p">)</span>  <span class="c1"># 예: http://127.0.0.1:3333/mcp
</span>    <span class="n">http_headers</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">Mcp-Session-Id</span><span class="sh">"</span><span class="p">:</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">MCP_SESSION_ID</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">demo-session</span><span class="sh">"</span><span class="p">)}</span>

    <span class="c1"># 우선순위: stdio &gt; http
</span>    <span class="k">async</span> <span class="k">with</span> <span class="nc">SimpleMcpClient</span><span class="p">(</span><span class="n">stdio_cmd</span><span class="o">=</span><span class="n">stdio</span><span class="p">,</span> <span class="n">http_url</span><span class="o">=</span><span class="n">http_url</span><span class="p">,</span> <span class="n">http_headers</span><span class="o">=</span><span class="n">http_headers</span><span class="p">)</span> <span class="k">as</span> <span class="n">mcp</span><span class="p">:</span>
        <span class="n">bridge</span> <span class="o">=</span> <span class="nc">McpBridge</span><span class="p">(</span>
            <span class="n">oai</span><span class="o">=</span><span class="n">client</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">mcp</span><span class="o">=</span><span class="n">mcp</span><span class="p">,</span>
            <span class="n">max_hops</span><span class="o">=</span><span class="nf">int</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">MAX_HOPS</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">8</span><span class="sh">"</span><span class="p">)),</span>
            <span class="n">per_tool_timeout_s</span><span class="o">=</span><span class="nf">float</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">TOOL_TIMEOUT_S</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">30</span><span class="sh">"</span><span class="p">)),</span>
            <span class="n">per_tool_retries</span><span class="o">=</span><span class="nf">int</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">TOOL_RETRIES</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">1</span><span class="sh">"</span><span class="p">)),</span>
            <span class="n">parallel</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">system_prompt</span><span class="o">=</span><span class="p">(</span>
                <span class="sh">"</span><span class="s">You are a tool-using assistant. </span><span class="sh">"</span>
                <span class="sh">"</span><span class="s">Only call tools when necessary. Keep outputs concise.</span><span class="sh">"</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">bridge</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">user_query</span><span class="p">)</span>
        <span class="n">dur</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">=== FINAL ANSWER ===</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">[done in </span><span class="si">{</span><span class="n">dur</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">s]</span><span class="sh">"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<hr />

<h2 id="어떻게-쓰면-되나-step-by-step">어떻게 쓰면 되나? (step-by-step)</h2>

<ol>
  <li>
    <p><strong>GPT-OSS 엔드포인트</strong>(OpenAI 호환) 준비</p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">OPENAI_BASE_URL</code>를 여러분 엔드포인트로 지정</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">OPENAI_API_KEY</code>는 서버가 요구하면 넣고, 아니면 아무 문자열도 OK</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>MCP 서버 하나 골라 연결</strong></p>

    <ul>
      <li><strong>stdio</strong> : 로컬 서버를 서브프로세스로 띄우려면
        <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>arduino
       
export MCP_STDIO_CMD="npx"
export MCP_STDIO_ARGS="@modelcontextprotocol/server-github --stdio"
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
</ol>

<p>처럼 커맨드를 환경변수로 넘기세요.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> * **HTTP** : 원격 MCP 서버가 있으면
   ```
   arduino
   
   export MCP_HTTP_URL="http://127.0.0.1:3333/mcp"
   export MCP_SESSION_ID="my-session-1"
   ```
</code></pre></div></div>

<ol>
  <li><strong>실행</strong>
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">OPENAI_BASE_URL</span><span class="o">=</span>http://localhost:8000/v1
<span class="nb">export </span><span class="nv">OPENAI_API_KEY</span><span class="o">=</span>dummy
<span class="nb">export </span><span class="nv">OSS_MODEL</span><span class="o">=</span>gpt-oss-20b
python mcp_bridge.py
</code></pre></div>    </div>
  </li>
</ol>

<p>또는
     <code class="language-plaintext highlighter-rouge">ini
     USER_QUERY="우리 이슈 목록 중 버그만 요약해줘" python mcp_bridge.py
    </code></p>

<ol>
  <li>
    <p><strong>확장 포인트(현업 팁)</strong></p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">McpBridge.run()</code> 안의 <code class="language-plaintext highlighter-rouge">temperature</code>, <code class="language-plaintext highlighter-rouge">tool_choice</code>, <code class="language-plaintext highlighter-rouge">system_prompt</code>를 상황에 맞게 조정</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">per_tool_timeout_s</code>, <code class="language-plaintext highlighter-rouge">per_tool_retries</code>로 MCP 안정화</p>
      </li>
      <li>
        <p>메시지 로깅/감사의 경우, <code class="language-plaintext highlighter-rouge">messages</code> 스냅샷과 MCP 호출 로그를 파일/DB에 남기세요</p>
      </li>
      <li>
        <p>한 턴 내 다건 <code class="language-plaintext highlighter-rouge">tool_calls</code>는 이미 <strong>병렬</strong> 처리. 실패한 것만 부분 재시도하도록 커스터마이즈 가능</p>
      </li>
      <li>
        <p>필요하면 <strong>스트리밍</strong>(<code class="language-plaintext highlighter-rouge">stream=True</code>)으로 변경하고, 토큰 중간 <code class="language-plaintext highlighter-rouge">tool_calls</code> 이벤트를 파싱하는 코루틴을 추가</p>
      </li>
    </ul>
  </li>
</ol>

<hr />

<p>필요하시면 위 코드를 <strong>여러 MCP 서버(예: GitHub/FS/DB)</strong>와 붙는 실전 예로 커스터마이즈해서 드릴게요. 현재 쓰시는 <strong>MCP 서버 명령/URL</strong> 을 알려주시면, <code class="language-plaintext highlighter-rouge">stdio_cmd/http_url</code>에 맞춰 바로 작동하는 버전으로 손봐드리겠습니다.</p>

<p class="chat--user">

서버 없이 그냥 간단한 파일 조회 같은건 그냥 파이썬 코드로도 할 수 있잖아. 그런 방법은 어때?

</p>

<p>맞아요—<strong>그냥 로컬 파이썬 함수들을 “툴”로 노출</strong> 해서 모델이 부르면 실행해 주면 됩니다. MCP 서버는 건너뛰고, 호스트(브리지) 레벨에서 <strong>파일 시스템 전용 툴</strong> 을 직접 구현하는 거죠. 간단‧빠름‧의존성 적고, 사내용 파일 탐색/요약엔 충분히 좋습니다.</p>

<p>아래는 여러분이 이미 쓰고 계신 <strong>AsyncOpenAI +<code class="language-plaintext highlighter-rouge">client.chat.completions.create</code></strong> 위에 얹는, <strong>로컬 파일 툴 브리지(while 루프)</strong> 완성 예시예요.</p>

<hr />

<h2 id="어떻게-동작해">어떻게 동작해?</h2>

<ol>
  <li>
    <p><strong>툴 정의(JSON Schema)</strong> : <code class="language-plaintext highlighter-rouge">list_dir</code>, <code class="language-plaintext highlighter-rouge">read_text</code>, <code class="language-plaintext highlighter-rouge">find_in_files</code></p>
  </li>
  <li>
    <p><strong>모델 호출</strong> → <code class="language-plaintext highlighter-rouge">tool_calls</code> 있나 확인</p>
  </li>
  <li>
    <p>있으면 <strong>해당 파이썬 함수 실행</strong>(루트 디렉토리 안에서만, 크기/경로 가드)</p>
  </li>
  <li>
    <p><strong>tool 결과 메시지</strong> 를 다시 모델에 주입</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">tool_calls</code>가 더 이상 안 나올 때까지 <strong>while</strong> 반복</p>
  </li>
</ol>

<blockquote>
  <p>보안 가드: 루트 고정(<code class="language-plaintext highlighter-rouge">SAFE_ROOT</code>), 경로 정규화/부모 탈출 방지, 파일 크기 제한, 바이너리 차단, 인코딩 폴백(utf-8, utf-8-sig, cp949), 타임아웃, 재시도.</p>
</blockquote>

<hr />

<h2 id="코드-복사-붙여넣기">코드 (복사-붙여넣기)</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># local_fs_tools_bridge.py
# AsyncOpenAI × 로컬 파일 툴(서버 없음) × while 루프
# pip install openai
</span>
<span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">json</span><span class="p">,</span> <span class="n">os</span><span class="p">,</span> <span class="n">re</span>
<span class="kn">from</span> <span class="n">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">AsyncOpenAI</span>

<span class="c1"># === 설정 ===
</span><span class="n">SAFE_ROOT</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">SAFE_ROOT</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">)).</span><span class="nf">resolve</span><span class="p">()</span>  <span class="c1"># 이 디렉토리 안에서만 작동
</span><span class="n">MAX_BYTES_READ</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">MAX_BYTES_READ</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">65536</span><span class="sh">"</span><span class="p">))</span>  <span class="c1"># 64KB
</span><span class="n">MAX_LIST_ENTRIES</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">MAX_LIST_ENTRIES</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">200</span><span class="sh">"</span><span class="p">))</span>
<span class="n">MAX_FILES_SCAN</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">MAX_FILES_SCAN</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">400</span><span class="sh">"</span><span class="p">))</span>
<span class="n">MODEL</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">OSS_MODEL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-oss-20b</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># === 유틸: 경로 안전성 보장 ===
</span><span class="k">def</span> <span class="nf">_safe_join</span><span class="p">(</span><span class="n">rel</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">SAFE_ROOT 기준 상대경로를 절대경로로 변환하고, 루트 밖 접근을 차단.</span><span class="sh">"""</span>
    <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">SAFE_ROOT</span> <span class="o">/</span> <span class="n">rel</span><span class="p">).</span><span class="nf">resolve</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">SAFE_ROOT</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Path escapes SAFE_ROOT: </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span>

<span class="k">def</span> <span class="nf">_is_text</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">간단한 바이너리 판단: 널 바이트 유무 + 가벼운 디코딩 시도.</span><span class="sh">"""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">path</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">head</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="mi">2048</span><span class="p">)</span>
        <span class="k">if</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x00</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">head</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="n">enc</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">utf-8-sig</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">cp949</span><span class="sh">"</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">head</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">enc</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="k">continue</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>

<span class="c1"># === 로컬 툴 구현 ===
</span><span class="k">async</span> <span class="k">def</span> <span class="nf">tool_list_dir</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">,</span> <span class="n">glob</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="p">,</span> <span class="n">include_hidden</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">base</span> <span class="o">=</span> <span class="nf">_safe_join</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">base</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">not found: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">base</span><span class="p">.</span><span class="nf">is_file</span><span class="p">():</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">base</span><span class="p">.</span><span class="n">parent</span>
    <span class="n">entries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">base</span><span class="p">.</span><span class="nf">glob</span><span class="p">(</span><span class="n">glob</span><span class="p">):</span>
        <span class="c1"># 숨김 파일 제외 옵션
</span>        <span class="n">name</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">include_hidden</span> <span class="ow">and</span> <span class="n">name</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="c1"># SAFE_ROOT 밖 symlink는 차단
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">resolved</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">resolve</span><span class="p">()</span>
            <span class="n">resolved</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">SAFE_ROOT</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">SAFE_ROOT</span><span class="p">)),</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">dir</span><span class="sh">"</span> <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">()</span> <span class="k">else</span> <span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">stat</span><span class="p">().</span><span class="n">st_size</span> <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_file</span><span class="p">()</span> <span class="k">else</span> <span class="bp">None</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="n">entries</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;=</span> <span class="n">MAX_LIST_ENTRIES</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">root</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">SAFE_ROOT</span><span class="p">),</span> <span class="sh">"</span><span class="s">dir</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">base</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">SAFE_ROOT</span><span class="p">)),</span> <span class="sh">"</span><span class="s">count</span><span class="sh">"</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">entries</span><span class="p">),</span> <span class="sh">"</span><span class="s">entries</span><span class="sh">"</span><span class="p">:</span> <span class="n">entries</span><span class="p">}</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">tool_read_text</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_bytes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">maxb</span> <span class="o">=</span> <span class="n">max_bytes</span> <span class="ow">or</span> <span class="n">MAX_BYTES_READ</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nf">_safe_join</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">exists</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_file</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">file not found: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nf">_is_text</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">binary or non-text file (blocked)</span><span class="sh">"</span><span class="p">}</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">stat</span><span class="p">().</span><span class="n">st_size</span>
    <span class="n">content</span> <span class="o">=</span> <span class="sh">""</span>
    <span class="n">enc_used</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c1"># 인코딩 폴백
</span>    <span class="k">for</span> <span class="n">enc</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">utf-8-sig</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">cp949</span><span class="sh">"</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">p</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">enc</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">content</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="n">maxb</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">enc_used</span> <span class="o">=</span> <span class="n">enc</span>
            <span class="k">break</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">continue</span>
    <span class="n">truncated</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">content</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">maxb</span>
    <span class="k">if</span> <span class="n">truncated</span><span class="p">:</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">content</span><span class="p">[:</span><span class="n">maxb</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">SAFE_ROOT</span><span class="p">)),</span>
        <span class="sh">"</span><span class="s">encoding</span><span class="sh">"</span><span class="p">:</span> <span class="n">enc_used</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">truncated</span><span class="sh">"</span><span class="p">:</span> <span class="n">truncated</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">content</span><span class="p">,</span>
    <span class="p">}</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">tool_find_in_files</span><span class="p">(</span><span class="n">root</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">,</span> <span class="n">pattern</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span><span class="p">,</span> <span class="n">regex</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
                             <span class="n">glob</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">**/*</span><span class="sh">"</span><span class="p">,</span> <span class="n">case_sensitive</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
                             <span class="n">max_files</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">max_hits_per_file</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">base</span> <span class="o">=</span> <span class="nf">_safe_join</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">base</span><span class="p">.</span><span class="nf">exists</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">base</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">dir not found: </span><span class="si">{</span><span class="n">root</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
    <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">case_sensitive</span> <span class="k">else</span> <span class="n">re</span><span class="p">.</span><span class="n">IGNORECASE</span>
    <span class="n">rx</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="n">pattern</span> <span class="k">if</span> <span class="n">regex</span> <span class="k">else</span> <span class="n">re</span><span class="p">.</span><span class="nf">escape</span><span class="p">(</span><span class="n">pattern</span><span class="p">),</span> <span class="n">flags</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">files_scanned</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">hit_files</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">limit</span> <span class="o">=</span> <span class="n">max_files</span> <span class="ow">or</span> <span class="n">MAX_FILES_SCAN</span>

    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">base</span><span class="p">.</span><span class="nf">glob</span><span class="p">(</span><span class="n">glob</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">files_scanned</span> <span class="o">&gt;=</span> <span class="n">limit</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">resolved</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">resolve</span><span class="p">()</span>
            <span class="n">resolved</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">SAFE_ROOT</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_file</span><span class="p">():</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nf">_is_text</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">files_scanned</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># 크기 제한 내에서만 스캔
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">p</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="n">MAX_BYTES_READ</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">hits</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">text</span><span class="p">.</span><span class="nf">splitlines</span><span class="p">(),</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">rx</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
                <span class="n">hits</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">line</span><span class="sh">"</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span> <span class="sh">"</span><span class="s">preview</span><span class="sh">"</span><span class="p">:</span> <span class="n">line</span><span class="p">[:</span><span class="mi">300</span><span class="p">]})</span>
                <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">hits</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">max_hits_per_file</span><span class="p">:</span>
                    <span class="k">break</span>
        <span class="k">if</span> <span class="n">hits</span><span class="p">:</span>
            <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">SAFE_ROOT</span><span class="p">)),</span> <span class="sh">"</span><span class="s">hits</span><span class="sh">"</span><span class="p">:</span> <span class="n">hits</span><span class="p">})</span>
            <span class="n">hit_files</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">root</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">base</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">SAFE_ROOT</span><span class="p">)),</span>
        <span class="sh">"</span><span class="s">files_scanned</span><span class="sh">"</span><span class="p">:</span> <span class="n">files_scanned</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">hit_files</span><span class="sh">"</span><span class="p">:</span> <span class="n">hit_files</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">pattern</span><span class="sh">"</span><span class="p">:</span> <span class="n">pattern</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">results</span><span class="sh">"</span><span class="p">:</span> <span class="n">results</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">truncated_note</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Scanned up to </span><span class="si">{</span><span class="n">MAX_BYTES_READ</span><span class="si">}</span><span class="s"> bytes per file, </span><span class="si">{</span><span class="n">limit</span><span class="si">}</span><span class="s"> files max.</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">}</span>

<span class="c1"># === OpenAI tools 스키마 ===
</span><span class="n">OPENAI_TOOLS</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_dir</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List directory entries under SAFE_ROOT.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Relative dir path from SAFE_ROOT</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">},</span>
                    <span class="sh">"</span><span class="s">glob</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">glob pattern</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="p">},</span>
                    <span class="sh">"</span><span class="s">include_hidden</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">boolean</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">},</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]</span>
            <span class="p">}</span>
        <span class="p">},</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a text file with size/encoding safeguards.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Relative file path from SAFE_ROOT</span><span class="sh">"</span><span class="p">},</span>
                    <span class="sh">"</span><span class="s">max_bytes</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">integer</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">minimum</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="sh">"</span><span class="s">maximum</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1048576</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">]</span>
            <span class="p">}</span>
        <span class="p">},</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">find_in_files</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Search for a string/regex across text files.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">root</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">},</span>
                    <span class="sh">"</span><span class="s">pattern</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string or regex</span><span class="sh">"</span><span class="p">},</span>
                    <span class="sh">"</span><span class="s">regex</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">boolean</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">},</span>
                    <span class="sh">"</span><span class="s">glob</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">**/*</span><span class="sh">"</span><span class="p">},</span>
                    <span class="sh">"</span><span class="s">case_sensitive</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">boolean</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">},</span>
                    <span class="sh">"</span><span class="s">max_files</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">integer</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">minimum</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="sh">"</span><span class="s">maximum</span><span class="sh">"</span><span class="p">:</span> <span class="mi">5000</span><span class="p">},</span>
                    <span class="sh">"</span><span class="s">max_hits_per_file</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">integer</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">minimum</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="sh">"</span><span class="s">maximum</span><span class="sh">"</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="mi">5</span><span class="p">},</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">pattern</span><span class="sh">"</span><span class="p">]</span>
            <span class="p">}</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">]</span>

<span class="c1"># === 라우터 ===
</span><span class="k">async</span> <span class="k">def</span> <span class="nf">call_local_tool</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">list_dir</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="nf">tool_list_dir</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">read_text</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="nf">tool_read_text</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">find_in_files</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="nf">tool_find_in_files</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">unknown tool: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">_assistant_msg_dict</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">OpenAI SDK 객체를 Chat API 재호출용 dict로 변환.</span><span class="sh">"""</span>
    <span class="n">tool_calls</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
            <span class="n">tool_calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">})</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="n">tool_calls</span> <span class="ow">or</span> <span class="bp">None</span><span class="p">}</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_query</span><span class="p">(</span><span class="n">user_input</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">AsyncOpenAI</span><span class="p">(</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">http://localhost:8000/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">dummy</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">timeout</span><span class="o">=</span><span class="mf">60.0</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">system_prompt</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sh">"</span><span class="s">You can inspect files inside SAFE_ROOT only. </span><span class="sh">"</span>
        <span class="sa">f</span><span class="sh">"</span><span class="s">SAFE_ROOT is </span><span class="sh">'</span><span class="si">{</span><span class="n">SAFE_ROOT</span><span class="si">}</span><span class="sh">'</span><span class="s">. </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">Call tools only when needed. Prefer concise outputs.</span><span class="sh">"</span>
    <span class="p">)</span>
    <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">system_prompt</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_input</span><span class="p">},</span>
    <span class="p">]</span>

    <span class="n">MAX_HOPS</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">MAX_HOPS</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">8</span><span class="sh">"</span><span class="p">))</span>
    <span class="n">final_text</span> <span class="o">=</span> <span class="sh">""</span>

    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">MAX_HOPS</span><span class="p">):</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">MODEL</span><span class="p">,</span>
            <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">OPENAI_TOOLS</span><span class="p">,</span>
            <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">temperature</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
        <span class="n">calls</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span> <span class="ow">or</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>  <span class="c1"># 종료
</span>            <span class="n">final_text</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span>
            <span class="k">break</span>

        <span class="c1"># 동턴 병렬 실행
</span>        <span class="k">async</span> <span class="k">def</span> <span class="nf">_run_one</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">c</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">_</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span><span class="p">}</span>
            <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="nf">call_local_tool</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">),</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">20.0</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="p">}</span>

        <span class="n">tool_msgs</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">gather</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="nf">_run_one</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">])</span>

        <span class="c1"># 응답(assistant) + 각 tool 결과를 누적
</span>        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">_assistant_msg_dict</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">final_text</span>

<span class="c1"># === CLI 실행 ===
</span><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">sys</span>
    <span class="n">q</span> <span class="o">=</span> <span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">data 폴더에서 TODO가 들어간 파일들 찾아줘. 그리고 상위 3개만 요약해.</span><span class="sh">"</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[SAFE_ROOT] </span><span class="si">{</span><span class="n">SAFE_ROOT</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[QUERY] </span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">run_query</span><span class="p">(</span><span class="n">q</span><span class="p">)))</span>
</code></pre></div></div>

<hr />

<h2 id="실행-방법">실행 방법</h2>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 1) 환경변수: 여러분의 OpenAI-호환 GPT-OSS 엔드포인트</span>
<span class="nb">export </span><span class="nv">OPENAI_BASE_URL</span><span class="o">=</span>http://localhost:8000/v1
<span class="nb">export </span><span class="nv">OPENAI_API_KEY</span><span class="o">=</span>dummy
<span class="nb">export </span><span class="nv">OSS_MODEL</span><span class="o">=</span>gpt-oss-20b

<span class="c"># 2) 파일 시스템 루트(이 경로 밖은 접근 금지)</span>
<span class="nb">export </span><span class="nv">SAFE_ROOT</span><span class="o">=</span>/path/to/workspace

<span class="c"># 3) 실행</span>
python local_fs_tools_bridge.py <span class="s2">"data 폴더에서 TODO 포함 파일 찾아 요약"</span>
</code></pre></div></div>

<hr />

<h2 id="언제-이-방식이-좋은가--아닌가">언제 이 방식이 좋은가 / 아닌가</h2>

<ul>
  <li>
    <p>👍 <strong>좋음</strong> : 내부 스크립트·리포 정리, 로그 조사, 빌드 산출물 검토 등 “한 머신 안” 단순 오토메이션</p>
  </li>
  <li>
    <p>🤔 <strong>아쉬움</strong> : 여러 앱/팀에서 <strong>재사용</strong> 하거나, 네트워크 자원/DB/API 같은 <strong>원격 리소스</strong> 까지 표준화하고 싶다면 <strong>MCP 서버화</strong> 가 장점(발견성·권한·감사·재사용)</p>
  </li>
</ul>

<p>원하시면 위 툴셋에 <code class="language-plaintext highlighter-rouge">write_text</code>, <code class="language-plaintext highlighter-rouge">tail</code>, <code class="language-plaintext highlighter-rouge">zip_list</code>, <code class="language-plaintext highlighter-rouge">json_query(jq)</code> 같은 툴을 추가해 드릴게요. 현재 쓰는 폴더 구조나 용례를 알려주시면, 스키마/가드를 맞춰 커스터마이즈해 드립니다.</p>

<p class="chat--user">

이걸 표준화된 형태로 할 수는 없을까? harmony도 다 호환되는거야?

</p>

<p>맞아요—<strong>표준화</strong> 하려면 딱 두 축만 잡으면 됩니다:<br />
(1) <strong>툴/데이터 인터페이스 표준 = MCP</strong>(서버·클라이언트 규약)<br />
(2) <strong>대화/툴호출 포맷 표준 = Harmony</strong>(모델 프롬프트/응답 포맷)<br />
둘은 <strong>서로 독립</strong> 이지만 잘 맞물립니다. MCP는 “도구를 어떻게 노출·호출할까”를 표준화하고, Harmony는 “모델과의 메시지 포맷”을 표준화해요. <a href="https://modelcontextprotocol.io/docs/learn/architecture?utm_source=chatgpt.com">modelcontextprotocol.io+1</a></p>

<hr />

<h1 id="무엇이-표준인가-한눈에">무엇이 “표준”인가 (한눈에)</h1>

<ul>
  <li>
    <p><strong>MCP</strong> : JSON-RPC 기반 프로토콜. 표준 전송은 <strong>stdio</strong> 와 <strong>Streamable HTTP</strong> 두 가지. 공식 Python/TS SDK가 있고, 여기에 맞춰 툴/리소스를 내보내면 어떤 호스트/에이전트에서도 재사용됩니다. <a href="https://modelcontextprotocol.io/specification/2025-03-26/basic/transports?utm_source=chatgpt.com">modelcontextprotocol.io+2</a></p>
  </li>
  <li>
    <p><strong>Harmony</strong> : GPT-OSS 계열이 학습한 <strong>대화·툴호출 포맷</strong>. Responses API 스타일을 모사하며, <strong>공식 렌더러(openai-harmony)</strong>가 있어 Python에서도 그대로 씁니다. (여러 배포자/서빙 솔루션은 내부에서 자동 처리하기도 함) <a href="https://github.com/openai/harmony?utm_source=chatgpt.com">GitHub+1</a></p>
  </li>
</ul>

<blockquote>
  <p>요약: <strong>MCP로 도구 측을 표준화</strong> 하고, <strong>Harmony로 모델 메시지 포맷을 표준화</strong> 하면 끝.</p>
</blockquote>

<hr />

<h1 id="내가-가진-로컬-파이썬-함수를-표준화하는-두-길">내가 가진 “로컬 파이썬 함수”를 표준화하는 두 길</h1>

<h2 id="a-최소-비용으로-mcp-서버-로-감싸기-권장">A) 최소 비용으로 <strong>MCP 서버</strong> 로 감싸기 (권장)</h2>

<p>로컬 함수들을 MCP <strong>툴</strong> 로 내보내면, Claude/ChatGPT/Gemini/에이전트 SDK에서 그대로 붙일 수 있어요. 파이썬에선 <strong>FastMCP</strong> 가 가장 손쉬움(데코레이터만 붙이면 schema 생성 포함). <a href="https://github.com/jlowin/fastmcp">GitHub+1</a></p>

<p><strong>예시(30줄대): 로컬 파일 툴 → MCP 서버</strong></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># mcp_files.py
</span><span class="kn">from</span> <span class="n">fastmcp</span> <span class="kn">import</span> <span class="n">FastMCP</span>
<span class="kn">from</span> <span class="n">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="n">mcp</span> <span class="o">=</span> <span class="nc">FastMCP</span><span class="p">(</span><span class="sh">"</span><span class="s">LocalFS</span><span class="sh">"</span><span class="p">)</span>
<span class="n">SAFE_ROOT</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="sh">"</span><span class="s">/path/to/root</span><span class="sh">"</span><span class="p">).</span><span class="nf">resolve</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">safe</span><span class="p">(</span><span class="n">rel</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">SAFE_ROOT</span> <span class="o">/</span> <span class="n">rel</span><span class="p">).</span><span class="nf">resolve</span><span class="p">()</span>
    <span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">SAFE_ROOT</span><span class="p">)</span>  <span class="c1"># 밖 탈출 시 예외
</span>    <span class="k">return</span> <span class="n">p</span>

<span class="nd">@mcp.tool</span>
<span class="k">def</span> <span class="nf">list_dir</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
    <span class="n">base</span> <span class="o">=</span> <span class="nf">safe</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">dir</span><span class="sh">"</span> <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">()</span> <span class="k">else</span> <span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="p">}</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">base</span><span class="p">.</span><span class="nf">iterdir</span><span class="p">()]</span>

<span class="nd">@mcp.tool</span>
<span class="k">def</span> <span class="nf">read_text</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_bytes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">65536</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nf">safe</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">read_text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)[:</span><span class="n">max_bytes</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">SAFE_ROOT</span><span class="p">)),</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">text</span><span class="p">}</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">mcp</span><span class="p">.</span><span class="nf">run</span><span class="p">()</span>  <span class="c1"># stdio (CLI: `fastmcp run mcp_files.py`)
</span></code></pre></div></div>

<ul>
  <li>
    <p>실행: <code class="language-plaintext highlighter-rouge">uv pip install fastmcp</code> → <code class="language-plaintext highlighter-rouge">fastmcp run mcp_files.py</code></p>
  </li>
  <li>
    <p>필요 시 <strong>HTTP(스트리머블)</strong> 전송으로 바꿔 다중 클라이언트도 처리 가능. <a href="https://github.com/jlowin/fastmcp">GitHub+1</a></p>
  </li>
</ul>

<h2 id="b-서버-없이-호스트-안에서-harmony만-채택">B) 서버 없이, <strong>호스트 안에서 Harmony만 채택</strong></h2>

<p>지금처럼 <code class="language-plaintext highlighter-rouge">AsyncOpenAI</code>로 <strong>while 루프</strong> 를 돌리되, 메시지를 <strong>Harmony 렌더러</strong> 로 구성하면 GPT-OSS 쪽 호환성이 올라갑니다. GPT-OSS는 Harmony 포맷을 전제로 학습되었고, 공식 가이드/렌더러가 있습니다. (단, vLLM/일부 프로바이더는 내부에서 Harmony를 자동 처리하기도 함) <a href="https://github.com/openai/harmony?utm_source=chatgpt.com">GitHub+1</a></p>

<hr />

<h1 id="harmony도-다-호환되는-거야에-대한-정리">“Harmony도 다 호환되는 거야?”에 대한 정리</h1>

<ul>
  <li>
    <p><strong>Harmony ↔ MCP는 층이 다릅니다.</strong><br />
MCP는 <strong>툴·리소스 호출 표준</strong> , Harmony는 <strong>대화/툴호출 포맷 표준</strong> 이에요. 보통 “호스트”가 MCP에서 얻은 툴 스키마를 <strong>모델이 이해하는 포맷(예: Harmony 또는 OpenAI tools 포맷)</strong>으로 바꿔 넣습니다. 그래서 <strong>동시에 써도 문제 없습니다.</strong> <a href="https://openai.github.io/openai-agents-python/mcp/?utm_source=chatgpt.com">openai.github.io</a></p>
  </li>
  <li>
    <p><strong>GPT-OSS 사용 시</strong> : 직접 서빙하는 엔진이 Harmony를 <strong>자동 처리하지 않는다면</strong> , <code class="language-plaintext highlighter-rouge">openai-harmony</code> 같은 <strong>렌더러</strong> 를 쓰세요. 그렇지 않으면 툴 호출/컨텍스트 주입이 불안정할 수 있습니다. <a href="https://cookbook.openai.com/articles/openai-harmony?utm_source=chatgpt.com">OpenAI Cookbook</a></p>
  </li>
</ul>

<hr />

<h1 id="단계별-권장-루트-step-by-step">단계별 권장 루트 (Step-by-Step)</h1>

<ol>
  <li>
    <p><strong>로컬 함수 → MCP 서버화</strong>(FastMCP 추천). 위 예시 같은 파일 툴부터 노출. <a href="https://github.com/jlowin/fastmcp">GitHub</a></p>
  </li>
  <li>
    <p><strong>호스트(브리지)</strong>에서 MCP <code class="language-plaintext highlighter-rouge">tools/list</code> → 모델용 포맷으로 변환(Harmony 또는 Chat Completions tools).</p>
  </li>
  <li>
    <p><strong>툴 호출 루프</strong>(while): <code class="language-plaintext highlighter-rouge">tool_use</code> 나오면 MCP <code class="language-plaintext highlighter-rouge">call_tool</code> 실행 → <code class="language-plaintext highlighter-rouge">tool_result</code> 재주입(또는 ChatCompletions의 tool 메시지 규격). <strong>ID 1:1 매칭</strong> 지키기. <a href="https://modelcontextprotocol.io/docs/develop/build-client?utm_source=chatgpt.com">modelcontextprotocol.io</a></p>
  </li>
  <li>
    <p><strong>전송·보안</strong> : 로컬은 stdio, 분산은 Streamable HTTP + 세션/인증. <a href="https://modelcontextprotocol.io/specification/2025-03-26/basic/transports?utm_source=chatgpt.com">modelcontextprotocol.io</a></p>
  </li>
</ol>

<hr />

<p>필요하시면, 지금 쓰시는 <strong>AsyncOpenAI 호출 루프</strong> 에 맞춰</p>

<ul>
  <li>
    <p>(A) 위 로컬 파일 툴을 <strong>FastMCP 서버</strong> 로 감싼 버전,</p>
  </li>
  <li>
    <p>(B) <strong>Harmony 렌더러</strong> 를 적용한 브리지(while 루프)<br />
두 가지를 바로 붙여드릴게요.</p>
  </li>
</ul>

<p class="chat--user">

서버로 감싸면 서버를 또 띄워야하는거아냐?

</p>

<p>맞아요, “서버로 감싼다” 해도 꼭 <strong>항상 떠 있는 데몬</strong> 을 의미하진 않아요.<br />
MCP는 두 전송을 지원하는데:</p>

<ul>
  <li>
    <p><strong>stdio(권장, 로컬)</strong> : 호스트가 <strong>필요할 때만 서브프로세스</strong> 를 띄웁니다. 포트도 없고, 끝나면 같이 내려가요. “또 하나의 인프라”가 아니라 <strong>일회성 프로세스</strong> 느낌.</p>
  </li>
  <li>
    <p><strong>HTTP(원격/다중 클라)</strong> : 진짜 서버를 띄워서 여러 호스트가 붙게 할 때.</p>
  </li>
</ul>

<p>즉, <strong>여러분 환경에선 stdio면 충분</strong> 해서 “상시 서버 운영” 안 해도 됩니다. while 루프 돌리는 호스트가 알아서 켰다 끄면 끝!</p>

<hr />

<h1 id="바로-쓰는-패턴-step-by-step">바로 쓰는 패턴 (Step-by-step)</h1>

<ol>
  <li><strong>로컬 툴을 MCP 서버로 래핑</strong> (stdio용, 20~30줄)</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># mcp_files.py  — FastMCP 예시 (pip/uv: fastmcp 설치)
</span><span class="kn">from</span> <span class="n">fastmcp</span> <span class="kn">import</span> <span class="n">FastMCP</span>
<span class="kn">from</span> <span class="n">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="n">mcp</span> <span class="o">=</span> <span class="nc">FastMCP</span><span class="p">(</span><span class="sh">"</span><span class="s">LocalFS</span><span class="sh">"</span><span class="p">)</span>
<span class="n">SAFE_ROOT</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">).</span><span class="nf">resolve</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">safe</span><span class="p">(</span><span class="n">rel</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">SAFE_ROOT</span> <span class="o">/</span> <span class="n">rel</span><span class="p">).</span><span class="nf">resolve</span><span class="p">()</span>
    <span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">SAFE_ROOT</span><span class="p">)</span>  <span class="c1"># 밖으로 나가면 예외
</span>    <span class="k">return</span> <span class="n">p</span>

<span class="nd">@mcp.tool</span>
<span class="k">def</span> <span class="nf">list_dir</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">):</span>
    <span class="n">base</span> <span class="o">=</span> <span class="nf">safe</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">dir</span><span class="sh">"</span> <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">()</span> <span class="k">else</span> <span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="p">}</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">base</span><span class="p">.</span><span class="nf">iterdir</span><span class="p">()]</span>

<span class="nd">@mcp.tool</span>
<span class="k">def</span> <span class="nf">read_text</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_bytes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">65536</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nf">safe</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">read_text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)[:</span><span class="n">max_bytes</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">SAFE_ROOT</span><span class="p">)),</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">text</span><span class="p">}</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">mcp</span><span class="p">.</span><span class="nf">run</span><span class="p">()</span>  <span class="c1"># 기본이 stdio: 호스트가 서브프로세스로 띄움
</span></code></pre></div></div>

<ol>
  <li><strong>호스트에서 “서브프로세스”로 붙이기</strong> (포트 없음)</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># host.py — 여러분이 이미 쓰는 AsyncOpenAI while 루프에 이 부분만 추가
</span><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">json</span><span class="p">,</span> <span class="n">os</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">AsyncOpenAI</span>
<span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioTransport</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">connect_mcp</span><span class="p">():</span>
    <span class="c1"># 호스트가 필요할 때만 서버 스크립트를 서브프로세스로 실행
</span>    <span class="n">t</span> <span class="o">=</span> <span class="nc">StdioTransport</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">python</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">mcp_files.py</span><span class="sh">"</span><span class="p">])</span>
    <span class="n">sess</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">sess</span><span class="p">.</span><span class="nf">__aenter__</span><span class="p">()</span>              <span class="c1"># initialize 교섭
</span>    <span class="k">return</span> <span class="n">sess</span>

<span class="k">def</span> <span class="nf">mcp_tools_to_openai</span><span class="p">(</span><span class="n">tools</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">MCP tool</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">inputSchema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span> <span class="ow">or</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{}}</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">]</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">AsyncOpenAI</span><span class="p">(</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">http://localhost:8000/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">dummy</span><span class="sh">"</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="k">async</span> <span class="k">with</span> <span class="k">await</span> <span class="nf">connect_mcp</span><span class="p">()</span> <span class="k">as</span> <span class="n">mcp</span><span class="p">:</span>
        <span class="n">tools</span> <span class="o">=</span> <span class="k">await</span> <span class="n">mcp</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
        <span class="n">oai_tools</span> <span class="o">=</span> <span class="nf">mcp_tools_to_openai</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span>

        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">Use tools only when needed.</span><span class="sh">"</span><span class="p">},</span>
            <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">현재 폴더 목록 보여줘</span><span class="sh">"</span><span class="p">}</span>
        <span class="p">]</span>

        <span class="c1"># === while 루프 핵심 ===
</span>        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">OSS_MODEL</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">gpt-oss-20b</span><span class="sh">"</span><span class="p">),</span>
                <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">oai_tools</span><span class="p">,</span> <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mf">0.2</span>
            <span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">res</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="nf">print</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">)</span>
                <span class="k">break</span>

            <span class="c1"># 동턴 tool_calls 실행 후 결과 재주입
</span>            <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="n">mcp</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">c</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">arguments</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>
                <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span>
                        <span class="p">{</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">out</span><span class="p">,</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
                         <span class="sh">"</span><span class="s">raw</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="sh">"</span><span class="s">__dict__</span><span class="sh">"</span><span class="p">,</span> <span class="nf">str</span><span class="p">(</span><span class="n">out</span><span class="p">))},</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                <span class="p">})</span>

            <span class="c1"># assistant 응답 + tool 결과를 누적
</span>            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[{</span>
                    <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span><span class="p">}</span>
                <span class="p">}</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">]</span>
            <span class="p">})</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<ul>
  <li>실행:</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">OPENAI_BASE_URL</span><span class="o">=</span>http://localhost:8000/v1
<span class="nb">export </span><span class="nv">OPENAI_API_KEY</span><span class="o">=</span>dummy
<span class="nb">export </span><span class="nv">OSS_MODEL</span><span class="o">=</span>gpt-oss-20b
python host.py
</code></pre></div></div>

<p>여기서 <code class="language-plaintext highlighter-rouge">host.py</code>가 <code class="language-plaintext highlighter-rouge">mcp_files.py</code>를 <strong>그때그때 서브프로세스로 실행</strong> 하고, 작업 끝나면 프로세스도 같이 종료됩니다. 네트워크 포트/데몬 X.</p>

<hr />

<h2 id="언제-진짜-서버http가-유리한가">언제 진짜 “서버(HTTP)”가 유리한가?</h2>

<ul>
  <li>
    <p>여러 호스트(IDE/에이전트)가 <strong>동시에 공유</strong> 할 공용 툴일 때</p>
  </li>
  <li>
    <p>원격/컨테이너/서버리스 등 <strong>분산 배치</strong> 가 필요할 때</p>
  </li>
  <li>
    <p><strong>관찰성/모니터링/스케일링</strong> 을 표준 인프라로 묶고 싶을 때</p>
  </li>
</ul>

<p>그 외엔 <strong>stdio 서브프로세스</strong> 가 가장 단순하고 안전해요.<br />
정리하면: <strong>“서버 또 띄워?” → (대부분) 아니요. 호스트가 잠깐 켰다 끄는 stdio면 충분합니다.</strong></p>

<p class="chat--user">

지금 보면 mcp_files.py라는 파일 하나를 mcp로 띄우잖아. 그거 대신에 그냥 함수나 클래스 단위로 올릴수없나?

</p>

<p>네, “파일 하나(mcp_files.py)를 띄우는 방식” 말고 <strong>함수/클래스 단위로 바로 올리는</strong> 표준적인 방법이 있어요. 포인트는 <strong>MCP 서버 인스턴스를 만들 때 그 함수·메서드를 등록</strong> 해 주는 겁니다. FastMCP 기준으로 두 가지 패턴이 깔끔합니다.</p>

<hr />

<h2 id="1-팩토리-함수-엔트리포인트권장">1) 팩토리 함수 엔트리포인트(권장)</h2>

<p>별도의 데몬 없이, 호스트가 필요할 때만 <strong>stdio 서브프로세스</strong> 로 불러 쓰세요. FastMCP는 <code class="language-plaintext highlighter-rouge">fastmcp run &lt;모듈:팩토리함수&gt;</code>를 지원합니다. 팩토리 함수가 <strong>서버 인스턴스를 만들어 반환</strong> 하면 끝! <a href="https://gofastmcp.com/patterns/cli">gofastmcp.com</a></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># yourpkg/localfs.py  (여기에 “그냥 쓰던” 함수/클래스가 있다고 가정)
</span><span class="kn">from</span> <span class="n">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="k">class</span> <span class="nc">Files</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">root</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span> <span class="n">self</span><span class="p">.</span><span class="n">root</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">root</span><span class="p">).</span><span class="nf">resolve</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">list_dir</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
        <span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">root</span> <span class="o">/</span> <span class="n">path</span><span class="p">).</span><span class="nf">resolve</span><span class="p">()</span>
        <span class="n">base</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">root</span><span class="p">)</span>  <span class="c1"># 루트 밖 접근 차단
</span>        <span class="k">return</span> <span class="p">[{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">dir</span><span class="sh">"</span> <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">()</span> <span class="k">else</span> <span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="p">}</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">base</span><span class="p">.</span><span class="nf">iterdir</span><span class="p">()]</span>

<span class="k">def</span> <span class="nf">read_text</span><span class="p">(</span><span class="n">root</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_bytes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">65536</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">root</span><span class="p">).</span><span class="nf">resolve</span><span class="p">()</span> <span class="o">/</span> <span class="n">path</span><span class="p">).</span><span class="nf">resolve</span><span class="p">()</span>
    <span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">root</span><span class="p">).</span><span class="nf">resolve</span><span class="p">())</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">read_text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)[:</span><span class="n">max_bytes</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">text</span><span class="p">}</span>

<span class="c1"># yourpkg/server.py  (“팩토리 함수”로 MCP 서버 구성)
</span><span class="kn">from</span> <span class="n">fastmcp</span> <span class="kn">import</span> <span class="n">FastMCP</span>
<span class="kn">from</span> <span class="n">.localfs</span> <span class="kn">import</span> <span class="n">Files</span><span class="p">,</span> <span class="n">read_text</span>

<span class="n">SAFE_ROOT</span> <span class="o">=</span> <span class="sh">"</span><span class="s">.</span><span class="sh">"</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">create_server</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">FastMCP</span><span class="p">:</span>
    <span class="n">mcp</span> <span class="o">=</span> <span class="nc">FastMCP</span><span class="p">(</span><span class="sh">"</span><span class="s">LocalFS</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">fs</span> <span class="o">=</span> <span class="nc">Files</span><span class="p">(</span><span class="n">SAFE_ROOT</span><span class="p">)</span>

    <span class="c1"># 함수/메서드를 “등록”만 하면 MCP 툴이 됩니다
</span>    <span class="n">mcp</span><span class="p">.</span><span class="nf">tool</span><span class="p">(</span><span class="n">fs</span><span class="p">.</span><span class="n">list_dir</span><span class="p">)</span>                  <span class="c1"># 인스턴스 메서드(바운드 메서드) 등록
</span>    <span class="n">mcp</span><span class="p">.</span><span class="nf">tool</span><span class="p">(</span><span class="k">lambda</span> <span class="n">path</span><span class="p">:</span> <span class="nf">read_text</span><span class="p">(</span><span class="n">SAFE_ROOT</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>  <span class="c1"># 루트 고정한 래퍼 함수
</span>
    <span class="k">return</span> <span class="n">mcp</span>
</code></pre></div></div>

<p>실행(항상-켜진 서버 필요 X):</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>uv pip <span class="nb">install </span>fastmcp
fastmcp run yourpkg/server.py:create_server   <span class="c"># STDIO 기본</span>
<span class="c"># 또는 원하시면 HTTP/SSE 전송도 지원</span>
fastmcp run yourpkg/server.py:create_server <span class="nt">--transport</span> http <span class="nt">--port</span> 3333
</code></pre></div></div>

<ul>
  <li>
    <p>이 <strong>CLI 엔트리포인트</strong> 는 파일 이름이 아니라 <strong>함수/변수 레벨로 지목</strong> 할 수 있고(예: <code class="language-plaintext highlighter-rouge">module:factory_fn</code>), 내부에서 장착한 함수/클래스들이 툴로 노출됩니다. <a href="https://gofastmcp.com/patterns/cli">gofastmcp.com</a></p>
  </li>
  <li>
    <p>stdio 전송은 호스트가 <strong>그때그때 서브프로세스 생성/종료</strong> 해 쓰는 구조라 “서버 또 띄워야 해?” 부담이 적습니다. 필요하면 Streamable HTTP도 표준이에요. <a href="https://modelcontextprotocol.io/specification/2025-03-26/basic/transports?utm_source=chatgpt.com">modelcontextprotocol.io+1</a></p>
  </li>
</ul>

<hr />

<h2 id="2-클래스-메서드-직접-데코레이트-대신-등록-메서드-패턴">2) “클래스 메서드 직접 데코레이트” 대신 “등록 메서드” 패턴</h2>

<p>인스턴스/클래스 메서드는 <strong>정의 시 데코레이터를 바로 붙이지 말고</strong> , <strong>인스턴스를 만든 뒤 바운드 메서드로 등록</strong> 하세요. 그래야 <code class="language-plaintext highlighter-rouge">self/cls</code> 파라미터가 스키마에 드러나지 않고 올바르게 노출됩니다. (FastMCP 문서의 권장 패턴) <a href="https://gofastmcp.com/patterns/decorating-methods">gofastmcp.com</a></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">fastmcp</span> <span class="kn">import</span> <span class="n">FastMCP</span>

<span class="k">class</span> <span class="nc">Math</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span> <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>

<span class="n">mcp</span> <span class="o">=</span> <span class="nc">FastMCP</span><span class="p">(</span><span class="sh">"</span><span class="s">Demo</span><span class="sh">"</span><span class="p">)</span>
<span class="n">math</span> <span class="o">=</span> <span class="nc">Math</span><span class="p">()</span>
<span class="n">mcp</span><span class="p">.</span><span class="nf">tool</span><span class="p">(</span><span class="n">math</span><span class="p">.</span><span class="n">add</span><span class="p">)</span>         <span class="c1"># ← 인스턴스 만든 뒤 등록(권장)
</span>
<span class="c1"># (참고) 정적 메서드는 등록해도 되지만, 인스턴스/클래스 메서드는 위 방식이 안전합니다. :contentReference[oaicite:4]{index=4}
</span></code></pre></div></div>

<hr />

<h2 id="호스트여러분의-asyncopenai-루프에서-붙이기">호스트(여러분의 AsyncOpenAI 루프)에서 붙이기</h2>

<p>기존 while 루프의 MCP 세션 생성 부분만 <strong>stdio 커맨드로 교체</strong> 하면 됩니다:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioTransport</span>

<span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioTransport</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">fastmcp</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">run</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">yourpkg/server.py:create_server</span><span class="sh">"</span><span class="p">])</span>
<span class="k">async</span> <span class="k">with</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span> <span class="k">as</span> <span class="n">mcp</span><span class="p">:</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="k">await</span> <span class="n">mcp</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
    <span class="c1"># ↓ 여기서부터는 이전에 쓰시던 tool loop 동일 (tool_calls -&gt; mcp.call_tool -&gt; 재주입)
</span></code></pre></div></div>

<ul>
  <li>stdio/HTTP 등 <strong>전송은 MCP 표준</strong> 이므로, 어떤 호스트에서도 같은 방식으로 연결됩니다. <a href="https://modelcontextprotocol.io/specification/2025-03-26/basic/transports?utm_source=chatgpt.com">modelcontextprotocol.io+1</a></li>
</ul>

<hr />

<h3 id="정리">정리</h3>

<ul>
  <li>
    <p>“파일 하나”가 아니라 <strong>함수/클래스 단위로 구성</strong> 된 모듈을 <strong>팩토리 함수</strong> 로 묶어 <strong>표준 MCP 서버</strong> 를 만들고,</p>
  </li>
  <li>
    <p><strong>stdio</strong> 로 필요할 때만 띄워 쓰면 <strong>상시 서버 운영 없이</strong> 재사용 가능한 표준 툴 체계가 됩니다. <a href="https://gofastmcp.com/patterns/cli">gofastmcp.com+1</a></p>
  </li>
</ul>

<p>원하시면 지금 쓰시는 함수/클래스를 기반으로 <strong><code class="language-plaintext highlighter-rouge">create_server()</code> 스켈레톤</strong>을 바로 만들어 드릴게요—패키지 이름/루트 경로만 알려주세요.</p>

<p class="chat--user">

아니 봐봐. 예를 들어 아래와 같이 간단히 운영할 수 없어? 
<code class="language-plaintext highlighter-rouge">python
@mcp.tool
def list_dir(path: str = "."):
    # implementation

@mcp.tool
def read_text(path: str):
    # implementation

async def main(mcp_list):
    async with AsyncOpenAI(...) as client:
        client.chat.completions.create("Hello", tools=mcp_list)

asyncio.run(main([read_text, list_dir]))
</code>

이런 식으로 그냥 바로 넣고 싶어

</p>

<p>좋아요—that’s exactly doable.<br />
핵심은 <strong>파이썬 함수/메서드 자체를 “도구”로 등록</strong> 하고, 그 시그니처로부터 <strong>OpenAI tools 스키마</strong> 를 만들어 <code class="language-plaintext highlighter-rouge">client.chat.completions.create(..., tools=...)</code>에 넘긴 뒤, 응답의 <code class="language-plaintext highlighter-rouge">tool_calls</code>를 <strong>그 함수에 실행→결과 재주입</strong> 하는 작은 러너를 갖추면 됩니다. MCP 서버는 전혀 필요 없어요.</p>

<p>아래 코드는 그대로 복붙해서 돌아가도록 만든 <strong>초소형 인라인-툴 브리지</strong> 예요.</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">@inline_tool</code>로 함수 등록</p>
  </li>
  <li>
    <p>타입힌트→JSON Schema 변환(기본 타입들)</p>
  </li>
  <li>
    <p>동기/비동기 함수 모두 지원</p>
  </li>
  <li>
    <p>while 루프(툴 호출 없어질 때까지) + <code class="language-plaintext highlighter-rouge">tool_call_id</code> 매칭</p>
  </li>
  <li>
    <p>간단한 파일 툴 <code class="language-plaintext highlighter-rouge">list_dir</code>, <code class="language-plaintext highlighter-rouge">read_text</code> 샘플 포함</p>
  </li>
</ul>

<hr />
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># inline_tools_bridge.py
# pip install openai
</span><span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">inspect</span><span class="p">,</span> <span class="n">json</span><span class="p">,</span> <span class="n">os</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">get_origin</span><span class="p">,</span> <span class="n">get_args</span>

<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">AsyncOpenAI</span>

<span class="c1"># ===============================
# 0) 인라인 툴 등록/스키마 생성기
# ===============================
</span><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">_ToolEntry</span><span class="p">:</span>
    <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">desc</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">schema</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>

<span class="n">_REGISTRY</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">_ToolEntry</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">def</span> <span class="nf">inline_tool</span><span class="p">(</span><span class="n">_fn</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">description</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">함수에 달아주면 자동으로 OpenAI tools 스키마가 만들어져 등록됩니다.</span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">):</span>
        <span class="n">tname</span> <span class="o">=</span> <span class="p">(</span><span class="n">name</span> <span class="ow">or</span> <span class="n">fn</span><span class="p">.</span><span class="n">__name__</span><span class="p">)[:</span><span class="mi">64</span><span class="p">]</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="nf">_build_openai_tool_schema</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">tname</span><span class="p">,</span> <span class="n">description</span> <span class="ow">or</span> <span class="p">(</span><span class="n">fn</span><span class="p">.</span><span class="n">__doc__</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">))</span>
        <span class="n">_REGISTRY</span><span class="p">[</span><span class="n">tname</span><span class="p">]</span> <span class="o">=</span> <span class="nf">_ToolEntry</span><span class="p">(</span><span class="n">fn</span><span class="o">=</span><span class="n">fn</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">tname</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">schema</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">],</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fn</span>
    <span class="k">return</span> <span class="n">decorator</span> <span class="k">if</span> <span class="n">_fn</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">_fn</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_pytype_to_schema</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="c1"># 아주 가벼운 매핑: 필요 시 확장하세요.
</span>    <span class="n">origin</span> <span class="o">=</span> <span class="nf">get_origin</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="nf">get_args</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tp</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">or</span> <span class="n">origin</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">tp</span> <span class="ow">is</span> <span class="n">inspect</span><span class="p">.</span><span class="n">_empty</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">tp</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">int</span><span class="p">,):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">integer</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">tp</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">float</span><span class="p">,):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">number</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">tp</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">bool</span><span class="p">,):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">boolean</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">origin</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">List</span><span class="p">):</span>
        <span class="n">item_schema</span> <span class="o">=</span> <span class="nf">_pytype_to_schema</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span> <span class="k">else</span> <span class="nb">str</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">array</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">items</span><span class="sh">"</span><span class="p">:</span> <span class="n">item_schema</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">origin</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="n">Dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">}</span>
    <span class="c1"># Optional[T] 처리
</span>    <span class="k">if</span> <span class="n">origin</span> <span class="ow">is</span> <span class="n">Optional</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">_pytype_to_schema</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="c1"># 그 외엔 문자열로 처리(보수적)
</span>    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">_build_openai_tool_schema</span><span class="p">(</span><span class="n">fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">desc</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="p">.</span><span class="nf">signature</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="n">properties</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">required</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">pname</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">sig</span><span class="p">.</span><span class="n">parameters</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
        <span class="n">ann</span> <span class="o">=</span> <span class="n">param</span><span class="p">.</span><span class="n">annotation</span>
        <span class="n">sch</span> <span class="o">=</span> <span class="nf">_pytype_to_schema</span><span class="p">(</span><span class="n">ann</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">param</span><span class="p">.</span><span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">inspect</span><span class="p">.</span><span class="n">_empty</span><span class="p">:</span>
            <span class="n">sch</span><span class="p">[</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span><span class="p">.</span><span class="n">default</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">required</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">pname</span><span class="p">)</span>
        <span class="n">properties</span><span class="p">[</span><span class="n">pname</span><span class="p">]</span> <span class="o">=</span> <span class="n">sch</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">desc</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="n">properties</span><span class="p">,</span> <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="n">required</span><span class="p">},</span>
        <span class="p">},</span>
    <span class="p">}</span>

<span class="k">def</span> <span class="nf">compiled_tools</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">e</span><span class="p">.</span><span class="n">schema</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">_REGISTRY</span><span class="p">.</span><span class="nf">values</span><span class="p">()]</span>

<span class="c1"># ===================================
# 1) 샘플 인라인 툴(파일 관련, 옵션)
# ===================================
</span><span class="n">SAFE_ROOT</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">SAFE_ROOT</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">)).</span><span class="nf">resolve</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_safe</span><span class="p">(</span><span class="n">rel</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">SAFE_ROOT</span> <span class="o">/</span> <span class="n">rel</span><span class="p">).</span><span class="nf">resolve</span><span class="p">()</span>
    <span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">SAFE_ROOT</span><span class="p">)</span>  <span class="c1"># 밖으로 나가면 예외
</span>    <span class="k">return</span> <span class="n">p</span>

<span class="nd">@inline_tool</span>
<span class="k">def</span> <span class="nf">list_dir</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="sh">"""</span><span class="s">List directory entries under SAFE_ROOT.</span><span class="sh">"""</span>
    <span class="n">base</span> <span class="o">=</span> <span class="nf">_safe</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">base</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">base</span><span class="p">.</span><span class="nf">iterdir</span><span class="p">():</span>
        <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">ch</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">dir</span><span class="sh">"</span> <span class="k">if</span> <span class="n">ch</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">()</span> <span class="k">else</span> <span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="n">ch</span><span class="p">.</span><span class="nf">stat</span><span class="p">().</span><span class="n">st_size</span> <span class="k">if</span> <span class="n">ch</span><span class="p">.</span><span class="nf">is_file</span><span class="p">()</span> <span class="k">else</span> <span class="bp">None</span>
        <span class="p">})</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="nd">@inline_tool</span>
<span class="k">def</span> <span class="nf">read_text</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_bytes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">65536</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">Read a text file with size/encoding guards.</span><span class="sh">"""</span>
    <span class="n">fp</span> <span class="o">=</span> <span class="nf">_safe</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">fp</span><span class="p">.</span><span class="nf">read_text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)[:</span><span class="n">max_bytes</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">fp</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">SAFE_ROOT</span><span class="p">)),</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">text</span><span class="p">}</span>

<span class="c1"># 예시: 비동기 툴도 OK
</span><span class="nd">@inline_tool</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">slow_count_chars</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Count characters in a file (simulated slow I/O).</span><span class="sh">"""</span>
    <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
    <span class="n">fp</span> <span class="o">=</span> <span class="nf">_safe</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">return</span> <span class="nf">len</span><span class="p">(</span><span class="n">fp</span><span class="p">.</span><span class="nf">read_text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">))</span>

<span class="c1"># ===================================
# 2) while 루프 러너 (OpenAI 호환)
# ===================================
</span><span class="k">def</span> <span class="nf">_assistant_msg_dict</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">tc</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
            <span class="n">tc</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span><span class="p">},</span>
            <span class="p">})</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="n">tc</span> <span class="ow">or</span> <span class="bp">None</span><span class="p">}</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">_call_inline_tool</span><span class="p">(</span><span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args_json</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout_s</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">20.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">tool_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_REGISTRY</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">unknown tool: </span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
    <span class="n">entry</span> <span class="o">=</span> <span class="n">_REGISTRY</span><span class="p">[</span><span class="n">tool_name</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args_json</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">_</span><span class="sh">"</span><span class="p">:</span> <span class="n">args_json</span><span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_runner</span><span class="p">():</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">entry</span><span class="p">.</span><span class="nf">func</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">inspect</span><span class="p">.</span><span class="nf">iscoroutine</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>
            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">res</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="nf">_runner</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout_s</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="n">result</span><span class="p">}</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">e</span><span class="p">.</span><span class="n">__class__</span><span class="p">.</span><span class="n">__name__</span><span class="p">}</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">chat_with_inline_tools</span><span class="p">(</span><span class="n">user_input</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">AsyncOpenAI</span><span class="p">(</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">http://localhost:8000/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">dummy</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">timeout</span><span class="o">=</span><span class="mf">60.0</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">OSS_MODEL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-oss-20b</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="nf">compiled_tools</span><span class="p">()</span>

    <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">You can use tools. SAFE_ROOT is </span><span class="sh">'</span><span class="si">{</span><span class="n">SAFE_ROOT</span><span class="si">}</span><span class="sh">'</span><span class="s">.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_input</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="n">MAX_HOPS</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">MAX_HOPS</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">8</span><span class="sh">"</span><span class="p">))</span>
    <span class="n">final</span> <span class="o">=</span> <span class="sh">""</span>

    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">MAX_HOPS</span><span class="p">):</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
            <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">temperature</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
        <span class="n">calls</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>
            <span class="n">final</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span>
            <span class="k">break</span>

        <span class="c1"># 동턴 병렬 실행
</span>        <span class="k">async</span> <span class="k">def</span> <span class="nf">_one</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
            <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">_call_inline_tool</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">c</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)}</span>

        <span class="n">tool_msgs</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">gather</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="nf">_one</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">])</span>

        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">_assistant_msg_dict</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">final</span>

<span class="c1"># ==========================
# 3) 데모 실행
# ==========================
</span><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">sys</span>
    <span class="n">q</span> <span class="o">=</span> <span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">현재 디렉토리 목록을 보여주고, README.md 있으면 읽어줘.</span><span class="sh">"</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[SAFE_ROOT] </span><span class="si">{</span><span class="n">SAFE_ROOT</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">chat_with_inline_tools</span><span class="p">(</span><span class="n">q</span><span class="p">)))</span>
</code></pre></div></div>

<hr />

<h2 id="이렇게-쓰시면-됩니다">이렇게 쓰시면 됩니다</h2>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">OPENAI_BASE_URL</span><span class="o">=</span>http://localhost:8000/v1
<span class="nb">export </span><span class="nv">OPENAI_API_KEY</span><span class="o">=</span>dummy
<span class="nb">export </span><span class="nv">OSS_MODEL</span><span class="o">=</span>gpt-oss-20b
<span class="nb">export </span><span class="nv">SAFE_ROOT</span><span class="o">=</span>/your/workspace
python inline_tools_bridge.py <span class="s2">"data 폴더 목록 보여주고, README.md 읽어줘"</span>
</code></pre></div></div>

<hr />

<h2 id="한-줄-요약-컨셉-정리">한 줄 요약 (컨셉 정리)</h2>

<ul>
  <li>
    <p>지금 보여드린 방식은 <strong>MCP 없이</strong> “함수/클래스 → OpenAI tools”로 직접 매핑하는 <strong>인라인 툴</strong> 입니다.</p>
  </li>
  <li>
    <p><strong>장점</strong> : 초간단, 서버/프로세스 추가 없음.</p>
  </li>
  <li>
    <p><strong>주의</strong> : 이것만으로는 “MCP 표준”은 아니므로, <strong>다른 호스트/에이전트와 재사용성·발견성</strong> 이 필요해지면 같은 함수들을 <strong>FastMCP로 래핑</strong> 해 stdio로 띄우면 바로 표준화를 얻을 수 있어요(코드 변경 최소).</p>
  </li>
</ul>

<p class="chat--user">

FastMCP에는 이런 기능이 없어?

</p>

<p>짧게 결론부터요:</p>

<ul>
  <li>
    <p><strong>FastMCP 자체로 “파이썬 함수 리스트를 곧장 Chat Completions의 tools에 넣어주는” 내장 기능은 없습니다.</strong> FastMCP는 기본적으로 <em>MCP 서버/클라이언트</em> 를 만들기 위한 프레임워크예요. (<code class="language-plaintext highlighter-rouge">@mcp.tool</code>로 함수 등록 → MCP로 노출) <a href="https://github.com/jlowin/fastmcp">GitHub+1</a></p>
  </li>
  <li>
    <p>다만 선택지는 3가지입니다. (step-by-step)</p>
  </li>
</ul>

<ol>
  <li>
    <p><strong>OpenAI Responses API로 전환</strong><br />
OpenAI의 <em>Responses API</em> 는 MCP 서버를 “원격 툴 소스”로 바로 붙일 수 있게 표준 지원합니다(※ Chat Completions는 미지원). FastMCP로 HTTP/SSE 서버를 띄우고 Responses에서 <code class="language-plaintext highlighter-rouge">type: "mcp"</code>로 연결하면 끝. <a href="https://gofastmcp.com/integrations/openai">gofastmcp.com</a></p>
  </li>
  <li>
    <p><strong>서버 따로 띄우기 싫다면: FastMCP “인메모리”로 내장 + 얇은 어댑터</strong><br />
FastMCP에는 <strong>클라이언트가 FastMCP 서버 인스턴스에 직접 붙는 “인메모리 트랜스포트”</strong>가 있어, <em>별도 프로세스 없이</em> 같은 파이썬 프로세스 안에서 MCP 호출을 수행할 수 있어요. 이때 <code class="language-plaintext highlighter-rouge">client.list_tools()</code>로 툴 스키마를 읽어 <strong>OpenAI 함수-툴 포맷으로 변환</strong> 해서 <code class="language-plaintext highlighter-rouge">chat.completions.create(..., tools=...)</code>에 넘기고, <code class="language-plaintext highlighter-rouge">tool_calls</code>가 오면 <code class="language-plaintext highlighter-rouge">client.call_tool(...)</code>로 실행→결과를 재주입하면 됩니다. (아래 소스 15~20줄 정도면 충분) <a href="https://gofastmcp.com/clients/client">gofastmcp.com</a></p>
  </li>
  <li>
    <p><strong>필요하면 stdio/HTTP로 “그때그때” 구동</strong><br />
<code class="language-plaintext highlighter-rouge">fastmcp run server.py[:객체/팩토리]</code>로 <strong>STDIO(기본)/HTTP/SSE</strong> 중 아무거나 택해 일회성으로 띄우는 패턴도 공식 제공돼요. (항상-켜진 서버 운영 부담 ↓) <a href="https://github.com/jlowin/fastmcp">GitHub+1</a></p>
  </li>
</ol>

<hr />

<h2 id="최소-어댑터-예시-인메모리-fastmcp--chat-completions">최소 어댑터 예시 (인메모리 FastMCP ↔ Chat Completions)</h2>

<blockquote>
  <p>핵심: FastMCP로 함수 등록 → <code class="language-plaintext highlighter-rouge">Client(mcp)</code>로 인메모리 접속 → <code class="language-plaintext highlighter-rouge">list_tools()</code>를 <strong>OpenAI tools 포맷</strong> 으로 변환 → <code class="language-plaintext highlighter-rouge">tool_calls</code>는 <code class="language-plaintext highlighter-rouge">client.call_tool()</code>로 실행.
```python
import asyncio, json, os
from fastmcp import FastMCP, Client
from openai import AsyncOpenAI</p>
</blockquote>

<p>mcp = FastMCP("LocalTools")</p>

<p>@mcp.tool
def list_dir(path: str = ".") -&gt; list[dict]:
    """List directory entries."""
    import os
    return [{"name": f, "type": ("dir" if os.path.isdir(os.path.join(path, f)) else "file")}
            for f in os.listdir(path)]</p>

<p>@mcp.tool
def read_text(path: str, max_bytes: int = 65536) -&gt; dict:
    """Read a UTF-8 text file."""
    with open(path, "r", encoding="utf-8", errors="replace") as f:
        return {"path": path, "text": f.read()[:max_bytes]}</p>

<p>async def main(user_input: str):
    # 1) 인메모리로 FastMCP 서버에 붙기(별도 프로세스 X)
    mcp_client = Client(mcp)
    async with mcp_client:
        # 2) MCP 툴 → OpenAI 함수-툴 포맷 변환
        tools = await mcp_client.list_tools()
        openai_tools = [{
            "type": "function",
            "function": {
                "name": t.name,
                "description": t.description or "",
                "parameters": t.inputSchema  # MCP 표준 스키마 그대로 사용
            }
        } for t in tools]</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    # 3) 일반 Chat Completions 루프
    llm = AsyncOpenAI(
        base_url=os.getenv("OPENAI_BASE_URL", "http://localhost:8000/v1"),
        api_key=os.getenv("OPENAI_API_KEY", "dummy"),
    )
    model = os.getenv("OSS_MODEL", "gpt-oss-20b")
    messages = [{"role": "user", "content": user_input}]

    for _ in range(8):
        resp = await llm.chat.completions.create(
            model=model, messages=messages, tools=openai_tools, tool_choice="auto", temperature=0.2
        )
        msg = resp.choices[0].message
        if not msg.tool_calls:
            print(msg.content or "")
            return

        # 4) tool_calls 실행 → 결과 재주입
        tool_msgs = []
        for c in msg.tool_calls:
            args = json.loads(c.function.arguments or "{}")
            result = await mcp_client.call_tool(c.function.name, args)
            # 결과는 문자열로 넣어주면 안전
            payload = getattr(result, "data", None) or getattr(result, "content", None) or result
            tool_msgs.append({"role": "tool", "tool_call_id": c.id,
                              "content": json.dumps(payload, ensure_ascii=False, default=str)})

        messages.append({
            "role": "assistant",
            "content": msg.content,
            "tool_calls": [{"id": c.id, "type": c.type,
                            "function": {"name": c.function.name, "arguments": c.function.arguments}}
                           for c in msg.tool_calls]
        })
        messages.extend(tool_msgs)
</code></pre></div></div>

<p>if <strong>name</strong> == "<strong>main</strong>":
    asyncio.run(main("현재 폴더 목록을 보여주고 README.md가 있으면 읽어줘"))</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
  * 위 코드는 **서버 프로세스 없이** FastMCP를 _내장_ 하고, MCP 툴 스키마를 그대로 **OpenAI 함수-툴** 로 넘깁니다. (Responses API로 갈 수 없다면 이 방식이 가장 가벼움)

  * 인스턴스/클래스 메서드를 툴로 내고 싶다면, **인스턴스를 만들고 바운드 메서드를 등록** 하는 패턴이 권장입니다. (`@mcp.tool`를 메서드에 직접 붙이지 말 것) [gofastmcp.com](https://gofastmcp.com/patterns/decorating-methods)

* * *

## 언제 무엇을 쓰면 되나 (요약)

  * **OpenAI Responses API 사용 가능** → _그냥 FastMCP 서버_ 노출하고 `type: "mcp"`로 붙이세요. (정석) [gofastmcp.com](https://gofastmcp.com/integrations/openai)

  * **Chat Completions만 반드시 써야 함** → 위 **인메모리 + 변환 어댑터** 패턴. (프로세스 추가 無) [gofastmcp.com](https://gofastmcp.com/clients/client)

  * **원하면 일회성 서버** → `fastmcp run server.py[:obj]`로 **STDIO/HTTP/SSE** 중 선택해 띄우기. [GitHub+1](https://github.com/jlowin/fastmcp)

필요하시면, 지금 쓰시는 함수들로 **인메모리 FastMCP + 변환 어댑터** 를 바로 맞춰 드릴게요—함수 시그니처만 알려 주세요.

&lt;p class="chat--user" markdown="1"&gt;

fastmcp 깃허브 보니 mcp = FastMCP("My MCP") async def main(): async with Client(mcp) as client: ... 이렇게 쓸 수 있는 것 같은데?

&lt;/p&gt;

맞아요, 그 패턴 그대로 쓸 수 있어요. **FastMCP는 “인메모리 클라이언트”**를 제공해서, 별도 서버나 서브프로세스 없이 **같은 파이썬 프로세스 안에서** MCP 호출을 돌릴 수 있습니다. 즉:
```python
mcp = FastMCP("My MCP")

async def main():
    async with Client(mcp) as client:
        ...
</code></pre></div></div>

<p>이 형태가 공식적으로 안내되는 <strong>인메모리(프로세스 내) 연결</strong> 방식이고, 테스트·개발에 특히 적합해요. <a href="https://gofastmcp.com/clients/client?utm_source=chatgpt.com">gofastmcp.com+2</a></p>

<p>아래는 당신이 원하신 그대로, <strong>함수들을 바로 등록</strong> 하고 <code class="language-plaintext highlighter-rouge">AsyncOpenAI</code>의 <code class="language-plaintext highlighter-rouge">chat.completions.create(...)</code>에 <strong>툴 스키마를 넣어</strong> while 루프를 돌리는 <strong>완성 예시</strong> 입니다. (서버/포트/데몬 없음)</p>

<hr />

<h3 id="fastmcp--인메모리--chat-completions-브리지-복붙용">fastmcp × 인메모리 × Chat Completions 브리지 (복붙용)</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># fastmcp_inline_bridge.py
# pip install fastmcp openai
</span>
<span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">json</span><span class="p">,</span> <span class="n">os</span><span class="p">,</span> <span class="n">inspect</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">AsyncOpenAI</span>
<span class="kn">from</span> <span class="n">fastmcp</span> <span class="kn">import</span> <span class="n">FastMCP</span><span class="p">,</span> <span class="n">Client</span>

<span class="c1"># 0) MCP 인스턴스와 "그냥 함수"들을 MCP 툴로 등록
</span><span class="n">mcp</span> <span class="o">=</span> <span class="nc">FastMCP</span><span class="p">(</span><span class="sh">"</span><span class="s">LocalFS</span><span class="sh">"</span><span class="p">)</span>

<span class="nd">@mcp.tool</span>
<span class="k">def</span> <span class="nf">list_dir</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">List directory entries.</span><span class="sh">"""</span>
    <span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">pathlib</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">pathlib</span><span class="p">.</span><span class="nc">Path</span><span class="p">(</span><span class="n">path</span><span class="p">).</span><span class="nf">resolve</span><span class="p">()</span>
    <span class="n">entries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="nf">listdir</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
        <span class="n">full</span> <span class="o">=</span> <span class="n">p</span> <span class="o">/</span> <span class="n">name</span>
        <span class="n">entries</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">dir</span><span class="sh">"</span> <span class="k">if</span> <span class="n">full</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">()</span> <span class="k">else</span> <span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="n">full</span><span class="p">.</span><span class="nf">stat</span><span class="p">().</span><span class="n">st_size</span> <span class="k">if</span> <span class="n">full</span><span class="p">.</span><span class="nf">is_file</span><span class="p">()</span> <span class="k">else</span> <span class="bp">None</span>
        <span class="p">})</span>
    <span class="k">return</span> <span class="n">entries</span>

<span class="nd">@mcp.tool</span>
<span class="k">def</span> <span class="nf">read_text</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_bytes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">65536</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Read a UTF-8 text file (size-limited).</span><span class="sh">"""</span>
    <span class="kn">from</span> <span class="n">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
    <span class="n">fp</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">path</span><span class="p">).</span><span class="nf">resolve</span><span class="p">()</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">fp</span><span class="p">.</span><span class="nf">read_text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)[:</span><span class="n">max_bytes</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">fp</span><span class="p">),</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">text</span><span class="p">}</span>

<span class="c1"># 1) MCP -&gt; OpenAI tools 포맷 변환 도우미
</span><span class="k">def</span> <span class="nf">_schema_of</span><span class="p">(</span><span class="n">tool_obj</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="c1"># FastMCP가 내주는 속성 이름이 구현별로 다를 수 있어 대비
</span>    <span class="nf">return </span><span class="p">(</span>
        <span class="nf">getattr</span><span class="p">(</span><span class="n">tool_obj</span><span class="p">,</span> <span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">or</span>
        <span class="nf">getattr</span><span class="p">(</span><span class="n">tool_obj</span><span class="p">,</span> <span class="sh">"</span><span class="s">inputSchema</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">or</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}}</span>
    <span class="p">)</span>

<span class="k">def</span> <span class="nf">_to_openai_tools</span><span class="p">(</span><span class="n">mcp_tools</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">mcp_tools</span><span class="p">:</span>
        <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">[:</span><span class="mi">64</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">MCP tool</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="nf">_schema_of</span><span class="p">(</span><span class="n">t</span><span class="p">),</span>
            <span class="p">}</span>
        <span class="p">})</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span> <span class="nf">_assistant_msg_dict</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">tool_calls</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
            <span class="n">tool_calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span><span class="p">}</span>
            <span class="p">})</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="n">tool_calls</span> <span class="ow">or</span> <span class="bp">None</span><span class="p">}</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">_call_tool</span><span class="p">(</span><span class="n">client</span><span class="p">:</span> <span class="n">Client</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args_json</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout_s</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">20.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args_json</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">_</span><span class="sh">"</span><span class="p">:</span> <span class="n">args_json</span><span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_runner</span><span class="p">():</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">tool_name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="c1"># 결과 정규화(문자/객체 무엇이든 JSON으로 넘길 수 있게)
</span>        <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="n">res</span><span class="p">.</span><span class="n">content</span>
        <span class="k">elif</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="n">res</span><span class="p">.</span><span class="n">data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="n">res</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>  <span class="c1"># 직렬화 가능 확인
</span>            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="n">payload</span><span class="p">}</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">payload</span><span class="p">)}</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="nf">_runner</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout_s</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">e</span><span class="p">.</span><span class="n">__class__</span><span class="p">.</span><span class="n">__name__</span><span class="p">}</span>

<span class="c1"># 2) 메인 루프: Chat Completions ↔ FastMCP(인메모리)
</span><span class="k">async</span> <span class="k">def</span> <span class="nf">chat_with_inline_mcp</span><span class="p">(</span><span class="n">user_input</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="c1"># OpenAI-호환 엔드포인트(GPT-OSS 등)로 교체
</span>    <span class="n">oai</span> <span class="o">=</span> <span class="nc">AsyncOpenAI</span><span class="p">(</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">http://localhost:8000/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">dummy</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">timeout</span><span class="o">=</span><span class="mf">60.0</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OSS_MODEL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-oss-20b</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">with</span> <span class="nc">Client</span><span class="p">(</span><span class="n">mcp</span><span class="p">)</span> <span class="k">as</span> <span class="n">mcp_client</span><span class="p">:</span>
        <span class="n">tools</span> <span class="o">=</span> <span class="k">await</span> <span class="n">mcp_client</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
        <span class="n">openai_tools</span> <span class="o">=</span> <span class="nf">_to_openai_tools</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span>

        <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">You can use tools when necessary. Keep outputs concise.</span><span class="sh">"</span><span class="p">},</span>
            <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_input</span><span class="p">},</span>
        <span class="p">]</span>

        <span class="n">MAX_HOPS</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">MAX_HOPS</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">8</span><span class="sh">"</span><span class="p">))</span>
        <span class="n">final_text</span> <span class="o">=</span> <span class="sh">""</span>

        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">MAX_HOPS</span><span class="p">):</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">oai</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
                <span class="n">tools</span><span class="o">=</span><span class="n">openai_tools</span><span class="p">,</span>
                <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
                <span class="n">temperature</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>           <span class="c1"># 종료 조건
</span>                <span class="n">final_text</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span>
                <span class="k">break</span>

            <span class="c1"># 동턴 병렬 실행
</span>            <span class="k">async</span> <span class="k">def</span> <span class="nf">_one</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
                <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">_call_tool</span><span class="p">(</span><span class="n">mcp_client</span><span class="p">,</span> <span class="n">c</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">c</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)}</span>

            <span class="n">tool_msgs</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">gather</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="nf">_one</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">])</span>

            <span class="c1"># assistant 응답 + tool 결과를 누적
</span>            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">_assistant_msg_dict</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">final_text</span>

<span class="c1"># 3) 실행
</span><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">sys</span>
    <span class="n">q</span> <span class="o">=</span> <span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">현재 디렉토리 목록 보여주고 README.md 있으면 읽어줘.</span><span class="sh">"</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">chat_with_inline_mcp</span><span class="p">(</span><span class="n">q</span><span class="p">)))</span>
</code></pre></div></div>

<p><strong>사용법</strong></p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip <span class="nb">install </span>fastmcp openai
<span class="nb">export </span><span class="nv">OPENAI_BASE_URL</span><span class="o">=</span>http://localhost:8000/v1
<span class="nb">export </span><span class="nv">OPENAI_API_KEY</span><span class="o">=</span>dummy
<span class="nb">export </span><span class="nv">OSS_MODEL</span><span class="o">=</span>gpt-oss-20b
python fastmcp_inline_bridge.py <span class="s2">"data 폴더 목록과 README.md 읽어줘"</span>
</code></pre></div></div>

<hr />

<h3 id="정리-step-by-step">정리 (Step-by-step)</h3>

<ol>
  <li>
    <p><code class="language-plaintext highlighter-rouge">@mcp.tool</code>로 <strong>그냥 파이썬 함수</strong> 를 등록한다.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">async with Client(mcp)</code>로 <strong>인메모리 연결</strong> 을 연다 → <code class="language-plaintext highlighter-rouge">list_tools()</code>로 툴 스키마 획득. <a href="https://gofastmcp.com/clients/client?utm_source=chatgpt.com">gofastmcp.com+1</a></p>
  </li>
  <li>
    <p>그 스키마를 <strong>OpenAI tools 포맷</strong> 으로 변환해 <code class="language-plaintext highlighter-rouge">chat.completions.create(..., tools=...)</code>에 전달.</p>
  </li>
  <li>
    <p>응답의 <code class="language-plaintext highlighter-rouge">tool_calls</code>를 <strong><code class="language-plaintext highlighter-rouge">client.call_tool(...)</code></strong>로 실행하고, <strong><code class="language-plaintext highlighter-rouge">tool_call_id</code> 매칭</strong>하여 <strong>tool 메시지</strong> 로 재주입 → <strong>while</strong> 반복.</p>
  </li>
  <li>
    <p>별도 서버나 포트는 전혀 필요 없음(인메모리). 필요해지면 언제든 <strong>STDIO/HTTP</strong> 로 바꿀 수 있음. <a href="https://gofastmcp.com/deployment/running-server?utm_source=chatgpt.com">gofastmcp.com</a></p>
  </li>
</ol>

<p>원하시면 여기에 <strong>클래스 메서드 바운드 등록</strong> , <strong>타임아웃/재시도/로깅</strong> 까지 커스터마이즈한 실전 버전으로 다듬어 드릴게요.</p>

<p class="chat--user">

그런데 예를 들어 이렇게 만들 수 있어? def add_read_text_tool(mcp: FastMCP): # mcp에 read_text를 tool로 등록 후 return mcp my_mcp = FastMCP("My MCP") my_mcp = add_read_text_tool(my_mcp) # my_mcp에는 툴이 등록된 상태

</p>

<p>네, 그렇게 만들 수 있어요. 포인트는 <strong>함수 자체에는 데코레이터를 붙이지 않고</strong> , 나중에 <code class="language-plaintext highlighter-rouge">mcp.tool(fn)</code>으로 <strong>등록(attach)</strong> 하는 거예요. 그러면 “추가 함수”들을 손쉽게 끼워넣고 조합할 수 있습니다.</p>

<p>아래는 바로 복붙해서 쓰는 <strong>유틸 패턴</strong> 이에요.</p>

<h3 id="1-툴-추가-유틸-함수클래스-메서드-모두-지원">1) 툴 추가 유틸 (함수/클래스 메서드 모두 지원)</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># tools_adders.py
</span><span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">from</span> <span class="n">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span>
<span class="kn">from</span> <span class="n">fastmcp</span> <span class="kn">import</span> <span class="n">FastMCP</span>

<span class="k">def</span> <span class="nf">add_read_text_tool</span><span class="p">(</span><span class="n">mcp</span><span class="p">:</span> <span class="n">FastMCP</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">root</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">=</span> <span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">,</span>
                       <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">read_text</span><span class="sh">"</span><span class="p">,</span> <span class="n">default_max_bytes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">65536</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FastMCP</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">read_text(path, max_bytes) 툴을 mcp에 등록하고 mcp를 반환.</span><span class="sh">"""</span>
    <span class="n">ROOT</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">root</span><span class="p">).</span><span class="nf">resolve</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_safe</span><span class="p">(</span><span class="n">rel</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">ROOT</span> <span class="o">/</span> <span class="n">rel</span><span class="p">).</span><span class="nf">resolve</span><span class="p">()</span>
        <span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">ROOT</span><span class="p">)</span>  <span class="c1"># 밖으로 나가면 예외
</span>        <span class="k">return</span> <span class="n">p</span>

    <span class="k">def</span> <span class="nf">read_text</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_bytes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">default_max_bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">Read a UTF-8 text file under ROOT with size limit.</span><span class="sh">"""</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="nf">_safe</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">fp</span><span class="p">.</span><span class="nf">read_text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)[:</span><span class="n">max_bytes</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">fp</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">ROOT</span><span class="p">)),</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">txt</span><span class="p">}</span>

    <span class="c1"># 함수 이름을 바꾸고 싶으면 wrapper의 __name__을 바꿔도 되고…
</span>    <span class="n">read_text</span><span class="p">.</span><span class="n">__name__</span> <span class="o">=</span> <span class="n">name</span>
    <span class="n">mcp</span><span class="p">.</span><span class="nf">tool</span><span class="p">(</span><span class="n">read_text</span><span class="p">)</span>          <span class="c1"># ← 여기서 등록!
</span>    <span class="k">return</span> <span class="n">mcp</span>

<span class="k">def</span> <span class="nf">add_list_dir_tool</span><span class="p">(</span><span class="n">mcp</span><span class="p">:</span> <span class="n">FastMCP</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">root</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">=</span> <span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">,</span>
                      <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">list_dir</span><span class="sh">"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FastMCP</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">list_dir(path=</span><span class="sh">'</span><span class="s">.</span><span class="sh">'</span><span class="s">) 툴 등록.</span><span class="sh">"""</span>
    <span class="n">ROOT</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">root</span><span class="p">).</span><span class="nf">resolve</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_safe</span><span class="p">(</span><span class="n">rel</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">ROOT</span> <span class="o">/</span> <span class="n">rel</span><span class="p">).</span><span class="nf">resolve</span><span class="p">()</span>
        <span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">ROOT</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">p</span>

    <span class="k">def</span> <span class="nf">list_dir</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">List directory entries under ROOT.</span><span class="sh">"""</span>
        <span class="n">base</span> <span class="o">=</span> <span class="nf">_safe</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">dir</span><span class="sh">"</span> <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">()</span> <span class="k">else</span> <span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="nf">stat</span><span class="p">().</span><span class="n">st_size</span> <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_file</span><span class="p">()</span> <span class="k">else</span> <span class="bp">None</span>
        <span class="p">}</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">base</span><span class="p">.</span><span class="nf">iterdir</span><span class="p">()]</span>

    <span class="n">list_dir</span><span class="p">.</span><span class="n">__name__</span> <span class="o">=</span> <span class="n">name</span>
    <span class="n">mcp</span><span class="p">.</span><span class="nf">tool</span><span class="p">(</span><span class="n">list_dir</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mcp</span>
</code></pre></div></div>

<h3 id="2-사용-예--체이닝해서-등록">2) 사용 예 — 체이닝해서 등록</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># main.py
</span><span class="kn">from</span> <span class="n">fastmcp</span> <span class="kn">import</span> <span class="n">FastMCP</span><span class="p">,</span> <span class="n">Client</span>
<span class="kn">from</span> <span class="n">tools_adders</span> <span class="kn">import</span> <span class="n">add_read_text_tool</span><span class="p">,</span> <span class="n">add_list_dir_tool</span>

<span class="n">mcp</span> <span class="o">=</span> <span class="nc">FastMCP</span><span class="p">(</span><span class="sh">"</span><span class="s">My MCP</span><span class="sh">"</span><span class="p">)</span>
<span class="n">mcp</span> <span class="o">=</span> <span class="nf">add_read_text_tool</span><span class="p">(</span><span class="n">mcp</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">read_text</span><span class="sh">"</span><span class="p">)</span>
<span class="n">mcp</span> <span class="o">=</span> <span class="nf">add_list_dir_tool</span><span class="p">(</span><span class="n">mcp</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">list_dir</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># 인메모리로 붙어서 동작 확인
</span><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">json</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">demo</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">with</span> <span class="nc">Client</span><span class="p">(</span><span class="n">mcp</span><span class="p">)</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
        <span class="n">tools</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">== Registered tools ==</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">-</span><span class="sh">"</span><span class="p">,</span> <span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># 실제 호출
</span>        <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="sh">"</span><span class="s">list_dir</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">})</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">list_dir -&gt;</span><span class="sh">"</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>

        <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="sh">"</span><span class="s">read_text</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">README.md</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">max_bytes</span><span class="sh">"</span><span class="p">:</span> <span class="mi">200</span><span class="p">})</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">read_text -&gt;</span><span class="sh">"</span><span class="p">,</span> <span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">][:</span><span class="mi">80</span><span class="p">]</span> <span class="o">+</span> <span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="p">)</span> <span class="k">if</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">out</span> <span class="k">else</span> <span class="n">out</span><span class="p">)</span>

<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">demo</span><span class="p">())</span>
</code></pre></div></div>

<h3 id="3-옵션-클래스-메서드도-같은-방식으로">3) (옵션) 클래스 메서드도 같은 방식으로</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">fastmcp</span> <span class="kn">import</span> <span class="n">FastMCP</span>

<span class="k">class</span> <span class="nc">Files</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">root</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span> <span class="n">self</span><span class="p">.</span><span class="n">root</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">root</span><span class="p">).</span><span class="nf">resolve</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">_safe</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">rel</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">root</span> <span class="o">/</span> <span class="n">rel</span><span class="p">).</span><span class="nf">resolve</span><span class="p">();</span> <span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">root</span><span class="p">);</span> <span class="k">return</span> <span class="n">p</span>
    <span class="k">def</span> <span class="nf">read_text</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_bytes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">65536</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_safe</span><span class="p">(</span><span class="n">path</span><span class="p">);</span> <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">fp</span><span class="p">),</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">fp</span><span class="p">.</span><span class="nf">read_text</span><span class="p">()[:</span><span class="n">max_bytes</span><span class="p">]}</span>

<span class="k">def</span> <span class="nf">add_files_tools</span><span class="p">(</span><span class="n">mcp</span><span class="p">:</span> <span class="n">FastMCP</span><span class="p">,</span> <span class="n">fs</span><span class="p">:</span> <span class="n">Files</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FastMCP</span><span class="p">:</span>
    <span class="n">mcp</span><span class="p">.</span><span class="nf">tool</span><span class="p">(</span><span class="n">fs</span><span class="p">.</span><span class="n">read_text</span><span class="p">)</span>   <span class="c1"># 바운드 메서드 등록 권장(데코레이터를 메서드에 직접 붙이지 말 것)
</span>    <span class="k">return</span> <span class="n">mcp</span>
</code></pre></div></div>

<hr />

<h2 id="한-걸음-더-툴을-llm에-넘길-때">한 걸음 더 (툴을 LLM에 넘길 때)</h2>

<p>위처럼 등록된 툴 스키마는 <code class="language-plaintext highlighter-rouge">Client(mcp).list_tools()</code>로 얻어서 <strong>OpenAI tools 포맷</strong> 으로 변환해 <code class="language-plaintext highlighter-rouge">AsyncOpenAI(...).chat.completions.create(..., tools=...)</code>에 넣으면 됩니다(이미 쓰시던 while 루프 그대로). 핵심 단계:</p>

<ol>
  <li>
    <p><code class="language-plaintext highlighter-rouge">async with Client(mcp) as client:</code></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">tools = await client.list_tools()</code></p>
  </li>
  <li>
    <p>각 <code class="language-plaintext highlighter-rouge">t</code>에 대해 <code class="language-plaintext highlighter-rouge">{"type":"function","function":{"name": t.name, "parameters": t.inputSchema}}</code>로 변환</p>
  </li>
  <li>
    <p>LLM 호출 → <code class="language-plaintext highlighter-rouge">tool_calls</code> 오면 <code class="language-plaintext highlighter-rouge">client.call_tool(tname, args)</code> 실행 → 결과를 tool 메시지로 재주입 → 반복</p>
  </li>
</ol>

<hr />

<h3 id="정리-1">정리</h3>

<ul>
  <li>
    <p>네, 질문하신 <strong>“add</strong> 함수로 FastMCP 인스턴스에 툴을 주입하고 그대로 반환”_* 패턴이 깔끔하게 동작합니다.</p>
  </li>
  <li>
    <p>이 방식은 <strong>컴포저블</strong>(여러 add_* 조합), <strong>테스트 용이</strong> , <strong>프로세스 추가 無</strong>(인메모리)라는 장점이 있어 운영에 딱 좋아요.</p>
  </li>
</ul>

        
      </section>

      <footer class="page__meta">
        
        


  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      <a href="/categories/#llm" class="page__taxonomy-item p-category" rel="tag">llm</a>
    
    </span>
  </p>


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time class="dt-published" datetime="2025-10-17T19:56:32+09:00">2025-10-17</time></p>

      </footer>

      

      
  <nav class="pagination">
    
      <a href="/circuit/circuit-optimization-example/" class="pagination--pager" title="아날로그 회로 최적화 데모">Previous</a>
    
    
      <a href="/llm/vllm-responses/" class="pagination--pager" title="vLLM 툴 호출 예제">Next</a>
    
  </nav>


    </div>

    
  </article>

  
  
    
<div class="page__related">
  
  <h2 class="page__related-title">You may also enjoy</h2>
  <div class="grid__wrapper">
    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/2025-08-19-python-repr-vs-str/" rel="permalink">
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <!-- hvppyarchive: remove date icon
        <i class="far fa-calendar-alt" aria-hidden="true"></i> 
        -->
        
        <time datetime="2025-10-24T14:07:16+09:00">2025-10-24</time>
      </span>
    

    

    
  </p>


    <p class="archive__item-excerpt" itemprop="description">
</p>
  </article>
</div>

    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/llm/openai-function-call-examples/" rel="permalink">OpenAI 함수 호출 테스트
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <!-- hvppyarchive: remove date icon
        <i class="far fa-calendar-alt" aria-hidden="true"></i> 
        -->
        
        <time datetime="2025-10-24T14:07:11+09:00">2025-10-24</time>
      </span>
    

    

    
  </p>


    <p class="archive__item-excerpt" itemprop="description">

</p>
  </article>
</div>

    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/llm/openai-function-call-examples/" rel="permalink">OpenAI 함수 호출 테스트
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <!-- hvppyarchive: remove date icon
        <i class="far fa-calendar-alt" aria-hidden="true"></i> 
        -->
        
        <time datetime="2025-10-22T16:55:18+09:00">2025-10-22</time>
      </span>
    

    

    
  </p>


    <p class="archive__item-excerpt" itemprop="description">

</p>
  </article>
</div>

    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/llm/openai-mcp/" rel="permalink">OpenAI MCP
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <!-- hvppyarchive: remove date icon
        <i class="far fa-calendar-alt" aria-hidden="true"></i> 
        -->
        
        <time datetime="2025-10-22T15:49:23+09:00">2025-10-22</time>
      </span>
    

    

    
  </p>


    <p class="archive__item-excerpt" itemprop="description">

</p>
  </article>
</div>

    
  </div>
</div>

  
  
</div>

      
    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';" role="search">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        

<div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
      
        
      
        
      
        
      
        
      
        
      
    

    
  </ul>
</div>


<div class="page__footer-copyright">&copy; 2013 - 2025 <a href="https://hvppyarchive.github.io">ARCHIVE</a>. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/jekyll-themes/minimal-mistakes/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>






  </body>
</html>
