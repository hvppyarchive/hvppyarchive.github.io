<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.27.1 by Michael Rose
  Copyright 2013-2025 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->

<html lang="en-US" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>vLLM 툴 호출 예제 - ARCHIVE</title>
<meta name="description" content="">


  <meta name="author" content="hvppyarchive">
  
  <meta property="article:author" content="hvppyarchive">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="ARCHIVE">
<meta property="og:title" content="vLLM 툴 호출 예제">
<meta property="og:url" content="https://hvppyarchive.github.io/llm/vllm-responses/">


  <meta property="og:description" content="">







  <meta property="article:published_time" content="2025-10-19T11:47:56+09:00">





  

  


<link rel="canonical" href="https://hvppyarchive.github.io/llm/vllm-responses/">












<!-- end _includes/seo.html -->


<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
  
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css"></noscript>



    <!-- start custom head snippets -->
<!-- hvppyarchive: add fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@200..900&display=swap" rel="stylesheet">

<!-- insert favicons. use https://realfavicongenerator.net/ -->
 <!-- hvppyarchive: add favicons -->
<link rel="icon" type="image/png" href="/assets/favicon/favicon-96x96.png" sizes="96x96" />
<link rel="icon" type="image/svg+xml" href="/assets/favicon/favicon.svg" />
<link rel="shortcut icon" href="/assets/favicon/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon/apple-touch-icon.png" />
<link rel="manifest" href="/assets/favicon/site.webmanifest" />

<!-- end custom head snippets -->

  </head>

  <body class="layout--single" dir="ltr">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          ARCHIVE
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a
                href="/year-archive/"
                
                
              >Posts</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <i class="fas fa-search"></i>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      





<div id="main" role="main">
  


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="vLLM 툴 호출 예제">
    <meta itemprop="description" content="">
    <meta itemprop="datePublished" content="2025-10-19T11:47:56+09:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">
            <a href="https://hvppyarchive.github.io/llm/vllm-responses/" itemprop="url">vLLM 툴 호출 예제
</a>
          </h1>
          

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <!-- hvppyarchive: remove date icon
        <i class="far fa-calendar-alt" aria-hidden="true"></i> 
        -->
        
        <time datetime="2025-10-19T11:47:56+09:00">2025-10-19</time>
      </span>
    

    

    
  </p>


        </header>
      

      <section class="page__content" itemprop="text">
        
        <p class="chat--user">

vLLM(GPT-OSS-120B) + openai responses 파이썬 패키지를 이용해서 통신하는 예제 작성해줘. 이 때 tool calling을 해야해(harmony 형식 지원). 다음의 tool 을 지원하도록 해줘 1. 폴더 내의 파일 리스트 조회 2. 단일 파일 읽기

</p>

<p>좋아요! vLLM으로 GPT-OSS-120B를 띄우고, Python용 OpenAI SDK의 Responses API로 “harmony 형식 + tool calling”을 사용하는 최소·완전 예제를 만들어 드릴게요. 요구하신 두 가지 툴(폴더 목록 조회, 단일 파일 읽기)을 정의하고, 모델이 툴을 호출하면 실제 함수를 실행한 뒤 결과를 다시 모델에 넘겨 최종 답을 받는 구조입니다.</p>

<p>아래 순서대로 진행하면 됩니다.</p>

<ol>
  <li>vLLM 서버 실행(오픈AI 호환 엔드포인트)</li>
</ol>

<ul>
  <li>vLLM은 OpenAI-compatible 서버를 제공하므로 SDK의 <code class="language-plaintext highlighter-rouge">base_url</code>만 바꿔서 쓸 수 있습니다. 예시처럼 gpt-oss-120b 모델을 서빙하세요. <a href="https://cookbook.openai.com/articles/gpt-oss/run-vllm">OpenAI Cookbook</a></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># vLLM 설치 및 서버 기동(공식 가이드에 맞춤)</span>
<span class="c"># 참고: gpt-oss는 vLLM에서 Responses API와 Chat Completions API 둘 다 지원합니다.</span>
vllm serve openai/gpt-oss-120b
<span class="c"># 서버는 기본적으로 http://localhost:8000/v1 에서 OpenAI 호환 API를 엽니다.</span>
</code></pre></div></div>

<ol>
  <li>핵심 아이디어(툴 호출 루프)</li>
</ol>

<ul>
  <li>
    <p>Responses API로 요청을 보내면 <code class="language-plaintext highlighter-rouge">output</code> 배열에 항목들이 들어오는데, 그중 <code class="language-plaintext highlighter-rouge">type == "function_call"</code>인 항목이 있으면 해당 함수를 로컬에서 실행하고, 결과를 <code class="language-plaintext highlighter-rouge">tool_outputs</code>로 다시 <code class="language-plaintext highlighter-rouge">responses.create</code>에 넘겨 후속 추론을 이어갑니다. <code class="language-plaintext highlighter-rouge">previous_response_id</code>를 사용해 직전 턴과 연결합니다. <a href="https://platform.openai.com/docs/guides/function-calling?utm_source=chatgpt.com">OpenAI 플랫폼+1</a></p>
  </li>
  <li>
    <p>GPT-OSS 계열은 Harmony 응답 포맷을 사용하도록 학습되어 있으며, vLLM + OpenAI SDK 조합을 쓰면 별도 포맷 처리 없이 그대로 동작합니다. 직접 토큰 레벨 제어가 필요할 때만 Harmony SDK를 사용하면 됩니다. <a href="https://cookbook.openai.com/articles/gpt-oss/run-vllm">OpenAI Cookbook</a></p>
  </li>
  <li>
    <p>vLLM은 Responses API와 툴 호출을 지원하므로 이 코드가 그대로 작동합니다. <a href="https://cookbook.openai.com/articles/gpt-oss/run-vllm">OpenAI Cookbook</a></p>
  </li>
</ul>

<ol>
  <li>파이썬 예제 코드(툴 2종: 폴더 목록, 파일 읽기)</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># pip install openai
# 환경: vLLM OpenAI-compatible 서버가 localhost:8000/v1 에서 실행 중이어야 합니다.
</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">from</span> <span class="n">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>

<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>

<span class="c1"># 0) OpenAI 클라이언트: vLLM 호환 서버로 지정
</span><span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span>
    <span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000/v1</span><span class="sh">"</span><span class="p">,</span>  <span class="c1"># vLLM OpenAI-compatible 서버
</span>    <span class="n">api_key</span><span class="o">=</span><span class="sh">"</span><span class="s">EMPTY</span><span class="sh">"</span>                       <span class="c1"># vLLM 기본 토큰(검증 안함). 필요시 임의 문자열
</span><span class="p">)</span>

<span class="c1"># 1) 실제로 실행될 로컬 함수들(툴 구현)
</span><span class="k">def</span> <span class="nf">list_directory</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">path</span><span class="p">).</span><span class="nf">expanduser</span><span class="p">().</span><span class="nf">resolve</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">exists</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Directory not found: </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

    <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">iterdir</span><span class="p">()):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">items</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">child</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">is_dir</span><span class="sh">"</span><span class="p">:</span> <span class="n">child</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">(),</span>
                <span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span> <span class="k">if</span> <span class="n">child</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">()</span> <span class="k">else</span> <span class="n">child</span><span class="p">.</span><span class="nf">stat</span><span class="p">().</span><span class="n">st_size</span>
            <span class="p">})</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">items</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">child</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)})</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="sh">"</span><span class="s">items</span><span class="sh">"</span><span class="p">:</span> <span class="n">items</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">read_file</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_bytes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">200_000</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">path</span><span class="p">).</span><span class="nf">expanduser</span><span class="p">().</span><span class="nf">resolve</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">exists</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_file</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">File not found: </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># 텍스트 파일 가정. 이진 파일이면 깨질 수 있음 → errors='replace'
</span>        <span class="n">data</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">read_text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_bytes</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="n">max_bytes</span><span class="p">]</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="s">... [truncated]</span><span class="sh">"</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">}</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

<span class="c1"># 2) 툴 스키마 정의(Harmony/Responses용 function tool)
</span><span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_directory</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List files and folders in a directory.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Target directory path</span><span class="sh">"</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_file</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a text file from disk.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Target file path</span><span class="sh">"</span><span class="p">},</span>
                    <span class="sh">"</span><span class="s">max_bytes</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">integer</span><span class="sh">"</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Max characters to return</span><span class="sh">"</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="mi">200000</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">]</span>

<span class="c1"># 로컬 함수 디스패처
</span><span class="n">FUNCTIONS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">list_directory</span><span class="sh">"</span><span class="p">:</span> <span class="n">list_directory</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">read_file</span><span class="sh">"</span><span class="p">:</span> <span class="n">read_file</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">def</span> <span class="nf">extract_function_calls</span><span class="p">(</span><span class="n">response_obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="sh">"""</span><span class="s">
    Responses API의 응답에서 function_call 항목을 추출.
    SDK 버전마다 타입 클래스가 달라질 수 있으므로 dict로 안전하게 처리.
    각 항목: { </span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="s">: str, </span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="s">: str, </span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="s">: dict }
    </span><span class="sh">"""</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">response_obj</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">response_obj</span><span class="p">,</span> <span class="sh">"</span><span class="s">model_dump</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="n">response_obj</span>
    <span class="n">calls</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]):</span>
        <span class="k">if</span> <span class="n">item</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">function_call</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">call_id</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">)</span>
            <span class="c1"># arguments는 dict 이거나 JSON string일 수 있음
</span>            <span class="n">raw_args</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">raw_args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">raw_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw_args</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">raw_args</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call_id</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">raw_args</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">calls</span>

<span class="k">def</span> <span class="nf">run_tool_call</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arguments</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    해당 툴을 실제 실행하고, 문자열(JSON)로 결과를 반환.
    모델로 돌려보낼 때는 문자열이어야 합니다.
    </span><span class="sh">"""</span>
    <span class="n">fn</span> <span class="o">=</span> <span class="n">FUNCTIONS</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">fn</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Unknown function: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">})</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nf">fn</span><span class="p">(</span><span class="o">**</span><span class="n">arguments</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># 잘못된 인자 등
</span>        <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Bad arguments for </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">},</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)},</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">respond_with_tools</span><span class="p">(</span><span class="n">user_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">openai/gpt-oss-120b</span><span class="sh">"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    1) 사용자 입력으로 응답 생성 시도
    2) 툴 호출이 나오면 실제 실행 → tool_outputs 로 재호출
    3) 더 이상 툴 호출이 없을 때 최종 텍스트를 반환
    </span><span class="sh">"""</span>
    <span class="n">prev_id</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">final_text</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">prev_id</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1"># 첫 턴: 사용자 입력을 보냄
</span>            <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
                <span class="nb">input</span><span class="o">=</span><span class="n">user_prompt</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># 두 번째 턴부터는 tool_outputs만 넘기고 이어서 추론
</span>            <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
                <span class="n">previous_response_id</span><span class="o">=</span><span class="n">prev_id</span><span class="p">,</span>
                <span class="n">tool_outputs</span><span class="o">=</span><span class="n">tool_outputs</span>  <span class="c1"># 직전 루프에서 준비
</span>            <span class="p">)</span>

        <span class="c1"># 툴 호출이 있는지 확인
</span>        <span class="n">calls</span> <span class="o">=</span> <span class="nf">extract_function_calls</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>
            <span class="c1"># 최종 답변
</span>            <span class="c1"># Responses SDK는 편의 프로퍼티로 output_text 를 제공합니다.
</span>            <span class="k">try</span><span class="p">:</span>
                <span class="n">final_text</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">output_text</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="c1"># 호환성 대비
</span>                <span class="n">data</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="sh">"</span><span class="s">model_dump</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="n">resp</span>
                <span class="c1"># output 배열에서 assistant 텍스트를 합치기
</span>                <span class="n">chunks</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]):</span>
                    <span class="k">if</span> <span class="n">item</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">item</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]):</span>
                            <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                                <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
                <span class="n">final_text</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">chunks</span><span class="p">)</span> <span class="k">if</span> <span class="n">chunks</span> <span class="k">else</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">break</span>

        <span class="c1"># 하나 이상 툴 호출 → 모두 실행 후 결과를 묶어서 넘김
</span>        <span class="n">tool_outputs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
            <span class="n">result_str</span> <span class="o">=</span> <span class="nf">run_tool_call</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
            <span class="n">tool_outputs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">result_str</span>
            <span class="p">})</span>

        <span class="n">prev_id</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="nb">id</span>  <span class="c1"># 이어지는 턴에서 previous_response_id로 연결
</span>
    <span class="k">return</span> <span class="n">final_text</span> <span class="ow">or</span> <span class="sh">""</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="c1"># 사용 예시(원하는 경로로 바꾸세요)
</span>    <span class="n">prompt</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sh">"</span><span class="s">현재 작업 폴더의 파일을 보여주고(./), </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">그중 README.md가 있으면 내용을 읽어서 요약해줘.</span><span class="sh">"</span>
    <span class="p">)</span>
    <span class="n">answer</span> <span class="o">=</span> <span class="nf">respond_with_tools</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">=== Assistant ===</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">answer</span><span class="p">)</span>
</code></pre></div></div>

<ol>
  <li>포인트 요약</li>
</ol>

<ul>
  <li>
    <p>vLLM는 OpenAI-compatible 서버로 Responses API를 그대로 지원합니다. 즉 <code class="language-plaintext highlighter-rouge">base_url</code>만 바꿔서 <code class="language-plaintext highlighter-rouge">client.responses.create(...)</code>를 호출하면 됩니다. <a href="https://cookbook.openai.com/articles/gpt-oss/run-vllm">OpenAI Cookbook</a></p>
  </li>
  <li>
    <p>툴 스키마는 <code class="language-plaintext highlighter-rouge">{"type": "function", "function": {name, description, parameters}}</code> 형태로 정의합니다. GPT-OSS는 Harmony 포맷을 이해하며 vLLM 경유 시 별도 처리 없이 툴 호출이 동작합니다. <a href="https://cookbook.openai.com/articles/gpt-oss/run-vllm">OpenAI Cookbook</a></p>
  </li>
  <li>
    <p>모델이 <code class="language-plaintext highlighter-rouge">function_call</code>을 생성하면, 각 항목의 <code class="language-plaintext highlighter-rouge">call_id</code>, <code class="language-plaintext highlighter-rouge">name</code>, <code class="language-plaintext highlighter-rouge">arguments</code>를 꺼내 실제 코드를 실행하고, 결과를 <code class="language-plaintext highlighter-rouge">tool_outputs=[{"tool_call_id": ..., "output": "..."}]</code>로 다시 <code class="language-plaintext highlighter-rouge">responses.create</code>에 넘겨 한 턴을 이어갑니다. <code class="language-plaintext highlighter-rouge">previous_response_id</code>로 직전 턴을 연결합니다. <a href="https://platform.openai.com/docs/guides/function-calling?utm_source=chatgpt.com">OpenAI 플랫폼+1</a></p>
  </li>
  <li>
    <p>gpt-oss를 vLLM로 직접 샘플링할 때는 Harmony SDK로 프롬프트/스톱토큰을 관리해야 하지만, OpenAI-compatible 서버 + SDK 경로에서는 신경 쓸 필요가 거의 없습니다. <a href="https://cookbook.openai.com/articles/gpt-oss/run-vllm">OpenAI Cookbook</a></p>
  </li>
</ul>

<p>필요하면 위 코드에 스트리밍(<code class="language-plaintext highlighter-rouge">stream=True</code>) 처리나, 바이너리 파일 감지/차단 같은 보강 로직도 덧대드릴게요.</p>

<p class="chat--user">

대화를 두 턴은 했으면 좋겠어. README.md를 읽었으니 다음엔 requirements.txt를 읽자

</p>

<p>좋아요. “두 턴 대화”가 자연스럽게 이어지도록, 첫 턴에서 README.md를 읽고 요약한 뒤, 둘째 턴에서 requirements.txt를 읽는 구조를 그대로 보여주는 예제를 드릴게요. 핵심은 Responses API에서 previous_response_id로 대화 문맥을 잇고, 툴 호출(function_call)이 올 때마다 실제 함수를 실행해 tool_outputs로 되돌려주는 루프를 매 턴마다 돌리는 것입니다.</p>

<p>아래 순서대로 보면 됩니다.</p>

<ol>
  <li>
    <p>vLLM(OpenAI-compatible) 서버가 localhost:8000/v1에서 실행 중이라고 가정합니다.</p>
  </li>
  <li>
    <p>두 개의 툴(list_directory, read_file)을 정의합니다.</p>
  </li>
  <li>
    <p>Conversation 클래스로 “턴 단위” 대화 실행기를 만들고, 턴마다 툴 호출 루프를 처리합니다.</p>
  </li>
  <li>
    <p>main에서 실제 두 턴을 수행합니다: 1턴(README.md) → 2턴(requirements.txt).</p>
  </li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># pip install openai
# 사전 준비: vLLM(OpenAI-compatible) 서버를 http://localhost:8000/v1 에서 가동
#   예) vllm serve openai/gpt-oss-120b
</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">from</span> <span class="n">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>

<span class="c1"># ===== 0) OpenAI 클라이언트: vLLM 호환 서버로 지정 =====
</span><span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span>
    <span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000/v1</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">api_key</span><span class="o">=</span><span class="sh">"</span><span class="s">EMPTY</span><span class="sh">"</span>  <span class="c1"># vLLM 기본값. 필요 시 임의 문자열로 대체
</span><span class="p">)</span>

<span class="c1"># ===== 1) 실제로 실행될 로컬 함수들(툴 구현) =====
</span><span class="k">def</span> <span class="nf">list_directory</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">path</span><span class="p">).</span><span class="nf">expanduser</span><span class="p">().</span><span class="nf">resolve</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">exists</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Directory not found: </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
    <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">iterdir</span><span class="p">()):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">items</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">child</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">is_dir</span><span class="sh">"</span><span class="p">:</span> <span class="n">child</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">(),</span>
                <span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span> <span class="k">if</span> <span class="n">child</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">()</span> <span class="k">else</span> <span class="n">child</span><span class="p">.</span><span class="nf">stat</span><span class="p">().</span><span class="n">st_size</span>
            <span class="p">})</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">items</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">child</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)})</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="sh">"</span><span class="s">items</span><span class="sh">"</span><span class="p">:</span> <span class="n">items</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">read_file</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_bytes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">200_000</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">path</span><span class="p">).</span><span class="nf">expanduser</span><span class="p">().</span><span class="nf">resolve</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">exists</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_file</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">File not found: </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">read_text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_bytes</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="p">[:</span><span class="n">max_bytes</span><span class="p">]</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="s">... [truncated]</span><span class="sh">"</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">text</span><span class="p">}</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

<span class="c1"># ===== 2) 툴 스키마(Harmony/Responses용 function tool) =====
</span><span class="n">TOOLS</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_directory</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List files and folders in a directory.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Target directory path</span><span class="sh">"</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_file</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a text file from disk.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Target file path</span><span class="sh">"</span><span class="p">},</span>
                    <span class="sh">"</span><span class="s">max_bytes</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">integer</span><span class="sh">"</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Max characters to return</span><span class="sh">"</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="mi">200000</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">]</span>
<span class="n">FUNCTIONS</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">list_directory</span><span class="sh">"</span><span class="p">:</span> <span class="n">list_directory</span><span class="p">,</span> <span class="sh">"</span><span class="s">read_file</span><span class="sh">"</span><span class="p">:</span> <span class="n">read_file</span><span class="p">}</span>

<span class="c1"># ===== 3) 툴 호출 유틸 =====
</span><span class="k">def</span> <span class="nf">extract_function_calls</span><span class="p">(</span><span class="n">resp_obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="sh">"""</span><span class="s">
    Responses API 응답에서 function_call들을 추출해
    [{call_id, name, arguments}, ...] 형태로 반환
    </span><span class="sh">"""</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">resp_obj</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">resp_obj</span><span class="p">,</span> <span class="sh">"</span><span class="s">model_dump</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="n">resp_obj</span>
    <span class="n">calls</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]):</span>
        <span class="k">if</span> <span class="n">item</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">function_call</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">call_id</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">raw_args</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">raw_args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">raw_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw_args</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">raw_args</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call_id</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">raw_args</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">calls</span>

<span class="k">def</span> <span class="nf">run_tool_call</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arguments</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    해당 툴을 실제 실행하고 결과를 JSON 문자열로 반환
    </span><span class="sh">"""</span>
    <span class="n">fn</span> <span class="o">=</span> <span class="n">FUNCTIONS</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">fn</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Unknown function: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">},</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nf">fn</span><span class="p">(</span><span class="o">**</span><span class="n">arguments</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Bad arguments for </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">},</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)},</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_output_text</span><span class="p">(</span><span class="n">resp_obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    최종 어시스턴트 텍스트를 꺼내는 헬퍼
    </span><span class="sh">"""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">resp_obj</span><span class="p">.</span><span class="n">output_text</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">resp_obj</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">resp_obj</span><span class="p">,</span> <span class="sh">"</span><span class="s">model_dump</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="n">resp_obj</span>
        <span class="n">chunks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="k">if</span> <span class="n">item</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">item</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]):</span>
                    <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
        <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">chunks</span><span class="p">)</span>

<span class="c1"># ===== 4) 대화 실행기: 턴 단위로 previous_response_id를 이어감 =====
</span><span class="k">class</span> <span class="nc">Conversation</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">client</span><span class="p">:</span> <span class="n">OpenAI</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">client</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">self</span><span class="p">.</span><span class="n">tools</span> <span class="o">=</span> <span class="n">tools</span>
        <span class="n">self</span><span class="p">.</span><span class="n">last_response_id</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c1"># 마지막 assistant 응답의 id
</span>
    <span class="k">def</span> <span class="nf">run_turn</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">user_input</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">
        한 턴을 수행:
          1) 사용자 입력을 모델에 보냄(문맥 연결: previous_response_id 사용)
          2) function_call이 있으면 실제 실행 → tool_outputs로 재호출
          3) function_call이 더 이상 없으면 최종 텍스트 반환
        </span><span class="sh">"""</span>
        <span class="c1"># 1) 사용자 입력 전송
</span>        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">last_response_id</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span>
                <span class="n">tools</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">,</span>
                <span class="nb">input</span><span class="o">=</span><span class="n">user_input</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span>
                <span class="n">tools</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">,</span>
                <span class="n">previous_response_id</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">last_response_id</span><span class="p">,</span>
                <span class="nb">input</span><span class="o">=</span><span class="n">user_input</span>
            <span class="p">)</span>

        <span class="c1"># 2) 툴 호출 루프
</span>        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">calls</span> <span class="o">=</span> <span class="nf">extract_function_calls</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="n">tool_outputs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="nf">run_tool_call</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
                <span class="n">tool_outputs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">],</span>
                    <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">result</span>
                <span class="p">})</span>

            <span class="n">resp</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span>
                <span class="n">tools</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">,</span>
                <span class="n">previous_response_id</span><span class="o">=</span><span class="n">resp</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
                <span class="n">tool_outputs</span><span class="o">=</span><span class="n">tool_outputs</span>
            <span class="p">)</span>

        <span class="c1"># 3) 최종 텍스트와 응답 id 갱신
</span>        <span class="n">text</span> <span class="o">=</span> <span class="nf">get_output_text</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">last_response_id</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="nb">id</span>
        <span class="k">return</span> <span class="n">text</span>

<span class="c1"># ===== 5) 데모: 두 턴 대화 =====
</span><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">conv</span> <span class="o">=</span> <span class="nc">Conversation</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">openai/gpt-oss-120b</span><span class="sh">"</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">TOOLS</span><span class="p">)</span>

    <span class="c1"># 첫 번째 턴: README.md를 읽고 요약 요청
</span>    <span class="n">turn1_user</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sh">"</span><span class="s">프로젝트 루트(./)의 파일 목록을 보고 README.md가 있으면 읽어서 핵심을 요약해줘. </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">없으면 왜 없는지도 알려줘.</span><span class="sh">"</span>
    <span class="p">)</span>
    <span class="n">turn1_assistant</span> <span class="o">=</span> <span class="n">conv</span><span class="p">.</span><span class="nf">run_turn</span><span class="p">(</span><span class="n">turn1_user</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">=== [TURN 1] Assistant ===</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">turn1_assistant</span><span class="p">)</span>

    <span class="c1"># 두 번째 턴: requirements.txt 읽기
</span>    <span class="n">turn2_user</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sh">"</span><span class="s">좋아. 이제 같은 폴더에서 requirements.txt를 찾아서 내용을 읽고, </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">주요 패키지와 대략적 버전을 bullet로 정리해줘.</span><span class="sh">"</span>
    <span class="p">)</span>
    <span class="n">turn2_assistant</span> <span class="o">=</span> <span class="n">conv</span><span class="p">.</span><span class="nf">run_turn</span><span class="p">(</span><span class="n">turn2_user</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">=== [TURN 2] Assistant ===</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">turn2_assistant</span><span class="p">)</span>
</code></pre></div></div>

<p>사용 팁과 체크포인트</p>

<ol>
  <li>
    <p>폴더 경로 기준은 현재 작업 디렉터리(./)입니다. 다른 경로를 쓰려면 프롬프트 또는 툴 인자(path)에 명시하세요.</p>
  </li>
  <li>
    <p>모델이 스스로 list_directory를 먼저 호출해 파일 존재 여부를 확인한 다음 read_file을 호출하도록 의도를 유도하고자, 사용자 프롬프트에 “목록을 보고 … 읽어줘”라고 써두었습니다.</p>
  </li>
  <li>
    <p>두 번째 턴에서는 previous_response_id로 문맥이 이어지므로, 같은 폴더를 바로 가정하고 requirements.txt만 요청하면 됩니다.</p>
  </li>
  <li>
    <p>read_file은 텍스트 파일 전용이며, 큰 파일은 max_bytes로 절단합니다. 이진 파일은 깨질 수 있으니 필요하면 바이너리 감지 로직을 추가하세요.</p>
  </li>
  <li>
    <p>스트리밍이 필요하면 responses.create(stream=True)로 바꾸고, 스트리밍 청크를 처리한 뒤 동일한 툴 호출 루프를 적용하면 됩니다.</p>
  </li>
</ol>

<p>이 스크립트를 그대로 실행하면, 실제 로컬 디렉터리의 README.md → requirements.txt 순서로 읽어서 요약/정리하는 두 턴 대화가 진행됩니다.</p>

<p class="chat--user">

여기에서보면 과거 대화를 같이 안 보내주고 저번 대화 id만 보내는 것 같은데 이런게 vLLM에도 지원돼?

</p>

<p>짧은 답: 네, 지원돼요. vLLM은 <code class="language-plaintext highlighter-rouge">/v1/responses</code> 엔드포인트를 갖고 <code class="language-plaintext highlighter-rouge">previous_response_id</code>를 받아 “직전 응답만” 넘겨도 문맥을 잇는 방식을 처리합니다. 다만 기본값에선 서버가 대화 상태를 저장하지 않도록 되어 있어, 상태 저장을 켜주거나(권장) 아니면 매 턴 전체 맥락을 직접 다시 보내야 합니다. <a href="https://cookbook.openai.com/articles/gpt-oss/run-vllm">OpenAI Cookbook+2</a></p>

<p>생각 순서</p>

<ol>
  <li>
    <p>무엇이 가능한가: vLLM은 OpenAI Responses API와 호환되며, <code class="language-plaintext highlighter-rouge">previous_response_id</code> 필드를 프로토콜에서 받아 처리합니다. 즉, “직전 응답의 id만” 전송해도 체이닝이 됩니다. <a href="https://cookbook.openai.com/articles/gpt-oss/run-vllm">OpenAI Cookbook+1</a></p>
  </li>
  <li>
    <p>왜 저장 옵션이 필요한가: OpenAI의 Responses API는 기본이 <code class="language-plaintext highlighter-rouge">store=True</code>라서 서버가 과거 턴을 내부 저장소에 보관합니다. vLLM은 기본에선 이를 꺼둔 상태이므로, 저장을 활성화하지 않으면 <code class="language-plaintext highlighter-rouge">store=True</code> 요청에 오류가 나거나, 저장 없이 동작해 <code class="language-plaintext highlighter-rouge">previous_response_id</code>의 이점(서버측 히든 상태 재사용)을 못 누릴 수 있습니다. 환경변수 <code class="language-plaintext highlighter-rouge">VLLM_ENABLE_RESPONSES_API_STORE=1</code>로 저장 기능을 켜면 OpenAI와 유사하게 동작합니다. 대안으로 클라이언트에서 <code class="language-plaintext highlighter-rouge">store=False</code>로 보내고 매 턴 전체 히스토리를 직접 재전송할 수도 있습니다. <a href="https://docs.vllm.ai/en/v0.10.1/api/vllm/entrypoints/openai/serving_responses.html?utm_source=chatgpt.com">VLLM Docs+2</a></p>
  </li>
</ol>

<p>빠른 설정 예시<br />
서버(상태 저장 ON):</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">VLLM_ENABLE_RESPONSES_API_STORE</span><span class="o">=</span>1 vllm serve openai/gpt-oss-120b <span class="nt">--port</span> 8000
</code></pre></div></div>

<p>클라이언트(두 턴 체인: 과거 대화 본문 미전송, id만 전달):</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>
<span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000/v1</span><span class="sh">"</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="sh">"</span><span class="s">EMPTY</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># 턴1
</span><span class="n">r1</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">openai/gpt-oss-120b</span><span class="sh">"</span><span class="p">,</span>
    <span class="nb">input</span><span class="o">=</span><span class="sh">"</span><span class="s">프로젝트 루트의 README.md를 읽고 핵심만 요약해줘.</span><span class="sh">"</span>
    <span class="c1"># store=True는 Responses API 기본값. vLLM에선 위 환경변수로 활성화 필요
</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">r1</span><span class="p">.</span><span class="n">output_text</span><span class="p">)</span>

<span class="c1"># 턴2: 과거 본문은 안 보내고, 직전 응답의 id만 연결
</span><span class="n">r2</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">openai/gpt-oss-120b</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">previous_response_id</span><span class="o">=</span><span class="n">r1</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
    <span class="nb">input</span><span class="o">=</span><span class="sh">"</span><span class="s">좋아. 이번엔 requirements.txt를 읽어서 주요 패키지와 버전을 정리해줘.</span><span class="sh">"</span>
<span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">r2</span><span class="p">.</span><span class="n">output_text</span><span class="p">)</span>
</code></pre></div></div>

<p>만약 서버 상태 저장을 끄고 싶다면</p>

<ul>
  <li>매 요청에 <code class="language-plaintext highlighter-rouge">store=False</code>로 보내세요. 이 경우 서버가 상태를 안 가지므로, <code class="language-plaintext highlighter-rouge">previous_response_id</code>를 써도 실질적 이득이 없고 스스로 히스토리를 재전송해야 합니다. <a href="https://docs.vllm.ai/en/v0.10.1/api/vllm/entrypoints/openai/serving_responses.html?utm_source=chatgpt.com">VLLM Docs</a></li>
</ul>

<p>주의할 점</p>

<ul>
  <li>멀티 인스턴스/재시작 상황에선 저장소가 꺼져 있으면 체인 컨텍스트가 유실됩니다. vLLM 커뮤니티에서도 “Responses API의 풀 기능을 쓰려면 store/message 스토어가 필요”하다는 논의가 있습니다. 운영 환경에선 저장을 켜거나 외부 영속 스토어 전략을 함께 고려하세요. <a href="https://github.com/vllm-project/vllm/issues/24603?utm_source=chatgpt.com">GitHub</a></li>
</ul>

<p>핵심 요약</p>

<ul>
  <li>
    <p>가능: vLLM은 <code class="language-plaintext highlighter-rouge">previous_response_id</code> 체이닝을 받습니다. <a href="https://docs.vllm.ai/en/latest/api/vllm/entrypoints/openai/serving_responses.html?utm_source=chatgpt.com">VLLM Docs</a></p>
  </li>
  <li>
    <p>권장: <code class="language-plaintext highlighter-rouge">VLLM_ENABLE_RESPONSES_API_STORE=1</code>로 상태 저장을 켜서 “과거 대화 본문 무전송 + id만 전달” 패턴을 그대로 사용하세요. <a href="https://docs.vllm.ai/en/v0.10.1/api/vllm/entrypoints/openai/serving_responses.html?utm_source=chatgpt.com">VLLM Docs</a></p>
  </li>
  <li>
    <p>대안: 저장을 끌 땐 <code class="language-plaintext highlighter-rouge">store=False</code>로 보내고, 히스토리는 클라이언트가 재전송합니다. <a href="https://docs.vllm.ai/en/latest/api/vllm/entrypoints/openai/serving_responses.html?utm_source=chatgpt.com">VLLM Docs</a></p>
  </li>
</ul>

<p class="chat--user">

툴 다 빼고 간단히 테스트할 curl 예제만 만들어줘

</p>

<p>원하는 것만 딱! 툴 없이 vLLM(OpenAI-compatible) Responses API를 <code class="language-plaintext highlighter-rouge">curl</code>로 두 턴 테스트하는 최소 예제입니다. 서버는 <code class="language-plaintext highlighter-rouge">http://localhost:8000/v1</code>에서 <code class="language-plaintext highlighter-rouge">openai/gpt-oss-120b</code>를 서빙한다고 가정합니다.</p>

<ol>
  <li>단발성 호출(연결 없음)</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-s</span> http://localhost:8000/v1/responses <span class="se">\</span>
  <span class="nt">-H</span> <span class="s2">"Authorization: Bearer EMPTY"</span> <span class="se">\</span>
  <span class="nt">-H</span> <span class="s2">"Content-Type: application/json"</span> <span class="se">\</span>
  <span class="nt">-d</span> <span class="s1">'{
    "model": "openai/gpt-oss-120b",
    "input": "한 줄 농담 하나 해줘."
  }'</span> | jq <span class="nt">-r</span> <span class="s1">'.output_text'</span>
</code></pre></div></div>

<ol>
  <li>두 턴 대화(직전 응답 ID(previous_response_id)로 체인)</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 턴 1</span>
<span class="nv">RESP1</span><span class="o">=</span><span class="si">$(</span>curl <span class="nt">-s</span> http://localhost:8000/v1/responses <span class="se">\</span>
  <span class="nt">-H</span> <span class="s2">"Authorization: Bearer EMPTY"</span> <span class="se">\</span>
  <span class="nt">-H</span> <span class="s2">"Content-Type: application/json"</span> <span class="se">\</span>
  <span class="nt">-d</span> <span class="s1">'{
    "model": "openai/gpt-oss-120b",
    "input": "프로젝트 루트의 README.md를 읽었다고 치고, 한 줄로 요약해줘."
  }'</span><span class="si">)</span>

<span class="nb">echo</span> <span class="s2">"TURN1:"</span><span class="p">;</span> <span class="nb">echo</span> <span class="s2">"</span><span class="nv">$RESP1</span><span class="s2">"</span> | jq <span class="nt">-r</span> <span class="s1">'.output_text'</span>

<span class="c"># 직전 응답의 id 추출</span>
<span class="nv">RID</span><span class="o">=</span><span class="si">$(</span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$RESP1</span><span class="s2">"</span> | jq <span class="nt">-r</span> <span class="s1">'.id'</span><span class="si">)</span>

<span class="c"># 턴 2: 과거 본문은 보내지 않고 id만 연결</span>
curl <span class="nt">-s</span> http://localhost:8000/v1/responses <span class="se">\</span>
  <span class="nt">-H</span> <span class="s2">"Authorization: Bearer EMPTY"</span> <span class="se">\</span>
  <span class="nt">-H</span> <span class="s2">"Content-Type: application/json"</span> <span class="se">\</span>
  <span class="nt">-d</span> <span class="s2">"{
    </span><span class="se">\"</span><span class="s2">model</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">openai/gpt-oss-120b</span><span class="se">\"</span><span class="s2">,
    </span><span class="se">\"</span><span class="s2">previous_response_id</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="nv">$RID</span><span class="se">\"</span><span class="s2">,
    </span><span class="se">\"</span><span class="s2">input</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">좋아. 이제 requirements.txt를 읽었다고 치고, 주요 패키지만 bullet로 뽑아줘.</span><span class="se">\"</span><span class="s2">
  }"</span> | jq <span class="nt">-r</span> <span class="s1">'.output_text'</span>
</code></pre></div></div>

<p>주의</p>

<ul>
  <li>
    <p>vLLM에서 <code class="language-plaintext highlighter-rouge">previous_response_id</code> 체이닝을 쓰려면 서버가 응답 저장을 지원해야 합니다. 서버 기동 전에 상태 저장을 켜두었다면 위 예제가 그대로 작동하고, 저장이 꺼져 있다면 매 턴 전체 맥락을 직접 보내야 합니다.</p>
  </li>
  <li>
    <p>토큰 검증을 하지 않는 기본 설정이라면 Authorization 헤더의 값은 임의 문자열(예: <code class="language-plaintext highlighter-rouge">EMPTY</code>)이면 됩니다.</p>
  </li>
  <li>
    <p>모델 이름은 <code class="language-plaintext highlighter-rouge">vllm serve</code> 시 지정한 이름과 일치해야 합니다. 예) <code class="language-plaintext highlighter-rouge">vllm serve openai/gpt-oss-120b</code> → 요청 바디의 <code class="language-plaintext highlighter-rouge">"model": "openai/gpt-oss-120b"</code>.</p>
  </li>
</ul>

        
      </section>

      <footer class="page__meta">
        
        


  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      <a href="/categories/#llm" class="page__taxonomy-item p-category" rel="tag">llm</a>
    
    </span>
  </p>


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time class="dt-published" datetime="2025-10-19T11:47:56+09:00">2025-10-19</time></p>

      </footer>

      

      
  <nav class="pagination">
    
      <a href="/llm/local-mcp/" class="pagination--pager" title="LLM Local MCP">Previous</a>
    
    
      <a href="/llm/optimization-prompt/" class="pagination--pager" title="자연어 최적화 입력 생성">Next</a>
    
  </nav>


    </div>

    
  </article>

  
  
    
<div class="page__related">
  
  <h2 class="page__related-title">You may also enjoy</h2>
  <div class="grid__wrapper">
    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/2025-08-19-python-repr-vs-str/" rel="permalink">
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <!-- hvppyarchive: remove date icon
        <i class="far fa-calendar-alt" aria-hidden="true"></i> 
        -->
        
        <time datetime="2025-10-27T11:05:53+09:00">2025-10-27</time>
      </span>
    

    

    
  </p>


    <p class="archive__item-excerpt" itemprop="description">
</p>
  </article>
</div>

    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/llm/openai-function-call-examples/" rel="permalink">OpenAI 함수 호출 테스트
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <!-- hvppyarchive: remove date icon
        <i class="far fa-calendar-alt" aria-hidden="true"></i> 
        -->
        
        <time datetime="2025-10-27T11:05:47+09:00">2025-10-27</time>
      </span>
    

    

    
  </p>


    <p class="archive__item-excerpt" itemprop="description">

</p>
  </article>
</div>

    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/llm/openai-function-call-examples/" rel="permalink">OpenAI 함수 호출 테스트
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <!-- hvppyarchive: remove date icon
        <i class="far fa-calendar-alt" aria-hidden="true"></i> 
        -->
        
        <time datetime="2025-10-24T16:39:17+09:00">2025-10-24</time>
      </span>
    

    

    
  </p>


    <p class="archive__item-excerpt" itemprop="description">

</p>
  </article>
</div>

    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/llm/openai-api-examples/" rel="permalink">OpenAI 함수 호출 테스트
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <!-- hvppyarchive: remove date icon
        <i class="far fa-calendar-alt" aria-hidden="true"></i> 
        -->
        
        <time datetime="2025-10-24T14:08:27+09:00">2025-10-24</time>
      </span>
    

    

    
  </p>


    <p class="archive__item-excerpt" itemprop="description">

</p>
  </article>
</div>

    
  </div>
</div>

  
  
</div>

      
    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';" role="search">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        

<div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
      
        
      
        
      
        
      
        
      
        
      
    

    
  </ul>
</div>


<div class="page__footer-copyright">&copy; 2013 - 2025 <a href="https://hvppyarchive.github.io">ARCHIVE</a>. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/jekyll-themes/minimal-mistakes/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>






  </body>
</html>
