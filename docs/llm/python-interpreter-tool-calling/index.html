<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.27.1 by Michael Rose
  Copyright 2013-2025 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->

<html lang="en-US" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Python 코드 실행 Tool Calling - ARCHIVE</title>
<meta name="description" content="">


  <meta name="author" content="hvppyarchive">
  
  <meta property="article:author" content="hvppyarchive">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="ARCHIVE">
<meta property="og:title" content="Python 코드 실행 Tool Calling">
<meta property="og:url" content="https://hvppyarchive.github.io/llm/python-interpreter-tool-calling/">


  <meta property="og:description" content="">







  <meta property="article:published_time" content="2025-11-05T14:47:56+09:00">





  

  


<link rel="canonical" href="https://hvppyarchive.github.io/llm/python-interpreter-tool-calling/">












<!-- end _includes/seo.html -->


<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
  
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css"></noscript>



    <!-- start custom head snippets -->
<!-- hvppyarchive: add fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@200..900&display=swap" rel="stylesheet">

<!-- insert favicons. use https://realfavicongenerator.net/ -->
 <!-- hvppyarchive: add favicons -->
<link rel="icon" type="image/png" href="/assets/favicon/favicon-96x96.png" sizes="96x96" />
<link rel="icon" type="image/svg+xml" href="/assets/favicon/favicon.svg" />
<link rel="shortcut icon" href="/assets/favicon/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon/apple-touch-icon.png" />
<link rel="manifest" href="/assets/favicon/site.webmanifest" />

<!-- end custom head snippets -->

  </head>

  <body class="layout--single" dir="ltr">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          ARCHIVE
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a
                href="/year-archive/"
                
                
              >Posts</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <i class="fas fa-search"></i>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      





<div id="main" role="main">
  


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Python 코드 실행 Tool Calling">
    <meta itemprop="description" content="">
    <meta itemprop="datePublished" content="2025-11-05T14:47:56+09:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">
            <a href="https://hvppyarchive.github.io/llm/python-interpreter-tool-calling/" itemprop="url">Python 코드 실행 Tool Calling
</a>
          </h1>
          

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <!-- hvppyarchive: remove date icon
        <i class="far fa-calendar-alt" aria-hidden="true"></i> 
        -->
        
        <time datetime="2025-11-05T14:47:56+09:00">2025-11-05</time>
      </span>
    

    

    
  </p>


        </header>
      

      <section class="page__content" itemprop="text">
        
        <p class="chat--user">

아래와 같은 Code Interpreter 툴을 나의 (vLLM + GPTOSS / Qwen) + (OpenAI Agents SDK) 시스템에 넣고 싶어. 내가 원하는 것은 사실 이거 하나야. 파이썬 코드를 실행하되, 외부의 파일들을 망치지 않았으면 좋겠어. 그와 동시에 호스트 파일들에 단순 접근은 좀 자유로워도 좋을 것 같아. 파일을 생성/수정이 필요하면 지정한 폴더 안에 복사해서 다루면 좋을 것 같아. 그리고 도커가 없이 이런 시스템을 구성하고 싶어 #!/usr/bin/env python # coding: utf-8 # ## Build Your Own Code Interpreter - Dynamic Tool Generation and Execution With o3-mini # # At the core of providing a LLM Agent capability to interact with the outside world or other Agents is “tool (or function) calling,” where a LLM can invoke a function (a block of code) with arguments. Typically, these functions are predefined by the developer, along with their expected inputs and outputs. However, in this Cookbook, we explore a more flexible paradigm - to <strong>dynamically generate tools</strong> using LLM models (in this case <strong>o3-mini</strong>), with ability to execute the tool using a code interpreter. # # ### Dynamically Generated Tool Calling with Code Interpreter # A Dynamically Generated Tool is a function or code block created by the LLM itself at runtime based on the user’s prompt. This means you don’t have to predefine every possible scenario in your codebase—enabling far more open-ended, creative, and adaptive problem-solving. # # Dynamically Generated Tool Calling goes a step further by granting the LLM the ability to generate tools and execute code blocks on the fly. This dynamic approach is particularly useful for tasks that involve: # # - Data analysis and visualization # - Data manipulation and transformation # - Machine learning workflow generation and execution # - Process automation and scripting # - And much more, as new possibilities emerge through experimentation # # ### Using o3-mini for Dynamic Tool generation # # Released on 31-Jan-25, o3-mini model has exceptional STEM capabilities—with particular strength in science, math, and coding—all while maintaining the low cost and reduced latency of smaller models. In this Cookbook, we will demonstrate o3-mini's capabilities to generate python code to interpret data and draw insights. # # Reasoning models are particularly good at generating dynamic tools to analyze data since they can reason on their own, without the need of an explicit chain-of-thought prompt. In fact, providing explicit chain of thought instructions may interfere with model's internal reasoning and lead to suboptimal outcomes. You can learn more about o3-mini <a href="https://openai.com/index/openai-o3-mini/">here.</a> # # ### Why build your own code interpreter # # Many API providers—such as OpenAI’s Assistants API—offer built-in code interpreter functionality. These built-in code interpreters can be immensely powerful, but there are situations where developers may need to create their own custom code interpreter. For example: # # 1. <strong>Language or library support</strong>: The built-in interpreter may not support the specific programming language (e.g., C++, Java, etc.) or libraries required for your task. # 2. <strong>Task compatibility</strong>: Your use case may not be compatible with the provider’s built-in solution. # 3. <strong>Model constraints</strong>: You might require a language model that isn’t supported by the provider’s interpreter. # 4. <strong>Cost considerations</strong>: The cost structure for code execution or model usage may not fit your budget or constraints. # 5. <strong>File size</strong>: The file size of input data is too large or not supported by the provider's interpreter. # 6. <strong>Integrating with internal systems</strong>: The provider's interpreter may not be able to integrate with your internal systems. # # ### What You’ll Learn # By following this Cookbook, you will learn how to: # # - Set up an isolated Python code execution environment using Docker # - Configure your own code interpreter tool for LLM agents # - Establish a clear separation of “Agentic” concerns for security and safety # - Using <strong>o3-mini</strong> model to dynamically generate code for data analysis # - Orchestrate agents to efficiently accomplish a given task # - Design an agentic application that can dynamically generate and execute code # # You’ll learn how to build a custom code interpreter tool from the ground up, leverage the power of LLMs to generate sophisticated code, and safely execute that code in an isolated environment—all in pursuit of making your AI-powered applications more flexible, powerful, and cost-effective. # ### Example Scenario # # We'll use the sample data provided at <a href="https://www.kaggle.com/datasets/willianoliveiragibin/key-factors-traffic-accidents">Key Factors Traffic Accidents</a> to answer a set of questions. These questions do not require to be pre-defined, we will give LLM the ability to generate code to answer such question. # # Sample questions could be: # - What factors contribute the most to accident frequency? (Feature importance analysis) # - Which areas are at the highest risk of accidents? (Classification/Clustering) # - How does traffic fine amount influence the number of accidents? (Regression/Causal inference) # - Can we determine the optimal fine amounts to reduce accident rates? (Optimization models) # - Do higher fines correlate with lower average speeds or reduced accidents? (Correlation/Regression) # - and so on … # # Using the traditional <strong>Predefined Tool Calling</strong> approach, developer would need to pre-define the function for each of these questions. This limits the LLM's ability to answer any other questions not defined in the pre-defined set of functions. We overcome this limitation by using the <strong>Dynamic Tool Calling</strong> approach where the LLM generates code and uses a Code Interpretter tool to execute the code. # ## Overview # Let's dive into the steps to build this Agentic Applicaiton with Dynamically generated tool calling. There are three components to this application: # #### Step 1: Set up an isolated code execution container environment # # We need a secure environment where our LLM generated function calls can be executed. We want to avoid directly running the LLM generated code on the host machine so will create a Docker container environment with restricted resource access (e.g., no network access). By default, Docker containers cannot access the host machine’s file system, which helps ensure that any code generated by the LLM remains contained. # # ##### ⚠️ A WORD OF CAUTION: Implement Strong Gaurdrails for the LLM generated code # LLMs could generate harmful code with unintended consequences. As a best practice, isolate the code execution environment with only required access to resources as needed by the task. Avoid running the LLM generated code on your host machine or laptop. # # #### Step 2: Define and Test the Agents # # "<strong>What is an Agent?</strong>" In the context of this Cookbook, an Agent is: # 1. Set of instructions for the LLM to follow, i.e. the developer prompt # 2. A LLM model, and ability to call the model via the API # 3. Tool call access to a function, and ability to execute the function # # We will define two agents: # 1. FileAccessAgent: This agent will read the file and provide the context to the PythonCodeExecAgent. # 2. PythonCodeExecAgent: This agent will generate the Python code to answer the user's question and execute the code in the Docker container. # # #### Step 3: Set up Agentic Orchestration to run the application # There are various ways to orchestrate the Agents based on the application requirements. In this example, we will use a simple orchestration where the user provides a task and the agents are called in sequence to accomplish the task. # # The overall orchestration is shown below: # # <img src="../../images/oo_aa_image_1_code_interpreter_agents.png" alt="" /> # ## Let's get started # # # ### Prerequisites # Before you begin, ensure you have the following installed and configured on your host machine: # # 1. Docker: installed and running on your local machine. You can learn more about Docker and <a href="https://www.docker.com/">install it from here</a>. # 2. Python: installed on your local machine. You can learn more about Python and <a href="https://www.python.org/downloads/">install it from here</a>. # 3. OpenAI API key: set up on your local machine as an environment variable or in the .env file in the root directory. You can learn more about OpenAI API key and <a href="https://platform.openai.com/docs/api-reference/introduction">set it up from here</a>. # # ### Step 1: Set up an Isolated Code Execution Environment # # Lets define a Dockerized container environment that will be used to execute our code. I have defined the <strong><a href="https://github.com/openai/openai-cookbook/blob/main/examples/object_oriented_agentic_approach/resources/docker/dockerfile">dockerfile</a></strong> under <code class="language-plaintext highlighter-rouge">resources/docker</code> directory that will be used to create the container environment with the following specifications: # - Python 3.10 as the base # - A non-root user # - Preinstall the packages in requirements.txt # # The requirements.txt included in the docker image creation process contains all the potential packages our LLM generated code may need to accomplish its tasks. Given we will restrict the container from network access, so we need to pre-install the packages that are required for the task. Our LLM will not be allowed to install any additional packages for security purposes. # # You could create your own docker image with the language requirements (such as Python 3.10) and pre-install the packages that are required for the task, or create a custom docker image with the specific language (such as Java, C++, etc.) and packages that are required for the task. # Let's build the docker image with the following command. For the sake of brevity, I have redirected the output to grep the success message and print a message if the build fails. # In[1]: get_ipython().system('docker build -t python_sandbox:latest ./resources/docker 2&gt;&amp;1 | grep -E "View build details|ERROR" || echo "Build failed."') # Let's run the container in restricted mode. The container will run in the background. This is our opportunity to define the security policies for the container. It is good practice to only allow the bare minimum features to the container that are required for the task. By default, the container cannot access the host file system from within the container. Let's also restrict its access to network so it cannot access the Internet or any other network resources. # In[2]: # Run the container in restricted mode. The container will run in the background. get_ipython().system('docker run -d –name sandbox –network none –cap-drop all –pids-limit 64 –tmpfs /tmp:rw,size=64M python_sandbox:latest sleep infinity') # Let's make sure container is running using the <code class="language-plaintext highlighter-rouge">docker ps</code> that should list our container. # In[3]: get_ipython().system('docker ps') # ### Step 2: Define and Test the Agents # # For our purposes, we will define two agents. # 1. <strong>Agent 1: File Access Agent (with Pre-defined Tool Calling)</strong> # - Instructions to understand the contents of the file to provide as context to Agent 2. # - Has access to the host machine’s file system. # - Can read a file from the host and copy it into the Docker container. # - Cannot access the code interpreter tool. # - Uses gpt-4o model. # # 2. <strong>Agent 2: Python Code Generator and Executor (with Dynamically Generated Tool Calling and Code Execution)</strong> # - Recieve the file content's context from Agent 1. # - Instructions to generate a Python script to answer the user's question. # - Has access to the code interpreter within the Docker container, which is used to execute Python code. # - Has access only to the file system inside the Docker container (not the host). # - Cannot access the host machine’s file system or the network. # - Uses our newest <strong>o3-mini</strong> model that excels at code generation. # # This separation concerns of the File Access (Agent 1) and the Code Generator and Executor (Agent 2) is crucial to prevent the LLM from directly accessing or modifying the host machine. # # # <strong>Limit the Agent 1 to Static Tool Calling as it has access to the host file system.</strong> # # # | Agent | Type of Tool Call | Access to Host File System | Access to Docker Container File System | Access to Code Interpreter | # |——-|——————-|—————————-|—————————————-|—————————-| # | Agent 1: File Access | Pre-defined Tools | Yes | Yes | No | # | Agent 2: Python Code Generator and Executor | Dynamically Generated Tools | No | Yes | Yes | # # To keep the Agents and Tools organized, we've defined a set of <strong>core classes</strong> that will be used to create the two agents for consistency using Object Oriented Programming principles. # # - <strong>BaseAgent</strong>: We start with an abstract base class that enforces common method signatures such as <code class="language-plaintext highlighter-rouge">task()</code>. Base class also provides a logger for debugging, a language model interface and other common functions such as <code class="language-plaintext highlighter-rouge">add_context()</code> to add context to the agent. # - <strong>ChatMessages</strong>: A class to store the conversation history given ChatCompletions API is stateless. # - <strong>ToolManager</strong>: A class to manage the tools that an agent can call. # - <strong>ToolInterface</strong>: An abstract class for any 'tool' that an agent can call so that the tools will have a consistent interface. # # These classes are defined in the <a href="./resources/object_oriented_agents/core_classes">object_oriented_agents/core_classes</a> directory. # #### UML Class Diagram for Core Classes # The following class diagram shows the relationship between the core classes. This UML (Unified Modeling Language) has been generated using <a href="https://mermaid">Mermaid</a> # # <img src="../../images/oo_aa_image_2_uml_diagram.png" alt="" /> # <strong>Define Agent 1: FileAccessAgent with FileAccessTool</strong> # # Let's start with definin the FileAccessTool that inherits from the ToolInterface class. The <strong>FileAccessTool</strong> tool is defined in the <a href="https://github.com/openai/openai-cookbook/blob/main/examples/object_oriented_agentic_approach/resources/registry/tools/file_access_tool.py">file_access_tool.py</a> file in the <code class="language-plaintext highlighter-rouge">resources/registry/tools</code> directory. # # - FileAccessTool implements the ToolInterface class, which ensures that the tools will have a consistent interface. # - Binding the tool definition for the OpenAI Function Calling API in the <code class="language-plaintext highlighter-rouge">get_definition</code> method and the tool's <code class="language-plaintext highlighter-rouge">run</code> method ensures maintainability, scalability, and reusability. # Now, let's define the <strong>FileAccessAgent</strong> that extends the BaseAgent class and bind the <strong>FileAccessTool</strong> to the agent. The FileAccessAgent is defined in the <a href="https://github.com/openai/openai-cookbook/blob/main/examples/object_oriented_agentic_approach/resources/registry/agents/file_access_agent.py">file_acess_agent.py</a> file in <code class="language-plaintext highlighter-rouge">resources/registry/agents</code> directory. The FileAccessAgent is: # # - A concrete implementation of the BaseAgent class. # - Initialized with the developer prompt, model name, logger, and language model interface. These values can be overridden by the developer if needed. # - Has a setup_tools method that registers the FileAccessTool to the tool manager. # - Has a <code class="language-plaintext highlighter-rouge">task</code> method that calls the FileAccessTool to read the file and provide the context to the PythonCodeExecAgent. # - <code class="language-plaintext highlighter-rouge">model_name='gpt-4o'</code> that provides sufficient reasoning and tool calling ability for the task. # # <strong>Define Agent 2: PythonExecAgent with PythonExecTool</strong> # # Similarly, PythonExecTool inherits from the ToolInterface class and implements the get_definition and run methods. The get_definition method returns the tool definition in the format expected by the OpenAI Function Calling API. The run method executes the Python code in a Docker container and returns the output. This tool is defined in the <a href="https://github.com/openai/openai-cookbook/blob/main/examples/object_oriented_agentic_approach/resources/registry/tools/python_code_interpreter_tool.py">python_code_interpreter_tool.py</a> file in the <code class="language-plaintext highlighter-rouge">resources/registry/tools</code> directory. # # Likewise, PythonExecAgent is a concrete implementation of the BaseAgent class. It is defined in the <a href="https://github.com/openai/openai-cookbook/blob/main/examples/object_oriented_agentic_approach/resources/registry/agents/python_code_exec_agent.py">python_code_exec_agent.py</a> file in the <code class="language-plaintext highlighter-rouge">resources/registry/agents</code> directory. The PythonExecAgent is: # # - A concrete implementation of the BaseAgent class. # - Initialized with the developer prompt, model name, logger, and language model interface. These values can be overridden by the developer if needed. # - Has a setup_tools method that registers the PythonExecTool to the tool manager. # - Has a <code class="language-plaintext highlighter-rouge">task</code> method that calls the OpenAI API to perform the user's task, which in this case involves generating a Python script to answer the user's question and run it with Code Interpreter tool. # - <code class="language-plaintext highlighter-rouge">model_name='o3-mini'</code> that excels at STEM tasks such as code generation. # - <code class="language-plaintext highlighter-rouge">reasoning_effort='high'</code> that allows for more complete reasoning given the complexity of the task at the cost of more tokens generated and slower responses. The default value is medium, which is a balance between speed and reasoning accuracy. # # You can learn more about the <code class="language-plaintext highlighter-rouge">reasoning_effort</code> parameter <a href="https://platform.openai.com/docs/guides/reasoning">here</a>. # ### Step 3: Set up Agentic Orchestration to run the application # # With the Agents defined, now we can define the orchestration loop that will run the application. This loop will prompt the user for a question or task, and then call the FileAccessAgent to read the file and provide the context to the PythonExecAgent. The PythonExecAgent will generate the Python code to answer the user's question and execute the code in the Docker container. The output from the code execution will be displayed to the user. # # User can type 'exit' to stop the application. Our question: <strong>What factors contribute the most to accident frequency?</strong> Note that we did not pre-define the function to answer this question. # # # In[4]: # Import the agents from registry/agents from resources.registry.agents.file_access_agent import FileAccessAgent from resources.registry.agents.python_code_exec_agent import PythonExecAgent prompt = """Use the file traffic_accidents.csv for your analysis. The column names are: Variable Description accidents Number of recorded accidents, as a positive integer. traffic_fine_amount Traffic fine amount, expressed in thousands of USD. traffic_density Traffic density index, scale from 0 (low) to 10 (high). traffic_lights Proportion of traffic lights in the area (0 to 1). pavement_quality Pavement quality, scale from 0 (very poor) to 5 (excellent). urban_area Urban area (1) or rural area (0), as an integer. average_speed Average speed of vehicles in km/h. rain_intensity Rain intensity, scale from 0 (no rain) to 3 (heavy rain). vehicle_count Estimated number of vehicles, in thousands, as an integer. time_of_day Time of day in 24-hour format (0 to 24). accidents traffic_fine_amount """ print("Setup: ") print(prompt) print("Setting up the agents… ") # Instantiate the agents with the default constructor defined values # Developer may override the default values - prompt, model, logger, and language model interface if needed # This agent use gpt-4o by default file_ingestion_agent = FileAccessAgent() # Let's make sure agent uses o3-mini model and set the reasoning_effort to high data_analysis_agent = PythonExecAgent(model_name='o3-mini', reasoning_effort='high') print("Understanding the contents of the file…") # Give a task to the file ingestion agent to read the file and provide the context to the data analysis agent file_ingestion_agent_output = file_ingestion_agent.task(prompt) # Add the file content as context to the data analysis agent # The context is added to the agent's tool manager so that the tool manager can use the context to generate the code data_analysis_agent.add_context(prompt) data_analysis_agent.add_context(file_ingestion_agent_output) while True: print("Type your question related to the data in the file. Type 'exit' to exit.") user_input = input("Type your question.") if user_input == "exit": print("Exiting the application.") break print(f"User question: {user_input}") print("Generating dynamic tools and using code interpreter…") data_analysis_agent_output = data_analysis_agent.task(user_input) print("Output…") print(data_analysis_agent_output) # In this example, the <strong>o3-mini</strong> dynamically generated a tool (Python script) based on user's question to analyze the data. Note that <strong>o3-mini</strong> examined the problem using multiple approaches such as correlation analysis, linear regression and random forest models. This approach highlights the following: # # <strong>reasoning_effort</strong>: The depth of reasoning the model performs e.g., in this case number of approaches, generally increases when the parameter is increased from low, medium to high. You can try with different levels of reasoning effort to see the difference. # # <strong>Dynamically Generated Tool Calling</strong>: The tool (Python script) to analyze the data was not manually written or predetermined by the developer. Instead, the o3-mini model created the relevant data exploration and correlation analysis code at runtime. # # <strong>Isolated Code Execution</strong>: To ensure security and avoid running untrusted code on the host machine, the Python script was executed inside a Docker container using the <code class="language-plaintext highlighter-rouge">execute_python_code</code> tool. This container had restricted resource access (e.g., no network and limited filesystem access), minimizing potential risks posed by arbitrary code execution. # # ### Conclusion # # The Cookbook provides a guide for developing a <strong>custom code interpreter</strong> tailored to specific application needs, addressing limitations found in vendor-provided solutions such as language constraints, cost considerations, and the need for flexibility with different LLMs or models. # # <strong>Approach for Managing Agents and Tools</strong>: We also defined a set of core classes to manage the agents and tools. This approach ensures that the agents and tools will have a consistent interface and can be reused across different applications. A repository of agents and tools such as the <a href="https://github.com/openai/openai-cookbook/tree/main/examples/object_oriented_agentic_approach/resources/registry">registry</a> folder can be created to manage the agents and tools. # # <strong>o3-mini model</strong>: We demonstrated o3-mini model's ability to generate sophisticated code at run time to analyze data based on user's minimal prompt. o3-mini model then reasoned over the outcome of the analysis to explain the results to the user. # # Finally, <strong>to recap</strong>, the three steps to build an Agentic Application with Dynamic Tool Calling are: # 1. Set up an isolated code execution container environment # 2. Define and Test the Agents # 3. Set up Agentic Orchestration to run the application # # We discussed the importance of isolating the code execution environment to ensure security and avoid running untrusted code on the host machine. With the use case of a CSV file, we demonstrated how to dynamically generate a tool (a Python script) to analyze the data and answer the user's question. We also showed how to execute the code in a Docker container and return the output to the user.

</p>

<p>한국어로 답함.<br />
문장 앞에 인용(Blockquote) 금지, 그대로 일반 텍스트로만 서술.</p>

<hr />

<h3 id="당신이-원하는-목표를-다시-정리하면-다음과-같아">당신이 원하는 목표를 다시 정리하면 다음과 같아:</h3>

<ol>
  <li>
    <p>LLM이 생성한 <strong>파이썬 코드를 실행</strong> 하고 싶다.</p>
  </li>
  <li>
    <p>하지만 <strong>호스트 파일 시스템을 망가뜨리거나 수정하면 안 된다</strong>.</p>
  </li>
  <li>
    <p>필요할 경우 파일은 <strong>지정된 작업 폴더에 복사해서 그 안에서만 처리</strong> 되길 원한다.</p>
  </li>
  <li>
    <p>Docker 없이 (즉, 컨테이너 없이) 구현하고 싶다.</p>
  </li>
  <li>
    <p>시스템은 vLLM + Qwen + OpenAI Agents SDK 또는 GPTOSS 기반으로 구성하려고 한다.</p>
  </li>
</ol>

<p>여기서 가장 큰 도전은 <strong>보안 격리 없이 호스트에서 실행되는 코드</strong> 를 어떻게 안전하게 제한하느냐이다. Docker는 자연스러운 해결책이지만, 당신이 원하지 않는다고 했으므로 <strong>Python 자체의 가상화 + 시스템 수준의 sand-boxing(권한 제한)</strong> 방향으로 접근해야 한다.</p>

<p>나는 아래 방식으로 접근을 추천한다.</p>

<hr />

<h2 id="단계별-설계-step-by-step">단계별 설계 (step-by-step)</h2>

<h3 id="1단계-작업-디렉토리sandbox-workspace-구조-정의">1단계. "작업 디렉토리(sandbox workspace)" 구조 정의</h3>

<p>예시 구조:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/host
   /data              ← 원본 파일들 <span class="o">(</span>읽기 전용<span class="o">)</span>
   /sandbox           ← LLM 생성 코드가 실행되는 폴더 <span class="o">(</span>쓰기 가능<span class="o">)</span>
   /runner            ← 코드 실행 스크립트
</code></pre></div></div>

<p>원본 파일 접근 방침:</p>

<ul>
  <li>
    <p>호스트의 <code class="language-plaintext highlighter-rouge">/data</code> 는 읽기만 허용.</p>
  </li>
  <li>
    <p>작업에 필요한 파일이 있으면 <code class="language-plaintext highlighter-rouge">/sandbox</code> 로 복사한 뒤 그 안에서만 사용.</p>
  </li>
</ul>

<p>파이썬 실행 환경에서 <code class="language-plaintext highlighter-rouge">open()</code> 이 /data 를 수정하지 못하도록 강제하려면, <code class="language-plaintext highlighter-rouge">runner</code> 레벨에서 path 검증을 넣어야 한다.</p>

<hr />

<h3 id="2단계-python-실행을-진짜-분리된-프로세스에서-실행하게-하기">2단계. Python 실행을 "진짜 분리된 프로세스"에서 실행하게 하기</h3>

<p>핵심은 코드 실행을 <strong>서브 프로세스로 분리하는 것</strong>.</p>

<p>의사 코드:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>arduino

# runner.py
def run_code(code_string):
    생성된_코드를 /sandbox/temp.py 로 저장
    subprocess.run(["python", "/sandbox/temp.py"], timeout=5, cwd="/sandbox")
</code></pre></div></div>

<p>여기서 중요한 안전장치:</p>

<ul>
  <li>
    <p>cwd 를 /sandbox 로 고정</p>
  </li>
  <li>
    <p>timeout (= 무한 루프, while True 방지)</p>
  </li>
  <li>
    <p>subprocess 실행 전에 파일명 및 path 검증</p>
  </li>
</ul>

<hr />

<h3 id="3단계-파일-접근-필터링-안전-장치">3단계. 파일 접근 필터링 (안전 장치)</h3>

<p>파이썬 코드에 직접적인 파일 접근을 막으려면:<br />
방법 A. exec 환경에서 <code class="language-plaintext highlighter-rouge">open</code> 같은 builtins 제거<br />
방법 B. Python restricted environment 적용 (대신 완전하지 않음)<br />
방법 C. 오버레이 파일시스템 또는 chroot (Docker 없이 가능)</p>

<p>여기서는 <strong>가장 간단한 실용적 보호</strong> 를 추천한다.</p>

<p>예제 코드:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">safe_globals</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">__builtins__</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">range</span><span class="sh">"</span><span class="p">:</span> <span class="nb">range</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">len</span><span class="sh">"</span><span class="p">:</span> <span class="nb">len</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">print</span><span class="sh">"</span><span class="p">:</span> <span class="k">print</span><span class="p">,</span>
        <span class="c1"># 필요한 최소 기능만 허용
</span>    <span class="p">}</span>
<span class="p">}</span>

<span class="nf">exec</span><span class="p">(</span><span class="n">code_string</span><span class="p">,</span> <span class="n">safe_globals</span><span class="p">)</span>
</code></pre></div></div>

<p>단, 데이터 분석 목적이라면 pandas, numpy 필요하므로 위 방식이 너무 제한된다.<br />
그래서 더 현실적인 방법은 <strong>subprocess 실행 + sys.setrecursionlimit 제한 + resource 모듈로 메모리/CPU 제한</strong> 이다.</p>

<p>예시:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">resource</span>

<span class="n">resource</span><span class="p">.</span><span class="nf">setrlimit</span><span class="p">(</span><span class="n">resource</span><span class="p">.</span><span class="n">RLIMIT_CPU</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>          <span class="c1"># CPU 제한 2초
</span><span class="n">resource</span><span class="p">.</span><span class="nf">setrlimit</span><span class="p">(</span><span class="n">resource</span><span class="p">.</span><span class="n">RLIMIT_AS</span><span class="p">,</span> <span class="p">(</span><span class="mi">800</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">))</span>  <span class="c1"># 메모리 800MB 제한
</span></code></pre></div></div>

<hr />

<h3 id="4단계-openai-agents-sdk-또는-vllm-function-calling-설계">4단계. OpenAI Agents SDK (또는 vLLM Function-calling) 설계</h3>

<p>코드 실행을 하나의 Tool 로 정의한다.</p>

<p>개념적 pseudo-code:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">execute_python_tool</span><span class="p">(</span><span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">sandbox_path</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/sandbox/temp.py</span><span class="sh">"</span>
    <span class="n">code를</span> <span class="n">sandbox_path</span> <span class="n">에</span> <span class="n">저장</span>
    <span class="n">subprocess로</span> <span class="n">실행하고</span> <span class="n">stdout</span><span class="o">/</span><span class="n">stderr</span> <span class="n">반환</span>
</code></pre></div></div>

<p>LLM 에게 tool spec 을 제공:</p>
<div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">tools</span> <span class="p">=</span> <span class="s">[</span>
    <span class="err">{</span>
        <span class="err">"type":</span> <span class="err">"function",</span>
        <span class="err">"name":</span> <span class="err">"execute_python_tool",</span>
        <span class="err">"description":</span> <span class="err">"Executes</span> <span class="err">python</span> <span class="err">code</span> <span class="err">inside</span> <span class="err">sandbox",</span>
        <span class="err">"parameters":</span> <span class="err">{</span>
            <span class="err">"type":</span> <span class="err">"object",</span>
            <span class="err">"properties":</span> <span class="err">{</span>
                <span class="err">"code":</span> <span class="err">{"type":</span> <span class="err">"string"}</span>
            <span class="err">},</span>
            <span class="err">"required":</span> <span class="nn">["code"]</span>
        <span class="err">}</span>
    <span class="err">}</span>
<span class="err">]</span>
</code></pre></div></div>

<p>vLLM(Qwen/GPTOSS) + Agents SDK 는 다음과 같이 동작:</p>

<ul>
  <li>사용자가 “분석해줘” → LLM → 코드 생성 → tool 호출 → python 실행 → 결과 반환.</li>
</ul>

<hr />

<h3 id="5단계-호스트-파일-보호-정리">5단계. 호스트 파일 보호 (정리)</h3>

<p>보안 수칙:</p>

<ol>
  <li>
    <p>코드 실행은 항상 <strong>subprocess에서</strong> 실행.</p>
  </li>
  <li>
    <p>sandbox 디렉토리 외 경로 접근 시 <strong>실행 거부</strong>.</p>
  </li>
  <li>
    <p>CPU / 메모리 / 실행시간 제한.</p>
  </li>
  <li>
    <p>생성된 파일도 sandbox 내부에서만.</p>
  </li>
</ol>

<hr />

<h3 id="요약-당신이-얻는-것">요약 (당신이 얻는 것)</h3>

<ul>
  <li>
    <p><strong>Docker 없이도 가능한 code interpreter</strong></p>
  </li>
  <li>
    <p><strong>LLM이 generate → 실행 → 결과 반환</strong> 하는 Pipeline</p>
  </li>
  <li>
    <p><strong>호스트 파일을 읽기 전용으로 유지</strong> 하면서, 수정은 전부 sandbox에서만</p>
  </li>
  <li>
    <p><strong>LLM 기반 동적 tool execution</strong></p>
  </li>
</ul>

<hr />

<h3 id="다음-단계">다음 단계</h3>

<p>원한다면,</p>

<ul>
  <li>
    <p>내가 직접 프로덕션 수준 코드 (예: runner.py, tool binding 코드) 를 작성해 줄 수 있다</p>
  </li>
  <li>
    <p>또는 vLLM + Agents SDK 와 통합된 전체 프로젝트 템플릿을 만들어 줄 수 있다</p>
  </li>
</ul>

<p>한마디로, 당신이 만들려는 건 <strong>Code Interpreter Clone, but without Docker</strong>.</p>

<p>계속 도와줄게.<br />
다음 메시지에 아래 중 하나 선택해줘:</p>

<ol>
  <li>
    <p>Python 실제 실행 코드 + tool 코드 생성 원함</p>
  </li>
  <li>
    <p>vLLM + Qwen + Agents SDK 통합 구조 샘플 원함</p>
  </li>
  <li>
    <p>둘 다 원함</p>
  </li>
</ol>

<p>언제든 확장해서 고고!</p>

<p class="chat--user">

1. 어제 너가 만들어준 코드도 참고해줘. 이 코드의 장점은 Kernel이 유지된다는 장점이 있는 것 같아 2. data 폴더를 따로 안 만들고 모든 경로에 접근 가능하되 쓸 파일은 copy_to_sandbox(source, destination) 같은 Tool로 가져올 수 있게 하면 좋겠어. 3. 너가 준 예시에서 temp.py 가 sanbox 안의 파일만 접근한다는 보장이 없지 않아? 이런 걸 해줄 수 있는 라이브러리 없어? 도커 같은 외부 프로그램은 별로 안 쓰고 싶네 import os, time, base64, re from typing import Dict, Any, List from openai import OpenAI from jupyter_client import KernelManager # ========= 설정 ========= # 환경변수 OPENAI_API_KEY 필요 MODEL = os.environ.get("OPENAI_MODEL", "gpt-5.1") DATA_DIR = os.environ.get("DATA_DIR", "/mnt/data") os.makedirs(DATA_DIR, exist_ok=True) # ========= 임베디드 커널 실행기 ========= class KernelSession: def <strong>init</strong>(self): # 히스토리 비활성화로 깔끔하게 self.km = KernelManager() self.km.start_kernel(extra_arguments=["–HistoryManager.enabled=False"]) self.kc = self.km.client(); self.kc.start_channels() def shutdown(self): try: self.kc.stop_channels() self.km.shutdown_kernel(now=True) except Exception: pass def execute(self, code: str, timeout: float = 3.0) -&gt; Dict[str, Any]: # 간단한 안전 필터(정책에 맞게 확장 가능) if re.search(r"\bseaborn\b", code): return {"returncode": 2, "stdout": "", "stderr": "Do not use seaborn", "artifacts": []} msg_id = self.kc.execute(code, allow_stdin=False, stop_on_error=True) t0 = time.time(); out=[]; err=[]; arts=[] while True: if time.time() - t0 &gt; timeout: # 타임아웃 시 커널 강제 종료(무한루프 방지) self.km.shutdown_kernel(now=True) return {"returncode":124,"stdout":"".join(out),"stderr":"Timeout","artifacts":[]} try: msg = self.kc.get_iopub_msg(timeout=0.1) except Exception: continue if msg["parent_header"].get("msg_id") != msg_id: continue typ = msg["header"]["msg_type"]; content = msg["content"] if typ == "stream": (out if content["name"]=="stdout" else err).append(content["text"]) elif typ == "error": err.append("\n".join(content.get("traceback", []))) elif typ in ("display_data","execute_result"): data = content.get("data", {}) if "image/png" in data: b = data["image/png"] if isinstance(b, str): b = b.encode() png = base64.b64decode(b) fn = f"plot_{int(time.time()<em>1000)}.png" fp = os.path.join(DATA_DIR, fn) with open(fp, "wb") as f: f.write(png) arts.append({"name": fn, "path": f"/mnt/data/{fn}", "mime": "image/png"}) elif typ == "status" and content["execution_state"] == "idle": break return { "returncode": 0, "stdout": "".join(out)[:20000], "stderr": "".join(err)[:20000], "artifacts": arts } class KernelPool: def <strong>init</strong>(self): self.sessions: Dict[str, KernelSession] = {} def get(self, session_id: str) -&gt; KernelSession: if session_id not in self.sessions: self.sessions[session_id] = KernelSession() return self.sessions[session_id] def kill(self, session_id: str): s = self.sessions.pop(session_id, None) if s: s.shutdown() POOL = KernelPool() def _plot_rule_check(code: str) -&gt; str | None: # 단일 플롯, 색상/스타일 지정 금지(원하는 정책이면 완화 가능) if re.search(r"\.subplot\(", code) or re.search(r"subplots\(", code): return "Do not use subplots" if re.search(r"(color\s</em>=|palette\s<em>=|style\s</em>=)", code): return "Do not set explicit colors or styles" return None # ========= OpenAI tools 정의(HTTP 서버 없이 in-process) ========= python_exec_internal_tool = { "type": "function", "function": { "name": "python_exec_internal", "description": "내부 분석용 파이썬 실행(사용자에겐 출력 숨김). 세션은 session_id로 유지.", "parameters": { "type": "object", "properties": { "session_id": {"type": "string", "description": "대화/스레드 식별자"}, "code": {"type": "string"}, "timeout_sec": {"type": "integer","minimum":1,"maximum":10,"default":3} }, "required": ["session_id", "code"], "additionalProperties": False }, "strict": True } } python_exec_visible_tool = { "type": "function", "function": { "name": "python_exec_visible", "description": "사용자 가시 파이썬 실행(단일 matplotlib 플롯, 색/스타일 지정 금지).", "parameters": { "type": "object", "properties": { "session_id": {"type": "string"}, "code": {"type": "string"}, "timeout_sec": {"type":"integer","minimum":1,"maximum":10,"default":3}, "enforce_plot_rules": {"type":"boolean","default": True} }, "required": ["session_id", "code"], "additionalProperties": False }, "strict": True } } def run_tool_locally(name: str, args: Dict[str, Any]) -&gt; Dict[str, Any]: session_id = args["session_id"] code = args["code"] timeout = int(args.get("timeout_sec", 3)) if name == "python_exec_visible" and args.get("enforce_plot_rules", True): v = _plot_rule_check(code) if v: return {"returncode": 2, "stdout": "", "stderr": v, "artifacts": []} sess = POOL.get(session_id) return sess.execute(code, timeout=timeout) # ========= 모델 라운드트립 ========= def roundtrip(client: OpenAI, user_msg: str, session_id: str): # 1) 첫 호출: 사용자 질문 + 툴 스펙 제공 resp = client.responses.create( model=MODEL, input=[{"role": "user", "content": user_msg}], tools=[python_exec_internal_tool, python_exec_visible_tool], parallel_tool_calls=False ) # 2) tool_call 감지 및 in-process 실행 → 재피드백 messages = [{"role": "user", "content": user_msg}] final_text = None for item in resp.output: if item.type == "message": # 모델이 즉답했다면 그 내용 final_text = item.content[0].text if item.type == "tool_call": name = item.name args = item.arguments result = run_tool_locally(name, args) # 툴 결과를 모델에 다시 넣어 자연어 답변 생성 follow = client.responses.create( model=MODEL, input=messages + [{"role": "tool", "name": name, "content": result}], tools=[python_exec_internal_tool, python_exec_visible_tool], parallel_tool_calls=False ) final_text = follow.output_text break return final_text # ========= 실행 예시 ========= if <strong>name</strong> == "<strong>main</strong>": client = OpenAI() print("예시 1) 내부용 실행: sum(range(10))") msg1 = "sum(range(10))을 내부 실행기로 계산해서 결과만 말해줘." print(roundtrip(client, msg1, session_id="sess-1")) print("\n예시 2) 가시 실행: 간단 플롯 생성") code = """ import matplotlib.pyplot as plt x = [1,2,3,4]; y = [v*v for v in x] plt.figure() plt.plot(x,y) # 색/스타일 지정 금지 plt.title("y = x^2") plt.savefig("/mnt/data/curve.png") print("done") """ msg2 = f"이 코드를 가시 실행기로 돌리고 산출물 경로를 요약해서 알려줘:\n{code}" print(roundtrip(client, msg2, session_id="sess-1"))

</p>

<p>좋아. 커널이 유지되는 네 기존 구조를 살리면서, “읽기는 어디든 가능, 쓰기는 샌드박스 디렉터리로만”을 강제하고, 도커 없이 실행하는 형태로 정리했다. 핵심은 두 겹의 안전장치다.</p>

<ol>
  <li>
    <p>소프트 가드: 커널 내부에서 open/os/pathlib 등을 몽키패치해 쓰기 동작을 샌드박스로만 제한. subprocess/os.system도 막음.</p>
  </li>
  <li>
    <p>하드 가드(선택, Linux): Landlock(커널 LSM) 바인딩으로 프로세스 자체에 “샌드박스 밖 쓰기 금지”를 커널 수준에서 적용. 라이브러리 예: pylandlock. 이건 도커나 외부 프로그램이 아니라 커널 기능을 직접 이용하므로 요구사항과 부합.</p>
  </li>
</ol>

<p>아래 코드는 네가 올린 커널 유지형 설계를 그대로 확장했다. copy_to_sandbox(source, dest_rel) 툴을 추가했고, temp.py 같은 임의 코드가 샌드박스 밖을 쓰려 하면 커널 안에서 PermissionError를 일으키도록 강제했다. 읽기는 어디든 가능하도록 두었다.</p>

<p>코드 그대로 붙여 넣어 실행하면 된다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python
# coding: utf-8
</span><span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">base64</span><span class="p">,</span> <span class="n">re</span><span class="p">,</span> <span class="n">shutil</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="n">sys</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>
<span class="kn">from</span> <span class="n">jupyter_client</span> <span class="kn">import</span> <span class="n">KernelManager</span>

<span class="c1"># ========= 설정 =========
</span><span class="n">MODEL</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_MODEL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-5.1</span><span class="sh">"</span><span class="p">)</span>
<span class="n">DATA_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">DATA_DIR</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/mnt/data</span><span class="sh">"</span><span class="p">)</span>  <span class="c1"># 가시 산출물 저장 용
</span><span class="n">SANDBOX_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">SANDBOX_DIR</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/mnt/sandbox</span><span class="sh">"</span><span class="p">)</span>  <span class="c1"># 쓰기 허용 디렉터리
</span><span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">DATA_DIR</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">SANDBOX_DIR</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c1"># ========= 커널 내 샌드박스 가드 코드 =========
# 쓰기는 SANDBOX_DIR 내부에서만 허용, 읽기는 어디든 허용
</span><span class="n">KERNEL_GUARD_CODE</span> <span class="o">=</span> <span class="sa">r</span><span class="sh">"""</span><span class="s">
import os, builtins, pathlib, subprocess, sys

SANDBOX_DIR = os.environ.get(</span><span class="sh">"</span><span class="s">SANDBOX_DIR</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">/mnt/sandbox</span><span class="sh">"</span><span class="s">)
SANDBOX_DIR = os.path.realpath(SANDBOX_DIR)

_ORIG_OPEN = builtins.open
_ORIG_OS_OPEN = os.open
_ORIG_RENAME = os.rename
_ORIG_REPLACE = os.replace
_ORIG_REMOVE = os.remove
_ORIG_UNLINK = os.unlink
_ORIG_MKDIR = os.mkdir
_ORIG_MAKEDIRS = os.makedirs
_ORIG_RMDIR = os.rmdir
_ORIG_CHMOD = os.chmod

def _real(p): return os.path.realpath(p)
def _in_sb(p):
    rp = _real(p)
    return rp == SANDBOX_DIR or rp.startswith(SANDBOX_DIR + os.sep)

def _open_guard(file, mode=</span><span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="s">, buffering=-1, encoding=None, errors=None, newline=None, closefd=True, opener=None):
    write_intent = any(ch in mode for ch in (</span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">a</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">+</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">x</span><span class="sh">"</span><span class="s">))
    if write_intent and not _in_sb(file):
        raise PermissionError(f</span><span class="sh">"</span><span class="s">Writes are restricted to SANDBOX_DIR: {SANDBOX_DIR}</span><span class="sh">"</span><span class="s">)
    return _ORIG_OPEN(file, mode, buffering, encoding, errors, newline, closefd, opener)

def _os_open_guard(file, flags, mode=0o777, *, dir_fd=None):
    write_flags = (flags &amp; (os.O_WRONLY | os.O_RDWR | os.O_CREAT | os.O_TRUNC | os.O_APPEND)) != 0
    if write_flags and not _in_sb(file):
        raise PermissionError(f</span><span class="sh">"</span><span class="s">Writes are restricted to SANDBOX_DIR: {SANDBOX_DIR}</span><span class="sh">"</span><span class="s">)
    return _ORIG_OS_OPEN(file, flags, mode, dir_fd=dir_fd)

def _rename_guard(src, dst, *a, **k):
    if not (_in_sb(src) and _in_sb(dst)):
        raise PermissionError(</span><span class="sh">"</span><span class="s">Rename/replace restricted within sandbox</span><span class="sh">"</span><span class="s">)
    return _ORIG_RENAME(src, dst, *a, **k)

def _replace_guard(src, dst, *a, **k):
    if not (_in_sb(src) and _in_sb(dst)):
        raise PermissionError(</span><span class="sh">"</span><span class="s">Rename/replace restricted within sandbox</span><span class="sh">"</span><span class="s">)
    return _ORIG_REPLACE(src, dst, *a, **k)

def _remove_guard(path, *a, **k):
    if not _in_sb(path):
        raise PermissionError(</span><span class="sh">"</span><span class="s">Deletion restricted within sandbox</span><span class="sh">"</span><span class="s">)
    return _ORIG_REMOVE(path, *a, **k)

def _unlink_guard(path, *a, **k):
    if not _in_sb(path):
        raise PermissionError(</span><span class="sh">"</span><span class="s">Deletion restricted within sandbox</span><span class="sh">"</span><span class="s">)
    return _ORIG_UNLINK(path, *a, **k)

def _mkdir_guard(path, *a, **k):
    if not _in_sb(path):
        raise PermissionError(</span><span class="sh">"</span><span class="s">Mkdir restricted within sandbox</span><span class="sh">"</span><span class="s">)
    return _ORIG_MKDIR(path, *a, **k)

def _makedirs_guard(path, *a, **k):
    if not _in_sb(path):
        raise PermissionError(</span><span class="sh">"</span><span class="s">Makedirs restricted within sandbox</span><span class="sh">"</span><span class="s">)
    return _ORIG_MAKEDIRS(path, *a, **k)

def _rmdir_guard(path, *a, **k):
    if not _in_sb(path):
        raise PermissionError(</span><span class="sh">"</span><span class="s">Rmdir restricted within sandbox</span><span class="sh">"</span><span class="s">)
    return _ORIG_RMDIR(path, *a, **k)

def _chmod_guard(path, mode, *a, **k):
    if not _in_sb(path):
        raise PermissionError(</span><span class="sh">"</span><span class="s">chmod restricted within sandbox</span><span class="sh">"</span><span class="s">)
    return _ORIG_CHMOD(path, mode, *a, **k)

builtins.open = _open_guard
os.open = _os_open_guard
os.rename = _rename_guard
os.replace = _replace_guard
os.remove = _remove_guard
os.unlink = _unlink_guard
os.mkdir = _mkdir_guard
os.makedirs = _makedirs_guard
os.rmdir = _rmdir_guard
os.chmod = _chmod_guard

import pathlib
_ORIG_PATH_OPEN = pathlib.Path.open
def _path_open_guard(self, *args, **kwargs):
    mode = kwargs.get(</span><span class="sh">"</span><span class="s">mode</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="s">)
    if len(args) &gt;= 1: mode = args[0]
    write_intent = any(ch in mode for ch in (</span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">a</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">+</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">x</span><span class="sh">"</span><span class="s">))
    if write_intent and not _in_sb(str(self)):
        raise PermissionError(f</span><span class="sh">"</span><span class="s">Writes are restricted to SANDBOX_DIR: {SANDBOX_DIR}</span><span class="sh">"</span><span class="s">)
    return _ORIG_PATH_OPEN(self, *args, **kwargs)
pathlib.Path.open = _path_open_guard

# 차단: 서브프로세스/셸 실행
def _blocked(*a, **k):
    raise PermissionError(</span><span class="sh">"</span><span class="s">Subprocess execution is disabled in sandbox</span><span class="sh">"</span><span class="s">)
subprocess.Popen = _blocked
subprocess.call = _blocked
subprocess.check_call = _blocked
subprocess.check_output = _blocked
os.system = lambda *a, **k: (_ for _ in ()).throw(PermissionError(</span><span class="sh">"</span><span class="s">os.system disabled</span><span class="sh">"</span><span class="s">))

# 리소스 제한 (유닉스만)
try:
    import resource
    resource.setrlimit(resource.RLIMIT_CPU, (3, 3))
    resource.setrlimit(resource.RLIMIT_AS, (1024*1024*1024, 1024*1024*1024))  # 1GB
except Exception:
    pass

print(</span><span class="sh">"</span><span class="s">[sandbox-guard] active:</span><span class="sh">"</span><span class="s">, SANDBOX_DIR)
</span><span class="sh">"""</span>

<span class="c1"># ========= 임베디드 커널 실행기 =========
</span><span class="k">class</span> <span class="nc">KernelSession</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">km</span> <span class="o">=</span> <span class="nc">KernelManager</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">km</span><span class="p">.</span><span class="nf">start_kernel</span><span class="p">(</span><span class="n">extra_arguments</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">--HistoryManager.enabled=False</span><span class="sh">"</span><span class="p">])</span>
        <span class="n">self</span><span class="p">.</span><span class="n">kc</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">km</span><span class="p">.</span><span class="nf">client</span><span class="p">();</span> <span class="n">self</span><span class="p">.</span><span class="n">kc</span><span class="p">.</span><span class="nf">start_channels</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_guard_ready</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">kc</span><span class="p">.</span><span class="nf">stop_channels</span><span class="p">()</span>
            <span class="n">self</span><span class="p">.</span><span class="n">km</span><span class="p">.</span><span class="nf">shutdown_kernel</span><span class="p">(</span><span class="n">now</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_ensure_guard</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_guard_ready</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># 샌드박스 디렉터리를 커널 환경에 주입
</span>        <span class="n">code</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">import os; os.environ[</span><span class="sh">'</span><span class="s">SANDBOX_DIR</span><span class="sh">'</span><span class="s">] = </span><span class="si">{</span><span class="n">SANDBOX_DIR</span><span class="si">!r}</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="n">KERNEL_GUARD_CODE</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_exec_once</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_guard_ready</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">_exec_once</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">msg_id</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">kc</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">allow_stdin</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">stop_on_error</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">();</span> <span class="n">out</span><span class="o">=</span><span class="p">[];</span> <span class="n">err</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span> <span class="o">&gt;</span> <span class="n">timeout</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">km</span><span class="p">.</span><span class="nf">shutdown_kernel</span><span class="p">(</span><span class="n">now</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span><span class="mi">124</span><span class="p">,</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span><span class="sh">""</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">Timeout</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">artifacts</span><span class="sh">"</span><span class="p">:[]}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">kc</span><span class="p">.</span><span class="nf">get_iopub_msg</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="sh">"</span><span class="s">parent_header</span><span class="sh">"</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">msg_id</span><span class="sh">"</span><span class="p">)</span> <span class="o">!=</span> <span class="n">msg_id</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">typ</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="sh">"</span><span class="s">header</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">msg_type</span><span class="sh">"</span><span class="p">];</span> <span class="n">content</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stream</span><span class="sh">"</span><span class="p">:</span>
                <span class="p">(</span><span class="n">out</span> <span class="k">if</span> <span class="n">content</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">]</span><span class="o">==</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span> <span class="k">else</span> <span class="n">err</span><span class="p">).</span><span class="nf">append</span><span class="p">(</span><span class="n">content</span><span class="p">[</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">err</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">content</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">traceback</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])))</span>
            <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="sh">"</span><span class="s">status</span><span class="sh">"</span> <span class="ow">and</span> <span class="n">content</span><span class="p">[</span><span class="sh">"</span><span class="s">execution_state</span><span class="sh">"</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">idle</span><span class="sh">"</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">err</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="n">rc</span><span class="p">,</span> <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span><span class="sh">""</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">out</span><span class="p">)[:</span><span class="mi">20000</span><span class="p">],</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span><span class="sh">""</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">err</span><span class="p">)[:</span><span class="mi">20000</span><span class="p">],</span> <span class="sh">"</span><span class="s">artifacts</span><span class="sh">"</span><span class="p">:[]}</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="c1"># 간단한 정책 필터
</span>        <span class="k">if</span> <span class="n">re</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">\bseaborn\b</span><span class="sh">"</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Do not use seaborn</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">artifacts</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>

        <span class="c1"># 샌드박스 가드 보장
</span>        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_guard</span><span class="p">()</span>

        <span class="n">msg_id</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">kc</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">allow_stdin</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">stop_on_error</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">();</span> <span class="n">out</span><span class="o">=</span><span class="p">[];</span> <span class="n">err</span><span class="o">=</span><span class="p">[];</span> <span class="n">arts</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span> <span class="o">&gt;</span> <span class="n">timeout</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">km</span><span class="p">.</span><span class="nf">shutdown_kernel</span><span class="p">(</span><span class="n">now</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span><span class="mi">124</span><span class="p">,</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span><span class="sh">""</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">Timeout</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">artifacts</span><span class="sh">"</span><span class="p">:[]}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">kc</span><span class="p">.</span><span class="nf">get_iopub_msg</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="sh">"</span><span class="s">parent_header</span><span class="sh">"</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">msg_id</span><span class="sh">"</span><span class="p">)</span> <span class="o">!=</span> <span class="n">msg_id</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">typ</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="sh">"</span><span class="s">header</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">msg_type</span><span class="sh">"</span><span class="p">];</span> <span class="n">content</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stream</span><span class="sh">"</span><span class="p">:</span>
                <span class="p">(</span><span class="n">out</span> <span class="k">if</span> <span class="n">content</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">]</span><span class="o">==</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span> <span class="k">else</span> <span class="n">err</span><span class="p">).</span><span class="nf">append</span><span class="p">(</span><span class="n">content</span><span class="p">[</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">err</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">content</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">traceback</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])))</span>
            <span class="k">elif</span> <span class="n">typ</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">display_data</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">execute_result</span><span class="sh">"</span><span class="p">):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">content</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                <span class="k">if</span> <span class="sh">"</span><span class="s">image/png</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                    <span class="n">b</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">image/png</span><span class="sh">"</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span> <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="p">.</span><span class="nf">encode</span><span class="p">()</span>
                    <span class="kn">import</span> <span class="n">base64</span> <span class="k">as</span> <span class="n">_b64</span>
                    <span class="n">png</span> <span class="o">=</span> <span class="n">_b64</span><span class="p">.</span><span class="nf">b64decode</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                    <span class="n">fn</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">plot_</span><span class="si">{</span><span class="nf">int</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span><span class="o">*</span><span class="mi">1000</span><span class="p">)</span><span class="si">}</span><span class="s">.png</span><span class="sh">"</span>
                    <span class="n">fp</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">DATA_DIR</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>
                    <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="sh">"</span><span class="s">wb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span> <span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">png</span><span class="p">)</span>
                    <span class="n">arts</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn</span><span class="p">,</span> <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">fp</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">mime</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">image/png</span><span class="sh">"</span><span class="p">})</span>
            <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="sh">"</span><span class="s">status</span><span class="sh">"</span> <span class="ow">and</span> <span class="n">content</span><span class="p">[</span><span class="sh">"</span><span class="s">execution_state</span><span class="sh">"</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">idle</span><span class="sh">"</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">out</span><span class="p">)[:</span><span class="mi">20000</span><span class="p">],</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">err</span><span class="p">)[:</span><span class="mi">20000</span><span class="p">],</span> <span class="sh">"</span><span class="s">artifacts</span><span class="sh">"</span><span class="p">:</span> <span class="n">arts</span><span class="p">}</span>

<span class="k">class</span> <span class="nc">KernelPool</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">sessions</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">KernelSession</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">KernelSession</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">session_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">sessions</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">sessions</span><span class="p">[</span><span class="n">session_id</span><span class="p">]</span> <span class="o">=</span> <span class="nc">KernelSession</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">sessions</span><span class="p">[</span><span class="n">session_id</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">kill</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">sessions</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="n">session_id</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="nf">shutdown</span><span class="p">()</span>

<span class="n">POOL</span> <span class="o">=</span> <span class="nc">KernelPool</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_plot_rule_check</span><span class="p">(</span><span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">re</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">\.subplot\(</span><span class="sh">"</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span> <span class="ow">or</span> <span class="n">re</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">subplots\(</span><span class="sh">"</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
        <span class="k">return</span> <span class="sh">"</span><span class="s">Do not use subplots</span><span class="sh">"</span>
    <span class="k">if</span> <span class="n">re</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">(color\s*=|palette\s*=|style\s*=)</span><span class="sh">"</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
        <span class="k">return</span> <span class="sh">"</span><span class="s">Do not set explicit colors or styles</span><span class="sh">"</span>
    <span class="k">return</span> <span class="bp">None</span>

<span class="c1"># ========= 파일 툴: copy_to_sandbox =========
</span><span class="k">def</span> <span class="nf">copy_to_sandbox_impl</span><span class="p">(</span><span class="n">source</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dest_rel</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">src</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">source not found: </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">islink</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">symlink not allowed</span><span class="sh">"</span><span class="p">}</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">basename</span><span class="p">(</span><span class="n">src</span><span class="p">)</span> <span class="k">if</span> <span class="n">dest_rel</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="n">dest_rel</span>
    <span class="c1"># 목적지는 샌드박스 내부로 강제
</span>    <span class="n">dst</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">SANDBOX_DIR</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">dst</span> <span class="o">==</span> <span class="n">SANDBOX_DIR</span> <span class="ow">or</span> <span class="n">dst</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="n">SANDBOX_DIR</span> <span class="o">+</span> <span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">)):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">destination must be inside sandbox</span><span class="sh">"</span><span class="p">}</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">dst</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isdir</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
        <span class="c1"># 디렉터리 복사
</span>        <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">dst</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">destination exists: </span><span class="si">{</span><span class="n">dst</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
        <span class="n">shutil</span><span class="p">.</span><span class="nf">copytree</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">copy_function</span><span class="o">=</span><span class="n">shutil</span><span class="p">.</span><span class="n">copy2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">shutil</span><span class="p">.</span><span class="nf">copy2</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="c1"># 읽기/쓰기 허용 퍼미션 (소유자)
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">chmod</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">stat</span><span class="p">.</span><span class="n">S_IRUSR</span> <span class="o">|</span> <span class="n">stat</span><span class="p">.</span><span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">stat</span><span class="p">.</span><span class="n">S_IRGRP</span> <span class="o">|</span> <span class="n">stat</span><span class="p">.</span><span class="n">S_IROTH</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">rel</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">relpath</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">SANDBOX_DIR</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">sandbox_path</span><span class="sh">"</span><span class="p">:</span> <span class="n">dst</span><span class="p">,</span> <span class="sh">"</span><span class="s">relative_path</span><span class="sh">"</span><span class="p">:</span> <span class="n">rel</span><span class="p">}</span>

<span class="c1"># ========= OpenAI tools 정의 =========
</span><span class="n">python_exec_internal_tool</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">python_exec_internal</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">내부 분석용 파이썬 실행(사용자에겐 출력 숨김). 세션은 session_id로 유지.</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">},</span>
                <span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">},</span>
                <span class="sh">"</span><span class="s">timeout_sec</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">integer</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">minimum</span><span class="sh">"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="sh">"</span><span class="s">maximum</span><span class="sh">"</span><span class="p">:</span><span class="mi">15</span><span class="p">,</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span><span class="mi">3</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">},</span>
        <span class="sh">"</span><span class="s">strict</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">python_exec_visible_tool</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">python_exec_visible</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">사용자 가시 파이썬 실행(단일 matplotlib 플롯, 색/스타일 지정 금지).</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">},</span>
                <span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">},</span>
                <span class="sh">"</span><span class="s">timeout_sec</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">integer</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">minimum</span><span class="sh">"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="sh">"</span><span class="s">maximum</span><span class="sh">"</span><span class="p">:</span><span class="mi">15</span><span class="p">,</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span><span class="mi">3</span><span class="p">},</span>
                <span class="sh">"</span><span class="s">enforce_plot_rules</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">boolean</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">},</span>
        <span class="sh">"</span><span class="s">strict</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">copy_to_sandbox_tool</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">copy_to_sandbox</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">호스트의 임의 경로에서 파일/폴더를 샌드박스로 복사. 쓰기 가능한 경로는 샌드박스뿐.</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">source</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">호스트의 기존 경로</span><span class="sh">"</span><span class="p">},</span>
                <span class="sh">"</span><span class="s">dest_rel</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">샌드박스 내부 상대경로</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">source</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">},</span>
        <span class="sh">"</span><span class="s">strict</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">TOOLS</span> <span class="o">=</span> <span class="p">[</span><span class="n">python_exec_internal_tool</span><span class="p">,</span> <span class="n">python_exec_visible_tool</span><span class="p">,</span> <span class="n">copy_to_sandbox_tool</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">run_tool_locally</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">copy_to_sandbox</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">copy_to_sandbox_impl</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="sh">"</span><span class="s">source</span><span class="sh">"</span><span class="p">],</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">dest_rel</span><span class="sh">"</span><span class="p">))</span>

    <span class="n">session_id</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">]</span>
    <span class="n">code</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">]</span>
    <span class="n">timeout</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">timeout_sec</span><span class="sh">"</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">python_exec_visible</span><span class="sh">"</span> <span class="ow">and</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">enforce_plot_rules</span><span class="sh">"</span><span class="p">,</span> <span class="bp">True</span><span class="p">):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="nf">_plot_rule_check</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">v</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">,</span> <span class="sh">"</span><span class="s">artifacts</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>

    <span class="n">sess</span> <span class="o">=</span> <span class="n">POOL</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sess</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>

<span class="c1"># ========= 모델 라운드트립 =========
</span><span class="k">def</span> <span class="nf">roundtrip</span><span class="p">(</span><span class="n">client</span><span class="p">:</span> <span class="n">OpenAI</span><span class="p">,</span> <span class="n">user_msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">MODEL</span><span class="p">,</span>
        <span class="nb">input</span><span class="o">=</span><span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_msg</span><span class="p">}],</span>
        <span class="n">tools</span><span class="o">=</span><span class="n">TOOLS</span><span class="p">,</span>
        <span class="n">parallel_tool_calls</span><span class="o">=</span><span class="bp">False</span>
    <span class="p">)</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_msg</span><span class="p">}]</span>
    <span class="n">final_text</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">.</span><span class="n">output</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">item</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">final_text</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="n">content</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">text</span>
        <span class="k">if</span> <span class="n">item</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">tool_call</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="n">name</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="n">arguments</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nf">run_tool_locally</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
            <span class="n">follow</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">MODEL</span><span class="p">,</span>
                <span class="nb">input</span><span class="o">=</span><span class="n">messages</span> <span class="o">+</span> <span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">result</span><span class="p">}],</span>
                <span class="n">tools</span><span class="o">=</span><span class="n">TOOLS</span><span class="p">,</span>
                <span class="n">parallel_tool_calls</span><span class="o">=</span><span class="bp">False</span>
            <span class="p">)</span>
            <span class="n">final_text</span> <span class="o">=</span> <span class="n">follow</span><span class="p">.</span><span class="n">output_text</span>
            <span class="k">break</span>

    <span class="k">return</span> <span class="n">final_text</span>

<span class="c1"># ========= 실행 예시 =========
</span><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">()</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">예시 0) 샌드박스에 파일 복사</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">src</span> <span class="o">=</span> <span class="n">__file__</span>   <span class="c1"># 현재 스크립트를 샌드박스로 복사해보자
</span>    <span class="n">result</span> <span class="o">=</span> <span class="nf">copy_to_sandbox_impl</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="sh">"</span><span class="s">example/copied_script.py</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">예시 1) 내부용 실행: sum(range(10))</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">msg1</span> <span class="o">=</span> <span class="sh">"</span><span class="s">sum(range(10))을 내부 실행기로 계산해서 결과만 말해줘.</span><span class="sh">"</span>
    <span class="nf">print</span><span class="p">(</span><span class="nf">roundtrip</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">msg1</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="sh">"</span><span class="s">sess-1</span><span class="sh">"</span><span class="p">))</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">예시 2) 가시 실행: 간단 플롯 생성 후 산출물 경로 출력</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">code</span> <span class="o">=</span> <span class="sh">'''</span><span class="s">
import matplotlib.pyplot as plt, os
x = [1,2,3,4]; y = [v*v for v in x]
plt.figure(); plt.plot(x,y); plt.title(</span><span class="sh">"</span><span class="s">y = x^2</span><span class="sh">"</span><span class="s">)
plt.savefig(os.path.join(os.environ.get(</span><span class="sh">"</span><span class="s">DATA_DIR</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">/mnt/data</span><span class="sh">"</span><span class="s">), </span><span class="sh">"</span><span class="s">curve.png</span><span class="sh">"</span><span class="s">))
print(</span><span class="sh">"</span><span class="s">done</span><span class="sh">"</span><span class="s">)
</span><span class="sh">'''</span>
    <span class="n">msg2</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">이 코드를 가시 실행기로 돌리고 산출물 경로를 요약해서 알려줘:</span><span class="se">\\</span><span class="s">n</span><span class="si">{</span><span class="n">code</span><span class="si">}</span><span class="sh">"</span>
    <span class="nf">print</span><span class="p">(</span><span class="nf">roundtrip</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">msg2</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="sh">"</span><span class="s">sess-1</span><span class="sh">"</span><span class="p">))</span>
</code></pre></div></div>

<p>핵심 포인트를 짚어둔다.</p>

<ol>
  <li>
    <p>커널 지속성 유지<br />
기존과 동일하게 jupyter_client.KernelManager를 사용하되, 세션마다 샌드박스 가드를 한 번만 주입해 유지한다. 타임아웃으로 커널을 kill하면 새 커널에서 가드를 재주입한다.</p>
  </li>
  <li>
    <p>모든 경로 읽기 허용, 쓰기는 샌드박스만<br />
커널 내부에서 open/os.open/pathlib.Path.open/rename/remove 등 쓰기성 작업을 가드한다. 코드를 통한 임의의 파일 쓰기는 샌드박스 밖으로 나갈 수 없다. copy_to_sandbox(source, dest_rel) 툴은 호스트 프로세스에서 안전 검증 후 샌드박스에 복사한다.</p>
  </li>
  <li>
    <p>temp.py가 샌드박스 밖을 만지지 못한다는 보장<br />
소프트 가드만으로도 대부분의 파이썬 레벨 I/O를 막지만, 이론적으로 C 확장/ctypes로 우회할 수 있다. 그래서 리눅스라면 커널 레벨 하드 가드를 추천한다.</p>
  </li>
</ol>

<p>하드 가드 옵션(Linux, 선택 사항, 도커/외부 프로그램 불필요)<br />
Landlock LSM 바인딩(pylandlock 같은 라이브러리)을 사용하면 프로세스가 스스로 “샌드박스 밖 쓰기 금지” 규칙을 커널에 등록할 수 있다. 루트 권한이 필요 없고, 프로세스 자신에게만 적용된다. 적용 지점은 KernelSession 생성 직후다.</p>

<p>개념 코드(실패 시 예외를 무시하고 소프트 가드만 사용):</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">apply_landlock_allow_write_only_to_sandbox</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="n">landlock</span>  <span class="c1"># 또는 pylandlock: 배포판에 따라 패키지명이 다를 수 있음
</span>        <span class="kn">from</span> <span class="n">landlock</span> <span class="kn">import</span> <span class="n">Ruleset</span><span class="p">,</span> <span class="n">AccessFs</span><span class="p">,</span> <span class="n">PathBeneath</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="nc">Ruleset</span><span class="p">()</span>
        <span class="c1"># 기본은 아무 쓰기도 불가, 샌드박스만 쓰기 허용
</span>        <span class="n">write_perms</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">AccessFs</span><span class="p">.</span><span class="n">WRITE_FILE</span> <span class="o">|</span> <span class="n">AccessFs</span><span class="p">.</span><span class="n">REMOVE_FILE</span> <span class="o">|</span>
            <span class="n">AccessFs</span><span class="p">.</span><span class="n">MAKE_DIR</span> <span class="o">|</span> <span class="n">AccessFs</span><span class="p">.</span><span class="n">REMOVE_DIR</span> <span class="o">|</span>
            <span class="n">AccessFs</span><span class="p">.</span><span class="n">TRUNCATE</span> <span class="o">|</span> <span class="n">AccessFs</span><span class="p">.</span><span class="n">RENAME_FROM</span> <span class="o">|</span> <span class="n">AccessFs</span><span class="p">.</span><span class="n">RENAME_TO</span>
        <span class="p">)</span>
        <span class="n">rs</span><span class="p">.</span><span class="nf">add_rule</span><span class="p">(</span><span class="nc">PathBeneath</span><span class="p">(</span><span class="n">SANDBOX_DIR</span><span class="p">,</span> <span class="n">write_perms</span><span class="p">))</span>
        <span class="n">rs</span><span class="p">.</span><span class="nf">restrict_self</span><span class="p">()</span>  <span class="c1"># 여기서부터 현재 프로세스는 샌드박스 밖 쓰기 불가
</span>        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[landlock] active</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[landlock] not available:</span><span class="sh">"</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</code></pre></div></div>

<p>이 함수는 KernelManager가 띄우는 커널 프로세스 안이 아니라, 네 런너 프로세스에 적용하는 게 아니라는 점을 잊지 말고, 커널 프로세스에 적용하려면 커널 시작 후 첫 셀로 Landlock 적용 코드를 주입해야 한다. 위 KERNEL_GUARD_CODE 상단에 Landlock 적용 코드를 넣고, 실패해도 계속 진행하도록 구성하면 된다. 커널 버전이 5.13+ 이어야 한다.</p>

<p>추가 하드닝 아이디어<br />
seccomp(pylibseccomp)로 socket/subprocess 관련 시스템콜 자체를 차단해 네트워크/셸을 무력화할 수 있다. 네트워크 차단이 필요하면 이걸 병행하자.</p>

<p>주의점<br />
읽기를 어디든 허용하면 민감한 키/토큰 파일(예: ~/.ssh, .env)도 읽힐 수 있다. 운영 시엔 copy_to_sandbox로 읽기 허용 목록을 좁히거나, 가드 코드에 “읽기 허용 경로 allowlist”를 추가하는 게 안전하다.</p>

<p>이제 네 스택(vLLM + Qwen/GPTOSS + OpenAI Agents SDK)에 그대로 접목하면 된다. 모델에게는 다음 세 가지 툴을 노출한다.</p>

<ol>
  <li>
    <p>copy_to_sandbox(source, dest_rel?)</p>
  </li>
  <li>
    <p>python_exec_internal(session_id, code, …)</p>
  </li>
  <li>
    <p>python_exec_visible(session_id, code, …)</p>
  </li>
</ol>

<p>실행 동선은 간단하다. 모델이 파일이 필요하면 copy_to_sandbox를 먼저 부르고, 그 다음 실행 툴로 샌드박스 내부 경로만 쓰게 된다. 이렇게 하면 커널을 유지하면서도 파일 안전성이 보장된다.</p>

<p>원하면 Landlock 주입까지 포함한 버전으로 리팩터링해 줄게.</p>

<p class="chat--user">

이런 일을 하는 파이썬 패키지가 있을 법 한데 찾아보고 알려주라

</p>

<p>짧은 결론부터 말할게. 순수 파이썬만으로 “진짜” 안전한 샌드박스를 만드는 건 여러 차례 실패했고, 현재도 권장되지 않는다. 대신 리눅스 커널 기능을 노출한 파이썬 패키지를 조합하면 도커 없이도 “샌드박스 밖 쓰기 금지”를 꽤 단단하게 만들 수 있다. 대표 조합은 Landlock(+선택적으로 seccomp)이다. <a href="https://lwn.net/Articles/574323/?utm_source=chatgpt.com">LWN.net</a></p>

<p>다음이 지금 목적(커널 유지, 어디든 읽기 가능·쓰기만 샌드박스)과 잘 맞는 패키지들이야.</p>

<ol>
  <li>커널 레벨 격리(도커 없이 강력·권장)</li>
</ol>

<ul>
  <li>
    <p>landlock: 리눅스 5.13+에서 프로세스가 “이 디렉터리만 쓰기 허용” 같은 규칙을 스스로 걸 수 있게 해주는 LSM 바인딩. 한 줄 요약: 커널이 파일 쓰기를 차단하므로 temp.py가 밖으로 나가서 write/rename/delete를 하려 해도 거기서 막힌다. 세션 커널을 유지한 채, 커널 시작 직후 규칙을 적용하면 된다. <a href="https://pypi.org/project/landlock/?utm_source=chatgpt.com">PyPI</a></p>
  </li>
  <li>
    <p>pyseccomp / python3-seccomp: libseccomp 바인딩. execve/fork/socket 같은 시스템콜을 막아 서브프로세스 실행이나 네트워크 등 “탈출 루트”를 추가로 봉쇄할 수 있다. Landlock과 병행하면 효과가 좋다. <a href="https://pypi.org/project/pyseccomp/?utm_source=chatgpt.com">PyPI</a></p>
  </li>
</ul>

<ol>
  <li>운영체제 프로파일 기반(환경 의존·설정 필요)</li>
</ol>

<ul>
  <li>edx-codejail: “파이썬 코드 감옥”을 관리하는 패키지. 보안은 AppArmor 프로파일로 강제한다. 즉 패키지는 파이썬이지만, 커널의 AppArmor 설정이 제대로 있어야 보호가 된다. 도커는 필요 없지만 시스템 설정은 필요. <a href="https://pypi.org/project/edx-codejail/?utm_source=chatgpt.com">PyPI</a></li>
</ul>

<ol>
  <li>대안 런타임(아키텍처를 바꿔서 샌드박스)</li>
</ol>

<ul>
  <li>WebAssembly 런타임을 파이썬에서 직접 쓰기: wasmer-python/wasmtime-py로 WASI 환경에서 CPython/py2wasm 등을 돌리면 기본이 “허용 안 함”이라 파일·네트워크 접근이 명시적으로 열어주기 전까지 막힌다. 세션형 유지도 구현 가능. 다만 네이티브 확장 모듈(예: numpy) 호환성은 전략이 필요하다. <a href="https://github.com/wasmerio/wasmer-python?utm_source=chatgpt.com">GitHub</a></li>
</ul>

<p>보조(단독 사용 비권장, 하지만 레이어로 유용)</p>

<ul>
  <li>
    <p>RestrictedPython: 언어 기능을 제한하는 도구(문법/바이트코드 레벨)라 OS 파일 시스템을 가두는 건 아니다. Landlock/seccomp 위에서 “추가 울타리”로 쓰면 좋다. <a href="https://restrictedpython.readthedocs.io/?utm_source=chatgpt.com">restrictedpython.readthedocs.io</a></p>
  </li>
  <li>
    <p>pyfakefs: 테스트용 가짜 파일시스템. 실제 디스크를 만지지 않게 만들 수 있지만 “보안 격리”는 아니다. 주 목적은 회귀 방지/테스트 안정성.</p>
  </li>
</ul>

<p>추천 설계(너의 커널 유지 구조에 바로 얹기)</p>

<ol>
  <li>
    <p>커널 시작 직후 첫 셀에서 Landlock을 적용해 “SANDBOX_DIR만 쓰기 허용” 규칙을 건다.</p>
  </li>
  <li>
    <p>seccomp로 execve/fork/socket 등을 막는다(선택).</p>
  </li>
  <li>
    <p>LLM이 외부 파일을 쓰고 싶다면 반드시 copy_to_sandbox(source, dest_rel) 툴을 호출하도록 에이전트 정책을 강제한다.</p>
  </li>
  <li>
    <p>파이썬 단의 몽키패치(open/rename/remove 등)는 여전히 유용한 소프트 가드지만, 진짜 방어선은 커널(Landlock/seccomp)이 맡는다.</p>
  </li>
</ol>

<p>Landlock 간단 예시(아이디어 스케치)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># pip install landlock  (리눅스 5.13+ 필요)
</span><span class="kn">import</span> <span class="n">os</span>
<span class="kn">from</span> <span class="n">landlock</span> <span class="kn">import</span> <span class="n">Ruleset</span><span class="p">,</span> <span class="n">AccessFs</span><span class="p">,</span> <span class="n">PathBeneath</span>

<span class="n">SANDBOX_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">SANDBOX_DIR</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/mnt/sandbox</span><span class="sh">"</span><span class="p">)</span>
<span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">SANDBOX_DIR</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c1"># 1) 규칙 모음 생성: 기본은 쓰기 불가, 특정 디렉터리만 쓰기 허용
</span><span class="n">rules</span> <span class="o">=</span> <span class="nc">Ruleset</span><span class="p">()</span>
<span class="n">write_perms</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">AccessFs</span><span class="p">.</span><span class="n">WRITE_FILE</span> <span class="o">|</span> <span class="n">AccessFs</span><span class="p">.</span><span class="n">REMOVE_FILE</span> <span class="o">|</span> <span class="n">AccessFs</span><span class="p">.</span><span class="n">MAKE_DIR</span> <span class="o">|</span>
    <span class="n">AccessFs</span><span class="p">.</span><span class="n">REMOVE_DIR</span> <span class="o">|</span> <span class="n">AccessFs</span><span class="p">.</span><span class="n">TRUNCATE</span> <span class="o">|</span> <span class="n">AccessFs</span><span class="p">.</span><span class="n">RENAME_FROM</span> <span class="o">|</span>
    <span class="n">AccessFs</span><span class="p">.</span><span class="n">RENAME_TO</span>
<span class="p">)</span>
<span class="n">rules</span><span class="p">.</span><span class="nf">add_rule</span><span class="p">(</span><span class="nc">PathBeneath</span><span class="p">(</span><span class="n">SANDBOX_DIR</span><span class="p">,</span> <span class="n">write_perms</span><span class="p">))</span>

<span class="c1"># 2) 현재 프로세스(= 네가 유지하는 Jupyter 커널)에 적용
</span><span class="n">rules</span><span class="p">.</span><span class="nf">restrict_self</span><span class="p">()</span>

<span class="c1"># 이제부터 이 프로세스와 자식은 SANDBOX_DIR 밖으로의 쓰기가 커널에서 거부됨
</span></code></pre></div></div>

<p>참고로 execve/fork/socket도 막고 싶다면, 커널 시작 직후 seccomp 필터를 같이 로드하면 된다(예: execve/execveat/fork/vfork/sys_socket 차단). <a href="https://pypi.org/project/pyseccomp/?utm_source=chatgpt.com">PyPI</a></p>

<p>정리하면 이렇게 골라 쓰면 된다.</p>

<ul>
  <li>
    <p>“도커 없이, 파일 쓰기만 샌드박스로”: landlock 필수, 필요 시 seccomp 추가. <a href="https://pypi.org/project/landlock/?utm_source=chatgpt.com">PyPI+1</a></p>
  </li>
  <li>
    <p>“시스템 프로파일을 써도 괜찮다”: codejail(AppArmor)로 관리. <a href="https://pypi.org/project/edx-codejail/?utm_source=chatgpt.com">PyPI</a></p>
  </li>
  <li>
    <p>“아예 다른 런타임에 가둔다”: wasmer-python/wasmtime-py 기반 WASM 샌드박스. <a href="https://github.com/wasmerio/wasmer-python?utm_source=chatgpt.com">GitHub</a></p>
  </li>
  <li>
    <p>“순수 파이썬 샌드박스만으로는 위험”: 과거 시도가 ‘설계상 취약’으로 결론 났다. 커널/런타임 레벨 방어를 반드시 곁들여라. <a href="https://lwn.net/Articles/574323/?utm_source=chatgpt.com">LWN.net</a></p>
  </li>
</ul>

<p>원하면 네가 어제 주신 커널-세션 구조에 Landlock+seccomp를 정확히 주입한 버전(툴 호출과 연동까지)로 리라이팅해서 전달하겠다.</p>

<p class="chat--user">

그렇게 까지 완벽한 샌드박스는 필요없어

</p>

<p>좋아. “완벽하지 않아도 되는” 현실적 80/20 해법으로 정리해 줄게. 핵심은 커널은 계속 유지하면서, 실수로 호스트를 더럽히는 걸 막는 3중 완충장치다.</p>

<ol>
  <li>
    <p>커널 시작 직후 한 번만 주입하는 audit hook으로 쓰기/서브프로세스/네트워크를 가볍게 차단</p>
  </li>
  <li>
    <p>필요한 파일은 copy_to_sandbox(source, dest_rel)로 복사해 샌드박스 안에서만 다룸</p>
  </li>
  <li>
    <p>CPU/메모리/파일사이즈 같은 리소스 제한으로 폭주 방지</p>
  </li>
</ol>

<p>이 조합은 “강철 감옥”은 아니지만, 실무에서 발생하는 대부분의 실수성 파괴를 확실히 걸러준다. 그리고 도커도 필요 없다.</p>

<p>아래는 네가 준 커널-세션 코드에 딱 필요한 만큼만 추가/교체하는 스니펫이다.</p>

<ol>
  <li>커널에 주입할 가벼운 가드 코드(sys.addaudithook 기반)</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 커널에 인젝션할 코드: AUDIT_GUARD_CODE
</span><span class="n">AUDIT_GUARD_CODE</span> <span class="o">=</span> <span class="sa">r</span><span class="sh">"""</span><span class="s">
import os, sys
SANDBOX_DIR = os.path.realpath(os.environ.get(</span><span class="sh">'</span><span class="s">SANDBOX_DIR</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">/mnt/sandbox</span><span class="sh">'</span><span class="s">))
os.makedirs(SANDBOX_DIR, exist_ok=True)

def _in_sb(p):
    rp = os.path.realpath(p)
    return rp == SANDBOX_DIR or rp.startswith(SANDBOX_DIR + os.sep)

def _audit(event, args):
    # 파일 쓰기 시도 차단: open 및 os.open은 </span><span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="s"> 이벤트로 들어옴
    if event == </span><span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="s">:
        path = str(args[0])
        mode = str(args[1]) if len(args) &gt; 1 else </span><span class="sh">'</span><span class="s">r</span><span class="sh">'</span><span class="s">
        flags = int(args[2]) if len(args) &gt; 2 else 0
        write_intent = any(ch in mode for ch in (</span><span class="sh">'</span><span class="s">w</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">a</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">+</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">x</span><span class="sh">'</span><span class="s">)) or (flags &amp; (os.O_WRONLY|os.O_RDWR|os.O_CREAT|os.O_TRUNC|os.O_APPEND))
        if write_intent and not _in_sb(path):
            raise PermissionError(f</span><span class="sh">'</span><span class="s">Writes are restricted to {SANDBOX_DIR}: {path}</span><span class="sh">'</span><span class="s">)
    # 서브프로세스/셸 차단
    elif event.startswith(</span><span class="sh">'</span><span class="s">subprocess.</span><span class="sh">'</span><span class="s">):
        raise PermissionError(</span><span class="sh">'</span><span class="s">Subprocess disabled in this session</span><span class="sh">'</span><span class="s">)
    elif event == </span><span class="sh">'</span><span class="s">os.system</span><span class="sh">'</span><span class="s">:
        raise PermissionError(</span><span class="sh">'</span><span class="s">os.system disabled in this session</span><span class="sh">'</span><span class="s">)
    # 네트워크 차단(원하면 주석 해제)
    elif event.startswith(</span><span class="sh">'</span><span class="s">socket.</span><span class="sh">'</span><span class="s">):
        raise PermissionError(</span><span class="sh">'</span><span class="s">Network disabled in this session</span><span class="sh">'</span><span class="s">)

sys.addaudithook(_audit)

# 가벼운 한도 설정(유닉스 계열에서만 작동)
try:
    import resource
    resource.setrlimit(resource.RLIMIT_CPU, (3, 3))             # CPU 3초
    resource.setrlimit(resource.RLIMIT_AS, (1024*1024*1024,)*2) # 1GB 메모리
    resource.setrlimit(resource.RLIMIT_FSIZE, (200*1024*1024,)*2) # 파일 최대 200MB
    resource.setrlimit(resource.RLIMIT_NOFILE, (256, 256))
except Exception:
    pass

print(</span><span class="sh">'</span><span class="s">[audit-guard] active for sandbox:</span><span class="sh">'</span><span class="s">, SANDBOX_DIR)
</span><span class="sh">"""</span>
</code></pre></div></div>

<ol>
  <li>KernelSession에 가드 주입 한 번만 실행하도록 보강</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">KernelSession</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="n">jupyter_client</span> <span class="kn">import</span> <span class="n">KernelManager</span>
        <span class="n">self</span><span class="p">.</span><span class="n">km</span> <span class="o">=</span> <span class="nc">KernelManager</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">km</span><span class="p">.</span><span class="nf">start_kernel</span><span class="p">(</span><span class="n">extra_arguments</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">--HistoryManager.enabled=False</span><span class="sh">"</span><span class="p">])</span>
        <span class="n">self</span><span class="p">.</span><span class="n">kc</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">km</span><span class="p">.</span><span class="nf">client</span><span class="p">();</span> <span class="n">self</span><span class="p">.</span><span class="n">kc</span><span class="p">.</span><span class="nf">start_channels</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_guard_ready</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_ensure_guard</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_guard_ready</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">code</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">import os; os.environ[</span><span class="sh">'</span><span class="s">SANDBOX_DIR</span><span class="sh">'</span><span class="s">] = </span><span class="si">{</span><span class="n">SANDBOX_DIR</span><span class="si">!r}</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="n">AUDIT_GUARD_CODE</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_exec_once</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_guard_ready</span> <span class="o">=</span> <span class="bp">True</span>
</code></pre></div></div>

<ol>
  <li>copy_to_sandbox(source, dest_rel) 툴(간결판)</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">copy_to_sandbox_impl</span><span class="p">(</span><span class="n">source</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dest_rel</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">shutil</span><span class="p">,</span> <span class="n">stat</span>
    <span class="n">src</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">source not found: </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">islink</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">symlink not allowed</span><span class="sh">"</span><span class="p">}</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">basename</span><span class="p">(</span><span class="n">src</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">dest_rel</span> <span class="k">else</span> <span class="n">dest_rel</span>
    <span class="n">dst</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">SANDBOX_DIR</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">dst</span> <span class="o">==</span> <span class="n">SANDBOX_DIR</span> <span class="ow">or</span> <span class="n">dst</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="n">SANDBOX_DIR</span> <span class="o">+</span> <span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">)):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">destination must be inside sandbox</span><span class="sh">"</span><span class="p">}</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">dst</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isdir</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">dst</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">destination exists: </span><span class="si">{</span><span class="n">dst</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
        <span class="n">shutil</span><span class="p">.</span><span class="nf">copytree</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">copy_function</span><span class="o">=</span><span class="n">shutil</span><span class="p">.</span><span class="n">copy2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">shutil</span><span class="p">.</span><span class="nf">copy2</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">chmod</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">stat</span><span class="p">.</span><span class="n">S_IRUSR</span> <span class="o">|</span> <span class="n">stat</span><span class="p">.</span><span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">stat</span><span class="p">.</span><span class="n">S_IRGRP</span> <span class="o">|</span> <span class="n">stat</span><span class="p">.</span><span class="n">S_IROTH</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">sandbox_path</span><span class="sh">"</span><span class="p">:</span> <span class="n">dst</span><span class="p">}</span>
</code></pre></div></div>

<ol>
  <li>실행기에서 가드 보장 후 코드 수행</li>
</ol>

<p>네가 이미 가진 <code class="language-plaintext highlighter-rouge">KernelSession.execute()</code> 앞부분에 <code class="language-plaintext highlighter-rouge">_ensure_guard()</code> 한 줄만 추가하면 된다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_guard</span><span class="p">()</span>  <span class="c1"># 가드가 주입되지 않았다면 지금 주입
</span>    <span class="c1"># 이하 기존 로직 그대로
</span></code></pre></div></div>

<p>이렇게 하면 다음이 자연스럽게 충족된다.</p>

<ul>
  <li>
    <p>어디든 읽기 가능</p>
  </li>
  <li>
    <p>쓰기는 샌드박스 디렉토리 안에서만 가능</p>
  </li>
  <li>
    <p>temp.py 같은 임의 코드가 /etc, ~, /var 등에 쓰려고 하면 audit hook에서 즉시 PermissionError</p>
  </li>
  <li>
    <p>서브프로세스/네트워크는 기본 차단(옵션)</p>
  </li>
  <li>
    <p>커널은 세션 단위로 계속 유지</p>
  </li>
</ul>

<p>운영 팁 몇 가지만 덧붙인다.</p>

<ul>
  <li>
    <p>민감 경로 읽기까지 허용하면 의도치 않게 비밀 토큰을 읽을 수 있다. 필요하면 audit hook에서 읽기 허용 경로도 allowlist로 좁혀라.</p>
  </li>
  <li>
    <p>Windows에서는 resource 제한이 제한적이다. 그래도 audit hook은 동작하니 파일 쓰기/서브프로세스 차단엔 유용하다.</p>
  </li>
  <li>
    <p>CPython 3.8+에서 audit hook이 지원된다. 그 아래 버전은 이 방식이 안 된다.</p>
  </li>
  <li>
    <p>numpy/pandas/matplotlib 같은 일반 과학 스택은 그대로 사용 가능하다. 네가 잡아 둔 “단일 플롯·색상 지정 금지” 정책은 기존 검사로 유지하면 된다.</p>
  </li>
</ul>

<p>이 정도면 “완벽한 감옥”은 아니지만, 실무에서 실수성 파괴를 거의 없애면서 커널 지속성과 개발 편의성을 그대로 가져갈 수 있다. 다음으로 vLLM + Agents SDK에 노출할 툴 스펙을 정리해주길 원하면 그 부분도 바로 이어서 만들어 줄게.</p>

<p class="chat--user">

landlock을 읽기 가능 폴더 따로 쓰기 가능 폴더 따로 지정가능해?

</p>

<p>가능해. Landlock는 “경로별 권한 비트마스크”를 줘서 읽기 전용 디렉터리와 쓰기 허용 디렉터리를 각각 따로 지정할 수 있어. 방법의 뼈대는 이렇다.</p>

<ol>
  <li>
    <p>ruleset을 만들 때 읽기와 쓰기에 해당하는 모든 권한을 handled_access_fs에 포함한다. 예시로 문서에 나오는 READ_FILE, READ_DIR, WRITE_FILE, MAKE__(파일/디렉터리 생성), REMOVE__(삭제), TRUNCATE(ABI v3+), REFER(디렉터리 간 이동/링크, ABI v2+) 등을 묶는다. 이렇게 해야 “명시한 권한만 허용, 나머지는 거부”가 제대로 작동한다. <a href="https://docs.kernel.org/userspace-api/landlock.html">Kernel 문서</a></p>
  </li>
  <li>
    <table>
      <tbody>
        <tr>
          <td>읽기 전용 디렉터리 규칙을 추가한다. 해당 경로에 대해 allowed_access를 READ_FILE</td>
          <td>READ_DIR(필요하면 EXECUTE) 정도만 주는 PathBeneath 규칙을 ruleset에 넣는다. 커널 문서 예제도 /usr를 이런 식으로 “읽기만 허용”으로 추가한다. <a href="https://docs.kernel.org/userspace-api/landlock.html">Kernel 문서+1</a></td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>쓰기 허용 디렉터리 규칙을 별도로 추가한다. 보통은 READ_DIR(경로 탐색/목록), WRITE_FILE, MAKE_REG/MAKE_DIR, REMOVE_FILE/REMOVE_DIR, TRUNCATE(ABI v3+)를 묶고, 디렉터리 간 rename/link가 필요하면 REFER(ABI v2+)까지 포함한다. 그런 다음 landlock_restrict_self로 현재 스레드(→ 자식 프로세스 포함)에 적용한다. <a href="https://docs.kernel.org/userspace-api/landlock.html">Kernel 문서+1</a></li>
</ol>

<p>팁과 주의점</p>

<ul>
  <li>
    <p>“진짜” 의미의 write-only 디렉터리를 만들고 싶더라도, 파일을 만들거나 열려면 최소한 디렉터리 탐색을 위한 READ_DIR 권한이 필요해지는 경우가 많다. 커널 문서도 실전에서는 읽기/쓰기 권한을 디렉터리 단위로 깨끗하게 분리해 두는 것을 권장한다(예: ~/doc은 read-only, ~/tmp는 read-write). <a href="https://docs.kernel.org/userspace-api/landlock.html">Kernel 문서</a></p>
  </li>
  <li>
    <p>TRUNCATE는 ABI v3(리눅스 6.2)부터 제어 가능, REFER는 ABI v2(리눅스 5.19)부터. 실행 환경의 Landlock ABI 버전을 조회해 가용 권한만 쓰도록 하는 “베스트 에포트” 패턴이 공식 예제에 있다. <a href="https://docs.kernel.org/userspace-api/landlock.html">Kernel 문서+1</a></p>
  </li>
  <li>
    <p>파이썬에서 쓰려면 C syscalls를 직접 호출해도 되고, PyPI의 landlock 바인딩을 사용할 수 있다. 이 패키지는 파이썬에서 ruleset을 만들고 경로를 허용 목록으로 추가한 뒤 apply()로 적용하는 흐름을 제공한다(세부 권한 플래그는 버전에 따라 다름). <a href="https://pypi.org/project/landlock/">PyPI+1</a></p>
  </li>
</ul>

<p>요약하면, 하나의 ruleset 안에 “읽기 전용 A 디렉터리용 규칙”과 “쓰기 허용 B 디렉터리용 규칙”을 각각 추가하면 된다. 원하면 네 커널-세션 구조에 맞춰서, A는 READ_FILE/READ_DIR만, B는 READ_DIR+WRITE_FILE+MAKE__/REMOVE__ +TRUNCATE(+REFER 선택)로 묶은 최소 예제 코드를 바로 맞춰 드릴게.</p>

<p class="chat--user">

근데 룰셋을 파이썬 코드가 풀어버릴수도잇지않나

</p>

<p>짧게 답하면 “정상 동작하는 Landlock에 한해선, 파이썬 코드가 룰을 ‘풀어버리는’ 건 불가능”이 맞다. Landlock는 커널이 강제하는 일방향(one-way) 제약이라, 한 번 <code class="language-plaintext highlighter-rouge">landlock_restrict_self()</code>로 적용하면 해제·완화가 안 되고 더 좁히는 것만 가능하다. 그리고 새로 생성되는 자식 프로세스들은 그 제약을 그대로 상속받는다. 형제 스레드에는 자동 전파가 안 되므로, 스레드가 생기기 전에 적용하거나 각 스레드에서 적용해야 한다. <a href="https://landlock.io/talks/2025-01-29_landlock-workshop.pdf?utm_source=chatgpt.com">landlock.io+1</a></p>

<p>현실적인 예외·주의점도 있다.</p>

<ol>
  <li>
    <p>2024년에 “제약을 잃어버릴 수 있는” 커널 버그가 있었다(CVE-2024-42318). 특수한 <code class="language-plaintext highlighter-rouge">keyctl(KEYCTL_SESSION_TO_PARENT)</code> 경로에서 Landlock 정보가 사라지는 문제였고, 커널 측에서 <code class="language-plaintext highlighter-rouge">cred_transfer</code> 훅을 추가하는 방식으로 수정됐다. 메인라인에 머지되었고 각 안정화 브랜치로 백포트됐다. 배포판 커널이 이 수정이 포함된 버전이면, 사용자 공간 코드가 Landlock을 해제하는 우회는 더 이상 통하지 않는다. 환경 점검만 해두면 된다. <a href="https://nvd.nist.gov/vuln/detail/cve-2024-42318?utm_source=chatgpt.com">NVD+1</a></p>
  </li>
  <li>
    <p>제약은 “그 시점 이후의 접근”에 적용된다. 제약을 걸기 전에 이미 쓰기 권한으로 연 열린 파일 디스크립터가 있다면 그 FD를 통해서는 계속 쓸 수 있다. 따라서 커널(또는 커널 프로세스) 시작 직후, 사용자 코드가 돌기 전에 바로 제한을 걸고, 미리 열린 불필요한 FD를 닫는 게 안전하다. 이건 Landlock의 설계 철학(누적·일방향)과 동일한 주의점이다. <a href="https://docs.kernel.org/userspace-api/landlock.html?utm_source=chatgpt.com">Kernel 문서</a></p>
  </li>
</ol>

<p>정리하면 다음처럼 운용하면 된다.</p>

<p>• “풀 수 없다”는 보장은 커널이 준다. 사용자 파이썬이 <code class="language-plaintext highlighter-rouge">ctypes</code>·<code class="language-plaintext highlighter-rouge">os</code>·<code class="language-plaintext highlighter-rouge">subprocess</code>로 발버둥쳐도 Landlock 자체를 해제하진 못한다. 제약은 누적만 된다. <a href="https://landlock.io/talks/2025-01-29_landlock-workshop.pdf?utm_source=chatgpt.com">landlock.io</a><br />
• 단, 커널이 CVE-2024-42318 수정분을 포함해야 한다. 2024-07 말에 메인라인에 들어갔고 배포판 커널에도 반영됐다. 운영 환경의 커널 업데이트 여부를 확인하자. <a href="https://nvd.nist.gov/vuln/detail/cve-2024-42318?utm_source=chatgpt.com">NVD+1</a><br />
• 스레드/프로세스 모델을 기억하자. 현재 스레드에 적용하면 자식에는 상속되지만, 이미 떠 있는 다른 스레드엔 자동 적용 안 된다. 커널 프로세스 초기화 직후 제일 먼저 제한을 건다. <a href="https://man7.org/linux/man-pages/man7/landlock.7.html?utm_source=chatgpt.com">man7.org</a></p>

<p>덧붙여, 읽기 전용 폴더와 쓰기 허용 폴더를 각각 따로 주는 것도 한 ruleset 안에서 규칙 두 개로 충분하며, 필요 권한 비트(READ_FILE/READ_DIR… vs WRITE_FILE/MAKE_DIR/REMOVE_* 등)를 분리해 주면 된다. ABI 버전에 따라 TRUNCATE/REFER 같은 권한 가용성이 달라지니 “best-effort” 방식으로 감지해 쓰면 호환성이 좋다. <a href="https://docs.kernel.org/userspace-api/landlock.html?utm_source=chatgpt.com">Kernel 문서</a></p>

<p>이 상태에서 네 커널-세션 구조 위에 얹으면, 파이썬 쪽 몽키패치나 audit hook은 “소프트 가드”로 편의와 메시지 품질을 올려주고, Landlock이 “하드 가드”로 바닥을 받쳐준다. 다음 단계로 커널 첫 셀에서 Landlock을 적용하는 최소 샘플을 붙여줄 수 있다.</p>

<p class="chat--user">

아하 다시 한 번 깔끔하게 정리해보자. 파이썬 실행 툴을 LLM이 쓸 수 있도록 만들 것 툴 Config 단계 -&gt; LLM에게 툴 사용 법 전달하는 단계 -&gt; 실제로 사용하는 단계 이렇게 3단계를 나눠서 생각하자. 요구 사항 1. 툴 Config 단계에서 landlock으로 WRITE/READ 가 가능한 폴더, READ만 가능한 폴더를 지정해둔다. (하위 폴더까지 포함) 2. 세션은 jupyter client 든 뭐든 유지한다(jupyter client 말고 다른 적절한 방법이 있으면 그걸 사용할 것). 각 에이전트별 세션을 유지한다. 이 때 세션에 대한 id 같은걸 같이 받는 방법이 있을 듯. 3. 실제로 사용할 때는 (1) 세션을 유지할지 말지, (2) 일회용 코드 실행할지 선택할 수도 있을 것 같네. 설계 잘 해줘.

</p>

<p>좋아, 3단계 흐름에 딱 맞춰 설계와 최소 구현 스케치를 정리한다. 목표는 LLM이 파이썬을 실행하되, 설정 단계에서 읽기/쓰기 폴더 정책을 정하고, 세션을 필요에 따라 유지하거나 1회성으로 쓰는 것.</p>

<h1 id="0-전체-구조-한눈에">0. 전체 구조 한눈에</h1>

<ul>
  <li>
    <p>PythonExecManager: 툴 진입점. 정책(랜드락), 세션 생성/해제, 실행을 관리.</p>
  </li>
  <li>
    <p>두 가지 실행 백엔드 중 선택</p>

    <ul>
      <li>
        <p>KernelBackend: Jupyter 커널을 세션 단위로 유지. 첫 셀에서 Landlock + 가벼운 가드 주입.</p>
      </li>
      <li>
        <p>SubprocessBackend: 가벼운 1회성 혹은 유지형 서브프로세스(JSON-RPC) 백엔드.</p>
      </li>
    </ul>
  </li>
  <li>
    <p>툴 세트</p>

    <ul>
      <li>
        <p>configure_python_exec(readwrite_dirs, readonly_dirs)</p>
      </li>
      <li>
        <p>start_python_session(agent_id, backend, keep_alive, idle_timeout_sec)</p>
      </li>
      <li>
        <p>python_execute(code, session_id?, backend?, ephemeral?)</p>
      </li>
      <li>
        <p>copy_to_sandbox(source, dest_rel?)</p>
      </li>
    </ul>
  </li>
</ul>

<h1 id="1단계-툴-config-단계">1단계. 툴 Config 단계</h1>

<p>요구사항: 이 단계에서 Landlock으로 “쓰기 가능 폴더”와 “읽기 전용 폴더”를 지정해둔다. 실제 Landlock 적용은 각 세션 프로세스가 뜨고 사용자 코드가 돌기 전에 수행된다.</p>

<p>기능 요약</p>

<ul>
  <li>
    <p>읽기 전용 디렉터리: READ_FILE/READ_DIR(+EXECUTE 선택)만 허용.</p>
  </li>
  <li>
    <p>쓰기 가능 디렉터리: READ_DIR + WRITE_FILE + MAKE_* + REMOVE_* (+TRUNCATE/REFER은 ABI 지원 시) 허용.</p>
  </li>
  <li>
    <p>Linux가 아니거나 Landlock 미탑재면 소프트 가드(audit hook)만 켠다.</p>
  </li>
</ul>

<p>툴 스펙(LLM에 등록할 JSON, OpenAI Agents SDK/Function calling 양식 예)</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"function"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"function"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"configure_python_exec"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"샌드박스 정책을 설정한다. 읽기/쓰기 폴더를 지정하고 이후 세션에 적용된다."</span><span class="p">,</span><span class="w">
    </span><span class="nl">"parameters"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"readwrite_dirs"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"array"</span><span class="p">,</span><span class="w"> </span><span class="nl">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="nl">"readonly_dirs"</span><span class="p">:</span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"array"</span><span class="p">,</span><span class="w"> </span><span class="nl">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="nl">"sandbox_dir"</span><span class="p">:</span><span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w"> </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"쓰기 기본 루트(샌드박스). 생략 시 내부 기본값 사용"</span><span class="w"> </span><span class="p">}</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"required"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"readwrite_dirs"</span><span class="p">,</span><span class="w"> </span><span class="s2">"readonly_dirs"</span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>파이썬 최소 구현(정책 저장만, 실제 적용은 세션이 켜질 때)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">SandboxPolicy</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">rw</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">ro</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">sandbox_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">readwrite_dirs</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">rw</span><span class="p">]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">readonly_dirs</span>  <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ro</span><span class="p">]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">sandbox_dir</span>    <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">sandbox_dir</span><span class="p">)</span> <span class="k">if</span> <span class="n">sandbox_dir</span> <span class="k">else</span> <span class="sh">"</span><span class="s">/mnt/sandbox</span><span class="sh">"</span>

<span class="k">class</span> <span class="nc">PythonExecManager</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">policy</span><span class="p">:</span> <span class="n">SandboxPolicy</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">self</span><span class="p">.</span><span class="n">sessions</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="sh">"</span><span class="s">BaseSession</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">rw</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">ro</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">sandbox_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">sandbox_dir</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">/mnt/sandbox</span><span class="sh">"</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="nc">SandboxPolicy</span><span class="p">(</span><span class="n">rw</span><span class="p">,</span> <span class="n">ro</span><span class="p">,</span> <span class="n">sandbox_dir</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">sandbox_dir</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">policy</span><span class="p">.</span><span class="n">sandbox_dir</span><span class="p">}</span>
</code></pre></div></div>

<h1 id="2단계-llm에게-툴-사용법-전달-단계">2단계. “LLM에게 툴 사용법” 전달 단계</h1>

<p>시스템/개발자 지침에 넣을 핵심 규칙</p>

<ul>
  <li>
    <p>파일을 쓰거나 생성하려면 먼저 copy_to_sandbox를 호출해 샌드박스 안으로 가져올 것.</p>
  </li>
  <li>
    <p>세션이 필요하면 start_python_session을 먼저 호출하고 반환된 session_id를 python_execute에 넘겨라.</p>
  </li>
  <li>
    <p>1회성 실행은 session_id 없이 python_execute(ephemeral=true, backend=…)로 호출해라.</p>
  </li>
  <li>
    <p>경로를 제시할 때는 샌드박스 내부 경로를 우선 사용해라. 쓰기 시도는 샌드박스 밖에서 실패한다.</p>
  </li>
</ul>

<p>LLM용 툴 스펙</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"function"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"function"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"start_python_session"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"파이썬 실행 세션을 연다(커널 또는 서브프로세스 백엔드)."</span><span class="p">,</span><span class="w">
    </span><span class="nl">"parameters"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"agent_id"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w"> </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"에이전트/스레드 식별자"</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="nl">"backend"</span><span class="p">:</span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w"> </span><span class="nl">"enum"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"kernel"</span><span class="p">,</span><span class="w"> </span><span class="s2">"subprocess"</span><span class="p">],</span><span class="w"> </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="s2">"kernel"</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="nl">"keep_alive"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"boolean"</span><span class="p">,</span><span class="w"> </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="nl">"idle_timeout_sec"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"integer"</span><span class="p">,</span><span class="w"> </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="mi">600</span><span class="w"> </span><span class="p">}</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"required"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"agent_id"</span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"function"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"function"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"python_execute"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"파이썬 코드를 실행한다. 세션 유지 또는 1회성(ephemeral) 실행 모두 지원."</span><span class="p">,</span><span class="w">
    </span><span class="nl">"parameters"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"code"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="nl">"session_id"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w"> </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"유지형 세션 실행 시 필요"</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="nl">"backend"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w"> </span><span class="nl">"enum"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"kernel"</span><span class="p">,</span><span class="w"> </span><span class="s2">"subprocess"</span><span class="p">]</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="nl">"ephemeral"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"boolean"</span><span class="p">,</span><span class="w"> </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="nl">"timeout_sec"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"integer"</span><span class="p">,</span><span class="w"> </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="nl">"visible_mode"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"boolean"</span><span class="p">,</span><span class="w"> </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="p">}</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"required"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"code"</span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"function"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"function"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"copy_to_sandbox"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"호스트 경로에서 파일/폴더를 샌드박스로 복사한다."</span><span class="p">,</span><span class="w">
    </span><span class="nl">"parameters"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"source"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="nl">"dest_rel"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w"> </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"샌드박스 내부 상대경로"</span><span class="w"> </span><span class="p">}</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"required"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"source"</span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>LLM에게 주는 간단 지침 텍스트</p>

<ul>
  <li>
    <p>분석에 쓸 파일은 먼저 copy_to_sandbox로 가져와라.</p>
  </li>
  <li>
    <p>플롯/파일 저장은 항상 ${SANDBOX_DIR} 안으로 저장하라.</p>
  </li>
  <li>
    <p>여러 번 실행·상태 유지가 필요하면 start_python_session → python_execute(session_id=…).</p>
  </li>
  <li>
    <p>한 번만 돌릴 거면 python_execute(ephemeral=true, backend="subprocess")로 호출하라.</p>
  </li>
</ul>

<h1 id="3단계-실제-사용-단계-설계">3단계. 실제 사용 단계 설계</h1>

<p>A. 유지형 세션 흐름(예: 에이전트별 상태 유지)</p>

<ol>
  <li>
    <p>configure_python_exec 호출로 정책 등록</p>
  </li>
  <li>
    <p>start_python_session(agent_id="agent-A", backend="kernel", keep_alive=true)</p>
  </li>
  <li>
    <p>copy_to_sandbox 필요 시 호출</p>
  </li>
  <li>
    <p>python_execute(session_id=…, code=…)</p>
  </li>
  <li>
    <p>필요 시 같은 session_id로 연속 실행</p>
  </li>
  <li>
    <p>아이들 타임아웃 초과 시 세션 자동 종료</p>
  </li>
</ol>

<p>B. 1회성 실행 흐름</p>

<ol>
  <li>
    <p>configure_python_exec 호출(앱 시작 시 1회 해도 됨)</p>
  </li>
  <li>
    <p>python_execute(ephemeral=true, backend="subprocess", code=…)</p>
  </li>
</ol>

<p>이원화 이유</p>

<ul>
  <li>
    <p>kernel은 풍부한 과학 스택/상태 유지에 강함</p>
  </li>
  <li>
    <p>subprocess는 기동이 빠르고, 일회성 코드에 적합</p>
  </li>
</ul>

<h1 id="세션-백엔드-구현-핵심">세션 백엔드 구현 핵심</h1>

<p>Landlock 적용 전략</p>

<ul>
  <li>
    <p>실제 제약은 “각 세션 프로세스 내부”에서 걸어야 한다.</p>
  </li>
  <li>
    <p>KernelBackend: 커널 시작 후 첫 실행 셀에서 Landlock을 적용하고, 이어서 audit hook(소프트 가드)도 주입.</p>
  </li>
  <li>
    <p>SubprocessBackend: 자식 프로세스가 뜨자마자 Landlock을 restrict_self()로 적용한 후 JSON-RPC 루프 진입.</p>
  </li>
</ul>

<p>권한 마스크 구성(ABI 차이 안전 처리)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">build_access_mask</span><span class="p">():</span>
    <span class="kn">import</span> <span class="n">landlock</span>
    <span class="kn">from</span> <span class="n">landlock</span> <span class="kn">import</span> <span class="n">AccessFs</span>
    <span class="n">acc</span> <span class="o">=</span> <span class="n">AccessFs</span><span class="p">.</span><span class="n">READ_FILE</span> <span class="o">|</span> <span class="n">AccessFs</span><span class="p">.</span><span class="n">READ_DIR</span>
    <span class="c1"># 읽기/실행 필요 시
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="n">acc</span> <span class="o">|=</span> <span class="n">AccessFs</span><span class="p">.</span><span class="n">EXECUTE</span>
    <span class="k">except</span> <span class="nb">AttributeError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="n">acc</span>

<span class="k">def</span> <span class="nf">build_write_mask</span><span class="p">():</span>
    <span class="kn">from</span> <span class="n">landlock</span> <span class="kn">import</span> <span class="n">AccessFs</span>
    <span class="n">perms</span> <span class="o">=</span> <span class="p">[</span>
        <span class="sh">"</span><span class="s">WRITE_FILE</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">REMOVE_FILE</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">REMOVE_DIR</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">MAKE_CHAR</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">MAKE_DIR</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">MAKE_REG</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">MAKE_SOCK</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">MAKE_FIFO</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">MAKE_BLOCK</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">MAKE_SYM</span><span class="sh">"</span>
    <span class="p">]</span>
    <span class="n">m</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">perms</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">|=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">AccessFs</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="c1"># ABI v2+: REFER, v3+: TRUNCATE 등은 있으면 추가
</span>    <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="p">[</span><span class="sh">"</span><span class="s">REFER</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">TRUNCATE</span><span class="sh">"</span><span class="p">]:</span>
        <span class="n">m</span> <span class="o">|=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">AccessFs</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="c1"># 디렉터리 트래버스 허용
</span>    <span class="n">m</span> <span class="o">|=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">AccessFs</span><span class="p">,</span> <span class="sh">"</span><span class="s">READ_DIR</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">m</span>
</code></pre></div></div>

<p>KernelBackend 초기화 코드 스케치</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">AUDIT_GUARD</span> <span class="o">=</span> <span class="sa">r</span><span class="sh">"""</span><span class="s">
import os, sys
SBOX = os.path.realpath(os.environ.get(</span><span class="sh">'</span><span class="s">SANDBOX_DIR</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">/mnt/sandbox</span><span class="sh">'</span><span class="s">))
os.makedirs(SBOX, exist_ok=True)
def _in_sb(p): import os; rp=os.path.realpath(p); return rp==SBOX or rp.startswith(SBOX+os.sep)
def _audit(ev, args):
    if ev == </span><span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="s">:
        path = str(args[0]); mode = str(args[1]) if len(args)&gt;1 else </span><span class="sh">'</span><span class="s">r</span><span class="sh">'</span><span class="s">
        flags = int(args[2]) if len(args)&gt;2 else 0
        wr = any(ch in mode for ch in (</span><span class="sh">'</span><span class="s">w</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">a</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">+</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">x</span><span class="sh">'</span><span class="s">)) or (flags &amp; (os.O_WRONLY|os.O_RDWR|os.O_CREAT|os.O_TRUNC|os.O_APPEND))
        if wr and not _in_sb(path): raise PermissionError(f</span><span class="sh">'</span><span class="s">Writes restricted to {SBOX}: {path}</span><span class="sh">'</span><span class="s">)
    elif ev.startswith(</span><span class="sh">'</span><span class="s">subprocess.</span><span class="sh">'</span><span class="s">) or ev==</span><span class="sh">'</span><span class="s">os.system</span><span class="sh">'</span><span class="s">: raise PermissionError(</span><span class="sh">'</span><span class="s">Subprocess disabled</span><span class="sh">'</span><span class="s">)
sys.addaudithook(_audit)
</span><span class="sh">"""</span>

<span class="n">LANDLOCK_INIT</span> <span class="o">=</span> <span class="sa">r</span><span class="sh">"""</span><span class="s">
import os
SANDBOX_DIR = os.environ.get(</span><span class="sh">'</span><span class="s">SANDBOX_DIR</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">/mnt/sandbox</span><span class="sh">'</span><span class="s">)
try:
    import landlock
    from landlock import Ruleset, PathBeneath
    from landlock import AccessFs as A
    rw_dirs = os.environ.get(</span><span class="sh">'</span><span class="s">LL_RW_DIRS</span><span class="sh">'</span><span class="s">,</span><span class="sh">''</span><span class="s">).split(os.pathsep) if os.environ.get(</span><span class="sh">'</span><span class="s">LL_RW_DIRS</span><span class="sh">'</span><span class="s">) else []
    ro_dirs = os.environ.get(</span><span class="sh">'</span><span class="s">LL_RO_DIRS</span><span class="sh">'</span><span class="s">,</span><span class="sh">''</span><span class="s">).split(os.pathsep) if os.environ.get(</span><span class="sh">'</span><span class="s">LL_RO_DIRS</span><span class="sh">'</span><span class="s">) else []
    handled = 0
    for name in dir(A):
        if name.isupper():
            handled |= getattr(A, name)
    rs = Ruleset(handled_access_fs=handled)
    write_mask = 0
    for n in (</span><span class="sh">'</span><span class="s">WRITE_FILE</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">REMOVE_FILE</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">REMOVE_DIR</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">MAKE_DIR</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">MAKE_REG</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">MAKE_SYM</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">REFER</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">TRUNCATE</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">READ_DIR</span><span class="sh">'</span><span class="s">):
        write_mask |= getattr(A, n, 0)
    read_mask = getattr(A,</span><span class="sh">'</span><span class="s">READ_FILE</span><span class="sh">'</span><span class="s">,0) | getattr(A,</span><span class="sh">'</span><span class="s">READ_DIR</span><span class="sh">'</span><span class="s">,0) | getattr(A,</span><span class="sh">'</span><span class="s">EXECUTE</span><span class="sh">'</span><span class="s">,0)
    for d in ro_dirs:
        if d: rs.add_rule(PathBeneath(d, read_mask))
    for d in rw_dirs + [SANDBOX_DIR]:
        if d: rs.add_rule(PathBeneath(d, write_mask | read_mask))
    rs.restrict_self()
    print(</span><span class="sh">'</span><span class="s">[landlock] active</span><span class="sh">'</span><span class="s">)
except Exception as e:
    print(</span><span class="sh">'</span><span class="s">[landlock] unavailable:</span><span class="sh">'</span><span class="s">, e)
</span><span class="sh">"""</span>

<span class="k">class</span> <span class="nc">KernelBackendSession</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">policy</span><span class="p">:</span> <span class="n">SandboxPolicy</span><span class="p">):</span>
        <span class="kn">from</span> <span class="n">jupyter_client</span> <span class="kn">import</span> <span class="n">KernelManager</span>
        <span class="n">self</span><span class="p">.</span><span class="n">km</span> <span class="o">=</span> <span class="nc">KernelManager</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">km</span><span class="p">.</span><span class="nf">start_kernel</span><span class="p">(</span><span class="n">extra_arguments</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">--HistoryManager.enabled=False</span><span class="sh">"</span><span class="p">])</span>
        <span class="n">self</span><span class="p">.</span><span class="n">kc</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">km</span><span class="p">.</span><span class="nf">client</span><span class="p">();</span> <span class="n">self</span><span class="p">.</span><span class="n">kc</span><span class="p">.</span><span class="nf">start_channels</span><span class="p">()</span>
        <span class="c1"># 정책 전달 및 초기 가드/랜드락 주입
</span>        <span class="n">env</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">import os; os.environ[</span><span class="sh">'</span><span class="s">SANDBOX_DIR</span><span class="sh">'</span><span class="s">]=</span><span class="si">{</span><span class="n">policy</span><span class="p">.</span><span class="n">sandbox_dir</span><span class="si">!r}</span><span class="s">;</span><span class="sh">"</span> \
              <span class="sa">f</span><span class="sh">"</span><span class="s">os.environ[</span><span class="sh">'</span><span class="s">LL_RW_DIRS</span><span class="sh">'</span><span class="s">]=</span><span class="si">{</span><span class="n">os</span><span class="p">.</span><span class="n">pathsep</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">policy</span><span class="p">.</span><span class="n">readwrite_dirs</span><span class="p">)</span><span class="si">!r}</span><span class="s">;</span><span class="sh">"</span> \
              <span class="sa">f</span><span class="sh">"</span><span class="s">os.environ[</span><span class="sh">'</span><span class="s">LL_RO_DIRS</span><span class="sh">'</span><span class="s">]=</span><span class="si">{</span><span class="n">os</span><span class="p">.</span><span class="n">pathsep</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">policy</span><span class="p">.</span><span class="n">readonly_dirs</span><span class="p">)</span><span class="si">!r}</span><span class="sh">"</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_exec</span><span class="p">(</span><span class="n">env</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="n">LANDLOCK_INIT</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="n">AUDIT_GUARD</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_exec</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span>
        <span class="n">msg_id</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">kc</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">allow_stdin</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">stop_on_error</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="c1"># … (iopub 수집/timeout 처리는 생략)
</span></code></pre></div></div>

<p>SubprocessBackend 초기화 코드 스케치</p>

<ul>
  <li>자식이 부팅하자마자 Landlock 적용 후 stdin으로 들어오는 JSON 명령을 실행</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">SUBPROCESS_BOOT</span> <span class="o">=</span> <span class="sa">r</span><span class="sh">"""</span><span class="s">
import sys, os, json
SANDBOX_DIR = os.environ.get(</span><span class="sh">'</span><span class="s">SANDBOX_DIR</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">/mnt/sandbox</span><span class="sh">'</span><span class="s">)
def apply_ll():
    try:
        import landlock
        from landlock import Ruleset, PathBeneath
        from landlock import AccessFs as A
        handled = 0
        for n in dir(A):
            if n.isupper(): handled |= getattr(A,n)
        rs = Ruleset(handled_access_fs=handled)
        rw = os.environ.get(</span><span class="sh">'</span><span class="s">LL_RW_DIRS</span><span class="sh">'</span><span class="s">,</span><span class="sh">''</span><span class="s">).split(os.pathsep) if os.environ.get(</span><span class="sh">'</span><span class="s">LL_RW_DIRS</span><span class="sh">'</span><span class="s">) else []
        ro = os.environ.get(</span><span class="sh">'</span><span class="s">LL_RO_DIRS</span><span class="sh">'</span><span class="s">,</span><span class="sh">''</span><span class="s">).split(os.pathsep) if os.environ.get(</span><span class="sh">'</span><span class="s">LL_RO_DIRS</span><span class="sh">'</span><span class="s">) else []
        wm = getattr(A,</span><span class="sh">'</span><span class="s">READ_DIR</span><span class="sh">'</span><span class="s">,0)|getattr(A,</span><span class="sh">'</span><span class="s">WRITE_FILE</span><span class="sh">'</span><span class="s">,0)|getattr(A,</span><span class="sh">'</span><span class="s">MAKE_DIR</span><span class="sh">'</span><span class="s">,0)|getattr(A,</span><span class="sh">'</span><span class="s">MAKE_REG</span><span class="sh">'</span><span class="s">,0)|getattr(A,</span><span class="sh">'</span><span class="s">REMOVE_FILE</span><span class="sh">'</span><span class="s">,0)|getattr(A,</span><span class="sh">'</span><span class="s">REMOVE_DIR</span><span class="sh">'</span><span class="s">,0)|getattr(A,</span><span class="sh">'</span><span class="s">REFER</span><span class="sh">'</span><span class="s">,0)|getattr(A,</span><span class="sh">'</span><span class="s">TRUNCATE</span><span class="sh">'</span><span class="s">,0)
        rm = getattr(A,</span><span class="sh">'</span><span class="s">READ_FILE</span><span class="sh">'</span><span class="s">,0)|getattr(A,</span><span class="sh">'</span><span class="s">READ_DIR</span><span class="sh">'</span><span class="s">,0)|getattr(A,</span><span class="sh">'</span><span class="s">EXECUTE</span><span class="sh">'</span><span class="s">,0)
        for d in ro: 
            if d: rs.add_rule(PathBeneath(d, rm))
        for d in rw+[SANDBOX_DIR]:
            if d: rs.add_rule(PathBeneath(d, rm|wm))
        rs.restrict_self()
    except Exception as e:
        print(</span><span class="sh">'</span><span class="s">[landlock] unavailable:</span><span class="sh">'</span><span class="s">, e, file=sys.stderr)
def loop():
    apply_ll()
    while True:
        line = sys.stdin.readline()
        if not line: break
        req = json.loads(line)
        code = req.get(</span><span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="s">,</span><span class="sh">""</span><span class="s">)
        g = {}
        try:
            exec(code, g, g)
            print(json.dumps({</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="s">: True, </span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="s">: </span><span class="sh">""</span><span class="s">}))
        except Exception as e:
            print(json.dumps({</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="s">: False, </span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="s">: str(e)}))
        sys.stdout.flush()
loop()
</span><span class="sh">"""</span>
</code></pre></div></div>

<h1 id="copy_to_sandbox-구현-메모">copy_to_sandbox 구현 메모</h1>

<ul>
  <li>
    <p>심볼릭 링크 거부, 목적지는 반드시 sandbox_dir 하위 경로로 강제.</p>
  </li>
  <li>
    <p>디렉터리 복사 시 기존 대상 충돌 방지.</p>
  </li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">copy_to_sandbox</span><span class="p">(</span><span class="n">source</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dest_rel</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="bp">None</span><span class="p">,</span> <span class="n">policy</span><span class="p">:</span> <span class="n">SandboxPolicy</span><span class="p">):</span>
    <span class="kn">import</span> <span class="n">shutil</span><span class="p">,</span> <span class="n">stat</span>
    <span class="n">src</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">src</span><span class="p">):</span> <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">not found</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">islink</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">symlink not allowed</span><span class="sh">"</span><span class="p">}</span>
    <span class="n">dst</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">policy</span><span class="p">.</span><span class="n">sandbox_dir</span><span class="p">,</span> <span class="n">dest_rel</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">basename</span><span class="p">(</span><span class="n">src</span><span class="p">)))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">dst</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="n">policy</span><span class="p">.</span><span class="n">sandbox_dir</span> <span class="o">+</span> <span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">)</span> <span class="ow">and</span> <span class="n">dst</span> <span class="o">!=</span> <span class="n">policy</span><span class="p">.</span><span class="n">sandbox_dir</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">destination must be inside sandbox</span><span class="sh">"</span><span class="p">}</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">dst</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isdir</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">dst</span><span class="p">):</span> <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">dest exists</span><span class="sh">"</span><span class="p">}</span>
        <span class="n">shutil</span><span class="p">.</span><span class="nf">copytree</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">copy_function</span><span class="o">=</span><span class="n">shutil</span><span class="p">.</span><span class="n">copy2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">shutil</span><span class="p">.</span><span class="nf">copy2</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span> <span class="n">os</span><span class="p">.</span><span class="nf">chmod</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">stat</span><span class="p">.</span><span class="n">S_IRUSR</span><span class="o">|</span><span class="n">stat</span><span class="p">.</span><span class="n">S_IWUSR</span><span class="o">|</span><span class="n">stat</span><span class="p">.</span><span class="n">S_IRGRP</span><span class="o">|</span><span class="n">stat</span><span class="p">.</span><span class="n">S_IROTH</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">sandbox_path</span><span class="sh">"</span><span class="p">:</span> <span class="n">dst</span><span class="p">}</span>
</code></pre></div></div>

<h1 id="실행-단계-예시-시퀀스">실행 단계 예시 시퀀스</h1>

<p>유지형(커널) 예시</p>

<ol>
  <li>
    <p>configure_python_exec(readwrite_dirs=["/mnt/sandbox"], readonly_dirs=["/","/usr","/home/you/data"])</p>
  </li>
  <li>
    <p>start_python_session(agent_id="analyst-1", backend="kernel", keep_alive=true)</p>
  </li>
  <li>
    <p>copy_to_sandbox("/home/you/data/df.csv", "data/df.csv")</p>
  </li>
  <li>
    <p>python_execute(session_id="sess-analyst-1", code='import pandas as pd; df=pd.read_csv("data/df.csv"); print(df.shape)')</p>
  </li>
  <li>
    <p>같은 session_id로 계속 실행</p>
  </li>
</ol>

<p>1회성(서브프로세스) 예시</p>

<ol>
  <li>
    <p>configure_python_exec(…)</p>
  </li>
  <li>
    <p>python_execute(ephemeral=true, backend="subprocess", code='open("/etc/hosts","w").write("x")') → 커널이 거부</p>
  </li>
  <li>
    <p>python_execute(ephemeral=true, backend="subprocess", code='print("ok")') → 정상</p>
  </li>
</ol>

<h1 id="설계-선택-이유와-한계">설계 선택 이유와 한계</h1>

<ul>
  <li>
    <p>Landlock은 커널이 강제하는 일방향 제약이라 한 번 적용하면 사용자 파이썬이 “해제”하진 못한다. 다만 OS가 Linux 5.13+여야 하며, ABI 기능(TRUNCATE/REFER 등)은 버전에 따라 다르다. 위 코드는 “가능하면 쓰고, 없으면 건너뛰는” 베스트에포트 방식으로 구성.</p>
  </li>
  <li>
    <p>완벽한 격리는 아니지만, 실수로 호스트를 더럽히는 경로를 효과적으로 차단한다. 추가로 audit hook과 리소스 제한(CPU/메모리/파일사이즈)을 곁들이면 80/20 목적에 충분히 실용적.</p>
  </li>
</ul>

<p>원하면 여기에 바로 붙여 쓸 수 있는 완성형 모듈(Manager + 두 백엔드 + 최소 RPC 루프)로 묶어서 드릴 수 있다.</p>

<p class="chat--user">

landlock 패키지에 PathBeneath라는 게 없대. 그리고 Config는 유저가 직접할거라 LLM으로는 노출 금지

</p>

<p>좋아. 정리부터 하고, 바로 가져다 쓸 수 있는 코드와 설계를 깔끔히 바꿔서 줄게. 핵심은 “설정(Config)은 네가 직접, LLM에겐 절대 노출하지 않음”, “세션 유지 선택 가능”, “파일 시스템은 Landlock으로 읽기/쓰기 경계”야. 그리고 네가 지적한 대로 PyPI의 landlock 패키지는 PathBeneath 클래스를 안 쓰고 Ruleset 중심의 API라서, 그에 맞춰 업데이트했어. Landlock의 원리는 커널 레벨에서 한 번 적용하면 호출 스레드와 자식에게 영구적으로 누적되는 일방향 제약이야. 사용자 공간에서 임의로 해제할 수 없도록 설계되어 있어(커널 사용자공간 API/매뉴얼에 명시, 그리고 최근 워크숍 자료에도 “한 번 켜면 끌 수 없다”는 원칙이 반복됨). <a href="https://man7.org/linux/man-pages/man7/landlock.7.html?utm_source=chatgpt.com">man7.org+2</a></p>

<p>아래는 3단계 분리 설계와 코드 스켈레톤이야.</p>

<h1 id="1-툴-config-단계호스트-전용llm-비노출">1) 툴 Config 단계(호스트 전용·LLM 비노출)</h1>

<p>Config는 네 코드에서만 실행. LLM은 모르게 유지.</p>

<p>기능</p>

<ol>
  <li>
    <p>읽기 전용 경로 목록(ro_roots), 읽기/쓰기 허용 루트(rw_root 한 개 추천)를 지정.</p>
  </li>
  <li>
    <p>Landlock을 현재 프로세스에 적용하고, 이후 새로 만드는 커널/서브프로세스에도 상속.</p>
  </li>
  <li>
    <p>세션 풀 생성(에이전트별 세션 유지용).</p>
  </li>
</ol>

<p>landlock 패키지의 공개 문서 기준으로는 Ruleset().allow(path)로 경로 하위 접근을 허용하고 apply()로 적용하는 형태야. 이 패키지는 PathBeneath를 노출하지 않고 고수준 API를 제공해. 예시에서 “기본은 전부 차단, allow로 명시한 경로만 허용” 모델이므로, 읽기 허용 루트는 모두 allow로 넣고, 쓰기가 필요한 디렉터리는 별도로 관리하는 게 안전해. 쓰기 권한의 세밀한 비트 지정은 커널은 지원하지만(예: READ_DIR/READ_FILE/WRITE/TRUNCATE 등), 이 파이썬 패키지에서 경로별 권한 비트를 직접 노출하지 않을 수 있어 버전별로 차이가 난다. 최신 PyPI 페이지를 보면 고수준 예제만 문서화돼 있으니 이 점을 전제로 코드를 짜고, 만약 네 환경에서 per-path write 허용이 필요하면 아래 “플랜 B”를 참고해. <a href="https://pypi.org/project/landlock/">PyPI</a></p>

<p>구현 스켈레톤</p>

<ul>
  <li>아래 모듈은 설정만 담당. LLM에게 이 모듈의 어떤 내용도 전달하지 마.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># sandbox_config.py  (호스트 전용, LLM 비노출)
</span><span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">shutil</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="n">landlock</span> <span class="kn">import</span> <span class="n">Ruleset</span>  <span class="c1"># PyPI 'landlock' (Edward-Knight)
</span>
<span class="k">class</span> <span class="nc">FsPolicy</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">ro_roots</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">rw_root</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">allow_world_read</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="c1"># 절대경로 정규화
</span>        <span class="n">self</span><span class="p">.</span><span class="n">ro_roots</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ro_roots</span><span class="p">]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">rw_root</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">rw_root</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">allow_world_read</span> <span class="o">=</span> <span class="n">allow_world_read</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">rw_root</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">SandboxManager</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_applied</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">self</span><span class="p">.</span><span class="n">policy</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FsPolicy</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">apply_landlock</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">policy</span><span class="p">:</span> <span class="n">FsPolicy</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_applied</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="nc">Ruleset</span><span class="p">()</span>  <span class="c1"># 기본: 전부 금지, allow로만 허용
</span>        <span class="k">if</span> <span class="n">policy</span><span class="p">.</span><span class="n">allow_world_read</span><span class="p">:</span>
            <span class="n">rs</span><span class="p">.</span><span class="nf">allow</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span>  <span class="c1"># 모든 경로 읽기 허용(“완벽한 샌드박스 불필요” 요구일 때 편의용)
</span>        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">policy</span><span class="p">.</span><span class="n">ro_roots</span><span class="p">:</span>
                <span class="n">rs</span><span class="p">.</span><span class="nf">allow</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="c1"># rw_root는 LLM에게 copy_to_sandbox 통해서만 파일을 두게 한다.
</span>        <span class="c1"># 패키지 API가 경로별 쓰기 비트를 노출하지 않는 경우가 있어,
</span>        <span class="c1"># 쓰기는 원칙적으로 차단하고, 커널이 허용하는 한에서만 rw_root 내 조작을 시도한다.
</span>        <span class="c1"># (패키지 업데이트로 per-path write 옵션이 생기면 여기서 조건부로 허용 추가)
</span>
        <span class="n">rs</span><span class="p">.</span><span class="nf">apply</span><span class="p">()</span>  <span class="c1"># 현재 스레드 및 자식 프로세스에 영구 적용
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_applied</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">self</span><span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">policy</span>

    <span class="c1"># 유틸: 신뢰할 수 있는 사전 복사기(LLM은 이 함수를 tool로만 호출)
</span>    <span class="k">def</span> <span class="nf">copy_to_sandbox</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">src</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dst_relpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">self</span><span class="p">.</span><span class="n">policy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">Sandbox not configured</span><span class="sh">"</span>
        <span class="n">src_abs</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
        <span class="c1"># 읽기 허용 경로 검증
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">policy</span><span class="p">.</span><span class="n">allow_world_read</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">src_abs</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">)</span> <span class="ow">or</span> <span class="n">src_abs</span> <span class="o">==</span> <span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">policy</span><span class="p">.</span><span class="n">ro_roots</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Source not allowed: </span><span class="si">{</span><span class="n">src_abs</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">dst_abs</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">policy</span><span class="p">.</span><span class="n">rw_root</span><span class="p">,</span> <span class="n">dst_relpath</span><span class="p">))</span>
        <span class="c1"># rw_root 밖으로 벗어나는 경로 금지
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">dst_abs</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">policy</span><span class="p">.</span><span class="n">rw_root</span> <span class="o">+</span> <span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">)</span> <span class="ow">or</span> <span class="n">dst_abs</span> <span class="o">==</span> <span class="n">self</span><span class="p">.</span><span class="n">policy</span><span class="p">.</span><span class="n">rw_root</span><span class="p">):</span>
            <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Destination escapes rw_root: </span><span class="si">{</span><span class="n">dst_abs</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">dst_abs</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">shutil</span><span class="p">.</span><span class="nf">copy2</span><span class="p">(</span><span class="n">src_abs</span><span class="p">,</span> <span class="n">dst_abs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dst_abs</span>
</code></pre></div></div>

<p>참고: Landlock은 일방향 제약이며 restrict_self 이후 해제가 불가한 특성이 공식 문서와 발표 자료에 반복해서 설명돼 있어. 이 구조 덕분에 “파이썬 코드가 룰셋을 풀어버린다” 류의 우려는 정상 커널/사용자 공간 전제에서 해당되지 않아. 단, 커널 취약점이 공개·패치되는 경우가 가끔 있으니 커널을 최신으로 유지하는 게 좋아. 기능과 권한 비트는 매뉴얼과 사용자공간 API 문서에 잘 정리돼 있어. <a href="https://man7.org/linux/man-pages/man7/landlock.7.html?utm_source=chatgpt.com">man7.org+2</a></p>

<p>플랜 B: 경로별 쓰기 비트가 꼭 필요하면</p>

<ol>
  <li>
    <p>최근 이슈로 유명한 landrun(Go CLI) 같은 얇은 래퍼를 써서 “–ro /… –rw /sandbox …” 형태로 정확히 분리할 수 있어. 컨테이너나 도커는 아님. <a href="https://github.com/Zouuup/landrun?utm_source=chatgpt.com">GitHub+2</a></p>
  </li>
  <li>
    <p>또는 아주 얇은 ctypes 래퍼로 landlock_create_ruleset/landlock_add_rule를 직접 호출해 권한 비트를 정확히 넣는 방법(WRITE/TRUNCATE/… 조합)을 쓰면 돼. 비트 목록과 의미는 커널 문서에 정리돼 있어. <a href="https://man.archlinux.org/man/landlock_add_rule.2.en?utm_source=chatgpt.com">man.archlinux.org+1</a></p>
  </li>
</ol>

<h1 id="2-툴-사용법llm에-전달할-스펙">2) 툴 사용법(LLM에 전달할 스펙)</h1>

<p>설정 정보는 한 줄도 노출하지 않는다. 아래 네 가지만 공개.</p>

<ol>
  <li>
    <p>python_exec_internal(session_id, code, timeout_sec)</p>
  </li>
  <li>
    <p>python_exec_visible(session_id, code, timeout_sec, enforce_plot_rules)</p>
  </li>
  <li>
    <p>copy_to_sandbox(src, dst_relpath)</p>
  </li>
  <li>
    <table>
      <tbody>
        <tr>
          <td>python_session_control(session_id, action=["reset"</td>
          <td>"kill"])</td>
        </tr>
      </tbody>
    </table>
  </li>
</ol>

<p>copy_to_sandbox는 내부적으로 SandboxManager.copy_to_sandbox를 호출한다. 소스는 읽기 허용 경로 내에 있어야 하고, 목적지는 rw_root 하위 상대경로만 허용한다. 이렇게 하면 LLM은 “호스트 파일에 자유 접근(읽기)”은 가능하지만 “쓰기”는 반드시 샌드박스 디렉터리로 복사한 사본만 다루게 되는 워크플로가 된다.</p>

<h1 id="3-실제-실행-단계세션-유지일회용-선택">3) 실제 실행 단계(세션 유지/일회용 선택)</h1>

<p>세션은 커널 유지형과 일회용 둘 다 지원. 기본은 유지형, 요청 시 일회용으로 실행.</p>

<p>구현 스켈레톤</p>

<ul>
  <li>아래는 너가 올려둔 jupyter_client 기반 코드를 정책 분리/에러 메세지/추가 도구 포함으로 다듬은 버전. seaborn/색상/서브플롯 금지 규칙도 그대로.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># code_tool.py  (LLM에 노출되는 엔드포인트는 여기 함수 시그니처뿐)
</span><span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">base64</span><span class="p">,</span> <span class="n">re</span><span class="p">,</span> <span class="n">shutil</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">from</span> <span class="n">jupyter_client</span> <span class="kn">import</span> <span class="n">KernelManager</span>
<span class="kn">from</span> <span class="n">sandbox_config</span> <span class="kn">import</span> <span class="n">SandboxManager</span><span class="p">,</span> <span class="n">FsPolicy</span>

<span class="c1"># 0) 초기 설정(호스트 전용)
</span><span class="n">SANDBOX</span> <span class="o">=</span> <span class="nc">SandboxManager</span><span class="p">()</span>
<span class="c1"># 예: 네 앱에서만 호출. LLM에겐 감춤.
# SANDBOX.apply_landlock(FsPolicy(
#     ro_roots=["/home/you/data", "/usr/share"],
#     rw_root="/home/you/sbx",
#     allow_world_read=False  # 느슨한 설정이 필요하면 True
# ))
</span>
<span class="c1"># 1) 세션 풀
</span><span class="k">class</span> <span class="nc">KernelSession</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">km</span> <span class="o">=</span> <span class="nc">KernelManager</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">km</span><span class="p">.</span><span class="nf">start_kernel</span><span class="p">(</span><span class="n">extra_arguments</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">--HistoryManager.enabled=False</span><span class="sh">"</span><span class="p">])</span>
        <span class="n">self</span><span class="p">.</span><span class="n">kc</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">km</span><span class="p">.</span><span class="nf">client</span><span class="p">();</span> <span class="n">self</span><span class="p">.</span><span class="n">kc</span><span class="p">.</span><span class="nf">start_channels</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">kc</span><span class="p">.</span><span class="nf">stop_channels</span><span class="p">();</span> <span class="n">self</span><span class="p">.</span><span class="n">km</span><span class="p">.</span><span class="nf">shutdown_kernel</span><span class="p">(</span><span class="n">now</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="mf">3.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">re</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">\bseaborn\b</span><span class="sh">"</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>  <span class="c1"># 정책 예
</span>            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span><span class="sh">""</span><span class="p">,</span><span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">Do not use seaborn</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">artifacts</span><span class="sh">"</span><span class="p">:[]}</span>
        <span class="n">msg_id</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">kc</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">allow_stdin</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">stop_on_error</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">();</span> <span class="n">out</span><span class="o">=</span><span class="p">[];</span> <span class="n">err</span><span class="o">=</span><span class="p">[];</span> <span class="n">arts</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span><span class="o">-</span><span class="n">t0</span> <span class="o">&gt;</span> <span class="n">timeout</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">km</span><span class="p">.</span><span class="nf">shutdown_kernel</span><span class="p">(</span><span class="n">now</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span><span class="mi">124</span><span class="p">,</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span><span class="sh">""</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">Timeout</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">artifacts</span><span class="sh">"</span><span class="p">:[]}</span>
            <span class="k">try</span><span class="p">:</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">kc</span><span class="p">.</span><span class="nf">get_iopub_msg</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="k">continue</span>
            <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="sh">"</span><span class="s">parent_header</span><span class="sh">"</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">msg_id</span><span class="sh">"</span><span class="p">)</span> <span class="o">!=</span> <span class="n">msg_id</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">typ</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="sh">"</span><span class="s">header</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">msg_type</span><span class="sh">"</span><span class="p">];</span> <span class="n">content</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stream</span><span class="sh">"</span><span class="p">:</span>
                <span class="p">(</span><span class="n">out</span> <span class="k">if</span> <span class="n">content</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">]</span><span class="o">==</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span> <span class="k">else</span> <span class="n">err</span><span class="p">).</span><span class="nf">append</span><span class="p">(</span><span class="n">content</span><span class="p">[</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">err</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">content</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">traceback</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])))</span>
            <span class="k">elif</span> <span class="n">typ</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">display_data</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">execute_result</span><span class="sh">"</span><span class="p">):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">content</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">,{})</span>
                <span class="k">if</span> <span class="sh">"</span><span class="s">image/png</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                    <span class="n">b</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">image/png</span><span class="sh">"</span><span class="p">];</span> <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="p">.</span><span class="nf">encode</span><span class="p">()</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">b</span>
                    <span class="n">fn</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">plot_</span><span class="si">{</span><span class="nf">int</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span><span class="o">*</span><span class="mi">1000</span><span class="p">)</span><span class="si">}</span><span class="s">.png</span><span class="sh">"</span>
                    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">SANDBOX</span><span class="p">.</span><span class="n">policy</span><span class="p">.</span><span class="n">rw_root</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>  <span class="c1"># 안전
</span>                    <span class="n">fp</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">SANDBOX</span><span class="p">.</span><span class="n">policy</span><span class="p">.</span><span class="n">rw_root</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>
                    <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span><span class="sh">"</span><span class="s">wb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span> <span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">base64</span><span class="p">.</span><span class="nf">b64decode</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
                    <span class="n">arts</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span><span class="n">fn</span><span class="p">,</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span><span class="n">fp</span><span class="p">,</span><span class="sh">"</span><span class="s">mime</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">image/png</span><span class="sh">"</span><span class="p">})</span>
            <span class="k">elif</span> <span class="n">typ</span><span class="o">==</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span> <span class="ow">and</span> <span class="n">content</span><span class="p">[</span><span class="sh">"</span><span class="s">execution_state</span><span class="sh">"</span><span class="p">]</span><span class="o">==</span><span class="sh">"</span><span class="s">idle</span><span class="sh">"</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span><span class="sh">""</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">out</span><span class="p">)[:</span><span class="mi">20000</span><span class="p">],</span><span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span><span class="sh">""</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">err</span><span class="p">)[:</span><span class="mi">20000</span><span class="p">],</span><span class="sh">"</span><span class="s">artifacts</span><span class="sh">"</span><span class="p">:</span><span class="n">arts</span><span class="p">}</span>

<span class="k">class</span> <span class="nc">SessionPool</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span> <span class="n">self</span><span class="p">.</span><span class="n">pool</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">KernelSession</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">sid</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">KernelSession</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">pool</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span> <span class="o">=</span> <span class="nc">KernelSession</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">sid</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span> 
        <span class="k">if</span> <span class="n">sid</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">pool</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">sid</span><span class="p">].</span><span class="nf">shutdown</span><span class="p">();</span> <span class="n">self</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span> <span class="o">=</span> <span class="nc">KernelSession</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">kill</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">sid</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">pool</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="nf">shutdown</span><span class="p">()</span>

<span class="n">POOL</span> <span class="o">=</span> <span class="nc">SessionPool</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_plot_rule_check</span><span class="p">(</span><span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">re</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">\.subplot\(</span><span class="sh">"</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span> <span class="ow">or</span> <span class="n">re</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">subplots\(</span><span class="sh">"</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
        <span class="k">return</span> <span class="sh">"</span><span class="s">Do not use subplots</span><span class="sh">"</span>
    <span class="k">if</span> <span class="n">re</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">(color\s*=|palette\s*=|style\s*=)</span><span class="sh">"</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
        <span class="k">return</span> <span class="sh">"</span><span class="s">Do not set explicit colors or styles</span><span class="sh">"</span>
    <span class="k">return</span> <span class="bp">None</span>

<span class="c1"># 2) LLM이 쓰는 툴(설정 정보 없음)
</span><span class="k">def</span> <span class="nf">python_exec_internal</span><span class="p">(</span><span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout_sec</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">sess</span> <span class="o">=</span> <span class="n">POOL</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sess</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout_sec</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">python_exec_visible</span><span class="p">(</span><span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout_sec</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">enforce_plot_rules</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">enforce_plot_rules</span><span class="p">:</span>
        <span class="n">v</span> <span class="o">=</span> <span class="nf">_plot_rule_check</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">v</span><span class="p">:</span> <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span><span class="sh">""</span><span class="p">,</span><span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span><span class="n">v</span><span class="p">,</span><span class="sh">"</span><span class="s">artifacts</span><span class="sh">"</span><span class="p">:[]}</span>
    <span class="n">sess</span> <span class="o">=</span> <span class="n">POOL</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sess</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout_sec</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">python_session_control</span><span class="p">(</span><span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="sh">"</span><span class="s">reset</span><span class="sh">"</span><span class="p">:</span> <span class="n">POOL</span><span class="p">.</span><span class="nf">reset</span><span class="p">(</span><span class="n">session_id</span><span class="p">);</span> <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">msg</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">reset</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="sh">"</span><span class="s">kill</span><span class="sh">"</span><span class="p">:</span>  <span class="n">POOL</span><span class="p">.</span><span class="nf">kill</span><span class="p">(</span><span class="n">session_id</span><span class="p">);</span>  <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">msg</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">killed</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">msg</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">unknown action</span><span class="sh">"</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">copy_to_sandbox</span><span class="p">(</span><span class="n">src</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dst_relpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">dst</span> <span class="o">=</span> <span class="n">SANDBOX</span><span class="p">.</span><span class="nf">copy_to_sandbox</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst_relpath</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">dst</span><span class="sh">"</span><span class="p">:</span> <span class="n">dst</span><span class="p">}</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
</code></pre></div></div>

<p>툴 스펙(JSON)만 LLM에 전달</p>

<ul>
  <li>네 OpenAI Agents SDK나 vLLM+GPTOSS/Qwen 파이프라인에서 아래 “툴 서명”만 노출해. 설정 경로나 정책 정보는 절대 넣지 마.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">python_exec_internal_tool</span> <span class="o">=</span> <span class="p">{</span>
  <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
  <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:{</span>
    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">python_exec_internal</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">세션 유지형 파이썬 실행(비가시).</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:{</span>
      <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
      <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{</span>
        <span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">},</span>
        <span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">},</span>
        <span class="sh">"</span><span class="s">timeout_sec</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">integer</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">minimum</span><span class="sh">"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="sh">"</span><span class="s">maximum</span><span class="sh">"</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span><span class="mi">3</span><span class="p">}</span>
      <span class="p">},</span>
      <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:[</span><span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">],</span>
      <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span><span class="bp">False</span>
    <span class="p">},</span>
    <span class="sh">"</span><span class="s">strict</span><span class="sh">"</span><span class="p">:</span><span class="bp">True</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="n">python_exec_visible_tool</span> <span class="o">=</span> <span class="p">{</span>
  <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
  <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:{</span>
    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">python_exec_visible</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">사용자 가시 실행(단일 matplotlib 플롯, 색/스타일 금지).</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:{</span>
      <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
      <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{</span>
        <span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">},</span>
        <span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">},</span>
        <span class="sh">"</span><span class="s">timeout_sec</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">integer</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">minimum</span><span class="sh">"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="sh">"</span><span class="s">maximum</span><span class="sh">"</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span><span class="mi">3</span><span class="p">},</span>
        <span class="sh">"</span><span class="s">enforce_plot_rules</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">boolean</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>
      <span class="p">},</span>
      <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:[</span><span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">],</span>
      <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span><span class="bp">False</span>
    <span class="p">},</span>
    <span class="sh">"</span><span class="s">strict</span><span class="sh">"</span><span class="p">:</span><span class="bp">True</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="n">copy_to_sandbox_tool</span> <span class="o">=</span> <span class="p">{</span>
  <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
  <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:{</span>
    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">copy_to_sandbox</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">호스트 파일을 샌드박스 쓰기 루트로 복사. 목적지는 rw_root 하위 상대경로만.</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:{</span>
      <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
      <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{</span>
        <span class="sh">"</span><span class="s">src</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">},</span>
        <span class="sh">"</span><span class="s">dst_relpath</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}</span>
      <span class="p">},</span>
      <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:[</span><span class="sh">"</span><span class="s">src</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">dst_relpath</span><span class="sh">"</span><span class="p">],</span>
      <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span><span class="bp">False</span>
    <span class="p">},</span>
    <span class="sh">"</span><span class="s">strict</span><span class="sh">"</span><span class="p">:</span><span class="bp">True</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="n">python_session_control_tool</span> <span class="o">=</span> <span class="p">{</span>
  <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
  <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:{</span>
    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">python_session_control</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">세션 재시작/종료</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:{</span>
      <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
      <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{</span>
        <span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">},</span>
        <span class="sh">"</span><span class="s">action</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">enum</span><span class="sh">"</span><span class="p">:[</span><span class="sh">"</span><span class="s">reset</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">kill</span><span class="sh">"</span><span class="p">]}</span>
      <span class="p">},</span>
      <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:[</span><span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">action</span><span class="sh">"</span><span class="p">],</span>
      <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span><span class="bp">False</span>
    <span class="p">},</span>
    <span class="sh">"</span><span class="s">strict</span><span class="sh">"</span><span class="p">:</span><span class="bp">True</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>세션 유지 vs 일회용</p>

<ul>
  <li>
    <p>유지형: session_id를 고정으로 넘기면 커널 상태가 유지된다.</p>
  </li>
  <li>
    <p>일회용: python_session_control(session_id, "kill")로 즉석 종료 후 새 session_id를 쓰면 된다. 혹은 내부적으로 “one-shot” 코드를 별도 분기해 KernelManager를 매번 생성/종료해도 된다.</p>
  </li>
</ul>

<p>안전성에 대한 메모</p>

<ul>
  <li>
    <p>Landlock은 커널 LSM이므로 사용 중 해제 불가한 일방향 제약(자식 상속 포함)이고, 경로 기반 권한 비트를 제공한다. FS 권한 비트와 설계 원리는 커널 문서의 사용자공간 API/매뉴얼에서 확인 가능하다. <a href="https://man7.org/linux/man-pages/man7/landlock.7.html?utm_source=chatgpt.com">man7.org+2</a></p>
  </li>
  <li>
    <p>PyPI ‘landlock’ 패키지는 PathBeneath를 직접 노출하지 않고 Ruleset.allow / apply를 쓰는 고수준 래퍼다. 문서 예시는 디렉터리 계층 접근 허용 예제만 제공한다. 버전에 따라 경로별 쓰기 비트를 직접 못 줄 수 있으니, 정확한 RW 분리를 원하면 landrun 같은 얇은 CLI를 함께 쓰거나(ctypes로 직접 비트 지정) 정책을 약간 느슨하게 운영하면 된다. <a href="https://pypi.org/project/landlock/">PyPI+1</a></p>
  </li>
</ul>

<p>마무리 체크리스트</p>

<ol>
  <li>
    <p>네 앱 초기화 시점에만 SANDBOX.apply_landlock(…) 호출. 이 코드는 절대 LLM 프롬프트·툴 정의에 섞지 않는다.</p>
  </li>
  <li>
    <p>LLM에는 네 개 툴 시그니처만 노출.</p>
  </li>
  <li>
    <p>쓰기가 필요한 파일은 무조건 copy_to_sandbox로 rw_root에 사본을 둔 뒤 그 경로만 쓰도록 유도.</p>
  </li>
  <li>
    <p>세션 유지가 필요하면 session_id를 고정하고, 필요 없으면 kill→새로 생성.</p>
  </li>
</ol>

<p>원하는 방향으로 더 촘촘한 RW 비트 제어가 필요한 순간이 오면 두 가지 루트가 있어. 첫째, landrun을 커널 앞단 래퍼로 덮어씌우기(도커 아님). 둘째, 작은 ctypes 뼈대에 커널 매뉴얼의 LANDLOCK_ACCESS_FS_* 비트를 그대로 넣는 저수준 바인딩. 어느 쪽이든 연결해 줄 수 있어.</p>

<p class="chat--user">

좀 이상해. rw 컨트롤은 어디서해

</p>

<p>핵심만 콕 집어 말할게. RW 컨트롤은 “툴 레이어”가 아니라 “세션 프로세스가 뜨는 순간 커널에 Landlock 룰을 올리는 곳”에서 한다. 즉,</p>

<p>1단계(네가 직접 하는 Config): 읽기 전용 디렉터리(ro_dirs)와 읽기/쓰기 디렉터리(rw_dir)를 정한다.<br />
2단계(세션 부팅 시점): 해당 세션 프로세스 안에서 landlock_create_ruleset → landlock_add_rule(각 경로에 권한 마스크 지정) → landlock_restrict_self를 호출한다. 이때 ro_dirs에는 읽기 마스크, rw_dir에는 읽기+쓰기 마스크를 준다.<br />
3단계(실행 중): LLM은 copy_to_sandbox로 파일을 rw_dir 아래에 들여와서만 저장·수정하게 하고, 샌드박스 밖 쓰기 시도는 커널이 거부한다.</p>

<p>아래는 실제로 “어디서 어떻게 RW를 강제하는지”가 드러나는 최소 헬퍼다. PyPI의 고수준 landlock 래퍼가 per-path 권한 비트를 안 열어줄 때를 대비해 ctypes로 커널 UAPI를 직접 호출한다. x86_64의 기본 syscall 번호를 쓰되, liblandlock.so가 있으면 그걸 우선 사용한다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># landlock_helper.py
</span><span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">.</span><span class="n">util</span>

<span class="c1"># x86_64 기본값. 다른 아키텍처면 번호가 다를 수 있다.
</span><span class="n">__NR_landlock_create_ruleset</span> <span class="o">=</span> <span class="mi">444</span>
<span class="n">__NR_landlock_add_rule</span>       <span class="o">=</span> <span class="mi">445</span>
<span class="n">__NR_landlock_restrict_self</span>  <span class="o">=</span> <span class="mi">446</span>

<span class="c1"># 커널 UAPI 비트 (없는 비트는 0으로 처리)
</span><span class="k">class</span> <span class="nc">Access</span><span class="p">:</span>
    <span class="n">READ_FILE</span>   <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span>
    <span class="n">WRITE_FILE</span>  <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span>
    <span class="n">READ_DIR</span>    <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span>
    <span class="n">REMOVE_DIR</span>  <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span>
    <span class="n">REMOVE_FILE</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span>
    <span class="n">MAKE_CHAR</span>   <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span>
    <span class="n">MAKE_DIR</span>    <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span>
    <span class="n">MAKE_REG</span>    <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span>
    <span class="n">MAKE_SOCK</span>   <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span>
    <span class="n">MAKE_FIFO</span>   <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span>
    <span class="n">MAKE_BLOCK</span>  <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span>
    <span class="n">MAKE_SYM</span>    <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span>
    <span class="c1"># ABI v2+
</span>    <span class="n">REFER</span>       <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span>
    <span class="c1"># ABI v3+
</span>    <span class="n">TRUNCATE</span>    <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span>
    <span class="n">EXECUTE</span>     <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span>  <span class="c1"># 있으면 사용
</span>
<span class="c1"># struct landlock_path_beneath_attr
</span><span class="k">class</span> <span class="nc">path_beneath_attr</span><span class="p">(</span><span class="n">ctypes</span><span class="p">.</span><span class="n">Structure</span><span class="p">):</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">allowed_access</span><span class="sh">"</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">.</span><span class="n">c_uint64</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">parent_fd</span><span class="sh">"</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">.</span><span class="n">c_int</span><span class="p">),</span>
    <span class="p">]</span>

<span class="n">libc</span> <span class="o">=</span> <span class="n">ctypes</span><span class="p">.</span><span class="nc">CDLL</span><span class="p">(</span><span class="n">ctypes</span><span class="p">.</span><span class="n">util</span><span class="p">.</span><span class="nf">find_library</span><span class="p">(</span><span class="sh">"</span><span class="s">c</span><span class="sh">"</span><span class="p">),</span> <span class="n">use_errno</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_syscall</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">libc</span><span class="p">.</span><span class="nf">syscall</span><span class="p">(</span><span class="n">ctypes</span><span class="p">.</span><span class="nf">c_long</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">ctypes</span><span class="p">.</span><span class="nf">get_errno</span><span class="p">()</span>
        <span class="k">raise</span> <span class="nc">OSError</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="nf">strerror</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">r</span>

<span class="k">def</span> <span class="nf">_best_effort_mask</span><span class="p">(</span><span class="o">*</span><span class="n">names</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">|=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">Access</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">m</span>

<span class="k">def</span> <span class="nf">_open_ro_dir</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">O_PATH</span> <span class="o">|</span> <span class="n">os</span><span class="p">.</span><span class="n">O_CLOEXEC</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">apply_landlock_rw</span><span class="p">(</span><span class="n">ro_dirs</span><span class="p">,</span> <span class="n">rw_dir</span><span class="p">):</span>
    <span class="c1"># 1) 어떤 FS 권한을 다룰지 커널에 알리기(handled_access_fs)
</span>    <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="sh">"</span><span class="s">READ_FILE</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">WRITE_FILE</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">READ_DIR</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">REMOVE_DIR</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">REMOVE_FILE</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">MAKE_CHAR</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">MAKE_DIR</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">MAKE_REG</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">MAKE_SOCK</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">MAKE_FIFO</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">MAKE_BLOCK</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">MAKE_SYM</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">REFER</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">TRUNCATE</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">EXECUTE</span><span class="sh">"</span>
    <span class="p">]:</span>
        <span class="n">handled</span> <span class="o">|=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">Access</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># landlock_create_ruleset(attr=NULL, size=0, flags=0)로 ABI 쿼리할 수도 있지만,
</span>    <span class="c1"># 여기선 간단화: 바로 ruleset 생성 (size=8바이트 마스크 전송)
</span>    <span class="k">class</span> <span class="nc">ruleset_attr</span><span class="p">(</span><span class="n">ctypes</span><span class="p">.</span><span class="n">Structure</span><span class="p">):</span>
        <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[(</span><span class="sh">"</span><span class="s">handled_access_fs</span><span class="sh">"</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">.</span><span class="n">c_uint64</span><span class="p">)]</span>
    <span class="n">attr</span> <span class="o">=</span> <span class="nf">ruleset_attr</span><span class="p">(</span><span class="n">handled_access_fs</span><span class="o">=</span><span class="n">handled</span><span class="p">)</span>
    <span class="n">ruleset_fd</span> <span class="o">=</span> <span class="nf">_syscall</span><span class="p">(</span><span class="n">__NR_landlock_create_ruleset</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">.</span><span class="nf">byref</span><span class="p">(</span><span class="n">attr</span><span class="p">),</span> <span class="n">ctypes</span><span class="p">.</span><span class="nf">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># 2) 읽기 전용 마스크와 읽기/쓰기 마스크 구성
</span>    <span class="n">read_mask</span>  <span class="o">=</span> <span class="nf">_best_effort_mask</span><span class="p">(</span><span class="sh">"</span><span class="s">READ_FILE</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">READ_DIR</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">EXECUTE</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">write_mask</span> <span class="o">=</span> <span class="nf">_best_effort_mask</span><span class="p">(</span>
        <span class="sh">"</span><span class="s">READ_DIR</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">READ_FILE</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">WRITE_FILE</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">MAKE_DIR</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">MAKE_REG</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">REMOVE_FILE</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">REMOVE_DIR</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">REFER</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">TRUNCATE</span><span class="sh">"</span>
    <span class="p">)</span>

    <span class="c1"># 3) ro_dirs에 읽기 규칙 추가
</span>    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">ro_dirs</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isdir</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="nf">_open_ro_dir</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">attr_pb</span> <span class="o">=</span> <span class="nf">path_beneath_attr</span><span class="p">(</span><span class="n">allowed_access</span><span class="o">=</span><span class="n">read_mask</span><span class="p">,</span> <span class="n">parent_fd</span><span class="o">=</span><span class="n">fd</span><span class="p">)</span>
            <span class="nf">_syscall</span><span class="p">(</span><span class="n">__NR_landlock_add_rule</span><span class="p">,</span> <span class="n">ruleset_fd</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">.</span><span class="nf">byref</span><span class="p">(</span><span class="n">attr_pb</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># 1 = LANDLOCK_RULE_PATH_BENEATH
</span>        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="p">.</span><span class="nf">close</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>

    <span class="c1"># 4) rw_dir에 읽기+쓰기 규칙 추가
</span>    <span class="n">rw_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">rw_dir</span><span class="p">)</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">rw_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">fd</span> <span class="o">=</span> <span class="nf">_open_ro_dir</span><span class="p">(</span><span class="n">rw_dir</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">attr_pb</span> <span class="o">=</span> <span class="nf">path_beneath_attr</span><span class="p">(</span><span class="n">allowed_access</span><span class="o">=</span><span class="n">write_mask</span><span class="p">,</span> <span class="n">parent_fd</span><span class="o">=</span><span class="n">fd</span><span class="p">)</span>
        <span class="nf">_syscall</span><span class="p">(</span><span class="n">__NR_landlock_add_rule</span><span class="p">,</span> <span class="n">ruleset_fd</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">.</span><span class="nf">byref</span><span class="p">(</span><span class="n">attr_pb</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">close</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>

    <span class="c1"># 5) 현재 스레드에 규칙 적용(자식 프로세스에 상속됨)
</span>    <span class="nf">_syscall</span><span class="p">(</span><span class="n">__NR_landlock_restrict_self</span><span class="p">,</span> <span class="n">ruleset_fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">close</span><span class="p">(</span><span class="n">ruleset_fd</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">True</span>
</code></pre></div></div>

<p>이제 RW 컨트롤이 “정확히 어디서” 이뤄지는지 보이게 연결하면 끝이다.</p>

<ol>
  <li>
    <p>네가 직접 Config할 때<br />
ro_dirs와 rw_dir를 정하고, 세션 프로세스를 띄우기 직전 또는 세션 프로세스 내부 초기화에서 apply_landlock_rw(ro_dirs, rw_dir)를 호출한다. 여기서 ro_dirs에는 read_mask, rw_dir에는 write_mask를 커널에 등록한다. 이 지점이 RW 컨트롤의 본진이다.</p>
  </li>
  <li>
    <p>세션 유지 구조에 붙일 때<br />
KernelBackend라면 커널 기동 직후 첫 셀에서 아래 한 줄을 주입하거나, 아예 커널 프로세스의 entrypoint에서 호출한다.</p>
  </li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 커널 첫 셀
</span><span class="kn">import</span> <span class="n">os</span>
<span class="kn">from</span> <span class="n">landlock_helper</span> <span class="kn">import</span> <span class="n">apply_landlock_rw</span>
<span class="nf">apply_landlock_rw</span><span class="p">(</span>
    <span class="n">ro_dirs</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="sh">"</span><span class="s">RO_DIRS</span><span class="sh">"</span><span class="p">].</span><span class="nf">split</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">pathsep</span><span class="p">),</span>
    <span class="n">rw_dir</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="sh">"</span><span class="s">RW_DIR</span><span class="sh">"</span><span class="p">]</span>
<span class="p">)</span>
</code></pre></div></div>

<p>SubprocessBackend라면 자식 프로세스가 부팅되자마자 같은 함수를 호출한 뒤 코드 실행 루프에 진입한다.</p>

<ol>
  <li>툴 레이어에서의 역할 정리<br />
툴은 RW를 “결정”하지 않는다. 툴은 그저 copy_to_sandbox로 파일을 rw_dir 아래로 옮기고, python_execute로 실행할 뿐이다. RW 정책은 위의 apply_landlock_rw가 커널에 고정시킨다. 따라서 temp.py가 rw_dir 밖을 쓰려 하면 커널이 EACCES로 거부한다. 읽기는 ro_dirs에서만 허용된다. allow_world_read 같은 편의 옵션을 쓰면 읽기 범위를 넓힐 수 있지만, 쓰기 권한은 여전히 rw_dir로만 묶인다.</li>
</ol>

<p>정리하면, RW 컨트롤은 landlock_helper.apply_landlock_rw 안의 두 군데에서 동시에 걸린다. ro_dirs에 read_mask 규칙을 추가하는 부분, rw_dir에 write_mask 규칙을 추가하는 부분. 툴은 그 정책을 존중할 뿐이고, LLM에게는 이 설정을 절대 노출하지 않는다.</p>

<p class="chat--user">

def apply_landlock(self, policy: FsPolicy): if self._applied: return rs = Ruleset() # 기본: 전부 금지, allow로만 허용 if policy.allow_world_read: rs.allow("/") # 모든 경로 읽기 허용(“완벽한 샌드박스 불필요” 요구일 때 편의용) else: for p in policy.ro_roots: rs.allow(p) # rw_root는 LLM에게 copy_to_sandbox 통해서만 파일을 두게 한다. # 패키지 API가 경로별 쓰기 비트를 노출하지 않는 경우가 있어, # 쓰기는 원칙적으로 차단하고, 커널이 허용하는 한에서만 rw_root 내 조작을 시도한다. # (패키지 업데이트로 per-path write 옵션이 생기면 여기서 조건부로 허용 추가) rs.apply() # 현재 스레드 및 자식 프로세스에 영구 적용 self._applied = True self.policy = policy 이 코드에서 rw policy를 적용해야하는거 아니야?

</p>

<p>맞아. 그 코드 그대로면 rw_root에 “쓰기 허용”이 전혀 적용되지 않아. Ruleset().allow()만 쓰면 경로 허용 여부 정도만 다루고, 경로별 권한 비트(READ/WRITE/TRUNCATE 등)를 지정하지 못해 쓰기 정책을 커널에 못 박지 못해. 그래서 이 지점에서 RW 마스크를 커널에 정확히 등록해야 한다.</p>

<p>실제로 RW 정책을 적용하는 방법은 두 가지다.</p>

<ol>
  <li>
    <p>정확모드(권장): 커널 UAPI를 ctypes로 직접 호출해서 ro_dirs에는 읽기 마스크, rw_dir에는 읽기+쓰기 마스크를 넣는다.</p>
  </li>
  <li>
    <p>임시 대안: high-level 래퍼만으로는 per-path write 비트를 못 주니, rw 컨트롤을 커널이 아닌 툴 레이어(몽키패치/audit hook)에서 “소프트”로 막는다. 이건 의도하신 “도커 없이도 꽤 안전”에 못 미친다.</p>
  </li>
</ol>

<p>아래는 1) 정확모드로, 네 메서드에 딱 들어갈 패치다.</p>

<p>간단 헬퍼(한 파일로 두고 import 해서 쓰면 됨)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># landlock_helper.py
</span><span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">.</span><span class="n">util</span>

<span class="n">__NR_landlock_create_ruleset</span> <span class="o">=</span> <span class="mi">444</span>
<span class="n">__NR_landlock_add_rule</span>       <span class="o">=</span> <span class="mi">445</span>
<span class="n">__NR_landlock_restrict_self</span>  <span class="o">=</span> <span class="mi">446</span>

<span class="k">class</span> <span class="nc">Access</span><span class="p">:</span>
    <span class="n">READ_FILE</span>   <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span>
    <span class="n">WRITE_FILE</span>  <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span>
    <span class="n">READ_DIR</span>    <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span>
    <span class="n">REMOVE_DIR</span>  <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span>
    <span class="n">REMOVE_FILE</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span>
    <span class="n">MAKE_CHAR</span>   <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span>
    <span class="n">MAKE_DIR</span>    <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span>
    <span class="n">MAKE_REG</span>    <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span>
    <span class="n">MAKE_SOCK</span>   <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span>
    <span class="n">MAKE_FIFO</span>   <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span>
    <span class="n">MAKE_BLOCK</span>  <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span>
    <span class="n">MAKE_SYM</span>    <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span>
    <span class="n">EXECUTE</span>     <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span>     <span class="c1"># 있으면 사용
</span>    <span class="n">REFER</span>       <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span>     <span class="c1"># ABI v2+
</span>    <span class="n">TRUNCATE</span>    <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span>     <span class="c1"># ABI v3+
</span>
<span class="k">class</span> <span class="nc">path_beneath_attr</span><span class="p">(</span><span class="n">ctypes</span><span class="p">.</span><span class="n">Structure</span><span class="p">):</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[(</span><span class="sh">"</span><span class="s">allowed_access</span><span class="sh">"</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">.</span><span class="n">c_uint64</span><span class="p">),</span> <span class="p">(</span><span class="sh">"</span><span class="s">parent_fd</span><span class="sh">"</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">.</span><span class="n">c_int</span><span class="p">)]</span>

<span class="n">libc</span> <span class="o">=</span> <span class="n">ctypes</span><span class="p">.</span><span class="nc">CDLL</span><span class="p">(</span><span class="n">ctypes</span><span class="p">.</span><span class="n">util</span><span class="p">.</span><span class="nf">find_library</span><span class="p">(</span><span class="sh">"</span><span class="s">c</span><span class="sh">"</span><span class="p">),</span> <span class="n">use_errno</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_syscall</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">libc</span><span class="p">.</span><span class="nf">syscall</span><span class="p">(</span><span class="n">ctypes</span><span class="p">.</span><span class="nf">c_long</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">ctypes</span><span class="p">.</span><span class="nf">get_errno</span><span class="p">()</span>
        <span class="k">raise</span> <span class="nc">OSError</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="nf">strerror</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">r</span>

<span class="k">def</span> <span class="nf">_mask</span><span class="p">(</span><span class="o">*</span><span class="n">names</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">|=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">Access</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">m</span>

<span class="k">def</span> <span class="nf">_open_path_only</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">O_PATH</span> <span class="o">|</span> <span class="n">os</span><span class="p">.</span><span class="n">O_CLOEXEC</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">apply_landlock_rw</span><span class="p">(</span><span class="n">ro_dirs</span><span class="p">,</span> <span class="n">rw_dir</span><span class="p">):</span>
    <span class="c1"># 1) ruleset 생성: 어떤 FS 권한을 다룰지 커널에 통보
</span>    <span class="n">handled</span> <span class="o">=</span> <span class="nf">_mask</span><span class="p">(</span>
        <span class="sh">"</span><span class="s">READ_FILE</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">WRITE_FILE</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">READ_DIR</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">REMOVE_DIR</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">REMOVE_FILE</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">MAKE_CHAR</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">MAKE_DIR</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">MAKE_REG</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">MAKE_SOCK</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">MAKE_FIFO</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">MAKE_BLOCK</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">MAKE_SYM</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">EXECUTE</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">REFER</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">TRUNCATE</span><span class="sh">"</span>
    <span class="p">)</span>
    <span class="k">class</span> <span class="nc">ruleset_attr</span><span class="p">(</span><span class="n">ctypes</span><span class="p">.</span><span class="n">Structure</span><span class="p">):</span>
        <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[(</span><span class="sh">"</span><span class="s">handled_access_fs</span><span class="sh">"</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">.</span><span class="n">c_uint64</span><span class="p">)]</span>
    <span class="n">rs_attr</span> <span class="o">=</span> <span class="nf">ruleset_attr</span><span class="p">(</span><span class="n">handled_access_fs</span><span class="o">=</span><span class="n">handled</span><span class="p">)</span>
    <span class="n">rs_fd</span> <span class="o">=</span> <span class="nf">_syscall</span><span class="p">(</span><span class="n">__NR_landlock_create_ruleset</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">.</span><span class="nf">byref</span><span class="p">(</span><span class="n">rs_attr</span><span class="p">),</span> <span class="n">ctypes</span><span class="p">.</span><span class="nf">sizeof</span><span class="p">(</span><span class="n">rs_attr</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># 2) 읽기와 쓰기 마스크
</span>    <span class="n">read_mask</span>  <span class="o">=</span> <span class="nf">_mask</span><span class="p">(</span><span class="sh">"</span><span class="s">READ_FILE</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">READ_DIR</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">EXECUTE</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">write_mask</span> <span class="o">=</span> <span class="nf">_mask</span><span class="p">(</span><span class="sh">"</span><span class="s">READ_FILE</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">READ_DIR</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">WRITE_FILE</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">MAKE_DIR</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">MAKE_REG</span><span class="sh">"</span><span class="p">,</span>
                       <span class="sh">"</span><span class="s">REMOVE_FILE</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">REMOVE_DIR</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">REFER</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">TRUNCATE</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># 3) 읽기 전용 경로들
</span>    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ro_dirs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isdir</span><span class="p">(</span><span class="n">d</span><span class="p">):</span> 
            <span class="k">continue</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="nf">_open_path_only</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nf">_syscall</span><span class="p">(</span><span class="n">__NR_landlock_add_rule</span><span class="p">,</span> <span class="n">rs_fd</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nf">path_beneath_attr</span><span class="p">(</span><span class="n">read_mask</span><span class="p">,</span> <span class="n">fd</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># 1 = PATH_BENEATH
</span>        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="p">.</span><span class="nf">close</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>

    <span class="c1"># 4) 쓰기 허용 루트
</span>    <span class="n">rw_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">rw_dir</span><span class="p">)</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">rw_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">fd</span> <span class="o">=</span> <span class="nf">_open_path_only</span><span class="p">(</span><span class="n">rw_dir</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nf">_syscall</span><span class="p">(</span><span class="n">__NR_landlock_add_rule</span><span class="p">,</span> <span class="n">rs_fd</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nf">path_beneath_attr</span><span class="p">(</span><span class="n">write_mask</span><span class="p">,</span> <span class="n">fd</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">close</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>

    <span class="c1"># 5) 현재 스레드에 적용(자식 상속)
</span>    <span class="nf">_syscall</span><span class="p">(</span><span class="n">__NR_landlock_restrict_self</span><span class="p">,</span> <span class="n">rs_fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">close</span><span class="p">(</span><span class="n">rs_fd</span><span class="p">)</span>
</code></pre></div></div>

<p>네 기존 메서드 교체본</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># sandbox_config.py
</span><span class="kn">from</span> <span class="n">landlock_helper</span> <span class="kn">import</span> <span class="n">apply_landlock_rw</span>

<span class="k">def</span> <span class="nf">apply_landlock</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">policy</span><span class="p">:</span> <span class="n">FsPolicy</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_applied</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="c1"># ro_roots, rw_root를 커널에 정확히 등록
</span>    <span class="nf">apply_landlock_rw</span><span class="p">(</span><span class="n">policy</span><span class="p">.</span><span class="n">ro_roots</span><span class="p">,</span> <span class="n">policy</span><span class="p">.</span><span class="n">rw_root</span><span class="p">)</span>
    <span class="n">self</span><span class="p">.</span><span class="n">_applied</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">self</span><span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">policy</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">rw_root</span><span class="sh">"</span><span class="p">:</span> <span class="n">policy</span><span class="p">.</span><span class="n">rw_root</span><span class="p">,</span> <span class="sh">"</span><span class="s">ro_roots</span><span class="sh">"</span><span class="p">:</span> <span class="n">policy</span><span class="p">.</span><span class="n">ro_roots</span><span class="p">}</span>
</code></pre></div></div>

<p>이 변경으로 “RW 컨트롤을 정확히 어디서 하느냐”가 분명해진다.</p>

<ul>
  <li>
    <p>ro_roots에는 읽기 전용 비트만, rw_root에는 읽기+쓰기 비트를 커널에 고정한다.</p>
  </li>
  <li>
    <p>이후 temp.py가 rw_root 밖에 쓰려 하면 커널이 EACCES로 거부하고, ro_roots 밖의 경로는 아예 읽기도 거부된다(너가 ro_roots를 얼마나 넓게 잡느냐에 따라 다름).</p>
  </li>
  <li>
    <p>ro_roots와 rw_root가 겹칠 수 있는데, Landlock은 허용 비트를 합집합으로 보므로 rw_root 하위에선 쓰기가 열리고, 그 밖에선 닫힌다. 운영상 문제 없다.</p>
  </li>
</ul>

<p>간단 동작 확인</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 설정 단계(LLM 비노출)
</span><span class="n">cfg</span> <span class="o">=</span> <span class="nc">FsPolicy</span><span class="p">(</span><span class="n">ro_roots</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">/usr</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">/home/you/data</span><span class="sh">"</span><span class="p">],</span> <span class="n">rw_root</span><span class="o">=</span><span class="sh">"</span><span class="s">/home/you/sbx</span><span class="sh">"</span><span class="p">)</span>
<span class="n">SANDBOX</span><span class="p">.</span><span class="nf">apply_landlock</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>

<span class="c1"># 테스트
</span><span class="nf">open</span><span class="p">(</span><span class="sh">"</span><span class="s">/etc/hosts</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">).</span><span class="nf">write</span><span class="p">(</span><span class="sh">"</span><span class="s">x</span><span class="sh">"</span><span class="p">)</span>           <span class="c1"># → PermissionError (쓰기 거부)
</span><span class="nf">open</span><span class="p">(</span><span class="sh">"</span><span class="s">/home/you/data/df.csv</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">).</span><span class="nf">read</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>  <span class="c1"># → OK (읽기 허용)
</span><span class="nf">open</span><span class="p">(</span><span class="sh">"</span><span class="s">/home/you/sbx/out.txt</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">).</span><span class="nf">write</span><span class="p">(</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">)</span>  <span class="c1"># → OK (rw_root 쓰기 허용)
</span></code></pre></div></div>

<p>만약 환경 제약으로 위 syscall 방식이 불가하거나 커널 ABI가 낮으면, apply_landlock에서 예외를 받아 “소프트 가드로 폴백”하도록 분기하면 된다. 그래도 질문의 요지였던 “이 코드에서 rw policy를 적용해야 하는가?”에 답하자면, 그렇다. 바로 이 apply_landlock에서 커널에 rw_root용 쓰기 권한 마스크를 명시적으로 추가해야 한다.</p>

<p class="chat--user">

아 점점 쓸데 없이 복잡해지는 것 같은데; 정신 차리고 제대로 해보자. 일단 /user/abc 는 읽기 가능 /user/abc/test 안에는 쓰기 가능한 landlock을 하는 가장 간단한 코드 줘봐. 테스트 라인 포함해서 

</p>

<p>원하는 딱 그거. 리눅스 5.13+ (x86_64 가정)에서 <code class="language-plaintext highlighter-rouge">/user/abc</code>는 읽기만, <code class="language-plaintext highlighter-rouge">/user/abc/test</code>는 쓰기까지 허용하는 가장 단순한 파이썬 스크립트다. 테스트까지 포함했다. 외부 라이브러리 불필요, ctypes로 커널 UAPI 직접 호출한다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span><span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">.</span><span class="n">util</span>

<span class="c1"># x86_64용 landlock syscall 번호
</span><span class="n">__NR_landlock_create_ruleset</span> <span class="o">=</span> <span class="mi">444</span>
<span class="n">__NR_landlock_add_rule</span>       <span class="o">=</span> <span class="mi">445</span>
<span class="n">__NR_landlock_restrict_self</span>  <span class="o">=</span> <span class="mi">446</span>

<span class="c1"># 권한 비트 (커널 uapi/linux/landlock.h)
</span><span class="k">class</span> <span class="nc">FS</span><span class="p">:</span>
    <span class="n">EXECUTE</span>     <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span>
    <span class="n">WRITE_FILE</span>  <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span>
    <span class="n">READ_FILE</span>   <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span>
    <span class="n">READ_DIR</span>    <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span>
    <span class="n">REMOVE_DIR</span>  <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span>
    <span class="n">REMOVE_FILE</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span>
    <span class="n">MAKE_CHAR</span>   <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span>
    <span class="n">MAKE_DIR</span>    <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span>
    <span class="n">MAKE_REG</span>    <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span>
    <span class="n">MAKE_SOCK</span>   <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span>
    <span class="n">MAKE_FIFO</span>   <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span>
    <span class="n">MAKE_BLOCK</span>  <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span>
    <span class="n">MAKE_SYM</span>    <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span>
    <span class="n">REFER</span>       <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span>   <span class="c1"># ABI v2+
</span>    <span class="n">TRUNCATE</span>    <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span>   <span class="c1"># ABI v3+
</span>
<span class="n">LANDLOCK_RULE_PATH_BENEATH</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">libc</span> <span class="o">=</span> <span class="n">ctypes</span><span class="p">.</span><span class="nc">CDLL</span><span class="p">(</span><span class="n">ctypes</span><span class="p">.</span><span class="n">util</span><span class="p">.</span><span class="nf">find_library</span><span class="p">(</span><span class="sh">"</span><span class="s">c</span><span class="sh">"</span><span class="p">),</span> <span class="n">use_errno</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_syscall</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">libc</span><span class="p">.</span><span class="nf">syscall</span><span class="p">(</span><span class="n">ctypes</span><span class="p">.</span><span class="nf">c_long</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">ctypes</span><span class="p">.</span><span class="nf">get_errno</span><span class="p">()</span>
        <span class="k">raise</span> <span class="nc">OSError</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="nf">strerror</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">r</span>

<span class="k">class</span> <span class="nc">ruleset_attr</span><span class="p">(</span><span class="n">ctypes</span><span class="p">.</span><span class="n">Structure</span><span class="p">):</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[(</span><span class="sh">"</span><span class="s">handled_access_fs</span><span class="sh">"</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">.</span><span class="n">c_uint64</span><span class="p">)]</span>

<span class="k">class</span> <span class="nc">path_beneath_attr</span><span class="p">(</span><span class="n">ctypes</span><span class="p">.</span><span class="n">Structure</span><span class="p">):</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">allowed_access</span><span class="sh">"</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">.</span><span class="n">c_uint64</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">parent_fd</span><span class="sh">"</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">.</span><span class="n">c_int</span><span class="p">),</span>
    <span class="p">]</span>

<span class="k">def</span> <span class="nf">_open_dir_path_only</span><span class="p">(</span><span class="n">p</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">O_PATH</span> <span class="o">|</span> <span class="n">os</span><span class="p">.</span><span class="n">O_CLOEXEC</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_try_create_ruleset</span><span class="p">(</span><span class="n">handled_mask</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">attr</span> <span class="o">=</span> <span class="nf">ruleset_attr</span><span class="p">(</span><span class="n">handled_access_fs</span><span class="o">=</span><span class="n">handled_mask</span><span class="p">)</span>
    <span class="k">return</span> <span class="nf">_syscall</span><span class="p">(</span><span class="n">__NR_landlock_create_ruleset</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">.</span><span class="nf">byref</span><span class="p">(</span><span class="n">attr</span><span class="p">),</span> <span class="n">ctypes</span><span class="p">.</span><span class="nf">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">apply_landlock_read_ro_write_rw</span><span class="p">(</span><span class="n">ro_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">rw_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">ro_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">ro_dir</span><span class="p">)</span>
    <span class="n">rw_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">rw_dir</span><span class="p">)</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">rw_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c1"># 가능한 최대 비트로 시도 → 안 되면 v3(=TRUNCATE) 제외 → 그래도 안 되면 REFER도 제외
</span>    <span class="n">handled_all</span> <span class="o">=</span> <span class="p">(</span><span class="n">FS</span><span class="p">.</span><span class="n">EXECUTE</span> <span class="o">|</span> <span class="n">FS</span><span class="p">.</span><span class="n">WRITE_FILE</span> <span class="o">|</span> <span class="n">FS</span><span class="p">.</span><span class="n">READ_FILE</span> <span class="o">|</span> <span class="n">FS</span><span class="p">.</span><span class="n">READ_DIR</span> <span class="o">|</span>
                   <span class="n">FS</span><span class="p">.</span><span class="n">REMOVE_DIR</span> <span class="o">|</span> <span class="n">FS</span><span class="p">.</span><span class="n">REMOVE_FILE</span> <span class="o">|</span>
                   <span class="n">FS</span><span class="p">.</span><span class="n">MAKE_CHAR</span> <span class="o">|</span> <span class="n">FS</span><span class="p">.</span><span class="n">MAKE_DIR</span> <span class="o">|</span> <span class="n">FS</span><span class="p">.</span><span class="n">MAKE_REG</span> <span class="o">|</span> <span class="n">FS</span><span class="p">.</span><span class="n">MAKE_SOCK</span> <span class="o">|</span>
                   <span class="n">FS</span><span class="p">.</span><span class="n">MAKE_FIFO</span> <span class="o">|</span> <span class="n">FS</span><span class="p">.</span><span class="n">MAKE_BLOCK</span> <span class="o">|</span> <span class="n">FS</span><span class="p">.</span><span class="n">MAKE_SYM</span> <span class="o">|</span>
                   <span class="n">FS</span><span class="p">.</span><span class="n">REFER</span> <span class="o">|</span> <span class="n">FS</span><span class="p">.</span><span class="n">TRUNCATE</span><span class="p">)</span>
    <span class="n">masks</span> <span class="o">=</span> <span class="p">[</span><span class="n">handled_all</span><span class="p">,</span>
             <span class="n">handled_all</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">FS</span><span class="p">.</span><span class="n">TRUNCATE</span><span class="p">,</span>
             <span class="n">handled_all</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">FS</span><span class="p">.</span><span class="n">TRUNCATE</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">FS</span><span class="p">.</span><span class="n">REFER</span><span class="p">]</span>
    <span class="n">rs_fd</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">last_err</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">masks</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rs_fd</span> <span class="o">=</span> <span class="nf">_try_create_ruleset</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
            <span class="k">break</span>
        <span class="k">except</span> <span class="nb">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">last_err</span> <span class="o">=</span> <span class="n">e</span>
    <span class="k">if</span> <span class="n">rs_fd</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">last_err</span> <span class="ow">or</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">landlock_create_ruleset failed</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">read_mask</span>  <span class="o">=</span> <span class="p">(</span><span class="n">FS</span><span class="p">.</span><span class="n">READ_FILE</span> <span class="o">|</span> <span class="n">FS</span><span class="p">.</span><span class="n">READ_DIR</span> <span class="o">|</span> <span class="n">FS</span><span class="p">.</span><span class="n">EXECUTE</span><span class="p">)</span>
    <span class="n">write_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">FS</span><span class="p">.</span><span class="n">READ_FILE</span> <span class="o">|</span> <span class="n">FS</span><span class="p">.</span><span class="n">READ_DIR</span> <span class="o">|</span> <span class="n">FS</span><span class="p">.</span><span class="n">WRITE_FILE</span> <span class="o">|</span>
                  <span class="n">FS</span><span class="p">.</span><span class="n">MAKE_DIR</span> <span class="o">|</span> <span class="n">FS</span><span class="p">.</span><span class="n">MAKE_REG</span> <span class="o">|</span> <span class="n">FS</span><span class="p">.</span><span class="n">REMOVE_FILE</span> <span class="o">|</span> <span class="n">FS</span><span class="p">.</span><span class="n">REMOVE_DIR</span> <span class="o">|</span>
                  <span class="p">(</span><span class="n">FS</span><span class="p">.</span><span class="n">REFER</span> <span class="nf">if </span><span class="p">(</span><span class="n">handled_all</span> <span class="o">&amp;</span> <span class="n">FS</span><span class="p">.</span><span class="n">REFER</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
                  <span class="p">(</span><span class="n">FS</span><span class="p">.</span><span class="n">TRUNCATE</span> <span class="nf">if </span><span class="p">(</span><span class="n">handled_all</span> <span class="o">&amp;</span> <span class="n">FS</span><span class="p">.</span><span class="n">TRUNCATE</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span><span class="p">))</span>

    <span class="c1"># 읽기 전용: /user/abc
</span>    <span class="n">fd_ro</span> <span class="o">=</span> <span class="nf">_open_dir_path_only</span><span class="p">(</span><span class="n">ro_dir</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ro_rule</span> <span class="o">=</span> <span class="nf">path_beneath_attr</span><span class="p">(</span><span class="n">allowed_access</span><span class="o">=</span><span class="n">read_mask</span><span class="p">,</span> <span class="n">parent_fd</span><span class="o">=</span><span class="n">fd_ro</span><span class="p">)</span>
        <span class="nf">_syscall</span><span class="p">(</span><span class="n">__NR_landlock_add_rule</span><span class="p">,</span> <span class="n">rs_fd</span><span class="p">,</span> <span class="n">LANDLOCK_RULE_PATH_BENEATH</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">.</span><span class="nf">byref</span><span class="p">(</span><span class="n">ro_rule</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">close</span><span class="p">(</span><span class="n">fd_ro</span><span class="p">)</span>

    <span class="c1"># 읽기/쓰기 허용: /user/abc/test
</span>    <span class="n">fd_rw</span> <span class="o">=</span> <span class="nf">_open_dir_path_only</span><span class="p">(</span><span class="n">rw_dir</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">rw_rule</span> <span class="o">=</span> <span class="nf">path_beneath_attr</span><span class="p">(</span><span class="n">allowed_access</span><span class="o">=</span><span class="n">write_mask</span><span class="p">,</span> <span class="n">parent_fd</span><span class="o">=</span><span class="n">fd_rw</span><span class="p">)</span>
        <span class="nf">_syscall</span><span class="p">(</span><span class="n">__NR_landlock_add_rule</span><span class="p">,</span> <span class="n">rs_fd</span><span class="p">,</span> <span class="n">LANDLOCK_RULE_PATH_BENEATH</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">.</span><span class="nf">byref</span><span class="p">(</span><span class="n">rw_rule</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">close</span><span class="p">(</span><span class="n">fd_rw</span><span class="p">)</span>

    <span class="c1"># 현재 스레드(프로세스)에 적용. 이후 자식 프로세스에도 상속됨.
</span>    <span class="nf">_syscall</span><span class="p">(</span><span class="n">__NR_landlock_restrict_self</span><span class="p">,</span> <span class="n">rs_fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">close</span><span class="p">(</span><span class="n">rs_fd</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">ro</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/user/abc</span><span class="sh">"</span>
    <span class="n">rw</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/user/abc/test</span><span class="sh">"</span>

    <span class="c1"># 테스트 준비: 디렉터리와 읽기용 파일 생성(제한 걸기 전)
</span>    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">rw</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">ro</span><span class="p">,</span> <span class="sh">"</span><span class="s">readonly.txt</span><span class="sh">"</span><span class="p">),</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="sh">"</span><span class="s">hello</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Applying Landlock: RO =</span><span class="sh">"</span><span class="p">,</span> <span class="n">ro</span><span class="p">,</span> <span class="sh">"</span><span class="s">RW =</span><span class="sh">"</span><span class="p">,</span> <span class="n">rw</span><span class="p">)</span>
    <span class="nf">apply_landlock_read_ro_write_rw</span><span class="p">(</span><span class="n">ro</span><span class="p">,</span> <span class="n">rw</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Landlock applied.</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># 테스트 1: ro 디렉터리 쓰기 → 실패해야 함
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">ro</span><span class="p">,</span> <span class="sh">"</span><span class="s">should_fail.txt</span><span class="sh">"</span><span class="p">),</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="sh">"</span><span class="s">nope</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[FAIL] wrote to RO dir (unexpected)</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[OK] RO write blocked:</span><span class="sh">"</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

    <span class="c1"># 테스트 2: rw 디렉터리 쓰기 → 성공해야 함
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">rw</span><span class="p">,</span> <span class="sh">"</span><span class="s">ok.txt</span><span class="sh">"</span><span class="p">),</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="sh">"</span><span class="s">works</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[OK] RW write succeeded</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[FAIL] RW write blocked:</span><span class="sh">"</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

    <span class="c1"># 테스트 3: ro 파일 읽기 → 성공해야 함
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">ro</span><span class="p">,</span> <span class="sh">"</span><span class="s">readonly.txt</span><span class="sh">"</span><span class="p">),</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[OK] RO read:</span><span class="sh">"</span><span class="p">,</span> <span class="n">f</span><span class="p">.</span><span class="nf">readline</span><span class="p">().</span><span class="nf">strip</span><span class="p">())</span>
    <span class="k">except</span> <span class="nb">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[FAIL] RO read blocked:</span><span class="sh">"</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">sys</span><span class="p">.</span><span class="n">platform</span> <span class="o">!=</span> <span class="sh">"</span><span class="s">linux</span><span class="sh">"</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Linux 전용입니다.</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="nf">main</span><span class="p">()</span>
</code></pre></div></div>

<p>설명 요약</p>

<ul>
  <li>
    <p>이 스크립트는 현재 프로세스에만 제약을 건다. 한 번 적용되면 해제 불가, 자식 프로세스에 상속된다.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">/user/abc</code>는 READ_FILE/READ_DIR(+EXECUTE)만, <code class="language-plaintext highlighter-rouge">/user/abc/test</code>는 READ/WRITE/CREATE/REMOVE(+가능하면 REFER/TRUNCATE)까지 허용한다.</p>
  </li>
  <li>
    <p>x86_64 기준 syscall 번호를 썼다. 다른 아키텍처면 번호가 다를 수 있다.</p>
  </li>
  <li>
    <p>커널이 낮아 TRUNCATE/REFER를 지원하지 않으면 자동으로 빼고 재시도한다.</p>
  </li>
</ul>

<p class="chat--user">

python landlock 패키지 쓰는거보다 ctype로 하는게 더 낫나?

</p>

<p>짧게 정리하면 “무엇을 통제하느냐”에 따라 선택이 갈린다.</p>

<ol>
  <li>ctypes 직접 호출이 나은 경우</li>
</ol>

<ul>
  <li>
    <p>경로별 권한 비트(READ_FILE/READ_DIR/WRITE_FILE/MAKE__/REMOVE__ /REFER/TRUNCATE 등)를 정확히 지정해야 할 때</p>
  </li>
  <li>
    <p>패키지 래퍼가 원하는 기능(예: rw 전용 디렉터리)까지 노출하지 않거나 버전마다 API가 달라 흔들릴 때</p>
  </li>
  <li>
    <p>지금처럼 “/user/abc는 읽기만, /user/abc/test는 쓰기까지” 같은 세밀한 정책이 필수일 때</p>
  </li>
</ul>

<p>장점: 커널 UAPI를 그대로 쓰므로 원하는 동작을 1:1로 구현 가능, 예측 가능성 높음<br />
단점: 아키텍처별 syscall 번호, ABI 호환성(REFER/TRUNCATE 지원 여부) 처리 등 주변 코드가 필요</p>

<ol>
  <li>PyPI landlock 패키지가 나은 경우</li>
</ol>

<ul>
  <li>
    <p>“읽기만 허용할 루트 몇 개 + 기본은 차단” 같은 단순 모델이면 충분할 때</p>
  </li>
  <li>
    <p>유지보수 용이성, 가독성, 배포 편의성을 우선할 때</p>
  </li>
  <li>
    <p>커널 기능 추가(ABI v2/v3)까지 세밀 제어가 굳이 필요 없을 때</p>
  </li>
</ul>

<p>장점: 코드 간단, 포터블, 업데이트 시 따라가면 됨<br />
단점: 래퍼가 노출하는 추상화 한계 때문에 per-path 쓰기 권한을 정확히 다루지 못할 수 있음</p>

<p>현실적인 권장</p>

<ul>
  <li>
    <p>네 요구(RO 디렉터리와 RW 디렉터리를 분리)라면 ctypes로 얇은 헬퍼를 두는 쪽이 깔끔하다. 이미 제공한 50~80줄짜리 helper를 모듈화하면 끝이다. 그 위에 “설정은 네가 직접, LLM에는 노출 금지” 원칙만 지키면 된다.</p>
  </li>
  <li>
    <p>유지보수 부담을 줄이고 싶다면 하이브리드로 가자. 우선 PyPI 패키지로 “읽기 허용 루트”만 잡고, “쓰기 허용 루트”만 ctypes로 추가 규칙을 넣는 방식도 가능하다. 즉, 간단한 건 래퍼에 맡기고, 꼭 필요한 부분만 커널 UAPI로 보강.</p>
  </li>
</ul>

<p>결론</p>

<ul>
  <li>
    <p>세밀한 RW 컨트롤이 필요하면 ctypes가 더 낫다.</p>
  </li>
  <li>
    <p>단순 접근제어와 운영 편의가 우선이면 패키지가 더 낫다.</p>
  </li>
  <li>
    <p>너의 현재 설계(세션 유지 + 명시적 RW 분리)는 ctypes 미니 헬퍼가 가장 직관적이고, LLM 툴 레이어와도 잘 맞는다.</p>
  </li>
</ul>

<p class="chat--user">

아 redhat 8.10은 그런게 안 되네. 그냥 pure 파이썬으로 간단하게 되는 패키지 없나? 해커가 작정하고 하면 뚫릴수도 있지만 LLM이 그런 동작을 안한다고 가정하고

</p>

<p>가능한 한 단순하게 갈게. RHEL 8.10에서 Landlock 안 된다면 “완벽 보안” 대신 실수 방지용 가벼운 가드가 현실적이다. 순수 파이썬만으로도 다음 정도는 막을 수 있다.</p>

<ol>
  <li>
    <p>sys.addaudithook로 파일 열기(open) 이벤트에서 “쓰기 의도”를 가로채기</p>
  </li>
  <li>
    <p>os/builtins/pathlib의 쓰기 계열 호출을 몽키패치해 우회 시도 최소화</p>
  </li>
  <li>
    <p>옵션으로 subprocess/네트워크 차단</p>
  </li>
</ol>

<p>audit hook은 파이썬 3.8+에서 표준이며 open 이벤트는 경로, 모드, 플래그를 넘겨준다. 이걸로 “쓰기 의도”를 정밀하게 잡아낼 수 있다. 다만 감사용 훅이지 하드한 보안 경계는 아니라는 점은 공식적으로도 명시돼 있다(그래도 이번 목표에는 충분히 유용). <a href="https://docs.python.org/3/library/audit_events.html?utm_source=chatgpt.com">Python documentation+2</a></p>

<p>아래는 바로 복붙해 쓸 수 있는 “순수 파이썬 미니 패키지” 코드와 테스트다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># lite_fs_guard.py
# 순수 파이썬 가드: 쓰기는 write_root 아래만 허용, 읽기는 기본 전체 허용(옵션으로 제한 가능)
</span>
<span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">builtins</span><span class="p">,</span> <span class="n">pathlib</span>

<span class="k">class</span> <span class="nc">LiteFSGuard</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">write_root</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">read_allow</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                 <span class="n">allow_read_anywhere</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
                 <span class="n">block_subprocess</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">block_network</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">write_root</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">write_root</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">read_allow</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">(</span><span class="n">read_allow</span> <span class="ow">or</span> <span class="p">[])]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">allow_read_anywhere</span> <span class="o">=</span> <span class="n">allow_read_anywhere</span>
        <span class="n">self</span><span class="p">.</span><span class="n">block_subprocess</span> <span class="o">=</span> <span class="n">block_subprocess</span>
        <span class="n">self</span><span class="p">.</span><span class="n">block_network</span> <span class="o">=</span> <span class="n">block_network</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">write_root</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_installed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="c1"># 원본 함수 백업
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_orig</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">open</span><span class="sh">"</span><span class="p">:</span> <span class="n">builtins</span><span class="p">.</span><span class="nb">open</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">os_open</span><span class="sh">"</span><span class="p">:</span> <span class="n">os</span><span class="p">.</span><span class="nb">open</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">rename</span><span class="sh">"</span><span class="p">:</span> <span class="n">os</span><span class="p">.</span><span class="n">rename</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">:</span> <span class="n">os</span><span class="p">.</span><span class="n">replace</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">remove</span><span class="sh">"</span><span class="p">:</span> <span class="n">os</span><span class="p">.</span><span class="n">remove</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">unlink</span><span class="sh">"</span><span class="p">:</span> <span class="n">os</span><span class="p">.</span><span class="n">unlink</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">mkdir</span><span class="sh">"</span><span class="p">:</span> <span class="n">os</span><span class="p">.</span><span class="n">mkdir</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">makedirs</span><span class="sh">"</span><span class="p">:</span> <span class="n">os</span><span class="p">.</span><span class="n">makedirs</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">rmdir</span><span class="sh">"</span><span class="p">:</span> <span class="n">os</span><span class="p">.</span><span class="n">rmdir</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">chmod</span><span class="sh">"</span><span class="p">:</span> <span class="n">os</span><span class="p">.</span><span class="n">chmod</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">path_open</span><span class="sh">"</span><span class="p">:</span> <span class="n">pathlib</span><span class="p">.</span><span class="n">Path</span><span class="p">.</span><span class="nb">open</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">os_system</span><span class="sh">"</span><span class="p">:</span> <span class="n">os</span><span class="p">.</span><span class="n">system</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_in_write_root</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">p</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">rp</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rp</span> <span class="o">==</span> <span class="n">self</span><span class="p">.</span><span class="n">write_root</span> <span class="ow">or</span> <span class="n">rp</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">write_root</span> <span class="o">+</span> <span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_is_read_allowed</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">p</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">allow_read_anywhere</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="n">rp</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">_in_write_root</span><span class="p">(</span><span class="n">rp</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="nf">any</span><span class="p">(</span><span class="n">rp</span> <span class="o">==</span> <span class="n">r</span> <span class="ow">or</span> <span class="n">rp</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">read_allow</span><span class="p">)</span>

    <span class="c1"># --------- audit hook ----------
</span>    <span class="k">def</span> <span class="nf">_audit</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="sh">"</span><span class="s">open</span><span class="sh">"</span><span class="p">:</span>
            <span class="c1"># args: path, mode, flags (문서화됨)
</span>            <span class="c1"># https://docs.python.org/3/library/audit_events.html
</span>            <span class="n">path</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span>
            <span class="n">flags</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">write_intent</span> <span class="o">=</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="ow">in</span> <span class="n">mode</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">a</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">+</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">x</span><span class="sh">"</span><span class="p">))</span> <span class="ow">or</span> \
                <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">O_WRONLY</span> <span class="o">|</span> <span class="n">os</span><span class="p">.</span><span class="n">O_RDWR</span> <span class="o">|</span> <span class="n">os</span><span class="p">.</span><span class="n">O_CREAT</span> <span class="o">|</span> <span class="n">os</span><span class="p">.</span><span class="n">O_TRUNC</span> <span class="o">|</span> <span class="n">os</span><span class="p">.</span><span class="n">O_APPEND</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">write_intent</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="nf">_in_write_root</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Write restricted to </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">write_root</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">write_intent</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="nf">_is_read_allowed</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Read not allowed here: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">self</span><span class="p">.</span><span class="n">block_subprocess</span> <span class="ow">and</span> <span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">subprocess.</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">event</span> <span class="o">==</span> <span class="sh">"</span><span class="s">os.system</span><span class="sh">"</span><span class="p">):</span>
            <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sh">"</span><span class="s">Subprocess disabled by LiteFSGuard</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">self</span><span class="p">.</span><span class="n">block_network</span> <span class="ow">and</span> <span class="n">event</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">socket.</span><span class="sh">"</span><span class="p">):</span>
            <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sh">"</span><span class="s">Network disabled by LiteFSGuard</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># --------- monkey patches (소프트 가드) ----------
</span>    <span class="k">def</span> <span class="nf">_patches</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">open_guard</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
            <span class="n">write_intent</span> <span class="o">=</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="ow">in</span> <span class="n">mode</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">a</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">+</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">x</span><span class="sh">"</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">write_intent</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="nf">_in_write_root</span><span class="p">(</span><span class="nb">file</span><span class="p">):</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Write restricted to </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">write_root</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="nb">file</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">write_intent</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="nf">_is_read_allowed</span><span class="p">(</span><span class="nb">file</span><span class="p">):</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Read not allowed here: </span><span class="si">{</span><span class="nb">file</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_orig</span><span class="p">[</span><span class="sh">"</span><span class="s">open</span><span class="sh">"</span><span class="p">](</span><span class="nb">file</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">os_open_guard</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
            <span class="n">write_intent</span> <span class="o">=</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">O_WRONLY</span> <span class="o">|</span> <span class="n">os</span><span class="p">.</span><span class="n">O_RDWR</span> <span class="o">|</span> <span class="n">os</span><span class="p">.</span><span class="n">O_CREAT</span> <span class="o">|</span> <span class="n">os</span><span class="p">.</span><span class="n">O_TRUNC</span> <span class="o">|</span> <span class="n">os</span><span class="p">.</span><span class="n">O_APPEND</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">write_intent</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="nf">_in_write_root</span><span class="p">(</span><span class="nb">file</span><span class="p">):</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Write restricted to </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">write_root</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="nb">file</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">write_intent</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="nf">_is_read_allowed</span><span class="p">(</span><span class="nb">file</span><span class="p">):</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Read not allowed here: </span><span class="si">{</span><span class="nb">file</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_orig</span><span class="p">[</span><span class="sh">"</span><span class="s">os_open</span><span class="sh">"</span><span class="p">](</span><span class="nb">file</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">rename_guard</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">_in_write_root</span><span class="p">(</span><span class="n">src</span><span class="p">)</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="nf">_in_write_root</span><span class="p">(</span><span class="n">dst</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sh">"</span><span class="s">Rename restricted within write_root</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_orig</span><span class="p">[</span><span class="sh">"</span><span class="s">rename</span><span class="sh">"</span><span class="p">](</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">replace_guard</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">_in_write_root</span><span class="p">(</span><span class="n">src</span><span class="p">)</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="nf">_in_write_root</span><span class="p">(</span><span class="n">dst</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sh">"</span><span class="s">Replace restricted within write_root</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_orig</span><span class="p">[</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">](</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">remove_guard</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="nf">_in_write_root</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sh">"</span><span class="s">Delete restricted within write_root</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_orig</span><span class="p">[</span><span class="sh">"</span><span class="s">remove</span><span class="sh">"</span><span class="p">](</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">unlink_guard</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="nf">_in_write_root</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sh">"</span><span class="s">Unlink restricted within write_root</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_orig</span><span class="p">[</span><span class="sh">"</span><span class="s">unlink</span><span class="sh">"</span><span class="p">](</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">mkdir_guard</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="nf">_in_write_root</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sh">"</span><span class="s">Mkdir restricted within write_root</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_orig</span><span class="p">[</span><span class="sh">"</span><span class="s">mkdir</span><span class="sh">"</span><span class="p">](</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">makedirs_guard</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="nf">_in_write_root</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sh">"</span><span class="s">Makedirs restricted within write_root</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_orig</span><span class="p">[</span><span class="sh">"</span><span class="s">makedirs</span><span class="sh">"</span><span class="p">](</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">rmdir_guard</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="nf">_in_write_root</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sh">"</span><span class="s">Rmdir restricted within write_root</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_orig</span><span class="p">[</span><span class="sh">"</span><span class="s">rmdir</span><span class="sh">"</span><span class="p">](</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">chmod_guard</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="nf">_in_write_root</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sh">"</span><span class="s">Chmod restricted within write_root</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_orig</span><span class="p">[</span><span class="sh">"</span><span class="s">chmod</span><span class="sh">"</span><span class="p">](</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">path_open_guard</span><span class="p">(</span><span class="n">self_path</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">mode</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">write_intent</span> <span class="o">=</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="ow">in</span> <span class="n">mode</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">a</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">+</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">x</span><span class="sh">"</span><span class="p">))</span>
            <span class="n">p</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">self_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">write_intent</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="nf">_in_write_root</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Write restricted to </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">write_root</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">write_intent</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="nf">_is_read_allowed</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Read not allowed here: </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_orig</span><span class="p">[</span><span class="sh">"</span><span class="s">path_open</span><span class="sh">"</span><span class="p">](</span><span class="n">self_path</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">builtins</span><span class="p">.</span><span class="nb">open</span> <span class="o">=</span> <span class="n">open_guard</span>
        <span class="n">os</span><span class="p">.</span><span class="nb">open</span> <span class="o">=</span> <span class="n">os_open_guard</span>
        <span class="n">os</span><span class="p">.</span><span class="n">rename</span> <span class="o">=</span> <span class="n">rename_guard</span>
        <span class="n">os</span><span class="p">.</span><span class="n">replace</span> <span class="o">=</span> <span class="n">replace_guard</span>
        <span class="n">os</span><span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">remove_guard</span>
        <span class="n">os</span><span class="p">.</span><span class="n">unlink</span> <span class="o">=</span> <span class="n">unlink_guard</span>
        <span class="n">os</span><span class="p">.</span><span class="n">mkdir</span> <span class="o">=</span> <span class="n">mkdir_guard</span>
        <span class="n">os</span><span class="p">.</span><span class="n">makedirs</span> <span class="o">=</span> <span class="n">makedirs_guard</span>
        <span class="n">os</span><span class="p">.</span><span class="n">rmdir</span> <span class="o">=</span> <span class="n">rmdir_guard</span>
        <span class="n">os</span><span class="p">.</span><span class="n">chmod</span> <span class="o">=</span> <span class="n">chmod_guard</span>
        <span class="n">pathlib</span><span class="p">.</span><span class="n">Path</span><span class="p">.</span><span class="nb">open</span> <span class="o">=</span> <span class="n">path_open_guard</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">block_subprocess</span><span class="p">:</span>
            <span class="n">os</span><span class="p">.</span><span class="n">system</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">:</span> <span class="p">(</span><span class="n">_</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="p">()).</span><span class="nf">throw</span><span class="p">(</span><span class="nc">PermissionError</span><span class="p">(</span><span class="sh">"</span><span class="s">os.system disabled</span><span class="sh">"</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">install</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_installed</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">sys</span><span class="p">.</span><span class="nf">addaudithook</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_audit</span><span class="p">)</span>  <span class="c1"># 3.8+ 표준 훅: 이벤트 목록은 공식 표 참조
</span>        <span class="n">self</span><span class="p">.</span><span class="nf">_patches</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_installed</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[lite-fs-guard] active. write_root=</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">write_root</span><span class="si">}</span><span class="s">, read_anywhere=</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">allow_read_anywhere</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<p>간단 테스트 스크립트</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># test_lite_fs_guard.py
</span><span class="kn">import</span> <span class="n">os</span>
<span class="kn">from</span> <span class="n">lite_fs_guard</span> <span class="kn">import</span> <span class="n">LiteFSGuard</span>

<span class="n">WRITE_ROOT</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/tmp/sbx</span><span class="sh">"</span>
<span class="n">guard</span> <span class="o">=</span> <span class="nc">LiteFSGuard</span><span class="p">(</span><span class="n">write_root</span><span class="o">=</span><span class="n">WRITE_ROOT</span><span class="p">,</span>
                    <span class="n">allow_read_anywhere</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>   <span class="c1"># 어디든 읽기 허용
</span>                    <span class="n">block_subprocess</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>      <span class="c1"># 원하면 False
</span>                    <span class="n">block_network</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>        <span class="c1"># 원하면 True
</span><span class="n">guard</span><span class="p">.</span><span class="nf">install</span><span class="p">()</span>

<span class="c1"># 준비
</span><span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">WRITE_ROOT</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">try write to /etc/hosts (should fail)</span><span class="sh">"</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="nf">open</span><span class="p">(</span><span class="sh">"</span><span class="s">/etc/hosts</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">a</span><span class="sh">"</span><span class="p">).</span><span class="nf">write</span><span class="p">(</span><span class="sh">"</span><span class="s"># nope</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">FAIL: wrote to /etc/hosts</span><span class="sh">"</span><span class="p">)</span>
<span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">OK:</span><span class="sh">"</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">try write to write_root (should pass)</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">open</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">WRITE_ROOT</span><span class="p">,</span> <span class="sh">"</span><span class="s">ok.txt</span><span class="sh">"</span><span class="p">),</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">).</span><span class="nf">write</span><span class="p">(</span><span class="sh">"</span><span class="s">hello</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">OK: wrote to</span><span class="sh">"</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">WRITE_ROOT</span><span class="p">,</span> <span class="sh">"</span><span class="s">ok.txt</span><span class="sh">"</span><span class="p">))</span>

<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">try read from /etc/hosts (should pass)</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="nf">open</span><span class="p">(</span><span class="sh">"</span><span class="s">/etc/hosts</span><span class="sh">"</span><span class="p">).</span><span class="nf">read</span><span class="p">().</span><span class="nf">splitlines</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
</code></pre></div></div>

<p>이 접근은 어디까지나 “실수 방지용”이다. 핵심 포인트만 다시 적는다.</p>

<ul>
  <li>
    <p>sys.addaudithook는 표준이며 open 이벤트(path, mode, flags)를 준다. 여기서 정확히 쓰기 의도를 판별할 수 있다. <a href="https://docs.python.org/3/library/audit_events.html?utm_source=chatgpt.com">Python documentation</a></p>
  </li>
  <li>
    <p>audit hook은 감사용이므로 완전한 보안 경계는 아니다. 하지만 이번 전제(LLM이 악의적 동작을 하지 않는다고 가정)에서는 충분히 실용적이다. <a href="https://github.com/python/cpython/issues/87604?utm_source=chatgpt.com">GitHub</a></p>
  </li>
  <li>
    <p>더 강한 격리가 필요하면 도커·랜드락·AppArmor 같은 OS 레벨이 답이지만, Red Hat 8.10 제약이라면 위 가드가 가장 단순한 “순수 파이썬 80/20 해법”이다.</p>
  </li>
  <li>
    <p>참고로 언어 제한만 필요한 경우 RestrictedPython 같은 도구도 있지만 파일시스템 격리를 제공하는 건 아니다. pyfakefs는 테스트용 가짜 FS이지 보안 격리가 아니다. codejail은 AppArmor가 필요해서 이번 조건에 맞지 않는다. <a href="https://restrictedpython.readthedocs.io/?utm_source=chatgpt.com">restrictedpython.readthedocs.io+3</a></p>
  </li>
</ul>

<p>다음 스텝으로, 이 가드를 너의 커널 세션(또는 서브프로세스) 시작 직후에 한 번 설치하도록 넣으면 된다. 세션 유지/일회성 모두 동일하게 동작한다.</p>

<p class="chat--user">

#!/usr/bin/python3.8 #-<em>- coding: utf-8 -</em>- ## QUEST FOR A PYTHON SANDBOX: # 1. You design an script where an exec() command is ran. # 2. The code ran by exec() is supplied by your opponent, trying e.g. to # write something to the './forbidden.txt' file or access # forbidden_object. Your opponent has # full knowledge of the outer script (no security through obscurity). # There should be no trick to break the sandbox whatsoever. Crashing # the subprocess Cpython does not count. # 3. The exec()uted code should however allow as large subset of Python # capabilities as possible, including interaction with variables/ # functions/objects in the outer script, if and only if they are # explicitly listed as accessible. # 4. Elegant, fast, dependency-frugal solution is also appreciated. # 5. The outer script writes something to the './allowed.txt' file # in the end. user_command = """import sys ## Useful code on the figure import numpy x = numpy.linspace(0,10) y = numpy.sin(x) fig.get_axes()[0].plot(x, y) ## Malicious wannabe exploits follow for l in ().<strong>class</strong>.<strong>base</strong>.<strong>subclasses</strong>(): if l.<strong>name</strong> == '<strong>code</strong>': print(l) ## SANDBOXED: has access to the sandboxed python subprocess only, in line with our intention ## to provide Python environment as-rich-as-possible exec("[ i for i in ().<strong>class</strong>.<strong>base</strong>.<strong>subclasses</strong>() if i.<strong>name</strong> == 'code']<a href="0, 0, 0, 5, 8, 0, b'hello world', (), (), ()," title="', '', 0, b'">0</a>") ## TEST #fig = numpy.array([666]) ## TODO: unexpected class type of returned objects should be detected after being returned from the sandbox #class SpoofFigure(matplotlib.pyplot.Figure): # def savefig(self): print("Malicious action") ## SANDBOXED: modified class won't be serialized if not defined in a module - can not get out of sandbox #fig = SpoofFig() #import XXX ## UNCLEAR: could some compiled module circumwent the file access hook? Which OS calls should be forbidden, too? ## See https://docs.python.org/3/library/audit_events.html to find them. #open('forbidden','w').write('pwned by l33t h4xx0rz') ## SANDBOXED: fails to write on disk thanks to the audit hook #fig.savefig('forbidden.png') ## SANDBOXED: audit hook applies to all python code #forbidden_object.access() ## SANDBOXED: no access to the forbidden object from the outer scope conn.send([fig]) ## all results can be safely passed (unless it is of custom class etc.) """ ## Prepare the testing example import matplotlib.pyplot as plt fig, ax = plt.subplots(nrows=1, ncols=1) ## the user's code will plot here allowed_objects = [fig] ## no other data exposed to the exec()uted script ## —————- The sandbox implementation follows, not to be changed ——————– def sandbox2020(code, allowed_objects): def ran_in_subprocess(conn): from sys import addaudithook def block_mischief(event,arg): if type(event) != str: raise # Security note: Well-designed objects can be passed to this function that could expose the top-level namespace # (through catching error and reading sys.exc_info()[2].tb_frame.f_back.f_globals). This should not enable modifying # variables outside the multiprocessing sandbox, but could give access to some internal sandbox variables. This function # thus should not refer to any 'lock variables'. It is safer to check the results in the main thread. if event=='open' and type(arg[1])==str and arg[1]!='r': print('\taudit:', event, arg) raise IOError('file write forbidden') if event.split('.')[0] in ['subprocess', 'shutil', 'winreg']: print('\taudit:', event, arg) raise IOError('potentially dangerous, filesystem-accessing functions forbidden') addaudithook(block_mischief) del(block_mischief) ## No way to remove or circumwent audit hooks from python. No access to this function. sandbox_locals['conn'] = conn # automatically add the communication pipe to objects accessible from the sandbox exec(user_command, sandbox_locals) print('len sandbox locals after', len(sandbox_locals)) conn.close() from multiprocessing import Process, Pipe parent_conn, child_conn = Pipe() p = Process(target=ran_in_subprocess, args=(child_conn,)) p.start() ## NOTE: The sandbox is probably safe against file writing, as well as against access into the main process. ## Yet the objects returned from it as results could have been manipulated. Asserting the output objects to be ## of expected data types is an extra safety measure. But be careful whenever your main program flow is ## controlled by the returned objects' attributes, e.g. file paths could change. return parent_conn.recv() p.join() ## Run the sandbox! sandbox_locals = dict((key, value) for key,value in locals().items() if value in allowed_objects) # copy.deepcopy() ## are all obj safely serialized? fig_result = sandbox2020(user_command, sandbox_locals) ## Demonstrate that the main process is not affected open('./allowed.txt','w').write('legally saved file from the main process') print(type(fig_result) == type(fig)) fig_result.savefig('allowed.png') 이런 코드는 어때

</p>

<p>좋은 출발이야. 다만 지금 코드는 “쓰기 의도” 판별이 부정확하고, os 계열 조작·서브프로세스·네트워크가 그대로 열려 있어 실수 방지라는 목표에도 살짝 모자라. 구조는 유지하되, 최소한만 손봐서 안전성과 예측가능성을 올린 패치안을 줄게.</p>

<p>핵심 문제 요약</p>

<ol>
  <li>
    <p>audit 훅의 open 검사: mode가 'r'이 아니면 전부 쓰기라고 가정하고 있는데, 'rb', 'r+', 'a', 'x' 등과 flags까지 모두 봐야 한다. os.open()도 잡아야 한다.</p>
  </li>
  <li>
    <p>파일 조작류: rename/replace/remove/unlink/mkdir/makedirs/rmdir 같은 조작 이벤트를 막아야 샌드박스 밖 훼손을 피할 수 있다.</p>
  </li>
  <li>
    <p>subprocess와 os.system, socket 계열은 명시 차단이 필요하다.</p>
  </li>
  <li>
    <p>타임아웃과 join 누락: recv() 대기 중 교착, 무한루프 방지 필요. p.join(timeout) 후 미응답이면 종료.</p>
  </li>
  <li>
    <p>인자 전달 혼선: sandbox2020(…, allowed_objects) 인자를 쓰지 않고 전역 sandbox_locals를 닫아 사용하고 있다. 함수 인자를 사용하도록 정리.</p>
  </li>
</ol>

<p>아래는 네 코드에 최소 변경만 가한 드롭인 패치다. 동작은 그대로이고, 샌드박스 안에서의 파일 쓰기는 현재 작업 디렉터리 기준으로 “./sandbox/” 하위에서만 허용하도록 했다. 필요하면 WRITE_ROOT를 바꿔.</p>

<p>수정본 전체</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/python3.8
#-*- coding: utf-8 -*-
</span>
<span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">time</span>
<span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="n">WRITE_ROOT</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="sh">"</span><span class="s">./sandbox</span><span class="sh">"</span><span class="p">)</span>   <span class="c1"># 샌드박스 내에서만 쓰기 허용
</span><span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">WRITE_ROOT</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="n">user_command</span> <span class="o">=</span> <span class="sh">"""</span><span class="s">import sys, os, numpy
x = numpy.linspace(0,10)
y = numpy.sin(x)
fig.get_axes()[0].plot(x, y)

# 시도: 금지 영역 쓰기
try:
    open(</span><span class="sh">'</span><span class="s">./forbidden.txt</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">w</span><span class="sh">'</span><span class="s">).write(</span><span class="sh">'</span><span class="s">nope</span><span class="sh">'</span><span class="s">)
except Exception as e:
    print(</span><span class="sh">'</span><span class="s">forbidden write blocked:</span><span class="sh">'</span><span class="s">, type(e).__name__)

# 시도: 허용 영역 쓰기
open(os.path.join(os.environ[</span><span class="sh">'</span><span class="s">WRITE_ROOT</span><span class="sh">'</span><span class="s">], </span><span class="sh">'</span><span class="s">ok.txt</span><span class="sh">'</span><span class="s">),</span><span class="sh">'</span><span class="s">w</span><span class="sh">'</span><span class="s">).write(</span><span class="sh">'</span><span class="s">ok</span><span class="sh">'</span><span class="s">)

# 결과 전달
conn.send([fig])
</span><span class="sh">"""</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">allowed_objects</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">fig</span><span class="sh">"</span><span class="p">:</span> <span class="n">fig</span><span class="p">}</span>   <span class="c1"># exec에 노출할 것만 명시
</span>
<span class="k">def</span> <span class="nf">sandbox2020</span><span class="p">(</span><span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">allowed_globals</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">timeout_sec</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="kn">from</span> <span class="n">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span><span class="p">,</span> <span class="n">Pipe</span>

    <span class="k">def</span> <span class="nf">ran_in_subprocess</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">allowed</span><span class="p">):</span>
        <span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">pathlib</span>
        <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="sh">'</span><span class="s">WRITE_ROOT</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">WRITE_ROOT</span><span class="sh">'</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="sh">"</span><span class="s">./sandbox</span><span class="sh">"</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">_in_write_root</span><span class="p">(</span><span class="n">p</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="n">rp</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">wr</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="sh">'</span><span class="s">WRITE_ROOT</span><span class="sh">'</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">rp</span> <span class="o">==</span> <span class="n">wr</span> <span class="ow">or</span> <span class="n">rp</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="n">wr</span> <span class="o">+</span> <span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_audit</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
            <span class="c1"># open / os.open: (path, mode, flags)
</span>            <span class="k">if</span> <span class="n">event</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">open</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">os.open</span><span class="sh">"</span><span class="p">):</span>
                <span class="n">path</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span>
                <span class="n">flags</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="n">write</span> <span class="o">=</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="ow">in</span> <span class="n">mode</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">a</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">+</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">x</span><span class="sh">"</span><span class="p">))</span> <span class="ow">or</span> \
                        <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">O_WRONLY</span> <span class="o">|</span> <span class="n">os</span><span class="p">.</span><span class="n">O_RDWR</span> <span class="o">|</span> <span class="n">os</span><span class="p">.</span><span class="n">O_CREAT</span> <span class="o">|</span> <span class="n">os</span><span class="p">.</span><span class="n">O_TRUNC</span> <span class="o">|</span> <span class="n">os</span><span class="p">.</span><span class="n">O_APPEND</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">write</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nf">_in_write_root</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Write restricted to </span><span class="si">{</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="sh">'</span><span class="s">WRITE_ROOT</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

            <span class="c1"># 파일 조작류
</span>            <span class="k">elif</span> <span class="n">event</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">os.rename</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.replace</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.remove</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.unlink</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.mkdir</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.makedirs</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.rmdir</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.chmod</span><span class="sh">"</span><span class="p">):</span>
                <span class="n">path</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nf">_in_write_root</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">FS op restricted to </span><span class="si">{</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="sh">'</span><span class="s">WRITE_ROOT</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

            <span class="c1"># 서브프로세스/시스템 호출
</span>            <span class="k">elif</span> <span class="n">event</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">subprocess.</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">event</span> <span class="o">==</span> <span class="sh">"</span><span class="s">os.system</span><span class="sh">"</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sh">"</span><span class="s">Subprocess disabled</span><span class="sh">"</span><span class="p">)</span>

            <span class="c1"># 네트워크(원하면 주석 해제)
</span>            <span class="c1"># elif event.startswith("socket."):
</span>            <span class="c1">#     raise PermissionError("Network disabled")
</span>
        <span class="n">sys</span><span class="p">.</span><span class="nf">addaudithook</span><span class="p">(</span><span class="n">_audit</span><span class="p">)</span>

        <span class="c1"># exec용 전역 딕셔너리 구성
</span>        <span class="n">g</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">__builtins__</span><span class="sh">"</span><span class="p">:</span> <span class="n">__builtins__</span><span class="p">}</span>
        <span class="n">g</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">allowed</span><span class="p">)</span>
        <span class="n">g</span><span class="p">[</span><span class="sh">"</span><span class="s">conn</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">conn</span>

        <span class="c1"># 실행
</span>        <span class="nf">exec</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>

        <span class="n">conn</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>

    <span class="n">parent_conn</span><span class="p">,</span> <span class="n">child_conn</span> <span class="o">=</span> <span class="nc">Pipe</span><span class="p">(</span><span class="n">duplex</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nc">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">ran_in_subprocess</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">child_conn</span><span class="p">,</span> <span class="n">allowed_globals</span><span class="p">))</span>
    <span class="n">p</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>

    <span class="c1"># 결과 수신 대기 + 타임아웃
</span>    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">parent_conn</span><span class="p">.</span><span class="nf">poll</span><span class="p">(</span><span class="mf">0.05</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">parent_conn</span><span class="p">.</span><span class="nf">recv</span><span class="p">()</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span> <span class="o">&gt;</span> <span class="n">timeout_sec</span><span class="p">:</span>
            <span class="n">p</span><span class="p">.</span><span class="nf">terminate</span><span class="p">()</span>
            <span class="n">p</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">raise</span> <span class="nc">TimeoutError</span><span class="p">(</span><span class="sh">"</span><span class="s">sandbox execution timed out</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">p</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="c1"># 샌드박스 실행
</span><span class="n">result_list</span> <span class="o">=</span> <span class="nf">sandbox2020</span><span class="p">(</span><span class="n">user_command</span><span class="p">,</span> <span class="n">allowed_objects</span><span class="p">)</span>

<span class="c1"># 메인 프로세스는 정상 동작
</span><span class="nf">open</span><span class="p">(</span><span class="sh">'</span><span class="s">./allowed.txt</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">w</span><span class="sh">'</span><span class="p">).</span><span class="nf">write</span><span class="p">(</span><span class="sh">'</span><span class="s">legally saved file from the main process</span><span class="sh">'</span><span class="p">)</span>

<span class="c1"># 결과 확인
</span><span class="n">fig_result</span> <span class="o">=</span> <span class="n">result_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">same type:</span><span class="sh">"</span><span class="p">,</span> <span class="nf">type</span><span class="p">(</span><span class="n">fig_result</span><span class="p">)</span> <span class="o">==</span> <span class="nf">type</span><span class="p">(</span><span class="n">fig_result</span><span class="p">))</span>
<span class="n">fig_result</span><span class="p">.</span><span class="nf">savefig</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">WRITE_ROOT</span><span class="p">,</span> <span class="sh">'</span><span class="s">allowed.png</span><span class="sh">'</span><span class="p">))</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">done</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<p>설명과 운용 팁</p>

<ol>
  <li>
    <p>WRITE_ROOT 안에서만 쓰기 허용: open/os.open에서 mode/flags를 모두 검사해 쓰기 의도를 잡고, 조작성 작업(삭제/이동/생성 등)은 경로가 WRITE_ROOT 내부일 때만 허용했다.</p>
  </li>
  <li>
    <p>읽기는 어디서나 가능하게 남겨두었고, 필요하면 _audit의 open 분기에서 읽기도 allowlist로 제한할 수 있다.</p>
  </li>
  <li>
    <p>subprocess, os.system 차단. 네 목적에 맞게 socket.*도 막을 수 있다.</p>
  </li>
  <li>
    <p>타임아웃과 안전 종료 추가. 자식이 결과를 안 보내면 terminate 후 TimeoutError.</p>
  </li>
  <li>
    <p>allowed_objects는 dict로 명시 주입. exec의 globals로만 전달돼, 그 외 바깥 이름은 보이지 않는다.</p>
  </li>
  <li>
    <p>이건 “실수 방지용”이다. 악의적 확장(C 확장에서 직접 open 호출, ctypes로 커널 호출 등)은 막지 못한다는 점은 설계상 감수. 그 대신 코드가 짧고 의존성 없고, LLM이 악의적으로 행동하지 않는다는 전제에서는 실용적이다.</p>
  </li>
</ol>

<p>여기서 더 단단히 하고 싶다면, 네가 이미 쓰던 커널 유지 구조에 이 가드를 첫 셀로 주입하고, 파일은 copy_to_sandbox로 WRITE_ROOT 밑으로만 들여와 다루게 만드는 정도면 충분히 80/20을 채운다.</p>

<p class="chat--user">

근데 기존 코드에서 return을 먼저하고 join을 하는데 말이 안되는거지?

</p>

<p>맞아. 그 코드는 return 다음에 p.join()이 있어 실행되지 않아. 결과를 받은 뒤 프로세스를 정리(join/terminate)하고 리소스를 닫은 다음에 return 해야 한다. 그렇지 않으면 좀비 프로세스가 생길 수 있다(특히 POSIX).</p>

<p>안전한 기본 패턴을 아주 간단히 적으면 이렇게 된다.</p>

<ol>
  <li>
    <p>자식 시작 → 부모에서 child_conn 닫기</p>
  </li>
  <li>
    <p>poll로 타임아웃 감시하며 recv</p>
  </li>
  <li>
    <p>결과 받으면 p.join()으로 수거</p>
  </li>
  <li>
    <p>타임아웃이면 p.terminate() 후 p.join()</p>
  </li>
  <li>
    <p>항상 파이프 닫기</p>
  </li>
</ol>

<p>최소 수정 예시</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">sandbox2020</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">allowed_globals</span><span class="p">,</span> <span class="n">timeout_sec</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="kn">from</span> <span class="n">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span><span class="p">,</span> <span class="n">Pipe</span>

    <span class="k">def</span> <span class="nf">ran_in_subprocess</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">allowed</span><span class="p">):</span>
        <span class="c1"># ... 내부 실행 로직 ...
</span>        <span class="n">conn</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="n">conn</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>           <span class="c1"># 자식 쪽 파이프 닫기 후 종료
</span>
    <span class="n">parent_conn</span><span class="p">,</span> <span class="n">child_conn</span> <span class="o">=</span> <span class="nc">Pipe</span><span class="p">(</span><span class="n">duplex</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nc">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">ran_in_subprocess</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">child_conn</span><span class="p">,</span> <span class="n">allowed_globals</span><span class="p">))</span>
    <span class="n">p</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
    <span class="n">child_conn</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>          <span class="c1"># 부모 쪽에서 child end는 바로 닫기
</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># 타임아웃 감시하면서 결과 수신
</span>        <span class="k">if</span> <span class="n">parent_conn</span><span class="p">.</span><span class="nf">poll</span><span class="p">(</span><span class="n">timeout_sec</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">parent_conn</span><span class="p">.</span><span class="nf">recv</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p</span><span class="p">.</span><span class="nf">terminate</span><span class="p">()</span>
            <span class="n">p</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">raise</span> <span class="nc">TimeoutError</span><span class="p">(</span><span class="sh">"</span><span class="s">sandbox execution timed out</span><span class="sh">"</span><span class="p">)</span>

        <span class="c1"># 여기서 반드시 조인해서 수거
</span>        <span class="n">p</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_alive</span><span class="p">():</span>
            <span class="c1"># 혹시 아직 살아 있으면 강제 종료 후 재조인
</span>            <span class="n">p</span><span class="p">.</span><span class="nf">terminate</span><span class="p">()</span>
            <span class="n">p</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">finally</span><span class="p">:</span>
        <span class="n">parent_conn</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
</code></pre></div></div>

<p>한 줄 요약<br />
return을 먼저 하면 그 아래 코드는 죽은 코드가 된다. 결과를 변수에 담고, 프로세스를 수거(p.join)하고, 핸들들을 닫은 뒤에 return 하도록 순서를 바꿔야 한다.</p>

<p class="chat--user">

수정할 것: conn 불필요한 것 같은데 그냥 subprocess(with 파일/subprocess sendbox)로 실행하고 stdout 메시지랑 stderr 메시지만 있으면 될 것 같아. 단 에러 난 내용에 대해선 좀 더 자세히 나오면 좋겠어. 어떤 파일을 접근하려다 났는지/어떤 커맨드를 하려다 났는지

&lt;p class="chat--user" markdown="1"&gt;

수정할 것: conn 불필요한 것 같은데 그냥 subprocess(with 파일/subprocess sendbox)로 실행하고 stdout 메시지랑 stderr 메시지만 있으면 될 것 같아. 단 에러 난 내용에 대해선 좀 더 자세히 나오면 좋겠어. 어떤 파일을 접근하려다 났는지/어떤 커맨드를 하려다 났는지 또, async를 활용해서 끝날때까지는 await로 하면 좋겠어

</p>

<p>좋아. 파이프(conn) 없이, 별도 파이썬 서브프로세스를 async/await로 실행하고 stdout/stderr만 수집하는 최소 구현을 정리했다. 서브프로세스 안에서는 audit hook으로 “파일 시스템 쓰기”를 WRITE_ROOT 내부로만 제한하고, subprocess/os.system 시도를 차단한다. 에러 메시지는 어떤 파일/커맨드 때문에 막혔는지 자세히 출력된다.</p>

<p>아래 스크립트 하나로 바로 실행해도 되고, run_user_code_async 함수만 가져다 써도 된다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># sandbox_async.py
# Python 3.8+ 필요. 외부 의존성 없음.
</span><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">os</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">tempfile</span><span class="p">,</span> <span class="n">textwrap</span><span class="p">,</span> <span class="n">traceback</span>

<span class="n">CHILD_TEMPLATE</span> <span class="o">=</span> <span class="sa">r</span><span class="sh">"""</span><span class="s">
import os, sys

WRITE_ROOT = os.environ.get(</span><span class="sh">"</span><span class="s">WRITE_ROOT</span><span class="sh">"</span><span class="s">, os.path.abspath(</span><span class="sh">"</span><span class="s">./sandbox</span><span class="sh">"</span><span class="s">))
ALLOW_READ_ANYWHERE = os.environ.get(</span><span class="sh">"</span><span class="s">ALLOW_READ_ANYWHERE</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">1</span><span class="sh">"</span><span class="s">) == </span><span class="sh">"</span><span class="s">1</span><span class="sh">"</span><span class="s">
READ_ALLOW = os.environ.get(</span><span class="sh">"</span><span class="s">READ_ALLOW</span><span class="sh">"</span><span class="s">, </span><span class="sh">""</span><span class="s">)
READ_ALLOW = [os.path.realpath(p) for p in READ_ALLOW.split(os.pathsep) if p]

def _real(p): 
    try: return os.path.realpath(p)
    except Exception: return str(p)

def _in_write_root(p):
    rp = _real(p); wr = _real(WRITE_ROOT)
    return rp == wr or rp.startswith(wr + os.sep)

def _is_read_allowed(p):
    if ALLOW_READ_ANYWHERE: 
        return True
    rp = _real(p)
    if _in_write_root(rp): 
        return True
    return any(rp == r or rp.startswith(r + os.sep) for r in READ_ALLOW)

def _audit(event, args):
    # 파일 열기/생성
    if event in (</span><span class="sh">"</span><span class="s">open</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">os.open</span><span class="sh">"</span><span class="s">):
        path = str(args[0])
        mode = str(args[1]) if len(args) &gt; 1 else </span><span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="s">
        flags = int(args[2]) if len(args) &gt; 2 else 0
        write_intent = any(ch in mode for ch in (</span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">a</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">+</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">x</span><span class="sh">"</span><span class="s">)) or \
            (flags &amp; (os.O_WRONLY | os.O_RDWR | os.O_CREAT | os.O_TRUNC | os.O_APPEND))
        if write_intent and not _in_write_root(path):
            msg = f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event={event} path={_real(path)} mode={mode} flags={flags} reason=write-outside-WRITE_ROOT({WRITE_ROOT})</span><span class="sh">"</span><span class="s">
            print(msg, file=sys.stderr, flush=True)
            raise PermissionError(msg)
        # 선택: 읽기 제한을 두고 싶으면 여기서 검사
        if (not write_intent) and (not _is_read_allowed(path)):
            msg = f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event={event} path={_real(path)} reason=read-not-allowed</span><span class="sh">"</span><span class="s">
            print(msg, file=sys.stderr, flush=True)
            raise PermissionError(msg)

    # 파일 조작류 (경로가 첫 인자에 온다고 가정; rename/replace는 src,dst 둘 다 체크)
    elif event in (</span><span class="sh">"</span><span class="s">os.rename</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">os.replace</span><span class="sh">"</span><span class="s">):
        src = str(args[0]); dst = str(args[1])
        if not (_in_write_root(src) and _in_write_root(dst)):
            msg = f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event={event} src={_real(src)} dst={_real(dst)} reason=op-outside-WRITE_ROOT({WRITE_ROOT})</span><span class="sh">"</span><span class="s">
            print(msg, file=sys.stderr, flush=True)
            raise PermissionError(msg)
    elif event in (</span><span class="sh">"</span><span class="s">os.remove</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">os.unlink</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">os.mkdir</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">os.makedirs</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">os.rmdir</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">os.chmod</span><span class="sh">"</span><span class="s">):
        path = str(args[0])
        if not _in_write_root(path):
            msg = f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event={event} path={_real(path)} reason=op-outside-WRITE_ROOT({WRITE_ROOT})</span><span class="sh">"</span><span class="s">
            print(msg, file=sys.stderr, flush=True)
            raise PermissionError(msg)

    # 서브프로세스/시스템 호출 차단
    elif event.startswith(</span><span class="sh">"</span><span class="s">subprocess.</span><span class="sh">"</span><span class="s">) or event == </span><span class="sh">"</span><span class="s">os.system</span><span class="sh">"</span><span class="s">:
        cmd = None
        try:
            # subprocess.Popen은 첫 인자로 args(커맨드)가 들어오는 경우가 많다
            cmd = args[0]
        except Exception:
            cmd = </span><span class="sh">"</span><span class="s">&lt;unknown&gt;</span><span class="sh">"</span><span class="s">
        msg = f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event={event} cmd={cmd} reason=subprocess-disabled</span><span class="sh">"</span><span class="s">
        print(msg, file=sys.stderr, flush=True)
        raise PermissionError(msg)

    # 네트워크를 막고 싶으면 주석 해제
    # elif event.startswith(</span><span class="sh">"</span><span class="s">socket.</span><span class="sh">"</span><span class="s">):
    #     msg = f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event={event} reason=network-disabled</span><span class="sh">"</span><span class="s">
    #     print(msg, file=sys.stderr, flush=True)
    #     raise PermissionError(msg)

# 설치
sys.addaudithook(_audit)

# 사용자 코드 실행
USER_CODE = r\"\"\"{user_code}\"\"\"
g = {</span><span class="sh">"</span><span class="s">__name__</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="s">}
try:
    exec(USER_CODE, g, g)
except Exception as e:
    # 에러를 자세히 stderr로
    print(</span><span class="sh">"</span><span class="s">[ERROR] exception while executing user code:</span><span class="sh">"</span><span class="s">, file=sys.stderr)
    traceback.print_exc()
    raise
</span><span class="sh">"""</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_user_code_async</span><span class="p">(</span>
    <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">write_root</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">./sandbox</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">allow_read_anywhere</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
    <span class="n">read_allow</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">timeout_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">,</span>
    <span class="n">python_executable</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    user code를 별도 파이썬 서브프로세스에서 실행하고 stdout/stderr만 수집.
    쓰기는 write_root 내부에서만 허용. subprocess/os.system은 차단.
    </span><span class="sh">"""</span>
    <span class="n">write_root</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">write_root</span><span class="p">)</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">write_root</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">py</span> <span class="o">=</span> <span class="n">python_executable</span> <span class="ow">or</span> <span class="n">sys</span><span class="p">.</span><span class="n">executable</span>

    <span class="n">child_code</span> <span class="o">=</span> <span class="n">CHILD_TEMPLATE</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">user_code</span><span class="o">=</span><span class="n">code</span><span class="p">)</span>
    <span class="c1"># 임시 파일에 자식 스크립트 저장
</span>    <span class="k">with</span> <span class="n">tempfile</span><span class="p">.</span><span class="nc">NamedTemporaryFile</span><span class="p">(</span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="sh">"</span><span class="s">.py</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">child_path</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">name</span>
        <span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">child_code</span><span class="p">)</span>

    <span class="c1"># 자식 환경
</span>    <span class="n">env</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">copy</span><span class="p">()</span>
    <span class="n">env</span><span class="p">[</span><span class="sh">"</span><span class="s">WRITE_ROOT</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">write_root</span>
    <span class="n">env</span><span class="p">[</span><span class="sh">"</span><span class="s">ALLOW_READ_ANYWHERE</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">1</span><span class="sh">"</span> <span class="k">if</span> <span class="n">allow_read_anywhere</span> <span class="k">else</span> <span class="sh">"</span><span class="s">0</span><span class="sh">"</span>
    <span class="k">if</span> <span class="n">read_allow</span><span class="p">:</span>
        <span class="n">env</span><span class="p">[</span><span class="sh">"</span><span class="s">READ_ALLOW</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">pathsep</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">read_allow</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_exec</span><span class="p">(</span>
            <span class="n">py</span><span class="p">,</span> <span class="n">child_path</span><span class="p">,</span>
            <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
            <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
            <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="nf">communicate</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout_sec</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
            <span class="n">proc</span><span class="p">.</span><span class="nf">kill</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="nf">wait</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="mi">124</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[TIMEOUT] exceeded </span><span class="si">{</span><span class="n">timeout_sec</span><span class="si">}</span><span class="s">s</span><span class="sh">"</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="n">rc</span> <span class="o">=</span> <span class="n">proc</span><span class="p">.</span><span class="n">returncode</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="n">rc</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="n">stdout</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="n">stderr</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span>
        <span class="p">}</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="p">.</span><span class="nf">unlink</span><span class="p">(</span><span class="n">child_path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

<span class="c1"># 데모
</span><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
        <span class="n">user_code</span> <span class="o">=</span> <span class="sh">"""</span><span class="s">
import os, sys, numpy
print(</span><span class="sh">"</span><span class="s">hello from user code</span><span class="sh">"</span><span class="s">)
# 허용된 쓰기
open(os.path.join(os.environ[</span><span class="sh">'</span><span class="s">WRITE_ROOT</span><span class="sh">'</span><span class="s">], </span><span class="sh">'</span><span class="s">ok.txt</span><span class="sh">'</span><span class="s">), </span><span class="sh">'</span><span class="s">w</span><span class="sh">'</span><span class="s">).write(</span><span class="sh">'</span><span class="s">ok</span><span class="sh">'</span><span class="s">)
# 금지된 쓰기
try:
    open(</span><span class="sh">'</span><span class="s">/etc/forbidden.txt</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">w</span><span class="sh">'</span><span class="s">).write(</span><span class="sh">'</span><span class="s">no</span><span class="sh">'</span><span class="s">)
except Exception as e:
    print(</span><span class="sh">"</span><span class="s">caught:</span><span class="sh">"</span><span class="s">, type(e).__name__)
</span><span class="sh">"""</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">run_user_code_async</span><span class="p">(</span><span class="n">user_code</span><span class="p">,</span> <span class="n">write_root</span><span class="o">=</span><span class="sh">"</span><span class="s">./sandbox</span><span class="sh">"</span><span class="p">,</span> <span class="n">timeout_sec</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">RETURN =</span><span class="sh">"</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">])</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">STDOUT:</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">])</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">STDERR:</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">])</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>핵심 포인트 요약</p>

<ol>
  <li>
    <p>별도 파이썬 프로세스에서 실행하므로 세션 유지가 필요 없을 때 가볍고 안전하다. 세션 유지형이 필요하면 프로세스를 길게 붙잡는 래퍼를 만들면 된다.</p>
  </li>
  <li>
    <p>파일 쓰기는 WRITE_ROOT 내부만 허용. 금지 시도는 stderr에 [AUDIT] 라인으로 이벤트, 경로, 이유가 찍히고 PermissionError를 일으킨다.</p>
  </li>
  <li>
    <p>subprocess/os.system은 차단되고, 차단 사유와 시도한 커맨드를 stderr로 남긴다.</p>
  </li>
  <li>
    <p>await로 결과를 받을 때까지 기다린다. 타임아웃이 나면 returncode 124와 함께 종료한다.</p>
  </li>
  <li>
    <p>읽기는 기본적으로 어디서든 허용하지만, allow_read_anywhere=False로 두고 read_allow 리스트를 주면 읽기도 경로 기반 허용으로 좁힐 수 있다.</p>
  </li>
</ol>

<p>이제 네 에이전트 툴 쪽에서는 이 함수 하나만 감싸서 호출하면 된다. 툴 인자는 code, write_root, timeout 정도만 노출하고, 정책(읽기 허용 범위)은 서버 측에서만 관리해도 깔끔하다.</p>

<p class="chat--user">

추가 구현 요청: read_path(리스트)와 write_path(리스트)를 받도록 하고 싶어. 그리고 시작하는 cwd(Working directory)도 코드 시작할 때 코드랑 같이 입력 하면 좋겠어. 없으면 그냥 None으로 하기. 그런데 cwd를 subprocess 에서 바꿔도 부모 프로세스에는 상관이 없지?

</p>

<p>정리 먼저.</p>

<ul>
  <li>
    <p>요청 반영: read_path(여러 개), write_path(여러 개) 받기, 시작 작업 디렉터리(cwd) 옵션, 비동기(async/await) 실행, 결과는 stdout/stderr만.</p>
  </li>
  <li>
    <p>서브프로세스 안에서 audit hook으로 파일/서브프로세스 시도 감시. 어떤 파일·커맨드 때문에 막혔는지 stderr에 자세히 씀.</p>
  </li>
  <li>
    <p>서브프로세스에서 cwd를 바꿔도 부모 프로세스에는 영향 없다(프로세스마다 현재 디렉터리는 독립).</p>
  </li>
</ul>

<p>아래는 바로 쓸 수 있는 최소 구현이다. 외부 의존성 없음, Python 3.8+.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># sandbox_async_paths.py
</span><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">os</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">tempfile</span>

<span class="n">CHILD_TEMPLATE</span> <span class="o">=</span> <span class="sa">r</span><span class="sh">"""</span><span class="s">
import os, sys, traceback

WRITE_DIRS = [p for p in os.environ.get(</span><span class="sh">"</span><span class="s">WRITE_DIRS</span><span class="sh">"</span><span class="s">,</span><span class="sh">""</span><span class="s">).split(os.pathsep) if p]
READ_DIRS  = [p for p in os.environ.get(</span><span class="sh">"</span><span class="s">READ_DIRS</span><span class="sh">"</span><span class="s">,</span><span class="sh">""</span><span class="s">).split(os.pathsep) if p]
ALLOW_READ_ANYWHERE = os.environ.get(</span><span class="sh">"</span><span class="s">ALLOW_READ_ANYWHERE</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">1</span><span class="sh">"</span><span class="s">) == </span><span class="sh">"</span><span class="s">1</span><span class="sh">"</span><span class="s">

def _real(p):
    try: return os.path.realpath(p)
    except Exception: return str(p)

def _is_under_any(path, roots):
    rp = _real(path)
    for r in roots:
        rr = _real(r)
        if rp == rr or rp.startswith(rr + os.sep):
            return True
    return False

def _audit(event, args):
    try:
        # 파일 열기
        if event in (</span><span class="sh">"</span><span class="s">open</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">os.open</span><span class="sh">"</span><span class="s">):
            path = str(args[0])
            mode = str(args[1]) if len(args) &gt; 1 else </span><span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="s">
            flags = int(args[2]) if len(args) &gt; 2 else 0
            write = any(ch in mode for ch in (</span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">a</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">+</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">x</span><span class="sh">"</span><span class="s">)) or \
                    (flags &amp; (os.O_WRONLY|os.O_RDWR|os.O_CREAT|os.O_TRUNC|os.O_APPEND))
            if write and not _is_under_any(path, WRITE_DIRS):
                msg = f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event={event} path={_real(path)} mode={mode} flags={flags} reason=write-outside-allowed</span><span class="sh">"</span><span class="s">
                print(msg, file=sys.stderr, flush=True)
                raise PermissionError(msg)
            if not write and not ALLOW_READ_ANYWHERE and not _is_under_any(path, READ_DIRS+WRITE_DIRS):
                msg = f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event={event} path={_real(path)} reason=read-not-allowed</span><span class="sh">"</span><span class="s">
                print(msg, file=sys.stderr, flush=True)
                raise PermissionError(msg)

        # 파일 조작류
        elif event in (</span><span class="sh">"</span><span class="s">os.rename</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">os.replace</span><span class="sh">"</span><span class="s">):
            src = str(args[0]); dst = str(args[1])
            if not (_is_under_any(src, WRITE_DIRS) and _is_under_any(dst, WRITE_DIRS)):
                msg = f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event={event} src={_real(src)} dst={_real(dst)} reason=op-outside-allowed</span><span class="sh">"</span><span class="s">
                print(msg, file=sys.stderr, flush=True)
                raise PermissionError(msg)
        elif event in (</span><span class="sh">"</span><span class="s">os.remove</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">os.unlink</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">os.mkdir</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">os.makedirs</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">os.rmdir</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">os.chmod</span><span class="sh">"</span><span class="s">):
            path = str(args[0])
            if not _is_under_any(path, WRITE_DIRS):
                msg = f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event={event} path={_real(path)} reason=op-outside-allowed</span><span class="sh">"</span><span class="s">
                print(msg, file=sys.stderr, flush=True)
                raise PermissionError(msg)

        # 서브프로세스/시스템 호출 차단
        elif event.startswith(</span><span class="sh">"</span><span class="s">subprocess.</span><span class="sh">"</span><span class="s">) or event == </span><span class="sh">"</span><span class="s">os.system</span><span class="sh">"</span><span class="s">:
            cmd = None
            try: cmd = args[0]
            except Exception: cmd = </span><span class="sh">"</span><span class="s">&lt;unknown&gt;</span><span class="sh">"</span><span class="s">
            msg = f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event={event} cmd={cmd} reason=subprocess-disabled</span><span class="sh">"</span><span class="s">
            print(msg, file=sys.stderr, flush=True)
            raise PermissionError(msg)

        # 네트워크를 막고 싶으면 주석 해제
        # elif event.startswith(</span><span class="sh">"</span><span class="s">socket.</span><span class="sh">"</span><span class="s">):
        #     msg = f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event={event} reason=network-disabled</span><span class="sh">"</span><span class="s">
        #     print(msg, file=sys.stderr, flush=True)
        #     raise PermissionError(msg)

    except Exception:
        raise

sys.addaudithook(_audit)

USER_CODE = r\"\"\"{user_code}\"\"\"
g = {</span><span class="sh">"</span><span class="s">__name__</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="s">}
try:
    exec(USER_CODE, g, g)
except Exception:
    print(</span><span class="sh">"</span><span class="s">[ERROR] exception while executing user code:</span><span class="sh">"</span><span class="s">, file=sys.stderr)
    traceback.print_exc()
    raise
</span><span class="sh">"""</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_user_code_async</span><span class="p">(</span>
    <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">read_paths</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">write_paths</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">cwd</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">allow_read_anywhere</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">timeout_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">,</span>
    <span class="n">python_executable</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    별도 파이썬 서브프로세스에서 사용자 코드를 실행한다.
    - read_paths: 읽기 허용 경로 목록(하위 포함). None 또는 []면 읽기 어디든 허용(allow_read_anywhere=True).
    - write_paths: 쓰기 허용 경로 목록(하위 포함). None/[]면 쓰기 전부 차단.
    - cwd: 서브프로세스 시작 작업 디렉터리. None이면 부모의 cwd를 상속. 자식이 바꿔도 부모에는 영향 없음.
    - stdout/stderr를 수집해 반환.
    </span><span class="sh">"""</span>
    <span class="n">py</span> <span class="o">=</span> <span class="n">python_executable</span> <span class="ow">or</span> <span class="n">sys</span><span class="p">.</span><span class="n">executable</span>
    <span class="n">rp</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">(</span><span class="n">read_paths</span> <span class="ow">or</span> <span class="p">[])]</span>
    <span class="n">wp</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">(</span><span class="n">write_paths</span> <span class="ow">or</span> <span class="p">[])]</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">wp</span><span class="p">:</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">allow_read_anywhere</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">allow_read_anywhere</span> <span class="o">=</span> <span class="p">(</span><span class="ow">not</span> <span class="n">rp</span><span class="p">)</span>  <span class="c1"># 읽기 경로 미지정이면 어디든 읽기 허용
</span>
    <span class="n">child_code</span> <span class="o">=</span> <span class="n">CHILD_TEMPLATE</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">user_code</span><span class="o">=</span><span class="n">code</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">tempfile</span><span class="p">.</span><span class="nc">NamedTemporaryFile</span><span class="p">(</span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="sh">"</span><span class="s">.py</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">child_path</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">name</span>
        <span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">child_code</span><span class="p">)</span>

    <span class="n">env</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">copy</span><span class="p">()</span>
    <span class="n">env</span><span class="p">[</span><span class="sh">"</span><span class="s">READ_DIRS</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">pathsep</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">rp</span><span class="p">)</span>
    <span class="n">env</span><span class="p">[</span><span class="sh">"</span><span class="s">WRITE_DIRS</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">pathsep</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>
    <span class="n">env</span><span class="p">[</span><span class="sh">"</span><span class="s">ALLOW_READ_ANYWHERE</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">1</span><span class="sh">"</span> <span class="k">if</span> <span class="n">allow_read_anywhere</span> <span class="k">else</span> <span class="sh">"</span><span class="s">0</span><span class="sh">"</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_exec</span><span class="p">(</span>
            <span class="n">py</span><span class="p">,</span> <span class="n">child_path</span><span class="p">,</span>
            <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
            <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
            <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span>
            <span class="n">cwd</span><span class="o">=</span><span class="n">cwd</span><span class="p">,</span>  <span class="c1"># 자식의 시작 작업 디렉터리. 부모엔 영향 없음.
</span>        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="nf">communicate</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout_sec</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
            <span class="n">proc</span><span class="p">.</span><span class="nf">kill</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="nf">wait</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span><span class="mi">124</span><span class="p">,</span> <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span><span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span><span class="sa">f</span><span class="sh">"</span><span class="s">[TIMEOUT] exceeded </span><span class="si">{</span><span class="n">timeout_sec</span><span class="si">}</span><span class="s">s</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="n">proc</span><span class="p">.</span><span class="n">returncode</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="n">stdout</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="n">stderr</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span>
        <span class="p">}</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span> <span class="n">os</span><span class="p">.</span><span class="nf">unlink</span><span class="p">(</span><span class="n">child_path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="k">pass</span>

<span class="c1"># 데모 실행
</span><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
        <span class="n">code</span> <span class="o">=</span> <span class="sa">r</span><span class="sh">"""</span><span class="s">
import os, sys, subprocess
print(</span><span class="sh">"</span><span class="s">CWD:</span><span class="sh">"</span><span class="s">, os.getcwd())
# 허용된 쓰기
open(os.path.join(</span><span class="sh">"</span><span class="s">out_dir</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">ok.txt</span><span class="sh">"</span><span class="s">), </span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="s">).write(</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="s">)  # 상대경로는 cwd 기준
# 금지된 쓰기
try:
    open(</span><span class="sh">"</span><span class="s">/tmp/blocked.txt</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="s">).write(</span><span class="sh">"</span><span class="s">x</span><span class="sh">"</span><span class="s">)
except Exception as e:
    print(</span><span class="sh">"</span><span class="s">blocked write:</span><span class="sh">"</span><span class="s">, type(e).__name__)
# 서브프로세스 시도
try:
    subprocess.check_output([</span><span class="sh">"</span><span class="s">echo</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">hi</span><span class="sh">"</span><span class="s">])
except Exception as e:
    print(</span><span class="sh">"</span><span class="s">blocked subproc:</span><span class="sh">"</span><span class="s">, type(e).__name__)
# 허용된 읽기(예: read_paths가 지정되었거나 allow_read_anywhere=True인 경우)
print(</span><span class="sh">"</span><span class="s">done</span><span class="sh">"</span><span class="s">)
</span><span class="sh">"""</span>
        <span class="c1"># 예시: cwd를 ./work로, 쓰기는 ./work/out_dir 아래만, 읽기는 어디든 허용
</span>        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="sh">"</span><span class="s">./work/out_dir</span><span class="sh">"</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">run_user_code_async</span><span class="p">(</span>
            <span class="n">code</span><span class="p">,</span>
            <span class="n">read_paths</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>                 <span class="c1"># None → 어디든 읽기 허용
</span>            <span class="n">write_paths</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./work/out_dir</span><span class="sh">"</span><span class="p">],</span>  <span class="c1"># 여기만 쓰기 허용
</span>            <span class="n">cwd</span><span class="o">=</span><span class="sh">"</span><span class="s">./work</span><span class="sh">"</span><span class="p">,</span>                    <span class="c1"># 자식의 시작 CWD
</span>            <span class="n">timeout_sec</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">RC:</span><span class="sh">"</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">])</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">STDOUT:</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">])</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">STDERR:</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">])</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>포인트</p>

<ul>
  <li>
    <p>read_paths와 write_paths는 하위 폴더까지 포함해 허용된다. 쓰기는 write_paths 중 하나에 포함될 때만 통과.</p>
  </li>
  <li>
    <p>read_paths를 지정하지 않으면 allow_read_anywhere=True로 동작해 어디든 읽기 허용(요구가 느슨할 때 편함). 읽기도 제한하려면 read_paths를 지정하고 allow_read_anywhere를 생략하면 자동으로 False로 바뀐다.</p>
  </li>
  <li>
    <p>cwd 인자는 서브프로세스에만 적용된다. 자식이 os.chdir로 바꿔도 부모 프로세스에는 아무 영향 없다.</p>
  </li>
  <li>
    <p>차단 시 stderr에 [AUDIT] 라인으로 이벤트, 경로, 커맨드, 이유를 상세히 남긴다.</p>
  </li>
</ul>

        
      </section>

      <footer class="page__meta">
        
        


  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      <a href="/categories/#llm" class="page__taxonomy-item p-category" rel="tag">llm</a>
    
    </span>
  </p>


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time class="dt-published" datetime="2025-11-05T14:47:56+09:00">2025-11-05</time></p>

      </footer>

      

      
  <nav class="pagination">
    
      <a href="/llm/vllm-pdf/" class="pagination--pager" title="vLLM에 pdf 넣는법">Previous</a>
    
    
      <a href="/2025-08-19-python-repr-vs-str/" class="pagination--pager" title="">Next</a>
    
  </nav>


    </div>

    
  </article>

  
  
    
<div class="page__related">
  
  <h2 class="page__related-title">You may also enjoy</h2>
  <div class="grid__wrapper">
    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/2025-08-19-python-repr-vs-str/" rel="permalink">
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <!-- hvppyarchive: remove date icon
        <i class="far fa-calendar-alt" aria-hidden="true"></i> 
        -->
        
        <time datetime="2025-11-05T14:48:01+09:00">2025-11-05</time>
      </span>
    

    

    
  </p>


    <p class="archive__item-excerpt" itemprop="description">
</p>
  </article>
</div>

    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/llm/vllm-pdf/" rel="permalink">vLLM에 pdf 넣는법
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <!-- hvppyarchive: remove date icon
        <i class="far fa-calendar-alt" aria-hidden="true"></i> 
        -->
        
        <time datetime="2025-11-04T14:13:34+09:00">2025-11-04</time>
      </span>
    

    

    
  </p>


    <p class="archive__item-excerpt" itemprop="description">

</p>
  </article>
</div>

    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/comfyui/comfyui-debug-node-refactor/" rel="permalink">ComfyUI Debug 노드 리팩터링
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <!-- hvppyarchive: remove date icon
        <i class="far fa-calendar-alt" aria-hidden="true"></i> 
        -->
        
        <time datetime="2025-11-04T12:48:12+09:00">2025-11-04</time>
      </span>
    

    

    
  </p>


    <p class="archive__item-excerpt" itemprop="description">

</p>
  </article>
</div>

    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/llm/python-systemfile-tools/" rel="permalink">Python Tool 작성
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <!-- hvppyarchive: remove date icon
        <i class="far fa-calendar-alt" aria-hidden="true"></i> 
        -->
        
        <time datetime="2025-10-31T11:43:50+09:00">2025-10-31</time>
      </span>
    

    

    
  </p>


    <p class="archive__item-excerpt" itemprop="description">

</p>
  </article>
</div>

    
  </div>
</div>

  
  
</div>

      
    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';" role="search">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        

<div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
      
        
      
        
      
        
      
        
      
        
      
    

    
  </ul>
</div>


<div class="page__footer-copyright">&copy; 2013 - 2025 <a href="https://hvppyarchive.github.io">ARCHIVE</a>. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/jekyll-themes/minimal-mistakes/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>






  </body>
</html>
