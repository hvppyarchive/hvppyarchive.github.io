<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.27.1 by Michael Rose
  Copyright 2013-2025 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->

<html lang="en-US" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Python MCP 연결 방법 - ARCHIVE</title>
<meta name="description" content="">


  <meta name="author" content="hvppyarchive">
  
  <meta property="article:author" content="hvppyarchive">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="ARCHIVE">
<meta property="og:title" content="Python MCP 연결 방법">
<meta property="og:url" content="https://hvppyarchive.github.io/llm/unified-mcp-interface/">


  <meta property="og:description" content="">







  <meta property="article:published_time" content="2025-10-28T20:16:40+09:00">





  

  


<link rel="canonical" href="https://hvppyarchive.github.io/llm/unified-mcp-interface/">












<!-- end _includes/seo.html -->


<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
  
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css"></noscript>



    <!-- start custom head snippets -->
<!-- hvppyarchive: add fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@200..900&display=swap" rel="stylesheet">

<!-- insert favicons. use https://realfavicongenerator.net/ -->
 <!-- hvppyarchive: add favicons -->
<link rel="icon" type="image/png" href="/assets/favicon/favicon-96x96.png" sizes="96x96" />
<link rel="icon" type="image/svg+xml" href="/assets/favicon/favicon.svg" />
<link rel="shortcut icon" href="/assets/favicon/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon/apple-touch-icon.png" />
<link rel="manifest" href="/assets/favicon/site.webmanifest" />

<!-- end custom head snippets -->

  </head>

  <body class="layout--single" dir="ltr">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          ARCHIVE
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a
                href="/year-archive/"
                
                
              >Posts</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <i class="fas fa-search"></i>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      





<div id="main" role="main">
  


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Python MCP 연결 방법">
    <meta itemprop="description" content="">
    <meta itemprop="datePublished" content="2025-10-28T20:16:40+09:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">
            <a href="https://hvppyarchive.github.io/llm/unified-mcp-interface/" itemprop="url">Python MCP 연결 방법
</a>
          </h1>
          

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <!-- hvppyarchive: remove date icon
        <i class="far fa-calendar-alt" aria-hidden="true"></i> 
        -->
        
        <time datetime="2025-10-28T20:16:40+09:00">2025-10-28</time>
      </span>
    

    

    
  </p>


        </header>
      

      <section class="page__content" itemprop="text">
        
        <p class="chat--user">

너는 LLM Agent 전문가야. MCP 두 개 이상(이건 입력으로 커맨드를 여러개 받을 수 있어)을 띄우고 모든 MCP 툴을 LLM에게 전달 및 실행하고 싶어. 

</p>

<p>좋아, 여러 개의 MCP 서버를 동시에 붙여서 “모든 MCP 툴을 LLM이 한 번에 보고 실행”하게 만드는 방법을 두 가지 경로로 정리해줄게. 첫째는 Anthropic Messages API의 MCP 커넥터를 그대로 쓰는 방법(가장 간단). 둘째는 직접 MCP 클라이언트를 만들어 여러 서버에 붙고, 툴 카탈로그를 합쳐서 LLM에게 제공하는 방법(커스텀 제어). 단계별로 바로 따라하면 된다. 인용구문은 쓰지 않는다.</p>

<h1 id="1-가장-쉬운-길-claude-messages-api의-mcp-커넥터로-여러-서버-붙이기">1) 가장 쉬운 길: Claude Messages API의 MCP 커넥터로 여러 서버 붙이기</h1>

<p>핵심은 <code class="language-plaintext highlighter-rouge">messages.create</code> 호출에 <code class="language-plaintext highlighter-rouge">mcp_servers</code> 배열을 넣어 여러 서버를 동시에 선언하는 것. 서버마다 이름을 부여하면 충돌 없이 툴을 구분할 수 있고, 모델은 각 서버에서 노출된 MCP 툴을 필요할 때 호출한다. 베타 헤더가 필요하다.</p>

<p>요청 바디 예시(둘 이상의 서버 연결):</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"model"</span><span class="p">:</span><span class="w"> </span><span class="s2">"claude-sonnet-4-5"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"max_tokens"</span><span class="p">:</span><span class="w"> </span><span class="mi">1000</span><span class="p">,</span><span class="w">
  </span><span class="nl">"messages"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"role"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user"</span><span class="p">,</span><span class="w"> </span><span class="nl">"content"</span><span class="p">:</span><span class="w"> </span><span class="s2">"두 서버의 툴을 모두 활용해서 작업을 끝내줘"</span><span class="w"> </span><span class="p">}</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"mcp_servers"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"url"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://mcp.example1.com/sse"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"mcp-server-1"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"authorization_token"</span><span class="p">:</span><span class="w"> </span><span class="s2">"TOKEN1"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"tool_configuration"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"enabled"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"url"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://mcp.example2.com/sse"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"mcp-server-2"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"authorization_token"</span><span class="p">:</span><span class="w"> </span><span class="s2">"TOKEN2"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>이 방식의 포인트</p>

<ol>
  <li>
    <p>한 요청에서 여러 MCP 서버의 툴을 모두 노출할 수 있다.</p>
  </li>
  <li>
    <p>서버 이름(<code class="language-plaintext highlighter-rouge">name</code>)이 툴 호출 블록에 함께 들어가서 충돌을 피한다.</p>
  </li>
  <li>
    <p>현재는 “MCP의 툴 호출”만 지원(리소스/프롬프트 등은 제외)되고, HTTP로 공개된 원격 서버만 직접 연결된다(로컬 stdio는 불가). <a href="https://docs.anthropic.com/en/docs/agents-and-tools/mcp-connector">docs.anthropic.com</a></p>
  </li>
</ol>

<p>문서 근거와 스펙<br />
• MCP 커넥터 사용법과 멀티 서버 예시는 Claude 공식 문서의 “MCP connector”와 “Multiple MCP servers” 섹션에 그대로 있다. <a href="https://docs.anthropic.com/en/docs/agents-and-tools/mcp-connector">docs.anthropic.com</a><br />
• MCP 자체 개념과 스펙은 프로토콜 사이트와 스펙 문서 참고. <a href="https://modelcontextprotocol.io/?utm_source=chatgpt.com">모델 컨텍스트 프로토콜+1</a></p>

<p>이 경로로 가면 “LLM에게 MCP 툴 전체를 그대로 전달하고, 실행은 모델이 알아서 서버별로 라우팅”해준다. 운영에서 OAuth 토큰이 필요한 서버는 <code class="language-plaintext highlighter-rouge">authorization_token</code> 필드로 전달하면 된다. <a href="https://docs.anthropic.com/en/docs/agents-and-tools/mcp-connector">docs.anthropic.com</a></p>

<h1 id="2-더-유연한-길-직접-mcp-클라이언트를-만들어-멀티-서버--단일-툴-레지스트리로-합치기">2) 더 유연한 길: 직접 MCP 클라이언트를 만들어 “멀티 서버 → 단일 툴 레지스트리”로 합치기</h1>

<p>로컬/사내용 툴까지 다 엮고 싶거나, 툴 노출/로그/권한을 섬세하게 통제하려면 직접 클라이언트를 만드는 편이 좋다. 공식 SDK가 있다(타입스크립트, 파이썬 등). <a href="https://github.com/modelcontextprotocol/typescript-sdk">GitHub+1</a></p>

<p>아키텍처 개요</p>

<ol>
  <li>
    <p>각 MCP 서버와 별도의 세션으로 연결(stdio 또는 HTTP).</p>
  </li>
  <li>
    <p>모든 서버에서 <code class="language-plaintext highlighter-rouge">list_tools</code>를 받아 합친다. 이때 충돌을 막기 위해 <code class="language-plaintext highlighter-rouge">serverName:toolName</code> 같은 네임스페이스를 붙인다.</p>
  </li>
  <li>
    <p>합쳐진 툴 목록을 LLM의 “도구(Function/Tool Use)”로 등록한다.</p>
  </li>
  <li>
    <p>LLM이 <code class="language-plaintext highlighter-rouge">serverName:toolName</code>을 호출하면, 해당 서버 세션으로 라우팅해서 <code class="language-plaintext highlighter-rouge">call_tool</code> 실행 → 결과를 모델에 <code class="language-plaintext highlighter-rouge">tool_result</code>로 되돌린다.</p>
  </li>
</ol>

<p>예시 코드(타입스크립트, Node). 여러 서버에서 툴을 모아 네임스페이스화하고, 호출 시 라우팅한다. SDK는 공식 TS SDK를 사용한다. <a href="https://github.com/modelcontextprotocol/typescript-sdk">GitHub</a></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ts

// package.json: @modelcontextprotocol/sdk, zod, anthropic 등 설치 가정
// npm i @modelcontextprotocol/sdk zod anthropic

import { ClientSession } from '@modelcontextprotocol/sdk/client/session.js';
import { StdioClientTransport, StdioServerParameters } from '@modelcontextprotocol/sdk/client/stdio.js';
import Anthropic from '@anthropic-ai/sdk';

// 서버 설정
type ServerCfg = { name: string; command: string; args: string[] };
const SERVERS: ServerCfg[] = [
  { name: 'files', command: 'node', args: ['./servers/files/index.js'] },
  { name: 'db', command: 'python', args: ['./servers/db/server.py'] },
];

type Connected = {
  name: string;
  session: ClientSession;
};

const connected: Connected[] = [];

async function connectAll() {
  for (const s of SERVERS) {
    const params: StdioServerParameters = { command: s.command, args: s.args };
    const transport = new StdioClientTransport(params);
    await transport.start();
    const session = new ClientSession(transport);
    await session.initialize();
    connected.push({ name: s.name, session });
    console.log(`[MCP] connected: ${s.name}`);
  }
}

type ToolDesc = {
  name: string;              // namespaced: `${server}:${tool}`
  description?: string;
  input_schema: any;         // JSON Schema
};

// 모든 서버의 툴을 수집하여 네임스페이스 부여
async function collectTools(): Promise&lt;ToolDesc[]&gt; {
  const all: ToolDesc[] = [];
  for (const { name: serverName, session } of connected) {
    const { tools } = await session.listTools();
    for (const t of tools) {
      all.push({
        name: `${serverName}:${t.name}`,
        description: t.description,
        input_schema: t.inputSchema,
      });
    }
  }
  return all;
}

// LLM이 namespaced 툴을 호출하면 해당 서버로 라우팅
async function callNamespacedTool(nsName: string, args: any) {
  const [serverName, toolName] = nsName.split(':');
  const target = connected.find(c =&gt; c.name === serverName);
  if (!target) throw new Error(`Server not found: ${serverName}`);
  return target.session.callTool(toolName, args);
}

async function main() {
  await connectAll();
  const tools = await collectTools();

  const anthropic = new Anthropic({ apiKey: process.env.ANTHROPIC_API_KEY! });

  // 대화 루프의 한 턴 예시
  let messages: any[] = [{ role: 'user', content: 'CSV를 DB에 적재하고 요약해줘' }];

  // Anthropic의 Tool Use 포맷에 맞춰 툴 전달
  const toolDefs = tools.map(t =&gt; ({
    name: t.name,
    description: t.description,
    input_schema: t.input_schema,
  }));

  let resp = await anthropic.messages.create({
    model: 'claude-3-5-sonnet-20241022',
    max_tokens: 1000,
    messages,
    tools: toolDefs,
  });

  // tool_use 처리 루프
  while (resp.content.some((c: any) =&gt; c.type === 'tool_use')) {
    const assistantContent: any[] = [];
    const toolResults: any[] = [];

    for (const c of resp.content) {
      if (c.type === 'text') assistantContent.push(c);
      if (c.type === 'tool_use') {
        const result = await callNamespacedTool(c.name, c.input);
        toolResults.push({
          type: 'tool_result',
          tool_use_id: c.id,
          content: result.content, // MCP 표준 content 배열
        });
      }
    }

    messages.push({ role: 'assistant', content: assistantContent.concat(resp.content.filter((c: any) =&gt; c.type === 'tool_use')) });
    messages.push({ role: 'user', content: toolResults });

    resp = await anthropic.messages.create({
      model: 'claude-3-5-sonnet-20241022',
      max_tokens: 1000,
      messages,
      tools: toolDefs,
    });
  }

  console.log(resp.content.map((c: any) =&gt; (c.type === 'text' ? c.text : '')).join('\n'));
}

main().catch(e =&gt; { console.error(e); process.exit(1); });
</code></pre></div></div>

<p>이 패턴의 장점<br />
• 어떤 LLM이든(Anthropic/OpenAI/로컬) 표준 “툴 호출” 인터페이스만 있으면 같은 레지스트리를 재활용할 수 있다.<br />
• 서버별 권한, 로깅, 레이트 리밋, 입력 검증을 중앙에서 통제 가능.<br />
• 네임스페이스 전략으로 툴 이름 충돌을 확실히 방지.<br />
• stdio 로컬 서버와 원격 HTTP 서버를 섞어서 붙일 수 있다(직접 클라이언트 방식이므로). SDK가 stdio/HTTP 모두 지원한다. <a href="https://github.com/modelcontextprotocol/typescript-sdk">GitHub</a></p>

<p>설치·참고<br />
• 공식 TS SDK와 예제 서버/클라이언트, Streamable HTTP/stdio 전송계층은 깃허브 README와 예제에 상세. <a href="https://github.com/modelcontextprotocol/typescript-sdk">GitHub</a><br />
• “Build an MCP client” 튜토리얼(파이썬/노드 포함)도 멀티 서버로 확장하기 쉽다. 위 예시 로직은 그 흐름을 일반화한 것. <a href="https://modelcontextprotocol.io/quickstart/client">모델 컨텍스트 프로토콜</a></p>

<h1 id="운영-팁과-함정실무-체크리스트">운영 팁과 함정(실무 체크리스트)</h1>

<p>네임스페이스 규칙<br />
• <code class="language-plaintext highlighter-rouge">${server}:${tool}</code>로 고정하면 라우팅이 단순해진다. 툴 설명에도 서버명을 적어 LLM의 선택을 돕는다.<br />
• 모델이 “비슷한 두 툴”을 혼동할 수 있으니 설명에 차이를 명확히 쓰고 스키마에 제약을 넣는다.</p>

<p>권한과 안전장치<br />
• 서버별 <code class="language-plaintext highlighter-rouge">allowed_tools</code>로 노출 툴을 제한하거나, 자체 클라이언트라면 툴 화이트리스트를 적용한다. <a href="https://docs.anthropic.com/en/docs/agents-and-tools/mcp-connector">docs.anthropic.com</a><br />
• 파괴적 툴(삭제/결제 등)은 “dry_run” 플래그를 스키마에 추가해 2단계 확인을 강제.<br />
• 프롬프트 인젝션 방지: 서버 측에서 입력 검증과 URL/경로 화이트리스트를 둔다.</p>

<p>성능/안정성<br />
• 초기에 모든 서버에 <code class="language-plaintext highlighter-rouge">list_tools</code>를 한 번만 호출하고 캐싱하라.<br />
• 툴 호출은 타임아웃과 재시도를 둔다. 실패 시 에러 메시지와 복구 힌트를 모델에게 짧게 제공하면 후속 계획을 모델이 스스로 조정한다.<br />
• 결과가 큰 경우(파일/표)는 리소스 링크를 반환하도록 MCP 쪽에서 설계하면 토큰 압박을 줄일 수 있다(리소스는 커넥터 경로에 따라 제한될 수 있음).</p>

<p>배포 토막 가이드<br />
• 원격 연결 위주면 Claude의 MCP 커넥터가 가장 빠른 온보딩이다(단, HTTP 공개 필요). <a href="https://docs.anthropic.com/en/docs/agents-and-tools/mcp-connector">docs.anthropic.com</a><br />
• 사내망·로컬 혼합이면 직접 클라이언트 구성이 유리하다. TS SDK의 streamable HTTP + stdio를 혼용하면 된다. <a href="https://github.com/modelcontextprotocol/typescript-sdk">GitHub</a></p>

<p>다음 확장 아이디어<br />
• “자동 라우터”: 툴 메타데이터에 domain 태그를 두고, 사용자 요청을 분류해 관련 서버 툴만 모델에 노출(토큰/혼란 감소).<br />
• “관측성”: 모든 tool_use/tool_result를 이벤트로 로그 수집해 실패율/지연/입력 분포를 대시보드로 본다.<br />
• “권한 승격”: 고위험 툴 호출은 사람 확인을 요구하는 인가 훅을 중앙 클라이언트에 추가.</p>

<p>원하면 네가 쓰려는 서버 목록과 전송 방식(stdio/HTTP), 붙일 모델(Claude/OpenAI 등)을 알려줘. 거기에 맞춰 완성 스캐폴딩을 바로 내줄게.</p>

<p class="chat--user">

타입스크립트 말고 파이썬 mcp 로 부탁해 그리고 커스텀 엔드포인트 LLM을 사용할거야.

</p>

<p>좋아. 파이썬으로 MCP 다중 서버를 붙이고, 커스텀 LLM 엔드포인트(자체 호스팅 모델)에 “툴 콜링”을 돌리는 전체 오케스트레이터 스캐폴딩을 바로 줄게. 핵심 아이디어는 두 가지다. 첫째, 여러 MCP 서버에 각각 세션을 열고 툴 목록을 합쳐서 네임스페이스(server:tool)로 노출. 둘째, 커스텀 LLM의 /chat API에 툴 스키마를 전달하고, 응답 내 tool_calls를 받아 해당 MCP 서버로 라우팅해 실행 결과를 다시 모델에 피드백하는 루프를 돈다.</p>

<p>아래 코드는 바로 실행 가능한 단일 파일 예시다. 커스텀 LLM의 API 포맷은 OpenAI 함수콜과 유사한 형태를 가정했지만, 클래스 한 군데만 바꾸면 어떤 엔드포인트든 맞출 수 있도록 어댑터를 분리해두었다.</p>

<p>설치 가정<br />
pip install mcp requests pydantic orjson</p>

<p>main.py</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">import</span> <span class="n">orjson</span>
<span class="kn">import</span> <span class="n">requests</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>

<span class="c1"># MCP Python SDK
</span><span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>
<span class="k">try</span><span class="p">:</span>
    <span class="c1"># 선택: SSE(원격 HTTP) 서버를 붙일 때
</span>    <span class="kn">from</span> <span class="n">mcp.client.sse</span> <span class="kn">import</span> <span class="n">SSEClientTransport</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">False</span>

<span class="c1">#######################################################################
# 0) 데이터 모델: LLM과 툴콜 인터페이스(커스텀 엔드포인트 어댑터용)
#######################################################################
</span>
<span class="k">class</span> <span class="nc">ChatMessage</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">role</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span> <span class="nc">ToolDef</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="c1"># OpenAI style에 가깝게 노멀라이즈해 커스텀 LLM에 전달
</span>    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span>
    <span class="n">function</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># {name, description, parameters(JSON Schema)}
</span>
<span class="k">class</span> <span class="nc">ToolCall</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span>
    <span class="n">function</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># {name, arguments(JSON str)}
</span>
<span class="k">class</span> <span class="nc">ChatResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span>
    <span class="n">tool_calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolCall</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="c1"># 필요 시 stop_reason 등 추가
</span>
<span class="c1">#######################################################################
# 1) MCP 연결 유틸: 여러 서버 연결하고 툴 합치기(네임스페이스)
#######################################################################
</span>
<span class="k">class</span> <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="c1"># stdio 또는 sse
</span>    <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># "stdio" | "sse"
</span>    <span class="c1"># stdio
</span>    <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c1"># sse
</span>    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">class</span> <span class="nc">ConnectedServer</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span>

<span class="k">class</span> <span class="nc">MCPMux</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">servers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPServerCfg</span><span class="p">]):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_servers_cfg</span> <span class="o">=</span> <span class="n">servers</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ConnectedServer</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">connect_all</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_servers_cfg</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">params</span> <span class="o">=</span> <span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">args</span> <span class="ow">or</span> <span class="p">[])</span>
                <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
                <span class="n">session</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">HAVE_SSE</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">mcp.client.sse 모듈이 설치되어야 SSE 연결을 사용할 수 있습니다.</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">transport</span> <span class="o">=</span> <span class="nc">SSEClientTransport</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">headers</span> <span class="ow">or</span> <span class="p">{})</span>
                <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
                <span class="n">session</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">unknown server kind: </span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ConnectedServer</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">))</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">list_tools</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">merged</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">srv</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span>
            <span class="n">tools_resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">srv</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools_resp</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
                <span class="c1"># t.name, t.description, t.input_schema
</span>                <span class="n">merged</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">server</span><span class="sh">"</span><span class="p">:</span> <span class="n">srv</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>  <span class="c1"># JSON Schema
</span>                <span class="p">})</span>
        <span class="k">return</span> <span class="n">merged</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">namespaced</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="c1"># namespaced = "server:tool"
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">server_name</span><span class="p">,</span> <span class="n">tool_name</span> <span class="o">=</span> <span class="n">namespaced</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">툴 이름은 </span><span class="sh">'</span><span class="s">server:tool</span><span class="sh">'</span><span class="s"> 형식이어야 합니다: </span><span class="si">{</span><span class="n">namespaced</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">srv</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">srv</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">server_name</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">srv</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">tool_name</span><span class="p">,</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{})</span>
                <span class="c1"># MCP 표준 content를 단일 문자열 또는 JSON으로 정리
</span>                <span class="c1"># MCP content는 list of {type: "text"|"json"|"blob", ...}
</span>                <span class="c1"># 여기서는 간단히 text/json만 지원 예시
</span>                <span class="n">packed</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">result</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">text</span><span class="p">})</span>
                    <span class="k">elif</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">json</span><span class="p">})</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># blob/resource 등은 필요 시 확장
</span>                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span><span class="p">})</span>
                <span class="k">return</span> <span class="n">packed</span>
        <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">서버를 찾을 수 없음: </span><span class="si">{</span><span class="n">server_name</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1">#######################################################################
# 2) 커스텀 LLM 어댑터: 너의 사설 /chat 엔드포인트에 맞춰 조정
#######################################################################
</span>
<span class="k">class</span> <span class="nc">CustomLLMClient</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    너의 커스텀 엔드포인트 규약을 한 곳에 캡슐화.
    아래는 예시 규약:
      POST {base_url}/chat
      json: {
        </span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="s">,
        </span><span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="s">: [{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="s">}],
        </span><span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="s">: [{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">:{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="s">:..., </span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="s">:..., </span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="s">:{...}}}]
      }
    응답:
      {
        </span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">assistant text...</span><span class="sh">"</span><span class="s">,
        </span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="s">: [
          {</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">:{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">server:tool</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">{</span><span class="se">\"</span><span class="s">k</span><span class="se">\"</span><span class="s">:</span><span class="se">\"</span><span class="s">v</span><span class="se">\"</span><span class="s">}</span><span class="sh">"</span><span class="s">}}
        ]
      }
    필요한 경우 이 클래스만 수정하면 된다.
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">extra_headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">self</span><span class="p">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="n">self</span><span class="p">.</span><span class="n">extra_headers</span> <span class="o">=</span> <span class="n">extra_headers</span> <span class="ow">or</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_headers</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="n">h</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content-type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="p">:</span>
            <span class="n">h</span><span class="p">[</span><span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Bearer </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">h</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">extra_headers</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">h</span>

    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ChatResponse</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">m</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">t</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">]</span> <span class="k">if</span> <span class="n">tools</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="p">}</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">base_url</span><span class="si">}</span><span class="s">/chat</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="nf">_headers</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
        <span class="n">r</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
        <span class="k">return</span> <span class="nc">ChatResponse</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">)</span>

<span class="c1">#######################################################################
# 3) 오케스트레이터: 툴 병합 → LLM 대화 루프 → MCP 라우팅
#######################################################################
</span>
<span class="k">def</span> <span class="nf">to_llm_tools</span><span class="p">(</span><span class="n">merged_tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]:</span>
    <span class="n">defs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">merged_tools</span><span class="p">:</span>
        <span class="n">namespaced</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">t</span><span class="p">[</span><span class="sh">'</span><span class="s">server</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">t</span><span class="p">[</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">namespaced</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="sa">f</span><span class="sh">"</span><span class="s">MCP tool </span><span class="si">{</span><span class="n">namespaced</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}}</span>
        <span class="p">}</span>
        <span class="n">defs</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ToolDef</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="n">fn</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">defs</span>

<span class="k">def</span> <span class="nf">coerce_arguments</span><span class="p">(</span><span class="n">args_raw</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">args_raw</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args_raw</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">args_raw</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args_raw</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">args_raw</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span> <span class="o">==</span> <span class="sh">""</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args_raw</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="c1"># 모델이 JSON이 아닌 걸 내는 경우 방어
</span>            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">args_raw</span><span class="p">}</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">args_raw</span><span class="p">}</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_conversation</span><span class="p">(</span>
    <span class="n">mux</span><span class="p">:</span> <span class="n">MCPMux</span><span class="p">,</span>
    <span class="n">llm</span><span class="p">:</span> <span class="n">CustomLLMClient</span><span class="p">,</span>
    <span class="n">user_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">system_prompt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">max_rounds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span>
<span class="p">):</span>
    <span class="n">tools_catalog</span> <span class="o">=</span> <span class="k">await</span> <span class="n">mux</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
    <span class="n">llm_tools</span> <span class="o">=</span> <span class="nf">to_llm_tools</span><span class="p">(</span><span class="n">tools_catalog</span><span class="p">)</span>

    <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">system_prompt</span><span class="p">:</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">system_prompt</span><span class="p">))</span>
    <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">user_prompt</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">max_rounds</span><span class="p">):</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">llm</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">llm_tools</span><span class="p">)</span>
        <span class="c1"># 우선 어시스턴트 텍스트가 있으면 추가
</span>        <span class="n">assistant_text</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span>
        <span class="k">if</span> <span class="n">assistant_text</span><span class="p">:</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">assistant_text</span><span class="p">))</span>

        <span class="c1"># 툴콜 없으면 종료
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">resp</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="c1"># MCP 라우팅 → 결과를 tool_result로 user에 피드백
</span>        <span class="n">tool_results_acc</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="nf">coerce_arguments</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">mux</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                <span class="c1"># 결과를 다시 모델에게 피드백: 단순화를 위해 JSON 텍스트로 합침
</span>                <span class="n">tool_results_acc</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">tool_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="n">result</span>
                <span class="p">}).</span><span class="nf">decode</span><span class="p">())</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">tool_results_acc</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">tool_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="p">}).</span><span class="nf">decode</span><span class="p">())</span>

        <span class="c1"># 다수 툴 호출 결과를 하나의 user 메시지로 재주입
</span>        <span class="n">feedback_text</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">tool_results_acc</span><span class="p">)</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="s">TOOL_RESULTS</span><span class="se">\n</span><span class="si">{</span><span class="n">feedback_text</span><span class="si">}</span><span class="sh">"</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">messages</span>

<span class="c1">#######################################################################
# 4) 샘플 엔트리포인트
#######################################################################
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># 4-1) 붙일 MCP 서버들 정의
</span>    <span class="n">servers</span> <span class="o">=</span> <span class="p">[</span>
        <span class="c1"># 로컬 stdio 예시
</span>        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">node</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./servers/files/index.js</span><span class="sh">"</span><span class="p">]),</span>
        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">db</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">python</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./servers/db/server.py</span><span class="sh">"</span><span class="p">]),</span>
        <span class="c1"># 원격 SSE 예시(있다면)
</span>        <span class="c1"># MCPServerCfg(name="search", kind="sse", url="https://mcp.example.com/sse", headers={"authorization":"Bearer X"}),
</span>    <span class="p">]</span>

    <span class="n">mux</span> <span class="o">=</span> <span class="nc">MCPMux</span><span class="p">(</span><span class="n">servers</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">mux</span><span class="p">.</span><span class="nf">connect_all</span><span class="p">()</span>

    <span class="c1"># 4-2) 커스텀 LLM 엔드포인트 설정
</span>    <span class="n">llm</span> <span class="o">=</span> <span class="nc">CustomLLMClient</span><span class="p">(</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">LLM_BASE_URL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">http://localhost:8000</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">model</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">LLM_MODEL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">LLM_API_KEY</span><span class="sh">"</span><span class="p">),</span>            <span class="c1"># 필요 시
</span>        <span class="n">extra_headers</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">x-tenant</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">demo</span><span class="sh">"</span><span class="p">}</span>                 <span class="c1"># 필요 시
</span>    <span class="p">)</span>

    <span class="c1"># 4-3) 대화 한 턴 예시
</span>    <span class="n">system</span> <span class="o">=</span> <span class="sh">"</span><span class="s">너는 MCP 툴을 활용해 일을 끝내는 에이전트다. 위험 작업은 dry_run을 선호하고, 명시적으로 승인받기 전에는 파괴적 변경을 하지 않는다.</span><span class="sh">"</span>
    <span class="n">user</span> <span class="o">=</span> <span class="sh">"</span><span class="s">CSV를 files 서버의 ingest_csv 툴로 적재하고, db 서버의 sql_summary로 요약해줘. 파일 경로는 ./data/sales.csv</span><span class="sh">"</span>

    <span class="n">messages</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">run_conversation</span><span class="p">(</span><span class="n">mux</span><span class="p">,</span> <span class="n">llm</span><span class="p">,</span> <span class="n">user_prompt</span><span class="o">=</span><span class="n">user</span><span class="p">,</span> <span class="n">system_prompt</span><span class="o">=</span><span class="n">system</span><span class="p">,</span> <span class="n">max_rounds</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=== 최종 대화 로그 ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[</span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">role</span><span class="si">}</span><span class="s">] </span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">content</span><span class="p">[</span><span class="si">:</span><span class="mi">2000</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>동작 흐름 설명<br />
1단계. MCPMux가 각 서버에 세션을 연다. stdio 서버는 command+args로 프로세스를 실행하고, sse 서버는 HTTP SSE로 연결한다.<br />
2단계. list_tools를 모든 서버에서 모아서 네임스페이스(server:tool)로 변환한다.<br />
3단계. 커스텀 LLM 엔드포인트에 messages와 tools를 넘긴다. tools는 OpenAI식 function 포맷으로 정규화해서 전달한다.<br />
4단계. LLM이 tool_calls를 반환하면, 각 call의 function.name이 server:tool이므로 해당 서버로 라우팅해서 call_tool을 실행한다.<br />
5단계. 결과를 TOOL_RESULTS 텍스트로 user 역할 메시지에 합쳐서 모델에 다시 주입한다. 모델은 추가적인 tool_calls를 내거나, 최종 답변을 낸다.<br />
6단계. tool_calls가 더 이상 없으면 루프 종료.</p>

<p>운영 팁<br />
네임스페이스 고정. server:tool 네이밍을 스키마 description에도 반복해서 LLM의 선택 오류를 줄인다.<br />
권한 경계. 삭제·결제·배포 같은 툴에는 parameters에 dry_run(boolean, default true) 같은 필드를 추가해 2단계 승인을 유도하라.<br />
타임아웃·재시도. SSE나 stdio 모두 외부 프로세스/네트워크에 민감하니 call_tool에는 서버 측 타임아웃과 재시도를 둔다. 필요 시 MCPMux.call에 재시도를 추가하라.<br />
대용량 결과. 파일·표·바이너리 결과는 MCP 리소스(파일 핸들)나 외부 저장소 URL을 반환하고, LLM에는 메타데이터만 보내 토큰을 아끼는 설계를 추천한다.<br />
적응층. CustomLLMClient를 너의 실제 /chat 규격에 맞게 수정한다. 예컨대 문서화된 JSON 키 이름이 다르면 ChatResponse 파싱만 바꾸면 된다.</p>

<p>테스트 방법<br />
가짜 서버부터. servers 디렉터리에 echo 수준의 간단한 MCP 서버 두 개(files, db)를 만들어 list_tools와 call_tool만 최소 구현한다.<br />
단위 테스트. CustomLLMClient.send를 모킹해 tool_calls를 강제로 내보내고, MCPMux.call이 올바른 서버로 라우팅되는지 확인한다.<br />
엔드투엔드. 실제 LLM 엔드포인트로 교체해 CSV → SQL 요약 같은 워크플로를 한 번에 돌려본다.</p>

<p>확장 아이디어<br />
자동 라우팅. 도메인 태그(files/db/search 등)를 보고 관련 툴만 tools 배열에 노출해 토큰과 혼란을 줄인다.<br />
감사 로그. 모든 tool_call 입력·출력을 JSONL로 파일에 적재해 지연, 실패율, 위험 호출을 모니터링한다.<br />
휴먼 게이트. 위험한 툴콜이 감지되면 CustomLLMClient로 바로 보내지 말고, 별도 승인 UI 혹은 CLI에서 1회 승인 후 재주입한다.</p>

<p>원하는 /chat 규격(JSON 예시 스펙)이나 실제 엔드포인트 샘플을 알려주면, 위 어댑터를 거기에 딱 맞춰 구체화해서 리라이트해줄 수 있다.</p>

<p class="chat--user">

질문이 있어. 1. 그냥 툴을 그대로 보내면 오류가 더 많을까? 2. 일반 툴 콜링과 섞여 있는 예시도 보여주면 좋겠어. 

</p>

<p>좋아, 두 가지 모두 딱 꽂히게 정리해줄게. 결론 먼저, 그다음 바로 실행 가능한 파이썬 예시로 마무리한다.</p>

<ol>
  <li>그냥 “서버에서 받은 툴을 전부” 모델에 그대로 보여주면 오류가 더 많을까?<br />
짧은 답: 보통 그렇다. 이유는 예측 가능하다.</li>
</ol>

<ul>
  <li>
    <p>과적재(too many tools). 툴이 많아질수록 선택 오류가 늘고, 모델이 비슷한 툴을 혼동한다. 비슷한 이름, 비슷한 설명은 특히 위험하다.</p>
  </li>
  <li>
    <p>스키마 느슨함. parameters(JSON Schema)에 타입·필수 필드·enum 제약이 약하면 arguments 형식 오류가 증가한다.</p>
  </li>
  <li>
    <p>문맥 미스매치. 현재 턴과 관계없는 툴까지 모두 보이면 “근처에 있는 도구” 편향 때문에 엉뚱한 걸 집는다.</p>
  </li>
  <li>
    <p>네임 충돌·의도 충돌. 서로 다른 서버에 같은 이름, 유사 기능이 있으면 라우팅·선택 모두 흔들린다.</p>
  </li>
  <li>
    <p>부작용 위험. 삭제/결제/배포 같은 툴을 아무 맥락 없이 노출하면 모델이 성급히 실행하려 한다(모델은 과감하다).</p>
  </li>
  <li>
    <p>레이턴시·실패 전파. 원격/SSE 툴 다수는 타임아웃과 429가 뒤섞여 에러 증폭을 만든다.</p>
  </li>
</ul>

<p>현업에서 에러를 줄이는 실전 처방</p>

<ul>
  <li>
    <p>턴별 툴 소출(Selective exposure). 유저 입력을 기준으로 관련 서버/도메인의 툴만 노출한다. 단순 키워드 라우팅만 넣어도 실패율이 뚝 떨어진다.</p>
  </li>
  <li>
    <p>네임스페이스 필수. server:tool 이름으로 고정하고, description에도 서버/도메인을 반복 명시한다.</p>
  </li>
  <li>
    <p>스키마를 엄격하게. type/enum/minItems/format까지 빡빡하게 걸어라. 가능하면 예제(example) 필드까지 넣는다.</p>
  </li>
  <li>
    <p>고위험 툴에 세이프티 플래그. dry_run 기본값 true, confirmation string 같은 이중 잠금.</p>
  </li>
  <li>
    <p>응답 정규화. MCP tool_result를 항상 같은 JSON 포맷으로 묶어 모델에 재주입해 학습된 기대 형태를 유지한다.</p>
  </li>
  <li>
    <p>타임아웃/재시도/백오프 표준화. 서버별 기본값이 달라도 클라이언트에서 상한을 통일한다.</p>
  </li>
  <li>
    <p>툴 캡. 한 턴에 최대 10~20개 정도만 노출(경험상 8~12에서 가장 안정적).</p>
  </li>
</ul>

<ol>
  <li>“일반 툴 콜링”과 “MCP 툴 콜링”이 섞여 있는 예시<br />
아래는 이전 파이썬 스캐폴딩을 얇게 확장한 버전이다. 핵심은 디스패처에 로컬(일반) 툴 네임스페이스 local.* 를 추가하고, LLM이 같은 턴에서 local.* 과 server:tool(MCP)을 섞어서 호출해도 자연스럽게 라우팅되는 구조다.</li>
</ol>

<p>필요 패키지<br />
pip install mcp requests pydantic orjson</p>

<p>mixed_tools.py</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">import</span> <span class="n">orjson</span>
<span class="kn">import</span> <span class="n">requests</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>

<span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>

<span class="c1"># ======== 공용 데이터 모델 ========
</span>
<span class="k">class</span> <span class="nc">ChatMessage</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">role</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span> <span class="nc">ToolDef</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span>
    <span class="n">function</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">ToolCall</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span>
    <span class="n">function</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">ChatResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span>
    <span class="n">tool_calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolCall</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

<span class="c1"># ======== MCP 멀티 서버 MUX ========
</span>
<span class="k">class</span> <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">command</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">ConnectedServer</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span>

<span class="k">class</span> <span class="nc">MCPMux</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">servers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPServerCfg</span><span class="p">]):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cfgs</span> <span class="o">=</span> <span class="n">servers</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ConnectedServer</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">connect_all</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_cfgs</span><span class="p">:</span>
            <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">args</span><span class="p">))</span>
            <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
            <span class="n">sess</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">sess</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ConnectedServer</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">sess</span><span class="p">))</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">list_tools</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">merged</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">srv</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span>
            <span class="n">tools</span> <span class="o">=</span> <span class="k">await</span> <span class="n">srv</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
                <span class="n">merged</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">server</span><span class="sh">"</span><span class="p">:</span> <span class="n">srv</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">MCP </span><span class="si">{</span><span class="n">srv</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">),</span>
                    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">})</span>
                <span class="p">})</span>
        <span class="k">return</span> <span class="n">merged</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">namespaced</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">server</span><span class="p">,</span> <span class="n">tool</span> <span class="o">=</span> <span class="n">namespaced</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">srv</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">srv</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">server</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">srv</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{})</span>
                <span class="n">packed</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">res</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">text</span><span class="p">})</span>
                    <span class="k">elif</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">json</span><span class="p">})</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span><span class="p">})</span>
                <span class="k">return</span> <span class="n">packed</span>
        <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">unknown server </span><span class="si">{</span><span class="n">server</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># ======== 로컬(일반) 툴: 예시 구현 ========
</span>
<span class="k">def</span> <span class="nf">local_tools_catalog</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">안전한 사칙연산/간단식 평가기. 입력: {expr: string}</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">local.top_k_keywords</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">텍스트에서 자주 등장하는 단어 상위 K를 뽑아준다. 입력: {text: string, k: integer}</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">},</span>
                    <span class="sh">"</span><span class="s">k</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">integer</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">minimum</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="sh">"</span><span class="s">maximum</span><span class="sh">"</span><span class="p">:</span> <span class="mi">50</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">k</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">]</span>

<span class="k">def</span> <span class="nf">run_local_tool</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">:</span>
        <span class="c1"># 아주 보수적인 계산기(숫자, + - * / () 만 허용)
</span>        <span class="n">expr</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">expr</span> <span class="k">if</span> <span class="n">ch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="sh">"</span><span class="s">0123456789+-*/(). </span><span class="sh">"</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">expr must contain only digits and + - * / ( )</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nf">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">__builtins__</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}},</span> <span class="p">{})</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span> <span class="n">val</span><span class="p">}}]}</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">local.top_k_keywords</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="n">k</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">k</span><span class="sh">"</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        <span class="kn">import</span> <span class="n">re</span><span class="p">,</span> <span class="n">collections</span>
        <span class="n">toks</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">findall</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">[A-Za-z0-9가-힣]+</span><span class="sh">"</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
        <span class="n">cnt</span> <span class="o">=</span> <span class="n">collections</span><span class="p">.</span><span class="nc">Counter</span><span class="p">([</span><span class="n">t</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">toks</span><span class="p">])</span>
        <span class="n">top</span> <span class="o">=</span> <span class="n">cnt</span><span class="p">.</span><span class="nf">most_common</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">top</span><span class="sh">"</span><span class="p">:</span> <span class="n">top</span><span class="p">}}]}</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">unknown local tool </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="c1"># ======== 커스텀 LLM 어댑터(예시) ========
</span>
<span class="k">class</span> <span class="nc">CustomLLMClient</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>

    <span class="k">def</span> <span class="nf">_headers</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">content-type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ChatResponse</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">m</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">t</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">base_url</span><span class="si">}</span><span class="s">/chat</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="nf">_headers</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
        <span class="n">r</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
        <span class="k">return</span> <span class="nc">ChatResponse</span><span class="p">(</span><span class="o">**</span><span class="n">r</span><span class="p">.</span><span class="nf">json</span><span class="p">())</span>

<span class="c1"># ======== 툴 노출 전략(간단 소출 예시) ========
</span>
<span class="k">def</span> <span class="nf">selective_expose</span><span class="p">(</span><span class="n">user_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">all_mcp</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="n">keep</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">user_text</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span>

    <span class="c1"># 키워드 기반 라우팅(아주 얕은 예시)
</span>    <span class="k">if</span> <span class="nf">any</span><span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">text</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="sh">"</span><span class="s">csv</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">파일</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ingest</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">load</span><span class="sh">"</span><span class="p">]):</span>
        <span class="n">keep</span> <span class="o">+=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">all_mcp</span> <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">server</span><span class="sh">"</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">]</span>
    <span class="k">if</span> <span class="nf">any</span><span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">text</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="sh">"</span><span class="s">sql</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">쿼리</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">db</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">데이터베이스</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">요약</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">summary</span><span class="sh">"</span><span class="p">]):</span>
        <span class="n">keep</span> <span class="o">+=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">all_mcp</span> <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">server</span><span class="sh">"</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">db</span><span class="sh">"</span><span class="p">]</span>

    <span class="c1"># 항상 노출할 로컬 도구
</span>    <span class="n">local_basics</span> <span class="o">=</span> <span class="nf">local_tools_catalog</span><span class="p">()</span>

    <span class="c1"># 중복 제거 및 이름 네임스페이스 적용
</span>    <span class="k">def</span> <span class="nf">to_tooldef</span><span class="p">(</span><span class="n">t</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ToolDef</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">t</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">server</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">namespaced</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">t</span><span class="p">[</span><span class="sh">'</span><span class="s">server</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">t</span><span class="p">[</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">namespaced</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">]}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">]}</span>
        <span class="k">return</span> <span class="nc">ToolDef</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="n">fn</span><span class="p">)</span>

    <span class="n">uniq</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">keep</span><span class="p">:</span>
        <span class="n">uniq</span><span class="p">[(</span><span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">server</span><span class="sh">"</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">])]</span> <span class="o">=</span> <span class="n">t</span>
    <span class="n">tooldefs</span> <span class="o">=</span> <span class="p">[</span><span class="nf">to_tooldef</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">uniq</span><span class="p">.</span><span class="nf">values</span><span class="p">()]</span>
    <span class="n">tooldefs</span> <span class="o">+=</span> <span class="p">[</span><span class="nc">ToolDef</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">]})</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">local_basics</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">tooldefs</span>

<span class="c1"># ======== 대화 루프 ========
</span>
<span class="k">def</span> <span class="nf">coerce_args</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">x</span><span class="p">}</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">x</span><span class="p">}</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">chat_once</span><span class="p">(</span><span class="n">mux</span><span class="p">:</span> <span class="n">MCPMux</span><span class="p">,</span> <span class="n">llm</span><span class="p">:</span> <span class="n">CustomLLMClient</span><span class="p">,</span> <span class="n">system</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_rounds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6</span><span class="p">):</span>
    <span class="k">await</span> <span class="n">mux</span><span class="p">.</span><span class="nf">connect_all</span><span class="p">()</span>
    <span class="n">all_mcp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">mux</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>

    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">system</span><span class="p">),</span> <span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">user</span><span class="p">)]</span>

    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">max_rounds</span><span class="p">):</span>
        <span class="n">tools_exposed</span> <span class="o">=</span> <span class="nf">selective_expose</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">all_mcp</span><span class="p">)</span>  <span class="c1"># 턴별 소출
</span>        <span class="n">resp</span> <span class="o">=</span> <span class="n">llm</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">tools_exposed</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">resp</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">resp</span><span class="p">.</span><span class="n">content</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">resp</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="c1"># 섞여 있는 툴콜 처리: local.* ↔ server:tool
</span>        <span class="n">results_texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="nf">coerce_args</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">local.</span><span class="sh">"</span><span class="p">):</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="nf">run_local_tool</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">mux</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                <span class="n">results_texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span> <span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="n">result</span><span class="p">}).</span><span class="nf">decode</span><span class="p">())</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">results_texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}).</span><span class="nf">decode</span><span class="p">())</span>

        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="sh">"</span><span class="s">TOOL_RESULTS</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">results_texts</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">messages</span>

<span class="c1"># ======== 실행 예시 ========
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">mux</span> <span class="o">=</span> <span class="nc">MCPMux</span><span class="p">([</span>
        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">node</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./servers/files/index.js</span><span class="sh">"</span><span class="p">]),</span>
        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">db</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">python</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./servers/db/server.py</span><span class="sh">"</span><span class="p">]),</span>
    <span class="p">])</span>
    <span class="n">llm</span> <span class="o">=</span> <span class="nc">CustomLLMClient</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000</span><span class="sh">"</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">system</span> <span class="o">=</span> <span class="sh">"</span><span class="s">너는 안전하고 신중한 에이전트다. 파괴적 작업은 dry_run을 우선한다.</span><span class="sh">"</span>
    <span class="n">user</span> <span class="o">=</span> <span class="sh">"</span><span class="s">CSV를 적재하고(sql 요약까지). 수치 확인은 계산기로 한번 검증해줘. 파일은 ./data/sales.csv 이야.</span><span class="sh">"</span>

    <span class="n">msgs</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">chat_once</span><span class="p">(</span><span class="n">mux</span><span class="p">,</span> <span class="n">llm</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=== LOG ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">msgs</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[</span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">role</span><span class="si">}</span><span class="s">] </span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">content</span><span class="p">[</span><span class="si">:</span><span class="mi">1000</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>이 코드에서 확인할 수 있는 것</p>

<ul>
  <li>
    <p>한 턴에 LLM이 local.math_eval(일반 툴)과 files:ingest_csv(MCP) / db:sql_summary(MCP)를 섞어 호출해도 디스패처가 각각 맞는 경로로 라우팅한다.</p>
  </li>
  <li>
    <p>selective_expose가 턴별 툴 소출을 해준다. 유저 요청에 필요 없는 서버 툴은 숨겨서 혼란과 에러를 줄인다.</p>
  </li>
  <li>
    <p>로컬 툴은 파이썬 함수로 바로 처리하므로 레이턴시가 적고, 간단한 검증·후처리(예: 계산으로 sanity-check)를 빠르게 수행할 수 있다.</p>
  </li>
</ul>

<p>마지막으로, 에러를 더 줄이려면</p>

<ul>
  <li>
    <p>툴 설명에 “언제 쓰는지/언제 쓰지 말아야 하는지”를 한 문장씩 명시한다.</p>
  </li>
  <li>
    <p>위험 툴의 parameters에 confirm 문자열(예: "I understand this deletes data")을 required로 추가한다.</p>
  </li>
  <li>
    <p>TOOL_RESULTS 포맷을 팀 공통 JSON 스키마로 고정해 모델이 예측 가능한 후속 계획을 세우도록 한다.</p>
  </li>
  <li>
    <p>각 서버/툴별 타임아웃·재시도·서킷브레이커를 공통 미들웨어로 묶는다.</p>
  </li>
</ul>

<p>여기까지면 커스텀 LLM 엔드포인트에서도 “일반+MCP 혼합 툴콜”을 안정적으로 돌릴 수 있다. 다음 단계는 네가 쓰는 /chat 스펙에 맞춰 CustomLLMClient의 직렬화/역직렬화 부분만 미세조정하고, 실제 서버 두 개(files/db) 최소 구현으로 E2E를 한 번 굴려보는 것이다.</p>

<p class="chat--user">

오호. 다음은 어려운 문제야. 이걸 openai agent python sdk에 붙일 수 있을까?

</p>

<p>가능하다. 게다가 “여러 MCP 서버”와 “커스텀 LLM 엔드포인트”를 동시에 쓰는 구성이 OpenAI Agents Python SDK에서 정석으로 지원된다. 요점만 단계별로 정리하고, 바로 돌아가는 최소 예시를 준다.</p>

<p>핵심 정리</p>

<ol>
  <li>
    <p>Agents SDK는 MCP를 4가지 전송으로 붙인다: Hosted MCP(Responses API가 원격서버를 직접 호출), Streamable HTTP, HTTP+SSE, stdio(로컬 프로세스). 서버 여러 개를 mcp_servers 리스트에 넣으면 한 에이전트가 전부를 본다. <a href="https://openai.github.io/openai-agents-python/mcp/">OpenAI GitHub</a></p>
  </li>
  <li>
    <p>모델은 OpenAI 모델 말고도 LiteLLM 확장을 통해 “OpenAI 호환 REST”로 노출된 임의의 엔드포인트를 모델처럼 쓸 수 있다. base_url만 네 엔드포인트로 바꾸면 된다. <a href="https://openai.github.io/openai-agents-python/ref/extensions/litellm/">OpenAI GitHub</a></p>
  </li>
  <li>
    <p>Hosted MCP를 쓰면 OpenAI 인프라가 원격 MCP 서버를 직접 호출하므로 파이썬 쪽 콜백이 필요 없다(공개 접근 가능한 원격 서버에 적합). 반대로 사내망/로컬은 stdio·SSE 등 “직접 붙이기”가 맞다. <a href="https://openai.github.io/openai-agents-python/mcp/">OpenAI GitHub</a></p>
  </li>
  <li>
    <p>Agents SDK에는 MCP 전용 클래스들이 이미 들어있다(MCPServerStdio, MCPServerSse, MCPServerStreamableHttp, HostedMCPTool 등). <a href="https://openai.github.io/openai-agents-python/mcp/">OpenAI GitHub+1</a></p>
  </li>
</ol>

<p>빠른 스캐폴딩(파이썬)<br />
설치<br />
pip install openai-agents mcp</p>

<p>예시 1) 커스텀 LLM(base_url) + stdio/SSE MCP 다중 서버 한 번에 붙이기<br />
아래는 파일시스템 MCP를 로컬(stdio)로, 사내용 검색 MCP를 SSE로 붙이고, 모델은 너의 커스텀 /v1 Chat 호환 엔드포인트를 씀.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Runner</span>
<span class="kn">from</span> <span class="n">agents.model_settings</span> <span class="kn">import</span> <span class="n">ModelSettings</span>
<span class="kn">from</span> <span class="n">agents.mcp</span> <span class="kn">import</span> <span class="n">MCPServerStdio</span><span class="p">,</span> <span class="n">MCPServerSse</span>
<span class="kn">from</span> <span class="n">agents.extensions.models.litellm_model</span> <span class="kn">import</span> <span class="n">LitellmModel</span>  <span class="c1"># 커스텀 엔드포인트용
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># 1) MCP 서버들을 context manager로 기동/연결
</span>    <span class="k">async</span> <span class="k">with</span> <span class="nc">MCPServerStdio</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">command</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">]},</span>
        <span class="n">cache_tools_list</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">files_server</span><span class="p">,</span> <span class="nc">MCPServerSse</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">search</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">https://mcp.example.com/sse</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">Authorization</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Bearer XYZ</span><span class="sh">"</span><span class="p">}},</span>
        <span class="n">cache_tools_list</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">search_server</span><span class="p">:</span>

        <span class="c1"># 2) 커스텀 LLM 엔드포인트(OpenAI 호환) 모델로 지정
</span>        <span class="n">model</span> <span class="o">=</span> <span class="nc">LitellmModel</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-custom-model</span><span class="sh">"</span><span class="p">,</span>                 <span class="c1"># 엔진/이름
</span>            <span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000/v1</span><span class="sh">"</span><span class="p">,</span>     <span class="c1"># 네 엔드포인트
</span>            <span class="n">api_key</span><span class="o">=</span><span class="sh">"</span><span class="s">sk-your-key</span><span class="sh">"</span><span class="p">,</span>                   <span class="c1"># 필요시
</span>        <span class="p">)</span>

        <span class="c1"># 3) 에이전트 구성: 여러 MCP 서버를 한 번에 노출
</span>        <span class="n">agent</span> <span class="o">=</span> <span class="nc">Agent</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">Orchestrator</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">instructions</span><span class="o">=</span><span class="sh">"</span><span class="s">MCP 툴을 안전하게 사용하고, 필요할 때만 호출한다.</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">mcp_servers</span><span class="o">=</span><span class="p">[</span><span class="n">files_server</span><span class="p">,</span> <span class="n">search_server</span><span class="p">],</span>
            <span class="n">model_settings</span><span class="o">=</span><span class="nc">ModelSettings</span><span class="p">(</span><span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">),</span>  <span class="c1"># 필요 시 "required"로 강제
</span>        <span class="p">)</span>

        <span class="c1"># 4) 실행
</span>        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="sh">"</span><span class="s">data 폴더의 CSV를 읽고, search 서버로 관련 문서 찾아 요약해줘</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">final_output</span><span class="p">)</span>

<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>예시 2) Hosted MCP를 섞는 변형<br />
원격에 공개된 MCP 서버는 HostedMCPTool 하나만 tools에 넣으면 모델이 OpenAI 인프라에서 직접 목록조회/호출까지 한다. 파이썬 쪽 콜백이 거의 없다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Runner</span><span class="p">,</span> <span class="n">HostedMCPTool</span>

<span class="n">agent</span> <span class="o">=</span> <span class="nc">Agent</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">HostedMCPUser</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="nc">HostedMCPTool</span><span class="p">(</span><span class="n">tool_config</span><span class="o">=</span><span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">mcp</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">server_label</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">gitmcp</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">server_url</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">https://gitmcp.io/openai/codex</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">require_approval</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">never</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">})],</span>
<span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">Runner</span><span class="p">.</span><span class="nf">run_sync</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="sh">"</span><span class="s">이 저장소의 주요 언어를 알려줘</span><span class="sh">"</span><span class="p">).</span><span class="n">final_output</span><span class="p">)</span>
</code></pre></div></div>

<p>위 두 방식은 공식 문서의 사용법과 동일한 흐름이다. Hosted MCP, stdio/SSE/HTTP 서버, 툴 필터링, 승인 훅까지 포함된 가이드를 참고해 세부옵션을 맞추면 된다. <a href="https://openai.github.io/openai-agents-python/mcp/">OpenAI GitHub</a></p>

<p>툴 소출 전략(오류 줄이는 팁)</p>

<ol>
  <li>
    <p>툴 필터링: 서버 생성자에 tool_filter를 걸거나 정적/동적 필터를 써서 턴별로 필요한 툴만 노출하라. SDK가 도우미를 제공한다. <a href="https://openai.github.io/openai-agents-python/mcp/">OpenAI GitHub</a></p>
  </li>
  <li>
    <p>위험 툴 승인: HostedMCPTool은 require_approval 및 on_approval_request 콜백으로 민감 작업을 승인 플로로 감싼다. <a href="https://openai.github.io/openai-agents-python/mcp/">OpenAI GitHub</a></p>
  </li>
  <li>
    <p>캐싱과 재시도: cache_tools_list, max_retry_attempts 등 옵션으로 지연과 실패 확률을 줄일 수 있다. <a href="https://openai.github.io/openai-agents-python/mcp/">OpenAI GitHub</a></p>
  </li>
</ol>

<p>한 줄 결론<br />
OpenAI Agents Python SDK에 네가 만든 “멀티 MCP + 커스텀 LLM 엔드포인트”를 그대로 붙일 수 있다. 모델은 LiteLLMModel로 커스텀 REST를 쓰고, MCP는 mcp_servers에 여러 개를 열거하거나 HostedMCPTool을 병용하면 된다. 필요하면 너의 엔드포인트 스펙에 맞춰 모델 어댑터를 더 촘촘하게 설정하는 코드도 만들어주겠다. <a href="https://openai.github.io/openai-agents-python/ref/extensions/litellm/">OpenAI GitHub+2</a></p>

<p class="chat--user">

아니 난 너가 만든 코드를 그대로 쓰고 싶어. 왜냐면 이렇게 만든 인터페이스를 다른 Chat 에도 쓰고 싶거든. Agent만을 위한 다른 코드가 분기 되는 것이 싫어. Tool만 입력해서 동작하게 하는 방법 없어?

</p>

<p>좋아. “Agent 전용 분기 없이” 너가 만든 인터페이스를 어떤 Chat에도 재사용하려면, 입력은 오직 툴(=프로바이더)과 LLM 엔드포인트만 주고 돌아가는 얇은 오케스트레이터가 필요하다. 아래는 그 목적에 맞춘 단일 파일 스캐폴딩이다. 핵심은 세 가지 인터페이스다.</p>

<ol>
  <li>
    <p>ChatBackend: 어떤 채팅 모델이든 붙일 수 있는 백엔드 어댑터.</p>
  </li>
  <li>
    <p>ToolProvider: 툴 카탈로그를 노출하고 호출을 처리하는 표준 인터페이스.</p>
  </li>
  <li>
    <p>Orchestrator: messages + tools만으로 루프를 돌린다. 어떤 에이전트 SDK 분기도 없다.</p>
  </li>
</ol>

<p>설치<br />
pip install mcp requests pydantic orjson</p>

<p>tools_only.py</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Protocol</span><span class="p">,</span> <span class="n">runtime_checkable</span>

<span class="kn">import</span> <span class="n">orjson</span>
<span class="kn">import</span> <span class="n">requests</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>

<span class="c1"># ========== 공통 데이터 모델 ==========
</span>
<span class="k">class</span> <span class="nc">ChatMessage</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">role</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span> <span class="nc">ToolDef</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="c1"># OpenAI/함수콜 호환 포맷으로 통일
</span>    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span>
    <span class="n">function</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># {name, description, parameters(JSON Schema)}
</span>
<span class="k">class</span> <span class="nc">ToolCall</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span>
    <span class="n">function</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># {name, arguments(str or dict)}
</span>
<span class="k">class</span> <span class="nc">ChatResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span>
    <span class="n">tool_calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolCall</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_coerce_args</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">x</span><span class="p">}</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">x</span><span class="p">}</span>

<span class="c1"># ========== 1) ChatBackend 인터페이스 ==========
</span>
<span class="nd">@runtime_checkable</span>
<span class="k">class</span> <span class="nc">ChatBackend</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ChatResponse</span><span class="p">:</span> <span class="bp">...</span>

<span class="k">class</span> <span class="nc">OpenAICompatibleBackend</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    OpenAI Chat Completions 호환(또는 유사) 엔드포인트용 백엔드.
    /v1/chat/completions 또는 /chat 같은 곳에 맞춰 최소한의 어댑터만 제공.
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/chat</span><span class="sh">"</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">self</span><span class="p">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="n">self</span><span class="p">.</span><span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>  <span class="c1"># "/v1/chat/completions"로 바꿔도 됨
</span>
    <span class="k">def</span> <span class="nf">_headers</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]:</span>
        <span class="n">h</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content-type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="p">:</span>
            <span class="n">h</span><span class="p">[</span><span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Bearer </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">h</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">headers</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">h</span>

    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ChatResponse</span><span class="p">:</span>
        <span class="c1"># 서버 규격에 맞게 필요한 키만 담는다. 필요시 여기만 수정.
</span>        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">m</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">t</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">base_url</span><span class="si">}{</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="nf">_headers</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
        <span class="n">r</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
        <span class="c1"># data를 ChatResponse로 매핑; 너의 엔드포인트 규격에 맞게 여기만 조정하면 된다.
</span>        <span class="k">return</span> <span class="nc">ChatResponse</span><span class="p">(</span><span class="o">**</span><span class="p">{</span>
            <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)</span> <span class="ow">or</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">,[{}])[</span><span class="mi">0</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">,{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">,[{}])[</span><span class="mi">0</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">,{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]),</span>
        <span class="p">})</span>

<span class="c1"># ========== 2) ToolProvider 인터페이스 ==========
</span>
<span class="nd">@runtime_checkable</span>
<span class="k">class</span> <span class="nc">ToolProvider</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">list_tools</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]:</span> <span class="bp">...</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arguments</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span> <span class="bp">...</span>

<span class="c1"># ---- 2-1) MCP 프로바이더 (여러 서버 포함) ----
# mcp 설치 필요
</span><span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="n">mcp.client.sse</span> <span class="kn">import</span> <span class="n">SSEClientTransport</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">False</span>

<span class="k">class</span> <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>               <span class="c1"># 네임스페이스
</span>    <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span>               <span class="c1"># "stdio" | "sse"
</span>    <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">class</span> <span class="nc">_Connected</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span>

<span class="k">class</span> <span class="nc">MCPProvider</span><span class="p">(</span><span class="n">ToolProvider</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">servers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPServerCfg</span><span class="p">],</span> <span class="n">cache</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cfgs</span> <span class="o">=</span> <span class="n">servers</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">_Connected</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_tools_cache</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="n">cache</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_started</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_ensure_started</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_started</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_cfgs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">args</span> <span class="ow">or</span> <span class="p">[]))</span>
            <span class="k">elif</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">HAVE_SSE</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">mcp.client.sse 모듈이 필요합니다.</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">transport</span> <span class="o">=</span> <span class="nc">SSEClientTransport</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">headers</span> <span class="ow">or</span> <span class="p">{})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">unknown kind: </span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
            <span class="n">sess</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">sess</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">_Connected</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">sess</span><span class="p">))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_started</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">_to_tooldef</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">server</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ToolDef</span><span class="p">:</span>
        <span class="n">namespaced</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">server</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span>
        <span class="k">return</span> <span class="nc">ToolDef</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">namespaced</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">MCP </span><span class="si">{</span><span class="n">namespaced</span><span class="si">}</span><span class="sh">"</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{}})</span>
        <span class="p">})</span>

    <span class="k">def</span> <span class="nf">list_tools</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]:</span>
        <span class="c1"># 동기 인터페이스 요구 때문에 캐시 기반. 최초 호출 전에 warmup()을 호출하거나,
</span>        <span class="c1"># Orchestrator가 응답 전 await ensure_ready()를 한 번 수행.
</span>        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools_cache</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">MCPProvider not ready. Call await provider.ensure_ready() first.</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools_cache</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">ensure_ready</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_started</span><span class="p">()</span>
        <span class="c1"># list_tools는 async라 여기서 미리 모은다.
</span>        <span class="n">merged</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">c</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
                <span class="n">merged</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">_to_tooldef</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_tools_cache</span> <span class="o">=</span> <span class="n">merged</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arguments</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="c1"># tool_name은 "server:tool"이어야 함
</span>        <span class="n">server</span><span class="p">,</span> <span class="n">tool</span> <span class="o">=</span> <span class="n">tool_name</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">server</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">c</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">arguments</span> <span class="ow">or</span> <span class="p">{})</span>
                <span class="n">packed</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
                <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">res</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">it</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">it</span><span class="p">.</span><span class="n">text</span><span class="p">})</span>
                    <span class="k">elif</span> <span class="n">it</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="n">it</span><span class="p">.</span><span class="n">json</span><span class="p">})</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">it</span><span class="p">.</span><span class="nb">type</span><span class="p">})</span>
                <span class="k">return</span> <span class="n">packed</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">unknown server namespace: </span><span class="si">{</span><span class="n">server</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="c1"># ---- 2-2) 로컬 툴 프로바이더(선택) ----
</span>
<span class="k">class</span> <span class="nc">LocalToolsProvider</span><span class="p">(</span><span class="n">ToolProvider</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_defs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nc">ToolDef</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="p">{</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">안전 사칙연산. 입력: {expr: string}</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}},</span>
                    <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:[</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">],</span>
                    <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
                <span class="p">}</span>
            <span class="p">})</span>
        <span class="p">]</span>
    <span class="k">def</span> <span class="nf">list_tools</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_defs</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arguments</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">tool_name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">expr</span> <span class="o">=</span> <span class="n">arguments</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">expr</span> <span class="k">if</span> <span class="n">ch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="sh">"</span><span class="s">0123456789+-*/(). </span><span class="sh">"</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">expr must contain only digits and + - * / ( )</span><span class="sh">"</span><span class="p">}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="nf">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">__builtins__</span><span class="sh">"</span><span class="p">:{}},</span> <span class="p">{})</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:[{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span><span class="n">val</span><span class="p">}}]}</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">unknown local tool </span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="c1"># ========== 3) Orchestrator (도구만 입력해서 동작) ==========
</span>
<span class="k">class</span> <span class="nc">Orchestrator</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    목적: 툴만 입력해서 동작. 어떤 Chat(백엔드)에도 재사용.
    - providers: ToolProvider들의 리스트
    - backend: ChatBackend 구현체 1개
    - expose_fn: 선택적으로 </span><span class="sh">'</span><span class="s">툴 소출</span><span class="sh">'</span><span class="s"> 전략을 주입 (기본값: 전부 노출)
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">providers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolProvider</span><span class="p">],</span> <span class="n">backend</span><span class="p">:</span> <span class="n">ChatBackend</span><span class="p">,</span> <span class="n">expose_fn</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">max_rounds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">providers</span> <span class="o">=</span> <span class="n">providers</span>
        <span class="n">self</span><span class="p">.</span><span class="n">backend</span> <span class="o">=</span> <span class="n">backend</span>
        <span class="n">self</span><span class="p">.</span><span class="n">max_rounds</span> <span class="o">=</span> <span class="n">max_rounds</span>
        <span class="n">self</span><span class="p">.</span><span class="n">expose_fn</span> <span class="o">=</span> <span class="n">expose_fn</span> <span class="ow">or</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">_messages</span><span class="p">,</span> <span class="n">tools</span><span class="p">:</span> <span class="n">tools</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">ensure_ready</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="c1"># MCPProvider 같은 async 준비가 필요한 프로바이더를 워밍업
</span>        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">providers</span><span class="p">:</span>
            <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="sh">"</span><span class="s">ensure_ready</span><span class="sh">"</span><span class="p">)</span> <span class="ow">and</span> <span class="nf">callable</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="sh">"</span><span class="s">ensure_ready</span><span class="sh">"</span><span class="p">)):</span>
                <span class="k">await</span> <span class="n">p</span><span class="p">.</span><span class="nf">ensure_ready</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_catalog</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]:</span>
        <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">providers</span><span class="p">:</span>
            <span class="n">tools</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">tools</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_dispatch_call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="c1"># 각 프로바이더가 책임지는 네임스페이스로 라우팅
</span>        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">providers</span><span class="p">:</span>
            <span class="c1"># 빠른 판별: MCP는 "server:" 네임스페이스, 로컬은 "local." 같은 규칙 추천
</span>            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">MCPProvider</span><span class="p">):</span>
                <span class="k">if</span> <span class="sh">"</span><span class="s">:</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>  <span class="c1"># server:tool
</span>                    <span class="k">return</span> <span class="k">await</span> <span class="n">p</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">local.</span><span class="sh">"</span><span class="p">):</span>
                    <span class="k">return</span> <span class="k">await</span> <span class="n">p</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="c1"># 마지막 fallback: 모든 provider에 시도
</span>        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">providers</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">p</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">no provider could handle tool </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">user_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">system_text</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]:</span>
        <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">ensure_ready</span><span class="p">()</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">system_text</span><span class="p">:</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">system_text</span><span class="p">))</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">user_text</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">max_rounds</span><span class="p">):</span>
            <span class="c1"># 툴 카탈로그를 수집하고 소출 전략 적용
</span>            <span class="n">all_tools</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_catalog</span><span class="p">()</span>
            <span class="n">exposed</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">expose_fn</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">all_tools</span><span class="p">)</span>

            <span class="n">resp</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">backend</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">exposed</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">resp</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">resp</span><span class="p">.</span><span class="n">content</span><span class="p">))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">resp</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="n">results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)</span>
                <span class="n">args</span> <span class="o">=</span> <span class="nf">_coerce_args</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_dispatch_call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                    <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span><span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span><span class="n">args</span><span class="p">,</span> <span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span><span class="n">result</span><span class="p">}).</span><span class="nf">decode</span><span class="p">())</span>
                <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span><span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span><span class="n">args</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span><span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}).</span><span class="nf">decode</span><span class="p">())</span>

            <span class="c1"># 모델에게 도구결과를 일괄 재주입
</span>            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="sh">"</span><span class="s">TOOL_RESULTS</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">results</span><span class="p">)))</span>

        <span class="k">return</span> <span class="n">messages</span>

<span class="c1"># ========== 실행 예시 ==========
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># 1) MCP 서버들: 필요 서버만 나열
</span>    <span class="n">mcp</span> <span class="o">=</span> <span class="nc">MCPProvider</span><span class="p">([</span>
        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">]),</span>
        <span class="c1"># MCPServerCfg(name="search", kind="sse", url="https://mcp.example.com/sse", headers={"Authorization":"Bearer X"}),
</span>    <span class="p">])</span>

    <span class="c1"># 2) 로컬 툴(선택)
</span>    <span class="n">local</span> <span class="o">=</span> <span class="nc">LocalToolsProvider</span><span class="p">()</span>

    <span class="c1"># 3) 어떤 Chat이든 붙일 백엔드. base_url과 path만 맞추면 끝.
</span>    <span class="n">backend</span> <span class="o">=</span> <span class="nc">OpenAICompatibleBackend</span><span class="p">(</span>
        <span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">path</span><span class="o">=</span><span class="sh">"</span><span class="s">/chat</span><span class="sh">"</span><span class="p">,</span>               <span class="c1"># 필요에 따라 "/v1/chat/completions" 등으로 변경
</span>        <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">api_key</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># 4) 오케스트레이터: 입력은 “툴(프로바이더)”뿐
</span>    <span class="n">orch</span> <span class="o">=</span> <span class="nc">Orchestrator</span><span class="p">(</span>
        <span class="n">providers</span><span class="o">=</span><span class="p">[</span><span class="n">mcp</span><span class="p">,</span> <span class="n">local</span><span class="p">],</span>
        <span class="n">backend</span><span class="o">=</span><span class="n">backend</span><span class="p">,</span>
        <span class="c1"># 간단 소출: 파일/SQL 관련 단어가 없으면 MCP를 숨기고 로컬만 노출
</span>        <span class="n">expose_fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">msgs</span><span class="p">,</span> <span class="n">tools</span><span class="p">:</span> <span class="p">[</span>
            <span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span>
            <span class="nf">if </span><span class="p">(</span><span class="sh">"</span><span class="s">local.</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">t</span><span class="p">.</span><span class="n">function</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">])</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="n">msgs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">content</span><span class="p">.</span><span class="nf">lower</span><span class="p">())</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="sh">"</span><span class="s">csv</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">파일</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">sql</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">db</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">쿼리</span><span class="sh">"</span><span class="p">])</span>
        <span class="p">],</span>
        <span class="n">max_rounds</span><span class="o">=</span><span class="mi">8</span>
    <span class="p">)</span>

    <span class="n">messages</span> <span class="o">=</span> <span class="k">await</span> <span class="n">orch</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span>
        <span class="n">user_text</span><span class="o">=</span><span class="sh">"</span><span class="s">CSV를 읽고 합계를 계산한 뒤 수치가 맞는지 계산기로 검증해줘. 파일은 ./data/sales.csv</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">system_text</span><span class="o">=</span><span class="sh">"</span><span class="s">너는 MCP 툴을 신중히 사용한다. 파괴적 작업은 dry_run을 우선한다.</span><span class="sh">"</span>
    <span class="p">)</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=== 최종 로그 ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[</span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">role</span><span class="si">}</span><span class="s">] </span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">content</span><span class="p">[</span><span class="si">:</span><span class="mi">1500</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>설명과 사용법 요약<br />
입력은 툴(프로바이더)만 넘긴다. 오케스트레이터는 툴 카탈로그를 합치고, LLM 응답의 tool_calls를 받아 적절한 프로바이더로 라우팅한다. 특정 에이전트 SDK 분기가 전혀 없다. 다른 Chat 백엔드로 바꾸고 싶으면 OpenAICompatibleBackend만 교체하거나 send 메소드가 동일한 시그니처를 가지는 새 클래스를 하나 추가하면 된다.</p>

<p>운영 팁<br />
툴 소출 함수(expose_fn)로 턴별 필터링을 꼭 넣자. 단순 키워드만으로도 선택 오류와 불필요 호출이 크게 준다.<br />
네임스페이스를 일관되게 유지하자. MCP는 server:tool, 로컬은 local.*처럼 구분하면 충돌이 없다.<br />
고위험 툴은 parameters에 dry_run, confirm 문자열 같은 제약을 넣어야 한다.<br />
대용량 결과는 MCP 서버가 파일 핸들(리소스)로 반환하고, 모델에는 요약/메타데이터만 재주입해 토큰을 아끼자.</p>

<p>이 구조면 같은 Orchestrator를 그대로 두고, 어떤 Chat UI/엔진에도 쉽게 이식할 수 있다. 필요하면 네 엔드포인트의 정확한 JSON 규격을 알려줘. OpenAICompatibleBackend의 매핑만 10줄쯤 손보면 바로 물릴 수 있게 맞춰줄 수 있다.</p>

<p class="chat--user">

이건 또 openai agent는 안 쓰는 것 같은데

</p>

<p>맞아, 방금 준 스캐폴딩은 “오픈AI Agents SDK”를 쓰지 않는 순수 오케스트레이터였지. 너가 원하는 건 그 코드를 그대로 유지하면서, 백엔드만 갈아끼워 “OpenAI Agents Python SDK”를 LLM 백엔드로 사용할 수 있게 하는 것. 아래처럼 백엔드 어댑터 하나만 추가하면 된다. 오케스트레이터·툴 프로바이더·라우팅은 그대로 재사용하고, 에이전트 SDK는 단지 “텍스트+툴콜 JSON을 뱉는 모델 백엔드”로만 쓴다. 즉, Agents SDK에게 MCP 실행을 맡기지 않고, 우리가 만든 라우터가 계속 MCP를 호출한다.</p>

<p>핵심 아이디어<br />
에이전트 SDK에게 도구를 등록하지 않는다(tool_choice 없이). 대신 우리가 넘긴 툴 카탈로그를 프롬프트에 JSON으로 주고, 에이전트가 반드시 다음 포맷의 JSON만 출력하도록 강제한다. 그러면 우리 오케스트레이터가 그 JSON을 파싱해 실제 MCP/로컬 툴로 라우팅한다. 이러면 Agent 전용 코드 분기가 생기지 않는다. 백엔드를 바꿔 끼우는 것만으로 같은 오케스트레이터가 그대로 동작한다.</p>

<p>설치<br />
pip install openai-agents mcp requests pydantic orjson</p>

<p>agents_backend.py<br />
아래 파일은 네가 이전에 받은 tools_only.py의 구조를 그대로 따르되, ChatBackend 구현체로 AgentsBackend를 추가한 버전이다. 나머지는 동일하니 이 파일 하나로 교체해도 되고, 필요한 부분만 가져다 써도 된다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Protocol</span><span class="p">,</span> <span class="n">runtime_checkable</span>

<span class="kn">import</span> <span class="n">orjson</span>
<span class="kn">import</span> <span class="n">requests</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>

<span class="c1"># ========== 공통 데이터 모델 ==========
</span>
<span class="k">class</span> <span class="nc">ChatMessage</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">role</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span> <span class="nc">ToolDef</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span>
    <span class="n">function</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">ToolCall</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span>
    <span class="n">function</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># {"name": ..., "arguments": str|dict}
</span>
<span class="k">class</span> <span class="nc">ChatResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span>
    <span class="n">tool_calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolCall</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_coerce_args</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">x</span><span class="p">}</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">x</span><span class="p">}</span>

<span class="c1"># ========== 1) ChatBackend 인터페이스 ==========
</span>
<span class="nd">@runtime_checkable</span>
<span class="k">class</span> <span class="nc">ChatBackend</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ChatResponse</span><span class="p">:</span> <span class="bp">...</span>

<span class="k">class</span> <span class="nc">OpenAICompatibleBackend</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/chat</span><span class="sh">"</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">self</span><span class="p">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="n">self</span><span class="p">.</span><span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>

    <span class="k">def</span> <span class="nf">_headers</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]:</span>
        <span class="n">h</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content-type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="p">:</span>
            <span class="n">h</span><span class="p">[</span><span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Bearer </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">h</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">headers</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">h</span>

    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ChatResponse</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">m</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">],</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">t</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">]}</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">base_url</span><span class="si">}{</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="nf">_headers</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
        <span class="n">r</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
        <span class="k">return</span> <span class="nc">ChatResponse</span><span class="p">(</span><span class="o">**</span><span class="p">{</span>
            <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)</span> <span class="ow">or</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">,[{}])[</span><span class="mi">0</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">,{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">,[{}])[</span><span class="mi">0</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">,{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]),</span>
        <span class="p">})</span>

<span class="c1"># ========== 1-b) OpenAI Agents SDK 백엔드 어댑터 ==========
</span>
<span class="c1"># Agents SDK는 내부적으로 도구 실행까지 맡길 수 있지만,
# 여기서는 "텍스트+툴콜 JSON을 생성하는 모델"로만 사용한다.
# 프롬프트 강제 형식으로 tool_calls를 JSON으로 출력하게 만든다.
</span>
<span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Runner</span>
<span class="kn">from</span> <span class="n">agents.model_settings</span> <span class="kn">import</span> <span class="n">ModelSettings</span>
<span class="kn">from</span> <span class="n">agents.extensions.models.litellm_model</span> <span class="kn">import</span> <span class="n">LitellmModel</span>

<span class="k">class</span> <span class="nc">AgentsBackend</span><span class="p">(</span><span class="n">ChatBackend</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="c1"># LiteLLM 모델 확장을 사용해 임의의 OpenAI 호환 엔드포인트를 붙일 수 있다.
</span>        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">api_key</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="k">if</span> <span class="n">headers</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">headers</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_model</span> <span class="o">=</span> <span class="nc">LitellmModel</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="n">base_url</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span> <span class="o">+</span> <span class="sh">"</span><span class="s">/v1</span><span class="sh">"</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># 도구는 에이전트에 등록하지 않는다. 우리가 직접 라우팅할 것이기 때문.
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_agent</span> <span class="o">=</span> <span class="nc">Agent</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">LLMOnly</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">instructions</span><span class="o">=</span><span class="sh">""</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">_model</span><span class="p">,</span>
            <span class="n">model_settings</span><span class="o">=</span><span class="nc">ModelSettings</span><span class="p">(</span><span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">none</span><span class="sh">"</span><span class="p">)</span>  <span class="c1"># 절대 자동 도구 호출 금지
</span>        <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_tools_to_schema_snippet</span><span class="p">(</span><span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># 툴 목록을 JSON으로 주고, 정확한 출력 포맷을 강제한다.
</span>        <span class="n">tools_payload</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="n">function</span>
            <span class="n">tools_payload</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">),</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{}})</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">tools_payload</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_build_prompt</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">history</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>
            <span class="n">history</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">role</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">content</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">tools_json</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_tools_to_schema_snippet</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span>
        <span class="n">guide</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sh">"</span><span class="s">위는 대화 내역이다. 아래는 사용 가능한 도구 목록이다.</span><span class="se">\n</span><span class="sh">"</span>
            <span class="sa">f</span><span class="sh">"</span><span class="s">TOOLS_JSON=</span><span class="si">{</span><span class="n">tools_json</span><span class="si">}</span><span class="se">\n\n</span><span class="sh">"</span>
            <span class="sh">"</span><span class="s">반드시 다음 JSON 포맷으로만 답하라. 다른 텍스트는 절대 출력하지 말라.</span><span class="se">\n</span><span class="sh">"</span>
            <span class="sh">"</span><span class="s">{</span><span class="se">\n</span><span class="sh">"</span>
            <span class="sh">'</span><span class="s">  </span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">&lt;최종 자연어 응답(있으면)&gt;</span><span class="sh">"</span><span class="s"> ,</span><span class="se">\n</span><span class="sh">'</span>
            <span class="sh">'</span><span class="s">  </span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="s">: [</span><span class="se">\n</span><span class="sh">'</span>
            <span class="sh">'</span><span class="s">     {</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">id-1</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">:{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">&lt;toolName&gt;</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="s">:{...}}},</span><span class="se">\n</span><span class="sh">'</span>
            <span class="sh">'</span><span class="s">     {</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">id-2</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">:{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">&lt;toolName&gt;</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="s">:{...}}}</span><span class="se">\n</span><span class="sh">'</span>
            <span class="sh">"</span><span class="s">  ]</span><span class="se">\n</span><span class="sh">"</span>
            <span class="sh">"</span><span class="s">}</span><span class="se">\n</span><span class="sh">"</span>
            <span class="sh">"</span><span class="s">여러 도구가 필요하면 tool_calls 배열에 순서대로 넣어라. 도구가 필요 없으면 빈 배열을 넣어라.</span><span class="sh">"</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">history</span> <span class="o">+</span> <span class="p">[</span><span class="sh">""</span><span class="p">,</span> <span class="n">guide</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ChatResponse</span><span class="p">:</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_build_prompt</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">tools</span><span class="p">)</span>
        <span class="c1"># Developer 메시지에 강제 포맷 가이드를 넣어 JSON만 출력하게 한다.
</span>        <span class="n">out</span> <span class="o">=</span> <span class="n">Runner</span><span class="p">.</span><span class="nf">run_sync</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_agent</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">developer_instructions</span><span class="o">=</span><span class="sh">"</span><span class="s">JSON 포맷만 출력</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">out</span><span class="p">.</span><span class="n">final_output</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="c1"># JSON 파싱 실패 시, 일반 텍스트만 채워서 반환
</span>            <span class="k">return</span> <span class="nc">ChatResponse</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">text</span><span class="p">,</span> <span class="n">tool_calls</span><span class="o">=</span><span class="p">[])</span>
        <span class="c1"># 표준 ChatResponse로 맵
</span>        <span class="n">tc_raw</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span>
        <span class="c1"># arguments가 dict가 아닐 수도 있으니 그대로 통과(오케스트레이터 쪽에서 정규화)
</span>        <span class="k">return</span> <span class="nc">ChatResponse</span><span class="p">(</span>
            <span class="n">content</span><span class="o">=</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">),</span>
            <span class="n">tool_calls</span><span class="o">=</span><span class="p">[</span><span class="nc">ToolCall</span><span class="p">(</span><span class="o">**</span><span class="n">tc</span><span class="p">)</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">tc_raw</span><span class="p">]</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">tc_raw</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="p">)</span>

<span class="c1"># ========== 2) ToolProvider (MCP/로컬) ==========
</span>
<span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="n">mcp.client.sse</span> <span class="kn">import</span> <span class="n">SSEClientTransport</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">False</span>

<span class="k">class</span> <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># "stdio" | "sse"
</span>    <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">class</span> <span class="nc">_Connected</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span>

<span class="k">class</span> <span class="nc">MCPProvider</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">servers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPServerCfg</span><span class="p">]):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cfgs</span> <span class="o">=</span> <span class="n">servers</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">_Connected</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_tools_cache</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_started</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_ensure_started</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_started</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_cfgs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">args</span> <span class="ow">or</span> <span class="p">[]))</span>
            <span class="k">elif</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">HAVE_SSE</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">mcp.client.sse 모듈이 필요합니다.</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">transport</span> <span class="o">=</span> <span class="nc">SSEClientTransport</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">headers</span> <span class="ow">or</span> <span class="p">{})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">unknown kind: </span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
            <span class="n">sess</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">sess</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">_Connected</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">sess</span><span class="p">))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_started</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">ensure_ready</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_started</span><span class="p">()</span>
        <span class="n">merged</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">c</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
                <span class="n">namespaced</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">c</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span>
                <span class="n">merged</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ToolDef</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="p">{</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">namespaced</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">MCP </span><span class="si">{</span><span class="n">namespaced</span><span class="si">}</span><span class="sh">"</span><span class="p">),</span>
                    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{}})</span>
                <span class="p">}))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_tools_cache</span> <span class="o">=</span> <span class="n">merged</span>

    <span class="k">def</span> <span class="nf">list_tools</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools_cache</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">MCPProvider not ready. Call await ensure_ready() first.</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools_cache</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arguments</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">server</span><span class="p">,</span> <span class="n">tool</span> <span class="o">=</span> <span class="n">tool_name</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">server</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">c</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">arguments</span> <span class="ow">or</span> <span class="p">{})</span>
                <span class="n">packed</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
                <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">res</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">it</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">it</span><span class="p">.</span><span class="n">text</span><span class="p">})</span>
                    <span class="k">elif</span> <span class="n">it</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="n">it</span><span class="p">.</span><span class="n">json</span><span class="p">})</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">it</span><span class="p">.</span><span class="nb">type</span><span class="p">})</span>
                <span class="k">return</span> <span class="n">packed</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">unknown server: </span><span class="si">{</span><span class="n">server</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="k">class</span> <span class="nc">LocalToolsProvider</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_defs</span> <span class="o">=</span> <span class="p">[</span><span class="nc">ToolDef</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">안전 사칙연산. 입력 {expr:string}</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:[</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">}</span>
        <span class="p">})]</span>
    <span class="k">def</span> <span class="nf">list_tools</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_defs</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arguments</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">tool_name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">expr</span> <span class="o">=</span> <span class="n">arguments</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">expr</span> <span class="k">if</span> <span class="n">ch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="sh">"</span><span class="s">0123456789+-*/(). </span><span class="sh">"</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">expr must contain only digits and + - * / ( )</span><span class="sh">"</span><span class="p">}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="nf">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">__builtins__</span><span class="sh">"</span><span class="p">:{}},</span> <span class="p">{})</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:[{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span><span class="n">val</span><span class="p">}}]}</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">unknown local tool </span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="c1"># ========== 3) Orchestrator (변경 없음) ==========
</span>
<span class="k">class</span> <span class="nc">Orchestrator</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">providers</span><span class="p">,</span> <span class="n">backend</span><span class="p">:</span> <span class="n">ChatBackend</span><span class="p">,</span> <span class="n">expose_fn</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">max_rounds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">providers</span> <span class="o">=</span> <span class="n">providers</span>
        <span class="n">self</span><span class="p">.</span><span class="n">backend</span> <span class="o">=</span> <span class="n">backend</span>
        <span class="n">self</span><span class="p">.</span><span class="n">max_rounds</span> <span class="o">=</span> <span class="n">max_rounds</span>
        <span class="n">self</span><span class="p">.</span><span class="n">expose_fn</span> <span class="o">=</span> <span class="n">expose_fn</span> <span class="ow">or</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">_messages</span><span class="p">,</span> <span class="n">tools</span><span class="p">:</span> <span class="n">tools</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">ensure_ready</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">providers</span><span class="p">:</span>
            <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="sh">"</span><span class="s">ensure_ready</span><span class="sh">"</span><span class="p">)</span> <span class="ow">and</span> <span class="nf">callable</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="sh">"</span><span class="s">ensure_ready</span><span class="sh">"</span><span class="p">)):</span>
                <span class="k">await</span> <span class="n">p</span><span class="p">.</span><span class="nf">ensure_ready</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_catalog</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]:</span>
        <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">providers</span><span class="p">:</span>
            <span class="n">tools</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">tools</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_dispatch_call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">providers</span><span class="p">:</span>
            <span class="c1"># 네임스페이스 단서
</span>            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">MCPProvider</span><span class="p">)</span> <span class="ow">and</span> <span class="sh">"</span><span class="s">:</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">p</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">LocalToolsProvider</span><span class="p">)</span> <span class="ow">and</span> <span class="n">name</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">local.</span><span class="sh">"</span><span class="p">):</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">p</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="c1"># 폴백
</span>        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">providers</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">p</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">no provider can handle </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">user_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">system_text</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]:</span>
        <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">ensure_ready</span><span class="p">()</span>
        <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">system_text</span><span class="p">:</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">system_text</span><span class="p">))</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">user_text</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">max_rounds</span><span class="p">):</span>
            <span class="n">all_tools</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_catalog</span><span class="p">()</span>
            <span class="n">exposed</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">expose_fn</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">all_tools</span><span class="p">)</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">backend</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">exposed</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">resp</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">resp</span><span class="p">.</span><span class="n">content</span><span class="p">))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">resp</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="n">results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)</span>
                <span class="n">args</span> <span class="o">=</span> <span class="nf">_coerce_args</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_dispatch_call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                    <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span><span class="n">name</span><span class="p">,</span><span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span><span class="n">args</span><span class="p">,</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span><span class="n">result</span><span class="p">}).</span><span class="nf">decode</span><span class="p">())</span>
                <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span><span class="n">name</span><span class="p">,</span><span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span><span class="n">args</span><span class="p">,</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span><span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}).</span><span class="nf">decode</span><span class="p">())</span>

            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="sh">"</span><span class="s">TOOL_RESULTS</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">results</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">messages</span>

<span class="c1"># ========== 실행 예시 ==========
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># MCP 서버 예시
</span>    <span class="n">mcp</span> <span class="o">=</span> <span class="nc">MCPProvider</span><span class="p">([</span>
        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">]),</span>
        <span class="c1"># MCPServerCfg(name="search", kind="sse", url="https://mcp.example.com/sse", headers={"Authorization":"Bearer X"}),
</span>    <span class="p">])</span>
    <span class="n">local</span> <span class="o">=</span> <span class="nc">LocalToolsProvider</span><span class="p">()</span>

    <span class="c1"># A) OpenAI Agents SDK를 백엔드로 사용
</span>    <span class="n">backend</span> <span class="o">=</span> <span class="nc">AgentsBackend</span><span class="p">(</span>
        <span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000</span><span class="sh">"</span><span class="p">,</span>   <span class="c1"># OpenAI 호환 엔드포인트(LiteLLM도 가능)
</span>        <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">,</span>                <span class="c1"># 혹은 네 임의 모델명
</span>        <span class="n">api_key</span><span class="o">=</span><span class="bp">None</span>
    <span class="p">)</span>

    <span class="c1"># B) 필요하면 기존 OpenAICompatibleBackend로 교체 가능
</span>    <span class="c1"># backend = OpenAICompatibleBackend(base_url="http://localhost:8000", path="/chat", model="my-model")
</span>
    <span class="n">orch</span> <span class="o">=</span> <span class="nc">Orchestrator</span><span class="p">(</span>
        <span class="n">providers</span><span class="o">=</span><span class="p">[</span><span class="n">mcp</span><span class="p">,</span> <span class="n">local</span><span class="p">],</span>
        <span class="n">backend</span><span class="o">=</span><span class="n">backend</span><span class="p">,</span>
        <span class="n">expose_fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">msgs</span><span class="p">,</span> <span class="n">tools</span><span class="p">:</span> <span class="p">[</span>
            <span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span>
            <span class="nf">if </span><span class="p">(</span><span class="sh">"</span><span class="s">local.</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">t</span><span class="p">.</span><span class="n">function</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">])</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">msgs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">content</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="sh">"</span><span class="s">csv</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">파일</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">sql</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">db</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">쿼리</span><span class="sh">"</span><span class="p">])</span>
        <span class="p">],</span>
        <span class="n">max_rounds</span><span class="o">=</span><span class="mi">8</span>
    <span class="p">)</span>

    <span class="n">msgs</span> <span class="o">=</span> <span class="k">await</span> <span class="n">orch</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span>
        <span class="n">user_text</span><span class="o">=</span><span class="sh">"</span><span class="s">CSV를 읽고 합계를 구한 뒤 계산기로 수치 검증까지 해줘. 파일은 ./data/sales.csv</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">system_text</span><span class="o">=</span><span class="sh">"</span><span class="s">너는 MCP 툴을 신중히 사용한다. 파괴적 작업은 dry_run을 우선한다.</span><span class="sh">"</span>
    <span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=== 최종 로그 ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">msgs</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[</span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">role</span><span class="si">}</span><span class="s">] </span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">content</span><span class="p">[</span><span class="si">:</span><span class="mi">1500</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>작동 방식 정리<br />
1단계. AgentsBackend는 OpenAI Agents Python SDK의 Agent를 모델 백엔드로만 쓴다. 도구는 등록하지 않는다.<br />
2단계. 우리가 노출할 툴 목록을 JSON으로 프롬프트에 넣고, 에이전트가 content와 tool_calls 배열을 정확히 담은 JSON만 출력하게 강제한다.<br />
3단계. 오케스트레이터는 그 tool_calls를 받아 기존과 똑같이 MCP/로컬 툴로 라우팅한다.<br />
4단계. 즉, 같은 오케스트레이터 코드를 유지한 채, 백엔드만 갈아끼워 Agents SDK 또는 일반 OpenAI 호환 엔드포인트를 자유롭게 선택할 수 있다.</p>

<p>주의점과 팁<br />
JSON 강제 프롬프트가 중요하다. 모델이 장식 텍스트를 섞지 않도록 developer_instructions로 “JSON만 출력”을 반복해서 고정하라.<br />
툴 스키마를 엄격하게. required, enum, format을 충분히 넣으면 arguments 파싱 실패가 줄어든다.<br />
성능. AgentsBackend는 Runner.run_sync를 한 턴마다 호출한다. 대화 길어지면 토큰·시간이 늘어나므로 expose_fn으로 툴을 턴별로 소출하고, 결과는 요약해서 재주입하라.<br />
대체. 에이전트 SDK의 모델 대신 OpenAICompatibleBackend로 바꾸면 바로 동일 코드가 다른 Chat에도 붙는다. 목적에 맞춰 백엔드만 교체하면 된다.</p>

<p>이렇게 하면 에이전트 SDK를 “백엔드 모델”로만 쓰면서, 너의 툴 중심 인터페이스와 라우터는 그대로 유지된다. 다음에는 네 실제 엔드포인트의 출력 JSON 예시를 알려줘. AgentsBackend의 JSON 파싱 부분을 거기에 맞춰 2~3줄만 조정하면 된다.</p>

<p class="chat--user">

아 복잡해 그냥 function_tool로 각 tool을 등록하면 어떨까

</p>

<p>좋지. “그냥 function_tool로 각 툴을 등록”하는 가장 깔끔한 방법은, MCP 서버들에서 list_tools를 긁어와서 각각을 Agents SDK의 FunctionTool로 동적으로 래핑하는 거야. 그러면 Agent 쪽은 전혀 커스텀 분기 없이 표준 툴만 본다. 아래 코드가 바로 그 패턴이고, 커스텀 LLM도 LiteLLM 모델 어댑터로 붙인다.</p>

<p>핵심 개념 한 줄 요약<br />
MCP의 tool 메타데이터(name, description, input_schema)를 Agents SDK의 FunctionTool(name, description, params_json_schema, on_invoke_tool)에 그대로 매핑하고, on_invoke_tool에서 해당 MCP 세션으로 call_tool만 라우팅한다. FunctionTool/<code class="language-plaintext highlighter-rouge">@function_tool</code> 사용법과 JSON 스키마 포맷은 Agents 문서 그대로다. <a href="https://openai.github.io/openai-agents-python/tools/">OpenAI GitHub</a> 또한 모델은 LiteLLMModel로 너의 베이스 URL을 모델처럼 쓸 수 있다. <a href="https://openai.github.io/openai-agents-python/models/litellm/?utm_source=chatgpt.com">OpenAI GitHub</a></p>

<p>설치<br />
pip install "openai-agents[litellm]" mcp pydantic orjson</p>

<p>mcp_as_function_tools.py</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">import</span> <span class="n">orjson</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Runner</span><span class="p">,</span> <span class="n">FunctionTool</span>
<span class="kn">from</span> <span class="n">agents.extensions.models.litellm_model</span> <span class="kn">import</span> <span class="n">LitellmModel</span>

<span class="c1"># MCP Python SDK
</span><span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="n">mcp.client.sse</span> <span class="kn">import</span> <span class="n">SSEClientTransport</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">False</span>

<span class="k">class</span> <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>                 <span class="c1"># 네임스페이스(툴 이름 prefix에 들어감)
</span>    <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span>                 <span class="c1"># "stdio" | "sse"
</span>    <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">class</span> <span class="nc">Connected</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">connect_servers</span><span class="p">(</span><span class="n">cfgs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPServerCfg</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Connected</span><span class="p">]:</span>
    <span class="n">conns</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Connected</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">cfgs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">args</span> <span class="ow">or</span> <span class="p">[]))</span>
        <span class="k">elif</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">HAVE_SSE</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">mcp.client.sse 모듈이 필요합니다.</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">transport</span> <span class="o">=</span> <span class="nc">SSEClientTransport</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">headers</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">unknown kind: </span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
        <span class="n">sess</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">sess</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
        <span class="n">conns</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">Connected</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">cdfg</span><span class="p">.</span><span class="n">name</span> <span class="nf">if </span><span class="p">(</span><span class="n">cdfg</span> <span class="p">:</span><span class="o">=</span> <span class="n">cfg</span><span class="p">)</span> <span class="k">else</span> <span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">sess</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">conns</span>

<span class="k">def</span> <span class="nf">make_function_tool_for_mcp</span><span class="p">(</span><span class="n">server_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tool_meta</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FunctionTool</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    MCP tool -&gt; Agents FunctionTool
    tool_meta: has .name, .description, .input_schema (JSON Schema)
    </span><span class="sh">"""</span>
    <span class="n">namespaced</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">server_name</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">tool_meta</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span>
    <span class="n">params_schema</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">tool_meta</span><span class="p">,</span> <span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}})</span>
    <span class="n">description</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">tool_meta</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">MCP </span><span class="si">{</span><span class="n">namespaced</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">on_invoke</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">args_json</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># Agents SDK가 args_json을 JSON 문자열로 넘겨준다 → dict로 파싱 후 MCP 호출
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args_json</span><span class="p">)</span> <span class="k">if</span> <span class="n">args_json</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="c1"># 모델이 형식 어기면 raw로 전달(서버 쪽 검증에 맡김)
</span>            <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">args_json</span><span class="p">}</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">tool_meta</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="c1"># MCP 표준 content를 텍스트/JSON 위주로 정규화
</span>        <span class="n">packed</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">result</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">text</span><span class="p">})</span>
            <span class="k">elif</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">json</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span><span class="p">})</span>
        <span class="c1"># 에이전트에게는 문자열을 반환하므로 JSON 문자열로 묶어준다
</span>        <span class="k">return</span> <span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">packed</span><span class="p">).</span><span class="nf">decode</span><span class="p">()</span>

    <span class="c1"># FunctionTool은 name/description/params_json_schema/on_invoke_tool만 주면 된다.
</span>    <span class="c1"># 공식 문서의 "Custom function tools" 섹션과 동일한 생성자. :contentReference[oaicite:2]{index=2}
</span>    <span class="k">return</span> <span class="nc">FunctionTool</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">namespaced</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
        <span class="n">params_json_schema</span><span class="o">=</span><span class="n">params_schema</span><span class="p">,</span>
        <span class="n">on_invoke_tool</span><span class="o">=</span><span class="n">on_invoke</span><span class="p">,</span>
    <span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">build_tools_from_mcp</span><span class="p">(</span><span class="n">cfgs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPServerCfg</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">FunctionTool</span><span class="p">]:</span>
    <span class="n">conns</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">connect_servers</span><span class="p">(</span><span class="n">cfgs</span><span class="p">)</span>
    <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">FunctionTool</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">conns</span><span class="p">:</span>
        <span class="n">listed</span> <span class="o">=</span> <span class="k">await</span> <span class="n">c</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">listed</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
            <span class="n">tools</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">make_function_tool_for_mcp</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">c</span><span class="p">.</span><span class="n">session</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">tools</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># 1) 여러 MCP 서버를 선언
</span>    <span class="n">servers</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">]),</span>
        <span class="c1"># MCPServerCfg(name="search", kind="sse", url="https://mcp.example.com/sse", headers={"Authorization": "Bearer X"}),
</span>        <span class="c1"># MCPServerCfg(name="db", kind="stdio", command="python", args=["./servers/db/server.py"]),
</span>    <span class="p">]</span>

    <span class="c1"># 2) MCP의 모든 툴을 FunctionTool로 등록
</span>    <span class="n">mcp_function_tools</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">build_tools_from_mcp</span><span class="p">(</span><span class="n">servers</span><span class="p">)</span>

    <span class="c1"># 3) 커스텀 LLM(너의 엔드포인트)을 LiteLLM 모델로 사용
</span>    <span class="n">model</span> <span class="o">=</span> <span class="nc">LitellmModel</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-custom-model</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000/v1</span><span class="sh">"</span><span class="p">,</span>   <span class="c1"># 네 엔드포인트를 OpenAI 호환으로 노출했다는 가정
</span>        <span class="n">api_key</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># 4) 에이전트 구성: “function_tool로 등록된 MCP 툴”만 전달
</span>    <span class="n">agent</span> <span class="o">=</span> <span class="nc">Agent</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">MCP-through-FunctionTools</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">instructions</span><span class="o">=</span><span class="sh">"</span><span class="s">필요할 때만 툴을 호출한다. 파괴적 작업은 dry_run을 우선한다.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
        <span class="n">tools</span><span class="o">=</span><span class="n">mcp_function_tools</span><span class="p">,</span>  <span class="c1"># 포인트: 오직 function_tool만
</span>    <span class="p">)</span>

    <span class="c1"># 5) 실행
</span>    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span>
        <span class="n">agent</span><span class="p">,</span>
        <span class="nb">input</span><span class="o">=</span><span class="sh">"</span><span class="s">data 폴더에서 sales.csv를 읽고 합계 계산해줘. 필요하면 스스로 적절한 MCP 툴을 골라 써.</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">final_output</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>어떻게 돌아가나<br />
1단계. 여러 MCP 서버에 연결하고 list_tools로 메타를 긁는다.<br />
2단계. 각 MCP 툴을 FunctionTool로 감싼다. name은 server:tool로 네임스페이스, description과 JSON 스키마는 MCP의 description/input_schema를 그대로 쓴다. 이 매핑은 Agents 문서의 Function tools/Custom function tools 규약에 맞다. <a href="https://openai.github.io/openai-agents-python/tools/">OpenAI GitHub</a><br />
3단계. on_invoke_tool에서 session.call_tool만 호출해 결과를 문자열(JSON)로 반환한다.<br />
4단계. Agent는 “function_tool로 등록된 툴”만 보므로, 네가 원한 단순한 툴 등록 모델 그대로다. 모델은 LiteLLM을 통해 임의 베이스 URL의 LLM을 쓸 수 있다. <a href="https://openai.github.io/openai-agents-python/models/litellm/?utm_source=chatgpt.com">OpenAI GitHub</a></p>

<p>실전 팁<br />
툴 과적재를 피하려면 tools=mcp_function_tools 대신, 프롬프트를 보고 필요한 서버만 필터링해서 전달해라(예: 파일/CSV가 있으면 files:*만). Function tools는 설명과 인자 스키마를 자동 소비하니, MCP 쪽 스키마를 빡빡하게 유지하면 arguments 오류가 줄어든다. FunctionTool로 직접 생성하면 데코레이터 없이도 이름·설명·스키마를 원하는 대로 넣을 수 있다. <a href="https://openai.github.io/openai-agents-python/tools/">OpenAI GitHub</a></p>

<p>확장 아이디어<br />
고위험 툴에 dry_run, confirm 같은 필드를 MCP input_schema에 추가하면, 그대로 FunctionTool 인자 스키마에 반영되어 실행 전에 모델이 스스로 안전 절차를 따른다.<br />
툴 결과가 크면 on_invoke_tool에서 요약만 반환하고, 원본은 파일 핸들이나 URL로 제공하도록 MCP 서버를 설계해 토큰 사용량을 줄인다.</p>

<p>원하면 네 파일/DB MCP 서버의 실제 tool 이름과 input_schema를 알려줘. 위 스크립트가 해당 스키마를 그대로 FunctionTool로 옮겨주기 때문에 추가 코드는 사실상 없다.</p>

<p class="chat--user">

응 내가 원하는거랑 가까워진듯. 질문이 더 있어. 질문 1. MCP 말고 일반 Function 툴과 섞인 버젼 추가해줘. 질문 2. 일반 chat completions (with tools) 예제도 바로 아래에 추가해줘. 질문 3. MCP Client Session은 저절로 종료되나? 질문 4. 여러 Agent가 있으면 MCP 종류별로 세션을 여러개 열게될수도 있을거 같은데 하나로 유지하는건 어때? 문제가 있으려나

</p>

<p>좋아. 네 질문 4개를 순서대로, 바로 쓸 수 있는 코드와 함께 정리한다. 인용구문은 쓰지 않는다.</p>

<h1 id="1-mcp-툴--일반-function-툴을-섞어-등록하는-버전">1) MCP 툴 + 일반 Function 툴을 섞어 등록하는 버전</h1>

<p>아래는 앞서 만든 “MCP → FunctionTool 래핑”에 더해, 일반 파이썬 함수도 FunctionTool로 함께 등록하는 예시다. 에이전트는 두 종류를 한꺼번에 본다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Runner</span><span class="p">,</span> <span class="n">FunctionTool</span>
<span class="kn">from</span> <span class="n">agents.extensions.models.litellm_model</span> <span class="kn">import</span> <span class="n">LitellmModel</span>
<span class="kn">import</span> <span class="n">orjson</span>

<span class="c1"># ========== MCP 연결 ==========
</span>
<span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>

<span class="k">class</span> <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">command</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">class</span> <span class="nc">Connected</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">connect_servers</span><span class="p">(</span><span class="n">cfgs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPServerCfg</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Connected</span><span class="p">]:</span>
    <span class="n">conns</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">cfgs</span><span class="p">:</span>
        <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">args</span><span class="p">))</span>
        <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
        <span class="n">sess</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">sess</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
        <span class="n">conns</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">Connected</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">sess</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">conns</span>

<span class="k">def</span> <span class="nf">mcp_tool_to_function</span><span class="p">(</span><span class="n">server</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tool_meta</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FunctionTool</span><span class="p">:</span>
    <span class="n">namespaced</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">server</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">tool_meta</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span>
    <span class="n">params_schema</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">tool_meta</span><span class="p">,</span> <span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}})</span>
    <span class="n">desc</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">tool_meta</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">MCP </span><span class="si">{</span><span class="n">namespaced</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">on_invoke</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">args_json</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">args_json</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args_json</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">args_json</span><span class="p">}</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">tool_meta</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="n">packed</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">res</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">text</span><span class="p">})</span>
            <span class="k">elif</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">json</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">packed</span><span class="p">).</span><span class="nf">decode</span><span class="p">()</span>

    <span class="k">return</span> <span class="nc">FunctionTool</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">namespaced</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="n">desc</span><span class="p">,</span>
        <span class="n">params_json_schema</span><span class="o">=</span><span class="n">params_schema</span><span class="p">,</span>
        <span class="n">on_invoke_tool</span><span class="o">=</span><span class="n">on_invoke</span><span class="p">,</span>
    <span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">build_mcp_function_tools</span><span class="p">(</span><span class="n">cfgs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPServerCfg</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">FunctionTool</span><span class="p">]:</span>
    <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">FunctionTool</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">conns</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">connect_servers</span><span class="p">(</span><span class="n">cfgs</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">conns</span><span class="p">:</span>
        <span class="n">listed</span> <span class="o">=</span> <span class="k">await</span> <span class="n">c</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">listed</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
            <span class="n">tools</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">mcp_tool_to_function</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">c</span><span class="p">.</span><span class="n">session</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">tools</span>

<span class="c1"># ========== 일반 파이썬 함수 → FunctionTool ==========
</span>
<span class="k">def</span> <span class="nf">make_local_tools</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">FunctionTool</span><span class="p">]:</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">math_eval</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">args_json</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args_json</span><span class="p">)</span> <span class="k">if</span> <span class="n">args_json</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">expr</span> <span class="k">if</span> <span class="n">ch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="sh">"</span><span class="s">0123456789+-*/(). </span><span class="sh">"</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">expr must contain only digits and + - * / ( )</span><span class="sh">"</span><span class="p">})</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nf">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">__builtins__</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}},</span> <span class="p">{})</span>
            <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span> <span class="n">val</span><span class="p">})</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)})</span>

    <span class="k">return</span> <span class="p">[</span>
        <span class="nc">FunctionTool</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">안전 사칙연산 계산기. 입력: {expr: string}</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">params_json_schema</span><span class="o">=</span><span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="n">on_invoke_tool</span><span class="o">=</span><span class="n">math_eval</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">]</span>

<span class="c1"># ========== 실행 예시 ==========
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># 1) MCP 툴
</span>    <span class="n">mcp_tools</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">build_mcp_function_tools</span><span class="p">([</span>
        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">]),</span>
        <span class="c1"># MCPServerCfg(name="db", command="python", args=["./servers/db/server.py"]),
</span>    <span class="p">])</span>

    <span class="c1"># 2) 일반 Function 툴
</span>    <span class="n">local_tools</span> <span class="o">=</span> <span class="nf">make_local_tools</span><span class="p">()</span>

    <span class="c1"># 3) 모델 (네 커스텀 LLM OpenAI-호환 엔드포인트)
</span>    <span class="n">model</span> <span class="o">=</span> <span class="nc">LitellmModel</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000/v1</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">agent</span> <span class="o">=</span> <span class="nc">Agent</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">MixedToolsAgent</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">instructions</span><span class="o">=</span><span class="sh">"</span><span class="s">필요할 때만 툴을 호출한다. 파괴적 작업은 dry_run을 우선한다.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
        <span class="n">tools</span><span class="o">=</span><span class="n">mcp_tools</span> <span class="o">+</span> <span class="n">local_tools</span><span class="p">,</span>  <span class="c1"># 섞어서 등록
</span>    <span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span>
        <span class="n">agent</span><span class="p">,</span>
        <span class="nb">input</span><span class="o">=</span><span class="sh">"</span><span class="s">data 폴더의 sales.csv를 읽어 합계를 구하고, local.math_eval로 숫자 검증까지 해줘</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">final_output</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<h1 id="2-일반-chat-completions-with-tools-예제">2) 일반 Chat Completions (with tools) 예제</h1>

<p>OpenAI 호환 Chat Completions API를 직접 쓰는 순수 예시다. tools에 함수 스키마를 주고, tool_calls를 받아서 너의 실행기로 라우팅한다. 여기서는 로컬 계산기 하나만 보여주지만, 위의 MCP tools 리스트를 그대로 합쳐 넣으면 된다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">json</span><span class="p">,</span> <span class="n">requests</span>

<span class="n">BASE_URL</span> <span class="o">=</span> <span class="sh">"</span><span class="s">http://localhost:8000/v1</span><span class="sh">"</span>  <span class="c1"># 네 OpenAI 호환 엔드포인트
</span><span class="n">MODEL</span> <span class="o">=</span> <span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span>

<span class="n">tools</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">안전 사칙연산 계산기</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1"># 여기에 MCP에서 긁어온 tools도 그대로 append 가능
</span><span class="p">]</span>

<span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">필요할 때만 툴을 호출한다.</span><span class="sh">"</span><span class="p">},</span>
    <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">3*(2+5) 값을 계산해줘</span><span class="sh">"</span><span class="p">},</span>
<span class="p">]</span>

<span class="k">def</span> <span class="nf">run_local_math_eval</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
    <span class="n">expr</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">expr</span> <span class="k">if</span> <span class="n">ch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="sh">"</span><span class="s">0123456789+-*/(). </span><span class="sh">"</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">expr must contain only digits and + - * / ( )</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="nf">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">__builtins__</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}},</span> <span class="p">{})</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span> <span class="n">val</span><span class="p">}</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

<span class="c1"># 1차 요청
</span><span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span>
    <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">BASE_URL</span><span class="si">}</span><span class="s">/chat/completions</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">MODEL</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_choice</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">},</span>
    <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">resp</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
<span class="n">msg</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">]</span>
<span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

<span class="c1"># tool_calls 처리
</span><span class="k">if</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">]:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">]</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nf">run_local_math_eval</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">unknown tool </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
            <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="p">})</span>

    <span class="c1"># 2차 요청(도구 결과 반영)
</span>    <span class="n">resp2</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span>
        <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">BASE_URL</span><span class="si">}</span><span class="s">/chat/completions</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">MODEL</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">},</span>
        <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">resp2</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">resp2</span><span class="p">.</span><span class="nf">json</span><span class="p">()[</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">])</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
</code></pre></div></div>

<p>포인트<br />
tools에 MCP에서 긁은 스키마를 그대로 추가하면, 일반 chat completions 루프에서도 MCP와 로컬 툴을 함께 쓸 수 있다. 단, MCP 호출부는 너의 라우터가 처리해 tool 역할 메시지를 만들어 넣으면 된다.</p>

<h1 id="3-mcp-clientsession은-저절로-종료되나">3) MCP ClientSession은 저절로 종료되나?</h1>

<p>자동 종료를 기대하면 안 된다. 표준 패턴은 세 가지다.</p>

<ol>
  <li>
    <p>세션을 감싼 트랜스포트(StdIO/SSE)에 대해 stop/close를 명시적으로 호출한다.</p>
  </li>
  <li>
    <p>async with 컨텍스트를 제공하는 래퍼를 만들어 with 블록이 끝날 때 정리한다.</p>
  </li>
  <li>
    <p>프로세스 종료 훅에서 전역 세션들을 순서대로 정리한다.</p>
  </li>
</ol>

<p>간단 정리 함수 예시:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 세션과 트랜스포트를 함께 추적해야 안전
</span><span class="k">class</span> <span class="nc">MCPHandle</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">transport</span><span class="p">,</span> <span class="n">session</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">self</span><span class="p">.</span><span class="n">transport</span> <span class="o">=</span> <span class="n">transport</span>
        <span class="n">self</span><span class="p">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">transport</span><span class="p">.</span><span class="nf">stop</span><span class="p">()</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
</code></pre></div></div>

<p>세션을 열 때 MCPHandle을 만들어 리스트에 넣고, 애플리케이션 종료 시 모든 handle.close()를 await 하면 된다.</p>

<h1 id="4-여러-agent가-세션을-공유해도-될까-하나로-유지하는-전략과-주의점">4) 여러 Agent가 세션을 공유해도 될까? 하나로 유지하는 전략과 주의점</h1>

<p>결론부터 말하면, 공유 풀을 두고 재사용하는 게 일반적으로 좋다. 다만 몇 가지 주의점이 있다.</p>

<p>장점<br />
메모리·프로세스 수 절감. stdio 서버는 프로세스를 하나만 띄우면 된다.<br />
콜드 스타트 지연 감소. list_tools 캐시와 연결 수립 시간이 절약된다.</p>

<p>주의점<br />
동시성. 하나의 MCP 세션이 다중 호출을 처리할 때, 서버/클라이언트가 동시 호출을 안전하게 처리하는지 확인해야 한다. 대부분의 MCP 서버 구현은 괜찮지만, 특정 서버가 순차 처리만 안전하게 지원한다면 큐잉이나 세마포어가 필요하다.<br />
격리. 사용자·권한이 다른 Agent가 같은 세션을 쓰면 권한 경계가 흐려질 수 있다. 서버 인스턴스를 권한 단위로 분리하는 게 안전하다.<br />
생명주기. 누가 언제 닫을지 합의가 필요하다. 레퍼런스 카운팅 또는 명시적 init/close API가 필요하다.<br />
버전·옵션 차이. 같은 서버라도 플래그(예: dry_run 기본값)가 다른 Agent마다 다를 수 있다. 이땐 세션을 공유하지 말고 별도 인스턴스를 띄워라.</p>

<p>간단한 세션 풀 스캐폴딩(RefCount + AsyncLock):</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>

<span class="k">class</span> <span class="nc">MCPSessionPool</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_pool</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,...]],</span> <span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># key 예시: ("stdio", ("npx","-y","@modelcontextprotocol/server-filesystem","./data"))
</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">acquire_stdio</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">command</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ClientSession</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="nf">tuple</span><span class="p">([</span><span class="n">command</span><span class="p">]</span> <span class="o">+</span> <span class="n">args</span><span class="p">))</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="n">slot</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_pool</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">slot</span><span class="p">:</span>
                <span class="n">slot</span><span class="p">[</span><span class="sh">"</span><span class="s">ref</span><span class="sh">"</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">return</span> <span class="n">slot</span><span class="p">[</span><span class="sh">"</span><span class="s">session</span><span class="sh">"</span><span class="p">]</span>
            <span class="c1"># 새로 생성
</span>            <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">))</span>
            <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
            <span class="n">session</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_pool</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">ref</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="sh">"</span><span class="s">session</span><span class="sh">"</span><span class="p">:</span> <span class="n">session</span><span class="p">,</span> <span class="sh">"</span><span class="s">transport</span><span class="sh">"</span><span class="p">:</span> <span class="n">transport</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">}</span>
            <span class="k">return</span> <span class="n">session</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">release_stdio</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">command</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="nf">tuple</span><span class="p">([</span><span class="n">command</span><span class="p">]</span> <span class="o">+</span> <span class="n">args</span><span class="p">))</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="n">slot</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_pool</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">slot</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">slot</span><span class="p">[</span><span class="sh">"</span><span class="s">ref</span><span class="sh">"</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">slot</span><span class="p">[</span><span class="sh">"</span><span class="s">ref</span><span class="sh">"</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">slot</span><span class="p">[</span><span class="sh">"</span><span class="s">session</span><span class="sh">"</span><span class="p">].</span><span class="nf">close</span><span class="p">()</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">slot</span><span class="p">[</span><span class="sh">"</span><span class="s">transport</span><span class="sh">"</span><span class="p">].</span><span class="nf">stop</span><span class="p">()</span>
                    <span class="k">finally</span><span class="p">:</span>
                        <span class="n">self</span><span class="p">.</span><span class="n">_pool</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
</code></pre></div></div>

<p>사용 패턴<br />
Agent가 시작할 때 acquire_stdio로 세션을 받아 쓰고, 끝날 때 release_stdio로 반납한다. 동일한 command/args 조합은 한 세션을 공유한다. 권한 격리가 필요한 경우 key에 추가 식별자(tenant, role 등)를 포함시키면 된다. 동시성 밀도가 높다면 각 MCP 서버 특성에 맞춰 per-server 세마포어를 더해주는 게 안전하다.</p>

<p>마무리 팁<br />
섞인 환경(일반 함수 + MCP)에서는 툴 수가 늘어 혼란이 생기기 쉬우니, 에이전트에 등록할 때 도메인별 프리픽스(server:tool, local.*)와 짧고 명확한 설명, 엄격한 JSON 스키마(required/enum/format)를 유지하자. 필요하면 한 턴에 노출할 툴을 필터링해 과적재를 줄이는 것도 효과적이다.</p>

<p class="chat--user">

1번과 2번을 합쳐서 써야지. 두 개 툴 구현이 너무 다르잖아. 툴 구현을 한 번만 하고 두 군데 모두에서 쓰고 싶은거야.

</p>

<p>좋아, “툴 구현은 한 번만” 하고, 그걸 두 방식 모두에서 재사용하도록 합치자. 아래 스캐폴딩은 단일 ToolRegistry에 툴을 등록하고, 같은 구현을 1) OpenAI Agents SDK(FunctionTool) 경로, 2) 일반 Chat Completions(with tools) 경로 양쪽에서 그대로 씁니다. MCP 툴도 동일한 추상화로 래핑합니다.</p>

<p>설치<br />
pip install "openai-agents[litellm]" mcp pydantic orjson requests</p>

<p>unified_tools.py</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Awaitable</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">import</span> <span class="n">orjson</span>
<span class="kn">import</span> <span class="n">requests</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>

<span class="c1">###############################################################################
# 공통 추상화: 한 번 구현한 툴을 어디서든 재사용
###############################################################################
</span>
<span class="c1"># Tool 핸들러 시그니처: args(dict) -&gt; dict/str (awaitable)
</span><span class="n">ToolHandler</span> <span class="o">=</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">Awaitable</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>

<span class="k">class</span> <span class="nc">ToolSpec</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># JSON Schema
</span>    <span class="n">handler</span><span class="p">:</span> <span class="n">ToolHandler</span>        <span class="c1"># 실제 실행 로직(동일 구현을 양쪽에서 재사용)
</span>
<span class="k">class</span> <span class="nc">ToolRegistry</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ToolSpec</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="n">ToolSpec</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">spec</span><span class="p">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">duplicated tool name: </span><span class="si">{</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">[</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ToolSpec</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">list_specs</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nf">list</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">.</span><span class="nf">values</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">list_for_chat_completions</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="c1"># OpenAI tools 포맷으로 직렬화
</span>        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="nf">list_specs</span><span class="p">():</span>
            <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">parameters</span>
                <span class="p">}</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">out</span>

<span class="c1">###############################################################################
# 로컬(일반) 툴 구현 예시: 한 번만 구현
###############################################################################
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">math_eval_handler</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="n">expr</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">expr</span> <span class="k">if</span> <span class="n">ch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="sh">"</span><span class="s">0123456789+-*/(). </span><span class="sh">"</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">expr must contain only digits and + - * / ( )</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="nf">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">__builtins__</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}},</span> <span class="p">{})</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span> <span class="n">val</span><span class="p">}</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

<span class="n">LOCAL_MATH_TOOL</span> <span class="o">=</span> <span class="nc">ToolSpec</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">안전 사칙연산 계산기. 입력 {expr: string}</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">parameters</span><span class="o">=</span><span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}},</span>
        <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">],</span>
        <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
    <span class="p">},</span>
    <span class="n">handler</span><span class="o">=</span><span class="n">math_eval_handler</span>
<span class="p">)</span>

<span class="c1">###############################################################################
# MCP 툴을 동일 추상화로 래핑: 세션별로 ToolSpec을 생성
###############################################################################
</span>
<span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="n">mcp.client.sse</span> <span class="kn">import</span> <span class="n">SSEClientTransport</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">False</span>

<span class="k">class</span> <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>           <span class="c1"># 네임스페이스 prefix
</span>    <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span>           <span class="c1"># "stdio" | "sse"
</span>    <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">class</span> <span class="nc">MCPHandle</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">transport</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">self</span><span class="p">.</span><span class="n">transport</span> <span class="o">=</span> <span class="n">transport</span>
        <span class="n">self</span><span class="p">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">transport</span><span class="p">.</span><span class="nf">stop</span><span class="p">()</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">connect_mcp</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">MCPServerCfg</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MCPHandle</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">args</span> <span class="ow">or</span> <span class="p">[]))</span>
    <span class="k">elif</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">HAVE_SSE</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">mcp.client.sse 모듈 필요</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">transport</span> <span class="o">=</span> <span class="nc">SSEClientTransport</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">headers</span> <span class="ow">or</span> <span class="p">{})</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">unknown kind: </span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
    <span class="n">session</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
    <span class="k">return</span> <span class="nc">MCPHandle</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">transport</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">mcp_toolspecs_from_session</span><span class="p">(</span><span class="n">server_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]:</span>
    <span class="c1"># 동기 함수로 명세만 만들고, handler는 session을 캡처하여 비동기로 호출
</span>    <span class="c1"># list_tools 는 async라 밖에서 호출해 metadata를 넘겨줘야 한다.
</span>    <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">call build_mcp_tools(...) instead</span><span class="sh">"</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">build_mcp_tools</span><span class="p">(</span><span class="n">handle</span><span class="p">:</span> <span class="n">MCPHandle</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]:</span>
    <span class="n">listed</span> <span class="o">=</span> <span class="k">await</span> <span class="n">handle</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
    <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">listed</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
        <span class="n">namespaced</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">handle</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}})</span>
        <span class="n">desc</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">MCP </span><span class="si">{</span><span class="n">namespaced</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

        <span class="k">async</span> <span class="k">def</span> <span class="nf">_handler</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="o">*</span><span class="p">,</span> <span class="n">_tool</span><span class="o">=</span><span class="n">t</span><span class="p">):</span>
            <span class="c1"># _tool를 default 인자로 바인딩해 late-binding 이슈 방지
</span>            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">handle</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">_tool</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{})</span>
            <span class="n">packed</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">res</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
                    <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">text</span><span class="p">})</span>
                <span class="k">elif</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span>
                    <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">json</span><span class="p">})</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span><span class="p">})</span>
            <span class="k">return</span> <span class="n">packed</span>

        <span class="n">specs</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ToolSpec</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">namespaced</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="n">desc</span><span class="p">,</span>
            <span class="n">parameters</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span>
            <span class="n">handler</span><span class="o">=</span><span class="n">_handler</span>
        <span class="p">))</span>
    <span class="k">return</span> <span class="n">specs</span>

<span class="c1">###############################################################################
# 1) OpenAI Agents SDK 경로: FunctionTool로 래핑하되, handler는 동일 구현 사용
###############################################################################
</span>
<span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Runner</span><span class="p">,</span> <span class="n">FunctionTool</span>
<span class="kn">from</span> <span class="n">agents.extensions.models.litellm_model</span> <span class="kn">import</span> <span class="n">LitellmModel</span>

<span class="k">def</span> <span class="nf">to_function_tool</span><span class="p">(</span><span class="n">spec</span><span class="p">:</span> <span class="n">ToolSpec</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FunctionTool</span><span class="p">:</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">on_invoke</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">args_json</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args_json</span><span class="p">)</span> <span class="k">if</span> <span class="n">args_json</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">args_json</span><span class="p">}</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">spec</span><span class="p">.</span><span class="nf">handler</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="c1"># 에이전트는 문자열 반환이 표준이므로 JSON 문자열로 직렬화
</span>        <span class="k">return</span> <span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">).</span><span class="nf">decode</span><span class="p">()</span>

    <span class="k">return</span> <span class="nc">FunctionTool</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="n">spec</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>
        <span class="n">params_json_schema</span><span class="o">=</span><span class="n">spec</span><span class="p">.</span><span class="n">parameters</span><span class="p">,</span>
        <span class="n">on_invoke_tool</span><span class="o">=</span><span class="n">on_invoke</span>
    <span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_with_agents</span><span class="p">(</span><span class="n">reg</span><span class="p">:</span> <span class="n">ToolRegistry</span><span class="p">,</span> <span class="n">user_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="p">[</span><span class="nf">to_function_tool</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">reg</span><span class="p">.</span><span class="nf">list_specs</span><span class="p">()]</span>
    <span class="n">model</span> <span class="o">=</span> <span class="nc">LitellmModel</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000/v1</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">agent</span> <span class="o">=</span> <span class="nc">Agent</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">UnifiedToolsAgent</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">instructions</span><span class="o">=</span><span class="sh">"</span><span class="s">필요할 때만 툴을 호출한다. 파괴적 작업은 dry_run을 우선한다.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
        <span class="n">tools</span><span class="o">=</span><span class="n">tools</span>
    <span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">user_text</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">final_output</span><span class="p">)</span>

<span class="c1">###############################################################################
# 2) 일반 Chat Completions 경로: tools JSON + 동일 handler로 tool_calls 라우팅
###############################################################################
</span>
<span class="k">class</span> <span class="nc">ChatCompletionsRunner</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/v1/chat/completions</span><span class="sh">"</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">self</span><span class="p">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>

    <span class="k">def</span> <span class="nf">_headers</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">h</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content-type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="p">:</span>
            <span class="n">h</span><span class="p">[</span><span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Bearer </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="si">}</span><span class="sh">"</span>
        <span class="k">return</span> <span class="n">h</span>

    <span class="k">def</span> <span class="nf">_post</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">base_url</span><span class="si">}{</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="nf">_headers</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
        <span class="n">r</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">r</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">reg</span><span class="p">:</span> <span class="n">ToolRegistry</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">tools</span> <span class="o">=</span> <span class="n">reg</span><span class="p">.</span><span class="nf">list_for_chat_completions</span><span class="p">()</span>

        <span class="c1"># 1차 호출
</span>        <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_post</span><span class="p">({</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_choice</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">})</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">]</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># 도구 호출 처리 루프(필요 시 반복)
</span>        <span class="k">while</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">]:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">]</span>
                <span class="n">raw_args</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw_args</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">raw_args</span><span class="p">}</span>

                <span class="n">spec</span> <span class="o">=</span> <span class="n">reg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">spec</span><span class="p">.</span><span class="nf">handler</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

                <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">).</span><span class="nf">decode</span><span class="p">()</span>
                <span class="p">})</span>

            <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_post</span><span class="p">({</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">})</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">]</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">msg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>

<span class="c1">###############################################################################
# 실행 예시: 한 번 구현 → 두 경로에서 사용
###############################################################################
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># 0) 레지스트리 생성 및 로컬 툴 등록(한 번만)
</span>    <span class="n">reg</span> <span class="o">=</span> <span class="nc">ToolRegistry</span><span class="p">()</span>
    <span class="n">reg</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="n">LOCAL_MATH_TOOL</span><span class="p">)</span>

    <span class="c1"># 1) MCP 세션 연결 후, MCP 툴들을 동일 추상화로 등록
</span>    <span class="n">files_cfg</span> <span class="o">=</span> <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">])</span>
    <span class="n">files_handle</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">connect_mcp</span><span class="p">(</span><span class="n">files_cfg</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="k">await</span> <span class="nf">build_mcp_tools</span><span class="p">(</span><span class="n">files_handle</span><span class="p">):</span>
            <span class="n">reg</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>

        <span class="c1"># A) Agents SDK 경로
</span>        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=== Agents SDK 경로 ===</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">await</span> <span class="nf">run_with_agents</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="sh">"</span><span class="s">data 폴더의 sales.csv를 읽고 합계를 계산한 뒤 local.math_eval로 2배를 계산해줘</span><span class="sh">"</span><span class="p">)</span>

        <span class="c1"># B) 일반 Chat Completions 경로
</span>        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=== Chat Completions 경로 ===</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">runner</span> <span class="o">=</span> <span class="nc">ChatCompletionsRunner</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000</span><span class="sh">"</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="n">runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span>
            <span class="n">reg</span><span class="p">,</span>
            <span class="n">messages</span><span class="o">=</span><span class="p">[</span>
                <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">필요할 때만 툴을 호출한다. 파괴적 작업은 dry_run을 우선한다.</span><span class="sh">"</span><span class="p">},</span>
                <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">files 서버 툴로 sales.csv 합계를 구하고 local.math_eval로 100+23도 계산해줘</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">files_handle</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>핵심 포인트 정리<br />
툴은 ToolSpec(handler 포함)으로 한 번만 구현한다. MCP도 build_mcp_tools가 동일한 ToolSpec을 만들고, 로컬 툴도 같은 형태다.<br />
OpenAI Agents SDK는 FunctionTool로 얇게 래핑만 한다. on_invoke는 같은 handler를 호출한다.<br />
Chat Completions(with tools)도 registry의 tools JSON을 그대로 사용하고, tool_calls를 같은 handler로 라우팅한다.<br />
MCP 세션은 MCPHandle.close로 명시 종료한다. 여러 Agent나 여러 러너가 있을 때 공유하고 싶다면 핸들 풀을 두고 레퍼런스 카운팅만 얹으면 된다.</p>

<p>이제 “툴 구현은 한 번만” 쓰고, Agents와 Chat Completions 어디서든 동일하게 돌아간다. 필요한 경우 expose(툴 소출) 정책이나 권한 게이트를 registry 레벨에서 필터링 훅으로 추가하면 된다.</p>

        
      </section>

      <footer class="page__meta">
        
        


  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      <a href="/categories/#llm" class="page__taxonomy-item p-category" rel="tag">llm</a>
    
    </span>
  </p>


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time class="dt-published" datetime="2025-10-28T20:16:40+09:00">2025-10-28</time></p>

      </footer>

      

      
  <nav class="pagination">
    
      <a href="/python/python-decorator/" class="pagination--pager" title="Python 데코레이터 설명">Previous</a>
    
    
      <a href="/2025-08-19-python-repr-vs-str/" class="pagination--pager" title="">Next</a>
    
  </nav>


    </div>

    
  </article>

  
  
    
<div class="page__related">
  
  <h2 class="page__related-title">You may also enjoy</h2>
  <div class="grid__wrapper">
    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/2025-08-19-python-repr-vs-str/" rel="permalink">
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <!-- hvppyarchive: remove date icon
        <i class="far fa-calendar-alt" aria-hidden="true"></i> 
        -->
        
        <time datetime="2025-10-28T20:16:45+09:00">2025-10-28</time>
      </span>
    

    

    
  </p>


    <p class="archive__item-excerpt" itemprop="description">
</p>
  </article>
</div>

    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/python/python-decorator/" rel="permalink">Python 데코레이터 설명
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <!-- hvppyarchive: remove date icon
        <i class="far fa-calendar-alt" aria-hidden="true"></i> 
        -->
        
        <time datetime="2025-10-28T16:53:51+09:00">2025-10-28</time>
      </span>
    

    

    
  </p>


    <p class="archive__item-excerpt" itemprop="description">

</p>
  </article>
</div>

    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/python/file-memory-cache/" rel="permalink">파일 캐시 패키지 추천
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <!-- hvppyarchive: remove date icon
        <i class="far fa-calendar-alt" aria-hidden="true"></i> 
        -->
        
        <time datetime="2025-10-28T13:03:49+09:00">2025-10-28</time>
      </span>
    

    

    
  </p>


    <p class="archive__item-excerpt" itemprop="description">

</p>
  </article>
</div>

    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/llm/comfyui-llm-tool-call/" rel="permalink">ComfyUI LLM Tool Call
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <!-- hvppyarchive: remove date icon
        <i class="far fa-calendar-alt" aria-hidden="true"></i> 
        -->
        
        <time datetime="2025-10-27T15:55:08+09:00">2025-10-27</time>
      </span>
    

    

    
  </p>


    <p class="archive__item-excerpt" itemprop="description">

</p>
  </article>
</div>

    
  </div>
</div>

  
  
</div>

      
    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';" role="search">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        

<div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
      
        
      
        
      
        
      
        
      
        
      
    

    
  </ul>
</div>


<div class="page__footer-copyright">&copy; 2013 - 2025 <a href="https://hvppyarchive.github.io">ARCHIVE</a>. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/jekyll-themes/minimal-mistakes/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>






  </body>
</html>
