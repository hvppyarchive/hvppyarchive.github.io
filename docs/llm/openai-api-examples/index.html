<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.27.1 by Michael Rose
  Copyright 2013-2025 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->

<html lang="en-US" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>OpenAI 함수 호출 테스트 - ARCHIVE</title>
<meta name="description" content="">


  <meta name="author" content="hvppyarchive">
  
  <meta property="article:author" content="hvppyarchive">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="ARCHIVE">
<meta property="og:title" content="OpenAI 함수 호출 테스트">
<meta property="og:url" content="https://hvppyarchive.github.io/llm/openai-api-examples/">


  <meta property="og:description" content="">







  <meta property="article:published_time" content="2025-10-24T14:08:27+09:00">





  

  


<link rel="canonical" href="https://hvppyarchive.github.io/llm/openai-api-examples/">












<!-- end _includes/seo.html -->


<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
  
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css"></noscript>



    <!-- start custom head snippets -->
<!-- hvppyarchive: add fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@200..900&display=swap" rel="stylesheet">

<!-- insert favicons. use https://realfavicongenerator.net/ -->
 <!-- hvppyarchive: add favicons -->
<link rel="icon" type="image/png" href="/assets/favicon/favicon-96x96.png" sizes="96x96" />
<link rel="icon" type="image/svg+xml" href="/assets/favicon/favicon.svg" />
<link rel="shortcut icon" href="/assets/favicon/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon/apple-touch-icon.png" />
<link rel="manifest" href="/assets/favicon/site.webmanifest" />

<!-- end custom head snippets -->

  </head>

  <body class="layout--single" dir="ltr">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          ARCHIVE
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a
                href="/year-archive/"
                
                
              >Posts</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <i class="fas fa-search"></i>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      





<div id="main" role="main">
  


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="OpenAI 함수 호출 테스트">
    <meta itemprop="description" content="">
    <meta itemprop="datePublished" content="2025-10-24T14:08:27+09:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">
            <a href="https://hvppyarchive.github.io/llm/openai-api-examples/" itemprop="url">OpenAI 함수 호출 테스트
</a>
          </h1>
          

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <!-- hvppyarchive: remove date icon
        <i class="far fa-calendar-alt" aria-hidden="true"></i> 
        -->
        
        <time datetime="2025-10-24T14:08:27+09:00">2025-10-24</time>
      </span>
    

    

    
  </p>


        </header>
      

      <section class="page__content" itemprop="text">
        
        <p class="chat--user">

openai package를 사용하는 테스트 코드 작성할거야. 목표: 2가지 모델에 대해 2가지 api type(completions, responses)에 대해 function calling 테스트를 하고 싶어. 총 4개 조합에 대해 설정할 수 있게 코드 작성 하자. 툴은 간단히 특정 폴더의 파일 조회, 특정 폴더의 파일 읽기 두 가지 툴을 구현할거야 2개 모델에 대한 엔드포인트, api 키, 모델명을 코드 내에서 설정할 수 있도록 할 것.

</p>

<p>좋아! 아래는 “두 모델 × 두 API 타입(completions, responses) × 함수 호출(function calling)” 조합을 한 파일에서 모두 테스트할 수 있는 파이썬 스크립트야.<br />
요구사항 정리대로</p>

<ol>
  <li>
    <p>두 가지 파일 관련 툴(폴더 내 파일 목록 조회, 파일 읽기)</p>
  </li>
  <li>
    <p>2개 모델에 대한 엔드포인트·API 키·모델명을 코드 내에서 설정 가능</p>
  </li>
  <li>
    <p>4가지 조합을 원하는 대로 실행 가능</p>
  </li>
</ol>

<p>을 모두 담았어. 최신 OpenAI Python SDK의 사용법과 Responses API의 툴 호출 흐름은 공식 문서의 구조를 따랐어. 참고: function calling과 tools 정의 방식은 공식 가이드와 동일하고, Chat Completions API에서는 tool_calls를 message에, Responses API에서는 output 항목과 tool_calls를 통해 주고받는 형태야. 관련 문서: Function Calling 가이드와 Responses API 레퍼런스. <a href="https://platform.openai.com/docs/guides/function-calling">OpenAI 플랫폼+1</a></p>

<p>스크립트는 다음처럼 동작해</p>

<ul>
  <li>
    <p>MODELS 섹션에서 model A/B의 endpoint, api_key, model 이름을 채워둔다(예시 포함).</p>
  </li>
  <li>
    <p>TOOL 정의는 공통(JSON Schema).</p>
  </li>
  <li>
    <p>run_with_chat_completions(…), run_with_responses(…) 두 함수가 각각 함수 호출 루프를 수행.</p>
  </li>
  <li>
    <p>main에서 네 가지 조합을 순차 실행하거나, 원하는 조합만 선택 실행하도록 CLI 옵션 제공.</p>
  </li>
</ul>

<p>코드 복사해서 test_openai_tools.py로 저장한 뒤, samples 폴더에 테스트용 파일을 몇 개 넣고 돌려봐.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># test_openai_tools.py
# Python 3.10+
# pip install --upgrade openai
</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">argparse</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>

<span class="c1"># =========================
# 1) 구성(모델/엔드포인트/키)
# =========================
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ModelConfig</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span>               <span class="c1"># ex) "https://api.openai.com/v1"
</span>    <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span>                <span class="c1"># ex) os.getenv("OPENAI_API_KEY")
</span>
<span class="c1"># 여기서 두 모델에 대한 엔드포인트/키/모델명을 설정하세요.
# 실제 키를 코드에 하드코딩하지 말고, 환경변수를 권장합니다.
</span><span class="n">MODELS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-4.1-mini</span><span class="sh">"</span><span class="p">,</span>          <span class="c1"># 예시 (원하는 최신 모델명으로 변경)
</span>        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_MODEL_A</span><span class="sh">"</span><span class="p">)</span>
    <span class="p">),</span>
    <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">,</span>           <span class="c1"># 예시 (원하는 최신 모델명으로 변경)
</span>        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL_B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY_B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_MODEL_B</span><span class="sh">"</span><span class="p">)</span>
    <span class="p">),</span>
<span class="p">}</span>

<span class="c1"># =====================================
# 2) 로컬 파일 툴(폴더 목록/파일 읽기)
# =====================================
</span>
<span class="k">def</span> <span class="nf">list_files_in_folder</span><span class="p">(</span><span class="n">folder_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">지정 폴더 내 파일 목록 반환(파일만).</span><span class="sh">"""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">items</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">listdir</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">items</span> <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">f</span><span class="p">))]</span>
    <span class="k">return</span> <span class="n">files</span>

<span class="k">def</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">지정 경로의 텍스트 파일 내용 반환(UTF-8 가정).</span><span class="sh">"""</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">return</span> <span class="sh">""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
    <span class="k">except</span> <span class="nb">UnicodeDecodeError</span><span class="p">:</span>
        <span class="c1"># 바이너리 등 텍스트가 아닌 경우
</span>        <span class="k">return</span> <span class="sh">""</span>

<span class="c1"># 공통 툴 스키마(JSON Schema; Chat Completions/Responses에서 그대로 사용)
</span><span class="n">TOOLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content as a string.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative path to the text file.</span><span class="sh">"</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">]</span>

<span class="c1"># 툴 디스패처
</span><span class="k">def</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arguments</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="n">arguments</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="nf">list_files_in_folder</span><span class="p">(</span><span class="n">folder</span><span class="p">),</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">arguments</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="k">return</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span>

<span class="c1"># =====================================
# 3) Chat Completions로 함수 호출 테스트
# =====================================
</span>
<span class="k">def</span> <span class="nf">run_with_chat_completions</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tool_choice</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Chat Completions API로 function calling 테스트.
    - tools: TOOLS
    - tool_choice: </span><span class="sh">'</span><span class="s">auto</span><span class="sh">'</span><span class="s"> 권장
    - tool_calls -&gt; 실제 파이썬 함수 실행 -&gt; tool 메시지 첨부 -&gt; 재호출
    </span><span class="sh">"""</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>

    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_task</span><span class="p">},</span>
    <span class="p">]</span>

    <span class="c1"># 1차 호출
</span>    <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
        <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
        <span class="n">tools</span><span class="o">=</span><span class="n">TOOLS</span><span class="p">,</span>
        <span class="n">tool_choice</span><span class="o">=</span><span class="n">tool_choice</span>  <span class="c1"># 'auto' or {'type':'function','function':{'name':'...'}}
</span>    <span class="p">)</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

    <span class="c1"># 함수 호출 루프
</span>    <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
            <span class="n">fn_name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
            <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">tool_output</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>

            <span class="c1"># tool 메시지 첨부
</span>            <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">tool_output</span>
            <span class="p">})</span>

        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">]})</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

        <span class="c1"># 후속 호출(최종 답변 유도)
</span>        <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">messages</span><span class="o">=</span><span class="n">messages</span>
        <span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

    <span class="k">return</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span>

<span class="c1"># =====================================
# 4) Responses API로 함수 호출 테스트
#    - 최신 SDK 규약에 맞춰 비스트리밍 루프 구성
# =====================================
</span>
<span class="k">def</span> <span class="nf">extract_text_from_responses_output</span><span class="p">(</span><span class="n">output_items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Responses API의 output 배열에서 자연어 텍스트만 모아 반환.</span><span class="sh">"""</span>
    <span class="n">chunks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output_items</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="c1"># item.type == "message" 인 경우, item.content[*] 중 type == "output_text"
</span>        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]:</span>
                <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                    <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
        <span class="c1"># 일부 모델은 최종에 바로 output_text만 내보내기도 함
</span>        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
    <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">chunks</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">extract_tool_calls_from_responses_output</span><span class="p">(</span><span class="n">output_items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="sh">"""</span><span class="s">
    Responses API의 output에서 tool_call 이벤트를 수집.
    각 항목은 {id, name, arguments} 형태로 정규화해서 반환.
    </span><span class="sh">"""</span>
    <span class="n">calls</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output_items</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="c1"># 케이스1: item.type == "tool_call"
</span>        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">tool_call</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">tc</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}</span>
            <span class="p">}</span>
            <span class="c1"># arguments는 문자열/딕셔너리 모두 가능성 고려
</span>            <span class="n">raw_args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">raw_args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">raw_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw_args</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">raw_args</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">tc</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">raw_args</span> <span class="ow">or</span> <span class="p">{}</span>
            <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">tc</span><span class="p">)</span>

        <span class="c1"># 케이스2: item.type == "message" 내부 content[*]에 tool_calls 묶여있을 수 있음
</span>        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="c1"># 일부 SDK 버전에서 item.tool_calls 또는 item.content[*].tool_calls 형태
</span>            <span class="n">inner_calls</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inner_calls</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">inner_calls</span><span class="p">:</span>
                    <span class="n">arg_obj</span> <span class="o">=</span> <span class="n">c</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="p">{}</span>
                    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">arg_obj</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">arg_obj</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">arg_obj</span><span class="p">)</span>
                        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                            <span class="n">arg_obj</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                        <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">function</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                        <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">arg_obj</span> <span class="ow">or</span> <span class="p">{}</span>
                    <span class="p">})</span>
    <span class="k">return</span> <span class="n">calls</span>

<span class="k">def</span> <span class="nf">run_with_responses</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tool_choice</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Responses API로 function calling 테스트.
    흐름:
      1) responses.create(input=[{role:user, content:...}], tools=TOOLS, tool_choice=...)
      2) tool_call이 있으면 로컬 함수 실행
      3) responses.create(..., tool_outputs=[{tool_call_id, output}], response_id=prev.id) 로 이어서 호출
         (최신 문서의 규약을 따름)
    </span><span class="sh">"""</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>

    <span class="c1"># 1차 호출
</span>    <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
        <span class="nb">input</span><span class="o">=</span><span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_task</span><span class="p">}],</span>
        <span class="n">tools</span><span class="o">=</span><span class="n">TOOLS</span><span class="p">,</span>
        <span class="n">tool_choice</span><span class="o">=</span><span class="n">tool_choice</span>
    <span class="p">)</span>

    <span class="c1"># 루프: 도구 호출이 끝날 때까지
</span>    <span class="n">final_text_parts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>  <span class="c1"># 안전 상한
</span>        <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">tool_calls</span> <span class="o">=</span> <span class="nf">extract_tool_calls_from_responses_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="n">plain_text</span> <span class="o">=</span> <span class="nf">extract_text_from_responses_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="k">if</span> <span class="n">plain_text</span><span class="p">:</span>
            <span class="n">final_text_parts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">plain_text</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">tool_calls</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="n">tool_outputs_payload</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">tool_calls</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">tc</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">tc</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
            <span class="n">tool_outputs_payload</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">tc</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">out</span>
            <span class="p">})</span>

        <span class="c1"># 이전 response와 이어 붙여 툴 결과를 전달
</span>        <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">TOOLS</span><span class="p">,</span>
            <span class="n">response_id</span><span class="o">=</span><span class="n">r</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
            <span class="n">tool_outputs</span><span class="o">=</span><span class="n">tool_outputs_payload</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">final_text_parts</span> <span class="k">if</span> <span class="n">p</span><span class="p">])</span>

<span class="c1"># =====================================
# 5) 실행부(4가지 조합)
# =====================================
</span>
<span class="n">DEFAULT_USER_TASK</span> <span class="o">=</span> <span class="p">(</span>
    <span class="sh">"</span><span class="s">테스트: ./samples 폴더 안의 파일 목록을 보여주고, 텍스트 파일이 하나라도 있으면 </span><span class="sh">"</span>
    <span class="sh">"</span><span class="s">그 중 하나의 내용을 읽어서 핵심만 2~3문장으로 요약해줘. 필요하면 툴을 사용해.</span><span class="sh">"</span>
<span class="p">)</span>

<span class="k">def</span> <span class="nf">run_one</span><span class="p">(</span><span class="n">combo_api</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">MODELS</span><span class="p">[</span><span class="n">model_key</span><span class="p">]</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">=== [</span><span class="si">{</span><span class="n">combo_api</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span><span class="si">}</span><span class="s">] with Model </span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="s"> (</span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">) ===</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">combo_api</span> <span class="o">==</span> <span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nf">run_with_chat_completions</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">user_task</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">combo_api</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nf">run_with_responses</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">user_task</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">combo_api must be </span><span class="sh">'</span><span class="s">completions</span><span class="sh">'</span><span class="s"> or </span><span class="sh">'</span><span class="s">responses</span><span class="sh">'"</span><span class="p">)</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">--- OUTPUT ---</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">out</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">(empty)</span><span class="sh">"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="nc">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Test function-calling with OpenAI (4-way matrix).</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--api</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">all</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">all</span><span class="sh">"</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">Which API type to run.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--model</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">Which model to use.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--task</span><span class="sh">"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_USER_TASK</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">User task/prompt.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="nf">parse_args</span><span class="p">()</span>

    <span class="n">apis</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">api</span> <span class="o">==</span> <span class="sh">"</span><span class="s">all</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">api</span><span class="p">]</span>
    <span class="n">models</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">model</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">model</span><span class="p">]</span>

    <span class="c1"># 샘플 폴더 안내
</span>    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="sh">"</span><span class="s">./samples</span><span class="sh">"</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">api</span> <span class="ow">in</span> <span class="n">apis</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">:</span>
            <span class="nf">run_one</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">task</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="nf">main</span><span class="p">()</span>
</code></pre></div></div>

<p>사용 방법 간단 정리</p>

<ol>
  <li>환경 변수 세팅(권장)</li>
</ol>

<ul>
  <li>
    <p>Model A</p>

    <ul>
      <li>
        <p>OPENAI_API_KEY=…</p>
      </li>
      <li>
        <p>OPENAI_BASE_URL=https://api.openai.com/v1</p>
      </li>
    </ul>
  </li>
  <li>
    <p>Model B</p>

    <ul>
      <li>
        <p>OPENAI_API_KEY_B=…</p>
      </li>
      <li>
        <p>OPENAI_BASE_URL_B=https://api.openai.com/v1</p>
      </li>
    </ul>
  </li>
</ul>

<ol>
  <li>테스트 파일 준비</li>
</ol>

<ul>
  <li>프로젝트 루트에 samples 폴더를 만들고, 텍스트 파일을 1개 이상 넣는다. 예: samples/readme.txt</li>
</ul>

<ol>
  <li>실행</li>
</ol>

<ul>
  <li>
    <p>네 조합 모두:<br />
python test_openai_tools.py</p>
  </li>
  <li>
    <p>특정 API만:<br />
python test_openai_tools.py –api completions<br />
python test_openai_tools.py –api responses</p>
  </li>
  <li>
    <p>특정 모델만:<br />
python test_openai_tools.py –model A<br />
python test_openai_tools.py –model B</p>
  </li>
  <li>
    <p>프롬프트 커스터마이즈:<br />
python test_openai_tools.py –task "여기에 원하는 테스트 지시문"</p>
  </li>
</ul>

<p>구현 포인트 설명(필요 시 점검할 체크리스트)</p>

<ul>
  <li>
    <p>Chat Completions: response.choices[0].message.tool_calls를 확인하고, 각 툴을 실행한 뒤 tool 메시지를 추가해서 재호출하는 전형적 루프를 사용했어. 이것은 Function Calling 가이드의 권고 패턴이야. <a href="https://platform.openai.com/docs/guides/function-calling">OpenAI 플랫폼</a></p>
  </li>
  <li>
    <p>Responses API: responses.create(…) → output에서 tool_call 이벤트를 수집 → 실제 함수 실행 → tool_outputs와 이전 response_id를 함께 넘겨 후속 responses.create(…) 호출로 이어 붙이는 패턴이야. 이 흐름은 공식 Responses API 레퍼런스가 안내하는 방식과 맞물려 있어. <a href="https://platform.openai.com/docs/api-reference/responses/create">OpenAI 플랫폼</a></p>
  </li>
  <li>
    <p>tools 스키마는 두 API에서 동일하게 재사용.</p>
  </li>
  <li>
    <p>로컬 파일 I/O는 안전하게 예외 처리했고, 텍스트 파일로 가정(UTF-8)했지만 디코딩 실패 시 빈 문자열을 반환해 모델이 적절히 안내하도록 했어.</p>
  </li>
</ul>

<p>문서 참고 링크</p>

<ul>
  <li>
    <p>Function Calling 가이드(툴 정의/호출 흐름) <a href="https://platform.openai.com/docs/guides/function-calling">OpenAI 플랫폼</a></p>
  </li>
  <li>
    <p>Responses API 레퍼런스(응답 구조, tool_outputs 전달 방식) <a href="https://platform.openai.com/docs/api-reference/responses/create">OpenAI 플랫폼</a></p>
  </li>
</ul>

<p>필요하면</p>

<ul>
  <li>
    <p>모델명만 바꿔서(예: 최신 gpt-4.1 계열 등) 즉시 시험 가능</p>
  </li>
  <li>
    <p>tool_choice를 "any"로 바꾸면 여러 툴 병렬 호출 경향을 더 시험할 수 있어</p>
  </li>
  <li>
    <p>samples 폴더 경로나 읽을 파일 선택 로직을 더 엄격하게 지정하고 싶다면, 프롬프트를 고정(seed task)하거나 시스템 메시지쪽에 규칙을 더해도 좋아</p>
  </li>
</ul>

<p>원하는 부분 더 바꿔드릴게.</p>

<p class="chat--user">

아니 내가 조사했을 때 responses용 툴 json이 있고, completion용이 따로 있어 조금 다르게 생겼던데 찾아서 반영해줘

</p>

<p>좋은 지적이야. 실제로 “도구 정의(tools JSON)”는 두 API가 거의 같지만, Responses API는 실행·상태 전파 방식(response_id, tool_outputs 등)과 출력 구조가 다르고, 가이드에선 Responses 예시에서 엄격 파싱(strict) 옵션을 곁들여 쓰는 패턴이 자주 보여서 모양이 살짝 달라 보일 수 있어. 그래서 아래처럼 아예 두 벌의 스키마를 분리해 두고, Responses 쪽엔 엄격 파싱을 넣는 식으로 반영했어. 또한 Responses는 tool_outputs와 response_id를 통해 단계적으로 이어붙이는 점을 코드에 명확히 했어. 참고 문서: Function Calling 가이드와 Responses API 레퍼런스. <a href="https://platform.openai.com/docs/guides/function-calling/supported-models?utm_source=chatgpt.com">OpenAI 플랫폼+2</a></p>

<p>아래 스크립트는 네 가지 조합(모델 A/B × completions/responses) 모두 함수 호출을 시험하고, 두 종류의 파일 툴을 제공해. 변경 포인트는 1) CHAT_TOOLS vs RESPONSES_TOOLS 분리, 2) Responses 루프에서 tool_outputs·response_id 사용을 더 엄격히, 3) Responses 출력 파서 보강이야.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># test_openai_tools_split_tools.py
# pip install --upgrade openai
</span>
<span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">json</span><span class="p">,</span> <span class="n">argparse</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ModelConfig</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span>

<span class="n">MODELS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">MODEL_A_NAME</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-4.1-mini</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_MODEL_A</span><span class="sh">"</span><span class="p">),</span>
    <span class="p">),</span>
    <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">MODEL_B_NAME</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL_B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY_B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_MODEL_B</span><span class="sh">"</span><span class="p">),</span>
    <span class="p">),</span>
<span class="p">}</span>

<span class="c1"># 공통 실제 구현 함수
</span><span class="kn">import</span> <span class="n">os</span>
<span class="k">def</span> <span class="nf">list_files_in_folder</span><span class="p">(</span><span class="n">folder_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="nf">listdir</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">f</span><span class="p">))]</span>
    <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>

<span class="k">def</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">return</span> <span class="sh">""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
    <span class="k">except</span> <span class="nb">UnicodeDecodeError</span><span class="p">:</span>
        <span class="k">return</span> <span class="sh">""</span>

<span class="k">def</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="nf">list_files_in_folder</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)),</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
    <span class="k">return</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span>

<span class="c1"># Chat Completions 전용 도구 JSON
# - 전통적인 function calling 스키마
</span><span class="n">CHAT_TOOLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">}</span>
        <span class="p">},</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Path to the text file.</span><span class="sh">"</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">}</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">]</span>

<span class="c1"># Responses 전용 도구 JSON
# - 스키마 필드는 유사하지만, Responses 예제 관례에 맞춰 strict를 켬
#   (모델이 schema에 정확히 맞춰 인자 생성하도록 강제)
</span><span class="n">RESPONSES_TOOLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">strict</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span>
        <span class="p">},</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Path to the text file.</span><span class="sh">"</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">strict</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">]</span>

<span class="k">def</span> <span class="nf">run_with_chat_completions</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tools_choice</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_task</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">CHAT_TOOLS</span><span class="p">,</span> <span class="n">tool_choice</span><span class="o">=</span><span class="n">tools_choice</span>
    <span class="p">)</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
    <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">):</span>
        <span class="c1"># 각 툴 실행
</span>        <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
            <span class="n">fn_name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
            <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>
            <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">output</span><span class="p">})</span>
        <span class="c1"># 대화 이어붙이기
</span>        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">]})</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
    <span class="k">return</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span>

<span class="c1"># Responses 출력 파서
</span><span class="k">def</span> <span class="nf">_extract_text</span><span class="p">(</span><span class="n">output_items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">chunks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output_items</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]:</span>
                <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                    <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
    <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">chunks</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">_extract_tool_calls</span><span class="p">(</span><span class="n">output_items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="n">calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output_items</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">tool_call</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">raw_args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">raw_args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span> <span class="n">raw_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw_args</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="n">raw_args</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">raw_args</span> <span class="ow">or</span> <span class="p">{}})</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">inner_calls</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inner_calls</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">inner_calls</span><span class="p">:</span>
                    <span class="n">raw_args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">raw_args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span> <span class="n">raw_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw_args</span><span class="p">)</span>
                        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="n">raw_args</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                        <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">function</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                        <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">raw_args</span> <span class="ow">or</span> <span class="p">{}</span>
                    <span class="p">})</span>
    <span class="k">return</span> <span class="n">calls</span>

<span class="k">def</span> <span class="nf">run_with_responses</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tools_choice</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
        <span class="nb">input</span><span class="o">=</span><span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_task</span><span class="p">}],</span>
        <span class="n">tools</span><span class="o">=</span><span class="n">RESPONSES_TOOLS</span><span class="p">,</span>
        <span class="n">tool_choice</span><span class="o">=</span><span class="n">tools_choice</span>
    <span class="p">)</span>

    <span class="n">final_text</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Responses는 tool_outputs + response_id로 상태를 이어서 보낸다.
</span>    <span class="c1"># 이어붙이기 패턴은 공식 레퍼런스의 흐름과 동일. :contentReference[oaicite:1]{index=1}
</span>    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>  <span class="c1"># 안전 상한
</span>        <span class="n">txt</span> <span class="o">=</span> <span class="nf">_extract_text</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="k">if</span> <span class="n">txt</span><span class="p">:</span>
            <span class="n">final_text</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>

        <span class="n">calls</span> <span class="o">=</span> <span class="nf">_extract_tool_calls</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="n">tool_outputs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">tc</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">tc</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
            <span class="n">tool_outputs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">tc</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">out</span><span class="p">})</span>

        <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">RESPONSES_TOOLS</span><span class="p">,</span>
            <span class="n">response_id</span><span class="o">=</span><span class="n">r</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>          <span class="c1"># 이전 응답과 연결
</span>            <span class="n">tool_outputs</span><span class="o">=</span><span class="n">tool_outputs</span>  <span class="c1"># 툴 실행 결과 전달
</span>        <span class="p">)</span>

    <span class="k">return</span> <span class="sh">"</span><span class="se">\n\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">final_text</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span> <span class="ow">or</span> <span class="sh">""</span>

<span class="n">DEFAULT_TASK</span> <span class="o">=</span> <span class="p">(</span>
    <span class="sh">"</span><span class="s">테스트: ./samples 폴더의 파일 목록을 보여주고, 텍스트 파일이 있으면 하나 골라 내용을 읽고 2~3문장 요약. 필요하면 툴 사용.</span><span class="sh">"</span>
<span class="p">)</span>

<span class="k">def</span> <span class="nf">run_one</span><span class="p">(</span><span class="n">which_api</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">MODELS</span><span class="p">[</span><span class="n">model_key</span><span class="p">]</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">=== [</span><span class="si">{</span><span class="n">which_api</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span><span class="si">}</span><span class="s">] Model </span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="s"> (</span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">) ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">which_api</span> <span class="o">==</span> <span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nf">run_with_chat_completions</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">user_task</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">which_api</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nf">run_with_responses</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">user_task</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">which_api must be </span><span class="sh">'</span><span class="s">completions</span><span class="sh">'</span><span class="s"> or </span><span class="sh">'</span><span class="s">responses</span><span class="sh">'"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">--- OUTPUT ---</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">out</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">(empty)</span><span class="sh">"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="sh">"</span><span class="s">./samples</span><span class="sh">"</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="nc">ArgumentParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--api</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">all</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">all</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--model</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--task</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_TASK</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="nf">parse_args</span><span class="p">()</span>

    <span class="n">apis</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">api</span> <span class="o">==</span> <span class="sh">"</span><span class="s">all</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">api</span><span class="p">]</span>
    <span class="n">models</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">model</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">model</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">apis</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">:</span>
            <span class="nf">run_one</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">task</span><span class="p">)</span>
</code></pre></div></div>

<p>핵심 차이 정리 단계별</p>

<ol>
  <li>
    <p>도구 정의 자체는 필드 구조가 동일(type=function, function.name/description/parameters)하되, Responses 쪽 예시에서는 strict를 켜서 JSON Schema를 엄격히 지키게 하는 패턴이 널리 쓰인다. 그래서 스키마가 “조금 다르게 생긴 것처럼” 보일 수 있다. <a href="https://platform.openai.com/docs/guides/function-calling/supported-models?utm_source=chatgpt.com">OpenAI 플랫폼+1</a></p>
  </li>
  <li>
    <p>Chat Completions는 messages 배열에 assistant.tool_calls가 나오고, 각 call.id에 대응하는 tool 메시지를 넣어 다시 chat.completions.create를 호출한다.</p>
  </li>
  <li>
    <p>Responses는 output에 tool_call 항목이 나오며, 실제 도구 실행 후 tool_outputs 배열과 이전 응답의 response_id를 포함해 responses.create를 다시 호출해 상태를 이어 붙인다. 이게 가장 큰 차이점이다. <a href="https://platform.openai.com/docs/api-reference/responses-streaming/response?utm_source=chatgpt.com">OpenAI 플랫폼</a></p>
  </li>
</ol>

<p>이 버전으로 돌려보고, Responses에서 strict를 끄고 싶으면 RESPONSES_TOOLS에서 "strict": True만 빼면 돼. 모델·엔드포인트·키는 상단 MODELS에서 조정 가능하고, samples 폴더에 테스트 파일만 있으면 바로 네 조합을 모두 확인할 수 있어.</p>

<p class="chat--user">

아니 예시를 좀 찾아봐.. from openai import OpenAI import json client = OpenAI() # 1. Define a list of callable tools for the model tools = [ { "type": "function", "name": "get_horoscope", "description": "Get today's horoscope for an astrological sign.", "parameters": { "type": "object", "properties": { "sign": { "type": "string", "description": "An astrological sign like Taurus or Aquarius", }, }, "required": ["sign"], }, }, ] def get_horoscope(sign): return f"{sign}: Next Tuesday you will befriend a baby otter." # Create a running input list we will add to over time input_list = [ {"role": "user", "content": "What is my horoscope? I am an Aquarius."} ] # 2. Prompt the model with tools defined response = client.responses.create( model="gpt-5", tools=tools, input=input_list, ) # Save function call outputs for subsequent requests input_list += response.output for item in response.output: if item.type == "function_call": if item.name == "get_horoscope": # 3. Execute the function logic for get_horoscope horoscope = get_horoscope(json.loads(item.arguments)) # 4. Provide function call results to the model input_list.append({ "type": "function_call_output", "call_id": item.call_id, "output": json.dumps({ "horoscope": horoscope }) }) print("Final input:") print(input_list) response = client.responses.create( model="gpt-5", instructions="Respond only with a horoscope generated by a tool.", tools=tools, input=input_list, ) # 5. The model should be able to give a response! print("Final output:") print(response.model_dump_json(indent=2)) print("\n" + response.output_text) 그러면 총 8개 조합이 나오지? 모델 x API 타입(completion, responses) x json 형태 이 8개 조합에 대해 각각 테스트하는 코드를 짜줘 이 때 실행 중 에러가 나는 경우에는 에러만 출력하고 나머지가 잘 수행되게 해줘.

</p>

<p>좋아. “2개 모델 × 2개 API(completions, responses) × 2가지 tools JSON 형태(Completions 스타일 vs Responses 스타일)” = 총 8개 조합을 한 번에 돌려보는 테스트 스크립트를 준비했어. 각 조합은 개별 try/except로 감싸 에러가 나더라도 나머지가 계속 수행돼. tools JSON은 네가 준 Responses 스타일 예시(평평한 형태: type/name/parameters가 최상위)와, Chat Completions에서 흔히 쓰는 중첩 형태({"type":"function","function":{…}})를 각각 분리해 두었고, 일부 조합은 의도적으로 “맞지 않는 형태”를 넣었기 때문에 실패할 수도 있어(그 경우 에러만 출력). 참고로 Responses와 Chat Completions의 차이, strict 옵션 등은 최신 가이드에 정리돼 있어. <a href="https://platform.openai.com/docs/guides/responses-vs-chat-completions?utm_source=chatgpt.com">OpenAI 플랫폼+2</a></p>

<p>아래 파일을 test_8combos_tools.py로 저장해서 실행하면 돼.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># test_8combos_tools.py
# Python 3.10+
# pip install --upgrade openai
</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">argparse</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>

<span class="c1"># =========================
# 0) 모델 설정
# =========================
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ModelConfig</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span>

<span class="n">MODELS</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ModelConfig</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">MODEL_A_NAME</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-4.1-mini</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL_A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY_A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_MODEL_A</span><span class="sh">"</span><span class="p">),</span>
    <span class="p">),</span>
    <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">MODEL_B_NAME</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL_B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY_B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_MODEL_B</span><span class="sh">"</span><span class="p">),</span>
    <span class="p">),</span>
<span class="p">}</span>

<span class="c1"># =========================
# 1) 로컬 툴 구현
# =========================
</span>
<span class="k">def</span> <span class="nf">list_files_in_folder</span><span class="p">(</span><span class="n">folder_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">sorted</span><span class="p">([</span>
            <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="nf">listdir</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
        <span class="p">])</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>

<span class="k">def</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">return</span> <span class="sh">""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="sh">""</span>

<span class="k">def</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">
    모든 툴의 결과를 dict로 통일해서 반환.
    Responses의 function_call_output에 넣기 좋게 {</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="s">: ...} 형태로 감싸준다.
    </span><span class="sh">"""</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="nf">list_files_in_folder</span><span class="p">(</span><span class="n">folder</span><span class="p">)}</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="n">path</span><span class="p">)}</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="c1"># =========================
# 2) tools JSON 두 가지 형태
# =========================
</span>
<span class="c1"># (A) Chat Completions 스타일: function 필드에 중첩
</span><span class="n">CHAT_STYLE_TOOLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative file path.</span><span class="sh">"</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">]</span>

<span class="c1"># (B) Responses 스타일: 네가 준 예시처럼 평평한 형태(일부 문서/예시에서 보이는 포맷)
</span><span class="n">RESPONSES_STYLE_TOOLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="c1"># "strict": True  # 필요 시 켜서 인자 스키마 준수 강제 (도움말 참조)
</span>    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative file path.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="c1"># "strict": True
</span>    <span class="p">},</span>
<span class="p">]</span>

<span class="c1"># =========================
# 3) Chat Completions 쪽 함수 호출 루프
# =========================
</span>
<span class="k">def</span> <span class="nf">run_chat_completions</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    tools_variant: </span><span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="s"> 또는 </span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="s">
    </span><span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="s">  -&gt; CHAT_STYLE_TOOLS 사용 (권장)
    </span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="s"> -&gt; RESPONSES_STYLE_TOOLS 사용 (의도적 비호환 가능)
    </span><span class="sh">"""</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="n">CHAT_STYLE_TOOLS</span> <span class="k">if</span> <span class="n">tools_variant</span> <span class="o">==</span> <span class="sh">"</span><span class="s">chat</span><span class="sh">"</span> <span class="k">else</span> <span class="n">RESPONSES_STYLE_TOOLS</span>

    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_task</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
        <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
        <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
        <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

    <span class="c1"># tool_calls 루프
</span>    <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
        <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
            <span class="n">fn_name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
            <span class="c1"># arguments는 문자열일 수 있음
</span>            <span class="k">try</span><span class="p">:</span>
                <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="n">fn_args</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">tool_output</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>

            <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">tool_output</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
            <span class="p">})</span>

        <span class="c1"># 대화 이어붙이기
</span>        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
            <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">],</span>
        <span class="p">})</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

        <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

    <span class="k">return</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span>

<span class="c1"># =========================
# 4) Responses 쪽 함수 호출 루프
# =========================
</span>
<span class="k">def</span> <span class="nf">_collect_function_calls_from_output</span><span class="p">(</span><span class="n">output</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="sh">"""</span><span class="s">
    Responses API의 output 배열에서 function_call / tool_call 류 이벤트를 추출.
    다양한 케이스를 최대한 관대하게 처리한다.
    </span><span class="sh">"""</span>
    <span class="n">calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="n">itype</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="c1"># 케이스 A: item.type == "function_call"
</span>        <span class="k">if</span> <span class="n">itype</span> <span class="o">==</span> <span class="sh">"</span><span class="s">function_call</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{},</span>
            <span class="p">})</span>

        <span class="c1"># 케이스 B: 일부 모델이 "tool_call" / item.message.tool_calls 형태로 줄 때
</span>        <span class="k">if</span> <span class="n">itype</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">inner</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inner</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">inner</span><span class="p">:</span>
                    <span class="n">nm</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                            <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                        <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">nm</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{},</span>
                    <span class="p">})</span>
    <span class="k">return</span> <span class="n">calls</span>

<span class="k">def</span> <span class="nf">_collect_text_from_output</span><span class="p">(</span><span class="n">output</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]:</span>
                <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                    <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
    <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">texts</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">run_responses</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    tools_variant: </span><span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="s"> 또는 </span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="s">
    </span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="s"> -&gt; RESPONSES_STYLE_TOOLS 사용 (권장)
    </span><span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="s">      -&gt; CHAT_STYLE_TOOLS 사용 (의도적 비호환 가능)
    순수 Responses 방식: 네가 준 예시 패턴(input_list 축적 + function_call_output)로 구현.
    </span><span class="sh">"""</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="n">RESPONSES_STYLE_TOOLS</span> <span class="k">if</span> <span class="n">tools_variant</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span> <span class="k">else</span> <span class="n">CHAT_STYLE_TOOLS</span>

    <span class="c1"># running input_list
</span>    <span class="n">input_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_task</span><span class="p">}</span>
    <span class="p">]</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
        <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
        <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># function_call 처리
</span>    <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

    <span class="c1"># call들을 찾아 실행하고, function_call_output을 이어 붙임
</span>    <span class="n">calls</span> <span class="o">=</span> <span class="nf">_collect_function_calls_from_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
    <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
        <span class="n">input_list</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function_call_output</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
        <span class="p">})</span>

    <span class="c1"># 최종 응답 시도(지시문을 추가적으로 줄 수도 있음)
</span>    <span class="n">r2</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
        <span class="n">instructions</span><span class="o">=</span><span class="sh">"</span><span class="s">Respond with a short summary of what you found.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
        <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># 텍스트 추출(중간/최종)
</span>    <span class="n">final_text</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">txt1</span> <span class="o">=</span> <span class="nf">_collect_text_from_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
    <span class="k">if</span> <span class="n">txt1</span><span class="p">:</span> <span class="n">final_text</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">txt1</span><span class="p">)</span>
    <span class="n">txt2</span> <span class="o">=</span> <span class="nf">_collect_text_from_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
    <span class="k">if</span> <span class="n">txt2</span><span class="p">:</span> <span class="n">final_text</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">txt2</span><span class="p">)</span>
    <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">final_text</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span> <span class="ow">or</span> <span class="sh">""</span>

<span class="c1"># =========================
# 5) 8개 조합 실행기
# =========================
</span>
<span class="n">DEFAULT_TASK</span> <span class="o">=</span> <span class="p">(</span>
    <span class="sh">"</span><span class="s">테스트: ./samples 폴더의 파일 목록을 보여주고, 텍스트 파일이 있으면 하나 골라 내용을 읽고 2~3문장 요약. 필요하면 도구를 사용해.</span><span class="sh">"</span>
<span class="p">)</span>

<span class="k">def</span> <span class="nf">run_one</span><span class="p">(</span><span class="n">api_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">MODELS</span><span class="p">[</span><span class="n">model_key</span><span class="p">]</span>
    <span class="n">header</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[</span><span class="si">{</span><span class="n">api_type</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span><span class="si">}</span><span class="s">] model=</span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s"> tools_json=</span><span class="si">{</span><span class="n">tools_variant</span><span class="si">}</span><span class="sh">"</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="sh">"</span><span class="s">=</span><span class="sh">"</span> <span class="o">*</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s"> </span><span class="si">{</span><span class="n">header</span><span class="si">}</span><span class="s"> </span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=</span><span class="sh">"</span> <span class="o">*</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">api_type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="nf">run_chat_completions</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">user_task</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">api_type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="nf">run_responses</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">user_task</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">api_type must be </span><span class="sh">'</span><span class="s">completions</span><span class="sh">'</span><span class="s"> or </span><span class="sh">'</span><span class="s">responses</span><span class="sh">'"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">--- OUTPUT ---</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">out</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">(empty)</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">--- ERROR ---</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="nc">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Run 8 combinations: 2 models × 2 APIs × 2 tools JSON styles.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--task</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_TASK</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--models</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--apis</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="c1"># tools_variant를 "both"로 두면 각 API에서 chat/​responses 두 가지 툴 JSON 모두 시도 → 8조합
</span>    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--tools</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="nf">parse_args</span><span class="p">()</span>

    <span class="c1"># 샘플 폴더 생성 안내
</span>    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="sh">"</span><span class="s">./samples</span><span class="sh">"</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">model_keys</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">models</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">models</span><span class="p">]</span>
    <span class="n">api_types</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">apis</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">apis</span><span class="p">]</span>
    <span class="n">tool_variants</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">tools</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">tools</span><span class="p">]</span>

    <span class="c1"># 8조합: 2모델 × 2API × 2JSON
</span>    <span class="k">for</span> <span class="n">mk</span> <span class="ow">in</span> <span class="n">model_keys</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">api</span> <span class="ow">in</span> <span class="n">api_types</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tv</span> <span class="ow">in</span> <span class="n">tool_variants</span><span class="p">:</span>
                <span class="nf">run_one</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="n">mk</span><span class="p">,</span> <span class="n">tv</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">task</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="nf">main</span><span class="p">()</span>
</code></pre></div></div>

<p>실행 예시<br />
python test_8combos_tools.py<br />
python test_8combos_tools.py –apis completions –tools both<br />
python test_8combos_tools.py –models A –apis responses –tools responses</p>

<p>포인트 요약</p>

<ol>
  <li>
    <p>CHAT_STYLE_TOOLS와 RESPONSES_STYLE_TOOLS를 분리해 두었고, Responses 루프는 네가 붙여준 예시처럼 input_list에 function_call과 function_call_output을 누적하는 방식으로 구현했어. 일부 문서/예시에선 strict를 켜 JSON 스키마를 강제하니 필요하면 해당 키를 켜면 돼. <a href="https://platform.openai.com/docs/guides/function-calling?utm_source=chatgpt.com">OpenAI 플랫폼+1</a></p>
  </li>
  <li>
    <p>일부 조합은 의도적으로 호환되지 않아 에러가 날 수 있어(예: Chat Completions에 Responses 스타일 tools). 모든 run은 try/except로 감싸 실패해도 나머지가 이어진다.</p>
  </li>
  <li>
    <p>최신 차이점과 권장 흐름은 Responses vs Chat Completions 가이드에서 비교 가능해. <a href="https://platform.openai.com/docs/guides/responses-vs-chat-completions?utm_source=chatgpt.com">OpenAI 플랫폼</a></p>
  </li>
</ol>

<p>더 엄격하게 Responses의 “response_id + tool_outputs” 방식으로 이어붙이는 버전도 원하면 따로 추가해줄게.</p>

<p class="chat--user">

개선 필요 사항 1. responses api에서도 여러 번 콜을 하고 각 대화를 다 출력하고 싶어. 2. 입력 전체를 그냥 json으로 출력하고, 출력 전체도 그냥 json으로 다 저장해줘. 단, 콘솔 출력 색깔 지정을 통해서 (1) 입력 (2) 툴 요청 (3) 출력 이 구분되면 좋겠어. 3. 추가적으로 json formatting (structured json)도 추가해줘. structured json이 있는 버젼과 없는 버젼 각각 추가해주면 좋겠어. 총 16가지 조합이 될 거야. 각 api에 대한 structured formatting 예시는 아래 코드를 참고해 chat completions 
<code class="language-plaintext highlighter-rouge">
from pydantic import BaseModel
from openai import OpenAI

client = OpenAI()

class CalendarEvent(BaseModel):
    name: str
    date: str
    participants: list[str]

completion = client.chat.completions.parse(
    model="gpt-4o-2024-08-06",
    messages=[
        {"role": "system", "content": "Extract the event information."},
        {"role": "user", "content": "Alice and Bob are going to a science fair on Friday."},
    ],
    response_format=CalendarEvent,
)

event = completion.choices[0].message.parsed
</code>

responses 
<code class="language-plaintext highlighter-rouge">
from openai import OpenAI
from pydantic import BaseModel

client = OpenAI()

class CalendarEvent(BaseModel):
    name: str
    date: str
    participants: list[str]

response = client.responses.parse(
    model="gpt-4o-2024-08-06",
    input=[
        {"role": "system", "content": "Extract the event information."},
        {
            "role": "user",
            "content": "Alice and Bob are going to a science fair on Friday.",
        },
    ],
    text_format=CalendarEvent,
)

event = response.output_parsed
</code>

</p>

<p>좋아, 요구사항(2모델 × 2 API 타입 × 2 Tools JSON 스타일 × 2 Structured 포맷 유무 = 16조합)을 모두 만족하는 단일 실행 스크립트를 준비했어. 다음을 보장해.</p>

<ol>
  <li>
    <p>Responses API에서 여러 번 호출(툴 호출 발생 시 루프)하며, 매 스텝의 대화 전개를 콘솔에 모두 출력.</p>
  </li>
  <li>
    <p>각 조합마다 “입력 전체”와 “출력 전체”를 JSON으로 파일로 저장. 콘솔에선 색상으로 (입력 / 툴요청 / 출력) 구분.</p>
  </li>
  <li>
    <p>Structured JSON 파싱 버전과 일반 버전 각각 제공.</p>
  </li>
  <li>
    <p>에러는 조합별로 try/except로 고립 처리하여, 실패해도 나머지 조합 계속 실행.</p>
  </li>
</ol>

<p>아래 코드를 test_16combos.py로 저장해서 실행해. samples 폴더에 텍스트 파일 몇 개 두면 툴 동작을 쉽게 확인할 수 있어.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># test_16combos.py
# Python 3.10+
# pip install --upgrade openai pydantic
</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="n">argparse</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>

<span class="c1"># =========================
# ANSI 색상 유틸
# =========================
</span><span class="n">RESET</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[0m</span><span class="sh">"</span>
<span class="n">CYAN</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[36m</span><span class="sh">"</span>      <span class="c1"># 입력
</span><span class="n">YELLOW</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[33m</span><span class="sh">"</span>    <span class="c1"># 툴 요청/툴 출력
</span><span class="n">GREEN</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[32m</span><span class="sh">"</span>     <span class="c1"># 모델 출력
</span><span class="n">RED</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[31m</span><span class="sh">"</span>       <span class="c1"># 에러
</span>
<span class="c1"># =========================
# 모델/엔드포인트/키 설정
# =========================
</span><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ModelConfig</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span>

<span class="n">MODELS</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ModelConfig</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">MODEL_A_NAME</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-4.1-mini</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL_A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY_A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_MODEL_A</span><span class="sh">"</span><span class="p">),</span>
    <span class="p">),</span>
    <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">MODEL_B_NAME</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL_B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY_B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_MODEL_B</span><span class="sh">"</span><span class="p">),</span>
    <span class="p">),</span>
<span class="p">}</span>

<span class="c1"># =========================
# 로컬 툴 구현
# =========================
</span><span class="k">def</span> <span class="nf">list_files_in_folder</span><span class="p">(</span><span class="n">folder_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">sorted</span><span class="p">([</span>
            <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="nf">listdir</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
        <span class="p">])</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>

<span class="k">def</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">return</span> <span class="sh">""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="sh">""</span>

<span class="k">def</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="nf">list_files_in_folder</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))}</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))}</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="c1"># =========================
# Tools JSON 2가지 스타일
# =========================
# Chat Completions 스타일 (function 필드 중첩)
</span><span class="n">CHAT_STYLE_TOOLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative file path.</span><span class="sh">"</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">]</span>

<span class="c1"># Responses 스타일 (평평한 형태; 일부 예시 포맷)
</span><span class="n">RESPONSES_STYLE_TOOLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="c1"># "strict": True  # 필요 시 활성화
</span>    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative file path.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="c1"># "strict": True
</span>    <span class="p">},</span>
<span class="p">]</span>

<span class="c1"># =========================
# Structured JSON 포맷용 Pydantic
# =========================
</span><span class="k">class</span> <span class="nc">FileTaskResult</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">files</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">chosen_file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">summary</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>

<span class="c1"># =========================
# 공통: 출력/저장 헬퍼
# =========================
</span><span class="k">def</span> <span class="nf">ensure_dirs</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">write_json</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
    <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">label_for</span><span class="p">(</span><span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">structured</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="n">api_type</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="n">tools_variant</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="sh">'</span><span class="s">structured</span><span class="sh">'</span> <span class="k">if</span> <span class="n">structured</span> <span class="k">else</span> <span class="sh">'</span><span class="s">plain</span><span class="sh">'</span><span class="si">}</span><span class="sh">"</span>

<span class="k">def</span> <span class="nf">print_section</span><span class="p">(</span><span class="n">title</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">color</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">color</span> <span class="o">+</span> <span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">[</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s">]</span><span class="sh">"</span> <span class="o">+</span> <span class="n">RESET</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">now_id</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">time</span><span class="p">.</span><span class="nf">strftime</span><span class="p">(</span><span class="sh">"</span><span class="s">%Y%m%d-%H%M%S</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># =========================
# Chat Completions 러너 (plain/structured)
# =========================
</span><span class="k">def</span> <span class="nf">run_chat</span><span class="p">(</span>
    <span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span>
    <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">structured</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">run_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="n">CHAT_STYLE_TOOLS</span> <span class="k">if</span> <span class="n">tools_variant</span> <span class="o">==</span> <span class="sh">"</span><span class="s">chat</span><span class="sh">"</span> <span class="k">else</span> <span class="n">RESPONSES_STYLE_TOOLS</span>

    <span class="c1"># 대화 시작
</span>    <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_task</span><span class="p">},</span>
    <span class="p">]</span>

    <span class="c1"># 입력/출력 전체 저장을 위한 구조
</span>    <span class="n">input_snapshot</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">.</span><span class="nf">copy</span><span class="p">(),</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools</span><span class="p">}</span>
    <span class="n">responses_dump</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">입력(Chat Completions)</span><span class="sh">"</span><span class="p">,</span> <span class="n">CYAN</span><span class="p">,</span> <span class="n">input_snapshot</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">structured</span><span class="p">:</span>
        <span class="c1"># structured: parse() 사용
</span>        <span class="n">completion</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
            <span class="n">response_format</span><span class="o">=</span><span class="n">FileTaskResult</span><span class="p">,</span>
            <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">completion</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">completion</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

        <span class="c1"># function calling 루프 (parse 결과에서도 tool_calls 접근 가능하도록 시도)
</span>        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="n">fn_name</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">툴 요청(Chat Completions)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_args</span><span class="p">})</span>
                <span class="n">tool_output</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>
                <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">tool_output</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                <span class="p">})</span>

            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">]})</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

            <span class="n">completion</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
                <span class="n">response_format</span><span class="o">=</span><span class="n">FileTaskResult</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">completion</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">completion</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

        <span class="c1"># 최종 구조화 결과
</span>        <span class="n">parsed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FileTaskResult</span><span class="p">]</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">parsed</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">out_to_print</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span><span class="p">,</span> <span class="sh">"</span><span class="s">parsed</span><span class="sh">"</span><span class="p">:</span> <span class="n">parsed</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">if</span> <span class="n">parsed</span> <span class="k">else</span> <span class="bp">None</span><span class="p">}</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">출력(Chat Completions, structured)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">out_to_print</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># plain: create() 사용
</span>        <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span> <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span>
        <span class="p">)</span>
        <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">resp</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="n">fn_name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">툴 요청(Chat Completions)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_args</span><span class="p">})</span>
                <span class="n">tool_output</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>
                <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">tool_output</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                <span class="p">})</span>

            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">]})</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

            <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">)</span>
            <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">resp</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">출력(Chat Completions, plain)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span><span class="p">})</span>

    <span class="c1"># 파일 저장
</span>    <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">input.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">input_snapshot</span><span class="p">)</span>
    <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">outputs.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">responses_dump</span><span class="p">)</span>

<span class="c1"># =========================
# Responses 러너 (plain/structured)
# - 여러 번 호출하며 매 스텝 출력
# =========================
</span><span class="k">def</span> <span class="nf">_collect_function_calls_from_output</span><span class="p">(</span><span class="n">output</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="n">calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="n">itype</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">itype</span> <span class="o">==</span> <span class="sh">"</span><span class="s">function_call</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{}})</span>

        <span class="k">if</span> <span class="n">itype</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">inner</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inner</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">inner</span><span class="p">:</span>
                    <span class="n">nm</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                            <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">nm</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{}})</span>
    <span class="k">return</span> <span class="n">calls</span>

<span class="k">def</span> <span class="nf">_collect_text_from_output</span><span class="p">(</span><span class="n">output</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]:</span>
                <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                    <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
    <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">texts</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">run_responses</span><span class="p">(</span>
    <span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span>
    <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">structured</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">run_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="n">RESPONSES_STYLE_TOOLS</span> <span class="k">if</span> <span class="n">tools_variant</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span> <span class="k">else</span> <span class="n">CHAT_STYLE_TOOLS</span>

    <span class="n">input_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_task</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="n">input_snapshot</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="n">input_list</span><span class="p">.</span><span class="nf">copy</span><span class="p">(),</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools</span><span class="p">}</span>
    <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">입력(Responses)</span><span class="sh">"</span><span class="p">,</span> <span class="n">CYAN</span><span class="p">,</span> <span class="n">input_snapshot</span><span class="p">)</span>

    <span class="n">responses_dump</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">structured</span><span class="p">:</span>
        <span class="c1"># structured: responses.parse(text_format=...)
</span>        <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
            <span class="n">text_format</span><span class="o">=</span><span class="n">FileTaskResult</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">출력(Responses step 1)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

        <span class="c1"># 툴 호출 탐지 → 실행 → function_call_output 추가 → 이어서 또 parse
</span>        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="bp">True</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">calls</span> <span class="o">=</span> <span class="nf">_collect_function_calls_from_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
                <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">툴 요청(Responses)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">]})</span>
                <span class="n">result</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
                <span class="n">input_list</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function_call_output</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">],</span>
                    <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                <span class="p">})</span>

            <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
                <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
                <span class="n">text_format</span><span class="o">=</span><span class="n">FileTaskResult</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">출력(Responses next)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

        <span class="c1"># 최종 파싱 결과
</span>        <span class="n">parsed</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output_parsed</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">출력 요약(Responses structured)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">parsed</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">if</span> <span class="n">parsed</span> <span class="k">else</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># plain: responses.create()
</span>        <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
            <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">출력(Responses step 1)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="bp">True</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">calls</span> <span class="o">=</span> <span class="nf">_collect_function_calls_from_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="n">tool_outputs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
                <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">툴 요청(Responses)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">]})</span>
                <span class="n">result</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
                <span class="c1"># function_call_output을 input에 누적
</span>                <span class="n">input_list</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function_call_output</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">],</span>
                    <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                <span class="p">})</span>

            <span class="c1"># 다음 턴
</span>            <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
                <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">출력(Responses next)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

        <span class="n">final_text</span> <span class="o">=</span> <span class="nf">_collect_text_from_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">출력 요약(Responses plain)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">final_text</span><span class="p">})</span>

    <span class="c1"># 파일 저장
</span>    <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">input.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">input_snapshot</span><span class="p">)</span>
    <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">outputs.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">responses_dump</span><span class="p">)</span>

<span class="c1"># =========================
# 16개 조합 실행기
#   2 모델 × 2 API × 2 Tools JSON × 2 Structured
# =========================
</span><span class="n">DEFAULT_TASK</span> <span class="o">=</span> <span class="p">(</span>
    <span class="sh">"</span><span class="s">테스트: ./samples 폴더의 파일 목록을 보여주고, 텍스트 파일이 있으면 하나를 골라 내용을 읽고 2~3문장으로 요약해줘. 필요하면 툴을 사용해.</span><span class="sh">"</span>
<span class="p">)</span>

<span class="k">def</span> <span class="nf">run_one</span><span class="p">(</span>
    <span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">api_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">structured</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">base_runs_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">MODELS</span><span class="p">[</span><span class="n">model_key</span><span class="p">]</span>
    <span class="n">combo_label</span> <span class="o">=</span> <span class="nf">label_for</span><span class="p">(</span><span class="n">model_key</span><span class="p">,</span> <span class="n">api_type</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">,</span> <span class="n">structured</span><span class="p">)</span>
    <span class="n">run_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">base_runs_dir</span><span class="p">,</span> <span class="n">combo_label</span><span class="p">)</span>
    <span class="nf">ensure_dirs</span><span class="p">(</span><span class="n">run_dir</span><span class="p">)</span>

    <span class="n">header</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[</span><span class="si">{</span><span class="n">api_type</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span><span class="si">}</span><span class="s">] model=</span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s"> tools=</span><span class="si">{</span><span class="n">tools_variant</span><span class="si">}</span><span class="s"> structured=</span><span class="si">{</span><span class="sh">'</span><span class="s">on</span><span class="sh">'</span> <span class="k">if</span> <span class="n">structured</span> <span class="k">else</span> <span class="sh">'</span><span class="s">off</span><span class="sh">'</span><span class="si">}</span><span class="sh">"</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="sh">"</span><span class="s">=</span><span class="sh">"</span> <span class="o">*</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s"> </span><span class="si">{</span><span class="n">header</span><span class="si">}</span><span class="s"> </span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=</span><span class="sh">"</span> <span class="o">*</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">api_type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">:</span>
            <span class="nf">run_chat</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">,</span> <span class="n">structured</span><span class="p">,</span> <span class="n">user_task</span><span class="p">,</span> <span class="n">run_dir</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">api_type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">:</span>
            <span class="nf">run_responses</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">,</span> <span class="n">structured</span><span class="p">,</span> <span class="n">user_task</span><span class="p">,</span> <span class="n">run_dir</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">api_type must be </span><span class="sh">'</span><span class="s">completions</span><span class="sh">'</span><span class="s"> or </span><span class="sh">'</span><span class="s">responses</span><span class="sh">'"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">RED</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="s">--- ERROR ---</span><span class="sh">"</span> <span class="o">+</span> <span class="n">RESET</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="c1"># 에러만 출력하고 계속
</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="nc">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Run 16 combos: 2 models × 2 APIs × 2 Tools JSON × 2 Structured.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--task</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_TASK</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--models</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--apis</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--tools</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--structured</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">on</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">off</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--runs_dir</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="s">./runs/</span><span class="si">{</span><span class="nf">now_id</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="nf">parse_args</span><span class="p">()</span>

    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="sh">"</span><span class="s">./samples</span><span class="sh">"</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nf">ensure_dirs</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">runs_dir</span><span class="p">)</span>

    <span class="n">model_keys</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">models</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">models</span><span class="p">]</span>
    <span class="n">api_types</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">apis</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">apis</span><span class="p">]</span>
    <span class="n">tool_variants</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">tools</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">tools</span><span class="p">]</span>
    <span class="n">structured_opts</span> <span class="o">=</span> <span class="p">[</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">structured</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">structured</span> <span class="o">==</span> <span class="sh">"</span><span class="s">on</span><span class="sh">"</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">mk</span> <span class="ow">in</span> <span class="n">model_keys</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">api</span> <span class="ow">in</span> <span class="n">api_types</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tv</span> <span class="ow">in</span> <span class="n">tool_variants</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">structured_opts</span><span class="p">:</span>
                    <span class="nf">run_one</span><span class="p">(</span><span class="n">mk</span><span class="p">,</span> <span class="n">api</span><span class="p">,</span> <span class="n">tv</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">task</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">runs_dir</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="nf">main</span><span class="p">()</span>
</code></pre></div></div>

<p>사용법 요약</p>

<ol>
  <li>환경 변수 설정(예시)</li>
</ol>

<ul>
  <li>
    <p>모델 A:<br />
OPENAI_API_KEY_A, OPENAI_BASE_URL_A=https://api.openai.com/v1, MODEL_A_NAME</p>
  </li>
  <li>
    <p>모델 B:<br />
OPENAI_API_KEY_B, OPENAI_BASE_URL_B=https://api.openai.com/v1, MODEL_B_NAME</p>
  </li>
</ul>

<ol>
  <li>
    <p>샘플 준비<br />
프로젝트 루트에 samples 폴더를 만들고 텍스트 파일을 1개 이상 넣어둔다.</p>
  </li>
  <li>
    <p>실행 예시</p>
  </li>
</ol>

<ul>
  <li>
    <p>16개 전체 조합 실행<br />
python test_16combos.py</p>
  </li>
  <li>
    <p>Responses만, structured/plain 둘 다, tools는 responses 스타일만<br />
python test_16combos.py –apis responses –tools responses –structured both</p>
  </li>
  <li>
    <p>모델 A만, Chat Completions만, structured만<br />
python test_16combos.py –models A –apis completions –structured on</p>
  </li>
</ul>

<p>동작 정리</p>

<ul>
  <li>
    <p>콘솔 색상으로 입력(청록), 툴 요청(노랑), 출력(초록)을 구분.</p>
  </li>
  <li>
    <p>각 조합은 runs/타임스탬프/모델_API_tools_structured/ 아래에 input.json, outputs.json 저장.</p>
  </li>
  <li>
    <p>Responses API는 툴 호출이 계속 나오면 루프를 반복하고 매 스텝 출력 및 누적 저장.</p>
  </li>
  <li>
    <p>Structured 모드에선 chat.completions.parse / responses.parse를 사용해 Pydantic 모델(FileTaskResult)로 결과를 파싱해 별도 요약도 콘솔에 표시.</p>
  </li>
</ul>

<p>원하는 추가 포맷(예: 파일명 규칙, 더 자세한 로깅, strict 옵션 상시 on 등)이 있으면 알려줘.</p>

<p class="chat--user">

출력 json 포맷은 task에서 요청한 걸 대답할 수 있게 해주면 좋을 것 같아. 예를 들어 filename: 파일명 contents: 내용 

</p>

<p>좋아! “결과 JSON 포맷을 task에 바로 쓰이게(filename, contents)”로 맞춘 버전을 아래처럼 업데이트했어. 핵심은 structured 모드에서 파싱 모델을 <code class="language-plaintext highlighter-rouge">{"filename": str, "contents": str}</code>로 고정하고, 모델에게 “contents에는 요약을 넣어라”라고 지시하는 것. plain 모드에서는 기존 그대로 자유 텍스트를 출력하고 전체 원시 JSON 로그만 저장하며, structured 모드에서는 추가로 <code class="language-plaintext highlighter-rouge">result.json</code>에 <code class="language-plaintext highlighter-rouge">{"filename","contents"}</code>를 저장해.</p>

<p>아래 스크립트는 이전 16조합 실행기(test_16combos.py)를 대체하는 완전판이야. 바뀐 점만 빠르게 요약하고 바로 코드 줄게.</p>

<p>변경 요약</p>

<ol>
  <li>Structured 파싱 모델 교체</li>
</ol>

<ul>
  <li>
    <p>Pydantic 모델을 <code class="language-plaintext highlighter-rouge">TaskAnswer</code>로 정의하고 필드를 filename, contents 두 개로 통일.</p>
  </li>
  <li>
    <p>contents는 “읽은 파일의 2~3문장 요약”을 넣도록 system/instructions에 명확히 지시.</p>
  </li>
</ul>

<ol>
  <li>Structured 모드에서 결과 JSON 저장</li>
</ol>

<ul>
  <li>
    <p>각 조합 폴더에 <code class="language-plaintext highlighter-rouge">result.json</code>으로 <code class="language-plaintext highlighter-rouge">{"filename","contents"}</code> 저장.</p>
  </li>
  <li>
    <p>기존처럼 <code class="language-plaintext highlighter-rouge">input.json</code>, <code class="language-plaintext highlighter-rouge">outputs.json</code>도 계속 저장.</p>
  </li>
</ul>

<ol>
  <li>콘솔 색상 출력은 동일하게 유지</li>
</ol>

<ul>
  <li>입력(CYAN), 툴 요청(YELLOW), 출력(GREEN)으로 구분.</li>
</ul>

<ol>
  <li>Responses API는 다단 호출 유지</li>
</ol>

<ul>
  <li>각 step의 출력과 툴 요청을 모두 콘솔에 표시하고, outputs.json에 누적 저장.</li>
</ul>

<p>코드</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># test_16combos_v2.py
# Python 3.10+
# pip install --upgrade openai pydantic
</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="n">argparse</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>

<span class="c1"># ===== ANSI 색상 =====
</span><span class="n">RESET</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[0m</span><span class="sh">"</span>
<span class="n">CYAN</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[36m</span><span class="sh">"</span>      <span class="c1"># 입력
</span><span class="n">YELLOW</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[33m</span><span class="sh">"</span>    <span class="c1"># 툴 요청/툴 출력
</span><span class="n">GREEN</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[32m</span><span class="sh">"</span>     <span class="c1"># 모델 출력
</span><span class="n">RED</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[31m</span><span class="sh">"</span>       <span class="c1"># 에러
</span>
<span class="c1"># ===== 모델 설정 =====
</span><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ModelConfig</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span>

<span class="n">MODELS</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ModelConfig</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">MODEL_A_NAME</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-4.1-mini</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL_A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY_A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_MODEL_A</span><span class="sh">"</span><span class="p">),</span>
    <span class="p">),</span>
    <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">MODEL_B_NAME</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL_B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY_B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_MODEL_B</span><span class="sh">"</span><span class="p">),</span>
    <span class="p">),</span>
<span class="p">}</span>

<span class="c1"># ===== 로컬 툴 구현 =====
</span><span class="k">def</span> <span class="nf">list_files_in_folder</span><span class="p">(</span><span class="n">folder_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">sorted</span><span class="p">([</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="nf">listdir</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">f</span><span class="p">))])</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>

<span class="k">def</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">return</span> <span class="sh">""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="sh">""</span>

<span class="k">def</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="nf">list_files_in_folder</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))}</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))}</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="c1"># ===== Tools JSON 2가지 =====
</span><span class="n">CHAT_STYLE_TOOLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative file path.</span><span class="sh">"</span><span class="p">}},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">]</span>

<span class="n">RESPONSES_STYLE_TOOLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative file path.</span><span class="sh">"</span><span class="p">}},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">]</span>

<span class="c1"># ===== Structured JSON 스키마 =====
</span><span class="k">class</span> <span class="nc">TaskAnswer</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">contents</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># 선택된 파일의 2~3문장 요약(모델이 생성)
</span>
<span class="c1"># ===== 유틸 =====
</span><span class="k">def</span> <span class="nf">ensure_dirs</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span> <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">write_json</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
    <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">now_id</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span> <span class="k">return</span> <span class="n">time</span><span class="p">.</span><span class="nf">strftime</span><span class="p">(</span><span class="sh">"</span><span class="s">%Y%m%d-%H%M%S</span><span class="sh">"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">print_section</span><span class="p">(</span><span class="n">title</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">color</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">color</span> <span class="o">+</span> <span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">[</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s">]</span><span class="sh">"</span> <span class="o">+</span> <span class="n">RESET</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">combo_label</span><span class="p">(</span><span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">structured</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="n">api_type</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="n">tools_variant</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="sh">'</span><span class="s">structured</span><span class="sh">'</span> <span class="k">if</span> <span class="n">structured</span> <span class="k">else</span> <span class="sh">'</span><span class="s">plain</span><span class="sh">'</span><span class="si">}</span><span class="sh">"</span>

<span class="c1"># ===== Chat Completions 러너 =====
</span><span class="k">def</span> <span class="nf">run_chat</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">structured</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">run_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="n">CHAT_STYLE_TOOLS</span> <span class="k">if</span> <span class="n">tools_variant</span> <span class="o">==</span> <span class="sh">"</span><span class="s">chat</span><span class="sh">"</span> <span class="k">else</span> <span class="n">RESPONSES_STYLE_TOOLS</span>

    <span class="n">system_msg</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed. </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">Task: Show files under ./samples, pick one text file, read it, and provide a 2-3 sentence summary. </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">If using structured output, respond ONLY with JSON having keys: filename, contents.</span><span class="sh">"</span>
    <span class="p">)</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">system_msg</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_task</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="n">input_snapshot</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">.</span><span class="nf">copy</span><span class="p">(),</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools</span><span class="p">}</span>
    <span class="n">responses_dump</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">입력(Chat Completions)</span><span class="sh">"</span><span class="p">,</span> <span class="n">CYAN</span><span class="p">,</span> <span class="n">input_snapshot</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">structured</span><span class="p">:</span>
        <span class="n">completion</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
            <span class="n">response_format</span><span class="o">=</span><span class="n">TaskAnswer</span><span class="p">,</span>
            <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">completion</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">completion</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="n">fn_name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">툴 요청(Chat)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_args</span><span class="p">})</span>
                <span class="n">tool_output</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>
                <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span>
                                  <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">tool_output</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)})</span>

            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span>
                             <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">]})</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

            <span class="n">completion</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
                <span class="n">response_format</span><span class="o">=</span><span class="n">TaskAnswer</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">completion</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">completion</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

        <span class="n">parsed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TaskAnswer</span><span class="p">]</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">parsed</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">out_obj</span> <span class="o">=</span> <span class="n">parsed</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">if</span> <span class="n">parsed</span> <span class="k">else</span> <span class="p">{</span><span class="sh">"</span><span class="s">filename</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">contents</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">}</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">출력(Chat structured)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">out_obj</span><span class="p">)</span>
        <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">result.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">out_obj</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span> <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span>
        <span class="p">)</span>
        <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">resp</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="n">fn_name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">툴 요청(Chat)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_args</span><span class="p">})</span>
                <span class="n">tool_output</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>
                <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span>
                                  <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">tool_output</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)})</span>

            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span>
                             <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">]})</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

            <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">)</span>
            <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">resp</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">출력(Chat plain)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span><span class="p">})</span>

    <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">input.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">input_snapshot</span><span class="p">)</span>
    <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">outputs.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">responses_dump</span><span class="p">)</span>

<span class="c1"># ===== Responses 러너 =====
</span><span class="k">def</span> <span class="nf">_collect_function_calls</span><span class="p">(</span><span class="n">output</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="n">calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="n">itype</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">itype</span> <span class="o">==</span> <span class="sh">"</span><span class="s">function_call</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span> <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{}})</span>
        <span class="k">if</span> <span class="n">itype</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">inner</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inner</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">inner</span><span class="p">:</span>
                    <span class="n">nm</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span> <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">nm</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{}})</span>
    <span class="k">return</span> <span class="n">calls</span>

<span class="k">def</span> <span class="nf">_collect_text</span><span class="p">(</span><span class="n">output</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]:</span>
                <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                    <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
    <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">texts</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">run_responses</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">structured</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">run_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="n">RESPONSES_STYLE_TOOLS</span> <span class="k">if</span> <span class="n">tools_variant</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span> <span class="k">else</span> <span class="n">CHAT_STYLE_TOOLS</span>

    <span class="n">system_inst</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed. </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">Task: Show files under ./samples, pick one text file, read it, and provide a 2-3 sentence summary. </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">If structured parsing is enabled, respond ONLY with JSON having keys: filename, contents.</span><span class="sh">"</span>
    <span class="p">)</span>
    <span class="n">input_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">system_inst</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_task</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="n">input_snapshot</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="n">input_list</span><span class="p">.</span><span class="nf">copy</span><span class="p">(),</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools</span><span class="p">}</span>
    <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">입력(Responses)</span><span class="sh">"</span><span class="p">,</span> <span class="n">CYAN</span><span class="p">,</span> <span class="n">input_snapshot</span><span class="p">)</span>

    <span class="n">responses_dump</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">structured</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
            <span class="n">text_format</span><span class="o">=</span><span class="n">TaskAnswer</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">출력(Responses step 1)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">calls</span> <span class="o">=</span> <span class="nf">_collect_function_calls</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
                <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">툴 요청(Responses)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">]})</span>
                <span class="n">result</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
                <span class="n">input_list</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function_call_output</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">],</span>
                    <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                <span class="p">})</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span> <span class="n">text_format</span><span class="o">=</span><span class="n">TaskAnswer</span><span class="p">)</span>
            <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">출력(Responses next)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

        <span class="n">parsed</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output_parsed</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">out_obj</span> <span class="o">=</span> <span class="n">parsed</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">if</span> <span class="n">parsed</span> <span class="k">else</span> <span class="p">{</span><span class="sh">"</span><span class="s">filename</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">contents</span><span class="sh">"</span><span class="p">:</span> <span class="nf">_collect_text</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))}</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">출력 요약(Responses structured)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">out_obj</span><span class="p">)</span>
        <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">result.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">out_obj</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span> <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">출력(Responses step 1)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">calls</span> <span class="o">=</span> <span class="nf">_collect_function_calls</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
                <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">툴 요청(Responses)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">]})</span>
                <span class="n">result</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
                <span class="n">input_list</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function_call_output</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">],</span>
                    <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                <span class="p">})</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">)</span>
            <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">출력(Responses next)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

        <span class="n">final_text</span> <span class="o">=</span> <span class="nf">_collect_text</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">출력 요약(Responses plain)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">final_text</span><span class="p">})</span>

    <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">input.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">input_snapshot</span><span class="p">)</span>
    <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">outputs.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">responses_dump</span><span class="p">)</span>

<span class="c1"># ===== 16개 조합 실행기 =====
</span><span class="n">DEFAULT_TASK</span> <span class="o">=</span> <span class="p">(</span>
    <span class="sh">"</span><span class="s">테스트: ./samples 폴더의 파일 목록을 보여주고, 텍스트 파일이 있으면 하나를 골라 내용을 읽고 2~3문장으로 요약해줘. 필요하면 툴을 사용해.</span><span class="sh">"</span>
<span class="p">)</span>

<span class="k">def</span> <span class="nf">run_one</span><span class="p">(</span><span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">structured</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">base_runs_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">MODELS</span><span class="p">[</span><span class="n">model_key</span><span class="p">]</span>
    <span class="n">label</span> <span class="o">=</span> <span class="nf">combo_label</span><span class="p">(</span><span class="n">model_key</span><span class="p">,</span> <span class="n">api_type</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">,</span> <span class="n">structured</span><span class="p">)</span>
    <span class="n">run_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">base_runs_dir</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
    <span class="nf">ensure_dirs</span><span class="p">(</span><span class="n">run_dir</span><span class="p">)</span>

    <span class="n">header</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[</span><span class="si">{</span><span class="n">api_type</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span><span class="si">}</span><span class="s">] model=</span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s"> tools=</span><span class="si">{</span><span class="n">tools_variant</span><span class="si">}</span><span class="s"> structured=</span><span class="si">{</span><span class="sh">'</span><span class="s">on</span><span class="sh">'</span> <span class="k">if</span> <span class="n">structured</span> <span class="k">else</span> <span class="sh">'</span><span class="s">off</span><span class="sh">'</span><span class="si">}</span><span class="sh">"</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="sh">"</span><span class="s">=</span><span class="sh">"</span> <span class="o">*</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s"> </span><span class="si">{</span><span class="n">header</span><span class="si">}</span><span class="s"> </span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=</span><span class="sh">"</span> <span class="o">*</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">api_type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">:</span>
            <span class="nf">run_chat</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">,</span> <span class="n">structured</span><span class="p">,</span> <span class="n">user_task</span><span class="p">,</span> <span class="n">run_dir</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">api_type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">:</span>
            <span class="nf">run_responses</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">,</span> <span class="n">structured</span><span class="p">,</span> <span class="n">user_task</span><span class="p">,</span> <span class="n">run_dir</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">api_type must be </span><span class="sh">'</span><span class="s">completions</span><span class="sh">'</span><span class="s"> or </span><span class="sh">'</span><span class="s">responses</span><span class="sh">'"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">RED</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="s">--- ERROR ---</span><span class="sh">"</span> <span class="o">+</span> <span class="n">RESET</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>  <span class="c1"># 에러만 출력하고 계속
</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="nc">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Run 16 combos with JSON result format {filename, contents}.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--task</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_TASK</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--models</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--apis</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--tools</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--structured</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">on</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">off</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--runs_dir</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="s">./runs/</span><span class="si">{</span><span class="nf">now_id</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="nf">parse_args</span><span class="p">()</span>

    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="sh">"</span><span class="s">./samples</span><span class="sh">"</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nf">ensure_dirs</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">runs_dir</span><span class="p">)</span>

    <span class="n">model_keys</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">models</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">models</span><span class="p">]</span>
    <span class="n">api_types</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">apis</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">apis</span><span class="p">]</span>
    <span class="n">tool_variants</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">tools</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">tools</span><span class="p">]</span>
    <span class="n">structured_opts</span> <span class="o">=</span> <span class="p">[</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">structured</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">structured</span> <span class="o">==</span> <span class="sh">"</span><span class="s">on</span><span class="sh">"</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">mk</span> <span class="ow">in</span> <span class="n">model_keys</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">api</span> <span class="ow">in</span> <span class="n">api_types</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tv</span> <span class="ow">in</span> <span class="n">tool_variants</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">structured_opts</span><span class="p">:</span>
                    <span class="nf">run_one</span><span class="p">(</span><span class="n">mk</span><span class="p">,</span> <span class="n">api</span><span class="p">,</span> <span class="n">tv</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">task</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">runs_dir</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="nf">main</span><span class="p">()</span>
</code></pre></div></div>

<p>사용 포인트</p>

<ul>
  <li>
    <p>structured 모드일 때만 <code class="language-plaintext highlighter-rouge">result.json</code>을 생성하며 내용은 반드시 <code class="language-plaintext highlighter-rouge">{"filename","contents"}</code>로 저장돼.</p>
  </li>
  <li>
    <p>contents에는 “선택한 파일의 2~3문장 요약”이 들어가도록 시스템 메시지에서 강제했어.</p>
  </li>
  <li>
    <p>plain 모드에선 자유 형식 출력이지만, 입력과 모든 원시 응답은 <code class="language-plaintext highlighter-rouge">input.json</code>, <code class="language-plaintext highlighter-rouge">outputs.json</code>로 저장돼.</p>
  </li>
  <li>
    <p>각 단계의 콘솔 출력은 색상으로 구분돼서 입력/툴요청/출력이 한눈에 보여.</p>
  </li>
</ul>

<p>원하면 contents를 “파일 전문”으로 바꾸는 옵션 스위치도 추가해줄 수 있어.</p>

<p class="chat--user">

Completions(structured)에서 ValueError list_files_in_folder is not strict. Only <code class="language-plaintext highlighter-rouge">strict</code> function tools can be auto-parsed.

</p>

<p>좋은 피드백이야. 에러 원인은 chat.completions.parse를 사용할 때 툴이 strict 모드가 아니면 자동 파싱이 불가능해서야. 즉, structured 모드에서 함수 툴 정의에 strict=True가 반드시 들어가야 해.</p>

<p>수정 방향 요약 단계별</p>

<ol>
  <li>
    <p>tools_variant와 structured 여부에 따라 툴 JSON에 strict를 주입하는 헬퍼를 만든다.</p>
  </li>
  <li>
    <p>Chat 스타일일 땐 tool["function"]["strict"]=True, Responses 스타일일 땐 tool["strict"]=True를 넣는다.</p>
  </li>
  <li>
    <p>run_chat / run_responses에서 기존 정적 TOOLS 대신 이 헬퍼로 반환된 툴을 사용한다.</p>
  </li>
</ol>

<p>아래 변경만 적용하면 돼. 나머지 로직은 그대로 둬도 동작한다.</p>

<p>추가 함수 및 변경점</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">copy</span>

<span class="k">def</span> <span class="nf">make_tools</span><span class="p">(</span><span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">structured</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    tools_variant: </span><span class="sh">'</span><span class="s">chat</span><span class="sh">'</span><span class="s"> | </span><span class="sh">'</span><span class="s">responses</span><span class="sh">'</span><span class="s">
    structured가 True면 strict 플래그를 주입한다.
    </span><span class="sh">"""</span>
    <span class="n">base</span> <span class="o">=</span> <span class="n">CHAT_STYLE_TOOLS</span> <span class="k">if</span> <span class="n">tools_variant</span> <span class="o">==</span> <span class="sh">"</span><span class="s">chat</span><span class="sh">"</span> <span class="k">else</span> <span class="n">RESPONSES_STYLE_TOOLS</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="n">copy</span><span class="p">.</span><span class="nf">deepcopy</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">structured</span><span class="p">:</span>
        <span class="c1"># Chat 스타일: "function" 블록 안에 strict
</span>        <span class="k">if</span> <span class="n">tools_variant</span> <span class="o">==</span> <span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">t</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span> <span class="ow">and</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
                    <span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">strict</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="c1"># Responses 스타일: 최상위에 strict
</span>        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">t</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span>
                    <span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">strict</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">return</span> <span class="n">tools</span>
</code></pre></div></div>

<p>run_chat 내부에서 툴 선택 부분 교체</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 기존
# tools = CHAT_STYLE_TOOLS if tools_variant == "chat" else RESPONSES_STYLE_TOOLS
# 변경
</span><span class="n">tools</span> <span class="o">=</span> <span class="nf">make_tools</span><span class="p">(</span><span class="n">tools_variant</span><span class="p">,</span> <span class="n">structured</span><span class="p">)</span>
</code></pre></div></div>

<p>run_responses 내부에서도 동일하게 교체</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 기존
# tools = RESPONSES_STYLE_TOOLS if tools_variant == "responses" else CHAT_STYLE_TOOLS
# 변경
</span><span class="n">tools</span> <span class="o">=</span> <span class="nf">make_tools</span><span class="p">(</span><span class="n">tools_variant</span><span class="p">,</span> <span class="n">structured</span><span class="p">)</span>
</code></pre></div></div>

<p>추가 참고</p>

<ul>
  <li>
    <p>이 변경으로 Completions(structured) 뿐만 아니라 Responses(structured)에서도 일관되게 엄격 파싱이 보장돼.</p>
  </li>
  <li>
    <p>plain 모드에선 strict가 없어도 되지만, 위 헬퍼는 structured일 때만 strict를 주입하므로 기존 동작을 해치지 않아.</p>
  </li>
  <li>
    <p>tools JSON을 동적으로 주입하므로, 새 함수만 추가하고 두 곳 호출부만 바꾸면 끝나.</p>
  </li>
</ul>

<p>이렇게 수정하면 “ValueError list_files_in_folder is not strict. Only <code class="language-plaintext highlighter-rouge">strict</code> function tools can be auto-parsed.” 에러는 사라지고 16개 조합 모두 정상적으로 순회할 수 있어.</p>

<p class="chat--user">

그래도 계속 에러가 나네. 일단 넘어가고 json scheme을 지정하는 방식은 동작을 잘 안하네 일반 json 모드를 켜보고 싶어. 총 3가지 sweep(no structured, json_mode, structured)로 실험해보자. 예시 responses 
<code class="language-plaintext highlighter-rouge">
we_did_not_specify_stop_tokens = True

try:
    response = client.responses.create(
        model="gpt-3.5-turbo-0125",
        input=[
            {"role": "system", "content": "You are a helpful assistant designed to output JSON."},
            {"role": "user", "content": "Who won the world series in 2020? Please respond in the format {winner: ...}"}
        ],
        text={"format": {"type": "json_object"}}
    )

    # Check if the conversation was too long for the context window, resulting in incomplete JSON 
    if response.status == "incomplete" and response.incomplete_details.reason == "max_output_tokens":
        # your code should handle this error case
        pass

    # Check if the OpenAI safety system refused the request and generated a refusal instead
    if response.output[0].content[0].type == "refusal":
        # your code should handle this error case
        # In this case, the .content field will contain the explanation (if any) that the model generated for why it is refusing
        print(response.output[0].content[0]["refusal"])

    # Check if the model's output included restricted content, so the generation of JSON was halted and may be partial
    if response.status == "incomplete" and response.incomplete_details.reason == "content_filter":
        # your code should handle this error case
        pass

    if response.status == "completed":
        # In this case the model has either successfully finished generating the JSON object according to your schema, or the model generated one of the tokens you provided as a "stop token"

        if we_did_not_specify_stop_tokens:
            # If you didn't specify any stop tokens, then the generation is complete and the content key will contain the serialized JSON object
            # This will parse successfully and should now contain  "{"winner": "Los Angeles Dodgers"}"
            print(response.output_text)
        else:
            # Check if the response.output_text ends with one of your stop tokens and handle appropriately
            pass
except Exception as e:
    # Your code should handle errors here, for example a network error calling the API
    print(e)
</code>

completions 
<code class="language-plaintext highlighter-rouge">
response = client.chat.completions.create(
  model="gpt-4-1106-preview",
  messages=[
    {"role": "system", "content": "You are a helpful assistant."},
    {"role": "user", "content": "LangChain은 무엇을 하는 라이브러리지? JSON으로 답해줘. JSON 키워드는 Description, Features, Usage로 해줘."}
  ],
  response_format = {'type':"json_object"}
)
</code>

</p>

<p>좋아. strict 기반의 JSON Schema 파싱은 접고, 세 모드로 스윕하도록 전체 스크립트를 업데이트했어.</p>

<p>스윕 축: 2모델 × 2 API(completions/responses) × 2 Tools JSON(chat-style/responses-style) × 3 모드(plain, json_mode, structured) = 총 24조합.</p>

<p>핵심</p>

<ul>
  <li>
    <p>plain: 자유 출력. 전체 입력/출력 원본 JSON을 저장.</p>
  </li>
  <li>
    <p>json_mode: 모델에게 “무조건 JSON”을 요구. 출력은 {"filename","contents"} 형식. 저장 시 result.json 생성.</p>

    <ul>
      <li>
        <p>Chat Completions: response_format={'type': 'json_object'}</p>
      </li>
      <li>
        <p>Responses: text={"format":{"type":"json_object"}}</p>
      </li>
    </ul>
  </li>
  <li>
    <p>structured: 이전처럼 parse 사용. 여전히 모델/SDK에 따라 strict 요구로 실패할 수도 있으니 try/except로 격리. 성공 시 result.json 생성.</p>
  </li>
  <li>
    <p>Responses API는 툴 호출이 나오면 여러 번 호출되며 매 스텝 콘솔 출력. 콘솔은 색상으로 입력(CYAN), 툴 요청(YELLOW), 출력(GREEN) 구분.</p>
  </li>
  <li>
    <p>모든 조합은 runs/타임스탬프/모델_API_tools_mode/ 폴더에 input.json, outputs.json 저장. json_mode/structured는 result.json 추가 저장.</p>
  </li>
  <li>
    <p>에러는 조합별로만 출력하고 나머지 계속 진행.</p>
  </li>
</ul>

<p>코드: test_24combos.py</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># test_24combos.py
# Python 3.10+
# pip install --upgrade openai pydantic
</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="n">copy</span>
<span class="kn">import</span> <span class="n">argparse</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>

<span class="c1"># ===== ANSI colors =====
</span><span class="n">RESET</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[0m</span><span class="sh">"</span>
<span class="n">CYAN</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[36m</span><span class="sh">"</span>      <span class="c1"># input
</span><span class="n">YELLOW</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[33m</span><span class="sh">"</span>    <span class="c1"># tool
</span><span class="n">GREEN</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[32m</span><span class="sh">"</span>     <span class="c1"># output
</span><span class="n">RED</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[31m</span><span class="sh">"</span>       <span class="c1"># error
</span>
<span class="c1"># ===== Model configs =====
</span><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ModelConfig</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span>

<span class="n">MODELS</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ModelConfig</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">MODEL_A_NAME</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-4.1-mini</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL_A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY_A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_MODEL_A</span><span class="sh">"</span><span class="p">),</span>
    <span class="p">),</span>
    <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">MODEL_B_NAME</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL_B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY_B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_MODEL_B</span><span class="sh">"</span><span class="p">),</span>
    <span class="p">),</span>
<span class="p">}</span>

<span class="c1"># ===== Local tools =====
</span><span class="k">def</span> <span class="nf">list_files_in_folder</span><span class="p">(</span><span class="n">folder_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">sorted</span><span class="p">([</span>
            <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="nf">listdir</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
        <span class="p">])</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>

<span class="k">def</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">return</span> <span class="sh">""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="sh">""</span>

<span class="k">def</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="nf">list_files_in_folder</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))}</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))}</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="c1"># ===== Tools JSON (two shapes) =====
</span><span class="n">CHAT_STYLE_TOOLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative file path.</span><span class="sh">"</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">]</span>

<span class="n">RESPONSES_STYLE_TOOLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative file path.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">]</span>

<span class="c1"># ===== Structured JSON schema (optional) =====
</span><span class="k">class</span> <span class="nc">TaskAnswer</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">contents</span><span class="p">:</span> <span class="nb">str</span>

<span class="c1"># ===== Helpers =====
</span><span class="k">def</span> <span class="nf">ensure_dirs</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span> <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">write_json</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
    <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">now_id</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span> <span class="k">return</span> <span class="n">time</span><span class="p">.</span><span class="nf">strftime</span><span class="p">(</span><span class="sh">"</span><span class="s">%Y%m%d-%H%M%S</span><span class="sh">"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">print_section</span><span class="p">(</span><span class="n">title</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">color</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">color</span> <span class="o">+</span> <span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">[</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s">]</span><span class="sh">"</span> <span class="o">+</span> <span class="n">RESET</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">combo_label</span><span class="p">(</span><span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="n">api_type</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="n">tools_variant</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="sh">"</span>

<span class="k">def</span> <span class="nf">make_tools</span><span class="p">(</span><span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">structured</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="c1"># structured에서 strict 문제를 피하기 위해 여기선 strict 주입을 끔
</span>    <span class="c1"># (structured는 parse() 사용 시 여전히 실패할 수 있으므로 try/except로 감싼다)
</span>    <span class="n">base</span> <span class="o">=</span> <span class="n">CHAT_STYLE_TOOLS</span> <span class="k">if</span> <span class="n">tools_variant</span> <span class="o">==</span> <span class="sh">"</span><span class="s">chat</span><span class="sh">"</span> <span class="k">else</span> <span class="n">RESPONSES_STYLE_TOOLS</span>
    <span class="k">return</span> <span class="n">copy</span><span class="p">.</span><span class="nf">deepcopy</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>

<span class="c1"># ===== Common parsing for Responses =====
</span><span class="k">def</span> <span class="nf">_collect_function_calls_from_output</span><span class="p">(</span><span class="n">output</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="n">calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="n">itype</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">itype</span> <span class="o">==</span> <span class="sh">"</span><span class="s">function_call</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span> <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{}})</span>
        <span class="k">if</span> <span class="n">itype</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">inner</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inner</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">inner</span><span class="p">:</span>
                    <span class="n">nm</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span> <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">nm</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{}})</span>
    <span class="k">return</span> <span class="n">calls</span>

<span class="k">def</span> <span class="nf">_collect_text_from_output</span><span class="p">(</span><span class="n">output</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]:</span>
                <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                    <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
    <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">texts</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

<span class="c1"># ===== Chat Completions runner =====
</span><span class="k">def</span> <span class="nf">run_chat</span><span class="p">(</span>
    <span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span>
    <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>  <span class="c1"># "plain" | "json_mode" | "structured"
</span>    <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">run_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="nf">make_tools</span><span class="p">(</span><span class="n">tools_variant</span><span class="p">,</span> <span class="n">structured</span><span class="o">=</span><span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">structured</span><span class="sh">"</span><span class="p">))</span>

    <span class="n">system_msg</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed. </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">Task: List files in ./samples, pick a text file, read it, and return a short 2-3 sentence summary. </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">When asked to answer in JSON, reply only with an object: {</span><span class="se">\"</span><span class="s">filename</span><span class="se">\"</span><span class="s">: string, </span><span class="se">\"</span><span class="s">contents</span><span class="se">\"</span><span class="s">: string}.</span><span class="sh">"</span>
    <span class="p">)</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">system_msg</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_task</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="n">input_snapshot</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">.</span><span class="nf">copy</span><span class="p">(),</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools</span><span class="p">,</span> <span class="sh">"</span><span class="s">mode</span><span class="sh">"</span><span class="p">:</span> <span class="n">mode</span><span class="p">}</span>
    <span class="n">outputs_dump</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">입력(Chat Completions)</span><span class="sh">"</span><span class="p">,</span> <span class="n">CYAN</span><span class="p">,</span> <span class="n">input_snapshot</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">structured</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">completion</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
                <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
                <span class="n">response_format</span><span class="o">=</span><span class="n">TaskAnswer</span><span class="p">,</span>
                <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">outputs_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">completion</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">completion</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

            <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
                <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                    <span class="n">fn_name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
                    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                        <span class="n">fn_args</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">툴 요청(Chat)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_args</span><span class="p">})</span>
                    <span class="n">tool_output</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>
                    <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span>
                                      <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">tool_output</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)})</span>
                <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span>
                                 <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">]})</span>
                <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

                <span class="n">completion</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span>
                    <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span> <span class="n">response_format</span><span class="o">=</span><span class="n">TaskAnswer</span>
                <span class="p">)</span>
                <span class="n">outputs_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">completion</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">completion</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

            <span class="n">parsed</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">parsed</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">out_obj</span> <span class="o">=</span> <span class="n">parsed</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">if</span> <span class="n">parsed</span> <span class="k">else</span> <span class="p">{</span><span class="sh">"</span><span class="s">filename</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">contents</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">}</span>
            <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">출력(Chat structured)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">out_obj</span><span class="p">)</span>
            <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">result.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">out_obj</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">RED</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="s">--- ERROR(Chat structured) ---</span><span class="sh">"</span> <span class="o">+</span> <span class="n">RESET</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json_mode</span><span class="sh">"</span><span class="p">:</span>
        <span class="c1"># Force JSON output
</span>        <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
            <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">response_format</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json_object</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">)</span>
        <span class="n">outputs_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">resp</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="n">fn_name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">툴 요청(Chat)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_args</span><span class="p">})</span>
                <span class="n">tool_output</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>
                <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span>
                                  <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">tool_output</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)})</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span>
                             <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">]})</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

            <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
                <span class="n">response_format</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json_object</span><span class="sh">"</span><span class="p">},</span>
            <span class="p">)</span>
            <span class="n">outputs_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">resp</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

        <span class="c1"># Try to parse JSON
</span>        <span class="n">result_obj</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result_obj</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="n">result_obj</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">filename</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">contents</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">}</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">출력(Chat json_mode)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">result_obj</span><span class="p">)</span>
        <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">result.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">result_obj</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>  <span class="c1"># plain
</span>        <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span> <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span>
        <span class="p">)</span>
        <span class="n">outputs_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">resp</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="n">fn_name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">툴 요청(Chat)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_args</span><span class="p">})</span>
                <span class="n">tool_output</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>
                <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span>
                                  <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">tool_output</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)})</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span>
                             <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">]})</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

            <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">)</span>
            <span class="n">outputs_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">resp</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">출력(Chat plain)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span><span class="p">})</span>

    <span class="c1"># Save IO logs
</span>    <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">input.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">input_snapshot</span><span class="p">)</span>
    <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">outputs.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">outputs_dump</span><span class="p">)</span>

<span class="c1"># ===== Responses runner =====
</span><span class="k">def</span> <span class="nf">run_responses</span><span class="p">(</span>
    <span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span>
    <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>  <span class="c1"># "plain" | "json_mode" | "structured"
</span>    <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">run_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="nf">make_tools</span><span class="p">(</span><span class="n">tools_variant</span><span class="p">,</span> <span class="n">structured</span><span class="o">=</span><span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">structured</span><span class="sh">"</span><span class="p">))</span>

    <span class="n">system_inst</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed. </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">Task: List files in ./samples, pick a text file, read it, and return a short 2-3 sentence summary. </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">If JSON is requested, reply only with an object: {</span><span class="se">\"</span><span class="s">filename</span><span class="se">\"</span><span class="s">: string, </span><span class="se">\"</span><span class="s">contents</span><span class="se">\"</span><span class="s">: string}.</span><span class="sh">"</span>
    <span class="p">)</span>
    <span class="n">input_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">system_inst</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_task</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="n">input_snapshot</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="n">input_list</span><span class="p">.</span><span class="nf">copy</span><span class="p">(),</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools</span><span class="p">,</span> <span class="sh">"</span><span class="s">mode</span><span class="sh">"</span><span class="p">:</span> <span class="n">mode</span><span class="p">}</span>
    <span class="n">outputs_dump</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">입력(Responses)</span><span class="sh">"</span><span class="p">,</span> <span class="n">CYAN</span><span class="p">,</span> <span class="n">input_snapshot</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">structured</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
                <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
                <span class="n">text_format</span><span class="o">=</span><span class="n">TaskAnswer</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">outputs_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">출력(Responses step 1)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

            <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
                <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">calls</span> <span class="o">=</span> <span class="nf">_collect_function_calls_from_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
                    <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">툴 요청(Responses)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">]})</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
                    <span class="n">input_list</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function_call_output</span><span class="sh">"</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">],</span>
                        <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                    <span class="p">})</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span>
                    <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span> <span class="n">text_format</span><span class="o">=</span><span class="n">TaskAnswer</span>
                <span class="p">)</span>
                <span class="n">outputs_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
                <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">출력(Responses next)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
                <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

            <span class="n">parsed</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output_parsed</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">out_obj</span> <span class="o">=</span> <span class="n">parsed</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">if</span> <span class="n">parsed</span> <span class="k">else</span> <span class="p">{</span><span class="sh">"</span><span class="s">filename</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">contents</span><span class="sh">"</span><span class="p">:</span> <span class="nf">_collect_text_from_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))}</span>
            <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">출력 요약(Responses structured)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">out_obj</span><span class="p">)</span>
            <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">result.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">out_obj</span><span class="p">)</span>

        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">RED</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="s">--- ERROR(Responses structured) ---</span><span class="sh">"</span> <span class="o">+</span> <span class="n">RESET</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json_mode</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
            <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">text</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">format</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json_object</span><span class="sh">"</span><span class="p">}},</span>
        <span class="p">)</span>
        <span class="n">outputs_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">출력(Responses step 1)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">calls</span> <span class="o">=</span> <span class="nf">_collect_function_calls_from_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
                <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">툴 요청(Responses)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">]})</span>
                <span class="n">result</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
                <span class="n">input_list</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function_call_output</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">],</span>
                    <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                <span class="p">})</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
                <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
                <span class="n">text</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">format</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json_object</span><span class="sh">"</span><span class="p">}},</span>
            <span class="p">)</span>
            <span class="n">outputs_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">출력(Responses next)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

        <span class="c1"># Try to parse JSON text
</span>        <span class="n">result_text</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">output_text</span> <span class="ow">or</span> <span class="sh">""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result_obj</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">result_text</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="n">result_obj</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">filename</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">contents</span><span class="sh">"</span><span class="p">:</span> <span class="n">result_text</span><span class="p">}</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">출력 요약(Responses json_mode)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">result_obj</span><span class="p">)</span>
        <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">result.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">result_obj</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>  <span class="c1"># plain
</span>        <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
            <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">outputs_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">출력(Responses step 1)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">calls</span> <span class="o">=</span> <span class="nf">_collect_function_calls_from_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
                <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">툴 요청(Responses)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">]})</span>
                <span class="n">result</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
                <span class="n">input_list</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function_call_output</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">],</span>
                    <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                <span class="p">})</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">)</span>
            <span class="n">outputs_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">출력(Responses next)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">출력 요약(Responses plain)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="nf">_collect_text_from_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))})</span>

    <span class="c1"># Save IO logs
</span>    <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">input.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">input_snapshot</span><span class="p">)</span>
    <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">outputs.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">outputs_dump</span><span class="p">)</span>

<span class="c1"># ===== 24-combo driver =====
</span><span class="n">DEFAULT_TASK</span> <span class="o">=</span> <span class="p">(</span>
    <span class="sh">"</span><span class="s">테스트: ./samples 폴더의 파일 목록을 보여주고, 텍스트 파일이 있으면 하나를 골라 내용을 읽고 2~3문장으로 요약해줘. </span><span class="sh">"</span>
    <span class="sh">"</span><span class="s">가능하다면 JSON으로 {</span><span class="se">\"</span><span class="s">filename</span><span class="se">\"</span><span class="s">: string, </span><span class="se">\"</span><span class="s">contents</span><span class="se">\"</span><span class="s">: string} 형태로 답해줘.</span><span class="sh">"</span>
<span class="p">)</span>

<span class="k">def</span> <span class="nf">run_one</span><span class="p">(</span><span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">base_runs_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">MODELS</span><span class="p">[</span><span class="n">model_key</span><span class="p">]</span>
    <span class="n">label</span> <span class="o">=</span> <span class="nf">combo_label</span><span class="p">(</span><span class="n">model_key</span><span class="p">,</span> <span class="n">api_type</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
    <span class="n">run_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">base_runs_dir</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
    <span class="nf">ensure_dirs</span><span class="p">(</span><span class="n">run_dir</span><span class="p">)</span>

    <span class="n">header</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[</span><span class="si">{</span><span class="n">api_type</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span><span class="si">}</span><span class="s">] model=</span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s"> tools=</span><span class="si">{</span><span class="n">tools_variant</span><span class="si">}</span><span class="s"> mode=</span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="sh">"</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="sh">"</span><span class="s">=</span><span class="sh">"</span> <span class="o">*</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s"> </span><span class="si">{</span><span class="n">header</span><span class="si">}</span><span class="s"> </span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=</span><span class="sh">"</span> <span class="o">*</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">api_type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">:</span>
            <span class="nf">run_chat</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">user_task</span><span class="p">,</span> <span class="n">run_dir</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">api_type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">:</span>
            <span class="nf">run_responses</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">user_task</span><span class="p">,</span> <span class="n">run_dir</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">api_type must be </span><span class="sh">'</span><span class="s">completions</span><span class="sh">'</span><span class="s"> or </span><span class="sh">'</span><span class="s">responses</span><span class="sh">'"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">RED</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="s">--- ERROR ---</span><span class="sh">"</span> <span class="o">+</span> <span class="n">RESET</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="nc">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Run 24 combos: 2 models × 2 APIs × 2 tool JSONs × 3 modes.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--task</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_TASK</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--models</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--apis</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--tools</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--modes</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">plain</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json_mode</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">structured</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">all</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">all</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--runs_dir</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="s">./runs/</span><span class="si">{</span><span class="nf">now_id</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="nf">parse_args</span><span class="p">()</span>

    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="sh">"</span><span class="s">./samples</span><span class="sh">"</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nf">ensure_dirs</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">runs_dir</span><span class="p">)</span>

    <span class="n">model_keys</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">models</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">models</span><span class="p">]</span>
    <span class="n">api_types</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">apis</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">apis</span><span class="p">]</span>
    <span class="n">tool_variants</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">tools</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">tools</span><span class="p">]</span>
    <span class="n">mode_list</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">plain</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json_mode</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">structured</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">modes</span> <span class="o">==</span> <span class="sh">"</span><span class="s">all</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">modes</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">mk</span> <span class="ow">in</span> <span class="n">model_keys</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">api</span> <span class="ow">in</span> <span class="n">api_types</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tv</span> <span class="ow">in</span> <span class="n">tool_variants</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">md</span> <span class="ow">in</span> <span class="n">mode_list</span><span class="p">:</span>
                    <span class="nf">run_one</span><span class="p">(</span><span class="n">mk</span><span class="p">,</span> <span class="n">api</span><span class="p">,</span> <span class="n">tv</span><span class="p">,</span> <span class="n">md</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">task</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">runs_dir</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="nf">main</span><span class="p">()</span>
</code></pre></div></div>

<p>사용 팁</p>

<ul>
  <li>
    <p>json_mode가 가장 안정적으로 {"filename","contents"}를 뱉어 줄 거야. structured는 SDK/모델의 strict 정책에 따라 여전히 실패할 수 있지만, 스크립트는 개별 조합별로 에러를 삼키고 계속 진행한다.</p>
  </li>
  <li>
    <p>모든 조합의 입력/출력(raw)을 저장해서 리그레션 비교가 가능해. json_mode/structured는 result.json을 따로 저장하므로 바로 사용할 수 있어.</p>
  </li>
  <li>
    <p>필요하면 system 메시지의 지시를 수정해서 contents에 “요약” 대신 “원문 전체”를 넣도록 바꿀 수도 있어.</p>
  </li>
</ul>

        
      </section>

      <footer class="page__meta">
        
        


  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      <a href="/categories/#llm" class="page__taxonomy-item p-category" rel="tag">llm</a>
    
    </span>
  </p>


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time class="dt-published" datetime="2025-10-24T14:08:27+09:00">2025-10-24</time></p>

      </footer>

      

      
  <nav class="pagination">
    
      <a href="/llm/openai-function-call-examples/" class="pagination--pager" title="OpenAI 함수 호출 테스트">Previous</a>
    
    
      <a href="/llm/openai-function-call-examples/" class="pagination--pager" title="OpenAI 함수 호출 테스트">Next</a>
    
  </nav>


    </div>

    
  </article>

  
  
    
<div class="page__related">
  
  <h2 class="page__related-title">You may also enjoy</h2>
  <div class="grid__wrapper">
    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/2025-08-19-python-repr-vs-str/" rel="permalink">
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <!-- hvppyarchive: remove date icon
        <i class="far fa-calendar-alt" aria-hidden="true"></i> 
        -->
        
        <time datetime="2025-10-27T13:35:20+09:00">2025-10-27</time>
      </span>
    

    

    
  </p>


    <p class="archive__item-excerpt" itemprop="description">
</p>
  </article>
</div>

    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/llm/comfyui-llm-tool-call/" rel="permalink">ComfyUI LLM Tool Call
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <!-- hvppyarchive: remove date icon
        <i class="far fa-calendar-alt" aria-hidden="true"></i> 
        -->
        
        <time datetime="2025-10-27T13:35:14+09:00">2025-10-27</time>
      </span>
    

    

    
  </p>


    <p class="archive__item-excerpt" itemprop="description">

</p>
  </article>
</div>

    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/llm/openai-function-call-examples/" rel="permalink">OpenAI 함수 호출 테스트
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <!-- hvppyarchive: remove date icon
        <i class="far fa-calendar-alt" aria-hidden="true"></i> 
        -->
        
        <time datetime="2025-10-27T11:05:47+09:00">2025-10-27</time>
      </span>
    

    

    
  </p>


    <p class="archive__item-excerpt" itemprop="description">

</p>
  </article>
</div>

    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/llm/openai-function-call-examples/" rel="permalink">OpenAI 함수 호출 테스트
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <!-- hvppyarchive: remove date icon
        <i class="far fa-calendar-alt" aria-hidden="true"></i> 
        -->
        
        <time datetime="2025-10-24T16:39:17+09:00">2025-10-24</time>
      </span>
    

    

    
  </p>


    <p class="archive__item-excerpt" itemprop="description">

</p>
  </article>
</div>

    
  </div>
</div>

  
  
</div>

      
    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';" role="search">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        

<div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
      
        
      
        
      
        
      
        
      
        
      
    

    
  </ul>
</div>


<div class="page__footer-copyright">&copy; 2013 - 2025 <a href="https://hvppyarchive.github.io">ARCHIVE</a>. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/jekyll-themes/minimal-mistakes/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>






  </body>
</html>
