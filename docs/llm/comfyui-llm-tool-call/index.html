<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.27.1 by Michael Rose
  Copyright 2013-2025 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->

<html lang="en-US" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>ComfyUI LLM Tool Call - ARCHIVE</title>
<meta name="description" content="">


  <meta name="author" content="hvppyarchive">
  
  <meta property="article:author" content="hvppyarchive">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="ARCHIVE">
<meta property="og:title" content="ComfyUI LLM Tool Call">
<meta property="og:url" content="https://hvppyarchive.github.io/llm/comfyui-llm-tool-call/">


  <meta property="og:description" content="">







  <meta property="article:published_time" content="2025-10-27T15:55:08+09:00">





  

  


<link rel="canonical" href="https://hvppyarchive.github.io/llm/comfyui-llm-tool-call/">












<!-- end _includes/seo.html -->


<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
  
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css"></noscript>



    <!-- start custom head snippets -->
<!-- hvppyarchive: add fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@200..900&display=swap" rel="stylesheet">

<!-- insert favicons. use https://realfavicongenerator.net/ -->
 <!-- hvppyarchive: add favicons -->
<link rel="icon" type="image/png" href="/assets/favicon/favicon-96x96.png" sizes="96x96" />
<link rel="icon" type="image/svg+xml" href="/assets/favicon/favicon.svg" />
<link rel="shortcut icon" href="/assets/favicon/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon/apple-touch-icon.png" />
<link rel="manifest" href="/assets/favicon/site.webmanifest" />

<!-- end custom head snippets -->

  </head>

  <body class="layout--single" dir="ltr">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          ARCHIVE
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a
                href="/year-archive/"
                
                
              >Posts</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <i class="fas fa-search"></i>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      





<div id="main" role="main">
  


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="ComfyUI LLM Tool Call">
    <meta itemprop="description" content="">
    <meta itemprop="datePublished" content="2025-10-27T15:55:08+09:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">
            <a href="https://hvppyarchive.github.io/llm/comfyui-llm-tool-call/" itemprop="url">ComfyUI LLM Tool Call
</a>
          </h1>
          

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <!-- hvppyarchive: remove date icon
        <i class="far fa-calendar-alt" aria-hidden="true"></i> 
        -->
        
        <time datetime="2025-10-27T15:55:08+09:00">2025-10-27</time>
      </span>
    

    

    
  </p>


        </header>
      

      <section class="page__content" itemprop="text">
        
        <p class="chat--user">

openai package를 사용하는 테스트 코드 작성할거야. 목표: 2가지 모델에 대해 2가지 api type(completions, responses)에 대해 function calling 테스트를 하고 싶어. 총 4개 조합에 대해 설정할 수 있게 코드 작성 하자. 툴은 간단히 특정 폴더의 파일 조회, 특정 폴더의 파일 읽기 두 가지 툴을 구현할거야 2개 모델에 대한 엔드포인트, api 키, 모델명을 코드 내에서 설정할 수 있도록 할 것.

</p>

<p>좋아! 아래는 “두 모델 × 두 API 타입(completions, responses) × 함수 호출(function calling)” 조합을 한 파일에서 모두 테스트할 수 있는 파이썬 스크립트야.<br />
요구사항 정리대로</p>

<ol>
  <li>
    <p>두 가지 파일 관련 툴(폴더 내 파일 목록 조회, 파일 읽기)</p>
  </li>
  <li>
    <p>2개 모델에 대한 엔드포인트·API 키·모델명을 코드 내에서 설정 가능</p>
  </li>
  <li>
    <p>4가지 조합을 원하는 대로 실행 가능</p>
  </li>
</ol>

<p>을 모두 담았어. 최신 OpenAI Python SDK의 사용법과 Responses API의 툴 호출 흐름은 공식 문서의 구조를 따랐어. 참고: function calling과 tools 정의 방식은 공식 가이드와 동일하고, Chat Completions API에서는 tool_calls를 message에, Responses API에서는 output 항목과 tool_calls를 통해 주고받는 형태야. 관련 문서: Function Calling 가이드와 Responses API 레퍼런스. <a href="https://platform.openai.com/docs/guides/function-calling">OpenAI 플랫폼+1</a></p>

<p>스크립트는 다음처럼 동작해</p>

<ul>
  <li>
    <p>MODELS 섹션에서 model A/B의 endpoint, api_key, model 이름을 채워둔다(예시 포함).</p>
  </li>
  <li>
    <p>TOOL 정의는 공통(JSON Schema).</p>
  </li>
  <li>
    <p>run_with_chat_completions(…), run_with_responses(…) 두 함수가 각각 함수 호출 루프를 수행.</p>
  </li>
  <li>
    <p>main에서 네 가지 조합을 순차 실행하거나, 원하는 조합만 선택 실행하도록 CLI 옵션 제공.</p>
  </li>
</ul>

<p>코드 복사해서 test_openai_tools.py로 저장한 뒤, samples 폴더에 테스트용 파일을 몇 개 넣고 돌려봐.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># test_openai_tools.py
# Python 3.10+
# pip install --upgrade openai
</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">argparse</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>

<span class="c1"># =========================
# 1) 구성(모델/엔드포인트/키)
# =========================
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ModelConfig</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span>               <span class="c1"># ex) "https://api.openai.com/v1"
</span>    <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span>                <span class="c1"># ex) os.getenv("OPENAI_API_KEY")
</span>
<span class="c1"># 여기서 두 모델에 대한 엔드포인트/키/모델명을 설정하세요.
# 실제 키를 코드에 하드코딩하지 말고, 환경변수를 권장합니다.
</span><span class="n">MODELS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-4.1-mini</span><span class="sh">"</span><span class="p">,</span>          <span class="c1"># 예시 (원하는 최신 모델명으로 변경)
</span>        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_MODEL_A</span><span class="sh">"</span><span class="p">)</span>
    <span class="p">),</span>
    <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">,</span>           <span class="c1"># 예시 (원하는 최신 모델명으로 변경)
</span>        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL_B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY_B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_MODEL_B</span><span class="sh">"</span><span class="p">)</span>
    <span class="p">),</span>
<span class="p">}</span>

<span class="c1"># =====================================
# 2) 로컬 파일 툴(폴더 목록/파일 읽기)
# =====================================
</span>
<span class="k">def</span> <span class="nf">list_files_in_folder</span><span class="p">(</span><span class="n">folder_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">지정 폴더 내 파일 목록 반환(파일만).</span><span class="sh">"""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">items</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">listdir</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">items</span> <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">f</span><span class="p">))]</span>
    <span class="k">return</span> <span class="n">files</span>

<span class="k">def</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">지정 경로의 텍스트 파일 내용 반환(UTF-8 가정).</span><span class="sh">"""</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">return</span> <span class="sh">""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
    <span class="k">except</span> <span class="nb">UnicodeDecodeError</span><span class="p">:</span>
        <span class="c1"># 바이너리 등 텍스트가 아닌 경우
</span>        <span class="k">return</span> <span class="sh">""</span>

<span class="c1"># 공통 툴 스키마(JSON Schema; Chat Completions/Responses에서 그대로 사용)
</span><span class="n">TOOLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content as a string.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative path to the text file.</span><span class="sh">"</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">]</span>

<span class="c1"># 툴 디스패처
</span><span class="k">def</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arguments</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="n">arguments</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="nf">list_files_in_folder</span><span class="p">(</span><span class="n">folder</span><span class="p">),</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">arguments</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="k">return</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span>

<span class="c1"># =====================================
# 3) Chat Completions로 함수 호출 테스트
# =====================================
</span>
<span class="k">def</span> <span class="nf">run_with_chat_completions</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tool_choice</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Chat Completions API로 function calling 테스트.
    - tools: TOOLS
    - tool_choice: </span><span class="sh">'</span><span class="s">auto</span><span class="sh">'</span><span class="s"> 권장
    - tool_calls -&gt; 실제 파이썬 함수 실행 -&gt; tool 메시지 첨부 -&gt; 재호출
    </span><span class="sh">"""</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>

    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_task</span><span class="p">},</span>
    <span class="p">]</span>

    <span class="c1"># 1차 호출
</span>    <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
        <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
        <span class="n">tools</span><span class="o">=</span><span class="n">TOOLS</span><span class="p">,</span>
        <span class="n">tool_choice</span><span class="o">=</span><span class="n">tool_choice</span>  <span class="c1"># 'auto' or {'type':'function','function':{'name':'...'}}
</span>    <span class="p">)</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

    <span class="c1"># 함수 호출 루프
</span>    <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
            <span class="n">fn_name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
            <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">tool_output</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>

            <span class="c1"># tool 메시지 첨부
</span>            <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">tool_output</span>
            <span class="p">})</span>

        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">]})</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

        <span class="c1"># 후속 호출(최종 답변 유도)
</span>        <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">messages</span><span class="o">=</span><span class="n">messages</span>
        <span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

    <span class="k">return</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span>

<span class="c1"># =====================================
# 4) Responses API로 함수 호출 테스트
#    - 최신 SDK 규약에 맞춰 비스트리밍 루프 구성
# =====================================
</span>
<span class="k">def</span> <span class="nf">extract_text_from_responses_output</span><span class="p">(</span><span class="n">output_items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Responses API의 output 배열에서 자연어 텍스트만 모아 반환.</span><span class="sh">"""</span>
    <span class="n">chunks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output_items</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="c1"># item.type == "message" 인 경우, item.content[*] 중 type == "output_text"
</span>        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]:</span>
                <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                    <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
        <span class="c1"># 일부 모델은 최종에 바로 output_text만 내보내기도 함
</span>        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
    <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">chunks</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">extract_tool_calls_from_responses_output</span><span class="p">(</span><span class="n">output_items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="sh">"""</span><span class="s">
    Responses API의 output에서 tool_call 이벤트를 수집.
    각 항목은 {id, name, arguments} 형태로 정규화해서 반환.
    </span><span class="sh">"""</span>
    <span class="n">calls</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output_items</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="c1"># 케이스1: item.type == "tool_call"
</span>        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">tool_call</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">tc</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}</span>
            <span class="p">}</span>
            <span class="c1"># arguments는 문자열/딕셔너리 모두 가능성 고려
</span>            <span class="n">raw_args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">raw_args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">raw_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw_args</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">raw_args</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">tc</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">raw_args</span> <span class="ow">or</span> <span class="p">{}</span>
            <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">tc</span><span class="p">)</span>

        <span class="c1"># 케이스2: item.type == "message" 내부 content[*]에 tool_calls 묶여있을 수 있음
</span>        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="c1"># 일부 SDK 버전에서 item.tool_calls 또는 item.content[*].tool_calls 형태
</span>            <span class="n">inner_calls</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inner_calls</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">inner_calls</span><span class="p">:</span>
                    <span class="n">arg_obj</span> <span class="o">=</span> <span class="n">c</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="p">{}</span>
                    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">arg_obj</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">arg_obj</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">arg_obj</span><span class="p">)</span>
                        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                            <span class="n">arg_obj</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                        <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">function</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                        <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">arg_obj</span> <span class="ow">or</span> <span class="p">{}</span>
                    <span class="p">})</span>
    <span class="k">return</span> <span class="n">calls</span>

<span class="k">def</span> <span class="nf">run_with_responses</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tool_choice</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Responses API로 function calling 테스트.
    흐름:
      1) responses.create(input=[{role:user, content:...}], tools=TOOLS, tool_choice=...)
      2) tool_call이 있으면 로컬 함수 실행
      3) responses.create(..., tool_outputs=[{tool_call_id, output}], response_id=prev.id) 로 이어서 호출
         (최신 문서의 규약을 따름)
    </span><span class="sh">"""</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>

    <span class="c1"># 1차 호출
</span>    <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
        <span class="nb">input</span><span class="o">=</span><span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_task</span><span class="p">}],</span>
        <span class="n">tools</span><span class="o">=</span><span class="n">TOOLS</span><span class="p">,</span>
        <span class="n">tool_choice</span><span class="o">=</span><span class="n">tool_choice</span>
    <span class="p">)</span>

    <span class="c1"># 루프: 도구 호출이 끝날 때까지
</span>    <span class="n">final_text_parts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>  <span class="c1"># 안전 상한
</span>        <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">tool_calls</span> <span class="o">=</span> <span class="nf">extract_tool_calls_from_responses_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="n">plain_text</span> <span class="o">=</span> <span class="nf">extract_text_from_responses_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="k">if</span> <span class="n">plain_text</span><span class="p">:</span>
            <span class="n">final_text_parts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">plain_text</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">tool_calls</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="n">tool_outputs_payload</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">tool_calls</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">tc</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">tc</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
            <span class="n">tool_outputs_payload</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">tc</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">out</span>
            <span class="p">})</span>

        <span class="c1"># 이전 response와 이어 붙여 툴 결과를 전달
</span>        <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">TOOLS</span><span class="p">,</span>
            <span class="n">response_id</span><span class="o">=</span><span class="n">r</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
            <span class="n">tool_outputs</span><span class="o">=</span><span class="n">tool_outputs_payload</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">final_text_parts</span> <span class="k">if</span> <span class="n">p</span><span class="p">])</span>

<span class="c1"># =====================================
# 5) 실행부(4가지 조합)
# =====================================
</span>
<span class="n">DEFAULT_USER_TASK</span> <span class="o">=</span> <span class="p">(</span>
    <span class="sh">"</span><span class="s">테스트: ./samples 폴더 안의 파일 목록을 보여주고, 텍스트 파일이 하나라도 있으면 </span><span class="sh">"</span>
    <span class="sh">"</span><span class="s">그 중 하나의 내용을 읽어서 핵심만 2~3문장으로 요약해줘. 필요하면 툴을 사용해.</span><span class="sh">"</span>
<span class="p">)</span>

<span class="k">def</span> <span class="nf">run_one</span><span class="p">(</span><span class="n">combo_api</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">MODELS</span><span class="p">[</span><span class="n">model_key</span><span class="p">]</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">=== [</span><span class="si">{</span><span class="n">combo_api</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span><span class="si">}</span><span class="s">] with Model </span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="s"> (</span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">) ===</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">combo_api</span> <span class="o">==</span> <span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nf">run_with_chat_completions</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">user_task</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">combo_api</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nf">run_with_responses</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">user_task</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">combo_api must be </span><span class="sh">'</span><span class="s">completions</span><span class="sh">'</span><span class="s"> or </span><span class="sh">'</span><span class="s">responses</span><span class="sh">'"</span><span class="p">)</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">--- OUTPUT ---</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">out</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">(empty)</span><span class="sh">"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="nc">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Test function-calling with OpenAI (4-way matrix).</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--api</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">all</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">all</span><span class="sh">"</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">Which API type to run.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--model</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">Which model to use.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--task</span><span class="sh">"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_USER_TASK</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">User task/prompt.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="nf">parse_args</span><span class="p">()</span>

    <span class="n">apis</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">api</span> <span class="o">==</span> <span class="sh">"</span><span class="s">all</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">api</span><span class="p">]</span>
    <span class="n">models</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">model</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">model</span><span class="p">]</span>

    <span class="c1"># 샘플 폴더 안내
</span>    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="sh">"</span><span class="s">./samples</span><span class="sh">"</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">api</span> <span class="ow">in</span> <span class="n">apis</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">:</span>
            <span class="nf">run_one</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">task</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="nf">main</span><span class="p">()</span>
</code></pre></div></div>

<p>사용 방법 간단 정리</p>

<ol>
  <li>환경 변수 세팅(권장)</li>
</ol>

<ul>
  <li>
    <p>Model A</p>

    <ul>
      <li>
        <p>OPENAI_API_KEY=…</p>
      </li>
      <li>
        <p>OPENAI_BASE_URL=https://api.openai.com/v1</p>
      </li>
    </ul>
  </li>
  <li>
    <p>Model B</p>

    <ul>
      <li>
        <p>OPENAI_API_KEY_B=…</p>
      </li>
      <li>
        <p>OPENAI_BASE_URL_B=https://api.openai.com/v1</p>
      </li>
    </ul>
  </li>
</ul>

<ol>
  <li>테스트 파일 준비</li>
</ol>

<ul>
  <li>프로젝트 루트에 samples 폴더를 만들고, 텍스트 파일을 1개 이상 넣는다. 예: samples/readme.txt</li>
</ul>

<ol>
  <li>실행</li>
</ol>

<ul>
  <li>
    <p>네 조합 모두:<br />
python test_openai_tools.py</p>
  </li>
  <li>
    <p>특정 API만:<br />
python test_openai_tools.py –api completions<br />
python test_openai_tools.py –api responses</p>
  </li>
  <li>
    <p>특정 모델만:<br />
python test_openai_tools.py –model A<br />
python test_openai_tools.py –model B</p>
  </li>
  <li>
    <p>프롬프트 커스터마이즈:<br />
python test_openai_tools.py –task "여기에 원하는 테스트 지시문"</p>
  </li>
</ul>

<p>구현 포인트 설명(필요 시 점검할 체크리스트)</p>

<ul>
  <li>
    <p>Chat Completions: response.choices[0].message.tool_calls를 확인하고, 각 툴을 실행한 뒤 tool 메시지를 추가해서 재호출하는 전형적 루프를 사용했어. 이것은 Function Calling 가이드의 권고 패턴이야. <a href="https://platform.openai.com/docs/guides/function-calling">OpenAI 플랫폼</a></p>
  </li>
  <li>
    <p>Responses API: responses.create(…) → output에서 tool_call 이벤트를 수집 → 실제 함수 실행 → tool_outputs와 이전 response_id를 함께 넘겨 후속 responses.create(…) 호출로 이어 붙이는 패턴이야. 이 흐름은 공식 Responses API 레퍼런스가 안내하는 방식과 맞물려 있어. <a href="https://platform.openai.com/docs/api-reference/responses/create">OpenAI 플랫폼</a></p>
  </li>
  <li>
    <p>tools 스키마는 두 API에서 동일하게 재사용.</p>
  </li>
  <li>
    <p>로컬 파일 I/O는 안전하게 예외 처리했고, 텍스트 파일로 가정(UTF-8)했지만 디코딩 실패 시 빈 문자열을 반환해 모델이 적절히 안내하도록 했어.</p>
  </li>
</ul>

<p>문서 참고 링크</p>

<ul>
  <li>
    <p>Function Calling 가이드(툴 정의/호출 흐름) <a href="https://platform.openai.com/docs/guides/function-calling">OpenAI 플랫폼</a></p>
  </li>
  <li>
    <p>Responses API 레퍼런스(응답 구조, tool_outputs 전달 방식) <a href="https://platform.openai.com/docs/api-reference/responses/create">OpenAI 플랫폼</a></p>
  </li>
</ul>

<p>필요하면</p>

<ul>
  <li>
    <p>모델명만 바꿔서(예: 최신 gpt-4.1 계열 등) 즉시 시험 가능</p>
  </li>
  <li>
    <p>tool_choice를 "any"로 바꾸면 여러 툴 병렬 호출 경향을 더 시험할 수 있어</p>
  </li>
  <li>
    <p>samples 폴더 경로나 읽을 파일 선택 로직을 더 엄격하게 지정하고 싶다면, 프롬프트를 고정(seed task)하거나 시스템 메시지쪽에 규칙을 더해도 좋아</p>
  </li>
</ul>

<p>원하는 부분 더 바꿔드릴게.</p>

<p class="chat--user">

아니 내가 조사했을 때 responses용 툴 json이 있고, completion용이 따로 있어 조금 다르게 생겼던데 찾아서 반영해줘

</p>

<p>좋은 지적이야. 실제로 “도구 정의(tools JSON)”는 두 API가 거의 같지만, Responses API는 실행·상태 전파 방식(response_id, tool_outputs 등)과 출력 구조가 다르고, 가이드에선 Responses 예시에서 엄격 파싱(strict) 옵션을 곁들여 쓰는 패턴이 자주 보여서 모양이 살짝 달라 보일 수 있어. 그래서 아래처럼 아예 두 벌의 스키마를 분리해 두고, Responses 쪽엔 엄격 파싱을 넣는 식으로 반영했어. 또한 Responses는 tool_outputs와 response_id를 통해 단계적으로 이어붙이는 점을 코드에 명확히 했어. 참고 문서: Function Calling 가이드와 Responses API 레퍼런스. <a href="https://platform.openai.com/docs/guides/function-calling/supported-models?utm_source=chatgpt.com">OpenAI 플랫폼+2</a></p>

<p>아래 스크립트는 네 가지 조합(모델 A/B × completions/responses) 모두 함수 호출을 시험하고, 두 종류의 파일 툴을 제공해. 변경 포인트는 1) CHAT_TOOLS vs RESPONSES_TOOLS 분리, 2) Responses 루프에서 tool_outputs·response_id 사용을 더 엄격히, 3) Responses 출력 파서 보강이야.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># test_openai_tools_split_tools.py
# pip install --upgrade openai
</span>
<span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">json</span><span class="p">,</span> <span class="n">argparse</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ModelConfig</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span>

<span class="n">MODELS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">MODEL_A_NAME</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-4.1-mini</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_MODEL_A</span><span class="sh">"</span><span class="p">),</span>
    <span class="p">),</span>
    <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">MODEL_B_NAME</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL_B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY_B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_MODEL_B</span><span class="sh">"</span><span class="p">),</span>
    <span class="p">),</span>
<span class="p">}</span>

<span class="c1"># 공통 실제 구현 함수
</span><span class="kn">import</span> <span class="n">os</span>
<span class="k">def</span> <span class="nf">list_files_in_folder</span><span class="p">(</span><span class="n">folder_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="nf">listdir</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">f</span><span class="p">))]</span>
    <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>

<span class="k">def</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">return</span> <span class="sh">""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
    <span class="k">except</span> <span class="nb">UnicodeDecodeError</span><span class="p">:</span>
        <span class="k">return</span> <span class="sh">""</span>

<span class="k">def</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="nf">list_files_in_folder</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)),</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
    <span class="k">return</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span>

<span class="c1"># Chat Completions 전용 도구 JSON
# - 전통적인 function calling 스키마
</span><span class="n">CHAT_TOOLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">}</span>
        <span class="p">},</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Path to the text file.</span><span class="sh">"</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">}</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">]</span>

<span class="c1"># Responses 전용 도구 JSON
# - 스키마 필드는 유사하지만, Responses 예제 관례에 맞춰 strict를 켬
#   (모델이 schema에 정확히 맞춰 인자 생성하도록 강제)
</span><span class="n">RESPONSES_TOOLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">strict</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span>
        <span class="p">},</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Path to the text file.</span><span class="sh">"</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">strict</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">]</span>

<span class="k">def</span> <span class="nf">run_with_chat_completions</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tools_choice</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_task</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">CHAT_TOOLS</span><span class="p">,</span> <span class="n">tool_choice</span><span class="o">=</span><span class="n">tools_choice</span>
    <span class="p">)</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
    <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">):</span>
        <span class="c1"># 각 툴 실행
</span>        <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
            <span class="n">fn_name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
            <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>
            <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">output</span><span class="p">})</span>
        <span class="c1"># 대화 이어붙이기
</span>        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">]})</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
    <span class="k">return</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span>

<span class="c1"># Responses 출력 파서
</span><span class="k">def</span> <span class="nf">_extract_text</span><span class="p">(</span><span class="n">output_items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">chunks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output_items</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]:</span>
                <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                    <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
    <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">chunks</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">_extract_tool_calls</span><span class="p">(</span><span class="n">output_items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="n">calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output_items</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">tool_call</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">raw_args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">raw_args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span> <span class="n">raw_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw_args</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="n">raw_args</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">raw_args</span> <span class="ow">or</span> <span class="p">{}})</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">inner_calls</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inner_calls</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">inner_calls</span><span class="p">:</span>
                    <span class="n">raw_args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">raw_args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span> <span class="n">raw_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw_args</span><span class="p">)</span>
                        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="n">raw_args</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                        <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">function</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                        <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">raw_args</span> <span class="ow">or</span> <span class="p">{}</span>
                    <span class="p">})</span>
    <span class="k">return</span> <span class="n">calls</span>

<span class="k">def</span> <span class="nf">run_with_responses</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tools_choice</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
        <span class="nb">input</span><span class="o">=</span><span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_task</span><span class="p">}],</span>
        <span class="n">tools</span><span class="o">=</span><span class="n">RESPONSES_TOOLS</span><span class="p">,</span>
        <span class="n">tool_choice</span><span class="o">=</span><span class="n">tools_choice</span>
    <span class="p">)</span>

    <span class="n">final_text</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Responses는 tool_outputs + response_id로 상태를 이어서 보낸다.
</span>    <span class="c1"># 이어붙이기 패턴은 공식 레퍼런스의 흐름과 동일. :contentReference[oaicite:1]{index=1}
</span>    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>  <span class="c1"># 안전 상한
</span>        <span class="n">txt</span> <span class="o">=</span> <span class="nf">_extract_text</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="k">if</span> <span class="n">txt</span><span class="p">:</span>
            <span class="n">final_text</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>

        <span class="n">calls</span> <span class="o">=</span> <span class="nf">_extract_tool_calls</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="n">tool_outputs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">tc</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">tc</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
            <span class="n">tool_outputs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">tc</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">out</span><span class="p">})</span>

        <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">RESPONSES_TOOLS</span><span class="p">,</span>
            <span class="n">response_id</span><span class="o">=</span><span class="n">r</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>          <span class="c1"># 이전 응답과 연결
</span>            <span class="n">tool_outputs</span><span class="o">=</span><span class="n">tool_outputs</span>  <span class="c1"># 툴 실행 결과 전달
</span>        <span class="p">)</span>

    <span class="k">return</span> <span class="sh">"</span><span class="se">\n\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">final_text</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span> <span class="ow">or</span> <span class="sh">""</span>

<span class="n">DEFAULT_TASK</span> <span class="o">=</span> <span class="p">(</span>
    <span class="sh">"</span><span class="s">테스트: ./samples 폴더의 파일 목록을 보여주고, 텍스트 파일이 있으면 하나 골라 내용을 읽고 2~3문장 요약. 필요하면 툴 사용.</span><span class="sh">"</span>
<span class="p">)</span>

<span class="k">def</span> <span class="nf">run_one</span><span class="p">(</span><span class="n">which_api</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">MODELS</span><span class="p">[</span><span class="n">model_key</span><span class="p">]</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">=== [</span><span class="si">{</span><span class="n">which_api</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span><span class="si">}</span><span class="s">] Model </span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="s"> (</span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">) ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">which_api</span> <span class="o">==</span> <span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nf">run_with_chat_completions</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">user_task</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">which_api</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nf">run_with_responses</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">user_task</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">which_api must be </span><span class="sh">'</span><span class="s">completions</span><span class="sh">'</span><span class="s"> or </span><span class="sh">'</span><span class="s">responses</span><span class="sh">'"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">--- OUTPUT ---</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">out</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">(empty)</span><span class="sh">"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="sh">"</span><span class="s">./samples</span><span class="sh">"</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="nc">ArgumentParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--api</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">all</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">all</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--model</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--task</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_TASK</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="nf">parse_args</span><span class="p">()</span>

    <span class="n">apis</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">api</span> <span class="o">==</span> <span class="sh">"</span><span class="s">all</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">api</span><span class="p">]</span>
    <span class="n">models</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">model</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">model</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">apis</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">:</span>
            <span class="nf">run_one</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">task</span><span class="p">)</span>
</code></pre></div></div>

<p>핵심 차이 정리 단계별</p>

<ol>
  <li>
    <p>도구 정의 자체는 필드 구조가 동일(type=function, function.name/description/parameters)하되, Responses 쪽 예시에서는 strict를 켜서 JSON Schema를 엄격히 지키게 하는 패턴이 널리 쓰인다. 그래서 스키마가 “조금 다르게 생긴 것처럼” 보일 수 있다. <a href="https://platform.openai.com/docs/guides/function-calling/supported-models?utm_source=chatgpt.com">OpenAI 플랫폼+1</a></p>
  </li>
  <li>
    <p>Chat Completions는 messages 배열에 assistant.tool_calls가 나오고, 각 call.id에 대응하는 tool 메시지를 넣어 다시 chat.completions.create를 호출한다.</p>
  </li>
  <li>
    <p>Responses는 output에 tool_call 항목이 나오며, 실제 도구 실행 후 tool_outputs 배열과 이전 응답의 response_id를 포함해 responses.create를 다시 호출해 상태를 이어 붙인다. 이게 가장 큰 차이점이다. <a href="https://platform.openai.com/docs/api-reference/responses-streaming/response?utm_source=chatgpt.com">OpenAI 플랫폼</a></p>
  </li>
</ol>

<p>이 버전으로 돌려보고, Responses에서 strict를 끄고 싶으면 RESPONSES_TOOLS에서 "strict": True만 빼면 돼. 모델·엔드포인트·키는 상단 MODELS에서 조정 가능하고, samples 폴더에 테스트 파일만 있으면 바로 네 조합을 모두 확인할 수 있어.</p>

<p class="chat--user">

아니 예시를 좀 찾아봐.. from openai import OpenAI import json client = OpenAI() # 1. Define a list of callable tools for the model tools = [ { "type": "function", "name": "get_horoscope", "description": "Get today's horoscope for an astrological sign.", "parameters": { "type": "object", "properties": { "sign": { "type": "string", "description": "An astrological sign like Taurus or Aquarius", }, }, "required": ["sign"], }, }, ] def get_horoscope(sign): return f"{sign}: Next Tuesday you will befriend a baby otter." # Create a running input list we will add to over time input_list = [ {"role": "user", "content": "What is my horoscope? I am an Aquarius."} ] # 2. Prompt the model with tools defined response = client.responses.create( model="gpt-5", tools=tools, input=input_list, ) # Save function call outputs for subsequent requests input_list += response.output for item in response.output: if item.type == "function_call": if item.name == "get_horoscope": # 3. Execute the function logic for get_horoscope horoscope = get_horoscope(json.loads(item.arguments)) # 4. Provide function call results to the model input_list.append({ "type": "function_call_output", "call_id": item.call_id, "output": json.dumps({ "horoscope": horoscope }) }) print("Final input:") print(input_list) response = client.responses.create( model="gpt-5", instructions="Respond only with a horoscope generated by a tool.", tools=tools, input=input_list, ) # 5. The model should be able to give a response! print("Final output:") print(response.model_dump_json(indent=2)) print("\n" + response.output_text) 그러면 총 8개 조합이 나오지? 모델 x API 타입(completion, responses) x json 형태 이 8개 조합에 대해 각각 테스트하는 코드를 짜줘 이 때 실행 중 에러가 나는 경우에는 에러만 출력하고 나머지가 잘 수행되게 해줘.

</p>

<p>좋아. “2개 모델 × 2개 API(completions, responses) × 2가지 tools JSON 형태(Completions 스타일 vs Responses 스타일)” = 총 8개 조합을 한 번에 돌려보는 테스트 스크립트를 준비했어. 각 조합은 개별 try/except로 감싸 에러가 나더라도 나머지가 계속 수행돼. tools JSON은 네가 준 Responses 스타일 예시(평평한 형태: type/name/parameters가 최상위)와, Chat Completions에서 흔히 쓰는 중첩 형태({"type":"function","function":{…}})를 각각 분리해 두었고, 일부 조합은 의도적으로 “맞지 않는 형태”를 넣었기 때문에 실패할 수도 있어(그 경우 에러만 출력). 참고로 Responses와 Chat Completions의 차이, strict 옵션 등은 최신 가이드에 정리돼 있어. <a href="https://platform.openai.com/docs/guides/responses-vs-chat-completions?utm_source=chatgpt.com">OpenAI 플랫폼+2</a></p>

<p>아래 파일을 test_8combos_tools.py로 저장해서 실행하면 돼.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># test_8combos_tools.py
# Python 3.10+
# pip install --upgrade openai
</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">argparse</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>

<span class="c1"># =========================
# 0) 모델 설정
# =========================
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ModelConfig</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span>

<span class="n">MODELS</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ModelConfig</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">MODEL_A_NAME</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-4.1-mini</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL_A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY_A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_MODEL_A</span><span class="sh">"</span><span class="p">),</span>
    <span class="p">),</span>
    <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">MODEL_B_NAME</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL_B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY_B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_MODEL_B</span><span class="sh">"</span><span class="p">),</span>
    <span class="p">),</span>
<span class="p">}</span>

<span class="c1"># =========================
# 1) 로컬 툴 구현
# =========================
</span>
<span class="k">def</span> <span class="nf">list_files_in_folder</span><span class="p">(</span><span class="n">folder_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">sorted</span><span class="p">([</span>
            <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="nf">listdir</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
        <span class="p">])</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>

<span class="k">def</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">return</span> <span class="sh">""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="sh">""</span>

<span class="k">def</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">
    모든 툴의 결과를 dict로 통일해서 반환.
    Responses의 function_call_output에 넣기 좋게 {</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="s">: ...} 형태로 감싸준다.
    </span><span class="sh">"""</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="nf">list_files_in_folder</span><span class="p">(</span><span class="n">folder</span><span class="p">)}</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="n">path</span><span class="p">)}</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="c1"># =========================
# 2) tools JSON 두 가지 형태
# =========================
</span>
<span class="c1"># (A) Chat Completions 스타일: function 필드에 중첩
</span><span class="n">CHAT_STYLE_TOOLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative file path.</span><span class="sh">"</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">]</span>

<span class="c1"># (B) Responses 스타일: 네가 준 예시처럼 평평한 형태(일부 문서/예시에서 보이는 포맷)
</span><span class="n">RESPONSES_STYLE_TOOLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="c1"># "strict": True  # 필요 시 켜서 인자 스키마 준수 강제 (도움말 참조)
</span>    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative file path.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="c1"># "strict": True
</span>    <span class="p">},</span>
<span class="p">]</span>

<span class="c1"># =========================
# 3) Chat Completions 쪽 함수 호출 루프
# =========================
</span>
<span class="k">def</span> <span class="nf">run_chat_completions</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    tools_variant: </span><span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="s"> 또는 </span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="s">
    </span><span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="s">  -&gt; CHAT_STYLE_TOOLS 사용 (권장)
    </span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="s"> -&gt; RESPONSES_STYLE_TOOLS 사용 (의도적 비호환 가능)
    </span><span class="sh">"""</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="n">CHAT_STYLE_TOOLS</span> <span class="k">if</span> <span class="n">tools_variant</span> <span class="o">==</span> <span class="sh">"</span><span class="s">chat</span><span class="sh">"</span> <span class="k">else</span> <span class="n">RESPONSES_STYLE_TOOLS</span>

    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_task</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
        <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
        <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
        <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

    <span class="c1"># tool_calls 루프
</span>    <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
        <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
            <span class="n">fn_name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
            <span class="c1"># arguments는 문자열일 수 있음
</span>            <span class="k">try</span><span class="p">:</span>
                <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="n">fn_args</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">tool_output</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>

            <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">tool_output</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
            <span class="p">})</span>

        <span class="c1"># 대화 이어붙이기
</span>        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
            <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">],</span>
        <span class="p">})</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

        <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

    <span class="k">return</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span>

<span class="c1"># =========================
# 4) Responses 쪽 함수 호출 루프
# =========================
</span>
<span class="k">def</span> <span class="nf">_collect_function_calls_from_output</span><span class="p">(</span><span class="n">output</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="sh">"""</span><span class="s">
    Responses API의 output 배열에서 function_call / tool_call 류 이벤트를 추출.
    다양한 케이스를 최대한 관대하게 처리한다.
    </span><span class="sh">"""</span>
    <span class="n">calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="n">itype</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="c1"># 케이스 A: item.type == "function_call"
</span>        <span class="k">if</span> <span class="n">itype</span> <span class="o">==</span> <span class="sh">"</span><span class="s">function_call</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{},</span>
            <span class="p">})</span>

        <span class="c1"># 케이스 B: 일부 모델이 "tool_call" / item.message.tool_calls 형태로 줄 때
</span>        <span class="k">if</span> <span class="n">itype</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">inner</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inner</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">inner</span><span class="p">:</span>
                    <span class="n">nm</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                            <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                        <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">nm</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{},</span>
                    <span class="p">})</span>
    <span class="k">return</span> <span class="n">calls</span>

<span class="k">def</span> <span class="nf">_collect_text_from_output</span><span class="p">(</span><span class="n">output</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]:</span>
                <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                    <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
    <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">texts</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">run_responses</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    tools_variant: </span><span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="s"> 또는 </span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="s">
    </span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="s"> -&gt; RESPONSES_STYLE_TOOLS 사용 (권장)
    </span><span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="s">      -&gt; CHAT_STYLE_TOOLS 사용 (의도적 비호환 가능)
    순수 Responses 방식: 네가 준 예시 패턴(input_list 축적 + function_call_output)로 구현.
    </span><span class="sh">"""</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="n">RESPONSES_STYLE_TOOLS</span> <span class="k">if</span> <span class="n">tools_variant</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span> <span class="k">else</span> <span class="n">CHAT_STYLE_TOOLS</span>

    <span class="c1"># running input_list
</span>    <span class="n">input_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_task</span><span class="p">}</span>
    <span class="p">]</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
        <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
        <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># function_call 처리
</span>    <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

    <span class="c1"># call들을 찾아 실행하고, function_call_output을 이어 붙임
</span>    <span class="n">calls</span> <span class="o">=</span> <span class="nf">_collect_function_calls_from_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
    <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
        <span class="n">input_list</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function_call_output</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
        <span class="p">})</span>

    <span class="c1"># 최종 응답 시도(지시문을 추가적으로 줄 수도 있음)
</span>    <span class="n">r2</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
        <span class="n">instructions</span><span class="o">=</span><span class="sh">"</span><span class="s">Respond with a short summary of what you found.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
        <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># 텍스트 추출(중간/최종)
</span>    <span class="n">final_text</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">txt1</span> <span class="o">=</span> <span class="nf">_collect_text_from_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
    <span class="k">if</span> <span class="n">txt1</span><span class="p">:</span> <span class="n">final_text</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">txt1</span><span class="p">)</span>
    <span class="n">txt2</span> <span class="o">=</span> <span class="nf">_collect_text_from_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
    <span class="k">if</span> <span class="n">txt2</span><span class="p">:</span> <span class="n">final_text</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">txt2</span><span class="p">)</span>
    <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">final_text</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span> <span class="ow">or</span> <span class="sh">""</span>

<span class="c1"># =========================
# 5) 8개 조합 실행기
# =========================
</span>
<span class="n">DEFAULT_TASK</span> <span class="o">=</span> <span class="p">(</span>
    <span class="sh">"</span><span class="s">테스트: ./samples 폴더의 파일 목록을 보여주고, 텍스트 파일이 있으면 하나 골라 내용을 읽고 2~3문장 요약. 필요하면 도구를 사용해.</span><span class="sh">"</span>
<span class="p">)</span>

<span class="k">def</span> <span class="nf">run_one</span><span class="p">(</span><span class="n">api_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">MODELS</span><span class="p">[</span><span class="n">model_key</span><span class="p">]</span>
    <span class="n">header</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[</span><span class="si">{</span><span class="n">api_type</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span><span class="si">}</span><span class="s">] model=</span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s"> tools_json=</span><span class="si">{</span><span class="n">tools_variant</span><span class="si">}</span><span class="sh">"</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="sh">"</span><span class="s">=</span><span class="sh">"</span> <span class="o">*</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s"> </span><span class="si">{</span><span class="n">header</span><span class="si">}</span><span class="s"> </span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=</span><span class="sh">"</span> <span class="o">*</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">api_type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="nf">run_chat_completions</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">user_task</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">api_type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="nf">run_responses</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">user_task</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">api_type must be </span><span class="sh">'</span><span class="s">completions</span><span class="sh">'</span><span class="s"> or </span><span class="sh">'</span><span class="s">responses</span><span class="sh">'"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">--- OUTPUT ---</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">out</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">(empty)</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">--- ERROR ---</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="nc">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Run 8 combinations: 2 models × 2 APIs × 2 tools JSON styles.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--task</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_TASK</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--models</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--apis</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="c1"># tools_variant를 "both"로 두면 각 API에서 chat/​responses 두 가지 툴 JSON 모두 시도 → 8조합
</span>    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--tools</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="nf">parse_args</span><span class="p">()</span>

    <span class="c1"># 샘플 폴더 생성 안내
</span>    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="sh">"</span><span class="s">./samples</span><span class="sh">"</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">model_keys</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">models</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">models</span><span class="p">]</span>
    <span class="n">api_types</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">apis</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">apis</span><span class="p">]</span>
    <span class="n">tool_variants</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">tools</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">tools</span><span class="p">]</span>

    <span class="c1"># 8조합: 2모델 × 2API × 2JSON
</span>    <span class="k">for</span> <span class="n">mk</span> <span class="ow">in</span> <span class="n">model_keys</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">api</span> <span class="ow">in</span> <span class="n">api_types</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tv</span> <span class="ow">in</span> <span class="n">tool_variants</span><span class="p">:</span>
                <span class="nf">run_one</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="n">mk</span><span class="p">,</span> <span class="n">tv</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">task</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="nf">main</span><span class="p">()</span>
</code></pre></div></div>

<p>실행 예시<br />
python test_8combos_tools.py<br />
python test_8combos_tools.py –apis completions –tools both<br />
python test_8combos_tools.py –models A –apis responses –tools responses</p>

<p>포인트 요약</p>

<ol>
  <li>
    <p>CHAT_STYLE_TOOLS와 RESPONSES_STYLE_TOOLS를 분리해 두었고, Responses 루프는 네가 붙여준 예시처럼 input_list에 function_call과 function_call_output을 누적하는 방식으로 구현했어. 일부 문서/예시에선 strict를 켜 JSON 스키마를 강제하니 필요하면 해당 키를 켜면 돼. <a href="https://platform.openai.com/docs/guides/function-calling?utm_source=chatgpt.com">OpenAI 플랫폼+1</a></p>
  </li>
  <li>
    <p>일부 조합은 의도적으로 호환되지 않아 에러가 날 수 있어(예: Chat Completions에 Responses 스타일 tools). 모든 run은 try/except로 감싸 실패해도 나머지가 이어진다.</p>
  </li>
  <li>
    <p>최신 차이점과 권장 흐름은 Responses vs Chat Completions 가이드에서 비교 가능해. <a href="https://platform.openai.com/docs/guides/responses-vs-chat-completions?utm_source=chatgpt.com">OpenAI 플랫폼</a></p>
  </li>
</ol>

<p>더 엄격하게 Responses의 “response_id + tool_outputs” 방식으로 이어붙이는 버전도 원하면 따로 추가해줄게.</p>

<p class="chat--user">

개선 필요 사항 1. responses api에서도 여러 번 콜을 하고 각 대화를 다 출력하고 싶어. 2. 입력 전체를 그냥 json으로 출력하고, 출력 전체도 그냥 json으로 다 저장해줘. 단, 콘솔 출력 색깔 지정을 통해서 (1) 입력 (2) 툴 요청 (3) 출력 이 구분되면 좋겠어. 3. 추가적으로 json formatting (structured json)도 추가해줘. structured json이 있는 버젼과 없는 버젼 각각 추가해주면 좋겠어. 총 16가지 조합이 될 거야. 각 api에 대한 structured formatting 예시는 아래 코드를 참고해 chat completions 
<code class="language-plaintext highlighter-rouge">
from pydantic import BaseModel
from openai import OpenAI

client = OpenAI()

class CalendarEvent(BaseModel):
    name: str
    date: str
    participants: list[str]

completion = client.chat.completions.parse(
    model="gpt-4o-2024-08-06",
    messages=[
        {"role": "system", "content": "Extract the event information."},
        {"role": "user", "content": "Alice and Bob are going to a science fair on Friday."},
    ],
    response_format=CalendarEvent,
)

event = completion.choices[0].message.parsed
</code>

responses 
<code class="language-plaintext highlighter-rouge">
from openai import OpenAI
from pydantic import BaseModel

client = OpenAI()

class CalendarEvent(BaseModel):
    name: str
    date: str
    participants: list[str]

response = client.responses.parse(
    model="gpt-4o-2024-08-06",
    input=[
        {"role": "system", "content": "Extract the event information."},
        {
            "role": "user",
            "content": "Alice and Bob are going to a science fair on Friday.",
        },
    ],
    text_format=CalendarEvent,
)

event = response.output_parsed
</code>

</p>

<p>좋아, 요구사항(2모델 × 2 API 타입 × 2 Tools JSON 스타일 × 2 Structured 포맷 유무 = 16조합)을 모두 만족하는 단일 실행 스크립트를 준비했어. 다음을 보장해.</p>

<ol>
  <li>
    <p>Responses API에서 여러 번 호출(툴 호출 발생 시 루프)하며, 매 스텝의 대화 전개를 콘솔에 모두 출력.</p>
  </li>
  <li>
    <p>각 조합마다 “입력 전체”와 “출력 전체”를 JSON으로 파일로 저장. 콘솔에선 색상으로 (입력 / 툴요청 / 출력) 구분.</p>
  </li>
  <li>
    <p>Structured JSON 파싱 버전과 일반 버전 각각 제공.</p>
  </li>
  <li>
    <p>에러는 조합별로 try/except로 고립 처리하여, 실패해도 나머지 조합 계속 실행.</p>
  </li>
</ol>

<p>아래 코드를 test_16combos.py로 저장해서 실행해. samples 폴더에 텍스트 파일 몇 개 두면 툴 동작을 쉽게 확인할 수 있어.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># test_16combos.py
# Python 3.10+
# pip install --upgrade openai pydantic
</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="n">argparse</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>

<span class="c1"># =========================
# ANSI 색상 유틸
# =========================
</span><span class="n">RESET</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[0m</span><span class="sh">"</span>
<span class="n">CYAN</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[36m</span><span class="sh">"</span>      <span class="c1"># 입력
</span><span class="n">YELLOW</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[33m</span><span class="sh">"</span>    <span class="c1"># 툴 요청/툴 출력
</span><span class="n">GREEN</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[32m</span><span class="sh">"</span>     <span class="c1"># 모델 출력
</span><span class="n">RED</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[31m</span><span class="sh">"</span>       <span class="c1"># 에러
</span>
<span class="c1"># =========================
# 모델/엔드포인트/키 설정
# =========================
</span><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ModelConfig</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span>

<span class="n">MODELS</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ModelConfig</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">MODEL_A_NAME</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-4.1-mini</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL_A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY_A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_MODEL_A</span><span class="sh">"</span><span class="p">),</span>
    <span class="p">),</span>
    <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">MODEL_B_NAME</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL_B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY_B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_MODEL_B</span><span class="sh">"</span><span class="p">),</span>
    <span class="p">),</span>
<span class="p">}</span>

<span class="c1"># =========================
# 로컬 툴 구현
# =========================
</span><span class="k">def</span> <span class="nf">list_files_in_folder</span><span class="p">(</span><span class="n">folder_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">sorted</span><span class="p">([</span>
            <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="nf">listdir</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
        <span class="p">])</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>

<span class="k">def</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">return</span> <span class="sh">""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="sh">""</span>

<span class="k">def</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="nf">list_files_in_folder</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))}</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))}</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="c1"># =========================
# Tools JSON 2가지 스타일
# =========================
# Chat Completions 스타일 (function 필드 중첩)
</span><span class="n">CHAT_STYLE_TOOLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative file path.</span><span class="sh">"</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">]</span>

<span class="c1"># Responses 스타일 (평평한 형태; 일부 예시 포맷)
</span><span class="n">RESPONSES_STYLE_TOOLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="c1"># "strict": True  # 필요 시 활성화
</span>    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative file path.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="c1"># "strict": True
</span>    <span class="p">},</span>
<span class="p">]</span>

<span class="c1"># =========================
# Structured JSON 포맷용 Pydantic
# =========================
</span><span class="k">class</span> <span class="nc">FileTaskResult</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">files</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">chosen_file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">summary</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>

<span class="c1"># =========================
# 공통: 출력/저장 헬퍼
# =========================
</span><span class="k">def</span> <span class="nf">ensure_dirs</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">write_json</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
    <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">label_for</span><span class="p">(</span><span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">structured</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="n">api_type</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="n">tools_variant</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="sh">'</span><span class="s">structured</span><span class="sh">'</span> <span class="k">if</span> <span class="n">structured</span> <span class="k">else</span> <span class="sh">'</span><span class="s">plain</span><span class="sh">'</span><span class="si">}</span><span class="sh">"</span>

<span class="k">def</span> <span class="nf">print_section</span><span class="p">(</span><span class="n">title</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">color</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">color</span> <span class="o">+</span> <span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">[</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s">]</span><span class="sh">"</span> <span class="o">+</span> <span class="n">RESET</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">now_id</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">time</span><span class="p">.</span><span class="nf">strftime</span><span class="p">(</span><span class="sh">"</span><span class="s">%Y%m%d-%H%M%S</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># =========================
# Chat Completions 러너 (plain/structured)
# =========================
</span><span class="k">def</span> <span class="nf">run_chat</span><span class="p">(</span>
    <span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span>
    <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">structured</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">run_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="n">CHAT_STYLE_TOOLS</span> <span class="k">if</span> <span class="n">tools_variant</span> <span class="o">==</span> <span class="sh">"</span><span class="s">chat</span><span class="sh">"</span> <span class="k">else</span> <span class="n">RESPONSES_STYLE_TOOLS</span>

    <span class="c1"># 대화 시작
</span>    <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_task</span><span class="p">},</span>
    <span class="p">]</span>

    <span class="c1"># 입력/출력 전체 저장을 위한 구조
</span>    <span class="n">input_snapshot</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">.</span><span class="nf">copy</span><span class="p">(),</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools</span><span class="p">}</span>
    <span class="n">responses_dump</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">입력(Chat Completions)</span><span class="sh">"</span><span class="p">,</span> <span class="n">CYAN</span><span class="p">,</span> <span class="n">input_snapshot</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">structured</span><span class="p">:</span>
        <span class="c1"># structured: parse() 사용
</span>        <span class="n">completion</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
            <span class="n">response_format</span><span class="o">=</span><span class="n">FileTaskResult</span><span class="p">,</span>
            <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">completion</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">completion</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

        <span class="c1"># function calling 루프 (parse 결과에서도 tool_calls 접근 가능하도록 시도)
</span>        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="n">fn_name</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">툴 요청(Chat Completions)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_args</span><span class="p">})</span>
                <span class="n">tool_output</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>
                <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">tool_output</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                <span class="p">})</span>

            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">]})</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

            <span class="n">completion</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
                <span class="n">response_format</span><span class="o">=</span><span class="n">FileTaskResult</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">completion</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">completion</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

        <span class="c1"># 최종 구조화 결과
</span>        <span class="n">parsed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FileTaskResult</span><span class="p">]</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">parsed</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">out_to_print</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span><span class="p">,</span> <span class="sh">"</span><span class="s">parsed</span><span class="sh">"</span><span class="p">:</span> <span class="n">parsed</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">if</span> <span class="n">parsed</span> <span class="k">else</span> <span class="bp">None</span><span class="p">}</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">출력(Chat Completions, structured)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">out_to_print</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># plain: create() 사용
</span>        <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span> <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span>
        <span class="p">)</span>
        <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">resp</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="n">fn_name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">툴 요청(Chat Completions)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_args</span><span class="p">})</span>
                <span class="n">tool_output</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>
                <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">tool_output</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                <span class="p">})</span>

            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">]})</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

            <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">)</span>
            <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">resp</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">출력(Chat Completions, plain)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span><span class="p">})</span>

    <span class="c1"># 파일 저장
</span>    <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">input.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">input_snapshot</span><span class="p">)</span>
    <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">outputs.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">responses_dump</span><span class="p">)</span>

<span class="c1"># =========================
# Responses 러너 (plain/structured)
# - 여러 번 호출하며 매 스텝 출력
# =========================
</span><span class="k">def</span> <span class="nf">_collect_function_calls_from_output</span><span class="p">(</span><span class="n">output</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="n">calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="n">itype</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">itype</span> <span class="o">==</span> <span class="sh">"</span><span class="s">function_call</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{}})</span>

        <span class="k">if</span> <span class="n">itype</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">inner</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inner</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">inner</span><span class="p">:</span>
                    <span class="n">nm</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                            <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">nm</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{}})</span>
    <span class="k">return</span> <span class="n">calls</span>

<span class="k">def</span> <span class="nf">_collect_text_from_output</span><span class="p">(</span><span class="n">output</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]:</span>
                <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                    <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
    <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">texts</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">run_responses</span><span class="p">(</span>
    <span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span>
    <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">structured</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">run_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="n">RESPONSES_STYLE_TOOLS</span> <span class="k">if</span> <span class="n">tools_variant</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span> <span class="k">else</span> <span class="n">CHAT_STYLE_TOOLS</span>

    <span class="n">input_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_task</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="n">input_snapshot</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="n">input_list</span><span class="p">.</span><span class="nf">copy</span><span class="p">(),</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools</span><span class="p">}</span>
    <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">입력(Responses)</span><span class="sh">"</span><span class="p">,</span> <span class="n">CYAN</span><span class="p">,</span> <span class="n">input_snapshot</span><span class="p">)</span>

    <span class="n">responses_dump</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">structured</span><span class="p">:</span>
        <span class="c1"># structured: responses.parse(text_format=...)
</span>        <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
            <span class="n">text_format</span><span class="o">=</span><span class="n">FileTaskResult</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">출력(Responses step 1)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

        <span class="c1"># 툴 호출 탐지 → 실행 → function_call_output 추가 → 이어서 또 parse
</span>        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="bp">True</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">calls</span> <span class="o">=</span> <span class="nf">_collect_function_calls_from_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
                <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">툴 요청(Responses)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">]})</span>
                <span class="n">result</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
                <span class="n">input_list</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function_call_output</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">],</span>
                    <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                <span class="p">})</span>

            <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
                <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
                <span class="n">text_format</span><span class="o">=</span><span class="n">FileTaskResult</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">출력(Responses next)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

        <span class="c1"># 최종 파싱 결과
</span>        <span class="n">parsed</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output_parsed</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">출력 요약(Responses structured)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">parsed</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">if</span> <span class="n">parsed</span> <span class="k">else</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># plain: responses.create()
</span>        <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
            <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">출력(Responses step 1)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="bp">True</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">calls</span> <span class="o">=</span> <span class="nf">_collect_function_calls_from_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="n">tool_outputs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
                <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">툴 요청(Responses)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">]})</span>
                <span class="n">result</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
                <span class="c1"># function_call_output을 input에 누적
</span>                <span class="n">input_list</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function_call_output</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">],</span>
                    <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                <span class="p">})</span>

            <span class="c1"># 다음 턴
</span>            <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
                <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">출력(Responses next)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

        <span class="n">final_text</span> <span class="o">=</span> <span class="nf">_collect_text_from_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">출력 요약(Responses plain)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">final_text</span><span class="p">})</span>

    <span class="c1"># 파일 저장
</span>    <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">input.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">input_snapshot</span><span class="p">)</span>
    <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">outputs.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">responses_dump</span><span class="p">)</span>

<span class="c1"># =========================
# 16개 조합 실행기
#   2 모델 × 2 API × 2 Tools JSON × 2 Structured
# =========================
</span><span class="n">DEFAULT_TASK</span> <span class="o">=</span> <span class="p">(</span>
    <span class="sh">"</span><span class="s">테스트: ./samples 폴더의 파일 목록을 보여주고, 텍스트 파일이 있으면 하나를 골라 내용을 읽고 2~3문장으로 요약해줘. 필요하면 툴을 사용해.</span><span class="sh">"</span>
<span class="p">)</span>

<span class="k">def</span> <span class="nf">run_one</span><span class="p">(</span>
    <span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">api_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">structured</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">base_runs_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">MODELS</span><span class="p">[</span><span class="n">model_key</span><span class="p">]</span>
    <span class="n">combo_label</span> <span class="o">=</span> <span class="nf">label_for</span><span class="p">(</span><span class="n">model_key</span><span class="p">,</span> <span class="n">api_type</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">,</span> <span class="n">structured</span><span class="p">)</span>
    <span class="n">run_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">base_runs_dir</span><span class="p">,</span> <span class="n">combo_label</span><span class="p">)</span>
    <span class="nf">ensure_dirs</span><span class="p">(</span><span class="n">run_dir</span><span class="p">)</span>

    <span class="n">header</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[</span><span class="si">{</span><span class="n">api_type</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span><span class="si">}</span><span class="s">] model=</span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s"> tools=</span><span class="si">{</span><span class="n">tools_variant</span><span class="si">}</span><span class="s"> structured=</span><span class="si">{</span><span class="sh">'</span><span class="s">on</span><span class="sh">'</span> <span class="k">if</span> <span class="n">structured</span> <span class="k">else</span> <span class="sh">'</span><span class="s">off</span><span class="sh">'</span><span class="si">}</span><span class="sh">"</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="sh">"</span><span class="s">=</span><span class="sh">"</span> <span class="o">*</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s"> </span><span class="si">{</span><span class="n">header</span><span class="si">}</span><span class="s"> </span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=</span><span class="sh">"</span> <span class="o">*</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">api_type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">:</span>
            <span class="nf">run_chat</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">,</span> <span class="n">structured</span><span class="p">,</span> <span class="n">user_task</span><span class="p">,</span> <span class="n">run_dir</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">api_type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">:</span>
            <span class="nf">run_responses</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">,</span> <span class="n">structured</span><span class="p">,</span> <span class="n">user_task</span><span class="p">,</span> <span class="n">run_dir</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">api_type must be </span><span class="sh">'</span><span class="s">completions</span><span class="sh">'</span><span class="s"> or </span><span class="sh">'</span><span class="s">responses</span><span class="sh">'"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">RED</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="s">--- ERROR ---</span><span class="sh">"</span> <span class="o">+</span> <span class="n">RESET</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="c1"># 에러만 출력하고 계속
</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="nc">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Run 16 combos: 2 models × 2 APIs × 2 Tools JSON × 2 Structured.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--task</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_TASK</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--models</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--apis</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--tools</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--structured</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">on</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">off</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--runs_dir</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="s">./runs/</span><span class="si">{</span><span class="nf">now_id</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="nf">parse_args</span><span class="p">()</span>

    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="sh">"</span><span class="s">./samples</span><span class="sh">"</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nf">ensure_dirs</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">runs_dir</span><span class="p">)</span>

    <span class="n">model_keys</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">models</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">models</span><span class="p">]</span>
    <span class="n">api_types</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">apis</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">apis</span><span class="p">]</span>
    <span class="n">tool_variants</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">tools</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">tools</span><span class="p">]</span>
    <span class="n">structured_opts</span> <span class="o">=</span> <span class="p">[</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">structured</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">structured</span> <span class="o">==</span> <span class="sh">"</span><span class="s">on</span><span class="sh">"</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">mk</span> <span class="ow">in</span> <span class="n">model_keys</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">api</span> <span class="ow">in</span> <span class="n">api_types</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tv</span> <span class="ow">in</span> <span class="n">tool_variants</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">structured_opts</span><span class="p">:</span>
                    <span class="nf">run_one</span><span class="p">(</span><span class="n">mk</span><span class="p">,</span> <span class="n">api</span><span class="p">,</span> <span class="n">tv</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">task</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">runs_dir</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="nf">main</span><span class="p">()</span>
</code></pre></div></div>

<p>사용법 요약</p>

<ol>
  <li>환경 변수 설정(예시)</li>
</ol>

<ul>
  <li>
    <p>모델 A:<br />
OPENAI_API_KEY_A, OPENAI_BASE_URL_A=https://api.openai.com/v1, MODEL_A_NAME</p>
  </li>
  <li>
    <p>모델 B:<br />
OPENAI_API_KEY_B, OPENAI_BASE_URL_B=https://api.openai.com/v1, MODEL_B_NAME</p>
  </li>
</ul>

<ol>
  <li>
    <p>샘플 준비<br />
프로젝트 루트에 samples 폴더를 만들고 텍스트 파일을 1개 이상 넣어둔다.</p>
  </li>
  <li>
    <p>실행 예시</p>
  </li>
</ol>

<ul>
  <li>
    <p>16개 전체 조합 실행<br />
python test_16combos.py</p>
  </li>
  <li>
    <p>Responses만, structured/plain 둘 다, tools는 responses 스타일만<br />
python test_16combos.py –apis responses –tools responses –structured both</p>
  </li>
  <li>
    <p>모델 A만, Chat Completions만, structured만<br />
python test_16combos.py –models A –apis completions –structured on</p>
  </li>
</ul>

<p>동작 정리</p>

<ul>
  <li>
    <p>콘솔 색상으로 입력(청록), 툴 요청(노랑), 출력(초록)을 구분.</p>
  </li>
  <li>
    <p>각 조합은 runs/타임스탬프/모델_API_tools_structured/ 아래에 input.json, outputs.json 저장.</p>
  </li>
  <li>
    <p>Responses API는 툴 호출이 계속 나오면 루프를 반복하고 매 스텝 출력 및 누적 저장.</p>
  </li>
  <li>
    <p>Structured 모드에선 chat.completions.parse / responses.parse를 사용해 Pydantic 모델(FileTaskResult)로 결과를 파싱해 별도 요약도 콘솔에 표시.</p>
  </li>
</ul>

<p>원하는 추가 포맷(예: 파일명 규칙, 더 자세한 로깅, strict 옵션 상시 on 등)이 있으면 알려줘.</p>

<p class="chat--user">

출력 json 포맷은 task에서 요청한 걸 대답할 수 있게 해주면 좋을 것 같아. 예를 들어 filename: 파일명 contents: 내용 

</p>

<p>좋아! “결과 JSON 포맷을 task에 바로 쓰이게(filename, contents)”로 맞춘 버전을 아래처럼 업데이트했어. 핵심은 structured 모드에서 파싱 모델을 <code class="language-plaintext highlighter-rouge">{"filename": str, "contents": str}</code>로 고정하고, 모델에게 “contents에는 요약을 넣어라”라고 지시하는 것. plain 모드에서는 기존 그대로 자유 텍스트를 출력하고 전체 원시 JSON 로그만 저장하며, structured 모드에서는 추가로 <code class="language-plaintext highlighter-rouge">result.json</code>에 <code class="language-plaintext highlighter-rouge">{"filename","contents"}</code>를 저장해.</p>

<p>아래 스크립트는 이전 16조합 실행기(test_16combos.py)를 대체하는 완전판이야. 바뀐 점만 빠르게 요약하고 바로 코드 줄게.</p>

<p>변경 요약</p>

<ol>
  <li>Structured 파싱 모델 교체</li>
</ol>

<ul>
  <li>
    <p>Pydantic 모델을 <code class="language-plaintext highlighter-rouge">TaskAnswer</code>로 정의하고 필드를 filename, contents 두 개로 통일.</p>
  </li>
  <li>
    <p>contents는 “읽은 파일의 2~3문장 요약”을 넣도록 system/instructions에 명확히 지시.</p>
  </li>
</ul>

<ol>
  <li>Structured 모드에서 결과 JSON 저장</li>
</ol>

<ul>
  <li>
    <p>각 조합 폴더에 <code class="language-plaintext highlighter-rouge">result.json</code>으로 <code class="language-plaintext highlighter-rouge">{"filename","contents"}</code> 저장.</p>
  </li>
  <li>
    <p>기존처럼 <code class="language-plaintext highlighter-rouge">input.json</code>, <code class="language-plaintext highlighter-rouge">outputs.json</code>도 계속 저장.</p>
  </li>
</ul>

<ol>
  <li>콘솔 색상 출력은 동일하게 유지</li>
</ol>

<ul>
  <li>입력(CYAN), 툴 요청(YELLOW), 출력(GREEN)으로 구분.</li>
</ul>

<ol>
  <li>Responses API는 다단 호출 유지</li>
</ol>

<ul>
  <li>각 step의 출력과 툴 요청을 모두 콘솔에 표시하고, outputs.json에 누적 저장.</li>
</ul>

<p>코드</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># test_16combos_v2.py
# Python 3.10+
# pip install --upgrade openai pydantic
</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="n">argparse</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>

<span class="c1"># ===== ANSI 색상 =====
</span><span class="n">RESET</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[0m</span><span class="sh">"</span>
<span class="n">CYAN</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[36m</span><span class="sh">"</span>      <span class="c1"># 입력
</span><span class="n">YELLOW</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[33m</span><span class="sh">"</span>    <span class="c1"># 툴 요청/툴 출력
</span><span class="n">GREEN</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[32m</span><span class="sh">"</span>     <span class="c1"># 모델 출력
</span><span class="n">RED</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[31m</span><span class="sh">"</span>       <span class="c1"># 에러
</span>
<span class="c1"># ===== 모델 설정 =====
</span><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ModelConfig</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span>

<span class="n">MODELS</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ModelConfig</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">MODEL_A_NAME</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-4.1-mini</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL_A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY_A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_MODEL_A</span><span class="sh">"</span><span class="p">),</span>
    <span class="p">),</span>
    <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">MODEL_B_NAME</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL_B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY_B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_MODEL_B</span><span class="sh">"</span><span class="p">),</span>
    <span class="p">),</span>
<span class="p">}</span>

<span class="c1"># ===== 로컬 툴 구현 =====
</span><span class="k">def</span> <span class="nf">list_files_in_folder</span><span class="p">(</span><span class="n">folder_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">sorted</span><span class="p">([</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="nf">listdir</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">f</span><span class="p">))])</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>

<span class="k">def</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">return</span> <span class="sh">""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="sh">""</span>

<span class="k">def</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="nf">list_files_in_folder</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))}</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))}</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="c1"># ===== Tools JSON 2가지 =====
</span><span class="n">CHAT_STYLE_TOOLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative file path.</span><span class="sh">"</span><span class="p">}},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">]</span>

<span class="n">RESPONSES_STYLE_TOOLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative file path.</span><span class="sh">"</span><span class="p">}},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">]</span>

<span class="c1"># ===== Structured JSON 스키마 =====
</span><span class="k">class</span> <span class="nc">TaskAnswer</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">contents</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># 선택된 파일의 2~3문장 요약(모델이 생성)
</span>
<span class="c1"># ===== 유틸 =====
</span><span class="k">def</span> <span class="nf">ensure_dirs</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span> <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">write_json</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
    <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">now_id</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span> <span class="k">return</span> <span class="n">time</span><span class="p">.</span><span class="nf">strftime</span><span class="p">(</span><span class="sh">"</span><span class="s">%Y%m%d-%H%M%S</span><span class="sh">"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">print_section</span><span class="p">(</span><span class="n">title</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">color</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">color</span> <span class="o">+</span> <span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">[</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s">]</span><span class="sh">"</span> <span class="o">+</span> <span class="n">RESET</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">combo_label</span><span class="p">(</span><span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">structured</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="n">api_type</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="n">tools_variant</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="sh">'</span><span class="s">structured</span><span class="sh">'</span> <span class="k">if</span> <span class="n">structured</span> <span class="k">else</span> <span class="sh">'</span><span class="s">plain</span><span class="sh">'</span><span class="si">}</span><span class="sh">"</span>

<span class="c1"># ===== Chat Completions 러너 =====
</span><span class="k">def</span> <span class="nf">run_chat</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">structured</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">run_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="n">CHAT_STYLE_TOOLS</span> <span class="k">if</span> <span class="n">tools_variant</span> <span class="o">==</span> <span class="sh">"</span><span class="s">chat</span><span class="sh">"</span> <span class="k">else</span> <span class="n">RESPONSES_STYLE_TOOLS</span>

    <span class="n">system_msg</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed. </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">Task: Show files under ./samples, pick one text file, read it, and provide a 2-3 sentence summary. </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">If using structured output, respond ONLY with JSON having keys: filename, contents.</span><span class="sh">"</span>
    <span class="p">)</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">system_msg</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_task</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="n">input_snapshot</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">.</span><span class="nf">copy</span><span class="p">(),</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools</span><span class="p">}</span>
    <span class="n">responses_dump</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">입력(Chat Completions)</span><span class="sh">"</span><span class="p">,</span> <span class="n">CYAN</span><span class="p">,</span> <span class="n">input_snapshot</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">structured</span><span class="p">:</span>
        <span class="n">completion</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
            <span class="n">response_format</span><span class="o">=</span><span class="n">TaskAnswer</span><span class="p">,</span>
            <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">completion</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">completion</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="n">fn_name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">툴 요청(Chat)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_args</span><span class="p">})</span>
                <span class="n">tool_output</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>
                <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span>
                                  <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">tool_output</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)})</span>

            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span>
                             <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">]})</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

            <span class="n">completion</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
                <span class="n">response_format</span><span class="o">=</span><span class="n">TaskAnswer</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">completion</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">completion</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

        <span class="n">parsed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TaskAnswer</span><span class="p">]</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">parsed</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">out_obj</span> <span class="o">=</span> <span class="n">parsed</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">if</span> <span class="n">parsed</span> <span class="k">else</span> <span class="p">{</span><span class="sh">"</span><span class="s">filename</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">contents</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">}</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">출력(Chat structured)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">out_obj</span><span class="p">)</span>
        <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">result.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">out_obj</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span> <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span>
        <span class="p">)</span>
        <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">resp</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="n">fn_name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">툴 요청(Chat)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_args</span><span class="p">})</span>
                <span class="n">tool_output</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>
                <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span>
                                  <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">tool_output</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)})</span>

            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span>
                             <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">]})</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

            <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">)</span>
            <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">resp</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">출력(Chat plain)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span><span class="p">})</span>

    <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">input.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">input_snapshot</span><span class="p">)</span>
    <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">outputs.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">responses_dump</span><span class="p">)</span>

<span class="c1"># ===== Responses 러너 =====
</span><span class="k">def</span> <span class="nf">_collect_function_calls</span><span class="p">(</span><span class="n">output</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="n">calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="n">itype</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">itype</span> <span class="o">==</span> <span class="sh">"</span><span class="s">function_call</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span> <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{}})</span>
        <span class="k">if</span> <span class="n">itype</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">inner</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inner</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">inner</span><span class="p">:</span>
                    <span class="n">nm</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span> <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">nm</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{}})</span>
    <span class="k">return</span> <span class="n">calls</span>

<span class="k">def</span> <span class="nf">_collect_text</span><span class="p">(</span><span class="n">output</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]:</span>
                <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                    <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
    <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">texts</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">run_responses</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">structured</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">run_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="n">RESPONSES_STYLE_TOOLS</span> <span class="k">if</span> <span class="n">tools_variant</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span> <span class="k">else</span> <span class="n">CHAT_STYLE_TOOLS</span>

    <span class="n">system_inst</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed. </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">Task: Show files under ./samples, pick one text file, read it, and provide a 2-3 sentence summary. </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">If structured parsing is enabled, respond ONLY with JSON having keys: filename, contents.</span><span class="sh">"</span>
    <span class="p">)</span>
    <span class="n">input_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">system_inst</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_task</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="n">input_snapshot</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="n">input_list</span><span class="p">.</span><span class="nf">copy</span><span class="p">(),</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools</span><span class="p">}</span>
    <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">입력(Responses)</span><span class="sh">"</span><span class="p">,</span> <span class="n">CYAN</span><span class="p">,</span> <span class="n">input_snapshot</span><span class="p">)</span>

    <span class="n">responses_dump</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">structured</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
            <span class="n">text_format</span><span class="o">=</span><span class="n">TaskAnswer</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">출력(Responses step 1)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">calls</span> <span class="o">=</span> <span class="nf">_collect_function_calls</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
                <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">툴 요청(Responses)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">]})</span>
                <span class="n">result</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
                <span class="n">input_list</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function_call_output</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">],</span>
                    <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                <span class="p">})</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span> <span class="n">text_format</span><span class="o">=</span><span class="n">TaskAnswer</span><span class="p">)</span>
            <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">출력(Responses next)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

        <span class="n">parsed</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output_parsed</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">out_obj</span> <span class="o">=</span> <span class="n">parsed</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">if</span> <span class="n">parsed</span> <span class="k">else</span> <span class="p">{</span><span class="sh">"</span><span class="s">filename</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">contents</span><span class="sh">"</span><span class="p">:</span> <span class="nf">_collect_text</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))}</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">출력 요약(Responses structured)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">out_obj</span><span class="p">)</span>
        <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">result.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">out_obj</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span> <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">출력(Responses step 1)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">calls</span> <span class="o">=</span> <span class="nf">_collect_function_calls</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
                <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">툴 요청(Responses)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">]})</span>
                <span class="n">result</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
                <span class="n">input_list</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function_call_output</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">],</span>
                    <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                <span class="p">})</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">)</span>
            <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">출력(Responses next)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

        <span class="n">final_text</span> <span class="o">=</span> <span class="nf">_collect_text</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">출력 요약(Responses plain)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">final_text</span><span class="p">})</span>

    <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">input.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">input_snapshot</span><span class="p">)</span>
    <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">outputs.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">responses_dump</span><span class="p">)</span>

<span class="c1"># ===== 16개 조합 실행기 =====
</span><span class="n">DEFAULT_TASK</span> <span class="o">=</span> <span class="p">(</span>
    <span class="sh">"</span><span class="s">테스트: ./samples 폴더의 파일 목록을 보여주고, 텍스트 파일이 있으면 하나를 골라 내용을 읽고 2~3문장으로 요약해줘. 필요하면 툴을 사용해.</span><span class="sh">"</span>
<span class="p">)</span>

<span class="k">def</span> <span class="nf">run_one</span><span class="p">(</span><span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">structured</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">base_runs_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">MODELS</span><span class="p">[</span><span class="n">model_key</span><span class="p">]</span>
    <span class="n">label</span> <span class="o">=</span> <span class="nf">combo_label</span><span class="p">(</span><span class="n">model_key</span><span class="p">,</span> <span class="n">api_type</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">,</span> <span class="n">structured</span><span class="p">)</span>
    <span class="n">run_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">base_runs_dir</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
    <span class="nf">ensure_dirs</span><span class="p">(</span><span class="n">run_dir</span><span class="p">)</span>

    <span class="n">header</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[</span><span class="si">{</span><span class="n">api_type</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span><span class="si">}</span><span class="s">] model=</span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s"> tools=</span><span class="si">{</span><span class="n">tools_variant</span><span class="si">}</span><span class="s"> structured=</span><span class="si">{</span><span class="sh">'</span><span class="s">on</span><span class="sh">'</span> <span class="k">if</span> <span class="n">structured</span> <span class="k">else</span> <span class="sh">'</span><span class="s">off</span><span class="sh">'</span><span class="si">}</span><span class="sh">"</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="sh">"</span><span class="s">=</span><span class="sh">"</span> <span class="o">*</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s"> </span><span class="si">{</span><span class="n">header</span><span class="si">}</span><span class="s"> </span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=</span><span class="sh">"</span> <span class="o">*</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">api_type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">:</span>
            <span class="nf">run_chat</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">,</span> <span class="n">structured</span><span class="p">,</span> <span class="n">user_task</span><span class="p">,</span> <span class="n">run_dir</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">api_type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">:</span>
            <span class="nf">run_responses</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">,</span> <span class="n">structured</span><span class="p">,</span> <span class="n">user_task</span><span class="p">,</span> <span class="n">run_dir</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">api_type must be </span><span class="sh">'</span><span class="s">completions</span><span class="sh">'</span><span class="s"> or </span><span class="sh">'</span><span class="s">responses</span><span class="sh">'"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">RED</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="s">--- ERROR ---</span><span class="sh">"</span> <span class="o">+</span> <span class="n">RESET</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>  <span class="c1"># 에러만 출력하고 계속
</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="nc">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Run 16 combos with JSON result format {filename, contents}.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--task</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_TASK</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--models</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--apis</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--tools</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--structured</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">on</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">off</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--runs_dir</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="s">./runs/</span><span class="si">{</span><span class="nf">now_id</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="nf">parse_args</span><span class="p">()</span>

    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="sh">"</span><span class="s">./samples</span><span class="sh">"</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nf">ensure_dirs</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">runs_dir</span><span class="p">)</span>

    <span class="n">model_keys</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">models</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">models</span><span class="p">]</span>
    <span class="n">api_types</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">apis</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">apis</span><span class="p">]</span>
    <span class="n">tool_variants</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">tools</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">tools</span><span class="p">]</span>
    <span class="n">structured_opts</span> <span class="o">=</span> <span class="p">[</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">structured</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">structured</span> <span class="o">==</span> <span class="sh">"</span><span class="s">on</span><span class="sh">"</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">mk</span> <span class="ow">in</span> <span class="n">model_keys</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">api</span> <span class="ow">in</span> <span class="n">api_types</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tv</span> <span class="ow">in</span> <span class="n">tool_variants</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">structured_opts</span><span class="p">:</span>
                    <span class="nf">run_one</span><span class="p">(</span><span class="n">mk</span><span class="p">,</span> <span class="n">api</span><span class="p">,</span> <span class="n">tv</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">task</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">runs_dir</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="nf">main</span><span class="p">()</span>
</code></pre></div></div>

<p>사용 포인트</p>

<ul>
  <li>
    <p>structured 모드일 때만 <code class="language-plaintext highlighter-rouge">result.json</code>을 생성하며 내용은 반드시 <code class="language-plaintext highlighter-rouge">{"filename","contents"}</code>로 저장돼.</p>
  </li>
  <li>
    <p>contents에는 “선택한 파일의 2~3문장 요약”이 들어가도록 시스템 메시지에서 강제했어.</p>
  </li>
  <li>
    <p>plain 모드에선 자유 형식 출력이지만, 입력과 모든 원시 응답은 <code class="language-plaintext highlighter-rouge">input.json</code>, <code class="language-plaintext highlighter-rouge">outputs.json</code>로 저장돼.</p>
  </li>
  <li>
    <p>각 단계의 콘솔 출력은 색상으로 구분돼서 입력/툴요청/출력이 한눈에 보여.</p>
  </li>
</ul>

<p>원하면 contents를 “파일 전문”으로 바꾸는 옵션 스위치도 추가해줄 수 있어.</p>

<p class="chat--user">

Completions(structured)에서 ValueError list_files_in_folder is not strict. Only <code class="language-plaintext highlighter-rouge">strict</code> function tools can be auto-parsed.

</p>

<p>좋은 피드백이야. 에러 원인은 chat.completions.parse를 사용할 때 툴이 strict 모드가 아니면 자동 파싱이 불가능해서야. 즉, structured 모드에서 함수 툴 정의에 strict=True가 반드시 들어가야 해.</p>

<p>수정 방향 요약 단계별</p>

<ol>
  <li>
    <p>tools_variant와 structured 여부에 따라 툴 JSON에 strict를 주입하는 헬퍼를 만든다.</p>
  </li>
  <li>
    <p>Chat 스타일일 땐 tool["function"]["strict"]=True, Responses 스타일일 땐 tool["strict"]=True를 넣는다.</p>
  </li>
  <li>
    <p>run_chat / run_responses에서 기존 정적 TOOLS 대신 이 헬퍼로 반환된 툴을 사용한다.</p>
  </li>
</ol>

<p>아래 변경만 적용하면 돼. 나머지 로직은 그대로 둬도 동작한다.</p>

<p>추가 함수 및 변경점</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">copy</span>

<span class="k">def</span> <span class="nf">make_tools</span><span class="p">(</span><span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">structured</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    tools_variant: </span><span class="sh">'</span><span class="s">chat</span><span class="sh">'</span><span class="s"> | </span><span class="sh">'</span><span class="s">responses</span><span class="sh">'</span><span class="s">
    structured가 True면 strict 플래그를 주입한다.
    </span><span class="sh">"""</span>
    <span class="n">base</span> <span class="o">=</span> <span class="n">CHAT_STYLE_TOOLS</span> <span class="k">if</span> <span class="n">tools_variant</span> <span class="o">==</span> <span class="sh">"</span><span class="s">chat</span><span class="sh">"</span> <span class="k">else</span> <span class="n">RESPONSES_STYLE_TOOLS</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="n">copy</span><span class="p">.</span><span class="nf">deepcopy</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">structured</span><span class="p">:</span>
        <span class="c1"># Chat 스타일: "function" 블록 안에 strict
</span>        <span class="k">if</span> <span class="n">tools_variant</span> <span class="o">==</span> <span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">t</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span> <span class="ow">and</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
                    <span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">strict</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="c1"># Responses 스타일: 최상위에 strict
</span>        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">t</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span>
                    <span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">strict</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">return</span> <span class="n">tools</span>
</code></pre></div></div>

<p>run_chat 내부에서 툴 선택 부분 교체</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 기존
# tools = CHAT_STYLE_TOOLS if tools_variant == "chat" else RESPONSES_STYLE_TOOLS
# 변경
</span><span class="n">tools</span> <span class="o">=</span> <span class="nf">make_tools</span><span class="p">(</span><span class="n">tools_variant</span><span class="p">,</span> <span class="n">structured</span><span class="p">)</span>
</code></pre></div></div>

<p>run_responses 내부에서도 동일하게 교체</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 기존
# tools = RESPONSES_STYLE_TOOLS if tools_variant == "responses" else CHAT_STYLE_TOOLS
# 변경
</span><span class="n">tools</span> <span class="o">=</span> <span class="nf">make_tools</span><span class="p">(</span><span class="n">tools_variant</span><span class="p">,</span> <span class="n">structured</span><span class="p">)</span>
</code></pre></div></div>

<p>추가 참고</p>

<ul>
  <li>
    <p>이 변경으로 Completions(structured) 뿐만 아니라 Responses(structured)에서도 일관되게 엄격 파싱이 보장돼.</p>
  </li>
  <li>
    <p>plain 모드에선 strict가 없어도 되지만, 위 헬퍼는 structured일 때만 strict를 주입하므로 기존 동작을 해치지 않아.</p>
  </li>
  <li>
    <p>tools JSON을 동적으로 주입하므로, 새 함수만 추가하고 두 곳 호출부만 바꾸면 끝나.</p>
  </li>
</ul>

<p>이렇게 수정하면 “ValueError list_files_in_folder is not strict. Only <code class="language-plaintext highlighter-rouge">strict</code> function tools can be auto-parsed.” 에러는 사라지고 16개 조합 모두 정상적으로 순회할 수 있어.</p>

<p class="chat--user">

그래도 계속 에러가 나네. 일단 넘어가고 json scheme을 지정하는 방식은 동작을 잘 안하네 일반 json 모드를 켜보고 싶어. 총 3가지 sweep(no structured, json_mode, structured)로 실험해보자. 예시 responses 
<code class="language-plaintext highlighter-rouge">
we_did_not_specify_stop_tokens = True

try:
    response = client.responses.create(
        model="gpt-3.5-turbo-0125",
        input=[
            {"role": "system", "content": "You are a helpful assistant designed to output JSON."},
            {"role": "user", "content": "Who won the world series in 2020? Please respond in the format {winner: ...}"}
        ],
        text={"format": {"type": "json_object"}}
    )

    # Check if the conversation was too long for the context window, resulting in incomplete JSON 
    if response.status == "incomplete" and response.incomplete_details.reason == "max_output_tokens":
        # your code should handle this error case
        pass

    # Check if the OpenAI safety system refused the request and generated a refusal instead
    if response.output[0].content[0].type == "refusal":
        # your code should handle this error case
        # In this case, the .content field will contain the explanation (if any) that the model generated for why it is refusing
        print(response.output[0].content[0]["refusal"])

    # Check if the model's output included restricted content, so the generation of JSON was halted and may be partial
    if response.status == "incomplete" and response.incomplete_details.reason == "content_filter":
        # your code should handle this error case
        pass

    if response.status == "completed":
        # In this case the model has either successfully finished generating the JSON object according to your schema, or the model generated one of the tokens you provided as a "stop token"

        if we_did_not_specify_stop_tokens:
            # If you didn't specify any stop tokens, then the generation is complete and the content key will contain the serialized JSON object
            # This will parse successfully and should now contain  "{"winner": "Los Angeles Dodgers"}"
            print(response.output_text)
        else:
            # Check if the response.output_text ends with one of your stop tokens and handle appropriately
            pass
except Exception as e:
    # Your code should handle errors here, for example a network error calling the API
    print(e)
</code>

completions 
<code class="language-plaintext highlighter-rouge">
response = client.chat.completions.create(
  model="gpt-4-1106-preview",
  messages=[
    {"role": "system", "content": "You are a helpful assistant."},
    {"role": "user", "content": "LangChain은 무엇을 하는 라이브러리지? JSON으로 답해줘. JSON 키워드는 Description, Features, Usage로 해줘."}
  ],
  response_format = {'type':"json_object"}
)
</code>

</p>

<p>좋아. strict 기반의 JSON Schema 파싱은 접고, 세 모드로 스윕하도록 전체 스크립트를 업데이트했어.</p>

<p>스윕 축: 2모델 × 2 API(completions/responses) × 2 Tools JSON(chat-style/responses-style) × 3 모드(plain, json_mode, structured) = 총 24조합.</p>

<p>핵심</p>

<ul>
  <li>
    <p>plain: 자유 출력. 전체 입력/출력 원본 JSON을 저장.</p>
  </li>
  <li>
    <p>json_mode: 모델에게 “무조건 JSON”을 요구. 출력은 {"filename","contents"} 형식. 저장 시 result.json 생성.</p>

    <ul>
      <li>
        <p>Chat Completions: response_format={'type': 'json_object'}</p>
      </li>
      <li>
        <p>Responses: text={"format":{"type":"json_object"}}</p>
      </li>
    </ul>
  </li>
  <li>
    <p>structured: 이전처럼 parse 사용. 여전히 모델/SDK에 따라 strict 요구로 실패할 수도 있으니 try/except로 격리. 성공 시 result.json 생성.</p>
  </li>
  <li>
    <p>Responses API는 툴 호출이 나오면 여러 번 호출되며 매 스텝 콘솔 출력. 콘솔은 색상으로 입력(CYAN), 툴 요청(YELLOW), 출력(GREEN) 구분.</p>
  </li>
  <li>
    <p>모든 조합은 runs/타임스탬프/모델_API_tools_mode/ 폴더에 input.json, outputs.json 저장. json_mode/structured는 result.json 추가 저장.</p>
  </li>
  <li>
    <p>에러는 조합별로만 출력하고 나머지 계속 진행.</p>
  </li>
</ul>

<p>코드: test_24combos.py</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># test_24combos.py
# Python 3.10+
# pip install --upgrade openai pydantic
</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="n">copy</span>
<span class="kn">import</span> <span class="n">argparse</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>

<span class="c1"># ===== ANSI colors =====
</span><span class="n">RESET</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[0m</span><span class="sh">"</span>
<span class="n">CYAN</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[36m</span><span class="sh">"</span>      <span class="c1"># input
</span><span class="n">YELLOW</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[33m</span><span class="sh">"</span>    <span class="c1"># tool
</span><span class="n">GREEN</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[32m</span><span class="sh">"</span>     <span class="c1"># output
</span><span class="n">RED</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[31m</span><span class="sh">"</span>       <span class="c1"># error
</span>
<span class="c1"># ===== Model configs =====
</span><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ModelConfig</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span>

<span class="n">MODELS</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ModelConfig</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">MODEL_A_NAME</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-4.1-mini</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL_A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY_A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_MODEL_A</span><span class="sh">"</span><span class="p">),</span>
    <span class="p">),</span>
    <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">MODEL_B_NAME</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL_B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY_B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_MODEL_B</span><span class="sh">"</span><span class="p">),</span>
    <span class="p">),</span>
<span class="p">}</span>

<span class="c1"># ===== Local tools =====
</span><span class="k">def</span> <span class="nf">list_files_in_folder</span><span class="p">(</span><span class="n">folder_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">sorted</span><span class="p">([</span>
            <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="nf">listdir</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
        <span class="p">])</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>

<span class="k">def</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">return</span> <span class="sh">""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="sh">""</span>

<span class="k">def</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="nf">list_files_in_folder</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))}</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))}</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="c1"># ===== Tools JSON (two shapes) =====
</span><span class="n">CHAT_STYLE_TOOLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative file path.</span><span class="sh">"</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">]</span>

<span class="n">RESPONSES_STYLE_TOOLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative file path.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">]</span>

<span class="c1"># ===== Structured JSON schema (optional) =====
</span><span class="k">class</span> <span class="nc">TaskAnswer</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">contents</span><span class="p">:</span> <span class="nb">str</span>

<span class="c1"># ===== Helpers =====
</span><span class="k">def</span> <span class="nf">ensure_dirs</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span> <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">write_json</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
    <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">now_id</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span> <span class="k">return</span> <span class="n">time</span><span class="p">.</span><span class="nf">strftime</span><span class="p">(</span><span class="sh">"</span><span class="s">%Y%m%d-%H%M%S</span><span class="sh">"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">print_section</span><span class="p">(</span><span class="n">title</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">color</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">color</span> <span class="o">+</span> <span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">[</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s">]</span><span class="sh">"</span> <span class="o">+</span> <span class="n">RESET</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">combo_label</span><span class="p">(</span><span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="n">api_type</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="n">tools_variant</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="sh">"</span>

<span class="k">def</span> <span class="nf">make_tools</span><span class="p">(</span><span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">structured</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="c1"># structured에서 strict 문제를 피하기 위해 여기선 strict 주입을 끔
</span>    <span class="c1"># (structured는 parse() 사용 시 여전히 실패할 수 있으므로 try/except로 감싼다)
</span>    <span class="n">base</span> <span class="o">=</span> <span class="n">CHAT_STYLE_TOOLS</span> <span class="k">if</span> <span class="n">tools_variant</span> <span class="o">==</span> <span class="sh">"</span><span class="s">chat</span><span class="sh">"</span> <span class="k">else</span> <span class="n">RESPONSES_STYLE_TOOLS</span>
    <span class="k">return</span> <span class="n">copy</span><span class="p">.</span><span class="nf">deepcopy</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>

<span class="c1"># ===== Common parsing for Responses =====
</span><span class="k">def</span> <span class="nf">_collect_function_calls_from_output</span><span class="p">(</span><span class="n">output</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="n">calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="n">itype</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">itype</span> <span class="o">==</span> <span class="sh">"</span><span class="s">function_call</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span> <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{}})</span>
        <span class="k">if</span> <span class="n">itype</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">inner</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inner</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">inner</span><span class="p">:</span>
                    <span class="n">nm</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span> <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">nm</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{}})</span>
    <span class="k">return</span> <span class="n">calls</span>

<span class="k">def</span> <span class="nf">_collect_text_from_output</span><span class="p">(</span><span class="n">output</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]:</span>
                <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                    <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
    <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">texts</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

<span class="c1"># ===== Chat Completions runner =====
</span><span class="k">def</span> <span class="nf">run_chat</span><span class="p">(</span>
    <span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span>
    <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>  <span class="c1"># "plain" | "json_mode" | "structured"
</span>    <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">run_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="nf">make_tools</span><span class="p">(</span><span class="n">tools_variant</span><span class="p">,</span> <span class="n">structured</span><span class="o">=</span><span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">structured</span><span class="sh">"</span><span class="p">))</span>

    <span class="n">system_msg</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed. </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">Task: List files in ./samples, pick a text file, read it, and return a short 2-3 sentence summary. </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">When asked to answer in JSON, reply only with an object: {</span><span class="se">\"</span><span class="s">filename</span><span class="se">\"</span><span class="s">: string, </span><span class="se">\"</span><span class="s">contents</span><span class="se">\"</span><span class="s">: string}.</span><span class="sh">"</span>
    <span class="p">)</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">system_msg</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_task</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="n">input_snapshot</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">.</span><span class="nf">copy</span><span class="p">(),</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools</span><span class="p">,</span> <span class="sh">"</span><span class="s">mode</span><span class="sh">"</span><span class="p">:</span> <span class="n">mode</span><span class="p">}</span>
    <span class="n">outputs_dump</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">입력(Chat Completions)</span><span class="sh">"</span><span class="p">,</span> <span class="n">CYAN</span><span class="p">,</span> <span class="n">input_snapshot</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">structured</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">completion</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
                <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
                <span class="n">response_format</span><span class="o">=</span><span class="n">TaskAnswer</span><span class="p">,</span>
                <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">outputs_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">completion</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">completion</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

            <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
                <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                    <span class="n">fn_name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
                    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                        <span class="n">fn_args</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">툴 요청(Chat)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_args</span><span class="p">})</span>
                    <span class="n">tool_output</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>
                    <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span>
                                      <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">tool_output</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)})</span>
                <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span>
                                 <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">]})</span>
                <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

                <span class="n">completion</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span>
                    <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span> <span class="n">response_format</span><span class="o">=</span><span class="n">TaskAnswer</span>
                <span class="p">)</span>
                <span class="n">outputs_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">completion</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">completion</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

            <span class="n">parsed</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">parsed</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">out_obj</span> <span class="o">=</span> <span class="n">parsed</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">if</span> <span class="n">parsed</span> <span class="k">else</span> <span class="p">{</span><span class="sh">"</span><span class="s">filename</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">contents</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">}</span>
            <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">출력(Chat structured)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">out_obj</span><span class="p">)</span>
            <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">result.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">out_obj</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">RED</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="s">--- ERROR(Chat structured) ---</span><span class="sh">"</span> <span class="o">+</span> <span class="n">RESET</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json_mode</span><span class="sh">"</span><span class="p">:</span>
        <span class="c1"># Force JSON output
</span>        <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
            <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">response_format</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json_object</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">)</span>
        <span class="n">outputs_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">resp</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="n">fn_name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">툴 요청(Chat)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_args</span><span class="p">})</span>
                <span class="n">tool_output</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>
                <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span>
                                  <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">tool_output</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)})</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span>
                             <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">]})</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

            <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
                <span class="n">response_format</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json_object</span><span class="sh">"</span><span class="p">},</span>
            <span class="p">)</span>
            <span class="n">outputs_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">resp</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

        <span class="c1"># Try to parse JSON
</span>        <span class="n">result_obj</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result_obj</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="n">result_obj</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">filename</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">contents</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">}</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">출력(Chat json_mode)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">result_obj</span><span class="p">)</span>
        <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">result.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">result_obj</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>  <span class="c1"># plain
</span>        <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span> <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span>
        <span class="p">)</span>
        <span class="n">outputs_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">resp</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="n">fn_name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">툴 요청(Chat)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_args</span><span class="p">})</span>
                <span class="n">tool_output</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>
                <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span>
                                  <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">tool_output</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)})</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span>
                             <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">]})</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

            <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">)</span>
            <span class="n">outputs_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">resp</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">출력(Chat plain)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span><span class="p">})</span>

    <span class="c1"># Save IO logs
</span>    <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">input.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">input_snapshot</span><span class="p">)</span>
    <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">outputs.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">outputs_dump</span><span class="p">)</span>

<span class="c1"># ===== Responses runner =====
</span><span class="k">def</span> <span class="nf">run_responses</span><span class="p">(</span>
    <span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span>
    <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>  <span class="c1"># "plain" | "json_mode" | "structured"
</span>    <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">run_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="nf">make_tools</span><span class="p">(</span><span class="n">tools_variant</span><span class="p">,</span> <span class="n">structured</span><span class="o">=</span><span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">structured</span><span class="sh">"</span><span class="p">))</span>

    <span class="n">system_inst</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed. </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">Task: List files in ./samples, pick a text file, read it, and return a short 2-3 sentence summary. </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">If JSON is requested, reply only with an object: {</span><span class="se">\"</span><span class="s">filename</span><span class="se">\"</span><span class="s">: string, </span><span class="se">\"</span><span class="s">contents</span><span class="se">\"</span><span class="s">: string}.</span><span class="sh">"</span>
    <span class="p">)</span>
    <span class="n">input_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">system_inst</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_task</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="n">input_snapshot</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="n">input_list</span><span class="p">.</span><span class="nf">copy</span><span class="p">(),</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools</span><span class="p">,</span> <span class="sh">"</span><span class="s">mode</span><span class="sh">"</span><span class="p">:</span> <span class="n">mode</span><span class="p">}</span>
    <span class="n">outputs_dump</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">입력(Responses)</span><span class="sh">"</span><span class="p">,</span> <span class="n">CYAN</span><span class="p">,</span> <span class="n">input_snapshot</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">structured</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
                <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
                <span class="n">text_format</span><span class="o">=</span><span class="n">TaskAnswer</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">outputs_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">출력(Responses step 1)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

            <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
                <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">calls</span> <span class="o">=</span> <span class="nf">_collect_function_calls_from_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
                    <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">툴 요청(Responses)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">]})</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
                    <span class="n">input_list</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function_call_output</span><span class="sh">"</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">],</span>
                        <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                    <span class="p">})</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span>
                    <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span> <span class="n">text_format</span><span class="o">=</span><span class="n">TaskAnswer</span>
                <span class="p">)</span>
                <span class="n">outputs_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
                <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">출력(Responses next)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
                <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

            <span class="n">parsed</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output_parsed</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">out_obj</span> <span class="o">=</span> <span class="n">parsed</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">if</span> <span class="n">parsed</span> <span class="k">else</span> <span class="p">{</span><span class="sh">"</span><span class="s">filename</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">contents</span><span class="sh">"</span><span class="p">:</span> <span class="nf">_collect_text_from_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))}</span>
            <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">출력 요약(Responses structured)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">out_obj</span><span class="p">)</span>
            <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">result.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">out_obj</span><span class="p">)</span>

        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">RED</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="s">--- ERROR(Responses structured) ---</span><span class="sh">"</span> <span class="o">+</span> <span class="n">RESET</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json_mode</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
            <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">text</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">format</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json_object</span><span class="sh">"</span><span class="p">}},</span>
        <span class="p">)</span>
        <span class="n">outputs_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">출력(Responses step 1)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">calls</span> <span class="o">=</span> <span class="nf">_collect_function_calls_from_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
                <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">툴 요청(Responses)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">]})</span>
                <span class="n">result</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
                <span class="n">input_list</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function_call_output</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">],</span>
                    <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                <span class="p">})</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
                <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
                <span class="n">text</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">format</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json_object</span><span class="sh">"</span><span class="p">}},</span>
            <span class="p">)</span>
            <span class="n">outputs_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">출력(Responses next)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

        <span class="c1"># Try to parse JSON text
</span>        <span class="n">result_text</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">output_text</span> <span class="ow">or</span> <span class="sh">""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result_obj</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">result_text</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="n">result_obj</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">filename</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">contents</span><span class="sh">"</span><span class="p">:</span> <span class="n">result_text</span><span class="p">}</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">출력 요약(Responses json_mode)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">result_obj</span><span class="p">)</span>
        <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">result.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">result_obj</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>  <span class="c1"># plain
</span>        <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
            <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">outputs_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">출력(Responses step 1)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">calls</span> <span class="o">=</span> <span class="nf">_collect_function_calls_from_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
                <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">툴 요청(Responses)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">]})</span>
                <span class="n">result</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
                <span class="n">input_list</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function_call_output</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">],</span>
                    <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                <span class="p">})</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">)</span>
            <span class="n">outputs_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">출력(Responses next)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">출력 요약(Responses plain)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="nf">_collect_text_from_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))})</span>

    <span class="c1"># Save IO logs
</span>    <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">input.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">input_snapshot</span><span class="p">)</span>
    <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">outputs.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">outputs_dump</span><span class="p">)</span>

<span class="c1"># ===== 24-combo driver =====
</span><span class="n">DEFAULT_TASK</span> <span class="o">=</span> <span class="p">(</span>
    <span class="sh">"</span><span class="s">테스트: ./samples 폴더의 파일 목록을 보여주고, 텍스트 파일이 있으면 하나를 골라 내용을 읽고 2~3문장으로 요약해줘. </span><span class="sh">"</span>
    <span class="sh">"</span><span class="s">가능하다면 JSON으로 {</span><span class="se">\"</span><span class="s">filename</span><span class="se">\"</span><span class="s">: string, </span><span class="se">\"</span><span class="s">contents</span><span class="se">\"</span><span class="s">: string} 형태로 답해줘.</span><span class="sh">"</span>
<span class="p">)</span>

<span class="k">def</span> <span class="nf">run_one</span><span class="p">(</span><span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">base_runs_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">MODELS</span><span class="p">[</span><span class="n">model_key</span><span class="p">]</span>
    <span class="n">label</span> <span class="o">=</span> <span class="nf">combo_label</span><span class="p">(</span><span class="n">model_key</span><span class="p">,</span> <span class="n">api_type</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
    <span class="n">run_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">base_runs_dir</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
    <span class="nf">ensure_dirs</span><span class="p">(</span><span class="n">run_dir</span><span class="p">)</span>

    <span class="n">header</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[</span><span class="si">{</span><span class="n">api_type</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span><span class="si">}</span><span class="s">] model=</span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s"> tools=</span><span class="si">{</span><span class="n">tools_variant</span><span class="si">}</span><span class="s"> mode=</span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="sh">"</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="sh">"</span><span class="s">=</span><span class="sh">"</span> <span class="o">*</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s"> </span><span class="si">{</span><span class="n">header</span><span class="si">}</span><span class="s"> </span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=</span><span class="sh">"</span> <span class="o">*</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">api_type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">:</span>
            <span class="nf">run_chat</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">user_task</span><span class="p">,</span> <span class="n">run_dir</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">api_type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">:</span>
            <span class="nf">run_responses</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">user_task</span><span class="p">,</span> <span class="n">run_dir</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">api_type must be </span><span class="sh">'</span><span class="s">completions</span><span class="sh">'</span><span class="s"> or </span><span class="sh">'</span><span class="s">responses</span><span class="sh">'"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">RED</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="s">--- ERROR ---</span><span class="sh">"</span> <span class="o">+</span> <span class="n">RESET</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="nc">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Run 24 combos: 2 models × 2 APIs × 2 tool JSONs × 3 modes.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--task</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_TASK</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--models</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--apis</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--tools</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--modes</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">plain</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json_mode</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">structured</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">all</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">all</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--runs_dir</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="s">./runs/</span><span class="si">{</span><span class="nf">now_id</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="nf">parse_args</span><span class="p">()</span>

    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="sh">"</span><span class="s">./samples</span><span class="sh">"</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nf">ensure_dirs</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">runs_dir</span><span class="p">)</span>

    <span class="n">model_keys</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">models</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">models</span><span class="p">]</span>
    <span class="n">api_types</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">apis</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">apis</span><span class="p">]</span>
    <span class="n">tool_variants</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">tools</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">tools</span><span class="p">]</span>
    <span class="n">mode_list</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">plain</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json_mode</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">structured</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">modes</span> <span class="o">==</span> <span class="sh">"</span><span class="s">all</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">modes</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">mk</span> <span class="ow">in</span> <span class="n">model_keys</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">api</span> <span class="ow">in</span> <span class="n">api_types</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tv</span> <span class="ow">in</span> <span class="n">tool_variants</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">md</span> <span class="ow">in</span> <span class="n">mode_list</span><span class="p">:</span>
                    <span class="nf">run_one</span><span class="p">(</span><span class="n">mk</span><span class="p">,</span> <span class="n">api</span><span class="p">,</span> <span class="n">tv</span><span class="p">,</span> <span class="n">md</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">task</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">runs_dir</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="nf">main</span><span class="p">()</span>
</code></pre></div></div>

<p>사용 팁</p>

<ul>
  <li>
    <p>json_mode가 가장 안정적으로 {"filename","contents"}를 뱉어 줄 거야. structured는 SDK/모델의 strict 정책에 따라 여전히 실패할 수 있지만, 스크립트는 개별 조합별로 에러를 삼키고 계속 진행한다.</p>
  </li>
  <li>
    <p>모든 조합의 입력/출력(raw)을 저장해서 리그레션 비교가 가능해. json_mode/structured는 result.json을 따로 저장하므로 바로 사용할 수 있어.</p>
  </li>
  <li>
    <p>필요하면 system 메시지의 지시를 수정해서 contents에 “요약” 대신 “원문 전체”를 넣도록 바꿀 수도 있어.</p>
  </li>
</ul>

<p class="chat--user">

둘 다 json 관련 포매팅은 잘 안먹히네 일단 일반 텍스트 출력만 생각하자. 이제 소프트웨어 아키텍트 디자인 측면에서 한 번 보자. 조합 1. GPT OSS + responses 형식 call + 신규 tool json 형식 조합 2. Qwen + completions 형식 call + 과거 tool json 형식 이거야. 그런데 나는 사용자가 일종의 콤보 박스로 GPT OSS를 쓸 것인지, Qwen을 쓸 것인지 선택하고 나머지는 그 때 그 때 잘 동작하게 하고 싶어. 뭔가 디자인 패턴적인 것을 써서 깔끔하게 이를 구현하는 방법이 있을까? function call tool도 어떤 식으로 구현하면 좋을까 파이썬 고수의 입장에서 이런 점을 고려해서 깔끔한 코드 만들어줘.

</p>

<p>좋아. 요구 조합과 사용성(콤보박스로 엔진 선택)까지 고려해서 “전략(Strategy) + 툴 스키마 빌더(Factory) + 레지스트리 + 어댑터” 조합으로 깔끔하게 설계한 파이썬 예시를 줄게.</p>

<p>핵심 아이디어 요약(간결):</p>

<ol>
  <li>Strategy 패턴: 서로 다른 호출 방식 차이를 캡슐화</li>
</ol>

<ul>
  <li>
    <p>ResponsesStrategy(GPT OSS, responses 호출, “신규/평평한” tool JSON)</p>
  </li>
  <li>
    <p>CompletionsStrategy(Qwen, chat.completions 호출, “과거/중첩” tool JSON)</p>
  </li>
</ul>

<ol>
  <li>ToolRegistry + ToolSchemaBuilder(Factory):</li>
</ol>

<ul>
  <li>
    <p>ToolRegistry는 파이썬 함수를 등록/실행</p>
  </li>
  <li>
    <p>ToolSchemaBuilder가 등록된 툴을 각 엔진이 요구하는 JSON 모양으로 변환</p>

    <ul>
      <li>
        <p>NewToolJSONBuilder: responses용 flat JSON</p>
      </li>
      <li>
        <p>OldToolJSONBuilder: completions용 nested JSON</p>
      </li>
    </ul>
  </li>
</ul>

<ol>
  <li>Output 어댑터(단순화):</li>
</ol>

<ul>
  <li>두 전략은 모두 최종적으로 str을 반환. 내부의 tool_call 파싱 차이는 전략에서 숨김.</li>
</ul>

<ol>
  <li>설정 주입:</li>
</ol>

<ul>
  <li>엔드포인트·API 키·모델명을 config로 주입.</li>
</ul>

<p>바로 실행 가능한 단일 파일 예시:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># arch_combo_clean.py
# Python 3.10+
# pip install --upgrade openai
</span>
<span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Protocol</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">from</span> <span class="n">abc</span> <span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>

<span class="c1"># =========================
# Config &amp; DTO
# =========================
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ModelConfig</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">RunConfig</span><span class="p">:</span>
    <span class="n">engine</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># "gpt-oss" | "qwen"
</span>    <span class="n">task</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">samples_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">./samples</span><span class="sh">"</span>

<span class="c1"># =========================
# Tool layer
# =========================
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ToolSpec</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># JSON schema for parameters
</span>    <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># executes with parsed args
</span>
<span class="k">class</span> <span class="nc">ToolRegistry</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ToolSpec</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="n">ToolSpec</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">spec</span><span class="p">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Tool already registered: </span><span class="si">{</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">[</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span>

    <span class="k">def</span> <span class="nf">specs</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nf">list</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">.</span><span class="nf">values</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">[</span><span class="n">name</span><span class="p">].</span><span class="nf">func</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

<span class="c1"># =========================
# Tool JSON schema builders (Factory)
# =========================
</span>
<span class="k">class</span> <span class="nc">ToolJSONBuilder</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="bp">...</span>

<span class="k">class</span> <span class="nc">NewToolJSONBuilder</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Responses API에서 자주 보이는 </span><span class="sh">'</span><span class="s">평평한(flat)</span><span class="sh">'</span><span class="s"> 툴 정의
    { </span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="s">:..., </span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="s">:..., </span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="s">:{...} }
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">tools</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">:</span>
            <span class="n">tools</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">parameters</span><span class="p">,</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">tools</span>

<span class="k">class</span> <span class="nc">OldToolJSONBuilder</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Chat Completions API에서 자주 보이는 </span><span class="sh">'</span><span class="s">중첩(nested)</span><span class="sh">'</span><span class="s"> 툴 정의
    { </span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">:{ </span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="s">:..., </span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="s">:..., </span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="s">:{...} } }
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">tools</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">:</span>
            <span class="n">tools</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">parameters</span>
                <span class="p">}</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">tools</span>

<span class="c1"># =========================
# Strategy layer
# =========================
</span>
<span class="k">class</span> <span class="nc">EngineStrategy</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span> <span class="n">tools</span><span class="p">:</span> <span class="n">ToolRegistry</span><span class="p">,</span> <span class="n">builder</span><span class="p">:</span> <span class="n">ToolJSONBuilder</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">self</span><span class="p">.</span><span class="n">tools</span> <span class="o">=</span> <span class="n">tools</span>
        <span class="n">self</span><span class="p">.</span><span class="n">builder</span> <span class="o">=</span> <span class="n">builder</span>
        <span class="n">self</span><span class="p">.</span><span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">model</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">model</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="bp">...</span>

<span class="c1"># ---- GPT OSS + Responses Strategy ----
</span>
<span class="k">class</span> <span class="nc">ResponsesStrategy</span><span class="p">(</span><span class="n">EngineStrategy</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    - responses.create 사용
    - 툴 정의: NewToolJSONBuilder(flat)
    - function_call → 로컬 툴 실행 → function_call_output를 input에 append → 다시 responses.create
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">input_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed.</span><span class="sh">"</span><span class="p">},</span>
            <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">task</span><span class="p">},</span>
        <span class="p">]</span>
        <span class="n">tools_json</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">builder</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">.</span><span class="nf">specs</span><span class="p">())</span>

        <span class="c1"># 첫 호출
</span>        <span class="n">r</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">tools_json</span><span class="p">,</span>
            <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># 누적 텍스트와 루프
</span>        <span class="n">final_text_chunks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c1"># 출력 텍스트 수집
</span>            <span class="n">final_text_chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">_collect_text</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>

            <span class="c1"># 툴 호출 수집
</span>            <span class="n">calls</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_collect_function_calls</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="c1"># 툴 실행 → function_call_output 추가
</span>            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">]</span>
                <span class="n">args</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">]</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                <span class="n">input_list</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function_call_output</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">],</span>
                    <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                <span class="p">})</span>

            <span class="c1"># 다음 턴
</span>            <span class="n">r</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
                <span class="n">tools</span><span class="o">=</span><span class="n">tools_json</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">final_text_chunks</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

    <span class="c1"># Helpers
</span>    <span class="k">def</span> <span class="nf">_collect_text</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">resp</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
            <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]:</span>
                    <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
            <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
        <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">texts</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_collect_function_calls</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">resp</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="sh">"</span><span class="s">function_call</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span> <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                              <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                              <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span><span class="p">})</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">inner</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">inner</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">inner</span><span class="p">:</span>
                        <span class="n">nm</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                        <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                            <span class="k">try</span><span class="p">:</span> <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                                      <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">nm</span><span class="p">,</span>
                                      <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">calls</span>

<span class="c1"># ---- Qwen + Chat Completions Strategy ----
</span>
<span class="k">class</span> <span class="nc">CompletionsStrategy</span><span class="p">(</span><span class="n">EngineStrategy</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    - chat.completions.create 사용
    - 툴 정의: OldToolJSONBuilder(nested)
    - assistant.tool_calls → 로컬 툴 실행 → tool 메시지 첨부 → 다시 completions
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">tools_json</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">builder</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">.</span><span class="nf">specs</span><span class="p">())</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed.</span><span class="sh">"</span><span class="p">},</span>
            <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">task</span><span class="p">},</span>
        <span class="p">]</span>

        <span class="n">resp</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">tools_json</span><span class="p">,</span>
            <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
        <span class="n">final_text_chunks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">]</span>
        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="n">fn_name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>
                <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                <span class="p">})</span>

            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">],</span>
            <span class="p">})</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

            <span class="n">resp</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
            <span class="k">if</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                <span class="n">final_text_chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">content</span><span class="p">)</span>

        <span class="k">return</span> <span class="sh">"</span><span class="se">\n\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">final_text_chunks</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

<span class="c1"># =========================
# Tool implementations
# =========================
</span>
<span class="k">def</span> <span class="nf">list_files_tool</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">folder</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">items</span> <span class="o">=</span> <span class="nf">sorted</span><span class="p">([</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="nf">listdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">f</span><span class="p">))])</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="n">items</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">read_text_tool</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()}</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">build_registry</span><span class="p">(</span><span class="n">samples_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ToolRegistry</span><span class="p">:</span>
    <span class="n">reg</span> <span class="o">=</span> <span class="nc">ToolRegistry</span><span class="p">()</span>
    <span class="n">reg</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="nc">ToolSpec</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">},</span>
        <span class="n">func</span><span class="o">=</span><span class="n">list_files_tool</span>
    <span class="p">))</span>
    <span class="n">reg</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="nc">ToolSpec</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative path to the text file.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">},</span>
        <span class="n">func</span><span class="o">=</span><span class="n">read_text_tool</span>
    <span class="p">))</span>
    <span class="k">return</span> <span class="n">reg</span>

<span class="c1"># =========================
# Engine factory / selector
# =========================
</span>
<span class="k">def</span> <span class="nf">make_engine</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">RunConfig</span><span class="p">,</span> <span class="n">model_cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span> <span class="n">registry</span><span class="p">:</span> <span class="n">ToolRegistry</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EngineStrategy</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    콤보박스에서 </span><span class="sh">'</span><span class="s">gpt-oss</span><span class="sh">'</span><span class="s"> 또는 </span><span class="sh">'</span><span class="s">qwen</span><span class="sh">'</span><span class="s">을 선택하면,
    내부적으로 알맞은 Strategy + ToolJSONBuilder를 구성해서 반환.
    </span><span class="sh">"""</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="p">.</span><span class="n">engine</span> <span class="o">==</span> <span class="sh">"</span><span class="s">gpt-oss</span><span class="sh">"</span><span class="p">:</span>
        <span class="c1"># Responses + New(flat) tool JSON
</span>        <span class="k">return</span> <span class="nc">ResponsesStrategy</span><span class="p">(</span><span class="n">model_cfg</span><span class="p">,</span> <span class="n">registry</span><span class="p">,</span> <span class="nc">NewToolJSONBuilder</span><span class="p">())</span>
    <span class="k">elif</span> <span class="n">cfg</span><span class="p">.</span><span class="n">engine</span> <span class="o">==</span> <span class="sh">"</span><span class="s">qwen</span><span class="sh">"</span><span class="p">:</span>
        <span class="c1"># Completions + Old(nested) tool JSON
</span>        <span class="k">return</span> <span class="nc">CompletionsStrategy</span><span class="p">(</span><span class="n">model_cfg</span><span class="p">,</span> <span class="n">registry</span><span class="p">,</span> <span class="nc">OldToolJSONBuilder</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">Unknown engine. Choose </span><span class="sh">'</span><span class="s">gpt-oss</span><span class="sh">'</span><span class="s"> or </span><span class="sh">'</span><span class="s">qwen</span><span class="sh">'</span><span class="s">.</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># =========================
# Example main
# =========================
</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># 실제에 맞게 환경 변수로 분리
</span>    <span class="n">gpt_oss</span> <span class="o">=</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">GPT_OSS_MODEL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-4.1-mini</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">GPT_OSS_BASE_URL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">GPT_OSS_API_KEY</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_GPT_OSS</span><span class="sh">"</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">qwen</span> <span class="o">=</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">QWEN_MODEL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">qwen2.5</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">QWEN_BASE_URL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">QWEN_API_KEY</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_QWEN</span><span class="sh">"</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># 콤보박스 선택을 CLI로 가정 (실서비스라면 UI에서 이 값만 바꿔 주입)
</span>    <span class="kn">import</span> <span class="n">argparse</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="nc">ArgumentParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--engine</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">gpt-oss</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">qwen</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-oss</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--task</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">samples 디렉토리 내 파일을 보여주고 하나를 읽어 2~3문장 요약해줘. 필요하면 툴 사용.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--samples</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">./samples</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="nf">parse_args</span><span class="p">()</span>

    <span class="c1"># 모델 선택: UI에서 엔진을 바꾸면 이 매핑도 바꿔치기
</span>    <span class="n">model_cfg</span> <span class="o">=</span> <span class="n">gpt_oss</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">engine</span> <span class="o">==</span> <span class="sh">"</span><span class="s">gpt-oss</span><span class="sh">"</span> <span class="k">else</span> <span class="n">qwen</span>
    <span class="n">run_cfg</span> <span class="o">=</span> <span class="nc">RunConfig</span><span class="p">(</span><span class="n">engine</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">engine</span><span class="p">,</span> <span class="n">task</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">task</span><span class="p">,</span> <span class="n">samples_dir</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">samples</span><span class="p">)</span>

    <span class="c1"># 레지스트리 구성(필요시 엔진별 추가/삭제도 가능)
</span>    <span class="n">registry</span> <span class="o">=</span> <span class="nf">build_registry</span><span class="p">(</span><span class="n">run_cfg</span><span class="p">.</span><span class="n">samples_dir</span><span class="p">)</span>

    <span class="c1"># 전략 생성
</span>    <span class="n">engine</span> <span class="o">=</span> <span class="nf">make_engine</span><span class="p">(</span><span class="n">run_cfg</span><span class="p">,</span> <span class="n">model_cfg</span><span class="p">,</span> <span class="n">registry</span><span class="p">)</span>

    <span class="c1"># 실행
</span>    <span class="n">result_text</span> <span class="o">=</span> <span class="n">engine</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">run_cfg</span><span class="p">.</span><span class="n">task</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">=== FINAL OUTPUT ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">result_text</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">(empty)</span><span class="sh">"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="c1"># 샘플 폴더 보장
</span>    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="sh">"</span><span class="s">./samples</span><span class="sh">"</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nf">main</span><span class="p">()</span>
</code></pre></div></div>

<p>적용 포인트(설계 관점):</p>

<ul>
  <li>
    <p>확장성: 새 엔진이 늘어나도 Strategy만 추가하면 됨. 각 엔진의 호출 차이(Responses vs Completions, tool loop 프로토콜)를 캡슐화했어.</p>
  </li>
  <li>
    <p>책임 분리: ToolRegistry는 등록·실행만, ToolJSONBuilder는 JSON 모양만, Strategy는 대화 루프만 책임.</p>
  </li>
  <li>
    <p>UI 연동: 콤보박스 선택값을 RunConfig.engine으로 주입 → make_engine이 올바른 전략을 리턴.</p>
  </li>
  <li>
    <p>안전성: 루프에 guard로 폭주 방지. arguments는 json.loads로 관대하게 파싱.</p>
  </li>
  <li>
    <p>구성 가능성: 모델명/엔드포인트/키는 ModelConfig로 분리. 환경변수나 설정파일로 치환 용이.</p>
  </li>
</ul>

<p>원한다면</p>

<ul>
  <li>
    <p>로깅 인터페이스를 추가해 단계별(입력/툴요청/출력) 로그를 공통 포맷으로 남기기</p>
  </li>
  <li>
    <p>ToolRegistry에 권한/샌드박스 층(파일 접근 화이트리스트) 추가</p>
  </li>
  <li>
    <p>결과를 항상 {filename, contents} 포맷으로 어댑팅하는 OutputAdapter 추가</p>
  </li>
  <li>
    <p>async 버전(토큰 절약/동시성)을 위한 비동기 전략 추가</p>
  </li>
</ul>

<p>까지도 같은 패턴으로 깔끔하게 확장 가능해.</p>

<p class="chat--user">

조금 더 파이썬과 소프트웨어 아키텍트가 되어서 잘 생각해보자. if gpt-oss가 들어간 거 부터 좀 악취가 나. 추후에 새로운 모델이 들어오고 그 모델은 어떤 조합에서 잘 동작할지 모르잖아? 새로운 모델이 10개쯤 더 추가돼도 잘 관리될 수 있는 구조를 짜주면 좋겠어

</p>

<p>좋아. “모델이 계속 늘어나도 관리 가능한 구조”에 초점을 맞춰 아키텍처를 재정리했어. 핵심은 “조합(Protocol × Tool JSON 형태)”을 모델에서 분리하고, 모델마다 “능력/선호(capabilities &amp; preferences)”만 선언하도록 만드는 거야. 실행 전략은 조합에 따라 자동 선택·실행되며, 실패 시 합리적으로 폴백해.</p>

<p>아래 순서로 설명하고 바로 동작 가능한 예시 코드를 제공할게.</p>

<ol>
  <li>설계 요점</li>
</ol>

<ul>
  <li>
    <p>모델 무관 추상화</p>

    <ul>
      <li>
        <p>ProtocolStrategy: 호출 방식의 차이를 캡슐화. 현재 두 개 구현</p>

        <ul>
          <li>
            <p>ResponsesProtocol (responses.create 루프)</p>
          </li>
          <li>
            <p>CompletionsProtocol (chat.completions.create 루프)</p>
          </li>
        </ul>
      </li>
      <li>
        <p>ToolSchemaBuilder: Tool JSON 모양을 캡슐화. 두 개 구현</p>

        <ul>
          <li>
            <p>FlatStyle (responses에서 흔한 평평한 스키마)</p>
          </li>
          <li>
            <p>NestedStyle (completions에서 흔한 function 중첩)</p>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <p>조합(Plan) 단위 실행</p>

    <ul>
      <li>
        <p>Plan(protocol=…, tool_schema=…)</p>
      </li>
      <li>
        <p>Orchestrator가 ModelProfile의 preference에 따라 Plan을 선택하고 실행. 실패 시 fallback Plans 순서대로 시도</p>
      </li>
    </ul>
  </li>
  <li>
    <p>ModelProfile은 “모델명/엔드포인트/키” + “capabilities &amp; preferences”만 정의</p>

    <ul>
      <li>
        <p>새 모델 추가 = ModelProfile 하나 등록</p>
      </li>
      <li>
        <p>모델이 어느 조합에서 잘 동작하는지 모르면, preferences는 비워 두고 Orchestrator가 표준 우선순위(Responses+Flat → Completions+Nested)를 적용</p>
      </li>
    </ul>
  </li>
  <li>
    <p>ToolRegistry로 툴 구현/등록을 분리</p>

    <ul>
      <li>툴 함수 추가/변경이 모델/프로토콜 코드에 전혀 영향 없도록</li>
    </ul>
  </li>
</ul>

<ol>
  <li>실제 동작 흐름</li>
</ol>

<ul>
  <li>
    <p>UI 콤보박스에서 “모델 키”만 선택 → Orchestrator.run(model_key, task)</p>
  </li>
  <li>
    <p>Orchestrator는 ModelCatalog에서 프로필 조회 → Plan 결정 → 해당 Strategy와 ToolSchemaBuilder를 결합해 실행</p>
  </li>
  <li>
    <p>responses 프로토콜은 function_call_output 루프, completions 프로토콜은 tool 메시지 루프 수행</p>
  </li>
  <li>
    <p>최종 결과는 일반 텍스트(plain)로 통일</p>
  </li>
</ul>

<ol>
  <li>코드<br />
아래 파일 하나로 실행 가능. samples 폴더에 텍스트 파일 몇 개 두고 돌려봐.</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># arch_flexible_orchestrator.py
# Python 3.10+
# pip install --upgrade openai
</span>
<span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Protocol</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">from</span> <span class="n">abc</span> <span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>

<span class="c1"># =========================
# Basic Configs &amp; DTOs
# =========================
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ModelConfig</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ModelCapabilities</span><span class="p">:</span>
    <span class="c1"># 가능한 프로토콜
</span>    <span class="n">supports_responses</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">supports_completions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="c1"># 선호/권장 조합(Plan)을 우선 시도. 비워두면 기본 우선순위가 적용됨
</span>    <span class="n">preferred_plans</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="nf">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>  <span class="c1"># e.g. [("responses","flat"), ("completions","nested")]
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ModelProfile</span><span class="p">:</span>
    <span class="n">key</span><span class="p">:</span> <span class="nb">str</span>                <span class="c1"># UI 콤보박스용 ID
</span>    <span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span>
    <span class="n">caps</span><span class="p">:</span> <span class="n">ModelCapabilities</span>

<span class="c1"># =========================
# Tool Layer
# =========================
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ToolSpec</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># JSON schema
</span>    <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">Any</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">ToolRegistry</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ToolSpec</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="n">ToolSpec</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">spec</span><span class="p">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Tool already registered: </span><span class="si">{</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">[</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span>

    <span class="k">def</span> <span class="nf">specs</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nf">list</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">.</span><span class="nf">values</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">[</span><span class="n">name</span><span class="p">].</span><span class="nf">func</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

<span class="c1"># 기본 툴 2개
</span><span class="k">def</span> <span class="nf">list_files_tool</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">folder</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">items</span> <span class="o">=</span> <span class="nf">sorted</span><span class="p">([</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="nf">listdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">f</span><span class="p">))])</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="n">items</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">read_text_tool</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()}</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">build_default_registry</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">ToolRegistry</span><span class="p">:</span>
    <span class="n">reg</span> <span class="o">=</span> <span class="nc">ToolRegistry</span><span class="p">()</span>
    <span class="n">reg</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="nc">ToolSpec</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">},</span>
        <span class="n">func</span><span class="o">=</span><span class="n">list_files_tool</span>
    <span class="p">))</span>
    <span class="n">reg</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="nc">ToolSpec</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative path to the text file.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">},</span>
        <span class="n">func</span><span class="o">=</span><span class="n">read_text_tool</span>
    <span class="p">))</span>
    <span class="k">return</span> <span class="n">reg</span>

<span class="c1"># =========================
# Tool JSON Schema Builders
# =========================
</span>
<span class="k">class</span> <span class="nc">ToolJSONBuilder</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="bp">...</span>

<span class="k">class</span> <span class="nc">FlatStyleBuilder</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Responses에서 자주 쓰는 평평한 툴 형식:
    { </span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="s">:..., </span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="s">:..., </span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="s">:{...} }
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">:</span>
            <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">parameters</span><span class="p">,</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">out</span>

<span class="k">class</span> <span class="nc">NestedStyleBuilder</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Completions에서 자주 쓰는 중첩 툴 형식:
    { </span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">:{ </span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="s">:..., </span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="s">:..., </span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="s">:{...} } }
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">:</span>
            <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">parameters</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">out</span>

<span class="c1"># =========================
# Protocol Strategies
# =========================
</span>
<span class="k">class</span> <span class="nc">ProtocolStrategy</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span> <span class="n">tools</span><span class="p">:</span> <span class="n">ToolRegistry</span><span class="p">,</span> <span class="n">builder</span><span class="p">:</span> <span class="n">ToolJSONBuilder</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">self</span><span class="p">.</span><span class="n">tools</span> <span class="o">=</span> <span class="n">tools</span>
        <span class="n">self</span><span class="p">.</span><span class="n">builder</span> <span class="o">=</span> <span class="n">builder</span>
        <span class="n">self</span><span class="p">.</span><span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">model</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">model</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="bp">...</span>

<span class="c1"># Responses 프로토콜
</span><span class="k">class</span> <span class="nc">ResponsesProtocol</span><span class="p">(</span><span class="n">ProtocolStrategy</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">input_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed.</span><span class="sh">"</span><span class="p">},</span>
            <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">task</span><span class="p">},</span>
        <span class="p">]</span>
        <span class="n">tools_json</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">builder</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">.</span><span class="nf">specs</span><span class="p">())</span>

        <span class="n">r</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">tools_json</span><span class="p">,</span>
            <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">chunks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">_collect_text</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>
            <span class="n">calls</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_collect_tool_calls</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
                <span class="n">input_list</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function_call_output</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">[</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">],</span>
                    <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                <span class="p">})</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
                <span class="n">tools</span><span class="o">=</span><span class="n">tools_json</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">chunks</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_collect_text</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">resp</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
            <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]:</span>
                    <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
            <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
        <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">texts</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_collect_tool_calls</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">resp</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="sh">"</span><span class="s">function_call</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span> <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                              <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                              <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span><span class="p">})</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">inner</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">inner</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">inner</span><span class="p">:</span>
                        <span class="n">nm</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                        <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                            <span class="k">try</span><span class="p">:</span> <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                                      <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">nm</span><span class="p">,</span>
                                      <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">calls</span>

<span class="c1"># Completions 프로토콜
</span><span class="k">class</span> <span class="nc">CompletionsProtocol</span><span class="p">(</span><span class="n">ProtocolStrategy</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">tools_json</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">builder</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">.</span><span class="nf">specs</span><span class="p">())</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed.</span><span class="sh">"</span><span class="p">},</span>
            <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">task</span><span class="p">},</span>
        <span class="p">]</span>

        <span class="n">resp</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">tools_json</span><span class="p">,</span>
            <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
        <span class="n">chunks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">]</span>
        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="n">fn_name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>
                <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                <span class="p">})</span>

            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">],</span>
            <span class="p">})</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

            <span class="n">resp</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
            <span class="k">if</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">content</span><span class="p">)</span>

        <span class="k">return</span> <span class="sh">"</span><span class="se">\n\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">chunks</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

<span class="c1"># =========================
# Planning (조합 결정)
# =========================
</span>
<span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Plan</span><span class="p">:</span>
    <span class="n">protocol</span><span class="p">:</span> <span class="nb">str</span>         <span class="c1"># "responses" | "completions"
</span>    <span class="n">tool_schema</span><span class="p">:</span> <span class="nb">str</span>      <span class="c1"># "flat" | "nested"
</span>
<span class="k">class</span> <span class="nc">Orchestrator</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">profiles</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ModelProfile</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">ToolRegistry</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">profiles</span> <span class="o">=</span> <span class="n">profiles</span>
        <span class="n">self</span><span class="p">.</span><span class="n">tools</span> <span class="o">=</span> <span class="n">tools</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">model_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">profiles</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Unknown model key: </span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">profiles</span><span class="p">[</span><span class="n">model_key</span><span class="p">]</span>

        <span class="n">plans</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_candidate_plans</span><span class="p">(</span><span class="n">profile</span><span class="p">.</span><span class="n">caps</span><span class="p">)</span>
        <span class="n">last_error</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">Exception</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">plan</span> <span class="ow">in</span> <span class="n">plans</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">strategy</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_make_strategy</span><span class="p">(</span><span class="n">profile</span><span class="p">.</span><span class="n">cfg</span><span class="p">,</span> <span class="n">plan</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">strategy</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">last_error</span> <span class="o">=</span> <span class="n">e</span>
                <span class="c1"># 다음 플랜으로 시도
</span>                <span class="k">continue</span>
        <span class="k">if</span> <span class="n">last_error</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">last_error</span>
        <span class="k">return</span> <span class="sh">""</span>

    <span class="k">def</span> <span class="nf">_candidate_plans</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">caps</span><span class="p">:</span> <span class="n">ModelCapabilities</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Plan</span><span class="p">]:</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Plan</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># 1) 명시된 선호 플랜 우선
</span>        <span class="k">for</span> <span class="n">proto</span><span class="p">,</span> <span class="n">schema</span> <span class="ow">in</span> <span class="n">caps</span><span class="p">.</span><span class="n">preferred_plans</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">_supported</span><span class="p">(</span><span class="n">proto</span><span class="p">,</span> <span class="n">caps</span><span class="p">):</span>
                <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">Plan</span><span class="p">(</span><span class="n">proto</span><span class="p">,</span> <span class="n">schema</span><span class="p">))</span>
        <span class="c1"># 2) 기본 폴백 순서
</span>        <span class="n">defaults</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nc">Plan</span><span class="p">(</span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">flat</span><span class="sh">"</span><span class="p">),</span>
            <span class="nc">Plan</span><span class="p">(</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">nested</span><span class="sh">"</span><span class="p">),</span>
            <span class="nc">Plan</span><span class="p">(</span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">nested</span><span class="sh">"</span><span class="p">),</span>   <span class="c1"># 혹시 특정 모델이 nested를 요구한다면
</span>            <span class="nc">Plan</span><span class="p">(</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">flat</span><span class="sh">"</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">defaults</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">_supported</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">protocol</span><span class="p">,</span> <span class="n">caps</span><span class="p">)</span> <span class="ow">and</span> <span class="n">p</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
                <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">_supported</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">proto</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">caps</span><span class="p">:</span> <span class="n">ModelCapabilities</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">proto</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span> <span class="ow">and</span> <span class="n">caps</span><span class="p">.</span><span class="n">supports_responses</span><span class="p">)</span> <span class="ow">or</span> \
               <span class="p">(</span><span class="n">proto</span> <span class="o">==</span> <span class="sh">"</span><span class="s">completions</span><span class="sh">"</span> <span class="ow">and</span> <span class="n">caps</span><span class="p">.</span><span class="n">supports_completions</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_make_strategy</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span> <span class="n">plan</span><span class="p">:</span> <span class="n">Plan</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ProtocolStrategy</span><span class="p">:</span>
        <span class="n">builder</span><span class="p">:</span> <span class="n">ToolJSONBuilder</span> <span class="o">=</span> <span class="nc">FlatStyleBuilder</span><span class="p">()</span> <span class="k">if</span> <span class="n">plan</span><span class="p">.</span><span class="n">tool_schema</span> <span class="o">==</span> <span class="sh">"</span><span class="s">flat</span><span class="sh">"</span> <span class="k">else</span> <span class="nc">NestedStyleBuilder</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">plan</span><span class="p">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">return</span> <span class="nc">ResponsesProtocol</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">,</span> <span class="n">builder</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">plan</span><span class="p">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">return</span> <span class="nc">CompletionsProtocol</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">,</span> <span class="n">builder</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Unknown protocol: </span><span class="si">{</span><span class="n">plan</span><span class="p">.</span><span class="n">protocol</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># =========================
# Model Catalog (등록/확장 지점)
# =========================
</span>
<span class="k">def</span> <span class="nf">build_catalog</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ModelProfile</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">
    새 모델을 추가하려면 아래 dict에 항목 1줄만 더 넣으면 됨.
    - 모델 키(key): UI 콤보박스에서 쓰는 식별자
    - name/base_url/api_key: 환경변수로 주입(다른 벤더 SDK여도 OpenAI 호환이면 그대로 가능)
    - 캡능/선호(preferred_plans): 조합을 몰라도 비워두면 기본 순서대로 자동 시도
    </span><span class="sh">"""</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="c1"># 예시1: GPT-계열(Responses 선호)
</span>        <span class="sh">"</span><span class="s">gpt_like</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelProfile</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt_like</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">cfg</span><span class="o">=</span><span class="nc">ModelConfig</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">GPT_LIKE_MODEL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-4.1-mini</span><span class="sh">"</span><span class="p">),</span>
                <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">GPT_LIKE_BASE_URL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
                <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">GPT_LIKE_API_KEY</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY</span><span class="sh">"</span><span class="p">),</span>
            <span class="p">),</span>
            <span class="n">caps</span><span class="o">=</span><span class="nc">ModelCapabilities</span><span class="p">(</span>
                <span class="n">supports_responses</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                <span class="n">supports_completions</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                <span class="n">preferred_plans</span><span class="o">=</span><span class="p">[(</span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">flat</span><span class="sh">"</span><span class="p">)]</span>  <span class="c1"># 먼저 responses+flat 시도
</span>            <span class="p">)</span>
        <span class="p">),</span>
        <span class="c1"># 예시2: Qwen-계열(Completions 선호)
</span>        <span class="sh">"</span><span class="s">qwen_like</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelProfile</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="sh">"</span><span class="s">qwen_like</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">cfg</span><span class="o">=</span><span class="nc">ModelConfig</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">QWEN_MODEL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">qwen2.5</span><span class="sh">"</span><span class="p">),</span>
                <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">QWEN_BASE_URL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
                <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">QWEN_API_KEY</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY</span><span class="sh">"</span><span class="p">),</span>
            <span class="p">),</span>
            <span class="n">caps</span><span class="o">=</span><span class="nc">ModelCapabilities</span><span class="p">(</span>
                <span class="n">supports_responses</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                <span class="n">supports_completions</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                <span class="n">preferred_plans</span><span class="o">=</span><span class="p">[(</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">nested</span><span class="sh">"</span><span class="p">)]</span>  <span class="c1"># 먼저 completions+nested 시도
</span>            <span class="p">)</span>
        <span class="p">),</span>
        <span class="c1"># 예시3: Responses만 되는 모델
</span>        <span class="sh">"</span><span class="s">resp_only</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelProfile</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="sh">"</span><span class="s">resp_only</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">cfg</span><span class="o">=</span><span class="nc">ModelConfig</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">RESP_ONLY_MODEL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">some-resp-model</span><span class="sh">"</span><span class="p">),</span>
                <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">RESP_ONLY_BASE_URL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
                <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">RESP_ONLY_API_KEY</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY</span><span class="sh">"</span><span class="p">),</span>
            <span class="p">),</span>
            <span class="n">caps</span><span class="o">=</span><span class="nc">ModelCapabilities</span><span class="p">(</span>
                <span class="n">supports_responses</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                <span class="n">supports_completions</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                <span class="n">preferred_plans</span><span class="o">=</span><span class="p">[(</span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">flat</span><span class="sh">"</span><span class="p">)]</span>
            <span class="p">)</span>
        <span class="p">),</span>
        <span class="c1"># 예시4: Completions만 되는 모델
</span>        <span class="sh">"</span><span class="s">chat_only</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelProfile</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="sh">"</span><span class="s">chat_only</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">cfg</span><span class="o">=</span><span class="nc">ModelConfig</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">CHAT_ONLY_MODEL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">some-chat-model</span><span class="sh">"</span><span class="p">),</span>
                <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">CHAT_ONLY_BASE_URL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
                <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">CHAT_ONLY_API_KEY</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY</span><span class="sh">"</span><span class="p">),</span>
            <span class="p">),</span>
            <span class="n">caps</span><span class="o">=</span><span class="nc">ModelCapabilities</span><span class="p">(</span>
                <span class="n">supports_responses</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                <span class="n">supports_completions</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                <span class="n">preferred_plans</span><span class="o">=</span><span class="p">[(</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">nested</span><span class="sh">"</span><span class="p">)]</span>
            <span class="p">)</span>
        <span class="p">),</span>
    <span class="p">}</span>

<span class="c1"># =========================
# Example main (UI 콤보박스 대체)
# =========================
</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="kn">import</span> <span class="n">argparse</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="nc">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Flexible model orchestrator (plain text, tools).</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--model-key</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt_like</span><span class="sh">"</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">Model key from catalog (e.g., gpt_like, qwen_like, resp_only, chat_only)</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--task</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">samples 폴더 파일 목록을 보여주고, 텍스트 파일을 하나 읽어 2~3문장으로 요약해줘. 필요하면 툴 사용.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="nf">parse_args</span><span class="p">()</span>

    <span class="c1"># 준비
</span>    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="sh">"</span><span class="s">./samples</span><span class="sh">"</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">registry</span> <span class="o">=</span> <span class="nf">build_default_registry</span><span class="p">()</span>
    <span class="n">catalog</span> <span class="o">=</span> <span class="nf">build_catalog</span><span class="p">()</span>
    <span class="n">orch</span> <span class="o">=</span> <span class="nc">Orchestrator</span><span class="p">(</span><span class="n">catalog</span><span class="p">,</span> <span class="n">registry</span><span class="p">)</span>

    <span class="c1"># 실행
</span>    <span class="n">out</span> <span class="o">=</span> <span class="n">orch</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">model_key</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">task</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">=== FINAL OUTPUT ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">out</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">(empty)</span><span class="sh">"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="nf">main</span><span class="p">()</span>
</code></pre></div></div>

<ol>
  <li>이 설계가 확장에 유리한 이유</li>
</ol>

<ul>
  <li>
    <p>새 모델 추가 시 변경 범위가 매우 작음</p>

    <ul>
      <li>
        <p>ModelCatalog에 ModelProfile 1줄 추가(이름/엔드포인트/키, 캡능/선호)</p>
      </li>
      <li>
        <p>조합을 몰라도 OK: preferred_plans 비우면 Orchestrator가 표준 우선순위로 자동 시도</p>
      </li>
    </ul>
  </li>
  <li>
    <p>조합 폭발에도 견고</p>

    <ul>
      <li>
        <p>Plan을 독립 타입으로 관리해서 Protocol × ToolSchema를 명시적으로 표기</p>
      </li>
      <li>
        <p>실패 시 다음 Plan으로 폴백하는 일관된 로직</p>
      </li>
    </ul>
  </li>
  <li>
    <p>관심사 분리</p>

    <ul>
      <li>
        <p>ToolRegistry/ToolSpec: 툴 구현과 파라미터 스키마만 관리</p>
      </li>
      <li>
        <p>ToolJSONBuilder: JSON 모양만 담당(Flat/Nested 추가 쉬움)</p>
      </li>
      <li>
        <p>ProtocolStrategy: 호출/루프/파싱 차이만 담당</p>
      </li>
      <li>
        <p>Orchestrator: 모델 선택과 플랜 선정/폴백만 담당</p>
      </li>
    </ul>
  </li>
</ul>

<ol>
  <li>커스터마이징 힌트</li>
</ol>

<ul>
  <li>
    <p>모델별 “도구 정책”이 다르면 ModelProfile에 tool_policy 콜백을 추가해 특정 툴만 노출 가능</p>
  </li>
  <li>
    <p>로깅/메트릭스: ProtocolStrategy.run 내부에서 콜 카운트/지연/토큰 사용량(응답 필드에 있으면) 수집 후 공통 인터페이스로 리턴</p>
  </li>
  <li>
    <p>안전 모드: 파일 접근 화이트리스트(예: samples 하위만 허용)를 ToolRegistry.call에 주입</p>
  </li>
  <li>
    <p>후일 JSON 모드/Structured가 안정화되면 Plan에 “output_format” 축을 추가해 전략적으로 선택 가능</p>
  </li>
</ul>

<p>필요하면 이 구조로 테스트 하네스(여러 모델×플랜을 한 번에 돌려 결과 비교)도 바로 얹어줄게.</p>

<p class="chat--user">

추가 요청 사항 1. Async 통신만 사용해줘. 
<code class="language-plaintext highlighter-rouge">
async with AsyncOpenAI(
    ..., http_clinet=httpx.AsyncClient(event_hooks=hooks) as client:
    client....
</code>

2. 유저가 인터럽트하면 중지가 되어야 해. 예를 들어 주기적으로 user.processing_interrupted() 함수를 호출해서 취소 여부를 확인하고 그에 따라 client도 깔끔하게 취소가 되어야 해. 3. 주석은 영문으로 써줘. 4. 모든 코드를 써줘.

</p>

<p>아래는 확장성에 초점을 둔 비동기(Async) 오케스트레이션 샘플이야.<br />
설계 포인트 요약</p>

<ul>
  <li>
    <p>모델 수가 늘어나도 변경 최소화: 새 모델은 ModelProfile만 추가하면 됨.</p>
  </li>
  <li>
    <p>조합(Protocol × Tool-JSON-Style)을 모델과 분리: Orchestrator가 Plan을 자동 선택·폴백.</p>
  </li>
  <li>
    <p>순수 비동기 통신만 사용: AsyncOpenAI + httpx.AsyncClient.</p>
  </li>
  <li>
    <p>사용자 인터럽트 지원: user.processing_interrupted()를 주기적으로 확인하고, 진행 중 요청은 asyncio Task 취소로 깔끔히 중단.</p>
  </li>
</ul>

<p>코드는 한 파일로 동작하며 일반 텍스트 출력만을 반환한다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># async_arch_orchestrator.py
# Python 3.10+
# pip install --upgrade openai httpx
</span>
<span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">signal</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Protocol</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">from</span> <span class="n">abc</span> <span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>

<span class="kn">import</span> <span class="n">httpx</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">AsyncOpenAI</span>

<span class="c1"># ============================================================
# Exceptions / Interrupt
# ============================================================
</span>
<span class="k">class</span> <span class="nc">UserCancelledError</span><span class="p">(</span><span class="nb">Exception</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Raised when the user has interrupted the processing.</span><span class="sh">"""</span>

<span class="k">class</span> <span class="nc">UserInterruptController</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    A simple interrupt controller.
    - Call `trigger()` to mark as interrupted (e.g., SIGINT handler).
    - Frameworks/UI can override processing_interrupted() to integrate with their own state.
    </span><span class="sh">"""</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_event</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Event</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">processing_interrupted</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">Return True if the user has requested cancellation.</span><span class="sh">"""</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_event</span><span class="p">.</span><span class="nf">is_set</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">trigger</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">Externally trigger an interrupt (e.g., from a signal handler or UI callback).</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_event</span><span class="p">.</span><span class="nf">set</span><span class="p">()</span>

<span class="c1"># ============================================================
# Configs &amp; Profiles
# ============================================================
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ModelConfig</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ModelCapabilities</span><span class="p">:</span>
    <span class="c1"># Supported protocols
</span>    <span class="n">supports_responses</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">supports_completions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="c1"># Preferred plans, empty ⇒ Orchestrator applies default order.
</span>    <span class="n">preferred_plans</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="nf">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>  <span class="c1"># e.g. [("responses", "flat"), ("completions", "nested")]
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ModelProfile</span><span class="p">:</span>
    <span class="n">key</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span>
    <span class="n">caps</span><span class="p">:</span> <span class="n">ModelCapabilities</span>

<span class="c1"># ============================================================
# Tool Layer
# ============================================================
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ToolSpec</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># JSON schema object
</span>    <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># Sync function (fast local I/O)
</span>
<span class="k">class</span> <span class="nc">ToolRegistry</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Keeps tool specs and executes them by name.</span><span class="sh">"""</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ToolSpec</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="n">ToolSpec</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">spec</span><span class="p">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Tool already registered: </span><span class="si">{</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">[</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span>

    <span class="k">def</span> <span class="nf">specs</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nf">list</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">.</span><span class="nf">values</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">[</span><span class="n">name</span><span class="p">].</span><span class="nf">func</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

<span class="c1"># Default file tools
</span>
<span class="k">def</span> <span class="nf">list_files_tool</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">folder</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">items</span> <span class="o">=</span> <span class="nf">sorted</span><span class="p">([</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="nf">listdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">f</span><span class="p">))])</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="n">items</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">read_text_tool</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()}</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">build_default_registry</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">ToolRegistry</span><span class="p">:</span>
    <span class="n">reg</span> <span class="o">=</span> <span class="nc">ToolRegistry</span><span class="p">()</span>
    <span class="n">reg</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="nc">ToolSpec</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">},</span>
        <span class="n">func</span><span class="o">=</span><span class="n">list_files_tool</span>
    <span class="p">))</span>
    <span class="n">reg</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="nc">ToolSpec</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative path to the text file.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">},</span>
        <span class="n">func</span><span class="o">=</span><span class="n">read_text_tool</span>
    <span class="p">))</span>
    <span class="k">return</span> <span class="n">reg</span>

<span class="c1"># ============================================================
# Tool JSON builders (Factory)
# ============================================================
</span>
<span class="k">class</span> <span class="nc">ToolJSONBuilder</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="bp">...</span>

<span class="k">class</span> <span class="nc">FlatStyleBuilder</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    </span><span class="sh">"</span><span class="s">New</span><span class="sh">"</span><span class="s"> / flat tool JSON (often used with Responses-style examples):
    { </span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="s">:..., </span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="s">:..., </span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="s">:{...} }
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">:</span>
            <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">parameters</span><span class="p">,</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">out</span>

<span class="k">class</span> <span class="nc">NestedStyleBuilder</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    </span><span class="sh">"</span><span class="s">Old</span><span class="sh">"</span><span class="s"> / nested tool JSON (common in Chat Completions examples):
    { </span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">:{ </span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="s">:..., </span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="s">:..., </span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="s">:{...} } }
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">:</span>
            <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">parameters</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">out</span>

<span class="c1"># ============================================================
# Async helpers (HTTP client, cancellation wrapper)
# ============================================================
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">call_with_interrupt</span><span class="p">(</span><span class="n">coro</span><span class="p">,</span> <span class="n">interrupt_cb</span><span class="p">,</span> <span class="n">poll_interval</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Run an awaitable while periodically checking for user interruption.
    If interrupted, cancel the task and raise UserCancelledError.
    </span><span class="sh">"""</span>
    <span class="n">task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="n">coro</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">({</span><span class="n">task</span><span class="p">},</span> <span class="n">timeout</span><span class="o">=</span><span class="n">poll_interval</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">task</span><span class="p">.</span><span class="nf">result</span><span class="p">()</span>
            <span class="c1"># Periodically check interrupt
</span>            <span class="k">if</span> <span class="k">await</span> <span class="nf">interrupt_cb</span><span class="p">():</span>
                <span class="n">task</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">task</span>
                <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">raise</span> <span class="nc">UserCancelledError</span><span class="p">(</span><span class="sh">"</span><span class="s">Processing interrupted by user.</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">raise</span>

<span class="k">def</span> <span class="nf">build_httpx_hooks</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Callable</span><span class="p">]]:</span>
    <span class="sh">"""</span><span class="s">
    Create httpx AsyncClient event hooks.
    You can add logging or tracing here if desired.
    </span><span class="sh">"""</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">on_request</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">httpx</span><span class="p">.</span><span class="n">Request</span><span class="p">):</span>
        <span class="c1"># Example: print(f"[httpx] -&gt; {request.method} {request.url}")
</span>        <span class="k">return</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">on_response</span><span class="p">(</span><span class="n">response</span><span class="p">:</span> <span class="n">httpx</span><span class="p">.</span><span class="n">Response</span><span class="p">):</span>
        <span class="c1"># Example: print(f"[httpx] &lt;- {response.status_code} {response.request.url}")
</span>        <span class="k">return</span>

    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">on_request</span><span class="p">],</span> <span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">on_response</span><span class="p">]}</span>

<span class="c1"># ============================================================
# Protocol Strategies (Async)
# ============================================================
</span>
<span class="k">class</span> <span class="nc">ProtocolStrategy</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Base class for protocol strategies.
    Each strategy must:
      - Use AsyncOpenAI only
      - Respect user interruption at reasonable checkpoints
    </span><span class="sh">"""</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span>
        <span class="n">tools</span><span class="p">:</span> <span class="n">ToolRegistry</span><span class="p">,</span>
        <span class="n">builder</span><span class="p">:</span> <span class="n">ToolJSONBuilder</span><span class="p">,</span>
        <span class="n">interrupt</span><span class="p">:</span> <span class="n">UserInterruptController</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">self</span><span class="p">.</span><span class="n">tools</span> <span class="o">=</span> <span class="n">tools</span>
        <span class="n">self</span><span class="p">.</span><span class="n">builder</span> <span class="o">=</span> <span class="n">builder</span>
        <span class="n">self</span><span class="p">.</span><span class="n">interrupt</span> <span class="o">=</span> <span class="n">interrupt</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="bp">...</span>

<span class="k">class</span> <span class="nc">ResponsesProtocol</span><span class="p">(</span><span class="n">ProtocolStrategy</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Async implementation of a Responses-style loop:
      - responses.create
      - process output_text
      - if tool calls exist: execute local tool(s), append function_call_output, repeat
    </span><span class="sh">"""</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_collect_text</span><span class="p">(</span><span class="n">resp</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
            <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]:</span>
                    <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
            <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
        <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">texts</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_collect_tool_calls</span><span class="p">(</span><span class="n">resp</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="sh">"</span><span class="s">function_call</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                        <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                    <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{},</span>
                <span class="p">})</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">inner</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">inner</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">inner</span><span class="p">:</span>
                        <span class="n">nm</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                        <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                                <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                            <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">nm</span><span class="p">,</span>
                            <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{},</span>
                        <span class="p">})</span>
        <span class="k">return</span> <span class="n">calls</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">hooks</span> <span class="o">=</span> <span class="nf">build_httpx_hooks</span><span class="p">()</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">httpx</span><span class="p">.</span><span class="nc">AsyncClient</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">httpx</span><span class="p">.</span><span class="nc">Timeout</span><span class="p">(</span><span class="mf">60.0</span><span class="p">),</span> <span class="n">event_hooks</span><span class="o">=</span><span class="n">hooks</span><span class="p">)</span> <span class="k">as</span> <span class="n">http_client</span><span class="p">:</span>
            <span class="k">async</span> <span class="k">with</span> <span class="nc">AsyncOpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">api_key</span><span class="p">,</span> <span class="n">http_client</span><span class="o">=</span><span class="n">http_client</span><span class="p">)</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
                <span class="n">input_list</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed.</span><span class="sh">"</span><span class="p">},</span>
                    <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">task</span><span class="p">},</span>
                <span class="p">]</span>
                <span class="n">tools_json</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">builder</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">.</span><span class="nf">specs</span><span class="p">())</span>

                <span class="c1"># First call
</span>                <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_guard_interrupt</span><span class="p">()</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">call_with_interrupt</span><span class="p">(</span>
                    <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                        <span class="n">model</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
                        <span class="n">tools</span><span class="o">=</span><span class="n">tools_json</span><span class="p">,</span>
                        <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">interrupt</span><span class="p">.</span><span class="n">processing_interrupted</span>
                <span class="p">)</span>

                <span class="c1"># Loop
</span>                <span class="n">chunks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">while</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
                    <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">_collect_text</span><span class="p">(</span><span class="n">resp</span><span class="p">))</span>

                    <span class="n">calls</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_collect_tool_calls</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>
                        <span class="k">break</span>

                    <span class="c1"># Execute tools locally and append outputs
</span>                    <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
                        <span class="c1"># Check for interruption between tool calls as well
</span>                        <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_guard_interrupt</span><span class="p">()</span>

                        <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">]</span>
                        <span class="n">args</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">]</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                        <span class="n">input_list</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function_call_output</span><span class="sh">"</span><span class="p">,</span>
                            <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">],</span>
                            <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                        <span class="p">})</span>

                    <span class="c1"># Next turn
</span>                    <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_guard_interrupt</span><span class="p">()</span>
                    <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">call_with_interrupt</span><span class="p">(</span>
                        <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                            <span class="n">model</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                            <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
                            <span class="n">tools</span><span class="o">=</span><span class="n">tools_json</span><span class="p">,</span>
                        <span class="p">),</span>
                        <span class="n">self</span><span class="p">.</span><span class="n">interrupt</span><span class="p">.</span><span class="n">processing_interrupted</span>
                    <span class="p">)</span>

                <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">chunks</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_guard_interrupt</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">interrupt</span><span class="p">.</span><span class="nf">processing_interrupted</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">UserCancelledError</span><span class="p">(</span><span class="sh">"</span><span class="s">Processing interrupted by user.</span><span class="sh">"</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">CompletionsProtocol</span><span class="p">(</span><span class="n">ProtocolStrategy</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Async implementation of a Chat Completions-style loop:
      - chat.completions.create
      - assistant.tool_calls → execute tools → append tool messages → repeat
    </span><span class="sh">"""</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">hooks</span> <span class="o">=</span> <span class="nf">build_httpx_hooks</span><span class="p">()</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">httpx</span><span class="p">.</span><span class="nc">AsyncClient</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">httpx</span><span class="p">.</span><span class="nc">Timeout</span><span class="p">(</span><span class="mf">60.0</span><span class="p">),</span> <span class="n">event_hooks</span><span class="o">=</span><span class="n">hooks</span><span class="p">)</span> <span class="k">as</span> <span class="n">http_client</span><span class="p">:</span>
            <span class="k">async</span> <span class="k">with</span> <span class="nc">AsyncOpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">api_key</span><span class="p">,</span> <span class="n">http_client</span><span class="o">=</span><span class="n">http_client</span><span class="p">)</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
                <span class="n">tools_json</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">builder</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">.</span><span class="nf">specs</span><span class="p">())</span>
                <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed.</span><span class="sh">"</span><span class="p">},</span>
                    <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">task</span><span class="p">},</span>
                <span class="p">]</span>

                <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_guard_interrupt</span><span class="p">()</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">call_with_interrupt</span><span class="p">(</span>
                    <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                        <span class="n">model</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
                        <span class="n">tools</span><span class="o">=</span><span class="n">tools_json</span><span class="p">,</span>
                        <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">interrupt</span><span class="p">.</span><span class="n">processing_interrupted</span>
                <span class="p">)</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
                <span class="n">chunks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">]</span>
                <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
                    <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="c1"># Prepare tool messages
</span>                    <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_guard_interrupt</span><span class="p">()</span>

                        <span class="n">fn_name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
                        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                            <span class="n">fn_args</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>
                        <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                            <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                            <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
                            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span>
                            <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                        <span class="p">})</span>

                    <span class="c1"># Append assistant tool_calls echo + tool outputs
</span>                    <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                        <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">],</span>
                    <span class="p">})</span>
                    <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

                    <span class="c1"># Next turn
</span>                    <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_guard_interrupt</span><span class="p">()</span>
                    <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">call_with_interrupt</span><span class="p">(</span>
                        <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                            <span class="n">model</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                            <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
                        <span class="p">),</span>
                        <span class="n">self</span><span class="p">.</span><span class="n">interrupt</span><span class="p">.</span><span class="n">processing_interrupted</span>
                    <span class="p">)</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
                    <span class="k">if</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                        <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">content</span><span class="p">)</span>

                <span class="k">return</span> <span class="sh">"</span><span class="se">\n\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">chunks</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_guard_interrupt</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">interrupt</span><span class="p">.</span><span class="nf">processing_interrupted</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">UserCancelledError</span><span class="p">(</span><span class="sh">"</span><span class="s">Processing interrupted by user.</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># ============================================================
# Planning (Protocol × Tool-JSON combination)
# ============================================================
</span>
<span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Plan</span><span class="p">:</span>
    <span class="n">protocol</span><span class="p">:</span> <span class="nb">str</span>        <span class="c1"># "responses" | "completions"
</span>    <span class="n">tool_schema</span><span class="p">:</span> <span class="nb">str</span>     <span class="c1"># "flat" | "nested"
</span>
<span class="k">class</span> <span class="nc">Orchestrator</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Chooses and executes the best Plan for a given model, with fallback.
    Fully async and interruption-aware.
    </span><span class="sh">"""</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">profiles</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ModelProfile</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">ToolRegistry</span><span class="p">,</span> <span class="n">interrupt</span><span class="p">:</span> <span class="n">UserInterruptController</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">profiles</span> <span class="o">=</span> <span class="n">profiles</span>
        <span class="n">self</span><span class="p">.</span><span class="n">tools</span> <span class="o">=</span> <span class="n">tools</span>
        <span class="n">self</span><span class="p">.</span><span class="n">interrupt</span> <span class="o">=</span> <span class="n">interrupt</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">model_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">profiles</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Unknown model key: </span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">profiles</span><span class="p">[</span><span class="n">model_key</span><span class="p">]</span>

        <span class="n">plans</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_candidate_plans</span><span class="p">(</span><span class="n">profile</span><span class="p">.</span><span class="n">caps</span><span class="p">)</span>
        <span class="n">last_error</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">Exception</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">plan</span> <span class="ow">in</span> <span class="n">plans</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">strategy</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_make_strategy</span><span class="p">(</span><span class="n">profile</span><span class="p">.</span><span class="n">cfg</span><span class="p">,</span> <span class="n">plan</span><span class="p">)</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">strategy</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">UserCancelledError</span><span class="p">:</span>
                <span class="c1"># Bubble up immediately on user cancellation
</span>                <span class="k">raise</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">last_error</span> <span class="o">=</span> <span class="n">e</span>
                <span class="c1"># Try next plan on failure
</span>                <span class="k">continue</span>
        <span class="k">if</span> <span class="n">last_error</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">last_error</span>
        <span class="k">return</span> <span class="sh">""</span>

    <span class="k">def</span> <span class="nf">_candidate_plans</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">caps</span><span class="p">:</span> <span class="n">ModelCapabilities</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Plan</span><span class="p">]:</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Plan</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># 1) Preferred plans first
</span>        <span class="k">for</span> <span class="n">proto</span><span class="p">,</span> <span class="n">schema</span> <span class="ow">in</span> <span class="n">caps</span><span class="p">.</span><span class="n">preferred_plans</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">_supported</span><span class="p">(</span><span class="n">proto</span><span class="p">,</span> <span class="n">caps</span><span class="p">):</span>
                <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">Plan</span><span class="p">(</span><span class="n">proto</span><span class="p">,</span> <span class="n">schema</span><span class="p">))</span>
        <span class="c1"># 2) Default fallback order
</span>        <span class="n">defaults</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nc">Plan</span><span class="p">(</span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">flat</span><span class="sh">"</span><span class="p">),</span>
            <span class="nc">Plan</span><span class="p">(</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">nested</span><span class="sh">"</span><span class="p">),</span>
            <span class="nc">Plan</span><span class="p">(</span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">nested</span><span class="sh">"</span><span class="p">),</span>
            <span class="nc">Plan</span><span class="p">(</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">flat</span><span class="sh">"</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">defaults</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">_supported</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">protocol</span><span class="p">,</span> <span class="n">caps</span><span class="p">)</span> <span class="ow">and</span> <span class="n">p</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
                <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">_supported</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">proto</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">caps</span><span class="p">:</span> <span class="n">ModelCapabilities</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">proto</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span> <span class="ow">and</span> <span class="n">caps</span><span class="p">.</span><span class="n">supports_responses</span><span class="p">)</span> <span class="ow">or</span> \
               <span class="p">(</span><span class="n">proto</span> <span class="o">==</span> <span class="sh">"</span><span class="s">completions</span><span class="sh">"</span> <span class="ow">and</span> <span class="n">caps</span><span class="p">.</span><span class="n">supports_completions</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_make_strategy</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span> <span class="n">plan</span><span class="p">:</span> <span class="n">Plan</span><span class="p">):</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="nc">FlatStyleBuilder</span><span class="p">()</span> <span class="k">if</span> <span class="n">plan</span><span class="p">.</span><span class="n">tool_schema</span> <span class="o">==</span> <span class="sh">"</span><span class="s">flat</span><span class="sh">"</span> <span class="k">else</span> <span class="nc">NestedStyleBuilder</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">plan</span><span class="p">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">return</span> <span class="nc">ResponsesProtocol</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">,</span> <span class="n">builder</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">interrupt</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">plan</span><span class="p">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">return</span> <span class="nc">CompletionsProtocol</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">,</span> <span class="n">builder</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">interrupt</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Unknown protocol: </span><span class="si">{</span><span class="n">plan</span><span class="p">.</span><span class="n">protocol</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># ============================================================
# Model Catalog (extensible)
# ============================================================
</span>
<span class="k">def</span> <span class="nf">build_catalog</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ModelProfile</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">
    To add a new model, just create another ModelProfile entry here.
    If you don</span><span class="sh">'</span><span class="s">t know which combo works best, leave `preferred_plans` empty;
    Orchestrator will try the defaults in a safe order.
    </span><span class="sh">"""</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="c1"># Example: GPT-like model (prefers Responses + flat tools)
</span>        <span class="sh">"</span><span class="s">gpt_like</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelProfile</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt_like</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">cfg</span><span class="o">=</span><span class="nc">ModelConfig</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">GPT_LIKE_MODEL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-4.1-mini</span><span class="sh">"</span><span class="p">),</span>
                <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">GPT_LIKE_BASE_URL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
                <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">GPT_LIKE_API_KEY</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY</span><span class="sh">"</span><span class="p">),</span>
            <span class="p">),</span>
            <span class="n">caps</span><span class="o">=</span><span class="nc">ModelCapabilities</span><span class="p">(</span>
                <span class="n">supports_responses</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                <span class="n">supports_completions</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                <span class="n">preferred_plans</span><span class="o">=</span><span class="p">[(</span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">flat</span><span class="sh">"</span><span class="p">)]</span>
            <span class="p">)</span>
        <span class="p">),</span>
        <span class="c1"># Example: Qwen-like model (prefers Completions + nested tools)
</span>        <span class="sh">"</span><span class="s">qwen_like</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelProfile</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="sh">"</span><span class="s">qwen_like</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">cfg</span><span class="o">=</span><span class="nc">ModelConfig</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">QWEN_MODEL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">qwen2.5</span><span class="sh">"</span><span class="p">),</span>
                <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">QWEN_BASE_URL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
                <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">QWEN_API_KEY</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY</span><span class="sh">"</span><span class="p">),</span>
            <span class="p">),</span>
            <span class="n">caps</span><span class="o">=</span><span class="nc">ModelCapabilities</span><span class="p">(</span>
                <span class="n">supports_responses</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                <span class="n">supports_completions</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                <span class="n">preferred_plans</span><span class="o">=</span><span class="p">[(</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">nested</span><span class="sh">"</span><span class="p">)]</span>
            <span class="p">)</span>
        <span class="p">),</span>
        <span class="c1"># Example: responses-only vendor
</span>        <span class="sh">"</span><span class="s">resp_only</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelProfile</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="sh">"</span><span class="s">resp_only</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">cfg</span><span class="o">=</span><span class="nc">ModelConfig</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">RESP_ONLY_MODEL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">some-resp-model</span><span class="sh">"</span><span class="p">),</span>
                <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">RESP_ONLY_BASE_URL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
                <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">RESP_ONLY_API_KEY</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY</span><span class="sh">"</span><span class="p">),</span>
            <span class="p">),</span>
            <span class="n">caps</span><span class="o">=</span><span class="nc">ModelCapabilities</span><span class="p">(</span>
                <span class="n">supports_responses</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                <span class="n">supports_completions</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                <span class="n">preferred_plans</span><span class="o">=</span><span class="p">[(</span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">flat</span><span class="sh">"</span><span class="p">)]</span>
            <span class="p">)</span>
        <span class="p">),</span>
        <span class="c1"># Example: completions-only vendor
</span>        <span class="sh">"</span><span class="s">chat_only</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelProfile</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="sh">"</span><span class="s">chat_only</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">cfg</span><span class="o">=</span><span class="nc">ModelConfig</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">CHAT_ONLY_MODEL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">some-chat-model</span><span class="sh">"</span><span class="p">),</span>
                <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">CHAT_ONLY_BASE_URL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
                <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">CHAT_ONLY_API_KEY</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY</span><span class="sh">"</span><span class="p">),</span>
            <span class="p">),</span>
            <span class="n">caps</span><span class="o">=</span><span class="nc">ModelCapabilities</span><span class="p">(</span>
                <span class="n">supports_responses</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                <span class="n">supports_completions</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                <span class="n">preferred_plans</span><span class="o">=</span><span class="p">[(</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">nested</span><span class="sh">"</span><span class="p">)]</span>
            <span class="p">)</span>
        <span class="p">),</span>
    <span class="p">}</span>

<span class="c1"># ============================================================
# Main (async) with signal-based interrupt wiring
# ============================================================
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">amain</span><span class="p">():</span>
    <span class="kn">import</span> <span class="n">argparse</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="nc">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Async flexible orchestrator (plain text + tool calling).</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--model-key</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt_like</span><span class="sh">"</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">Pick from catalog: gpt_like, qwen_like, resp_only, chat_only</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--task</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">List files under ./samples, pick a text file, read it, and return a 2-3 sentence summary. Use tools if needed.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--samples</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">./samples</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="nf">parse_args</span><span class="p">()</span>

    <span class="c1"># Build tool registry (you can scope tools per model if required)
</span>    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">samples</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="nf">build_default_registry</span><span class="p">()</span>

    <span class="c1"># Build catalog and orchestrator
</span>    <span class="n">catalog</span> <span class="o">=</span> <span class="nf">build_catalog</span><span class="p">()</span>
    <span class="n">interrupt</span> <span class="o">=</span> <span class="nc">UserInterruptController</span><span class="p">()</span>

    <span class="c1"># OS signal → user interrupt (Ctrl+C)
</span>    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_running_loop</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">loop</span><span class="p">.</span><span class="nf">add_signal_handler</span><span class="p">(</span><span class="n">signal</span><span class="p">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">interrupt</span><span class="p">.</span><span class="n">trigger</span><span class="p">)</span>
        <span class="n">loop</span><span class="p">.</span><span class="nf">add_signal_handler</span><span class="p">(</span><span class="n">signal</span><span class="p">.</span><span class="n">SIGTERM</span><span class="p">,</span> <span class="n">interrupt</span><span class="p">.</span><span class="n">trigger</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">NotImplementedError</span><span class="p">:</span>
        <span class="c1"># add_signal_handler may not be available on some platforms (e.g., Windows in some envs)
</span>        <span class="k">pass</span>

    <span class="n">orch</span> <span class="o">=</span> <span class="nc">Orchestrator</span><span class="p">(</span><span class="n">catalog</span><span class="p">,</span> <span class="n">tools</span><span class="p">,</span> <span class="n">interrupt</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="n">orch</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">model_key</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">task</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">=== FINAL OUTPUT ===</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">out</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">(empty)</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">UserCancelledError</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">=== INTERRUPTED ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">=== ERROR ===</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">amain</span><span class="p">())</span>
</code></pre></div></div>

<p>확장 방법</p>

<ul>
  <li>
    <p>새 모델 추가: build_catalog()에 ModelProfile 한 줄만 추가. preferred_plans가 비어도 Orchestrator가 기본 순서대로 시도.</p>
  </li>
  <li>
    <p>툴 추가: ToolRegistry.register(…)만 호출. 파라미터 스키마와 함수 구현을 붙이면 자동으로 모든 전략에서 사용.</p>
  </li>
  <li>
    <p>인터럽트 연동: UI 스레드에서 interrupt.trigger()를 호출하거나, UserInterruptController를 구현해 processing_interrupted()가 True를 반환하도록 만들면 된다.</p>
  </li>
  <li>
    <p>로깅/메트릭/리트라이: call_with_interrupt()나 각 ProtocolStrategy.run() 내부에 쉽게 주입 가능.</p>
  </li>
</ul>

<p class="chat--user">

responses와 completions에서 parameter 넣는 방식은 똑같아? 예를 들어 reasoning_effort나 max_tokens 같은 것들

</p>

<p>짧은 답: 완전히 같지 않아. 공통 파라미터도 있지만, 길이·추론 제어 계열은 엔드포인트마다 이름이 다르다.</p>

<p>핵심 정리</p>

<ul>
  <li>
    <p>출력 길이 상한</p>

    <ul>
      <li>
        <p>Responses API: max_output_tokens 사용. <a href="https://platform.openai.com/docs/api-reference/realtime-server-events/response?_ga=2.241776386.1079907819.1650361546-70707626.1649909918&amp;_ga=2.36908453.440971442.1659710882-965169732.1659710882">OpenAI 플랫폼</a></p>
      </li>
      <li>
        <p>Chat Completions: 모델에 따라 다름</p>

        <ul>
          <li>
            <p>추론형(o*, GPT-5 계열 등): max_completion_tokens 권장</p>
          </li>
          <li>
            <p>일반 채팅 모델: 기존 max_tokens<br />
실제로 서로 바꿔 쓰면 무시되거나 에러가 난다. 공식 Chat API 문서는 max_tokens 계열을, Responses/Realtime 쪽 문서는 max_output_tokens를 각각 다룬다. <a href="https://platform.openai.com/docs/api-reference/introduction?utm_source=chatgpt.com">OpenAI 플랫폼+1</a></p>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <p>추론 강도(“얼마나 깊게 생각할지”)</p>

    <ul>
      <li>
        <table>
          <tbody>
            <tr>
              <td>최신 가이드라인은 reasoning 객체 아래 effort 필드를 쓰는 형태가 표준이다. 예: reasoning={"effort": "low</td>
              <td>medium</td>
              <td>high"} 또는 일부 최신 모델에서 "minimal" 추가. 두 엔드포인트 모두 같은 모양으로 붙이되, 모델이 지원할 때만 적용된다. <a href="https://platform.openai.com/docs/guides/reasoning?utm_source=chatgpt.com">OpenAI 플랫폼</a></td>
            </tr>
          </tbody>
        </table>
      </li>
    </ul>
  </li>
  <li>
    <p>그 외 공통으로 거의 동일하게 쓰는 것<br />
temperature, top_p, stop, tools 정의 자체 등은 두 엔드포인트 모두 유사하게 동작한다. 차이는 메시지 컨테이너가 responses는 input, chat completions는 messages라는 점 정도다. <a href="https://platform.openai.com/docs/api-reference/introduction?utm_source=chatgpt.com">OpenAI 플랫폼</a></p>
  </li>
</ul>

<p>권장 사용 패턴</p>

<ul>
  <li>
    <p>Responses API 예시</p>

    <ul>
      <li>
        <p>max_output_tokens와 reasoning.effort를 함께 설정</p>
      </li>
      <li>
        <p>메시지는 input=[{role, content}, …]</p>
      </li>
    </ul>
  </li>
  <li>
    <p>Chat Completions 예시</p>

    <ul>
      <li>
        <p>추론 모델이면 max_completion_tokens 사용, 일반 모델이면 max_tokens</p>
      </li>
      <li>
        <p>메시지는 messages=[{role, content}, …]</p>
      </li>
      <li>
        <p>reasoning.effort는 지원 모델에서만</p>
      </li>
    </ul>
  </li>
</ul>

<p>간단 예시</p>

<p>Python, Responses API</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-5-mini</span><span class="sh">"</span><span class="p">,</span>
    <span class="nb">input</span><span class="o">=</span><span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">요약해줘</span><span class="sh">"</span><span class="p">}],</span>
    <span class="n">max_output_tokens</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span>
    <span class="n">reasoning</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">effort</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">medium</span><span class="sh">"</span><span class="p">},</span>
    <span class="n">tools</span><span class="o">=</span><span class="p">[{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:{...}}],</span>
<span class="p">)</span>
</code></pre></div></div>

<p>Python, Chat Completions</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">o3-mini</span><span class="sh">"</span><span class="p">,</span>  <span class="c1"># 추론형 모델
</span>    <span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">요약해줘</span><span class="sh">"</span><span class="p">}],</span>
    <span class="n">max_completion_tokens</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span>   <span class="c1"># 추론형이면 이걸 사용
</span>    <span class="n">reasoning</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">effort</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">medium</span><span class="sh">"</span><span class="p">},</span>
    <span class="n">tools</span><span class="o">=</span><span class="p">[{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:{...}}}],</span>
<span class="p">)</span>
<span class="c1"># 일반 채팅 모델이라면 max_tokens를 사용
</span></code></pre></div></div>

<p>요약 체크리스트</p>

<ul>
  <li>
    <p>Responses → max_output_tokens</p>
  </li>
  <li>
    <p>Chat Completions → 추론형: max_completion_tokens / 일반: max_tokens</p>
  </li>
  <li>
    <p>reasoning.effort는 모델이 지원할 때만 적용</p>
  </li>
  <li>
    <p>공통 파라미터(temperature, top_p, stop 등)는 거의 동일하고, 컨테이너만 input vs messages가 다름</p>
  </li>
</ul>

<p>참고 문서</p>

<ul>
  <li>
    <p>Chat Completions API 레퍼런스(파라미터 전반, messages 등). <a href="https://platform.openai.com/docs/api-reference/introduction?utm_source=chatgpt.com">OpenAI 플랫폼</a></p>
  </li>
  <li>
    <p>Reasoning 가이드(추론 모델과 effort 개념). <a href="https://platform.openai.com/docs/guides/reasoning?utm_source=chatgpt.com">OpenAI 플랫폼</a></p>
  </li>
  <li>
    <p>Realtime/Responses 계열에서 max_output_tokens 명시. <a href="https://platform.openai.com/docs/api-reference/realtime-server-events/response?_ga=2.241776386.1079907819.1650361546-70707626.1649909918&amp;_ga=2.36908453.440971442.1659710882-965169732.1659710882">OpenAI 플랫폼</a></p>
  </li>
</ul>

<p class="chat--user">

왜 이렇게 api를 짜증나게 만들었을까

</p>

<p>그 마음 100% 이해해. 엔드포인트마다 이름이 미묘하게 다르고, 모델마다 지원/비지원이 달라서 매번 “이건 max_output_tokens였지? 아니면 max_tokens였나…?” 하게 만들죠.</p>

<p>왜 이런 일이 생기냐(현실적인 배경)</p>

<ol>
  <li>
    <p>레거시와 진화가 동시에 굴러감<br />
초기 Chat Completions의 설계가 이미 광범위하게 쓰인 뒤, Responses 계열이 “더 범용(멀티모달·툴·스트리밍·상태전달)” 관점으로 나왔어요. 과거 API를 깨지 않으려니 파라미터/컨테이너 이름이 달라졌습니다.</p>
  </li>
  <li>
    <p>모델 계열별 제약이 달라요<br />
“추론형(reasoning) 모델”은 토큰·추론깊이 제어가 별도라 max_completion_tokens, reasoning.effort 같은 필드가 추가되고, 일반 채팅 모델과 동작이 달라요.</p>
  </li>
  <li>
    <p>안전·비용·속도 정책이 독립적으로 변함<br />
각 엔드포인트가 검열·중단·비용제어 사양을 따로 발전시키다 보니 교집합이 어긋납니다.</p>
  </li>
  <li>
    <p>도구(tool) 생태계의 빠른 변화<br />
함수 호출 스키마가 “nested” → “flat”로, 혹은 strict 모드 추가처럼 사용성 개선을 반복하면서 예시와 실제가 엇갈리는 시기가 생겨요.</p>
  </li>
</ol>

<p>그래서 어떻게 덜 짜증나게 쓰냐(실전 팁)</p>

<ol>
  <li>
    <p>어댑터 + 전략 패턴으로 API 차이를 가둬두기<br />
호출부엔 “내가 원하는 공통 파라미터”만 쓰고, 엔드포인트별로 맞는 실제 파라미터로 변환하는 얇은 레이어를 둡니다.</p>
  </li>
  <li>
    <p>파라미터 정규화기(Parameter Normalizer)<br />
length, temp, top_p, stop, reasoning_effort 같은 “중립 이름”을 입력받아 completions/responses/모델종류에 맞춰 매핑합니다.</p>
  </li>
  <li>
    <p>툴 스키마 빌더<br />
동일한 ToolRegistry를 두고, “flat”과 “nested” 스키마로 빌드만 갈라서 뿌립니다.</p>
  </li>
  <li>
    <p>기능 감지와 폴백<br />
모델 프로필에 capabilities를 선언하고, 우선 시도할 조합 목록을 정해 실패 시 다음 조합으로 자동 폴백합니다.</p>
  </li>
  <li>
    <p>계약 테스트(작은 매트릭스 러너)<br />
대표 프롬프트 하나로 “모델×프로토콜×툴스키마×파라미터세트”를 돌려 빨갛게 실패하는 조합을 미리 파악해둡니다.</p>
  </li>
</ol>

<p>아래는 “딱 이것만” 넣으면 스트레스가 급감하는 최소 어댑터 예시야. 비동기 기준, 호출부는 공통 파라미터만 건네고 내부에서 알아서 매핑합니다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># adapters.py
</span><span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>

<span class="k">def</span> <span class="nf">build_tools_flat</span><span class="p">(</span><span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="c1"># input tools: [{"name", "description", "parameters"}]
</span>    <span class="k">return</span> <span class="p">[{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="o">**</span><span class="n">t</span><span class="p">}</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">build_tools_nested</span><span class="p">(</span><span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="k">return</span> <span class="p">[{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">}</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">ParamNormalizer</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Normalize neutral params -&gt; endpoint-specific params.
    neutral:
      - length (int): desired max tokens
      - temperature (float), top_p (float), stop (list[str])
      - reasoning_effort (None|</span><span class="sh">"</span><span class="s">low</span><span class="sh">"</span><span class="s">|</span><span class="sh">"</span><span class="s">medium</span><span class="sh">"</span><span class="s">|</span><span class="sh">"</span><span class="s">high</span><span class="sh">"</span><span class="s">)
      - tool_json_style (</span><span class="sh">"</span><span class="s">flat</span><span class="sh">"</span><span class="s">|</span><span class="sh">"</span><span class="s">nested</span><span class="sh">"</span><span class="s">)
    endpoint:
      - responses: max_output_tokens, input, tools(flat)
      - completions: max_completion_tokens or max_tokens, messages, tools(nested)
    </span><span class="sh">"""</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">for_responses</span><span class="p">(</span>
        <span class="n">neutral</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>  <span class="c1"># [{role, content}]
</span>        <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>     <span class="c1"># normalized {"name", "description", "parameters"}
</span>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="nf">build_tools_flat</span><span class="p">(</span><span class="n">tools</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="nf">if </span><span class="p">(</span><span class="n">L</span> <span class="p">:</span><span class="o">=</span> <span class="n">neutral</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">length</span><span class="sh">"</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">max_output_tokens</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">L</span><span class="p">)</span>
        <span class="nf">if </span><span class="p">(</span><span class="n">t</span> <span class="p">:</span><span class="o">=</span> <span class="n">neutral</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">temperature</span><span class="sh">"</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">temperature</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="nf">if </span><span class="p">(</span><span class="n">p</span> <span class="p">:</span><span class="o">=</span> <span class="n">neutral</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">top_p</span><span class="sh">"</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">top_p</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="nf">if </span><span class="p">(</span><span class="n">st</span> <span class="p">:</span><span class="o">=</span> <span class="n">neutral</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">stop</span><span class="sh">"</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">stop</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">st</span>
        <span class="nf">if </span><span class="p">(</span><span class="n">eff</span> <span class="p">:</span><span class="o">=</span> <span class="n">neutral</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">reasoning_effort</span><span class="sh">"</span><span class="p">)):</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">reasoning</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">effort</span><span class="sh">"</span><span class="p">:</span> <span class="n">eff</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">for_completions</span><span class="p">(</span>
        <span class="n">neutral</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">is_reasoning_model</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="nf">build_tools_nested</span><span class="p">(</span><span class="n">tools</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="c1"># token cap
</span>        <span class="nf">if </span><span class="p">(</span><span class="n">L</span> <span class="p">:</span><span class="o">=</span> <span class="n">neutral</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">length</span><span class="sh">"</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">max_completion_tokens</span><span class="sh">"</span> <span class="k">if</span> <span class="n">is_reasoning_model</span> <span class="k">else</span> <span class="sh">"</span><span class="s">max_tokens</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">L</span><span class="p">)</span>
        <span class="c1"># common
</span>        <span class="nf">if </span><span class="p">(</span><span class="n">t</span> <span class="p">:</span><span class="o">=</span> <span class="n">neutral</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">temperature</span><span class="sh">"</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">temperature</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="nf">if </span><span class="p">(</span><span class="n">p</span> <span class="p">:</span><span class="o">=</span> <span class="n">neutral</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">top_p</span><span class="sh">"</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">top_p</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="nf">if </span><span class="p">(</span><span class="n">st</span> <span class="p">:</span><span class="o">=</span> <span class="n">neutral</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">stop</span><span class="sh">"</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">stop</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">st</span>
        <span class="c1"># reasoning
</span>        <span class="nf">if </span><span class="p">(</span><span class="n">eff</span> <span class="p">:</span><span class="o">=</span> <span class="n">neutral</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">reasoning_effort</span><span class="sh">"</span><span class="p">))</span> <span class="ow">and</span> <span class="n">is_reasoning_model</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">reasoning</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">effort</span><span class="sh">"</span><span class="p">:</span> <span class="n">eff</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">out</span>
</code></pre></div></div>

<p>간단 사용 예시(비동기):</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># use_case.py
</span><span class="kn">import</span> <span class="n">httpx</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">AsyncOpenAI</span>
<span class="kn">from</span> <span class="n">adapters</span> <span class="kn">import</span> <span class="n">ParamNormalizer</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_responses</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Be helpful.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List ./samples and summarize one file.</span><span class="sh">"</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{...}},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{...}},</span>
    <span class="p">]</span>
    <span class="n">neutral</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">reasoning_effort</span><span class="o">=</span><span class="sh">"</span><span class="s">medium</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">ParamNormalizer</span><span class="p">.</span><span class="nf">for_responses</span><span class="p">(</span><span class="n">neutral</span><span class="p">,</span> <span class="n">messages</span><span class="p">,</span> <span class="n">tools</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">with</span> <span class="n">httpx</span><span class="p">.</span><span class="nc">AsyncClient</span><span class="p">()</span> <span class="k">as</span> <span class="n">http_client</span><span class="p">:</span>
        <span class="k">async</span> <span class="k">with</span> <span class="nc">AsyncOpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span> <span class="n">http_client</span><span class="o">=</span><span class="n">http_client</span><span class="p">)</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">,</span> <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">r</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_completions</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">is_reasoning_model</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Be helpful.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List ./samples and summarize one file.</span><span class="sh">"</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{...}},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{...}},</span>
    <span class="p">]</span>
    <span class="n">neutral</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">reasoning_effort</span><span class="o">=</span><span class="sh">"</span><span class="s">medium</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">ParamNormalizer</span><span class="p">.</span><span class="nf">for_completions</span><span class="p">(</span><span class="n">neutral</span><span class="p">,</span> <span class="n">messages</span><span class="p">,</span> <span class="n">tools</span><span class="p">,</span> <span class="n">is_reasoning_model</span><span class="o">=</span><span class="n">is_reasoning_model</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">with</span> <span class="n">httpx</span><span class="p">.</span><span class="nc">AsyncClient</span><span class="p">()</span> <span class="k">as</span> <span class="n">http_client</span><span class="p">:</span>
        <span class="k">async</span> <span class="k">with</span> <span class="nc">AsyncOpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span> <span class="n">http_client</span><span class="o">=</span><span class="n">http_client</span><span class="p">)</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">,</span> <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">r</span>
</code></pre></div></div>

<p>마이그레이션 체크리스트</p>

<ol>
  <li>
    <p>호출부엔 neutral 파라미터만 노출한다(length, temperature, reasoning_effort 등).</p>
  </li>
  <li>
    <p>엔진/모델 선택에 따라 ParamNormalizer가 실제 필드로 변환한다.</p>
  </li>
  <li>
    <p>모델 능력 플래그(예: is_reasoning_model)는 ModelProfile에 넣고 Orchestrator가 주입한다.</p>
  </li>
  <li>
    <p>실패 시 다른 Plan으로 폴백한다(Responses+flat → Completions+nested 같은 순서).</p>
  </li>
  <li>
    <p>계약 테스트를 CI에 넣어 눈으로 확인하기 전에 “어느 조합이 깨졌는지” 자동으로 경고받는다.</p>
  </li>
</ol>

<p>API의 불일치는 우리 잘못이 아니니, 작은 어댑터/전략 레이어로 “짜증”을 코드 경계 밖에 가둬두는 게 정답이에요. 이 레이어 한 번 만들어두면 새 모델 10개가 들어와도 호출부는 거의 손댈 일이 없어집니다.</p>

<p class="chat--user">

근데 너가 말한것도 못 믿겠어. 실제 내 서빙 환경과 api 패키지 설치 환경에서 테스트해봐야할 것 같아. 그런데 top_p 같은 것은 테스트해봐도 이게 반영이 된 건지 안 된 건지 내가 알 수가 있나?

</p>

<p>완전 공감. 파라미터가 “들어가긴 했는지, 모델이 실제로 반영했는지”는 말만으론 못 믿죠. 그래서 실제 서빙 환경에서 직접 검증하는 비동기 테스트 하네스를 줘요. 핵심은 두 축입니다.</p>

<ol>
  <li>
    <p>전송 검증: HTTP 요청 바디에 top_p, temperature 등이 실제로 포함되는지 로깅</p>
  </li>
  <li>
    <p>효과 검증: 동일 프롬프트로 여러 번 샘플링하여 top_p 스윕에 따라 출력 다양성이 통계적으로 달라지는지 확인</p>
  </li>
</ol>

<p>아래 코드는 둘 다 합니다. Responses와 Completions를 선택해 같은 방식으로 돌릴 수 있고, 각 top_p 구간에서 N회 샘플링하여 텍스트 다양성 지표를 계산합니다. logprobs 지원 모델이면 상위 토큰 분포도 같이 덤프해 “누클리어스 컷(top_p 이하 누적확률)” 영향도 간접 확인합니다. 모두 비동기 AsyncOpenAI + httpx.AsyncClient 사용, 이벤트 훅으로 실제 전송 JSON을 캡처합니다.</p>

<p>설명 요약</p>

<ul>
  <li>
    <p>전송 로깅: httpx 이벤트 훅에서 요청 JSON을 파싱해 주요 필드만 출력 및 파일 저장</p>
  </li>
  <li>
    <p>다양성 지표: 타입-토큰 비율(TTR), 평균 길이, 응답 쌍 간 3-그램 자카드 거리 평균</p>
  </li>
  <li>
    <p>스윕: 예) top_p ∈ {0.1, 0.3, 0.7, 0.95}, temperature 고정(예: 0.8), 각 구간 N회 샘플</p>
  </li>
  <li>
    <p>기대 패턴: top_p가 커질수록 평균 자카드 거리, TTR이 증가하는 경향. 전혀 변화가 없다면 모델/엔드포인트에서 파라미터가 무시되었을 가능성</p>
  </li>
  <li>
    <p>안전장치: Ctrl+C 등 인터럽트 시 즉시 중지</p>
  </li>
</ul>

<p>코드 전체</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># async_param_probe.py
# Python 3.10+
# pip install --upgrade openai httpx
</span>
<span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">math</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">signal</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">import</span> <span class="n">httpx</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">AsyncOpenAI</span>

<span class="c1"># =========================
# Interrupt support
# =========================
</span>
<span class="k">class</span> <span class="nc">UserCancelledError</span><span class="p">(</span><span class="nb">Exception</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Raised when the user has interrupted the processing.</span><span class="sh">"""</span>

<span class="k">class</span> <span class="nc">Interruptor</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Simple async interrupt flag that can be triggered by signals or UI.</span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_event</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Event</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">trigger</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_event</span><span class="p">.</span><span class="nf">set</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">processing_interrupted</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_event</span><span class="p">.</span><span class="nf">is_set</span><span class="p">()</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">call_with_interrupt</span><span class="p">(</span><span class="n">coro</span><span class="p">,</span> <span class="n">interrupt_cb</span><span class="p">,</span> <span class="n">poll</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Await a coroutine while polling interruption.</span><span class="sh">"""</span>
    <span class="n">task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="n">coro</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">({</span><span class="n">task</span><span class="p">},</span> <span class="n">timeout</span><span class="o">=</span><span class="n">poll</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">task</span><span class="p">.</span><span class="nf">result</span><span class="p">()</span>
            <span class="k">if</span> <span class="k">await</span> <span class="nf">interrupt_cb</span><span class="p">():</span>
                <span class="n">task</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">task</span>
                <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">raise</span> <span class="nc">UserCancelledError</span><span class="p">(</span><span class="sh">"</span><span class="s">Interrupted by user</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">raise</span>

<span class="c1"># =========================
# Request capture via httpx hooks
# =========================
</span>
<span class="k">class</span> <span class="nc">RequestCapture</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Capture outgoing JSON payloads for inspection.</span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">last_payload</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">self</span><span class="p">.</span><span class="n">all_payloads</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">get_hooks</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">async</span> <span class="k">def</span> <span class="nf">on_request</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">httpx</span><span class="p">.</span><span class="n">Request</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content-type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">).</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">):</span>
                    <span class="n">body</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">content</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">content</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)</span> <span class="k">else</span> <span class="n">request</span><span class="p">.</span><span class="n">content</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">body</span><span class="p">)</span> <span class="k">if</span> <span class="n">body</span> <span class="k">else</span> <span class="p">{}</span>
                    <span class="c1"># Keep only notable fields to keep logs readable
</span>                    <span class="n">filtered</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="n">request</span><span class="p">.</span><span class="n">url</span><span class="p">.</span><span class="n">path</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">),</span>
                        <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">),</span>
                        <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">),</span>
                        <span class="sh">"</span><span class="s">top_p</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">top_p</span><span class="sh">"</span><span class="p">),</span>
                        <span class="sh">"</span><span class="s">temperature</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">temperature</span><span class="sh">"</span><span class="p">),</span>
                        <span class="sh">"</span><span class="s">max_tokens</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">max_tokens</span><span class="sh">"</span><span class="p">),</span>
                        <span class="sh">"</span><span class="s">max_completion_tokens</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">max_completion_tokens</span><span class="sh">"</span><span class="p">),</span>
                        <span class="sh">"</span><span class="s">max_output_tokens</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">max_output_tokens</span><span class="sh">"</span><span class="p">),</span>
                        <span class="sh">"</span><span class="s">reasoning</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">reasoning</span><span class="sh">"</span><span class="p">),</span>
                        <span class="sh">"</span><span class="s">logprobs</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">logprobs</span><span class="sh">"</span><span class="p">),</span>
                        <span class="sh">"</span><span class="s">top_logprobs</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">top_logprobs</span><span class="sh">"</span><span class="p">),</span>
                        <span class="sh">"</span><span class="s">tool_choice</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_choice</span><span class="sh">"</span><span class="p">),</span>
                        <span class="sh">"</span><span class="s">response_format</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">response_format</span><span class="sh">"</span><span class="p">),</span>
                        <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">),</span>
                    <span class="p">}</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">last_payload</span> <span class="o">=</span> <span class="n">filtered</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">all_payloads</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">filtered</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="c1"># Best effort; never block the request
</span>                <span class="k">pass</span>

        <span class="k">async</span> <span class="k">def</span> <span class="nf">on_response</span><span class="p">(</span><span class="n">response</span><span class="p">:</span> <span class="n">httpx</span><span class="p">.</span><span class="n">Response</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">on_request</span><span class="p">],</span> <span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">on_response</span><span class="p">]}</span>

<span class="c1"># =========================
# Diversity metrics
# =========================
</span>
<span class="k">def</span> <span class="nf">tokenize_words</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">w</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="sh">""</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">c</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nf">isalnum</span><span class="p">()</span> <span class="k">else</span> <span class="sh">"</span><span class="s"> </span><span class="sh">"</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">text</span><span class="p">]).</span><span class="nf">split</span><span class="p">()</span> <span class="k">if</span> <span class="n">w</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">ngrams</span><span class="p">(</span><span class="n">tokens</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="p">...]]:</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nf">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="k">return</span> <span class="p">[</span><span class="nf">tuple</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">n</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span><span class="o">-</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>

<span class="k">def</span> <span class="nf">jaccard</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="p">...]],</span> <span class="n">b</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="p">...]])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">b</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0</span>
    <span class="n">sa</span><span class="p">,</span> <span class="n">sb</span> <span class="o">=</span> <span class="nf">set</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="nf">set</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="n">inter</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">sa</span> <span class="o">&amp;</span> <span class="n">sb</span><span class="p">)</span>
    <span class="n">union</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">sa</span> <span class="o">|</span> <span class="n">sb</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="n">inter</span> <span class="o">/</span> <span class="n">union</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">ttr</span><span class="p">(</span><span class="n">tokens</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">tokens</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0</span>
    <span class="k">return</span> <span class="nf">len</span><span class="p">(</span><span class="nf">set</span><span class="p">(</span><span class="n">tokens</span><span class="p">))</span> <span class="o">/</span> <span class="nf">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">pairwise_avg_jaccard</span><span class="p">(</span><span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">grams</span> <span class="o">=</span> <span class="p">[</span><span class="nf">ngrams</span><span class="p">(</span><span class="nf">tokenize_words</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">texts</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">texts</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">texts</span><span class="p">)):</span>
            <span class="n">total</span> <span class="o">+=</span> <span class="nf">jaccard</span><span class="p">(</span><span class="n">grams</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">grams</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">total</span> <span class="o">/</span> <span class="nf">max</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">summarize_diversity</span><span class="p">(</span><span class="n">samples</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">toks</span> <span class="o">=</span> <span class="p">[</span><span class="nf">tokenize_words</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">samples</span><span class="p">]</span>
    <span class="n">lengths</span> <span class="o">=</span> <span class="p">[</span><span class="nf">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">toks</span><span class="p">]</span>
    <span class="n">ttrs</span> <span class="o">=</span> <span class="p">[</span><span class="nf">ttr</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">toks</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">num_samples</span><span class="sh">"</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">samples</span><span class="p">),</span>
        <span class="sh">"</span><span class="s">avg_len_tokens</span><span class="sh">"</span><span class="p">:</span> <span class="nf">round</span><span class="p">(</span><span class="nf">sum</span><span class="p">(</span><span class="n">lengths</span><span class="p">)</span> <span class="o">/</span> <span class="nf">max</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">lengths</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">2</span><span class="p">),</span>
        <span class="sh">"</span><span class="s">avg_ttr</span><span class="sh">"</span><span class="p">:</span> <span class="nf">round</span><span class="p">(</span><span class="nf">sum</span><span class="p">(</span><span class="n">ttrs</span><span class="p">)</span> <span class="o">/</span> <span class="nf">max</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">ttrs</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">4</span><span class="p">),</span>
        <span class="sh">"</span><span class="s">pairwise_jaccard_3gram</span><span class="sh">"</span><span class="p">:</span> <span class="nf">round</span><span class="p">(</span><span class="nf">pairwise_avg_jaccard</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="mi">4</span><span class="p">),</span>
        <span class="sh">"</span><span class="s">pairwise_jaccard_2gram</span><span class="sh">"</span><span class="p">:</span> <span class="nf">round</span><span class="p">(</span><span class="nf">pairwise_avg_jaccard</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">4</span><span class="p">),</span>
        <span class="sh">"</span><span class="s">unique_ratio</span><span class="sh">"</span><span class="p">:</span> <span class="nf">round</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="nf">set</span><span class="p">(</span><span class="n">samples</span><span class="p">))</span> <span class="o">/</span> <span class="nf">max</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">samples</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">4</span><span class="p">),</span>
    <span class="p">}</span>

<span class="c1"># =========================
# Probers
# =========================
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ProbeConfig</span><span class="p">:</span>
    <span class="n">model</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">protocol</span><span class="p">:</span> <span class="nb">str</span>                  <span class="c1"># "responses" | "completions"
</span>    <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">temperature</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span>
    <span class="n">top_p_grid</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="p">...]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">)</span>
    <span class="n">samples_per_setting</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span>
    <span class="n">request_log_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">./probe_logs</span><span class="sh">"</span>
    <span class="n">use_logprobs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span>      <span class="c1"># Only for completions if model supports it
</span>
<span class="k">def</span> <span class="nf">sanitize_filename</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="sh">""</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">c</span> <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nf">isalnum</span><span class="p">()</span> <span class="ow">or</span> <span class="n">c</span> <span class="ow">in</span> <span class="sh">"</span><span class="s">-_.</span><span class="sh">"</span> <span class="k">else</span> <span class="sh">"</span><span class="s">_</span><span class="sh">"</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">s</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">sample_once_responses</span><span class="p">(</span><span class="n">client</span><span class="p">:</span> <span class="n">AsyncOpenAI</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">temperature</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">top_p</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">r</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">client</span><span class="p">.</span><span class="n">_client</span><span class="p">.</span><span class="n">_base_url</span><span class="p">,</span>  <span class="c1"># wrong; fix below
</span>    <span class="p">)</span>
    <span class="c1"># We will implement properly in the caller using **params normalization; keep explicit here.
</span>    <span class="k">raise</span> <span class="nc">NotImplementedError</span><span class="p">(</span><span class="sh">"</span><span class="s">Use run_responses_batch; do not call directly.</span><span class="sh">"</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_responses_batch</span><span class="p">(</span><span class="n">client</span><span class="p">:</span> <span class="n">AsyncOpenAI</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">temperature</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">top_p</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">interrupt</span><span class="p">:</span> <span class="n">Interruptor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">input_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Be helpful and concise.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">prompt</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">call_with_interrupt</span><span class="p">(</span>
        <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">client</span><span class="p">.</span><span class="n">_client</span><span class="p">.</span><span class="n">_headers</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">x-stainless-model</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">unknown-model</span><span class="sh">"</span><span class="p">,</span>
            <span class="c1"># The AsyncOpenAI SDK requires model at call-site; we provide it via partial elsewhere.
</span>        <span class="p">),</span>
        <span class="n">interrupt</span><span class="p">.</span><span class="n">processing_interrupted</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">resp</span><span class="p">.</span><span class="n">output_text</span> <span class="ow">or</span> <span class="sh">""</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_completions_batch</span><span class="p">(</span><span class="n">client</span><span class="p">:</span> <span class="n">AsyncOpenAI</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">temperature</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">top_p</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">use_logprobs</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">interrupt</span><span class="p">:</span> <span class="n">Interruptor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">call_with_interrupt</span><span class="p">(</span>
        <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">messages</span><span class="o">=</span><span class="p">[</span>
                <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Be helpful and concise.</span><span class="sh">"</span><span class="p">},</span>
                <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">prompt</span><span class="p">},</span>
            <span class="p">],</span>
            <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">,</span>
            <span class="n">top_p</span><span class="o">=</span><span class="n">top_p</span><span class="p">,</span>
            <span class="c1"># Logprobs is model-dependent; if unsupported it will raise. Handle at caller.
</span>            <span class="o">**</span><span class="p">({</span><span class="sh">"</span><span class="s">logprobs</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">top_logprobs</span><span class="sh">"</span><span class="p">:</span> <span class="mi">5</span><span class="p">}</span> <span class="k">if</span> <span class="n">use_logprobs</span> <span class="k">else</span> <span class="p">{}),</span>
        <span class="p">),</span>
        <span class="n">interrupt</span><span class="p">.</span><span class="n">processing_interrupted</span>
    <span class="p">)</span>
    <span class="n">out_text</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span>
    <span class="n">out_logprobs</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="sh">"</span><span class="s">logprobs</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">out_text</span><span class="p">,</span> <span class="sh">"</span><span class="s">logprobs</span><span class="sh">"</span><span class="p">:</span> <span class="n">out_logprobs</span><span class="p">}</span>

<span class="c1"># =========================
# Runner
# =========================
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">run_probe</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">ProbeConfig</span><span class="p">,</span> <span class="n">interrupt</span><span class="p">:</span> <span class="n">Interruptor</span><span class="p">):</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="n">request_log_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">capture</span> <span class="o">=</span> <span class="nc">RequestCapture</span><span class="p">()</span>
    <span class="n">hooks</span> <span class="o">=</span> <span class="n">capture</span><span class="p">.</span><span class="nf">get_hooks</span><span class="p">()</span>

    <span class="c1"># Build AsyncOpenAI client with httpx hooks
</span>    <span class="k">async</span> <span class="k">with</span> <span class="n">httpx</span><span class="p">.</span><span class="nc">AsyncClient</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">httpx</span><span class="p">.</span><span class="nc">Timeout</span><span class="p">(</span><span class="mf">60.0</span><span class="p">),</span> <span class="n">event_hooks</span><span class="o">=</span><span class="n">hooks</span><span class="p">)</span> <span class="k">as</span> <span class="n">http_client</span><span class="p">:</span>
        <span class="k">async</span> <span class="k">with</span> <span class="nc">AsyncOpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">,</span> <span class="n">http_client</span><span class="o">=</span><span class="n">http_client</span><span class="p">)</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
            <span class="n">results</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">if</span> <span class="n">cfg</span><span class="p">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">:</span>
                <span class="c1"># For Responses we construct the call per-sample to vary top_p.
</span>                <span class="k">for</span> <span class="n">tp</span> <span class="ow">in</span> <span class="n">cfg</span><span class="p">.</span><span class="n">top_p_grid</span><span class="p">:</span>
                    <span class="k">await</span> <span class="nf">_guard</span><span class="p">(</span><span class="n">interrupt</span><span class="p">)</span>
                    <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="n">samples_per_setting</span><span class="p">):</span>
                        <span class="k">await</span> <span class="nf">_guard</span><span class="p">(</span><span class="n">interrupt</span><span class="p">)</span>
                        <span class="n">r</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">call_with_interrupt</span><span class="p">(</span>
                            <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                                <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">model</span><span class="p">,</span>
                                <span class="nb">input</span><span class="o">=</span><span class="p">[</span>
                                    <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Be helpful and concise.</span><span class="sh">"</span><span class="p">},</span>
                                    <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">cfg</span><span class="p">.</span><span class="n">prompt</span><span class="p">},</span>
                                <span class="p">],</span>
                                <span class="n">temperature</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">temperature</span><span class="p">,</span>
                                <span class="n">top_p</span><span class="o">=</span><span class="n">tp</span><span class="p">,</span>
                            <span class="p">),</span>
                            <span class="n">interrupt</span><span class="p">.</span><span class="n">processing_interrupted</span>
                        <span class="p">)</span>
                        <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">output_text</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">)</span>
                    <span class="n">stats</span> <span class="o">=</span> <span class="nf">summarize_diversity</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span>
                    <span class="n">results</span><span class="p">[</span><span class="sa">f</span><span class="sh">"</span><span class="s">top_p=</span><span class="si">{</span><span class="n">tp</span><span class="si">}</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">samples</span><span class="sh">"</span><span class="p">:</span> <span class="n">texts</span><span class="p">,</span> <span class="sh">"</span><span class="s">stats</span><span class="sh">"</span><span class="p">:</span> <span class="n">stats</span><span class="p">}</span>
                    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[responses] top_p=</span><span class="si">{</span><span class="n">tp</span><span class="si">}</span><span class="s"> =&gt; </span><span class="si">{</span><span class="n">stats</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">cfg</span><span class="p">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">tp</span> <span class="ow">in</span> <span class="n">cfg</span><span class="p">.</span><span class="n">top_p_grid</span><span class="p">:</span>
                    <span class="k">await</span> <span class="nf">_guard</span><span class="p">(</span><span class="n">interrupt</span><span class="p">)</span>
                    <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">first_logprobs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="n">samples_per_setting</span><span class="p">):</span>
                        <span class="k">await</span> <span class="nf">_guard</span><span class="p">(</span><span class="n">interrupt</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">run_completions_batch</span><span class="p">(</span>
                                <span class="n">client</span><span class="p">,</span> <span class="n">cfg</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="n">cfg</span><span class="p">.</span><span class="n">prompt</span><span class="p">,</span> <span class="n">cfg</span><span class="p">.</span><span class="n">temperature</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="n">use_logprobs</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">use_logprobs</span> <span class="ow">and</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">interrupt</span><span class="o">=</span><span class="n">interrupt</span>
                            <span class="p">)</span>
                            <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">])</span>
                            <span class="k">if</span> <span class="n">first_logprobs</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                                <span class="n">first_logprobs</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">logprobs</span><span class="sh">"</span><span class="p">]</span>
                        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="c1"># Fallback if logprobs not supported or param rejected
</span>                            <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">run_completions_batch</span><span class="p">(</span>
                                <span class="n">client</span><span class="p">,</span> <span class="n">cfg</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="n">cfg</span><span class="p">.</span><span class="n">prompt</span><span class="p">,</span> <span class="n">cfg</span><span class="p">.</span><span class="n">temperature</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="n">use_logprobs</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">interrupt</span><span class="o">=</span><span class="n">interrupt</span>
                            <span class="p">)</span>
                            <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">])</span>
                            <span class="n">first_logprobs</span> <span class="o">=</span> <span class="bp">None</span>
                    <span class="n">stats</span> <span class="o">=</span> <span class="nf">summarize_diversity</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span>
                    <span class="n">results</span><span class="p">[</span><span class="sa">f</span><span class="sh">"</span><span class="s">top_p=</span><span class="si">{</span><span class="n">tp</span><span class="si">}</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">samples</span><span class="sh">"</span><span class="p">:</span> <span class="n">texts</span><span class="p">,</span> <span class="sh">"</span><span class="s">stats</span><span class="sh">"</span><span class="p">:</span> <span class="n">stats</span><span class="p">,</span> <span class="sh">"</span><span class="s">first_logprobs</span><span class="sh">"</span><span class="p">:</span> <span class="nf">_maybe_slim_logprobs</span><span class="p">(</span><span class="n">first_logprobs</span><span class="p">)}</span>
                    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[completions] top_p=</span><span class="si">{</span><span class="n">tp</span><span class="si">}</span><span class="s"> =&gt; </span><span class="si">{</span><span class="n">stats</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

            <span class="c1"># Persist request payloads and results
</span>            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="n">request_log_dir</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">requests_</span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">protocol</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="nf">sanitize_filename</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="n">model</span><span class="p">)</span><span class="si">}</span><span class="s">.json</span><span class="sh">"</span><span class="p">),</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">capture</span><span class="p">.</span><span class="n">all_payloads</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="n">request_log_dir</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">results_</span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">protocol</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="nf">sanitize_filename</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="n">model</span><span class="p">)</span><span class="si">}</span><span class="s">.json</span><span class="sh">"</span><span class="p">),</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">Saved logs under: </span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">request_log_dir</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Key check 1: Open requests_*.json to confirm top_p/temperature got sent.</span><span class="sh">"</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Key check 2: Inspect stats monotonicity across top_p grid. If flat, top_p may be ignored.</span><span class="sh">"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_maybe_slim_logprobs</span><span class="p">(</span><span class="n">lp</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Reduce logprobs payload size for storage, keeping only first 10 tokens.</span><span class="sh">"""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">lp</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">)</span> <span class="ow">and</span> <span class="n">lp</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
            <span class="c1"># OpenAI SDK returns a structured object; convert to dict and trim
</span>            <span class="n">d</span> <span class="o">=</span> <span class="n">lp</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span>
            <span class="k">if</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">d</span> <span class="ow">and</span> <span class="n">d</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">]:</span>
                <span class="n">d</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">][:</span><span class="mi">10</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">d</span>
        <span class="c1"># If already dict-like
</span>        <span class="k">return</span> <span class="n">lp</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">_guard</span><span class="p">(</span><span class="n">interrupt</span><span class="p">:</span> <span class="n">Interruptor</span><span class="p">):</span>
    <span class="k">if</span> <span class="k">await</span> <span class="n">interrupt</span><span class="p">.</span><span class="nf">processing_interrupted</span><span class="p">():</span>
        <span class="k">raise</span> <span class="nc">UserCancelledError</span><span class="p">(</span><span class="sh">"</span><span class="s">Interrupted by user</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># =========================
# CLI
# =========================
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">amain</span><span class="p">():</span>
    <span class="kn">import</span> <span class="n">argparse</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="nc">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Async parameter probe for top_p/temperature (Responses or Completions).</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--protocol</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--model</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_MODEL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">))</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--base-url</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">))</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--api-key</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY</span><span class="sh">"</span><span class="p">))</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--prompt</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">Write a two-sentence review of a fictional cafe. Be creative.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--temperature</span><span class="sh">"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--top-p</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">0.1,0.3,0.7,0.95</span><span class="sh">"</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">Comma-separated values to sweep.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--n</span><span class="sh">"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">Samples per setting.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--logdir</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">./probe_logs</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--no-logprobs</span><span class="sh">"</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="sh">"</span><span class="s">store_true</span><span class="sh">"</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">Disable logprobs even if supported (completions only).</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="nf">parse_args</span><span class="p">()</span>

    <span class="n">interrupt</span> <span class="o">=</span> <span class="nc">Interruptor</span><span class="p">()</span>
    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_running_loop</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">loop</span><span class="p">.</span><span class="nf">add_signal_handler</span><span class="p">(</span><span class="n">signal</span><span class="p">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">interrupt</span><span class="p">.</span><span class="n">trigger</span><span class="p">)</span>
        <span class="n">loop</span><span class="p">.</span><span class="nf">add_signal_handler</span><span class="p">(</span><span class="n">signal</span><span class="p">.</span><span class="n">SIGTERM</span><span class="p">,</span> <span class="n">interrupt</span><span class="p">.</span><span class="n">trigger</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">NotImplementedError</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="n">cfg</span> <span class="o">=</span> <span class="nc">ProbeConfig</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">model</span><span class="p">,</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">api_key</span><span class="p">,</span>
        <span class="n">protocol</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">protocol</span><span class="p">,</span>
        <span class="n">prompt</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">prompt</span><span class="p">,</span>
        <span class="n">temperature</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">temperature</span><span class="p">,</span>
        <span class="n">top_p_grid</span><span class="o">=</span><span class="nf">tuple</span><span class="p">(</span><span class="nf">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">args</span><span class="p">.</span><span class="n">top_p</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="p">)),</span>
        <span class="n">samples_per_setting</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">n</span><span class="p">,</span>
        <span class="n">request_log_dir</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">logdir</span><span class="p">,</span>
        <span class="n">use_logprobs</span><span class="o">=</span><span class="ow">not</span> <span class="n">args</span><span class="p">.</span><span class="n">no_logprobs</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Build client and run
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="k">await</span> <span class="nf">run_probe</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">interrupt</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">UserCancelledError</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">Interrupted by user.</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">ERROR:</span><span class="sh">"</span><span class="p">,</span> <span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">amain</span><span class="p">())</span>
</code></pre></div></div>

<p>어떻게 해석하면 되나</p>

<ol>
  <li>
    <p>requests__.json을 열어 실제 요청 바디에 top_p, temperature, max__ 가 들어갔는지 먼저 확인합니다. 이건 “전송은 됐다”를 보장합니다.</p>
  </li>
  <li>
    <p>results_*.json의 stats를 봅니다. top_p가 커질수록 pairwise_jaccard_3gram, avg_ttr, unique_ratio가 보통 증가합니다. 변동이 거의 없다면 모델이 top_p를 무시하는지, temperature가 너무 낮은지, 프롬프트가 지나치게 결정적인지(사실상 한 가지 답) 점검하세요.</p>
  </li>
  <li>
    <p>Completions에서 logprobs가 지원되면 first_logprobs로 토큰 후보와 확률이 들어옵니다. top_p가 낮을 때는 상위 토큰에 확률 질량이 더 집중되는 경향을 간접적으로 볼 수 있습니다. 지원 안 되면 코드가 자동으로 끄고 진행합니다.</p>
  </li>
</ol>

<p>실험 팁</p>

<ul>
  <li>
    <p>temperature를 0.7~0.9 정도로 두고 top_p를 스윕하면 차이가 가장 잘 드러납니다. temperature가 0이면 샘플링 자체가 거의 결정적이라 차이가 안 보입니다.</p>
  </li>
  <li>
    <p>프롬프트는 “사실상 정답 한 개”인 지식질문보다, 창의적 생성이나 요약-재서술이 다양성 측정에 유리합니다.</p>
  </li>
  <li>
    <p>max_* 제한을 너무 빡빡하게 주면 모든 샘플이 짧아져 차이가 줄어듭니다.</p>
  </li>
  <li>
    <p>파라미터 오류를 의도적으로 보내 검증해도 좋습니다. 예를 들어 top_p=-1 같은 값은 서버에서 거절돼야 합니다. 거절되지 않으면 해당 엔드포인트가 파라미터를 무시하거나 자체 정규화할 가능성이 있습니다.</p>
  </li>
</ul>

<p>이 하네스로 실제 서빙 환경과 설치된 SDK에서 “전송 여부”와 “효과 존재 여부”를 모두 계량적으로 확인할 수 있어요.</p>

<p class="chat--user">

종합해서, 내가 말한 모든 것들을 만족하는 파이썬 코드 설계하고 만들어줘. 1. Response/Chat Completions API 선택 + tool JSON format 선택 + LLM Parameter로부터 argument 변환 법 선택 2. Config 파일에 여러 모델 설정에 대해 각각의 모델 + API + JSON 포맷을 미리 정의해둘 거야 (config.toml 파일로 생각 중 - 이 조합 1개를 api_provider라고 부를거고 name(유저가 보는 이름), 모델(호출 시 쓰이는 모델명), base_url, api_key, api 형식, 툴 형식, argument 어댑터 형식을 기입할거야) 그걸 읽어와서 유저가 api_provider name만 보고 고르고 user prompt(+system prompt)와 툴 선택만 하고 실행하면 잘 동작하도록 구성해줘. 

</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># orchestrator_async_configurable.py
# Python 3.10+
# Dependencies: pip install --upgrade openai httpx
#
# -------------------------------------------------------------
# What this file provides
# -------------------------------------------------------------
# 1) A clean, extensible design to run tool-calling LLMs with:
#    - API choice: Responses vs Chat Completions
#    - Tool JSON shape choice: "flat" (new) vs "nested" (legacy)
#    - Argument mapping (neutral → endpoint-specific) strategy choice
# 2) Async-only I/O (AsyncOpenAI + httpx.AsyncClient with hooks)
# 3) User interrupt support via user.processing_interrupted()
# 4) Providers are defined in a config.toml, each called an "api_provider".
#    Users pick a provider by name; system/user prompts and tool selection
#    are provided at runtime.
#
# -------------------------------------------------------------
# Example config.toml (put this next to the script)
# -------------------------------------------------------------
# [[api_provider]]
# name = "OSS GPT (Responses + Flat + RespAdapter)"
# model = "gpt-4.1-mini"
# base_url = "https://api.openai.com/v1"
# api_key_env = "OPENAI_API_KEY"   # or use: api_key = "sk-..."
# api = "responses"                # "responses" | "completions"
# tool_json = "flat"               # "flat" | "nested"
# arg_adapter = "responses"        # "responses" | "completions" | "completions_reasoning"
#
# [[api_provider]]
# name = "Qwen-like (Completions + Nested + CompAdapter)"
# model = "qwen2.5"
# base_url = "https://api.openai.com/v1"
# api_key_env = "QWEN_API_KEY"
# api = "completions"
# tool_json = "nested"
# arg_adapter = "completions"
#
# -------------------------------------------------------------
# CLI usage examples
# -------------------------------------------------------------
# python orchestrator_async_configurable.py \
#   --config ./config.toml \
#   --provider "OSS GPT (Responses + Flat + RespAdapter)" \
#   --system "You are a helpful assistant that uses tools when needed." \
#   --user "List files under ./samples, pick a text file, read it, and summarize in 2-3 sentences." \
#   --enable-tools list_files_in_folder,read_text_file \
#   --length 400 --temperature 0.7 --top-p 0.9
#
# -------------------------------------------------------------
# Notes
# -------------------------------------------------------------
# - This script outputs plain text only (no JSON-mode / structured parsing).
# - Tools are executed locally and results are passed back to the model.
# - Interrupts: SIGINT/SIGTERM will stop ongoing requests cleanly.
# - If tomllib is not available (Python &lt;3.11), you can `pip install tomli`.
#
</span>
<span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">signal</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Protocol</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="c1"># TOML loader with fallback
</span><span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomllib</span>  <span class="c1"># Python 3.11+
</span><span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">tomllib</span> <span class="o">=</span> <span class="bp">None</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomli</span>  <span class="c1"># fallback
</span><span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">tomli</span> <span class="o">=</span> <span class="bp">None</span>

<span class="kn">import</span> <span class="n">httpx</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">AsyncOpenAI</span>

<span class="c1"># ============================================================
# Interrupt support
# ============================================================
</span>
<span class="k">class</span> <span class="nc">UserCancelledError</span><span class="p">(</span><span class="nb">Exception</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Raised when the user has interrupted the processing.</span><span class="sh">"""</span>

<span class="k">class</span> <span class="nc">UserInterface</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Minimal user interface object that exposes `processing_interrupted()`.
    Replace/extend this for GUI/Server integration if needed.
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_event</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Event</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">trigger_interrupt</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_event</span><span class="p">.</span><span class="nf">set</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">processing_interrupted</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_event</span><span class="p">.</span><span class="nf">is_set</span><span class="p">()</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">call_with_interrupt</span><span class="p">(</span><span class="n">coro</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="n">UserInterface</span><span class="p">,</span> <span class="n">poll_interval</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Await a coroutine while periodically checking user.processing_interrupted().
    If interrupted, cancel the task and raise UserCancelledError.
    </span><span class="sh">"""</span>
    <span class="n">task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="n">coro</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">({</span><span class="n">task</span><span class="p">},</span> <span class="n">timeout</span><span class="o">=</span><span class="n">poll_interval</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">task</span><span class="p">.</span><span class="nf">result</span><span class="p">()</span>
            <span class="k">if</span> <span class="k">await</span> <span class="n">user</span><span class="p">.</span><span class="nf">processing_interrupted</span><span class="p">():</span>
                <span class="n">task</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">task</span>
                <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">raise</span> <span class="nc">UserCancelledError</span><span class="p">(</span><span class="sh">"</span><span class="s">Processing interrupted by user.</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">raise</span>

<span class="c1"># ============================================================
# Model &amp; Provider profiles from config
# ============================================================
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ProviderProfile</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Single provider (api_provider) loaded from config.toml.</span><span class="sh">"""</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">model</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">api</span><span class="p">:</span> <span class="nb">str</span>         <span class="c1"># "responses" | "completions"
</span>    <span class="n">tool_json</span><span class="p">:</span> <span class="nb">str</span>   <span class="c1"># "flat" | "nested"
</span>    <span class="n">arg_adapter</span><span class="p">:</span> <span class="nb">str</span> <span class="c1"># "responses" | "completions" | "completions_reasoning"
</span>
<span class="k">def</span> <span class="nf">load_providers</span><span class="p">(</span><span class="n">config_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ProviderProfile</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">
    Load providers from config.toml (or .json if needed).
    Returns a dict mapping provider name -&gt; profile.
    </span><span class="sh">"""</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">config_path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="nc">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Config not found: </span><span class="si">{</span><span class="n">config_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># Read bytes
</span>    <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">config_path</span><span class="p">,</span> <span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>

    <span class="c1"># Parse TOML (preferred)
</span>    <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">config_path</span><span class="p">.</span><span class="nf">lower</span><span class="p">().</span><span class="nf">endswith</span><span class="p">(</span><span class="sh">"</span><span class="s">.toml</span><span class="sh">"</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">tomllib</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">tomllib</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">tomli</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">tomli</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">TOML parser not available. Install Python 3.11+ or `pip install tomli`.</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Fallback: JSON
</span>        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">))</span>

    <span class="n">providers_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">api_provider</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">api_providers</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">providers_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">Invalid config: expected [[api_provider]] entries.</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ProviderProfile</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">providers_data</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">base_url</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">api_key_env</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">api_key_env</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">api</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">api</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">tool_json</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_json</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">arg_adapter</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arg_adapter</span><span class="sh">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">model</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">base_url</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">api</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">tool_json</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">arg_adapter</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Invalid provider entry: </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

        <span class="c1"># Resolve API key: direct string takes precedence; else from env var.
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">api_key</span> <span class="ow">and</span> <span class="n">api_key_env</span><span class="p">:</span>
            <span class="n">api_key</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="n">api_key_env</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">api_key</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">API key missing for provider </span><span class="sh">'</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">'</span><span class="s">. Use api_key or api_key_env.</span><span class="sh">"</span><span class="p">)</span>

        <span class="n">profile</span> <span class="o">=</span> <span class="nc">ProviderProfile</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">base_url</span><span class="o">=</span><span class="n">base_url</span><span class="p">,</span>
            <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
            <span class="n">api</span><span class="o">=</span><span class="n">api</span><span class="p">,</span>
            <span class="n">tool_json</span><span class="o">=</span><span class="n">tool_json</span><span class="p">,</span>
            <span class="n">arg_adapter</span><span class="o">=</span><span class="n">arg_adapter</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">profile</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="c1"># ============================================================
# Tool layer
# ============================================================
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ToolSpec</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Single tool spec + local implementation.</span><span class="sh">"""</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="n">func</span><span class="p">:</span> <span class="n">Any</span>  <span class="c1"># Callable[[Dict[str, Any]], Any]
</span>
<span class="k">class</span> <span class="nc">ToolRegistry</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Holds tools and executes them by name.</span><span class="sh">"""</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ToolSpec</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="n">ToolSpec</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">spec</span><span class="p">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Tool already registered: </span><span class="si">{</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">[</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span>

    <span class="k">def</span> <span class="nf">select</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">names</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">names</span><span class="p">:</span>
            <span class="k">return</span> <span class="nf">list</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">.</span><span class="nf">values</span><span class="p">())</span>
        <span class="n">selected</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">:</span>
                <span class="n">selected</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">selected</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">[</span><span class="n">name</span><span class="p">].</span><span class="nf">func</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

<span class="c1"># Concrete tools (fast local I/O)
</span>
<span class="k">def</span> <span class="nf">list_files_in_folder_impl</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">folder</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">items</span> <span class="o">=</span> <span class="nf">sorted</span><span class="p">([</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="nf">listdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">f</span><span class="p">))])</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="n">items</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">read_text_file_impl</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()}</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">build_default_tools</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">ToolRegistry</span><span class="p">:</span>
    <span class="n">reg</span> <span class="o">=</span> <span class="nc">ToolRegistry</span><span class="p">()</span>
    <span class="n">reg</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="nc">ToolSpec</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">},</span>
        <span class="n">func</span><span class="o">=</span><span class="n">list_files_in_folder_impl</span>
    <span class="p">))</span>
    <span class="n">reg</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="nc">ToolSpec</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative path to a text file.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">},</span>
        <span class="n">func</span><span class="o">=</span><span class="n">read_text_file_impl</span>
    <span class="p">))</span>
    <span class="k">return</span> <span class="n">reg</span>

<span class="c1"># ============================================================
# Tool JSON builders (Factory)
# ============================================================
</span>
<span class="k">class</span> <span class="nc">ToolJSONBuilder</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="bp">...</span>

<span class="k">class</span> <span class="nc">FlatToolJSONBuilder</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Flat tool JSON: { </span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="s">:..., </span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="s">:..., </span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="s">:{...} }</span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">:</span>
            <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">parameters</span><span class="p">,</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">out</span>

<span class="k">class</span> <span class="nc">NestedToolJSONBuilder</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Nested tool JSON: { </span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">:{...} }</span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">:</span>
            <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">parameters</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span> <span class="nf">get_tool_builder</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ToolJSONBuilder</span><span class="p">:</span>
    <span class="n">kind</span> <span class="o">=</span> <span class="p">(</span><span class="n">kind</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">).</span><span class="nf">strip</span><span class="p">().</span><span class="nf">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">flat</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="nc">FlatToolJSONBuilder</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">nested</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="nc">NestedToolJSONBuilder</span><span class="p">()</span>
    <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool_json type: </span><span class="si">{</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># ============================================================
# Neutral → Endpoint-specific parameter mapping (Adapters)
# ============================================================
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">NeutralParams</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Neutral params that callers can pass without worrying about endpoint differences.</span><span class="sh">"""</span>
    <span class="n">length</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">temperature</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">top_p</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">stop</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">reasoning_effort</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c1"># "low"|"medium"|"high" (if supported)
</span>
<span class="k">class</span> <span class="nc">ArgAdapter</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">build_for_responses</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">neutral</span><span class="p">:</span> <span class="n">NeutralParams</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">tools_json</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="bp">...</span>
    <span class="k">def</span> <span class="nf">build_for_completions</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">neutral</span><span class="p">:</span> <span class="n">NeutralParams</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">tools_json</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="bp">...</span>

<span class="k">class</span> <span class="nc">ResponsesArgAdapter</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Use max_output_tokens + reasoning in Responses; reasonable defaults elsewhere.</span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">build_for_responses</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">neutral</span><span class="p">:</span> <span class="n">NeutralParams</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">tools_json</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools_json</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">max_output_tokens</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">length</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">temperature</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">temperature</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">temperature</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">top_p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">top_p</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">top_p</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">stop</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">neutral</span><span class="p">.</span><span class="n">stop</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">reasoning_effort</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">reasoning</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">effort</span><span class="sh">"</span><span class="p">:</span> <span class="n">neutral</span><span class="p">.</span><span class="n">reasoning_effort</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">build_for_completions</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">neutral</span><span class="p">:</span> <span class="n">NeutralParams</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">tools_json</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools_json</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">max_tokens</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">length</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">temperature</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">temperature</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">temperature</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">top_p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">top_p</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">top_p</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">stop</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">neutral</span><span class="p">.</span><span class="n">stop</span>
        <span class="c1"># reasoning may be ignored by non-reasoning chat models
</span>        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">reasoning_effort</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">reasoning</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">effort</span><span class="sh">"</span><span class="p">:</span> <span class="n">neutral</span><span class="p">.</span><span class="n">reasoning_effort</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">out</span>

<span class="k">class</span> <span class="nc">CompletionsArgAdapter</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Use max_tokens for completions; map others as common fields.</span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">build_for_responses</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">neutral</span><span class="p">:</span> <span class="n">NeutralParams</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">tools_json</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="c1"># If someone forces this adapter onto Responses: do a best-effort mapping
</span>        <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools_json</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">max_output_tokens</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">length</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">temperature</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">temperature</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">temperature</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">top_p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">top_p</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">top_p</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">stop</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">neutral</span><span class="p">.</span><span class="n">stop</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">reasoning_effort</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">reasoning</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">effort</span><span class="sh">"</span><span class="p">:</span> <span class="n">neutral</span><span class="p">.</span><span class="n">reasoning_effort</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">build_for_completions</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">neutral</span><span class="p">:</span> <span class="n">NeutralParams</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">tools_json</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools_json</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">max_tokens</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">length</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">temperature</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">temperature</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">temperature</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">top_p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">top_p</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">top_p</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">stop</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">neutral</span><span class="p">.</span><span class="n">stop</span>
        <span class="k">return</span> <span class="n">out</span>

<span class="k">class</span> <span class="nc">CompletionsReasoningArgAdapter</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Use max_completion_tokens + reasoning for reasoning-friendly chat models.</span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">build_for_responses</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">neutral</span><span class="p">:</span> <span class="n">NeutralParams</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">tools_json</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools_json</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">max_output_tokens</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">length</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">temperature</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">temperature</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">temperature</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">top_p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">top_p</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">top_p</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">stop</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">neutral</span><span class="p">.</span><span class="n">stop</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">reasoning_effort</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">reasoning</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">effort</span><span class="sh">"</span><span class="p">:</span> <span class="n">neutral</span><span class="p">.</span><span class="n">reasoning_effort</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">build_for_completions</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">neutral</span><span class="p">:</span> <span class="n">NeutralParams</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">tools_json</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools_json</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">max_completion_tokens</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">length</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">temperature</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">temperature</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">temperature</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">top_p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">top_p</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">top_p</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">stop</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">neutral</span><span class="p">.</span><span class="n">stop</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">reasoning_effort</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">reasoning</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">effort</span><span class="sh">"</span><span class="p">:</span> <span class="n">neutral</span><span class="p">.</span><span class="n">reasoning_effort</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span> <span class="nf">get_arg_adapter</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ArgAdapter</span><span class="p">:</span>
    <span class="n">kind</span> <span class="o">=</span> <span class="p">(</span><span class="n">kind</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">).</span><span class="nf">strip</span><span class="p">().</span><span class="nf">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="nc">ResponsesArgAdapter</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="nc">CompletionsArgAdapter</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">completions_reasoning</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="nc">CompletionsReasoningArgAdapter</span><span class="p">()</span>
    <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Unknown arg_adapter: </span><span class="si">{</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># ============================================================
# Protocol strategies (Async, plain-text only)
# ============================================================
</span>
<span class="k">class</span> <span class="nc">ProtocolStrategy</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">client</span><span class="p">:</span> <span class="n">AsyncOpenAI</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">tools_json</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">payload_args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">user</span><span class="p">:</span> <span class="n">UserInterface</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="bp">...</span>

<span class="k">class</span> <span class="nc">ResponsesStrategy</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    responses.create loop:
      - Send input + tools
      - Collect text
      - If function calls appear: execute locally and append function_call_output
      - Repeat until no more tool calls
    </span><span class="sh">"""</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_collect_text</span><span class="p">(</span><span class="n">resp</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
            <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]:</span>
                    <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
            <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
        <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">texts</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_collect_tool_calls</span><span class="p">(</span><span class="n">resp</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="sh">"</span><span class="s">function_call</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                        <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                              <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                              <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{}})</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">inner</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">inner</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">inner</span><span class="p">:</span>
                        <span class="n">nm</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                        <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                                <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                                      <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">nm</span><span class="p">,</span>
                                      <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{}})</span>
        <span class="k">return</span> <span class="n">calls</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">registry</span><span class="p">:</span> <span class="n">ToolRegistry</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">registry</span> <span class="o">=</span> <span class="n">registry</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">client</span><span class="p">:</span> <span class="n">AsyncOpenAI</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">tools_json</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">payload_args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">user</span><span class="p">:</span> <span class="n">UserInterface</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># First call
</span>        <span class="n">args</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools_json</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">tool_choice</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
            <span class="o">**</span><span class="n">payload_args</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">call_with_interrupt</span><span class="p">(</span>
            <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">),</span>
            <span class="n">user</span>
        <span class="p">)</span>

        <span class="n">chunks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">_collect_text</span><span class="p">(</span><span class="n">resp</span><span class="p">))</span>
            <span class="n">calls</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_collect_tool_calls</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="c1"># Execute tools and append outputs into input messages
</span>            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
                <span class="c1"># Check for user interrupt between tool calls
</span>                <span class="k">if</span> <span class="k">await</span> <span class="n">user</span><span class="p">.</span><span class="nf">processing_interrupted</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="nc">UserCancelledError</span><span class="p">(</span><span class="sh">"</span><span class="s">Processing interrupted by user.</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">registry</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
                <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function_call_output</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">],</span>
                    <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                <span class="p">})</span>

            <span class="c1"># Next turn
</span>            <span class="n">args</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools_json</span><span class="p">,</span>
                <span class="o">**</span><span class="n">payload_args</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">call_with_interrupt</span><span class="p">(</span>
                <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">),</span>
                <span class="n">user</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">chunks</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

<span class="k">class</span> <span class="nc">CompletionsStrategy</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    chat.completions.create loop:
      - Send messages + tools
      - If tool_calls appear: execute locally and append tool messages
      - Repeat until no more tool_calls
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">registry</span><span class="p">:</span> <span class="n">ToolRegistry</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">registry</span> <span class="o">=</span> <span class="n">registry</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">client</span><span class="p">:</span> <span class="n">AsyncOpenAI</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">tools_json</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">payload_args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">user</span><span class="p">:</span> <span class="n">UserInterface</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools_json</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">tool_choice</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
            <span class="o">**</span><span class="n">payload_args</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">call_with_interrupt</span><span class="p">(</span>
            <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">),</span>
            <span class="n">user</span>
        <span class="p">)</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
        <span class="n">chunks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">]</span>
        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">tool_msgs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="k">if</span> <span class="k">await</span> <span class="n">user</span><span class="p">.</span><span class="nf">processing_interrupted</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="nc">UserCancelledError</span><span class="p">(</span><span class="sh">"</span><span class="s">Processing interrupted by user.</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">fn_name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">registry</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>
                <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                <span class="p">})</span>

            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">],</span>
            <span class="p">})</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

            <span class="n">args</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span>
                <span class="o">**</span><span class="n">payload_args</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">call_with_interrupt</span><span class="p">(</span>
                <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">),</span>
                <span class="n">user</span>
            <span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
            <span class="k">if</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">content</span><span class="p">)</span>

        <span class="k">return</span> <span class="sh">"</span><span class="se">\n\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">chunks</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">get_protocol_strategy</span><span class="p">(</span><span class="n">api</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">registry</span><span class="p">:</span> <span class="n">ToolRegistry</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ProtocolStrategy</span><span class="p">:</span>
    <span class="n">api</span> <span class="o">=</span> <span class="p">(</span><span class="n">api</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">).</span><span class="nf">strip</span><span class="p">().</span><span class="nf">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">api</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="nc">ResponsesStrategy</span><span class="p">(</span><span class="n">registry</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">api</span> <span class="o">==</span> <span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="nc">CompletionsStrategy</span><span class="p">(</span><span class="n">registry</span><span class="p">)</span>
    <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Unknown api type: </span><span class="si">{</span><span class="n">api</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># ============================================================
# HTTPX hooks (optional request logging)
# ============================================================
</span>
<span class="k">def</span> <span class="nf">build_httpx_hooks</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">on_request</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">httpx</span><span class="p">.</span><span class="n">Request</span><span class="p">):</span>
        <span class="c1"># Uncomment to debug requests:
</span>        <span class="c1"># if request.headers.get("content-type","").startswith("application/json"):
</span>        <span class="c1">#     print("[httpx] -&gt;", request.method, request.url)
</span>        <span class="k">return</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">on_response</span><span class="p">(</span><span class="n">response</span><span class="p">:</span> <span class="n">httpx</span><span class="p">.</span><span class="n">Response</span><span class="p">):</span>
        <span class="c1"># Uncomment to debug responses:
</span>        <span class="c1"># print("[httpx] &lt;-", response.status_code, response.request.url)
</span>        <span class="k">return</span>

    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">on_request</span><span class="p">],</span> <span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">on_response</span><span class="p">]}</span>

<span class="c1"># ============================================================
# Orchestrator (ties everything together)
# ============================================================
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">RunOptions</span><span class="p">:</span>
    <span class="n">system_prompt</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">user_prompt</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">enabled_tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">neutral_params</span><span class="p">:</span> <span class="n">NeutralParams</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_with_provider</span><span class="p">(</span>
    <span class="n">provider</span><span class="p">:</span> <span class="n">ProviderProfile</span><span class="p">,</span>
    <span class="n">options</span><span class="p">:</span> <span class="n">RunOptions</span><span class="p">,</span>
    <span class="n">registry</span><span class="p">:</span> <span class="n">ToolRegistry</span><span class="p">,</span>
    <span class="n">user</span><span class="p">:</span> <span class="n">UserInterface</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Single-shot run given a ProviderProfile and run options.
    </span><span class="sh">"""</span>
    <span class="c1"># Select tools
</span>    <span class="n">specs</span> <span class="o">=</span> <span class="n">registry</span><span class="p">.</span><span class="nf">select</span><span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">enabled_tools</span><span class="p">)</span>
    <span class="c1"># Build tool JSON
</span>    <span class="n">tools_builder</span> <span class="o">=</span> <span class="nf">get_tool_builder</span><span class="p">(</span><span class="n">provider</span><span class="p">.</span><span class="n">tool_json</span><span class="p">)</span>
    <span class="n">tools_json</span> <span class="o">=</span> <span class="n">tools_builder</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span>

    <span class="c1"># Build messages
</span>    <span class="k">if</span> <span class="n">provider</span><span class="p">.</span><span class="n">api</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">:</span>
        <span class="c1"># Responses expects "input" messages (role/content pair objects)
</span>        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">options</span><span class="p">.</span><span class="n">system_prompt</span><span class="p">},</span>
            <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">options</span><span class="p">.</span><span class="n">user_prompt</span><span class="p">},</span>
        <span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Completions expects chat "messages"
</span>        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">options</span><span class="p">.</span><span class="n">system_prompt</span><span class="p">},</span>
            <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">options</span><span class="p">.</span><span class="n">user_prompt</span><span class="p">},</span>
        <span class="p">]</span>

    <span class="c1"># Build endpoint-specific argument payload
</span>    <span class="n">adapter</span> <span class="o">=</span> <span class="nf">get_arg_adapter</span><span class="p">(</span><span class="n">provider</span><span class="p">.</span><span class="n">arg_adapter</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">provider</span><span class="p">.</span><span class="n">api</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">payload_args</span> <span class="o">=</span> <span class="n">adapter</span><span class="p">.</span><span class="nf">build_for_responses</span><span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">neutral_params</span><span class="p">,</span> <span class="n">messages</span><span class="p">,</span> <span class="n">tools_json</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">payload_args</span> <span class="o">=</span> <span class="n">adapter</span><span class="p">.</span><span class="nf">build_for_completions</span><span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">neutral_params</span><span class="p">,</span> <span class="n">messages</span><span class="p">,</span> <span class="n">tools_json</span><span class="p">)</span>

    <span class="c1"># Strategy by API
</span>    <span class="n">strategy</span> <span class="o">=</span> <span class="nf">get_protocol_strategy</span><span class="p">(</span><span class="n">provider</span><span class="p">.</span><span class="n">api</span><span class="p">,</span> <span class="n">registry</span><span class="p">)</span>

    <span class="c1"># Async client creation (single session) with hooks
</span>    <span class="n">hooks</span> <span class="o">=</span> <span class="nf">build_httpx_hooks</span><span class="p">()</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">httpx</span><span class="p">.</span><span class="nc">AsyncClient</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">httpx</span><span class="p">.</span><span class="nc">Timeout</span><span class="p">(</span><span class="mf">60.0</span><span class="p">),</span> <span class="n">event_hooks</span><span class="o">=</span><span class="n">hooks</span><span class="p">)</span> <span class="k">as</span> <span class="n">http_client</span><span class="p">:</span>
        <span class="k">async</span> <span class="k">with</span> <span class="nc">AsyncOpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">provider</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">provider</span><span class="p">.</span><span class="n">api_key</span><span class="p">,</span> <span class="n">http_client</span><span class="o">=</span><span class="n">http_client</span><span class="p">)</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
            <span class="c1"># Run and return final plain text
</span>            <span class="k">return</span> <span class="k">await</span> <span class="n">strategy</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span>
                <span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">,</span>
                <span class="n">model</span><span class="o">=</span><span class="n">provider</span><span class="p">.</span><span class="n">model</span><span class="p">,</span>
                <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
                <span class="n">tools_json</span><span class="o">=</span><span class="n">tools_json</span><span class="p">,</span>
                <span class="n">payload_args</span><span class="o">=</span><span class="n">payload_args</span><span class="p">,</span>
                <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
            <span class="p">)</span>

<span class="c1"># ============================================================
# CLI entry point
# ============================================================
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">amain</span><span class="p">():</span>
    <span class="kn">import</span> <span class="n">argparse</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="nc">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Async LLM Orchestrator with configurable API/Tools/Arg adapters.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--config</span><span class="sh">"</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">Path to config.toml (or .json fallback).</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--provider</span><span class="sh">"</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">api_provider name from the config.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--system</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--user</span><span class="sh">"</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">User prompt to run.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--enable-tools</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">list_files_in_folder,read_text_file</span><span class="sh">"</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">Comma-separated tool names (subset of registered).</span><span class="sh">"</span><span class="p">)</span>
    <span class="c1"># Neutral params
</span>    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--length</span><span class="sh">"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">Neutral length cap (mapped to endpoint-specific).</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--temperature</span><span class="sh">"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--top-p</span><span class="sh">"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="sh">"</span><span class="s">top_p</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--stop</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">Comma-separated stop tokens.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--reasoning-effort</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">One of </span><span class="sh">"</span><span class="s">low</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">medium</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">high</span><span class="sh">"</span><span class="s"> (if supported).</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="nf">parse_args</span><span class="p">()</span>

    <span class="c1"># Build the user interrupt controller and wire OS signals
</span>    <span class="n">user</span> <span class="o">=</span> <span class="nc">UserInterface</span><span class="p">()</span>
    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_running_loop</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">loop</span><span class="p">.</span><span class="nf">add_signal_handler</span><span class="p">(</span><span class="n">signal</span><span class="p">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">user</span><span class="p">.</span><span class="n">trigger_interrupt</span><span class="p">)</span>
        <span class="n">loop</span><span class="p">.</span><span class="nf">add_signal_handler</span><span class="p">(</span><span class="n">signal</span><span class="p">.</span><span class="n">SIGTERM</span><span class="p">,</span> <span class="n">user</span><span class="p">.</span><span class="n">trigger_interrupt</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">NotImplementedError</span><span class="p">:</span>
        <span class="c1"># Some platforms (e.g., certain Windows envs) may not support this
</span>        <span class="k">pass</span>

    <span class="c1"># Load providers
</span>    <span class="n">providers</span> <span class="o">=</span> <span class="nf">load_providers</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">config</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">provider</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">providers</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Provider </span><span class="sh">'</span><span class="si">{</span><span class="n">args</span><span class="p">.</span><span class="n">provider</span><span class="si">}</span><span class="sh">'</span><span class="s"> not found in config. Available: </span><span class="si">{</span><span class="nf">list</span><span class="p">(</span><span class="n">providers</span><span class="p">.</span><span class="nf">keys</span><span class="p">())</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">provider</span> <span class="o">=</span> <span class="n">providers</span><span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">provider</span><span class="p">]</span>

    <span class="c1"># Prepare tools
</span>    <span class="n">registry</span> <span class="o">=</span> <span class="nf">build_default_tools</span><span class="p">()</span>
    <span class="n">enabled_tools</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">args</span><span class="p">.</span><span class="n">enable_tools</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="p">)]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">enable_tools</span> <span class="k">else</span> <span class="p">[]</span>
    <span class="n">stop</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">stop</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="p">)</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">stop</span> <span class="k">else</span> <span class="p">[])</span> <span class="k">if</span> <span class="n">s</span><span class="p">]</span>

    <span class="c1"># Prepare neutral params
</span>    <span class="n">neutral</span> <span class="o">=</span> <span class="nc">NeutralParams</span><span class="p">(</span>
        <span class="n">length</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">length</span><span class="p">,</span>
        <span class="n">temperature</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">temperature</span><span class="p">,</span>
        <span class="n">top_p</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">top_p</span><span class="p">,</span>
        <span class="n">stop</span><span class="o">=</span><span class="n">stop</span> <span class="k">if</span> <span class="n">stop</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">reasoning_effort</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">reasoning_effort</span>
    <span class="p">)</span>

    <span class="n">options</span> <span class="o">=</span> <span class="nc">RunOptions</span><span class="p">(</span>
        <span class="n">system_prompt</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">system</span><span class="p">,</span>
        <span class="n">user_prompt</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">user</span><span class="p">,</span>
        <span class="n">enabled_tools</span><span class="o">=</span><span class="n">enabled_tools</span><span class="p">,</span>
        <span class="n">neutral_params</span><span class="o">=</span><span class="n">neutral</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">output_text</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">run_with_provider</span><span class="p">(</span><span class="n">provider</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">registry</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">=== FINAL OUTPUT ===</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">output_text</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">(empty)</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">UserCancelledError</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">=== INTERRUPTED ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">=== ERROR ===</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">amain</span><span class="p">())</span>
</code></pre></div></div>

<p class="chat--user">

Protocol 클래스를 상속 받는건 무슨 의미야?

</p>

<p>좋은 질문이야. 파이썬의 typing.Protocol을 상속한다는 건 “이 클래스는 인터페이스 규격이다”라고 선언해, 정적 타입체커(mypy, pyright 등)가 ‘덕 타이핑 기반의 구조적 서브타이핑’을 적용하도록 만드는 거야.</p>

<p>핵심만 단계별로 정리할게.</p>

<ol>
  <li>Protocol이 뭐고, 상속하면 뭐가 달라지나</li>
</ol>

<ul>
  <li>
    <p>Protocol을 상속한 클래스는 인터페이스(규격)로 취급돼.</p>
  </li>
  <li>
    <p>이 인터페이스를 “구현”하는 쪽은 굳이 상속할 필요가 없어. 같은 시그니처의 메서드·속성을 갖고 있으면 타입체커가 자동으로 호환된다고 본다.</p>
  </li>
  <li>
    <p>즉, 이름으로 맞추는 덕 타이핑을 정적 타입 수준에서 안전하게 쓰게 해준다.</p>
  </li>
</ul>

<ol>
  <li>ABC(Abstract Base Class)와의 차이</li>
</ol>

<ul>
  <li>
    <p>ABC는 명시적 상속과 추상 메서드 구현이 필요해. 상속관계가 중심이야.</p>
  </li>
  <li>
    <p>Protocol은 구조적(subtype-by-structure)이라 상속 없이도 규격만 맞으면 통과야. 플러그인 구조나 외부 라이브러리 어댑터처럼 “손댈 수 없는 타입들”을 끼워 넣기 좋다.</p>
  </li>
  <li>
    <p>런타임 강제력은 기본적으로 없음. 주로 정적 타입체킹 단계에서 이점이 크다.</p>
  </li>
</ul>

<ol>
  <li>우리 코드에서 왜 썼나</li>
</ol>

<ul>
  <li>
    <p>ToolJSONBuilder, ArgAdapter, ProtocolStrategy 같은 “역할”을 인터페이스로 분리했지.</p>
  </li>
  <li>
    <p>새 벤더·새 전략을 추가할 때 굳이 공통 베이스 클래스를 상속하지 않아도, 같은 메서드 시그니처만 맞추면 곧바로 끼워 넣을 수 있어.</p>
  </li>
  <li>
    <p>결과적으로 의존성 역전(DI)과 확장성(새 구현체 추가)에 유리해.</p>
  </li>
</ul>

<ol>
  <li>최소 예시<br />
아래에서 MyPrinter는 Printable을 상속하지 않았지만, 구조가 같으니 타입체커가 OK라고 본다.</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Protocol</span>

<span class="k">class</span> <span class="nc">Printable</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">print</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span> <span class="bp">...</span>

<span class="k">class</span> <span class="nc">MyPrinter</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">print</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">p</span><span class="p">:</span> <span class="n">Printable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">p</span><span class="p">.</span><span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">hello</span><span class="sh">"</span><span class="p">)</span>

<span class="nf">run</span><span class="p">(</span><span class="nc">MyPrinter</span><span class="p">())</span>  <span class="c1"># OK: structural subtyping
</span></code></pre></div></div>

<ol>
  <li>런타임에서 isinstance 체크가 필요하면</li>
</ol>

<ul>
  <li>
    <p>기본 Protocol은 런타임 검사용이 아니야. 꼭 필요하면 @runtime_checkable 데코레이터를 붙여서 가벼운 런타임 검사를 허용할 수 있어.</p>
  </li>
  <li>
    <p>그래도 isinstance는 속성 유무만 느슨하게 확인하니, 진짜 강제는 정적 타입체커에 맡기는 게 보통 더 낫다.</p>
  </li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Protocol</span><span class="p">,</span> <span class="n">runtime_checkable</span>

<span class="nd">@runtime_checkable</span>
<span class="k">class</span> <span class="nc">Printable</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">print</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span> <span class="bp">...</span>

<span class="n">p</span> <span class="o">=</span> <span class="nc">MyPrinter</span><span class="p">()</span>
<span class="k">assert</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">Printable</span><span class="p">)</span>  <span class="c1"># 가능해짐 (정교한 보장은 아님)
</span></code></pre></div></div>

<ol>
  <li>언제 Protocol이 특히 유용한가</li>
</ol>

<ul>
  <li>
    <p>플러그인/전략/어댑터 패턴: 서드파티 구현체를 쉽게 꽂을 때</p>
  </li>
  <li>
    <p>테스트 더블 주입: 목/스텁을 상속 없이 바로 넣고 싶을 때</p>
  </li>
  <li>
    <p>멀티 벤더 지원: 서로 다른 SDK 객체라도 같은 표면 API만 맞춰주면 교체 가능</p>
  </li>
</ul>

<ol>
  <li>주의할 점</li>
</ol>

<ul>
  <li>
    <p>런타임 강제력이 거의 없으니, 타입 안전성은 mypy/pyright 같은 정적 타입체커를 CI에 넣어 확보하는 게 정석.</p>
  </li>
  <li>
    <p>메서드 시그니처는 정확히 맞춰야 한다. 인자 이름·개수·타입이 빗나가면 타입체커가 잡아줄 것이다.</p>
  </li>
  <li>
    <p>속성(데이터 필드)도 Protocol에 선언할 수 있지만, 구현체가 정확히 제공해야 한다.</p>
  </li>
</ul>

<p>정리<br />
Protocol을 상속한다는 건 “이건 인터페이스 명세입니다. 상속 없이도 이 규격만 맞추면 같은 타입으로 인정하세요”라는 신호야. 우리 오케스트레이터에서 확장성을 높이기 위해 Protocol을 쓴 건, 새로운 모델·전략·어댑터를 최소 마찰로 추가하려는 의도였고, 실제로 그게 가장 깔끔한 선택이야.</p>

<p class="chat--user">

너는 ComfyUI custom node 전문 제작자이며, 파이썬 코드 전문가야. 난 이 기능을 ComfyUI Custom Node로 만들고 싶어. 참고로 최신 ComfyUI는 async execute 함수를 지원해. 많은 것이 바뀔 수 있으니 잘 생각해서 해보자. OpenAIChatNode - async def run(user_prompt, provider(name), advanced_options(Optional)) 노드 리턴값은 1개이고 openai api를 통해 받은 response를 리턴할거야. OpenAIToolNode - function calling에 대한 정보(실행 함수 포함) 담을거야. 너가 만든 ToolSpec과 비슷할 것 같아. input: 다른 ToolNode의 리스트(None일수도 있음, 그러면 리스트를 만들면 돼) output: 지금 Tool을 인풋에 받은 리스트에 추가하여 리턴 OpenAICustomProviderNode - inputs: base_url, model, api_key, api 형식(completions, response), tool json 형식(flat, nested) - output: 현재 provider의 정보를 담은 객체 OpenAIAdvancedOptionsNode - input은 3개고 모두 optional해. input 1. tools (chat node에서 사용할 tool 정보 tool spec들의 모음 - ToolNode와 연결) input 2. custom provider -&gt; OpenAICustomProviderNode와 연결 input 3. system prompt -&gt; multiline string - output은 받은 정보를 모두 하나의 클래스 객체로 만들어서 chat node에서 이를 참고할 수 있게할 것. 

</p>

<p>좋아! 아래는 너가 요청한 4개의 커스텀 노드(OpenAIChatNode / OpenAIToolNode / OpenAICustomProviderNode / OpenAIAdvancedOptionsNode)를 한 파일에 담은 완전한 ComfyUI Custom Node 구현이야. 전부 비동기(async) 기반으로 작성했고, Responses/Chat Completions 선택, Tool JSON 포맷 선택(flat/nested), 파라미터 어댑터 선택(responses / completions / completions_reasoning)을 모두 지원해. 또한 config.toml에서 api_provider 목록을 읽어와 사용자는 provider 이름만 선택해도 되고, AdvancedOptions로 커스텀 provider와 도구, 시스템 프롬프트를 덮어쓸 수 있어.</p>

<p>파일명 예시: <code class="language-plaintext highlighter-rouge">openai_comfy_nodes.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># openai_comfy_nodes.py
# Python 3.10+
# Dependencies:
#   pip install --upgrade openai httpx
#
# This module provides four ComfyUI custom nodes:
#   1) OpenAIChatNode
#   2) OpenAIToolNode
#   3) OpenAICustomProviderNode
#   4) OpenAIAdvancedOptionsNode
#
# Design highlights:
# - Async-only execution (AsyncOpenAI + httpx.AsyncClient).
# - Users pick an api_provider by name (loaded from config.toml) or override via AdvancedOptions.
# - Supports Responses vs Chat Completions API, flat vs nested tool JSON, and three argument adapters.
# - ToolNode composes a list of tool specs (built-ins: list_files_in_folder, read_text_file).
# - AdvancedOptions aggregates tools, custom provider, system prompt.
# - ChatNode runs a tool-calling loop and returns the final plain-text response.
#
# Notes:
# - Config path is resolved from env OPENAI_PROVIDER_CONFIG or defaults to ./config.toml.
# - This node avoids JSON-mode/Structured output; it returns plain text only.
# - For cancellation: ComfyUI may cancel the task; we also poll an internal interrupt flag.
#   (If your ComfyUI build surfaces a cancellation signal, you can wire it to InterruptUser.trigger_interrupt.)
</span>
<span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">signal</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Protocol</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomllib</span>  <span class="c1"># Python 3.11+
</span><span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">tomllib</span> <span class="o">=</span> <span class="bp">None</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomli</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">tomli</span> <span class="o">=</span> <span class="bp">None</span>

<span class="kn">import</span> <span class="n">httpx</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">AsyncOpenAI</span>

<span class="c1"># ============================================================
# Interrupt helpers
# ============================================================
</span>
<span class="k">class</span> <span class="nc">UserCancelledError</span><span class="p">(</span><span class="nb">Exception</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Raised when the user has interrupted the processing.</span><span class="sh">"""</span>

<span class="k">class</span> <span class="nc">InterruptUser</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Minimal interrupt controller.
    - In ComfyUI, task cancellation raises CancelledError. We also poll this flag for cooperative cancellation.
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_event</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Event</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">trigger_interrupt</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_event</span><span class="p">.</span><span class="nf">set</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">processing_interrupted</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="c1"># If ComfyUI cancels the task, current task will be cancelled and the await below will raise.
</span>        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_event</span><span class="p">.</span><span class="nf">is_set</span><span class="p">()</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">call_with_interrupt</span><span class="p">(</span><span class="n">awaitable</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="n">InterruptUser</span><span class="p">,</span> <span class="n">poll</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Await an I/O operation while polling for user interruption.
    If interrupted, cancel and raise UserCancelledError.
    </span><span class="sh">"""</span>
    <span class="n">task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="n">awaitable</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">({</span><span class="n">task</span><span class="p">},</span> <span class="n">timeout</span><span class="o">=</span><span class="n">poll</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">task</span><span class="p">.</span><span class="nf">result</span><span class="p">()</span>
            <span class="k">if</span> <span class="k">await</span> <span class="n">user</span><span class="p">.</span><span class="nf">processing_interrupted</span><span class="p">():</span>
                <span class="n">task</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">task</span>
                <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">raise</span> <span class="nc">UserCancelledError</span><span class="p">(</span><span class="sh">"</span><span class="s">Interrupted by user.</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">raise</span>

<span class="c1"># ============================================================
# Config loading (api_provider catalog)
# ============================================================
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ProviderProfile</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">model</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">api</span><span class="p">:</span> <span class="nb">str</span>          <span class="c1"># "responses" | "completions"
</span>    <span class="n">tool_json</span><span class="p">:</span> <span class="nb">str</span>    <span class="c1"># "flat" | "nested"
</span>    <span class="n">arg_adapter</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># "responses" | "completions" | "completions_reasoning"
</span>
<span class="k">def</span> <span class="nf">_load_toml_bytes</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
    <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">load_providers_from_config</span><span class="p">(</span><span class="n">config_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ProviderProfile</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">
    Expect config like:
      [[api_provider]]
      name = </span><span class="sh">"</span><span class="s">OSS GPT (Responses + Flat)</span><span class="sh">"</span><span class="s">
      model = </span><span class="sh">"</span><span class="s">gpt-4.1-mini</span><span class="sh">"</span><span class="s">
      base_url = </span><span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="s">
      api_key_env = </span><span class="sh">"</span><span class="s">OPENAI_API_KEY</span><span class="sh">"</span><span class="s">   # or api_key = </span><span class="sh">"</span><span class="s">sk-...</span><span class="sh">"</span><span class="s">
      api = </span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="s">
      tool_json = </span><span class="sh">"</span><span class="s">flat</span><span class="sh">"</span><span class="s">
      arg_adapter = </span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="s">
    </span><span class="sh">"""</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">config_path</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="n">raw</span> <span class="o">=</span> <span class="nf">_load_toml_bytes</span><span class="p">(</span><span class="n">config_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">config_path</span><span class="p">.</span><span class="nf">lower</span><span class="p">().</span><span class="nf">endswith</span><span class="p">(</span><span class="sh">"</span><span class="s">.toml</span><span class="sh">"</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">tomllib</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">tomllib</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">tomli</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">tomli</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">TOML parser not available. Use Python 3.11+ or `pip install tomli`.</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">))</span>

    <span class="n">providers_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">api_provider</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">api_providers</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">providers_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ProviderProfile</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">providers_data</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">base_url</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">api_key_env</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">api_key_env</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">api</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">api</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">tool_json</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_json</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">arg_adapter</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arg_adapter</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">model</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">base_url</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">api</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">tool_json</span><span class="p">:</span>
            <span class="c1"># Skip invalid entries silently (or raise, if you prefer)
</span>            <span class="k">continue</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">api_key</span> <span class="ow">and</span> <span class="n">api_key_env</span><span class="p">:</span>
            <span class="n">api_key</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="n">api_key_env</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">api_key</span><span class="p">:</span>
            <span class="c1"># If API key is missing, skip this provider
</span>            <span class="k">continue</span>

        <span class="n">out</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nc">ProviderProfile</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">base_url</span><span class="o">=</span><span class="n">base_url</span><span class="p">,</span>
            <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
            <span class="n">api</span><span class="o">=</span><span class="n">api</span><span class="p">,</span>
            <span class="n">tool_json</span><span class="o">=</span><span class="n">tool_json</span><span class="p">,</span>
            <span class="n">arg_adapter</span><span class="o">=</span><span class="n">arg_adapter</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="c1"># Resolve provider catalog at import-time; can be reloaded in node call if needed
</span><span class="n">DEFAULT_CONFIG_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_PROVIDER_CONFIG</span><span class="sh">"</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="nf">getcwd</span><span class="p">(),</span> <span class="sh">"</span><span class="s">config.toml</span><span class="sh">"</span><span class="p">))</span>
<span class="n">PROVIDER_CATALOG</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ProviderProfile</span><span class="p">]</span> <span class="o">=</span> <span class="nf">load_providers_from_config</span><span class="p">(</span><span class="n">DEFAULT_CONFIG_PATH</span><span class="p">)</span>

<span class="c1"># ============================================================
# Tool layer
# ============================================================
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ToolSpec</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="n">func</span><span class="p">:</span> <span class="n">Any</span>  <span class="c1"># Callable[[Dict[str, Any]], Any]
</span>
<span class="k">class</span> <span class="nc">ToolJSONBuilder</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="bp">...</span>

<span class="k">class</span> <span class="nc">FlatToolJSONBuilder</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Flat tool JSON: { </span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="s">:..., </span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="s">:..., </span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="s">:{...} }</span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">:</span>
            <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">parameters</span><span class="p">,</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">out</span>

<span class="k">class</span> <span class="nc">NestedToolJSONBuilder</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Nested tool JSON: { </span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">:{...} }</span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">:</span>
            <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">parameters</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span> <span class="nf">select_tool_builder</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ToolJSONBuilder</span><span class="p">:</span>
    <span class="n">kind</span> <span class="o">=</span> <span class="p">(</span><span class="n">kind</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">).</span><span class="nf">strip</span><span class="p">().</span><span class="nf">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">flat</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="nc">FlatToolJSONBuilder</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">nested</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="nc">NestedToolJSONBuilder</span><span class="p">()</span>
    <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool_json: </span><span class="si">{</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># Built-in tool implementations (safe local I/O)
</span>
<span class="k">def</span> <span class="nf">_list_files_in_folder</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">folder</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">items</span> <span class="o">=</span> <span class="nf">sorted</span><span class="p">([</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="nf">listdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">f</span><span class="p">))])</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="n">items</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">_read_text_file</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()}</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}</span>

<span class="n">BUILTIN_TOOLS</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ToolSpec</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ToolSpec</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">},</span>
        <span class="n">func</span><span class="o">=</span><span class="n">_list_files_in_folder</span>
    <span class="p">),</span>
    <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ToolSpec</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative path to a text file.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">},</span>
        <span class="n">func</span><span class="o">=</span><span class="n">_read_text_file</span>
    <span class="p">),</span>
<span class="p">}</span>

<span class="c1"># ============================================================
# Neutral params and argument adapters
# ============================================================
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">NeutralParams</span><span class="p">:</span>
    <span class="n">length</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">temperature</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">top_p</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">stop</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">reasoning_effort</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c1"># "low"|"medium"|"high"
</span>
<span class="k">class</span> <span class="nc">ArgAdapter</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">for_responses</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">neutral</span><span class="p">:</span> <span class="n">NeutralParams</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">tools_json</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="bp">...</span>
    <span class="k">def</span> <span class="nf">for_completions</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">neutral</span><span class="p">:</span> <span class="n">NeutralParams</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">tools_json</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="bp">...</span>

<span class="k">class</span> <span class="nc">ResponsesArgAdapter</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">for_responses</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">neutral</span><span class="p">:</span> <span class="n">NeutralParams</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">tools_json</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools_json</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">max_output_tokens</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">length</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">temperature</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">temperature</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">temperature</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">top_p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">top_p</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">top_p</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">stop</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">neutral</span><span class="p">.</span><span class="n">stop</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">reasoning_effort</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">reasoning</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">effort</span><span class="sh">"</span><span class="p">:</span> <span class="n">neutral</span><span class="p">.</span><span class="n">reasoning_effort</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">for_completions</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">neutral</span><span class="p">:</span> <span class="n">NeutralParams</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">tools_json</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools_json</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">max_tokens</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">length</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">temperature</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">temperature</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">temperature</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">top_p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">top_p</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">top_p</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">stop</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">neutral</span><span class="p">.</span><span class="n">stop</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">reasoning_effort</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">reasoning</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">effort</span><span class="sh">"</span><span class="p">:</span> <span class="n">neutral</span><span class="p">.</span><span class="n">reasoning_effort</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">out</span>

<span class="k">class</span> <span class="nc">CompletionsArgAdapter</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">for_responses</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">neutral</span><span class="p">:</span> <span class="n">NeutralParams</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">tools_json</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools_json</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">max_output_tokens</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">length</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">temperature</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">temperature</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">temperature</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">top_p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">top_p</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">top_p</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">stop</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">neutral</span><span class="p">.</span><span class="n">stop</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">reasoning_effort</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">reasoning</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">effort</span><span class="sh">"</span><span class="p">:</span> <span class="n">neutral</span><span class="p">.</span><span class="n">reasoning_effort</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">for_completions</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">neutral</span><span class="p">:</span> <span class="n">NeutralParams</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">tools_json</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools_json</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">max_tokens</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">length</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">temperature</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">temperature</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">temperature</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">top_p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">top_p</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">top_p</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">stop</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">neutral</span><span class="p">.</span><span class="n">stop</span>
        <span class="k">return</span> <span class="n">out</span>

<span class="k">class</span> <span class="nc">CompletionsReasoningArgAdapter</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">for_responses</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">neutral</span><span class="p">:</span> <span class="n">NeutralParams</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">tools_json</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools_json</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">max_output_tokens</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">length</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">temperature</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">temperature</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">temperature</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">top_p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">top_p</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">top_p</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">stop</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">neutral</span><span class="p">.</span><span class="n">stop</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">reasoning_effort</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">reasoning</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">effort</span><span class="sh">"</span><span class="p">:</span> <span class="n">neutral</span><span class="p">.</span><span class="n">reasoning_effort</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">for_completions</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">neutral</span><span class="p">:</span> <span class="n">NeutralParams</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">tools_json</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools_json</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">max_completion_tokens</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">length</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">temperature</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">temperature</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">temperature</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">top_p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">top_p</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">top_p</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">stop</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">neutral</span><span class="p">.</span><span class="n">stop</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">reasoning_effort</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">reasoning</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">effort</span><span class="sh">"</span><span class="p">:</span> <span class="n">neutral</span><span class="p">.</span><span class="n">reasoning_effort</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span> <span class="nf">get_arg_adapter</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ArgAdapter</span><span class="p">:</span>
    <span class="n">kind</span> <span class="o">=</span> <span class="p">(</span><span class="n">kind</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">).</span><span class="nf">strip</span><span class="p">().</span><span class="nf">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="nc">ResponsesArgAdapter</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="nc">CompletionsArgAdapter</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">completions_reasoning</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="nc">CompletionsReasoningArgAdapter</span><span class="p">()</span>
    <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Unknown arg_adapter: </span><span class="si">{</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># ============================================================
# Protocol strategies (async, plain-text)
# ============================================================
</span>
<span class="k">class</span> <span class="nc">ResponsesRunner</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Async Responses loop with local tool execution.</span><span class="sh">"""</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_collect_text</span><span class="p">(</span><span class="n">resp</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
            <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]:</span>
                    <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
            <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
        <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">texts</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_collect_calls</span><span class="p">(</span><span class="n">resp</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="sh">"</span><span class="s">function_call</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                        <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                              <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                              <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{}})</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">inner</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">inner</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">inner</span><span class="p">:</span>
                        <span class="n">nm</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                        <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                                <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                                      <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">nm</span><span class="p">,</span>
                                      <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{}})</span>
        <span class="k">return</span> <span class="n">calls</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">tools</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">:</span> <span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">_exec_tool</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">spec</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">spec</span><span class="p">.</span><span class="nf">func</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">client</span><span class="p">:</span> <span class="n">AsyncOpenAI</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">tools_json</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">payload_args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">user</span><span class="p">:</span> <span class="n">InterruptUser</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># First call
</span>        <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span> <span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools_json</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_choice</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span> <span class="o">**</span><span class="n">payload_args</span><span class="p">}</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">call_with_interrupt</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">),</span> <span class="n">user</span><span class="p">)</span>

        <span class="n">chunks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">_collect_text</span><span class="p">(</span><span class="n">resp</span><span class="p">))</span>
            <span class="n">calls</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_collect_calls</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
                <span class="k">if</span> <span class="k">await</span> <span class="n">user</span><span class="p">.</span><span class="nf">processing_interrupted</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="nc">UserCancelledError</span><span class="p">(</span><span class="sh">"</span><span class="s">Interrupted by user.</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_exec_tool</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
                <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function_call_output</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">[</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)})</span>

            <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span> <span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools_json</span><span class="p">,</span> <span class="o">**</span><span class="n">payload_args</span><span class="p">}</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">call_with_interrupt</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">),</span> <span class="n">user</span><span class="p">)</span>

        <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">chunks</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

<span class="k">class</span> <span class="nc">CompletionsRunner</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Async Chat Completions loop with local tool execution.</span><span class="sh">"""</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">tools</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">:</span> <span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">_exec_tool</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">spec</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">spec</span><span class="p">.</span><span class="nf">func</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">client</span><span class="p">:</span> <span class="n">AsyncOpenAI</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">tools_json</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">payload_args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">user</span><span class="p">:</span> <span class="n">InterruptUser</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools_json</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_choice</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span> <span class="o">**</span><span class="n">payload_args</span><span class="p">}</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">call_with_interrupt</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">),</span> <span class="n">user</span><span class="p">)</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
        <span class="n">chunks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">]</span>
        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">tool_msgs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="k">if</span> <span class="k">await</span> <span class="n">user</span><span class="p">.</span><span class="nf">processing_interrupted</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="nc">UserCancelledError</span><span class="p">(</span><span class="sh">"</span><span class="s">Interrupted by user.</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">fn</span> <span class="o">=</span> <span class="n">tc</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">tc</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_exec_tool</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>
                <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">tc</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)})</span>

            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">]})</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

            <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="o">**</span><span class="n">payload_args</span><span class="p">}</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">call_with_interrupt</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">),</span> <span class="n">user</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
            <span class="k">if</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">content</span><span class="p">)</span>

        <span class="k">return</span> <span class="sh">"</span><span class="se">\n\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">chunks</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

<span class="c1"># ============================================================
# Orchestration
# ============================================================
</span>
<span class="k">def</span> <span class="nf">select_arg_adapter</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ArgAdapter</span><span class="p">:</span>
    <span class="k">return</span> <span class="nf">get_arg_adapter</span><span class="p">(</span><span class="n">kind</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">build_payload</span><span class="p">(</span><span class="n">provider</span><span class="p">:</span> <span class="n">ProviderProfile</span><span class="p">,</span> <span class="n">neutral</span><span class="p">:</span> <span class="n">NeutralParams</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">builder</span> <span class="o">=</span> <span class="nf">select_tool_builder</span><span class="p">(</span><span class="n">provider</span><span class="p">.</span><span class="n">tool_json</span><span class="p">)</span>
    <span class="n">tools_json</span> <span class="o">=</span> <span class="n">builder</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span>
    <span class="n">adapter</span> <span class="o">=</span> <span class="nf">select_arg_adapter</span><span class="p">(</span><span class="n">provider</span><span class="p">.</span><span class="n">arg_adapter</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">provider</span><span class="p">.</span><span class="n">api</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">adapter</span><span class="p">.</span><span class="nf">for_responses</span><span class="p">(</span><span class="n">neutral</span><span class="p">,</span> <span class="n">messages</span><span class="p">,</span> <span class="n">tools_json</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">adapter</span><span class="p">.</span><span class="nf">for_completions</span><span class="p">(</span><span class="n">neutral</span><span class="p">,</span> <span class="n">messages</span><span class="p">,</span> <span class="n">tools_json</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">tools_json</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools_json</span><span class="p">,</span> <span class="sh">"</span><span class="s">payload_args</span><span class="sh">"</span><span class="p">:</span> <span class="n">payload</span><span class="p">}</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_with_provider</span><span class="p">(</span>
    <span class="n">provider</span><span class="p">:</span> <span class="n">ProviderProfile</span><span class="p">,</span>
    <span class="n">system_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">user_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">],</span>
    <span class="n">neutral</span><span class="p">:</span> <span class="n">NeutralParams</span><span class="p">,</span>
    <span class="n">user</span><span class="p">:</span> <span class="n">InterruptUser</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">system_prompt</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_prompt</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="n">built</span> <span class="o">=</span> <span class="nf">build_payload</span><span class="p">(</span><span class="n">provider</span><span class="p">,</span> <span class="n">neutral</span><span class="p">,</span> <span class="n">messages</span><span class="p">,</span> <span class="n">tools</span><span class="p">)</span>
    <span class="n">tools_json</span> <span class="o">=</span> <span class="n">built</span><span class="p">[</span><span class="sh">"</span><span class="s">tools_json</span><span class="sh">"</span><span class="p">]</span>
    <span class="n">payload_args</span> <span class="o">=</span> <span class="n">built</span><span class="p">[</span><span class="sh">"</span><span class="s">payload_args</span><span class="sh">"</span><span class="p">]</span>

    <span class="n">hooks</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">:</span> <span class="p">[],</span> <span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>  <span class="c1"># Add httpx hooks for logging if you want
</span>    <span class="k">async</span> <span class="k">with</span> <span class="n">httpx</span><span class="p">.</span><span class="nc">AsyncClient</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">httpx</span><span class="p">.</span><span class="nc">Timeout</span><span class="p">(</span><span class="mf">60.0</span><span class="p">),</span> <span class="n">event_hooks</span><span class="o">=</span><span class="n">hooks</span><span class="p">)</span> <span class="k">as</span> <span class="n">http_client</span><span class="p">:</span>
        <span class="k">async</span> <span class="k">with</span> <span class="nc">AsyncOpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">provider</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">provider</span><span class="p">.</span><span class="n">api_key</span><span class="p">,</span> <span class="n">http_client</span><span class="o">=</span><span class="n">http_client</span><span class="p">)</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">provider</span><span class="p">.</span><span class="n">api</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">runner</span> <span class="o">=</span> <span class="nc">ResponsesRunner</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">provider</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="n">messages</span><span class="p">,</span> <span class="n">tools_json</span><span class="p">,</span> <span class="n">payload_args</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">runner</span> <span class="o">=</span> <span class="nc">CompletionsRunner</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">provider</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="n">messages</span><span class="p">,</span> <span class="n">tools_json</span><span class="p">,</span> <span class="n">payload_args</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>

<span class="c1"># ============================================================
# Node: OpenAICustomProviderNode
# ============================================================
</span>
<span class="k">class</span> <span class="nc">OpenAICustomProviderNode</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Build a provider profile object directly from the UI.
    </span><span class="sh">"""</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">gpt-4.1-mini</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">api</span><span class="sh">"</span><span class="p">:</span> <span class="p">([</span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">],),</span>
                <span class="sh">"</span><span class="s">tool_json</span><span class="sh">"</span><span class="p">:</span> <span class="p">([</span><span class="sh">"</span><span class="s">flat</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">nested</span><span class="sh">"</span><span class="p">],),</span>
                <span class="sh">"</span><span class="s">arg_adapter</span><span class="sh">"</span><span class="p">:</span> <span class="p">([</span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">completions_reasoning</span><span class="sh">"</span><span class="p">],),</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_PROVIDER</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">provider</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">build</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OpenAI/Provider</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tool_json</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arg_adapter</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">provider</span> <span class="o">=</span> <span class="nc">ProviderProfile</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="s">custom::</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">base_url</span><span class="o">=</span><span class="n">base_url</span><span class="p">,</span>
            <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
            <span class="n">api</span><span class="o">=</span><span class="n">api</span><span class="p">,</span>
            <span class="n">tool_json</span><span class="o">=</span><span class="n">tool_json</span><span class="p">,</span>
            <span class="n">arg_adapter</span><span class="o">=</span><span class="n">arg_adapter</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">provider</span><span class="p">,)</span>

<span class="c1"># ============================================================
# Node: OpenAIToolNode
# ============================================================
</span>
<span class="k">class</span> <span class="nc">OpenAIToolNode</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Compose a list of ToolSpec. If input tools is None, start a new list.
    </span><span class="sh">"""</span>

    <span class="n">BUILTIN_CHOICES</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">BUILTIN_TOOLS</span><span class="p">.</span><span class="nf">keys</span><span class="p">())</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="n">cls</span><span class="p">.</span><span class="n">BUILTIN_CHOICES</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">}),</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">optional</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">tools_in</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_TOOLS</span><span class="sh">"</span><span class="p">,),</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_TOOLS</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">append_tool</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OpenAI/Tools</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">append_tool</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tool</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tools_in</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">speclist</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]</span> <span class="o">=</span> <span class="n">tools_in</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">tools_in</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">BUILTIN_TOOLS</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">tool</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">spec</span><span class="p">:</span>
            <span class="n">speclist</span> <span class="o">=</span> <span class="n">speclist</span> <span class="o">+</span> <span class="p">[</span><span class="n">spec</span><span class="p">]</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">speclist</span><span class="p">,)</span>

<span class="c1"># ============================================================
# Node: OpenAIAdvancedOptionsNode
# ============================================================
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">AdvancedOptions</span><span class="p">:</span>
    <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]</span>
    <span class="n">custom_provider</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ProviderProfile</span><span class="p">]</span>
    <span class="n">system_prompt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">OpenAIAdvancedOptionsNode</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Aggregate optional tools, custom provider, and system prompt into a single options object.
    </span><span class="sh">"""</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">optional</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_TOOLS</span><span class="sh">"</span><span class="p">,),</span>
                <span class="sh">"</span><span class="s">custom_provider</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_PROVIDER</span><span class="sh">"</span><span class="p">,),</span>
                <span class="sh">"</span><span class="s">system_prompt</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}),</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_ADVANCED</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">advanced</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">build</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OpenAI/Options</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">custom_provider</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">system_prompt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span><span class="p">):</span>
        <span class="n">tlist</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]</span> <span class="o">=</span> <span class="n">tools</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">tools</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="n">provider</span> <span class="o">=</span> <span class="n">custom_provider</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">custom_provider</span><span class="p">,</span> <span class="n">ProviderProfile</span><span class="p">)</span> <span class="k">else</span> <span class="bp">None</span>
        <span class="n">sys_prompt</span> <span class="o">=</span> <span class="n">system_prompt</span> <span class="nf">if </span><span class="p">(</span><span class="n">system_prompt</span> <span class="ow">and</span> <span class="n">system_prompt</span><span class="p">.</span><span class="nf">strip</span><span class="p">())</span> <span class="k">else</span> <span class="bp">None</span>
        <span class="nf">return </span><span class="p">(</span><span class="nc">AdvancedOptions</span><span class="p">(</span><span class="n">tlist</span><span class="p">,</span> <span class="n">provider</span><span class="p">,</span> <span class="n">sys_prompt</span><span class="p">),)</span>

<span class="c1"># ============================================================
# Node: OpenAIChatNode (async)
# ============================================================
</span>
<span class="k">class</span> <span class="nc">OpenAIChatNode</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Async chat node that:
      - Loads provider by name from config.toml (OPENAI_PROVIDER_CONFIG or ./config.toml).
      - Optionally overrides with AdvancedOptions.custom_provider.
      - Uses AdvancedOptions.tools and system prompt if provided.
      - Executes a tool-calling loop and returns final text.
    </span><span class="sh">"""</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_provider_names</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="c1"># Reload providers on every call to reflect config changes at runtime
</span>        <span class="k">global</span> <span class="n">PROVIDER_CATALOG</span>
        <span class="n">PROVIDER_CATALOG</span> <span class="o">=</span> <span class="nf">load_providers_from_config</span><span class="p">(</span><span class="n">DEFAULT_CONFIG_PATH</span><span class="p">)</span>
        <span class="k">return</span> <span class="nf">list</span><span class="p">(</span><span class="n">PROVIDER_CATALOG</span><span class="p">.</span><span class="nf">keys</span><span class="p">())</span> <span class="ow">or</span> <span class="p">[</span><span class="sh">"</span><span class="s">&lt;no providers in config&gt;</span><span class="sh">"</span><span class="p">]</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="n">provider_list</span> <span class="o">=</span> <span class="n">cls</span><span class="p">.</span><span class="nf">_provider_names</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">user_prompt</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List files under ./samples, choose one text file, read it, and summarize in 2-3 sentences.</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">provider_name</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="n">provider_list</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="n">provider_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]}),</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">optional</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">advanced</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_ADVANCED</span><span class="sh">"</span><span class="p">,),</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">response_text</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">run</span><span class="sh">"</span>
    <span class="n">OUTPUT_NODE</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OpenAI/Chat</span><span class="sh">"</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">user_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">provider_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">advanced</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="c1"># Resolve provider
</span>        <span class="k">global</span> <span class="n">PROVIDER_CATALOG</span>
        <span class="n">provider</span> <span class="o">=</span> <span class="n">PROVIDER_CATALOG</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">provider_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">advanced</span> <span class="ow">and</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">advanced</span><span class="p">,</span> <span class="n">AdvancedOptions</span><span class="p">)</span> <span class="ow">and</span> <span class="n">advanced</span><span class="p">.</span><span class="n">custom_provider</span><span class="p">:</span>
            <span class="n">provider</span> <span class="o">=</span> <span class="n">advanced</span><span class="p">.</span><span class="n">custom_provider</span>  <span class="c1"># override by advanced
</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">provider</span><span class="p">:</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">[OpenAIChatNode] Error: provider not found. Check config.toml or AdvancedOptions.</span><span class="sh">"</span><span class="p">,)</span>

        <span class="c1"># System prompt
</span>        <span class="n">system_prompt</span> <span class="o">=</span> <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed.</span><span class="sh">"</span>
        <span class="k">if</span> <span class="n">advanced</span> <span class="ow">and</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">advanced</span><span class="p">,</span> <span class="n">AdvancedOptions</span><span class="p">)</span> <span class="ow">and</span> <span class="n">advanced</span><span class="p">.</span><span class="n">system_prompt</span><span class="p">:</span>
            <span class="n">system_prompt</span> <span class="o">=</span> <span class="n">advanced</span><span class="p">.</span><span class="n">system_prompt</span>

        <span class="c1"># Tools
</span>        <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">advanced</span> <span class="ow">and</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">advanced</span><span class="p">,</span> <span class="n">AdvancedOptions</span><span class="p">)</span> <span class="ow">and</span> <span class="n">advanced</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
            <span class="n">tools</span> <span class="o">=</span> <span class="n">advanced</span><span class="p">.</span><span class="n">tools</span>

        <span class="c1"># Neutral parameters (you can expose these as additional node inputs if desired)
</span>        <span class="n">neutral</span> <span class="o">=</span> <span class="nc">NeutralParams</span><span class="p">(</span>
            <span class="n">length</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">temperature</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">top_p</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">stop</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">reasoning_effort</span><span class="o">=</span><span class="bp">None</span>
        <span class="p">)</span>

        <span class="c1"># Interrupt support
</span>        <span class="n">user</span> <span class="o">=</span> <span class="nc">InterruptUser</span><span class="p">()</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_running_loop</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">loop</span><span class="p">.</span><span class="nf">add_signal_handler</span><span class="p">(</span><span class="n">signal</span><span class="p">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">user</span><span class="p">.</span><span class="n">trigger_interrupt</span><span class="p">)</span>
            <span class="n">loop</span><span class="p">.</span><span class="nf">add_signal_handler</span><span class="p">(</span><span class="n">signal</span><span class="p">.</span><span class="n">SIGTERM</span><span class="p">,</span> <span class="n">user</span><span class="p">.</span><span class="n">trigger_interrupt</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="c1"># Not all platforms allow signal handlers (e.g., some Windows envs)
</span>            <span class="k">pass</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">run_with_provider</span><span class="p">(</span>
                <span class="n">provider</span><span class="o">=</span><span class="n">provider</span><span class="p">,</span>
                <span class="n">system_prompt</span><span class="o">=</span><span class="n">system_prompt</span><span class="p">,</span>
                <span class="n">user_prompt</span><span class="o">=</span><span class="n">user_prompt</span><span class="p">,</span>
                <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
                <span class="n">neutral</span><span class="o">=</span><span class="n">neutral</span><span class="p">,</span>
                <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nf">return </span><span class="p">(</span><span class="n">text</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,)</span>
        <span class="k">except</span> <span class="n">UserCancelledError</span><span class="p">:</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">[OpenAIChatNode] Interrupted by user.</span><span class="sh">"</span><span class="p">,)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nf">return </span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[OpenAIChatNode] Error: </span><span class="si">{</span><span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">,)</span>

<span class="c1"># ============================================================
# ComfyUI registration
# ============================================================
</span>
<span class="n">NODE_CLASS_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">OpenAIChatNode</span><span class="sh">"</span><span class="p">:</span> <span class="n">OpenAIChatNode</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">OpenAIToolNode</span><span class="sh">"</span><span class="p">:</span> <span class="n">OpenAIToolNode</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">OpenAICustomProviderNode</span><span class="sh">"</span><span class="p">:</span> <span class="n">OpenAICustomProviderNode</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">OpenAIAdvancedOptionsNode</span><span class="sh">"</span><span class="p">:</span> <span class="n">OpenAIAdvancedOptionsNode</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">NODE_DISPLAY_NAME_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">OpenAIChatNode</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">OpenAI Chat (Async)</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">OpenAIToolNode</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">OpenAI Tool Builder</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">OpenAICustomProviderNode</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">OpenAI Custom Provider</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">OpenAIAdvancedOptionsNode</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">OpenAI Advanced Options</span><span class="sh">"</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div>

<p>설치와 사용 방법 요약</p>

<ol>
  <li>파일 배치</li>
</ol>

<ul>
  <li>
    <p>위 코드를 <code class="language-plaintext highlighter-rouge">ComfyUI/custom_nodes/openai_comfy_nodes.py</code>로 저장.</p>
  </li>
  <li>
    <p>OpenAI 파이썬 SDK와 httpx 설치: <code class="language-plaintext highlighter-rouge">pip install --upgrade openai httpx</code></p>
  </li>
</ul>

<ol>
  <li>config.toml 작성</li>
</ol>

<ul>
  <li>
    <p>ComfyUI 루트(또는 원하는 경로)에 <code class="language-plaintext highlighter-rouge">config.toml</code> 생성. 환경 변수 <code class="language-plaintext highlighter-rouge">OPENAI_PROVIDER_CONFIG</code>로 경로를 바꿀 수 있음.</p>
  </li>
  <li>
    <p>예시:</p>
  </li>
</ul>

<div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[[api_provider]</span><span class="err">]</span>
<span class="py">name</span> <span class="p">=</span> <span class="s">"OSS GPT (Responses + Flat + RespAdapter)"</span>
<span class="py">model</span> <span class="p">=</span> <span class="s">"gpt-4.1-mini"</span>
<span class="py">base_url</span> <span class="p">=</span> <span class="s">"https://api.openai.com/v1"</span>
<span class="py">api_key_env</span> <span class="p">=</span> <span class="s">"OPENAI_API_KEY"</span>
<span class="py">api</span> <span class="p">=</span> <span class="s">"responses"</span>
<span class="py">tool_json</span> <span class="p">=</span> <span class="s">"flat"</span>
<span class="py">arg_adapter</span> <span class="p">=</span> <span class="s">"responses"</span>

<span class="nn">[[api_provider]</span><span class="err">]</span>
<span class="py">name</span> <span class="p">=</span> <span class="s">"Qwen-like (Completions + Nested + CompAdapter)"</span>
<span class="py">model</span> <span class="p">=</span> <span class="s">"qwen2.5"</span>
<span class="py">base_url</span> <span class="p">=</span> <span class="s">"https://api.openai.com/v1"</span>
<span class="py">api_key_env</span> <span class="p">=</span> <span class="s">"QWEN_API_KEY"</span>
<span class="py">api</span> <span class="p">=</span> <span class="s">"completions"</span>
<span class="py">tool_json</span> <span class="p">=</span> <span class="s">"nested"</span>
<span class="py">arg_adapter</span> <span class="p">=</span> <span class="s">"completions"</span>
</code></pre></div></div>

<ol>
  <li>워크플로 구성</li>
</ol>

<ul>
  <li>
    <p>OpenAIToolNode를 여러 개 연결해서 tools 리스트를 만든다. (예: list_files_in_folder → read_text_file)</p>
  </li>
  <li>
    <p>OpenAICustomProviderNode로 즉석 provider를 만들 수 있고, 또는 config.toml에 있는 provider를 선택할 수도 있다.</p>
  </li>
  <li>
    <p>OpenAIAdvancedOptionsNode에 tools, custom provider, system prompt를 연결해 AdvancedOptions를 만든다.</p>
  </li>
  <li>
    <p>OpenAIChatNode에 user_prompt와 provider_name(드롭다운)을 주고, AdvancedOptions를 선택적으로 붙인다.</p>
  </li>
  <li>
    <p>실행하면 최종 응답 텍스트 1개를 반환한다.</p>
  </li>
</ul>

<p>확장 포인트</p>

<ul>
  <li>
    <p>파라미터 노출: OpenAIChatNode INPUT_TYPES에 length/temperature/top_p/stop/reasoning_effort를 옵션으로 추가하고 NeutralParams에 반영하면 UI에서 쉽게 조절 가능.</p>
  </li>
  <li>
    <p>더 많은 툴: OpenAIToolNode에 BUILTIN_TOOLS를 확장하거나, 툴을 동적으로 주입하는 별도 노드를 만들어도 된다.</p>
  </li>
  <li>
    <p>로깅/디버깅: httpx 이벤트 훅으로 요청 페이로드를 캡처해 파일로 남길 수 있다.</p>
  </li>
  <li>
    <p>스트리밍: SDK 스트리밍을 쓰고 싶다면 Responses/Completions 러너에서 스트림 처리 분기를 추가하되, ComfyUI의 프론트엔드 표시 방식에 맞춰야 한다.</p>
  </li>
</ul>

<p>필요하면 length/temperature/top_p 같은 매개변수 입력을 바로 Chat 노드에 노출해줄 수도 있어.</p>

<p class="chat--user">

아 확장 더 필요해. 너가 말한대로 파라미터 정의 advanced node에 parameters를 multiline으로 받게 해줘. 이 때 json 입력이 기본인데 생각보다 대충 입력해도 잘 알아들을 수 있게 처리해두면 좋겠어. 예를 들어 그냥 reasoning_effort: high max_tokens: 1024 이런 식으로 json 포맷 안 맞춰서 써도 잘 parsing하면 좋겠어. 그리고 생각해보니 CustomProvider 노드 쪽에 arg_adapter도 지정 필요할 것 같네

</p>

<p>아래는 요청하신 확장 사항을 반영한 최신 ComfyUI 커스텀 노드 전체 코드예요. 핵심 변경점은 OpenAIAdvancedOptionsNode에 parameters(멀티라인) 입력을 추가하고, 매우 느슨한 파서로 JSON이 아니어도 “key: value” 형식을 유연하게 해석해 NeutralParams로 변환하도록 했다는 점입니다. 또한 OpenAICustomProviderNode에는 arg_adapter 입력이 이미 포함되어 있으며, 이 값을 사용합니다.</p>

<p>파일명 예시: ComfyUI/custom_nodes/openai_comfy_nodes.py</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># openai_comfy_nodes.py
# Python 3.10+
# Dependencies:
#   pip install --upgrade openai httpx
#
# Nodes:
#   1) OpenAIChatNode (async)
#   2) OpenAIToolNode
#   3) OpenAICustomProviderNode
#   4) OpenAIAdvancedOptionsNode
#
# Highlights:
# - Async-only execution with AsyncOpenAI + httpx.AsyncClient.
# - Provider selection from config.toml (env OPENAI_PROVIDER_CONFIG or ./config.toml).
# - Optional AdvancedOptions: tools, custom provider override, system prompt, and neutral parameters.
# - Neutral parameters are accepted as multiline "parameters" (loose parser):
#     Examples:
#       reasoning_effort: high
#       max_tokens: 1024
#       temperature: 0.7
#       top_p: 0.9
#       stop: [END, ###]
#   - JSON is also accepted; if not JSON, a permissive line parser is used.
# - Supports Responses/Completions, flat/nested tool JSON, and arg adapters
#   ("responses" | "completions" | "completions_reasoning").
#
# Note:
# - This node returns plain text only.
# - If your ComfyUI build provides task cancellation hooks, wire them into InterruptUser.trigger_interrupt().
</span>
<span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">re</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">signal</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Protocol</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomllib</span>  <span class="c1"># Python 3.11+
</span><span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">tomllib</span> <span class="o">=</span> <span class="bp">None</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomli</span>  <span class="c1"># Fallback TOML parser
</span><span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">tomli</span> <span class="o">=</span> <span class="bp">None</span>

<span class="kn">import</span> <span class="n">httpx</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">AsyncOpenAI</span>

<span class="c1"># =========================
# Interrupt helpers
# =========================
</span>
<span class="k">class</span> <span class="nc">UserCancelledError</span><span class="p">(</span><span class="nb">Exception</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Raised when the user has interrupted the processing.</span><span class="sh">"""</span>

<span class="k">class</span> <span class="nc">InterruptUser</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Minimal interrupt controller. If ComfyUI cancels the task, awaiting the
    underlying operation will usually raise. We also expose a cooperative flag.
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_event</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Event</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">trigger_interrupt</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_event</span><span class="p">.</span><span class="nf">set</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">processing_interrupted</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_event</span><span class="p">.</span><span class="nf">is_set</span><span class="p">()</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">call_with_interrupt</span><span class="p">(</span><span class="n">awaitable</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="n">InterruptUser</span><span class="p">,</span> <span class="n">poll</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Await an I/O operation while polling for user interruption.
    If interrupted, cancel and raise UserCancelledError.
    </span><span class="sh">"""</span>
    <span class="n">task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="n">awaitable</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">({</span><span class="n">task</span><span class="p">},</span> <span class="n">timeout</span><span class="o">=</span><span class="n">poll</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">task</span><span class="p">.</span><span class="nf">result</span><span class="p">()</span>
            <span class="k">if</span> <span class="k">await</span> <span class="n">user</span><span class="p">.</span><span class="nf">processing_interrupted</span><span class="p">():</span>
                <span class="n">task</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">task</span>
                <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">raise</span> <span class="nc">UserCancelledError</span><span class="p">(</span><span class="sh">"</span><span class="s">Interrupted by user.</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">raise</span>

<span class="c1"># =========================
# Config loading (api_provider catalog)
# =========================
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ProviderProfile</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">model</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">api</span><span class="p">:</span> <span class="nb">str</span>          <span class="c1"># "responses" | "completions"
</span>    <span class="n">tool_json</span><span class="p">:</span> <span class="nb">str</span>    <span class="c1"># "flat" | "nested"
</span>    <span class="n">arg_adapter</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># "responses" | "completions" | "completions_reasoning"
</span>
<span class="k">def</span> <span class="nf">_load_toml_bytes</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
    <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">load_providers_from_config</span><span class="p">(</span><span class="n">config_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ProviderProfile</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">
    Expected TOML schema:

    [[api_provider]]
    name = </span><span class="sh">"</span><span class="s">OSS GPT (Responses + Flat + RespAdapter)</span><span class="sh">"</span><span class="s">
    model = </span><span class="sh">"</span><span class="s">gpt-4.1-mini</span><span class="sh">"</span><span class="s">
    base_url = </span><span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="s">
    api_key_env = </span><span class="sh">"</span><span class="s">OPENAI_API_KEY</span><span class="sh">"</span><span class="s">   # or api_key = </span><span class="sh">"</span><span class="s">sk-...</span><span class="sh">"</span><span class="s">
    api = </span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="s">                # </span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="s"> | </span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="s">
    tool_json = </span><span class="sh">"</span><span class="s">flat</span><span class="sh">"</span><span class="s">               # </span><span class="sh">"</span><span class="s">flat</span><span class="sh">"</span><span class="s"> | </span><span class="sh">"</span><span class="s">nested</span><span class="sh">"</span><span class="s">
    arg_adapter = </span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="s">        # </span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="s"> | </span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="s"> | </span><span class="sh">"</span><span class="s">completions_reasoning</span><span class="sh">"</span><span class="s">
    </span><span class="sh">"""</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">config_path</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="n">raw</span> <span class="o">=</span> <span class="nf">_load_toml_bytes</span><span class="p">(</span><span class="n">config_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">config_path</span><span class="p">.</span><span class="nf">lower</span><span class="p">().</span><span class="nf">endswith</span><span class="p">(</span><span class="sh">"</span><span class="s">.toml</span><span class="sh">"</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">tomllib</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">tomllib</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">tomli</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">tomli</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">TOML parser not available. Use Python 3.11+ or `pip install tomli`.</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">))</span>

    <span class="n">providers_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">api_provider</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">api_providers</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">providers_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ProviderProfile</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">providers_data</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">base_url</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">api_key_env</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">api_key_env</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">api</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">api</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">tool_json</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_json</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">arg_adapter</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arg_adapter</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">model</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">base_url</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">api</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">tool_json</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">api_key</span> <span class="ow">and</span> <span class="n">api_key_env</span><span class="p">:</span>
            <span class="n">api_key</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="n">api_key_env</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">api_key</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">out</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nc">ProviderProfile</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">base_url</span><span class="o">=</span><span class="n">base_url</span><span class="p">,</span>
            <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
            <span class="n">api</span><span class="o">=</span><span class="n">api</span><span class="p">,</span>
            <span class="n">tool_json</span><span class="o">=</span><span class="n">tool_json</span><span class="p">,</span>
            <span class="n">arg_adapter</span><span class="o">=</span><span class="n">arg_adapter</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="n">DEFAULT_CONFIG_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_PROVIDER_CONFIG</span><span class="sh">"</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="nf">getcwd</span><span class="p">(),</span> <span class="sh">"</span><span class="s">config.toml</span><span class="sh">"</span><span class="p">))</span>
<span class="n">PROVIDER_CATALOG</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ProviderProfile</span><span class="p">]</span> <span class="o">=</span> <span class="nf">load_providers_from_config</span><span class="p">(</span><span class="n">DEFAULT_CONFIG_PATH</span><span class="p">)</span>

<span class="c1"># =========================
# Tool layer
# =========================
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ToolSpec</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="n">func</span><span class="p">:</span> <span class="n">Any</span>  <span class="c1"># Callable[[Dict[str, Any]], Any]
</span>
<span class="k">class</span> <span class="nc">ToolJSONBuilder</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="bp">...</span>

<span class="k">class</span> <span class="nc">FlatToolJSONBuilder</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Flat tool JSON: { </span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="s">:..., </span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="s">:..., </span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="s">:{...} }</span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">:</span>
            <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">parameters</span><span class="p">,</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">out</span>

<span class="k">class</span> <span class="nc">NestedToolJSONBuilder</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Nested tool JSON: { </span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">:{...} }</span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">:</span>
            <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">parameters</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span> <span class="nf">select_tool_builder</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ToolJSONBuilder</span><span class="p">:</span>
    <span class="n">kind</span> <span class="o">=</span> <span class="p">(</span><span class="n">kind</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">).</span><span class="nf">strip</span><span class="p">().</span><span class="nf">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">flat</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="nc">FlatToolJSONBuilder</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">nested</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="nc">NestedToolJSONBuilder</span><span class="p">()</span>
    <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool_json: </span><span class="si">{</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># Built-in tools (safe local I/O)
</span>
<span class="k">def</span> <span class="nf">_list_files_in_folder</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">folder</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">items</span> <span class="o">=</span> <span class="nf">sorted</span><span class="p">([</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="nf">listdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">f</span><span class="p">))])</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="n">items</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">_read_text_file</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()}</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}</span>

<span class="n">BUILTIN_TOOLS</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ToolSpec</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ToolSpec</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">},</span>
        <span class="n">func</span><span class="o">=</span><span class="n">_list_files_in_folder</span>
    <span class="p">),</span>
    <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ToolSpec</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative path to a text file.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">},</span>
        <span class="n">func</span><span class="o">=</span><span class="n">_read_text_file</span>
    <span class="p">),</span>
<span class="p">}</span>

<span class="c1"># =========================
# Neutral params and arg adapters
# =========================
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">NeutralParams</span><span class="p">:</span>
    <span class="n">length</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">temperature</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">top_p</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">stop</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">reasoning_effort</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c1"># "low"|"medium"|"high"
</span>
<span class="k">class</span> <span class="nc">ArgAdapter</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">for_responses</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">neutral</span><span class="p">:</span> <span class="n">NeutralParams</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">tools_json</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="bp">...</span>
    <span class="k">def</span> <span class="nf">for_completions</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">neutral</span><span class="p">:</span> <span class="n">NeutralParams</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">tools_json</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="bp">...</span>

<span class="k">class</span> <span class="nc">ResponsesArgAdapter</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">for_responses</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">neutral</span><span class="p">:</span> <span class="n">NeutralParams</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">tools_json</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools_json</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">max_output_tokens</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">length</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">temperature</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">temperature</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">temperature</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">top_p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">top_p</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">top_p</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">stop</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">neutral</span><span class="p">.</span><span class="n">stop</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">reasoning_effort</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">reasoning</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">effort</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">reasoning_effort</span><span class="p">)}</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">for_completions</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">neutral</span><span class="p">:</span> <span class="n">NeutralParams</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">tools_json</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools_json</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">max_tokens</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">length</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">temperature</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">temperature</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">temperature</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">top_p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">top_p</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">top_p</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">stop</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">neutral</span><span class="p">.</span><span class="n">stop</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">reasoning_effort</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">reasoning</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">effort</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">reasoning_effort</span><span class="p">)}</span>
        <span class="k">return</span> <span class="n">out</span>

<span class="k">class</span> <span class="nc">CompletionsArgAdapter</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">for_responses</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">neutral</span><span class="p">:</span> <span class="n">NeutralParams</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">tools_json</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools_json</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">max_output_tokens</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">length</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">temperature</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">temperature</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">temperature</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">top_p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">top_p</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">top_p</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">stop</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">neutral</span><span class="p">.</span><span class="n">stop</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">reasoning_effort</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">reasoning</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">effort</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">reasoning_effort</span><span class="p">)}</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">for_completions</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">neutral</span><span class="p">:</span> <span class="n">NeutralParams</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">tools_json</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools_json</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">max_tokens</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">length</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">temperature</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">temperature</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">temperature</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">top_p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">top_p</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">top_p</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">stop</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">neutral</span><span class="p">.</span><span class="n">stop</span>
        <span class="k">return</span> <span class="n">out</span>

<span class="k">class</span> <span class="nc">CompletionsReasoningArgAdapter</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">for_responses</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">neutral</span><span class="p">:</span> <span class="n">NeutralParams</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">tools_json</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools_json</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">max_output_tokens</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">length</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">temperature</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">temperature</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">temperature</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">top_p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">top_p</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">top_p</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">stop</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">neutral</span><span class="p">.</span><span class="n">stop</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">reasoning_effort</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">reasoning</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">effort</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">reasoning_effort</span><span class="p">)}</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">for_completions</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">neutral</span><span class="p">:</span> <span class="n">NeutralParams</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">tools_json</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools_json</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">max_completion_tokens</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">length</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">temperature</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">temperature</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">temperature</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">top_p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">top_p</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">top_p</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">stop</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">neutral</span><span class="p">.</span><span class="n">stop</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">reasoning_effort</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">reasoning</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">effort</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">reasoning_effort</span><span class="p">)}</span>
        <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span> <span class="nf">get_arg_adapter</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ArgAdapter</span><span class="p">:</span>
    <span class="n">kind</span> <span class="o">=</span> <span class="p">(</span><span class="n">kind</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">).</span><span class="nf">strip</span><span class="p">().</span><span class="nf">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="nc">ResponsesArgAdapter</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="nc">CompletionsArgAdapter</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">completions_reasoning</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="nc">CompletionsReasoningArgAdapter</span><span class="p">()</span>
    <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Unknown arg_adapter: </span><span class="si">{</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># =========================
# Protocol runners (async)
# =========================
</span>
<span class="k">class</span> <span class="nc">ResponsesRunner</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Async Responses loop with local tool execution.</span><span class="sh">"""</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_collect_text</span><span class="p">(</span><span class="n">resp</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
            <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]:</span>
                    <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
            <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
        <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">texts</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_collect_calls</span><span class="p">(</span><span class="n">resp</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="sh">"</span><span class="s">function_call</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                        <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                              <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                              <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{}})</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">inner</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">inner</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">inner</span><span class="p">:</span>
                        <span class="n">nm</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                        <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                                <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                                      <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">nm</span><span class="p">,</span>
                                      <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{}})</span>
        <span class="k">return</span> <span class="n">calls</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">tools</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">:</span> <span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">_exec_tool</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">spec</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">spec</span><span class="p">.</span><span class="nf">func</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">client</span><span class="p">:</span> <span class="n">AsyncOpenAI</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">tools_json</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">payload_args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">user</span><span class="p">:</span> <span class="n">InterruptUser</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span> <span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools_json</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_choice</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span> <span class="o">**</span><span class="n">payload_args</span><span class="p">}</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">call_with_interrupt</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">),</span> <span class="n">user</span><span class="p">)</span>

        <span class="n">chunks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">_collect_text</span><span class="p">(</span><span class="n">resp</span><span class="p">))</span>
            <span class="n">calls</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_collect_calls</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
                <span class="k">if</span> <span class="k">await</span> <span class="n">user</span><span class="p">.</span><span class="nf">processing_interrupted</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="nc">UserCancelledError</span><span class="p">(</span><span class="sh">"</span><span class="s">Interrupted by user.</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_exec_tool</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
                <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function_call_output</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">[</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)})</span>

            <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span> <span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools_json</span><span class="p">,</span> <span class="o">**</span><span class="n">payload_args</span><span class="p">}</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">call_with_interrupt</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">),</span> <span class="n">user</span><span class="p">)</span>

        <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">chunks</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

<span class="k">class</span> <span class="nc">CompletionsRunner</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Async Chat Completions loop with local tool execution.</span><span class="sh">"""</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">tools</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">:</span> <span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">_exec_tool</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">spec</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">spec</span><span class="p">.</span><span class="nf">func</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">client</span><span class="p">:</span> <span class="n">AsyncOpenAI</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">tools_json</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">payload_args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">user</span><span class="p">:</span> <span class="n">InterruptUser</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools_json</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_choice</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span> <span class="o">**</span><span class="n">payload_args</span><span class="p">}</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">call_with_interrupt</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">),</span> <span class="n">user</span><span class="p">)</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
        <span class="n">chunks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">]</span>
        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">tool_msgs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="k">if</span> <span class="k">await</span> <span class="n">user</span><span class="p">.</span><span class="nf">processing_interrupted</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="nc">UserCancelledError</span><span class="p">(</span><span class="sh">"</span><span class="s">Interrupted by user.</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">fn</span> <span class="o">=</span> <span class="n">tc</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">tc</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_exec_tool</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>
                <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">tc</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)})</span>

            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">]})</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

            <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="o">**</span><span class="n">payload_args</span><span class="p">}</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">call_with_interrupt</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">),</span> <span class="n">user</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
            <span class="k">if</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">content</span><span class="p">)</span>

        <span class="k">return</span> <span class="sh">"</span><span class="se">\n\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">chunks</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

<span class="c1"># =========================
# Orchestration helpers
# =========================
</span>
<span class="k">def</span> <span class="nf">select_arg_adapter</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ArgAdapter</span><span class="p">:</span>
    <span class="k">return</span> <span class="nf">get_arg_adapter</span><span class="p">(</span><span class="n">kind</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">build_payload</span><span class="p">(</span><span class="n">provider</span><span class="p">:</span> <span class="n">ProviderProfile</span><span class="p">,</span> <span class="n">neutral</span><span class="p">:</span> <span class="n">NeutralParams</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">builder</span> <span class="o">=</span> <span class="nf">select_tool_builder</span><span class="p">(</span><span class="n">provider</span><span class="p">.</span><span class="n">tool_json</span><span class="p">)</span>
    <span class="n">tools_json</span> <span class="o">=</span> <span class="n">builder</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span>
    <span class="n">adapter</span> <span class="o">=</span> <span class="nf">select_arg_adapter</span><span class="p">(</span><span class="n">provider</span><span class="p">.</span><span class="n">arg_adapter</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">provider</span><span class="p">.</span><span class="n">api</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">adapter</span><span class="p">.</span><span class="nf">for_responses</span><span class="p">(</span><span class="n">neutral</span><span class="p">,</span> <span class="n">messages</span><span class="p">,</span> <span class="n">tools_json</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">adapter</span><span class="p">.</span><span class="nf">for_completions</span><span class="p">(</span><span class="n">neutral</span><span class="p">,</span> <span class="n">messages</span><span class="p">,</span> <span class="n">tools_json</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">tools_json</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools_json</span><span class="p">,</span> <span class="sh">"</span><span class="s">payload_args</span><span class="sh">"</span><span class="p">:</span> <span class="n">payload</span><span class="p">}</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_with_provider</span><span class="p">(</span>
    <span class="n">provider</span><span class="p">:</span> <span class="n">ProviderProfile</span><span class="p">,</span>
    <span class="n">system_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">user_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">],</span>
    <span class="n">neutral</span><span class="p">:</span> <span class="n">NeutralParams</span><span class="p">,</span>
    <span class="n">user</span><span class="p">:</span> <span class="n">InterruptUser</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">system_prompt</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_prompt</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="n">built</span> <span class="o">=</span> <span class="nf">build_payload</span><span class="p">(</span><span class="n">provider</span><span class="p">,</span> <span class="n">neutral</span><span class="p">,</span> <span class="n">messages</span><span class="p">,</span> <span class="n">tools</span><span class="p">)</span>
    <span class="n">tools_json</span> <span class="o">=</span> <span class="n">built</span><span class="p">[</span><span class="sh">"</span><span class="s">tools_json</span><span class="sh">"</span><span class="p">]</span>
    <span class="n">payload_args</span> <span class="o">=</span> <span class="n">built</span><span class="p">[</span><span class="sh">"</span><span class="s">payload_args</span><span class="sh">"</span><span class="p">]</span>

    <span class="n">hooks</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">:</span> <span class="p">[],</span> <span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">httpx</span><span class="p">.</span><span class="nc">AsyncClient</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">httpx</span><span class="p">.</span><span class="nc">Timeout</span><span class="p">(</span><span class="mf">60.0</span><span class="p">),</span> <span class="n">event_hooks</span><span class="o">=</span><span class="n">hooks</span><span class="p">)</span> <span class="k">as</span> <span class="n">http_client</span><span class="p">:</span>
        <span class="k">async</span> <span class="k">with</span> <span class="nc">AsyncOpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">provider</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">provider</span><span class="p">.</span><span class="n">api_key</span><span class="p">,</span> <span class="n">http_client</span><span class="o">=</span><span class="n">http_client</span><span class="p">)</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">provider</span><span class="p">.</span><span class="n">api</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">runner</span> <span class="o">=</span> <span class="nc">ResponsesRunner</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">provider</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="n">messages</span><span class="p">,</span> <span class="n">tools_json</span><span class="p">,</span> <span class="n">payload_args</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">runner</span> <span class="o">=</span> <span class="nc">CompletionsRunner</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">provider</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="n">messages</span><span class="p">,</span> <span class="n">tools_json</span><span class="p">,</span> <span class="n">payload_args</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>

<span class="c1"># =========================
# Loose parameters parsing
# =========================
</span>
<span class="k">def</span> <span class="nf">_try_json_loads</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">_parse_scalar</span><span class="p">(</span><span class="n">v</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">t</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">false</span><span class="sh">"</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">t</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="o">==</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span>
    <span class="k">if</span> <span class="n">t</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">null</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">none</span><span class="sh">"</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="c1"># Try numeric
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">re</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">^-?\d+$</span><span class="sh">"</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
            <span class="k">return</span> <span class="nf">int</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">re</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">^-?\d+\.\d+$</span><span class="sh">"</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
            <span class="k">return</span> <span class="nf">float</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="c1"># JSON-looking lists or dicts
</span>    <span class="nf">if </span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">[</span><span class="sh">"</span><span class="p">)</span> <span class="ow">and</span> <span class="n">t</span><span class="p">.</span><span class="nf">endswith</span><span class="p">(</span><span class="sh">"</span><span class="s">]</span><span class="sh">"</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">{</span><span class="sh">"</span><span class="p">)</span> <span class="ow">and</span> <span class="n">t</span><span class="p">.</span><span class="nf">endswith</span><span class="p">(</span><span class="sh">"</span><span class="s">}</span><span class="sh">"</span><span class="p">)):</span>
        <span class="n">j</span> <span class="o">=</span> <span class="nf">_try_json_loads</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">j</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">j</span>
    <span class="c1"># Comma-separated list (fallback)
</span>    <span class="k">if</span> <span class="sh">"</span><span class="s">,</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">t</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="p">)]</span>
        <span class="k">return</span> <span class="p">[</span><span class="nf">_parse_scalar</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">t</span>

<span class="k">def</span> <span class="nf">parse_loose_params</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">
    Permissive parser:
      1) Try JSON first.
      2) Else parse line-by-line </span><span class="sh">"</span><span class="s">key: value</span><span class="sh">"</span><span class="s"> or </span><span class="sh">"</span><span class="s">key = value</span><span class="sh">"</span><span class="s">.
         - Ignores empty lines and comment lines starting with # // ;
         - Values auto-typed (bool, null, int, float, JSON, comma-list, string).
    </span><span class="sh">"""</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">text</span><span class="p">.</span><span class="nf">strip</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="n">j</span> <span class="o">=</span> <span class="nf">_try_json_loads</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">j</span>

    <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">text</span><span class="p">.</span><span class="nf">splitlines</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">raw</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">raw</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">line</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">#</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">line</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">//</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">line</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">;</span><span class="sh">"</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="c1"># Strip trailing in-line comments (only # as heuristic)
</span>        <span class="n">line</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">\s+#</span><span class="sh">"</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nf">strip</span><span class="p">()</span>

        <span class="c1"># Split on first ":" or "="
</span>        <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">\s*[:=]\s*</span><span class="sh">"</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">strip</span><span class="p">(),</span> <span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="c1"># Normalize key: lower + replace spaces/hyphens with underscores
</span>        <span class="n">norm_key</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">sub</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">[\s\-]+</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">_</span><span class="sh">"</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="nf">lower</span><span class="p">())</span>
        <span class="n">out</span><span class="p">[</span><span class="n">norm_key</span><span class="p">]</span> <span class="o">=</span> <span class="nf">_parse_scalar</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span> <span class="nf">normalize_to_neutral</span><span class="p">(</span><span class="n">d</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">NeutralParams</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Map arbitrary keys into NeutralParams.
    Recognized keys:
      - length | max_tokens | max_output_tokens | max_completion_tokens
      - temperature
      - top_p
      - stop (list or comma-separated string)
      - reasoning_effort | effort | reasoning.effort | reasoning:{effort:...}
    </span><span class="sh">"""</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="nc">NeutralParams</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">pick_int</span><span class="p">(</span><span class="o">*</span><span class="n">keys</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">d</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
                <span class="k">return</span> <span class="nf">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="nf">int</span><span class="p">(</span><span class="nf">float</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">pick_float</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">d</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">return</span> <span class="nf">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="nf">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">pick_stop</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">d</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">stop</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">v</span><span class="p">]</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="c1"># Try parse JSON array first
</span>            <span class="n">j</span> <span class="o">=</span> <span class="nf">_try_json_loads</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">j</span><span class="p">]</span>
            <span class="c1"># Else comma-split
</span>            <span class="k">return</span> <span class="p">[</span><span class="n">s</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">v</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="p">)</span> <span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="nf">strip</span><span class="p">()]</span>
        <span class="c1"># Fallback: single token
</span>        <span class="k">return</span> <span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="n">v</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">pick_effort</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="c1"># Prefer explicit keys; fallback to nested dict
</span>        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">reasoning_effort</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">effort</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">reasoning.effort</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">d</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">v</span><span class="p">.</span><span class="nf">strip</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">v</span><span class="p">.</span><span class="nf">strip</span><span class="p">().</span><span class="nf">lower</span><span class="p">()</span>
        <span class="n">reason</span> <span class="o">=</span> <span class="n">d</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">reasoning</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">reason</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">reason</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">effort</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">v</span><span class="p">.</span><span class="nf">strip</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">v</span><span class="p">.</span><span class="nf">strip</span><span class="p">().</span><span class="nf">lower</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="n">length</span> <span class="o">=</span> <span class="nf">pick_int</span><span class="p">(</span><span class="sh">"</span><span class="s">length</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">max_tokens</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">max_output_tokens</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">max_completion_tokens</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">temperature</span> <span class="o">=</span> <span class="nf">pick_float</span><span class="p">(</span><span class="sh">"</span><span class="s">temperature</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">top_p</span> <span class="o">=</span> <span class="nf">pick_float</span><span class="p">(</span><span class="sh">"</span><span class="s">top_p</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">stop</span> <span class="o">=</span> <span class="nf">pick_stop</span><span class="p">()</span>
    <span class="n">effort</span> <span class="o">=</span> <span class="nf">pick_effort</span><span class="p">()</span>

    <span class="k">return</span> <span class="nc">NeutralParams</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="n">length</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">,</span> <span class="n">top_p</span><span class="o">=</span><span class="n">top_p</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">stop</span><span class="p">,</span> <span class="n">reasoning_effort</span><span class="o">=</span><span class="n">effort</span><span class="p">)</span>

<span class="c1"># =========================
# Nodes
# =========================
</span>
<span class="k">class</span> <span class="nc">OpenAICustomProviderNode</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Build a provider profile directly from UI inputs.
    </span><span class="sh">"""</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">gpt-4.1-mini</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">api</span><span class="sh">"</span><span class="p">:</span> <span class="p">([</span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">],),</span>
                <span class="sh">"</span><span class="s">tool_json</span><span class="sh">"</span><span class="p">:</span> <span class="p">([</span><span class="sh">"</span><span class="s">flat</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">nested</span><span class="sh">"</span><span class="p">],),</span>
                <span class="sh">"</span><span class="s">arg_adapter</span><span class="sh">"</span><span class="p">:</span> <span class="p">([</span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">completions_reasoning</span><span class="sh">"</span><span class="p">],),</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_PROVIDER</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">provider</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">build</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OpenAI/Provider</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tool_json</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arg_adapter</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">provider</span> <span class="o">=</span> <span class="nc">ProviderProfile</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="s">custom::</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">base_url</span><span class="o">=</span><span class="n">base_url</span><span class="p">,</span>
            <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
            <span class="n">api</span><span class="o">=</span><span class="n">api</span><span class="p">,</span>
            <span class="n">tool_json</span><span class="o">=</span><span class="n">tool_json</span><span class="p">,</span>
            <span class="n">arg_adapter</span><span class="o">=</span><span class="n">arg_adapter</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">provider</span><span class="p">,)</span>

<span class="k">class</span> <span class="nc">OpenAIToolNode</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Compose a list of ToolSpec. If input list is None, start a new list.
    </span><span class="sh">"""</span>

    <span class="n">BUILTIN_CHOICES</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">BUILTIN_TOOLS</span><span class="p">.</span><span class="nf">keys</span><span class="p">())</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="n">cls</span><span class="p">.</span><span class="n">BUILTIN_CHOICES</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">}),</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">optional</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">tools_in</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_TOOLS</span><span class="sh">"</span><span class="p">,),</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_TOOLS</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">append_tool</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OpenAI/Tools</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">append_tool</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tool</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tools_in</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">speclist</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]</span> <span class="o">=</span> <span class="n">tools_in</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">tools_in</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">BUILTIN_TOOLS</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">tool</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">spec</span><span class="p">:</span>
            <span class="n">speclist</span> <span class="o">=</span> <span class="n">speclist</span> <span class="o">+</span> <span class="p">[</span><span class="n">spec</span><span class="p">]</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">speclist</span><span class="p">,)</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">AdvancedOptions</span><span class="p">:</span>
    <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]</span>
    <span class="n">custom_provider</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ProviderProfile</span><span class="p">]</span>
    <span class="n">system_prompt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">neutral_params</span><span class="p">:</span> <span class="n">NeutralParams</span>

<span class="k">class</span> <span class="nc">OpenAIAdvancedOptionsNode</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Aggregate optional tools, custom provider, system prompt, and loose parameters.
    Parameters are parsed from JSON or a permissive </span><span class="sh">"</span><span class="s">key: value</span><span class="sh">"</span><span class="s"> text.
    </span><span class="sh">"""</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">optional</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_TOOLS</span><span class="sh">"</span><span class="p">,),</span>
                <span class="sh">"</span><span class="s">custom_provider</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_PROVIDER</span><span class="sh">"</span><span class="p">,),</span>
                <span class="sh">"</span><span class="s">system_prompt</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">reasoning_effort: high</span><span class="se">\n</span><span class="s">max_tokens: 1024</span><span class="se">\n</span><span class="s">temperature: 0.7</span><span class="se">\n</span><span class="s">top_p: 0.9</span><span class="se">\n</span><span class="s"># stop can be a JSON array</span><span class="se">\n</span><span class="s"># stop: [END, ###]</span><span class="se">\n</span><span class="sh">"</span>
                <span class="p">}),</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_ADVANCED</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">advanced</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">build</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OpenAI/Options</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">custom_provider</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">system_prompt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span><span class="p">,</span> <span class="n">parameters</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span><span class="p">):</span>
        <span class="c1"># Tools
</span>        <span class="n">tlist</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]</span> <span class="o">=</span> <span class="n">tools</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">tools</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="c1"># Provider override
</span>        <span class="n">provider</span> <span class="o">=</span> <span class="n">custom_provider</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">custom_provider</span><span class="p">,</span> <span class="n">ProviderProfile</span><span class="p">)</span> <span class="k">else</span> <span class="bp">None</span>
        <span class="c1"># System prompt
</span>        <span class="n">sys_prompt</span> <span class="o">=</span> <span class="n">system_prompt</span> <span class="nf">if </span><span class="p">(</span><span class="n">system_prompt</span> <span class="ow">and</span> <span class="n">system_prompt</span><span class="p">.</span><span class="nf">strip</span><span class="p">())</span> <span class="k">else</span> <span class="bp">None</span>
        <span class="c1"># Loose parameters -&gt; NeutralParams
</span>        <span class="n">params_dict</span> <span class="o">=</span> <span class="nf">parse_loose_params</span><span class="p">(</span><span class="n">parameters</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">)</span>
        <span class="n">neutral</span> <span class="o">=</span> <span class="nf">normalize_to_neutral</span><span class="p">(</span><span class="n">params_dict</span><span class="p">)</span>

        <span class="nf">return </span><span class="p">(</span><span class="nc">AdvancedOptions</span><span class="p">(</span><span class="n">tlist</span><span class="p">,</span> <span class="n">provider</span><span class="p">,</span> <span class="n">sys_prompt</span><span class="p">,</span> <span class="n">neutral</span><span class="p">),)</span>

<span class="k">class</span> <span class="nc">OpenAIChatNode</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Async chat node.
      - Loads provider by name from config.toml; allows override via AdvancedOptions.custom_provider.
      - If AdvancedOptions.parameters provided, they override neutral defaults.
      - Runs a tool-calling loop and returns final text.
    </span><span class="sh">"""</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_provider_names</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">global</span> <span class="n">PROVIDER_CATALOG</span>
        <span class="n">PROVIDER_CATALOG</span> <span class="o">=</span> <span class="nf">load_providers_from_config</span><span class="p">(</span><span class="n">DEFAULT_CONFIG_PATH</span><span class="p">)</span>
        <span class="k">return</span> <span class="nf">list</span><span class="p">(</span><span class="n">PROVIDER_CATALOG</span><span class="p">.</span><span class="nf">keys</span><span class="p">())</span> <span class="ow">or</span> <span class="p">[</span><span class="sh">"</span><span class="s">&lt;no providers in config&gt;</span><span class="sh">"</span><span class="p">]</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="n">provider_list</span> <span class="o">=</span> <span class="n">cls</span><span class="p">.</span><span class="nf">_provider_names</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">user_prompt</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List files under ./samples, choose one text file, read it, and summarize in 2-3 sentences.</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">provider_name</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="n">provider_list</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="n">provider_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]}),</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">optional</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">advanced</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_ADVANCED</span><span class="sh">"</span><span class="p">,),</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">response_text</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">run</span><span class="sh">"</span>
    <span class="n">OUTPUT_NODE</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OpenAI/Chat</span><span class="sh">"</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">user_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">provider_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">advanced</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="c1"># Provider selection (config or override)
</span>        <span class="k">global</span> <span class="n">PROVIDER_CATALOG</span>
        <span class="n">provider</span> <span class="o">=</span> <span class="n">PROVIDER_CATALOG</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">provider_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">advanced</span> <span class="ow">and</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">advanced</span><span class="p">,</span> <span class="n">AdvancedOptions</span><span class="p">)</span> <span class="ow">and</span> <span class="n">advanced</span><span class="p">.</span><span class="n">custom_provider</span><span class="p">:</span>
            <span class="n">provider</span> <span class="o">=</span> <span class="n">advanced</span><span class="p">.</span><span class="n">custom_provider</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">provider</span><span class="p">:</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">[OpenAIChatNode] Error: provider not found. Check config.toml or AdvancedOptions.</span><span class="sh">"</span><span class="p">,)</span>

        <span class="c1"># System prompt
</span>        <span class="n">system_prompt</span> <span class="o">=</span> <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed.</span><span class="sh">"</span>
        <span class="k">if</span> <span class="n">advanced</span> <span class="ow">and</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">advanced</span><span class="p">,</span> <span class="n">AdvancedOptions</span><span class="p">)</span> <span class="ow">and</span> <span class="n">advanced</span><span class="p">.</span><span class="n">system_prompt</span><span class="p">:</span>
            <span class="n">system_prompt</span> <span class="o">=</span> <span class="n">advanced</span><span class="p">.</span><span class="n">system_prompt</span>

        <span class="c1"># Tools
</span>        <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">advanced</span> <span class="ow">and</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">advanced</span><span class="p">,</span> <span class="n">AdvancedOptions</span><span class="p">)</span> <span class="ow">and</span> <span class="n">advanced</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
            <span class="n">tools</span> <span class="o">=</span> <span class="n">advanced</span><span class="p">.</span><span class="n">tools</span>

        <span class="c1"># Neutral parameters (override by advanced.parameters if present)
</span>        <span class="n">neutral</span> <span class="o">=</span> <span class="nc">NeutralParams</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">advanced</span> <span class="ow">and</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">advanced</span><span class="p">,</span> <span class="n">AdvancedOptions</span><span class="p">)</span> <span class="ow">and</span> <span class="n">advanced</span><span class="p">.</span><span class="n">neutral_params</span><span class="p">:</span>
            <span class="n">neutral</span> <span class="o">=</span> <span class="n">advanced</span><span class="p">.</span><span class="n">neutral_params</span>

        <span class="c1"># Interrupt support
</span>        <span class="n">user</span> <span class="o">=</span> <span class="nc">InterruptUser</span><span class="p">()</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_running_loop</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">loop</span><span class="p">.</span><span class="nf">add_signal_handler</span><span class="p">(</span><span class="n">signal</span><span class="p">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">user</span><span class="p">.</span><span class="n">trigger_interrupt</span><span class="p">)</span>
            <span class="n">loop</span><span class="p">.</span><span class="nf">add_signal_handler</span><span class="p">(</span><span class="n">signal</span><span class="p">.</span><span class="n">SIGTERM</span><span class="p">,</span> <span class="n">user</span><span class="p">.</span><span class="n">trigger_interrupt</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">run_with_provider</span><span class="p">(</span>
                <span class="n">provider</span><span class="o">=</span><span class="n">provider</span><span class="p">,</span>
                <span class="n">system_prompt</span><span class="o">=</span><span class="n">system_prompt</span><span class="p">,</span>
                <span class="n">user_prompt</span><span class="o">=</span><span class="n">user_prompt</span><span class="p">,</span>
                <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
                <span class="n">neutral</span><span class="o">=</span><span class="n">neutral</span><span class="p">,</span>
                <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nf">return </span><span class="p">(</span><span class="n">text</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,)</span>
        <span class="k">except</span> <span class="n">UserCancelledError</span><span class="p">:</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">[OpenAIChatNode] Interrupted by user.</span><span class="sh">"</span><span class="p">,)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nf">return </span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[OpenAIChatNode] Error: </span><span class="si">{</span><span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">,)</span>

<span class="c1"># =========================
# ComfyUI registration
# =========================
</span>
<span class="n">NODE_CLASS_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">OpenAIChatNode</span><span class="sh">"</span><span class="p">:</span> <span class="n">OpenAIChatNode</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">OpenAIToolNode</span><span class="sh">"</span><span class="p">:</span> <span class="n">OpenAIToolNode</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">OpenAICustomProviderNode</span><span class="sh">"</span><span class="p">:</span> <span class="n">OpenAICustomProviderNode</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">OpenAIAdvancedOptionsNode</span><span class="sh">"</span><span class="p">:</span> <span class="n">OpenAIAdvancedOptionsNode</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">NODE_DISPLAY_NAME_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">OpenAIChatNode</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">OpenAI Chat (Async)</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">OpenAIToolNode</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">OpenAI Tool Builder</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">OpenAICustomProviderNode</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">OpenAI Custom Provider</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">OpenAIAdvancedOptionsNode</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">OpenAI Advanced Options</span><span class="sh">"</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div>

<p>포인트 요약</p>

<ul>
  <li>
    <p>OpenAIAdvancedOptionsNode에 parameters를 추가했고, JSON이 아니어도 “key: value”를 줄마다 적으면 느슨한 파서가 해석합니다.</p>
  </li>
  <li>
    <p>max_tokens, max_output_tokens, max_completion_tokens, length 중 무엇을 쓰든 NeutralParams.length로 매핑됩니다.</p>
  </li>
  <li>
    <p>stop은 JSON 배열이나 콤마 구분 문자열 모두 지원합니다.</p>
  </li>
  <li>
    <p>reasoning_effort, effort, reasoning.effort, reasoning:{effort:…} 형태 모두 인식합니다.</p>
  </li>
  <li>
    <p>OpenAICustomProviderNode에 arg_adapter가 포함되어 있으며, 이 값으로 argument 매핑 방식을 결정합니다.</p>
  </li>
  <li>
    <p>전체 플로우는 비동기이며, 인터럽트(CTRL+C 등) 시 안전하게 중단됩니다.</p>
  </li>
</ul>

<p class="chat--user">

흠 아니다 아직 arg_adapter를 넣는건 좀 시기 상조인것 같아. 그냥 전체 코드에서 이에 관련된 모든 코드를 빼줘. 단, 파라미터 정보는 넣을 수 있게 해줘. Config 파일과 Advanced Node에서 설정할거야. 전체 코드 꼼꼼하게 다시 작성해줘.

</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># openai_comfy_nodes.py
# Python 3.10+
# Dependencies:
#   pip install --upgrade openai httpx
#
# Nodes:
#   1) OpenAIChatNode (async)
#   2) OpenAIToolNode
#   3) OpenAICustomProviderNode
#   4) OpenAIAdvancedOptionsNode
#
# Highlights:
# - Async-only execution (AsyncOpenAI + httpx.AsyncClient).
# - Provider selection from config.toml (env OPENAI_PROVIDER_CONFIG or ./config.toml),
#   with optional override via AdvancedOptions.custom_provider.
# - Supports Responses vs Chat Completions API and tool JSON shape (flat/nested).
# - Parameters can be set in both config and AdvancedOptions (multiline, loose parsing).
# - No arg_adapter concept: a single, consistent mapping is applied:
#     * Responses: length -&gt; max_output_tokens
#     * Completions: length -&gt; max_tokens
#     * Both: temperature, top_p, stop, reasoning.effort (best-effort; ignored if unsupported)
#
# Notes:
# - Returns plain text only.
# - If your ComfyUI build exposes task cancellation hooks, wire them into InterruptUser.trigger_interrupt().
</span>
<span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">re</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">signal</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Protocol</span>

<span class="c1"># TOML parser
</span><span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomllib</span>  <span class="c1"># Python 3.11+
</span><span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">tomllib</span> <span class="o">=</span> <span class="bp">None</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomli</span>  <span class="c1"># Fallback for Python &lt;3.11
</span><span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">tomli</span> <span class="o">=</span> <span class="bp">None</span>

<span class="kn">import</span> <span class="n">httpx</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">AsyncOpenAI</span>

<span class="c1"># =========================
# Interrupt helpers
# =========================
</span>
<span class="k">class</span> <span class="nc">UserCancelledError</span><span class="p">(</span><span class="nb">Exception</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Raised when the user has interrupted the processing.</span><span class="sh">"""</span>

<span class="k">class</span> <span class="nc">InterruptUser</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Minimal interrupt controller. If ComfyUI cancels the task, awaiting the
    underlying operation will usually raise. We also expose a cooperative flag.
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_event</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Event</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">trigger_interrupt</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_event</span><span class="p">.</span><span class="nf">set</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">processing_interrupted</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_event</span><span class="p">.</span><span class="nf">is_set</span><span class="p">()</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">call_with_interrupt</span><span class="p">(</span><span class="n">awaitable</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="n">InterruptUser</span><span class="p">,</span> <span class="n">poll</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Await an I/O operation while polling for user interruption.
    If interrupted, cancel and raise UserCancelledError.
    </span><span class="sh">"""</span>
    <span class="n">task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="n">awaitable</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">({</span><span class="n">task</span><span class="p">},</span> <span class="n">timeout</span><span class="o">=</span><span class="n">poll</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">task</span><span class="p">.</span><span class="nf">result</span><span class="p">()</span>
            <span class="k">if</span> <span class="k">await</span> <span class="n">user</span><span class="p">.</span><span class="nf">processing_interrupted</span><span class="p">():</span>
                <span class="n">task</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">task</span>
                <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">raise</span> <span class="nc">UserCancelledError</span><span class="p">(</span><span class="sh">"</span><span class="s">Interrupted by user.</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">raise</span>

<span class="c1"># =========================
# Config loading (api_provider catalog)
# =========================
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">NeutralParams</span><span class="p">:</span>
    <span class="n">length</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">temperature</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">top_p</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">stop</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">reasoning_effort</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c1"># "low"|"medium"|"high"
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ProviderProfile</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">model</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">api</span><span class="p">:</span> <span class="nb">str</span>          <span class="c1"># "responses" | "completions"
</span>    <span class="n">tool_json</span><span class="p">:</span> <span class="nb">str</span>    <span class="c1"># "flat" | "nested"
</span>    <span class="n">default_params</span><span class="p">:</span> <span class="n">NeutralParams</span>  <span class="c1"># default neutral parameters from config
</span>
<span class="k">def</span> <span class="nf">_load_toml_bytes</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
    <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_try_json_loads</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">_parse_scalar</span><span class="p">(</span><span class="n">v</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Heuristic scalar parser for loose </span><span class="sh">'</span><span class="s">key: value</span><span class="sh">'</span><span class="s"> values.</span><span class="sh">"""</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">t</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">false</span><span class="sh">"</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">t</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="o">==</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span>
    <span class="k">if</span> <span class="n">t</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">null</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">none</span><span class="sh">"</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="c1"># numbers
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">re</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">^-?\d+$</span><span class="sh">"</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
            <span class="k">return</span> <span class="nf">int</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">re</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">^-?\d+\.\d+$</span><span class="sh">"</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
            <span class="k">return</span> <span class="nf">float</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="c1"># JSON-looking
</span>    <span class="nf">if </span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">[</span><span class="sh">"</span><span class="p">)</span> <span class="ow">and</span> <span class="n">t</span><span class="p">.</span><span class="nf">endswith</span><span class="p">(</span><span class="sh">"</span><span class="s">]</span><span class="sh">"</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">{</span><span class="sh">"</span><span class="p">)</span> <span class="ow">and</span> <span class="n">t</span><span class="p">.</span><span class="nf">endswith</span><span class="p">(</span><span class="sh">"</span><span class="s">}</span><span class="sh">"</span><span class="p">)):</span>
        <span class="n">j</span> <span class="o">=</span> <span class="nf">_try_json_loads</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">j</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">j</span>
    <span class="c1"># comma list fallback
</span>    <span class="k">if</span> <span class="sh">"</span><span class="s">,</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">t</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="p">)]</span>
        <span class="k">return</span> <span class="p">[</span><span class="nf">_parse_scalar</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">t</span>

<span class="k">def</span> <span class="nf">parse_loose_params</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">
    Permissive parser:
      1) Try JSON first.
      2) Else parse line-by-line </span><span class="sh">"</span><span class="s">key: value</span><span class="sh">"</span><span class="s"> or </span><span class="sh">"</span><span class="s">key = value</span><span class="sh">"</span><span class="s">.
         - Ignores empty lines and lines starting with # // ;
         - Auto-typed values (bool, null, int, float, JSON, comma-list, string).
    </span><span class="sh">"""</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">text</span><span class="p">.</span><span class="nf">strip</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="n">j</span> <span class="o">=</span> <span class="nf">_try_json_loads</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">j</span>

    <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">raw</span> <span class="ow">in</span> <span class="n">text</span><span class="p">.</span><span class="nf">splitlines</span><span class="p">():</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">raw</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">line</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">#</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">line</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">//</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">line</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">;</span><span class="sh">"</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="c1"># strip simple trailing comment after '#'
</span>        <span class="n">line</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">\s+#</span><span class="sh">"</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nf">strip</span><span class="p">()</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">\s*[:=]\s*</span><span class="sh">"</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">strip</span><span class="p">(),</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">norm_key</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">sub</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">[\s\-]+</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">_</span><span class="sh">"</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="nf">lower</span><span class="p">())</span>
        <span class="n">out</span><span class="p">[</span><span class="n">norm_key</span><span class="p">]</span> <span class="o">=</span> <span class="nf">_parse_scalar</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span> <span class="nf">normalize_to_neutral</span><span class="p">(</span><span class="n">d</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">NeutralParams</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Map arbitrary keys into NeutralParams.
    Recognized keys:
      - length | max_tokens | max_output_tokens | max_completion_tokens
      - temperature
      - top_p
      - stop (list or comma-separated string)
      - reasoning_effort | effort | reasoning.effort | reasoning:{effort:...}
    </span><span class="sh">"""</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="nc">NeutralParams</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">pick_int</span><span class="p">(</span><span class="o">*</span><span class="n">keys</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">d</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
                <span class="k">return</span> <span class="nf">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="nf">int</span><span class="p">(</span><span class="nf">float</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">pick_float</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">d</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">return</span> <span class="nf">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="nf">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">pick_stop</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">d</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">stop</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">v</span><span class="p">]</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">j</span> <span class="o">=</span> <span class="nf">_try_json_loads</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">j</span><span class="p">]</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">s</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">v</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="p">)</span> <span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="nf">strip</span><span class="p">()]</span>
        <span class="k">return</span> <span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="n">v</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">pick_effort</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">reasoning_effort</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">effort</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">reasoning.effort</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">d</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">v</span><span class="p">.</span><span class="nf">strip</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">v</span><span class="p">.</span><span class="nf">strip</span><span class="p">().</span><span class="nf">lower</span><span class="p">()</span>
        <span class="n">reason</span> <span class="o">=</span> <span class="n">d</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">reasoning</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">reason</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">reason</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">effort</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">v</span><span class="p">.</span><span class="nf">strip</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">v</span><span class="p">.</span><span class="nf">strip</span><span class="p">().</span><span class="nf">lower</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="n">length</span> <span class="o">=</span> <span class="nf">pick_int</span><span class="p">(</span><span class="sh">"</span><span class="s">length</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">max_tokens</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">max_output_tokens</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">max_completion_tokens</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">temperature</span> <span class="o">=</span> <span class="nf">pick_float</span><span class="p">(</span><span class="sh">"</span><span class="s">temperature</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">top_p</span> <span class="o">=</span> <span class="nf">pick_float</span><span class="p">(</span><span class="sh">"</span><span class="s">top_p</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">stop</span> <span class="o">=</span> <span class="nf">pick_stop</span><span class="p">()</span>
    <span class="n">effort</span> <span class="o">=</span> <span class="nf">pick_effort</span><span class="p">()</span>

    <span class="k">return</span> <span class="nc">NeutralParams</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="n">length</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">,</span> <span class="n">top_p</span><span class="o">=</span><span class="n">top_p</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">stop</span><span class="p">,</span> <span class="n">reasoning_effort</span><span class="o">=</span><span class="n">effort</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">merge_neutral</span><span class="p">(</span><span class="n">base</span><span class="p">:</span> <span class="n">NeutralParams</span><span class="p">,</span> <span class="n">override</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">NeutralParams</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">NeutralParams</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Override non-None fields from `override` onto `base`.</span><span class="sh">"""</span>
    <span class="k">if</span> <span class="n">override</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">base</span>
    <span class="k">return</span> <span class="nc">NeutralParams</span><span class="p">(</span>
        <span class="n">length</span><span class="o">=</span><span class="n">override</span><span class="p">.</span><span class="n">length</span> <span class="k">if</span> <span class="n">override</span><span class="p">.</span><span class="n">length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">base</span><span class="p">.</span><span class="n">length</span><span class="p">,</span>
        <span class="n">temperature</span><span class="o">=</span><span class="n">override</span><span class="p">.</span><span class="n">temperature</span> <span class="k">if</span> <span class="n">override</span><span class="p">.</span><span class="n">temperature</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">base</span><span class="p">.</span><span class="n">temperature</span><span class="p">,</span>
        <span class="n">top_p</span><span class="o">=</span><span class="n">override</span><span class="p">.</span><span class="n">top_p</span> <span class="k">if</span> <span class="n">override</span><span class="p">.</span><span class="n">top_p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">base</span><span class="p">.</span><span class="n">top_p</span><span class="p">,</span>
        <span class="n">stop</span><span class="o">=</span><span class="n">override</span><span class="p">.</span><span class="n">stop</span> <span class="k">if</span> <span class="n">override</span><span class="p">.</span><span class="n">stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">base</span><span class="p">.</span><span class="n">stop</span><span class="p">,</span>
        <span class="n">reasoning_effort</span><span class="o">=</span><span class="n">override</span><span class="p">.</span><span class="n">reasoning_effort</span> <span class="k">if</span> <span class="n">override</span><span class="p">.</span><span class="n">reasoning_effort</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">base</span><span class="p">.</span><span class="n">reasoning_effort</span><span class="p">,</span>
    <span class="p">)</span>

<span class="k">def</span> <span class="nf">load_providers_from_config</span><span class="p">(</span><span class="n">config_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ProviderProfile</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">
    Expected TOML schema:

    [[api_provider]]
    name = </span><span class="sh">"</span><span class="s">OSS GPT (Responses + Flat)</span><span class="sh">"</span><span class="s">
    model = </span><span class="sh">"</span><span class="s">gpt-4.1-mini</span><span class="sh">"</span><span class="s">
    base_url = </span><span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="s">
    api_key_env = </span><span class="sh">"</span><span class="s">OPENAI_API_KEY</span><span class="sh">"</span><span class="s">   # or api_key = </span><span class="sh">"</span><span class="s">sk-...</span><span class="sh">"</span><span class="s">
    api = </span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="s">                # </span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="s"> | </span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="s">
    tool_json = </span><span class="sh">"</span><span class="s">flat</span><span class="sh">"</span><span class="s">               # </span><span class="sh">"</span><span class="s">flat</span><span class="sh">"</span><span class="s"> | </span><span class="sh">"</span><span class="s">nested</span><span class="sh">"</span><span class="s">
    parameters = </span><span class="sh">"""</span>
      <span class="n">reasoning_effort</span><span class="p">:</span> <span class="n">high</span>
      <span class="n">max_tokens</span><span class="p">:</span> <span class="mi">1024</span>
      <span class="n">temperature</span><span class="p">:</span> <span class="mf">0.7</span>
      <span class="n">top_p</span><span class="p">:</span> <span class="mf">0.9</span>
    <span class="sh">"""</span><span class="s">
    </span><span class="sh">"""</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">config_path</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="n">raw</span> <span class="o">=</span> <span class="nf">_load_toml_bytes</span><span class="p">(</span><span class="n">config_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">config_path</span><span class="p">.</span><span class="nf">lower</span><span class="p">().</span><span class="nf">endswith</span><span class="p">(</span><span class="sh">"</span><span class="s">.toml</span><span class="sh">"</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">tomllib</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">tomllib</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">tomli</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">tomli</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">TOML parser not available. Use Python 3.11+ or `pip install tomli`.</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">))</span>

    <span class="n">providers_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">api_provider</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">api_providers</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">providers_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ProviderProfile</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">providers_data</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">base_url</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">api_key_env</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">api_key_env</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">api</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">api</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">tool_json</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_json</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">raw_params</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">model</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">base_url</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">api</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">tool_json</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">api_key</span> <span class="ow">and</span> <span class="n">api_key_env</span><span class="p">:</span>
            <span class="n">api_key</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="n">api_key_env</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">api_key</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># parameters: dict or multiline string
</span>        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">raw_params</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">params_dict</span> <span class="o">=</span> <span class="nf">parse_loose_params</span><span class="p">(</span><span class="n">raw_params</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">raw_params</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">params_dict</span> <span class="o">=</span> <span class="n">raw_params</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">params_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">default_neutral</span> <span class="o">=</span> <span class="nf">normalize_to_neutral</span><span class="p">(</span><span class="n">params_dict</span><span class="p">)</span>

        <span class="n">out</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nc">ProviderProfile</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">base_url</span><span class="o">=</span><span class="n">base_url</span><span class="p">,</span>
            <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
            <span class="n">api</span><span class="o">=</span><span class="n">api</span><span class="p">,</span>
            <span class="n">tool_json</span><span class="o">=</span><span class="n">tool_json</span><span class="p">,</span>
            <span class="n">default_params</span><span class="o">=</span><span class="n">default_neutral</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="n">DEFAULT_CONFIG_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_PROVIDER_CONFIG</span><span class="sh">"</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="nf">getcwd</span><span class="p">(),</span> <span class="sh">"</span><span class="s">config.toml</span><span class="sh">"</span><span class="p">))</span>
<span class="n">PROVIDER_CATALOG</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ProviderProfile</span><span class="p">]</span> <span class="o">=</span> <span class="nf">load_providers_from_config</span><span class="p">(</span><span class="n">DEFAULT_CONFIG_PATH</span><span class="p">)</span>

<span class="c1"># =========================
# Tool layer
# =========================
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ToolSpec</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="n">func</span><span class="p">:</span> <span class="n">Any</span>  <span class="c1"># Callable[[Dict[str, Any]], Any]
</span>
<span class="k">class</span> <span class="nc">ToolJSONBuilder</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="bp">...</span>

<span class="k">class</span> <span class="nc">FlatToolJSONBuilder</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Flat tool JSON: { </span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="s">:..., </span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="s">:..., </span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="s">:{...} }</span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">:</span>
            <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">parameters</span><span class="p">,</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">out</span>

<span class="k">class</span> <span class="nc">NestedToolJSONBuilder</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Nested tool JSON: { </span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">:{...} }</span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">:</span>
            <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">parameters</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span> <span class="nf">select_tool_builder</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ToolJSONBuilder</span><span class="p">:</span>
    <span class="n">kind</span> <span class="o">=</span> <span class="p">(</span><span class="n">kind</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">).</span><span class="nf">strip</span><span class="p">().</span><span class="nf">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">flat</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="nc">FlatToolJSONBuilder</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">nested</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="nc">NestedToolJSONBuilder</span><span class="p">()</span>
    <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool_json: </span><span class="si">{</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># Built-in tools (safe local I/O)
</span>
<span class="k">def</span> <span class="nf">_list_files_in_folder</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">folder</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">items</span> <span class="o">=</span> <span class="nf">sorted</span><span class="p">([</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="nf">listdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">f</span><span class="p">))])</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="n">items</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">_read_text_file</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()}</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}</span>

<span class="n">BUILTIN_TOOLS</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ToolSpec</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ToolSpec</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">},</span>
        <span class="n">func</span><span class="o">=</span><span class="n">_list_files_in_folder</span>
    <span class="p">),</span>
    <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ToolSpec</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative path to a text file.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">},</span>
        <span class="n">func</span><span class="o">=</span><span class="n">_read_text_file</span>
    <span class="p">),</span>
<span class="p">}</span>

<span class="c1"># =========================
# Protocol runners (async)
# =========================
</span>
<span class="k">class</span> <span class="nc">ResponsesRunner</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Async Responses loop with local tool execution.</span><span class="sh">"""</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_collect_text</span><span class="p">(</span><span class="n">resp</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
            <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]:</span>
                    <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
            <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
        <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">texts</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_collect_calls</span><span class="p">(</span><span class="n">resp</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="sh">"</span><span class="s">function_call</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                        <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                              <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                              <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{}})</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">inner</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">inner</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">inner</span><span class="p">:</span>
                        <span class="n">nm</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                        <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                                <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                                      <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">nm</span><span class="p">,</span>
                                      <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{}})</span>
        <span class="k">return</span> <span class="n">calls</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">tools</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">:</span> <span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">_exec_tool</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">spec</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">spec</span><span class="p">.</span><span class="nf">func</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">client</span><span class="p">:</span> <span class="n">AsyncOpenAI</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">tools_json</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">payload_args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">user</span><span class="p">:</span> <span class="n">InterruptUser</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span> <span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools_json</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_choice</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span> <span class="o">**</span><span class="n">payload_args</span><span class="p">}</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">call_with_interrupt</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">),</span> <span class="n">user</span><span class="p">)</span>

        <span class="n">chunks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">_collect_text</span><span class="p">(</span><span class="n">resp</span><span class="p">))</span>
            <span class="n">calls</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_collect_calls</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
                <span class="k">if</span> <span class="k">await</span> <span class="n">user</span><span class="p">.</span><span class="nf">processing_interrupted</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="nc">UserCancelledError</span><span class="p">(</span><span class="sh">"</span><span class="s">Interrupted by user.</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_exec_tool</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
                <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function_call_output</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">[</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)})</span>

            <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span> <span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools_json</span><span class="p">,</span> <span class="o">**</span><span class="n">payload_args</span><span class="p">}</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">call_with_interrupt</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">),</span> <span class="n">user</span><span class="p">)</span>

        <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">chunks</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

<span class="k">class</span> <span class="nc">CompletionsRunner</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Async Chat Completions loop with local tool execution.</span><span class="sh">"""</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">tools</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">:</span> <span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">_exec_tool</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">spec</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">spec</span><span class="p">.</span><span class="nf">func</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">client</span><span class="p">:</span> <span class="n">AsyncOpenAI</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">tools_json</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">payload_args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">user</span><span class="p">:</span> <span class="n">InterruptUser</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools_json</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_choice</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span> <span class="o">**</span><span class="n">payload_args</span><span class="p">}</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">call_with_interrupt</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">),</span> <span class="n">user</span><span class="p">)</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
        <span class="n">chunks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">]</span>
        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">tool_msgs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="k">if</span> <span class="k">await</span> <span class="n">user</span><span class="p">.</span><span class="nf">processing_interrupted</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="nc">UserCancelledError</span><span class="p">(</span><span class="sh">"</span><span class="s">Interrupted by user.</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">fn</span> <span class="o">=</span> <span class="n">tc</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">tc</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_exec_tool</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>
                <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">tc</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)})</span>

            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">]})</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

            <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="o">**</span><span class="n">payload_args</span><span class="p">}</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">call_with_interrupt</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">),</span> <span class="n">user</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
            <span class="k">if</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">content</span><span class="p">)</span>

        <span class="k">return</span> <span class="sh">"</span><span class="se">\n\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">chunks</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

<span class="c1"># =========================
# Mapping helpers (no arg_adapter)
# =========================
</span>
<span class="k">def</span> <span class="nf">build_responses_payload</span><span class="p">(</span><span class="n">neutral</span><span class="p">:</span> <span class="n">NeutralParams</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">tools_json</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">Map NeutralParams to Responses API arguments.</span><span class="sh">"""</span>
    <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools_json</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">max_output_tokens</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">length</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">temperature</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">temperature</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">temperature</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">top_p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">top_p</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">top_p</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">stop</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">neutral</span><span class="p">.</span><span class="n">stop</span>
    <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">reasoning_effort</span><span class="p">:</span>
        <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">reasoning</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">effort</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">reasoning_effort</span><span class="p">)}</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span> <span class="nf">build_completions_payload</span><span class="p">(</span><span class="n">neutral</span><span class="p">:</span> <span class="n">NeutralParams</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">tools_json</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">Map NeutralParams to Chat Completions API arguments.</span><span class="sh">"""</span>
    <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools_json</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">max_tokens</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">length</span><span class="p">)</span>  <span class="c1"># unified choice
</span>    <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">temperature</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">temperature</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">temperature</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">top_p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">top_p</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">top_p</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">stop</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">neutral</span><span class="p">.</span><span class="n">stop</span>
    <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">reasoning_effort</span><span class="p">:</span>
        <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">reasoning</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">effort</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">reasoning_effort</span><span class="p">)}</span>  <span class="c1"># ignored if unsupported
</span>    <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span> <span class="nf">build_payload</span><span class="p">(</span><span class="n">provider</span><span class="p">:</span> <span class="n">ProviderProfile</span><span class="p">,</span> <span class="n">neutral</span><span class="p">:</span> <span class="n">NeutralParams</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">builder</span> <span class="o">=</span> <span class="nf">select_tool_builder</span><span class="p">(</span><span class="n">provider</span><span class="p">.</span><span class="n">tool_json</span><span class="p">)</span>
    <span class="n">tools_json</span> <span class="o">=</span> <span class="n">builder</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">provider</span><span class="p">.</span><span class="n">api</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="nf">build_responses_payload</span><span class="p">(</span><span class="n">neutral</span><span class="p">,</span> <span class="n">messages</span><span class="p">,</span> <span class="n">tools_json</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="nf">build_completions_payload</span><span class="p">(</span><span class="n">neutral</span><span class="p">,</span> <span class="n">messages</span><span class="p">,</span> <span class="n">tools_json</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">tools_json</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools_json</span><span class="p">,</span> <span class="sh">"</span><span class="s">payload_args</span><span class="sh">"</span><span class="p">:</span> <span class="n">payload</span><span class="p">}</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_with_provider</span><span class="p">(</span>
    <span class="n">provider</span><span class="p">:</span> <span class="n">ProviderProfile</span><span class="p">,</span>
    <span class="n">system_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">user_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">],</span>
    <span class="n">neutral</span><span class="p">:</span> <span class="n">NeutralParams</span><span class="p">,</span>
    <span class="n">user</span><span class="p">:</span> <span class="n">InterruptUser</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">system_prompt</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_prompt</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="n">built</span> <span class="o">=</span> <span class="nf">build_payload</span><span class="p">(</span><span class="n">provider</span><span class="p">,</span> <span class="n">neutral</span><span class="p">,</span> <span class="n">messages</span><span class="p">,</span> <span class="n">tools</span><span class="p">)</span>
    <span class="n">tools_json</span> <span class="o">=</span> <span class="n">built</span><span class="p">[</span><span class="sh">"</span><span class="s">tools_json</span><span class="sh">"</span><span class="p">]</span>
    <span class="n">payload_args</span> <span class="o">=</span> <span class="n">built</span><span class="p">[</span><span class="sh">"</span><span class="s">payload_args</span><span class="sh">"</span><span class="p">]</span>

    <span class="n">hooks</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">:</span> <span class="p">[],</span> <span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">httpx</span><span class="p">.</span><span class="nc">AsyncClient</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">httpx</span><span class="p">.</span><span class="nc">Timeout</span><span class="p">(</span><span class="mf">60.0</span><span class="p">),</span> <span class="n">event_hooks</span><span class="o">=</span><span class="n">hooks</span><span class="p">)</span> <span class="k">as</span> <span class="n">http_client</span><span class="p">:</span>
        <span class="k">async</span> <span class="k">with</span> <span class="nc">AsyncOpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">provider</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">provider</span><span class="p">.</span><span class="n">api_key</span><span class="p">,</span> <span class="n">http_client</span><span class="o">=</span><span class="n">http_client</span><span class="p">)</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">provider</span><span class="p">.</span><span class="n">api</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">runner</span> <span class="o">=</span> <span class="nc">ResponsesRunner</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">provider</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="n">messages</span><span class="p">,</span> <span class="n">tools_json</span><span class="p">,</span> <span class="n">payload_args</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">runner</span> <span class="o">=</span> <span class="nc">CompletionsRunner</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">provider</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="n">messages</span><span class="p">,</span> <span class="n">tools_json</span><span class="p">,</span> <span class="n">payload_args</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>

<span class="c1"># =========================
# Nodes
# =========================
</span>
<span class="k">class</span> <span class="nc">OpenAICustomProviderNode</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Build a provider profile directly from UI inputs.
    Optional </span><span class="sh">'</span><span class="s">parameters</span><span class="sh">'</span><span class="s"> lets you set default neutral parameters for this provider.
    </span><span class="sh">"""</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">gpt-4.1-mini</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">api</span><span class="sh">"</span><span class="p">:</span> <span class="p">([</span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">],),</span>
                <span class="sh">"</span><span class="s">tool_json</span><span class="sh">"</span><span class="p">:</span> <span class="p">([</span><span class="sh">"</span><span class="s">flat</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">nested</span><span class="sh">"</span><span class="p">],),</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">optional</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">reasoning_effort: high</span><span class="se">\n</span><span class="s">max_tokens: 1024</span><span class="se">\n</span><span class="s">temperature: 0.7</span><span class="se">\n</span><span class="s">top_p: 0.9</span><span class="se">\n</span><span class="sh">"</span>
                <span class="p">}),</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_PROVIDER</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">provider</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">build</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OpenAI/Provider</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tool_json</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">parameters</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span><span class="p">):</span>
        <span class="n">params_dict</span> <span class="o">=</span> <span class="nf">parse_loose_params</span><span class="p">(</span><span class="n">parameters</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">)</span>
        <span class="n">neutral</span> <span class="o">=</span> <span class="nf">normalize_to_neutral</span><span class="p">(</span><span class="n">params_dict</span><span class="p">)</span>
        <span class="n">provider</span> <span class="o">=</span> <span class="nc">ProviderProfile</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="s">custom::</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">base_url</span><span class="o">=</span><span class="n">base_url</span><span class="p">,</span>
            <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
            <span class="n">api</span><span class="o">=</span><span class="n">api</span><span class="p">,</span>
            <span class="n">tool_json</span><span class="o">=</span><span class="n">tool_json</span><span class="p">,</span>
            <span class="n">default_params</span><span class="o">=</span><span class="n">neutral</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">provider</span><span class="p">,)</span>

<span class="k">class</span> <span class="nc">OpenAIToolNode</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Compose a list of ToolSpec. If input list is None, start a new list.
    </span><span class="sh">"""</span>

    <span class="n">BUILTIN_CHOICES</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">BUILTIN_TOOLS</span><span class="p">.</span><span class="nf">keys</span><span class="p">())</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="n">cls</span><span class="p">.</span><span class="n">BUILTIN_CHOICES</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">}),</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">optional</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">tools_in</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_TOOLS</span><span class="sh">"</span><span class="p">,),</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_TOOLS</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">append_tool</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OpenAI/Tools</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">append_tool</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tool</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tools_in</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">speclist</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]</span> <span class="o">=</span> <span class="n">tools_in</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">tools_in</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">BUILTIN_TOOLS</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">tool</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">spec</span><span class="p">:</span>
            <span class="n">speclist</span> <span class="o">=</span> <span class="n">speclist</span> <span class="o">+</span> <span class="p">[</span><span class="n">spec</span><span class="p">]</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">speclist</span><span class="p">,)</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">AdvancedOptions</span><span class="p">:</span>
    <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]</span>
    <span class="n">custom_provider</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ProviderProfile</span><span class="p">]</span>
    <span class="n">system_prompt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">neutral_params</span><span class="p">:</span> <span class="n">NeutralParams</span>

<span class="k">class</span> <span class="nc">OpenAIAdvancedOptionsNode</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Aggregate optional tools, custom provider, system prompt, and loose parameters.
    Parameters are parsed from JSON or a permissive </span><span class="sh">"</span><span class="s">key: value</span><span class="sh">"</span><span class="s"> text.
    </span><span class="sh">"""</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">optional</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_TOOLS</span><span class="sh">"</span><span class="p">,),</span>
                <span class="sh">"</span><span class="s">custom_provider</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_PROVIDER</span><span class="sh">"</span><span class="p">,),</span>
                <span class="sh">"</span><span class="s">system_prompt</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">reasoning_effort: high</span><span class="se">\n</span><span class="s">max_tokens: 1024</span><span class="se">\n</span><span class="s">temperature: 0.7</span><span class="se">\n</span><span class="s">top_p: 0.9</span><span class="se">\n</span><span class="s"># stop: [END, ###]</span><span class="se">\n</span><span class="sh">"</span>
                <span class="p">}),</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_ADVANCED</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">advanced</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">build</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OpenAI/Options</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">custom_provider</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">system_prompt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span><span class="p">,</span> <span class="n">parameters</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span><span class="p">):</span>
        <span class="n">tlist</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]</span> <span class="o">=</span> <span class="n">tools</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">tools</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="n">provider</span> <span class="o">=</span> <span class="n">custom_provider</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">custom_provider</span><span class="p">,</span> <span class="n">ProviderProfile</span><span class="p">)</span> <span class="k">else</span> <span class="bp">None</span>
        <span class="n">sys_prompt</span> <span class="o">=</span> <span class="n">system_prompt</span> <span class="nf">if </span><span class="p">(</span><span class="n">system_prompt</span> <span class="ow">and</span> <span class="n">system_prompt</span><span class="p">.</span><span class="nf">strip</span><span class="p">())</span> <span class="k">else</span> <span class="bp">None</span>
        <span class="n">params_dict</span> <span class="o">=</span> <span class="nf">parse_loose_params</span><span class="p">(</span><span class="n">parameters</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">)</span>
        <span class="n">neutral</span> <span class="o">=</span> <span class="nf">normalize_to_neutral</span><span class="p">(</span><span class="n">params_dict</span><span class="p">)</span>
        <span class="nf">return </span><span class="p">(</span><span class="nc">AdvancedOptions</span><span class="p">(</span><span class="n">tlist</span><span class="p">,</span> <span class="n">provider</span><span class="p">,</span> <span class="n">sys_prompt</span><span class="p">,</span> <span class="n">neutral</span><span class="p">),)</span>

<span class="k">class</span> <span class="nc">OpenAIChatNode</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Async chat node.
      - Loads provider by name from config.toml; allows override via AdvancedOptions.custom_provider.
      - Parameters: merged from provider.default_params and AdvancedOptions.parameters.
      - Runs a tool-calling loop and returns final text.
    </span><span class="sh">"""</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_provider_names</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">global</span> <span class="n">PROVIDER_CATALOG</span>
        <span class="n">PROVIDER_CATALOG</span> <span class="o">=</span> <span class="nf">load_providers_from_config</span><span class="p">(</span><span class="n">DEFAULT_CONFIG_PATH</span><span class="p">)</span>
        <span class="k">return</span> <span class="nf">list</span><span class="p">(</span><span class="n">PROVIDER_CATALOG</span><span class="p">.</span><span class="nf">keys</span><span class="p">())</span> <span class="ow">or</span> <span class="p">[</span><span class="sh">"</span><span class="s">&lt;no providers in config&gt;</span><span class="sh">"</span><span class="p">]</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="n">provider_list</span> <span class="o">=</span> <span class="n">cls</span><span class="p">.</span><span class="nf">_provider_names</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">user_prompt</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List files under ./samples, choose one text file, read it, and summarize in 2-3 sentences.</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">provider_name</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="n">provider_list</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="n">provider_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]}),</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">optional</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">advanced</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_ADVANCED</span><span class="sh">"</span><span class="p">,),</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">response_text</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">run</span><span class="sh">"</span>
    <span class="n">OUTPUT_NODE</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OpenAI/Chat</span><span class="sh">"</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">user_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">provider_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">advanced</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="c1"># Select provider (config or advanced override)
</span>        <span class="k">global</span> <span class="n">PROVIDER_CATALOG</span>
        <span class="n">provider</span> <span class="o">=</span> <span class="n">PROVIDER_CATALOG</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">provider_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">advanced</span> <span class="ow">and</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">advanced</span><span class="p">,</span> <span class="n">AdvancedOptions</span><span class="p">)</span> <span class="ow">and</span> <span class="n">advanced</span><span class="p">.</span><span class="n">custom_provider</span><span class="p">:</span>
            <span class="n">provider</span> <span class="o">=</span> <span class="n">advanced</span><span class="p">.</span><span class="n">custom_provider</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">provider</span><span class="p">:</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">[OpenAIChatNode] Error: provider not found. Check config.toml or AdvancedOptions.</span><span class="sh">"</span><span class="p">,)</span>

        <span class="c1"># System prompt
</span>        <span class="n">system_prompt</span> <span class="o">=</span> <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed.</span><span class="sh">"</span>
        <span class="k">if</span> <span class="n">advanced</span> <span class="ow">and</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">advanced</span><span class="p">,</span> <span class="n">AdvancedOptions</span><span class="p">)</span> <span class="ow">and</span> <span class="n">advanced</span><span class="p">.</span><span class="n">system_prompt</span><span class="p">:</span>
            <span class="n">system_prompt</span> <span class="o">=</span> <span class="n">advanced</span><span class="p">.</span><span class="n">system_prompt</span>

        <span class="c1"># Tools
</span>        <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">advanced</span> <span class="ow">and</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">advanced</span><span class="p">,</span> <span class="n">AdvancedOptions</span><span class="p">)</span> <span class="ow">and</span> <span class="n">advanced</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
            <span class="n">tools</span> <span class="o">=</span> <span class="n">advanced</span><span class="p">.</span><span class="n">tools</span>

        <span class="c1"># Merge parameters: provider defaults overridden by advanced
</span>        <span class="n">merged_neutral</span> <span class="o">=</span> <span class="n">provider</span><span class="p">.</span><span class="n">default_params</span> <span class="ow">or</span> <span class="nc">NeutralParams</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">advanced</span> <span class="ow">and</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">advanced</span><span class="p">,</span> <span class="n">AdvancedOptions</span><span class="p">)</span> <span class="ow">and</span> <span class="n">advanced</span><span class="p">.</span><span class="n">neutral_params</span><span class="p">:</span>
            <span class="n">merged_neutral</span> <span class="o">=</span> <span class="nf">merge_neutral</span><span class="p">(</span><span class="n">merged_neutral</span><span class="p">,</span> <span class="n">advanced</span><span class="p">.</span><span class="n">neutral_params</span><span class="p">)</span>

        <span class="c1"># Interrupt support
</span>        <span class="n">user</span> <span class="o">=</span> <span class="nc">InterruptUser</span><span class="p">()</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_running_loop</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">loop</span><span class="p">.</span><span class="nf">add_signal_handler</span><span class="p">(</span><span class="n">signal</span><span class="p">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">user</span><span class="p">.</span><span class="n">trigger_interrupt</span><span class="p">)</span>
            <span class="n">loop</span><span class="p">.</span><span class="nf">add_signal_handler</span><span class="p">(</span><span class="n">signal</span><span class="p">.</span><span class="n">SIGTERM</span><span class="p">,</span> <span class="n">user</span><span class="p">.</span><span class="n">trigger_interrupt</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">run_with_provider</span><span class="p">(</span>
                <span class="n">provider</span><span class="o">=</span><span class="n">provider</span><span class="p">,</span>
                <span class="n">system_prompt</span><span class="o">=</span><span class="n">system_prompt</span><span class="p">,</span>
                <span class="n">user_prompt</span><span class="o">=</span><span class="n">user_prompt</span><span class="p">,</span>
                <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
                <span class="n">neutral</span><span class="o">=</span><span class="n">merged_neutral</span><span class="p">,</span>
                <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nf">return </span><span class="p">(</span><span class="n">text</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,)</span>
        <span class="k">except</span> <span class="n">UserCancelledError</span><span class="p">:</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">[OpenAIChatNode] Interrupted by user.</span><span class="sh">"</span><span class="p">,)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nf">return </span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[OpenAIChatNode] Error: </span><span class="si">{</span><span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">,)</span>

<span class="c1"># =========================
# ComfyUI registration
# =========================
</span>
<span class="n">NODE_CLASS_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">OpenAIChatNode</span><span class="sh">"</span><span class="p">:</span> <span class="n">OpenAIChatNode</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">OpenAIToolNode</span><span class="sh">"</span><span class="p">:</span> <span class="n">OpenAIToolNode</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">OpenAICustomProviderNode</span><span class="sh">"</span><span class="p">:</span> <span class="n">OpenAICustomProviderNode</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">OpenAIAdvancedOptionsNode</span><span class="sh">"</span><span class="p">:</span> <span class="n">OpenAIAdvancedOptionsNode</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">NODE_DISPLAY_NAME_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">OpenAIChatNode</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">OpenAI Chat (Async)</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">OpenAIToolNode</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">OpenAI Tool Builder</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">OpenAICustomProviderNode</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">OpenAI Custom Provider</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">OpenAIAdvancedOptionsNode</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">OpenAI Advanced Options</span><span class="sh">"</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div>

<p class="chat--user">

adapter를 빼달라는건 그냥 파라미터로 들어온 걸 그대로 llm 쿼리 파라미터로 넘기면 돼. NeutralParams 이런 컨셉도 그냥 없애고 파라미터는 json 형태로 받아서 그대로 **kwargs로 넘겨버릴거야

</p>

<p>요청대로 arg_adapter/NeutralParams 전부 제거하고, config/Advanced에서 받은 parameters를 느슨 파싱해서 그대로 **kwargs로 API 호출에 넘기는 버전이야. Responses/Completions, flat/nested 툴 JSON 모두 지원하고, 파라미터는 사용자가 넣은 값이 기본 인자들을 덮어쓰도록 머지했어.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># openai_comfy_nodes.py
# Python 3.10+
# Dependencies:
#   pip install --upgrade openai httpx
#
# Nodes:
#   1) OpenAIChatNode (async)
#   2) OpenAIToolNode
#   3) OpenAICustomProviderNode
#   4) OpenAIAdvancedOptionsNode
#
# Design:
# - Async-only execution (AsyncOpenAI + httpx.AsyncClient)
# - Provider selection from config.toml (env OPENAI_PROVIDER_CONFIG or ./config.toml)
# - AdvancedOptions may override provider, tools, system prompt, and parameters
# - parameters are parsed permissively (JSON or loose "key: value") and passed
#   directly as **kwargs to the underlying API call (no adapter, no remapping)
# - Reserved base args (model/messages/input/tools) are set first, then **parameters
#   is merged with precedence to user parameters (they can intentionally override)
</span>
<span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">re</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">signal</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Protocol</span>

<span class="c1"># TOML loader
</span><span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomllib</span>  <span class="c1"># Python 3.11+
</span><span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">tomllib</span> <span class="o">=</span> <span class="bp">None</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomli</span>  <span class="c1"># fallback for Python &lt;3.11
</span><span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">tomli</span> <span class="o">=</span> <span class="bp">None</span>

<span class="kn">import</span> <span class="n">httpx</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">AsyncOpenAI</span>

<span class="c1"># =========================
# Interrupt helpers
# =========================
</span>
<span class="k">class</span> <span class="nc">UserCancelledError</span><span class="p">(</span><span class="nb">Exception</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Raised when the user has interrupted the processing.</span><span class="sh">"""</span>

<span class="k">class</span> <span class="nc">InterruptUser</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Simple cooperative interrupt controller.</span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_event</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Event</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">trigger_interrupt</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_event</span><span class="p">.</span><span class="nf">set</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">processing_interrupted</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_event</span><span class="p">.</span><span class="nf">is_set</span><span class="p">()</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">call_with_interrupt</span><span class="p">(</span><span class="n">awaitable</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="n">InterruptUser</span><span class="p">,</span> <span class="n">poll</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Await an I/O operation while polling for user interruption.
    If interrupted, cancel and raise UserCancelledError.
    </span><span class="sh">"""</span>
    <span class="n">task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="n">awaitable</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">({</span><span class="n">task</span><span class="p">},</span> <span class="n">timeout</span><span class="o">=</span><span class="n">poll</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">task</span><span class="p">.</span><span class="nf">result</span><span class="p">()</span>
            <span class="k">if</span> <span class="k">await</span> <span class="n">user</span><span class="p">.</span><span class="nf">processing_interrupted</span><span class="p">():</span>
                <span class="n">task</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">task</span>
                <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">raise</span> <span class="nc">UserCancelledError</span><span class="p">(</span><span class="sh">"</span><span class="s">Interrupted by user.</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">raise</span>

<span class="c1"># =========================
# Permissive parameters parsing
# =========================
</span>
<span class="k">def</span> <span class="nf">_try_json_loads</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">_parse_scalar</span><span class="p">(</span><span class="n">v</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">t</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">false</span><span class="sh">"</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">t</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="o">==</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span>
    <span class="k">if</span> <span class="n">t</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">null</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">none</span><span class="sh">"</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">re</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">^-?\d+$</span><span class="sh">"</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
            <span class="k">return</span> <span class="nf">int</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">re</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">^-?\d+\.\d+$</span><span class="sh">"</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
            <span class="k">return</span> <span class="nf">float</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="nf">if </span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">[</span><span class="sh">"</span><span class="p">)</span> <span class="ow">and</span> <span class="n">t</span><span class="p">.</span><span class="nf">endswith</span><span class="p">(</span><span class="sh">"</span><span class="s">]</span><span class="sh">"</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">{</span><span class="sh">"</span><span class="p">)</span> <span class="ow">and</span> <span class="n">t</span><span class="p">.</span><span class="nf">endswith</span><span class="p">(</span><span class="sh">"</span><span class="s">}</span><span class="sh">"</span><span class="p">)):</span>
        <span class="n">j</span> <span class="o">=</span> <span class="nf">_try_json_loads</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">j</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">j</span>
    <span class="k">if</span> <span class="sh">"</span><span class="s">,</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">t</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="p">)]</span>
        <span class="k">return</span> <span class="p">[</span><span class="nf">_parse_scalar</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">t</span>

<span class="k">def</span> <span class="nf">parse_loose_params</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">
    1) Try strict JSON.
    2) Else parse lines like </span><span class="sh">"</span><span class="s">key: value</span><span class="sh">"</span><span class="s"> or </span><span class="sh">"</span><span class="s">key = value</span><span class="sh">"</span><span class="s"> with auto-typing.
       Ignores empty lines and comment lines starting with # // ;
    </span><span class="sh">"""</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">text</span><span class="p">.</span><span class="nf">strip</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="n">j</span> <span class="o">=</span> <span class="nf">_try_json_loads</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">j</span>

    <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">raw</span> <span class="ow">in</span> <span class="n">text</span><span class="p">.</span><span class="nf">splitlines</span><span class="p">():</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">raw</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">line</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">#</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">line</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">//</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">line</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">;</span><span class="sh">"</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">\s+#</span><span class="sh">"</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nf">strip</span><span class="p">()</span>  <span class="c1"># strip trailing comment after '#'
</span>        <span class="n">parts</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">\s*[:=]\s*</span><span class="sh">"</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">strip</span><span class="p">(),</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">norm_key</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">sub</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">[\s\-]+</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">_</span><span class="sh">"</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="nf">lower</span><span class="p">())</span>
        <span class="n">out</span><span class="p">[</span><span class="n">norm_key</span><span class="p">]</span> <span class="o">=</span> <span class="nf">_parse_scalar</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="c1"># =========================
# Provider config
# =========================
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ProviderProfile</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">model</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">api</span><span class="p">:</span> <span class="nb">str</span>          <span class="c1"># "responses" | "completions"
</span>    <span class="n">tool_json</span><span class="p">:</span> <span class="nb">str</span>    <span class="c1"># "flat" | "nested"
</span>    <span class="n">default_parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># passed as **kwargs
</span>
<span class="k">def</span> <span class="nf">_load_toml_bytes</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
    <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">load_providers_from_config</span><span class="p">(</span><span class="n">config_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ProviderProfile</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">
    Expected TOML:

    [[api_provider]]
    name = </span><span class="sh">"</span><span class="s">OSS GPT (Responses + Flat)</span><span class="sh">"</span><span class="s">
    model = </span><span class="sh">"</span><span class="s">gpt-4.1-mini</span><span class="sh">"</span><span class="s">
    base_url = </span><span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="s">
    api_key_env = </span><span class="sh">"</span><span class="s">OPENAI_API_KEY</span><span class="sh">"</span><span class="s">   # or api_key = </span><span class="sh">"</span><span class="s">sk-...</span><span class="sh">"</span><span class="s">
    api = </span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="s">                # </span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="s"> | </span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="s">
    tool_json = </span><span class="sh">"</span><span class="s">flat</span><span class="sh">"</span><span class="s">               # </span><span class="sh">"</span><span class="s">flat</span><span class="sh">"</span><span class="s"> | </span><span class="sh">"</span><span class="s">nested</span><span class="sh">"</span><span class="s">
    parameters = </span><span class="sh">"""</span>
      <span class="c1"># any fields accepted by the chosen API will be forwarded verbatim
</span>      <span class="n">max_output_tokens</span><span class="p">:</span> <span class="mi">1024</span>
      <span class="n">temperature</span><span class="p">:</span> <span class="mf">0.7</span>
      <span class="n">top_p</span><span class="p">:</span> <span class="mf">0.9</span>
      <span class="n">tool_choice</span><span class="p">:</span> <span class="n">auto</span>
    <span class="sh">"""</span><span class="s">
    </span><span class="sh">"""</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">config_path</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="n">raw</span> <span class="o">=</span> <span class="nf">_load_toml_bytes</span><span class="p">(</span><span class="n">config_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">config_path</span><span class="p">.</span><span class="nf">lower</span><span class="p">().</span><span class="nf">endswith</span><span class="p">(</span><span class="sh">"</span><span class="s">.toml</span><span class="sh">"</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">tomllib</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">tomllib</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">tomli</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">tomli</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">TOML parser not available. Use Python 3.11+ or `pip install tomli`.</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">))</span>

    <span class="n">providers_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">api_provider</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">api_providers</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">providers_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ProviderProfile</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">providers_data</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">base_url</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">api_key_env</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">api_key_env</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">api</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">api</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">tool_json</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_json</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">raw_params</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">model</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">base_url</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">api</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">tool_json</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">api_key</span> <span class="ow">and</span> <span class="n">api_key_env</span><span class="p">:</span>
            <span class="n">api_key</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="n">api_key_env</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">api_key</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">raw_params</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">params_dict</span> <span class="o">=</span> <span class="nf">parse_loose_params</span><span class="p">(</span><span class="n">raw_params</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">raw_params</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">params_dict</span> <span class="o">=</span> <span class="n">raw_params</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">params_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">out</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nc">ProviderProfile</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">base_url</span><span class="o">=</span><span class="n">base_url</span><span class="p">,</span>
            <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
            <span class="n">api</span><span class="o">=</span><span class="n">api</span><span class="p">,</span>
            <span class="n">tool_json</span><span class="o">=</span><span class="n">tool_json</span><span class="p">,</span>
            <span class="n">default_parameters</span><span class="o">=</span><span class="n">params_dict</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="n">DEFAULT_CONFIG_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_PROVIDER_CONFIG</span><span class="sh">"</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="nf">getcwd</span><span class="p">(),</span> <span class="sh">"</span><span class="s">config.toml</span><span class="sh">"</span><span class="p">))</span>
<span class="n">PROVIDER_CATALOG</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ProviderProfile</span><span class="p">]</span> <span class="o">=</span> <span class="nf">load_providers_from_config</span><span class="p">(</span><span class="n">DEFAULT_CONFIG_PATH</span><span class="p">)</span>

<span class="c1"># =========================
# Tools
# =========================
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ToolSpec</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="n">func</span><span class="p">:</span> <span class="n">Any</span>  <span class="c1"># Callable[[Dict[str, Any]], Any]
</span>
<span class="k">class</span> <span class="nc">ToolJSONBuilder</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="bp">...</span>

<span class="k">class</span> <span class="nc">FlatToolJSONBuilder</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="k">return</span> <span class="p">[{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">description</span><span class="p">,</span> <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">parameters</span><span class="p">}</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">NestedToolJSONBuilder</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="k">return</span> <span class="p">[{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">description</span><span class="p">,</span> <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">parameters</span><span class="p">}}</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">select_tool_builder</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ToolJSONBuilder</span><span class="p">:</span>
    <span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="n">kind</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">).</span><span class="nf">strip</span><span class="p">().</span><span class="nf">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="sh">"</span><span class="s">flat</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="nc">FlatToolJSONBuilder</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="sh">"</span><span class="s">nested</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="nc">NestedToolJSONBuilder</span><span class="p">()</span>
    <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool_json: </span><span class="si">{</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># Built-in tool implementations
</span>
<span class="k">def</span> <span class="nf">_list_files_in_folder</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">folder</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">items</span> <span class="o">=</span> <span class="nf">sorted</span><span class="p">([</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="nf">listdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">f</span><span class="p">))])</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="n">items</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">_read_text_file</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()}</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}</span>

<span class="n">BUILTIN_TOOLS</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ToolSpec</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ToolSpec</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">},</span>
        <span class="n">func</span><span class="o">=</span><span class="n">_list_files_in_folder</span>
    <span class="p">),</span>
    <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ToolSpec</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative path to a text file.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">},</span>
        <span class="n">func</span><span class="o">=</span><span class="n">_read_text_file</span>
    <span class="p">),</span>
<span class="p">}</span>

<span class="c1"># =========================
# Protocol runners (async), passing **kwargs verbatim
# =========================
</span>
<span class="k">class</span> <span class="nc">ResponsesRunner</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Async Responses loop; tool calls executed locally.</span><span class="sh">"""</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_collect_text</span><span class="p">(</span><span class="n">resp</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
            <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]:</span>
                    <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
            <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
        <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">texts</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_collect_calls</span><span class="p">(</span><span class="n">resp</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="sh">"</span><span class="s">function_call</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                        <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                              <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                              <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{}})</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">inner</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">inner</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">inner</span><span class="p">:</span>
                        <span class="n">nm</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                        <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                                <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                                      <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">nm</span><span class="p">,</span>
                                      <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{}})</span>
        <span class="k">return</span> <span class="n">calls</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">tools</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">:</span> <span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">_exec_tool</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">spec</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">spec</span><span class="p">.</span><span class="nf">func</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">client</span><span class="p">:</span> <span class="n">AsyncOpenAI</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">tools_json</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">user</span><span class="p">:</span> <span class="n">InterruptUser</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># Base args; user params can override any of them (including input/tools/tool_choice)
</span>        <span class="n">base</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span> <span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools_json</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_choice</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">}</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">base</span><span class="p">,</span> <span class="o">**</span><span class="p">(</span><span class="n">params</span> <span class="ow">or</span> <span class="p">{})}</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">call_with_interrupt</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">),</span> <span class="n">user</span><span class="p">)</span>

        <span class="n">chunks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">_collect_text</span><span class="p">(</span><span class="n">resp</span><span class="p">))</span>
            <span class="n">calls</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_collect_calls</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
                <span class="k">if</span> <span class="k">await</span> <span class="n">user</span><span class="p">.</span><span class="nf">processing_interrupted</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="nc">UserCancelledError</span><span class="p">(</span><span class="sh">"</span><span class="s">Interrupted by user.</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_exec_tool</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
                <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function_call_output</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">[</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)})</span>

            <span class="n">base</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span> <span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools_json</span><span class="p">}</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">base</span><span class="p">,</span> <span class="o">**</span><span class="p">(</span><span class="n">params</span> <span class="ow">or</span> <span class="p">{})}</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">call_with_interrupt</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">),</span> <span class="n">user</span><span class="p">)</span>

        <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">chunks</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

<span class="k">class</span> <span class="nc">CompletionsRunner</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Async Chat Completions loop; tool calls executed locally.</span><span class="sh">"""</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">tools</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">:</span> <span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">_exec_tool</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">spec</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">spec</span><span class="p">.</span><span class="nf">func</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">client</span><span class="p">:</span> <span class="n">AsyncOpenAI</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">tools_json</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">user</span><span class="p">:</span> <span class="n">InterruptUser</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">base</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools_json</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_choice</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">}</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">base</span><span class="p">,</span> <span class="o">**</span><span class="p">(</span><span class="n">params</span> <span class="ow">or</span> <span class="p">{})}</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">call_with_interrupt</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">),</span> <span class="n">user</span><span class="p">)</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
        <span class="n">chunks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">]</span>
        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">tool_msgs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="k">if</span> <span class="k">await</span> <span class="n">user</span><span class="p">.</span><span class="nf">processing_interrupted</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="nc">UserCancelledError</span><span class="p">(</span><span class="sh">"</span><span class="s">Interrupted by user.</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">fn</span> <span class="o">=</span> <span class="n">tc</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">tc</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_exec_tool</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>
                <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">tc</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)})</span>

            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">]})</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

            <span class="n">base</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">}</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">base</span><span class="p">,</span> <span class="o">**</span><span class="p">(</span><span class="n">params</span> <span class="ow">or</span> <span class="p">{})}</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">call_with_interrupt</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">),</span> <span class="n">user</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
            <span class="k">if</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">content</span><span class="p">)</span>

        <span class="k">return</span> <span class="sh">"</span><span class="se">\n\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">chunks</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

<span class="c1"># =========================
# Orchestrator
# =========================
</span>
<span class="k">def</span> <span class="nf">build_payload</span><span class="p">(</span><span class="n">provider</span><span class="p">:</span> <span class="n">ProviderProfile</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">builder</span> <span class="o">=</span> <span class="nf">select_tool_builder</span><span class="p">(</span><span class="n">provider</span><span class="p">.</span><span class="n">tool_json</span><span class="p">)</span>
    <span class="n">tools_json</span> <span class="o">=</span> <span class="n">builder</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">tools_json</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools_json</span><span class="p">,</span> <span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">:</span> <span class="nf">dict</span><span class="p">(</span><span class="n">provider</span><span class="p">.</span><span class="n">default_parameters</span> <span class="ow">or</span> <span class="p">{})}</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_with_provider</span><span class="p">(</span>
    <span class="n">provider</span><span class="p">:</span> <span class="n">ProviderProfile</span><span class="p">,</span>
    <span class="n">system_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">user_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">],</span>
    <span class="n">params_override</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">user</span><span class="p">:</span> <span class="n">InterruptUser</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">system_prompt</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_prompt</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="n">built</span> <span class="o">=</span> <span class="nf">build_payload</span><span class="p">(</span><span class="n">provider</span><span class="p">,</span> <span class="n">messages</span><span class="p">,</span> <span class="n">tools</span><span class="p">)</span>
    <span class="n">tools_json</span> <span class="o">=</span> <span class="n">built</span><span class="p">[</span><span class="sh">"</span><span class="s">tools_json</span><span class="sh">"</span><span class="p">]</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">built</span><span class="p">[</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">]</span>

    <span class="c1"># Advanced parameters override provider defaults (right wins)
</span>    <span class="k">if</span> <span class="n">params_override</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">params</span><span class="p">,</span> <span class="o">**</span><span class="n">params_override</span><span class="p">}</span>

    <span class="n">hooks</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">:</span> <span class="p">[],</span> <span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">httpx</span><span class="p">.</span><span class="nc">AsyncClient</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">httpx</span><span class="p">.</span><span class="nc">Timeout</span><span class="p">(</span><span class="mf">60.0</span><span class="p">),</span> <span class="n">event_hooks</span><span class="o">=</span><span class="n">hooks</span><span class="p">)</span> <span class="k">as</span> <span class="n">http_client</span><span class="p">:</span>
        <span class="k">async</span> <span class="k">with</span> <span class="nc">AsyncOpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">provider</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">provider</span><span class="p">.</span><span class="n">api_key</span><span class="p">,</span> <span class="n">http_client</span><span class="o">=</span><span class="n">http_client</span><span class="p">)</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">provider</span><span class="p">.</span><span class="n">api</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">runner</span> <span class="o">=</span> <span class="nc">ResponsesRunner</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">provider</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="n">messages</span><span class="p">,</span> <span class="n">tools_json</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">runner</span> <span class="o">=</span> <span class="nc">CompletionsRunner</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">provider</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="n">messages</span><span class="p">,</span> <span class="n">tools_json</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>

<span class="c1"># =========================
# Nodes
# =========================
</span>
<span class="k">class</span> <span class="nc">OpenAICustomProviderNode</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Build a provider profile directly from UI inputs.
    Optional </span><span class="sh">'</span><span class="s">parameters</span><span class="sh">'</span><span class="s"> lets you set default kwargs to forward verbatim.
    </span><span class="sh">"""</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">gpt-4.1-mini</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">api</span><span class="sh">"</span><span class="p">:</span> <span class="p">([</span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">],),</span>
                <span class="sh">"</span><span class="s">tool_json</span><span class="sh">"</span><span class="p">:</span> <span class="p">([</span><span class="sh">"</span><span class="s">flat</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">nested</span><span class="sh">"</span><span class="p">],),</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">optional</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool_choice: auto</span><span class="se">\n</span><span class="s">max_output_tokens: 1024</span><span class="se">\n</span><span class="s">temperature: 0.7</span><span class="se">\n</span><span class="s">top_p: 0.9</span><span class="se">\n</span><span class="sh">"</span>
                <span class="p">}),</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_PROVIDER</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">provider</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">build</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OpenAI/Provider</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tool_json</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">parameters</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span><span class="p">):</span>
        <span class="n">params_dict</span> <span class="o">=</span> <span class="nf">parse_loose_params</span><span class="p">(</span><span class="n">parameters</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">)</span>
        <span class="n">provider</span> <span class="o">=</span> <span class="nc">ProviderProfile</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="s">custom::</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">base_url</span><span class="o">=</span><span class="n">base_url</span><span class="p">,</span>
            <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
            <span class="n">api</span><span class="o">=</span><span class="n">api</span><span class="p">,</span>
            <span class="n">tool_json</span><span class="o">=</span><span class="n">tool_json</span><span class="p">,</span>
            <span class="n">default_parameters</span><span class="o">=</span><span class="n">params_dict</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">provider</span><span class="p">,)</span>

<span class="k">class</span> <span class="nc">OpenAIToolNode</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Compose a list of ToolSpec. If input list is None, start a new list.
    </span><span class="sh">"""</span>

    <span class="n">BUILTIN_CHOICES</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">BUILTIN_TOOLS</span><span class="p">.</span><span class="nf">keys</span><span class="p">())</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="n">cls</span><span class="p">.</span><span class="n">BUILTIN_CHOICES</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">}),</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">optional</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">tools_in</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_TOOLS</span><span class="sh">"</span><span class="p">,),</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_TOOLS</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">append_tool</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OpenAI/Tools</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">append_tool</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tool</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tools_in</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">speclist</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]</span> <span class="o">=</span> <span class="n">tools_in</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">tools_in</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">BUILTIN_TOOLS</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">tool</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">spec</span><span class="p">:</span>
            <span class="n">speclist</span> <span class="o">=</span> <span class="n">speclist</span> <span class="o">+</span> <span class="p">[</span><span class="n">spec</span><span class="p">]</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">speclist</span><span class="p">,)</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">AdvancedOptions</span><span class="p">:</span>
    <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]</span>
    <span class="n">custom_provider</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ProviderProfile</span><span class="p">]</span>
    <span class="n">system_prompt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># forwarded as **kwargs
</span>
<span class="k">class</span> <span class="nc">OpenAIAdvancedOptionsNode</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Aggregate optional tools, custom provider, system prompt, and parameters.
    </span><span class="sh">'</span><span class="s">parameters</span><span class="sh">'</span><span class="s"> is parsed with parse_loose_params and forwarded verbatim as **kwargs.
    </span><span class="sh">"""</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">optional</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_TOOLS</span><span class="sh">"</span><span class="p">,),</span>
                <span class="sh">"</span><span class="s">custom_provider</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_PROVIDER</span><span class="sh">"</span><span class="p">,),</span>
                <span class="sh">"</span><span class="s">system_prompt</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool_choice: auto</span><span class="se">\n</span><span class="s"># e.g., max_tokens / max_output_tokens / top_p / temperature / stop</span><span class="se">\n</span><span class="sh">"</span>
                <span class="p">}),</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_ADVANCED</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">advanced</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">build</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OpenAI/Options</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">custom_provider</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">system_prompt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span><span class="p">,</span> <span class="n">parameters</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span><span class="p">):</span>
        <span class="n">tlist</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]</span> <span class="o">=</span> <span class="n">tools</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">tools</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="n">provider</span> <span class="o">=</span> <span class="n">custom_provider</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">custom_provider</span><span class="p">,</span> <span class="n">ProviderProfile</span><span class="p">)</span> <span class="k">else</span> <span class="bp">None</span>
        <span class="n">sys_prompt</span> <span class="o">=</span> <span class="n">system_prompt</span> <span class="nf">if </span><span class="p">(</span><span class="n">system_prompt</span> <span class="ow">and</span> <span class="n">system_prompt</span><span class="p">.</span><span class="nf">strip</span><span class="p">())</span> <span class="k">else</span> <span class="bp">None</span>
        <span class="n">params_dict</span> <span class="o">=</span> <span class="nf">parse_loose_params</span><span class="p">(</span><span class="n">parameters</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">)</span>
        <span class="nf">return </span><span class="p">(</span><span class="nc">AdvancedOptions</span><span class="p">(</span><span class="n">tlist</span><span class="p">,</span> <span class="n">provider</span><span class="p">,</span> <span class="n">sys_prompt</span><span class="p">,</span> <span class="n">params_dict</span><span class="p">),)</span>

<span class="k">class</span> <span class="nc">OpenAIChatNode</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Async chat node:
      - Provider chosen by name from config.toml (auto-refreshed), overrideable via AdvancedOptions.custom_provider
      - parameters: provider.default_parameters merged with AdvancedOptions.parameters (right wins)
      - Executes tool-calling loop and returns final text
    </span><span class="sh">"""</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_provider_names</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">global</span> <span class="n">PROVIDER_CATALOG</span>
        <span class="n">PROVIDER_CATALOG</span> <span class="o">=</span> <span class="nf">load_providers_from_config</span><span class="p">(</span><span class="n">DEFAULT_CONFIG_PATH</span><span class="p">)</span>
        <span class="k">return</span> <span class="nf">list</span><span class="p">(</span><span class="n">PROVIDER_CATALOG</span><span class="p">.</span><span class="nf">keys</span><span class="p">())</span> <span class="ow">or</span> <span class="p">[</span><span class="sh">"</span><span class="s">&lt;no providers in config&gt;</span><span class="sh">"</span><span class="p">]</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="n">provider_list</span> <span class="o">=</span> <span class="n">cls</span><span class="p">.</span><span class="nf">_provider_names</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">user_prompt</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List files under ./samples, choose one text file, read it, and summarize in 2-3 sentences.</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">provider_name</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="n">provider_list</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="n">provider_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]}),</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">optional</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">advanced</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_ADVANCED</span><span class="sh">"</span><span class="p">,),</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">response_text</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">run</span><span class="sh">"</span>
    <span class="n">OUTPUT_NODE</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OpenAI/Chat</span><span class="sh">"</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">user_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">provider_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">advanced</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="c1"># Resolve provider
</span>        <span class="k">global</span> <span class="n">PROVIDER_CATALOG</span>
        <span class="n">provider</span> <span class="o">=</span> <span class="n">PROVIDER_CATALOG</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">provider_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">advanced</span> <span class="ow">and</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">advanced</span><span class="p">,</span> <span class="n">AdvancedOptions</span><span class="p">)</span> <span class="ow">and</span> <span class="n">advanced</span><span class="p">.</span><span class="n">custom_provider</span><span class="p">:</span>
            <span class="n">provider</span> <span class="o">=</span> <span class="n">advanced</span><span class="p">.</span><span class="n">custom_provider</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">provider</span><span class="p">:</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">[OpenAIChatNode] Error: provider not found. Check config.toml or AdvancedOptions.</span><span class="sh">"</span><span class="p">,)</span>

        <span class="c1"># System prompt
</span>        <span class="n">system_prompt</span> <span class="o">=</span> <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed.</span><span class="sh">"</span>
        <span class="k">if</span> <span class="n">advanced</span> <span class="ow">and</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">advanced</span><span class="p">,</span> <span class="n">AdvancedOptions</span><span class="p">)</span> <span class="ow">and</span> <span class="n">advanced</span><span class="p">.</span><span class="n">system_prompt</span><span class="p">:</span>
            <span class="n">system_prompt</span> <span class="o">=</span> <span class="n">advanced</span><span class="p">.</span><span class="n">system_prompt</span>

        <span class="c1"># Tools
</span>        <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">advanced</span> <span class="ow">and</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">advanced</span><span class="p">,</span> <span class="n">AdvancedOptions</span><span class="p">)</span> <span class="ow">and</span> <span class="n">advanced</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
            <span class="n">tools</span> <span class="o">=</span> <span class="n">advanced</span><span class="p">.</span><span class="n">tools</span>

        <span class="c1"># Merge parameters: provider defaults overridden by advanced
</span>        <span class="n">params_override</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">advanced</span> <span class="ow">and</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">advanced</span><span class="p">,</span> <span class="n">AdvancedOptions</span><span class="p">)</span> <span class="ow">and</span> <span class="n">advanced</span><span class="p">.</span><span class="n">parameters</span><span class="p">:</span>
            <span class="n">params_override</span> <span class="o">=</span> <span class="n">advanced</span><span class="p">.</span><span class="n">parameters</span>

        <span class="c1"># Interrupt support
</span>        <span class="n">user</span> <span class="o">=</span> <span class="nc">InterruptUser</span><span class="p">()</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_running_loop</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">loop</span><span class="p">.</span><span class="nf">add_signal_handler</span><span class="p">(</span><span class="n">signal</span><span class="p">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">user</span><span class="p">.</span><span class="n">trigger_interrupt</span><span class="p">)</span>
            <span class="n">loop</span><span class="p">.</span><span class="nf">add_signal_handler</span><span class="p">(</span><span class="n">signal</span><span class="p">.</span><span class="n">SIGTERM</span><span class="p">,</span> <span class="n">user</span><span class="p">.</span><span class="n">trigger_interrupt</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">run_with_provider</span><span class="p">(</span>
                <span class="n">provider</span><span class="o">=</span><span class="n">provider</span><span class="p">,</span>
                <span class="n">system_prompt</span><span class="o">=</span><span class="n">system_prompt</span><span class="p">,</span>
                <span class="n">user_prompt</span><span class="o">=</span><span class="n">user_prompt</span><span class="p">,</span>
                <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
                <span class="n">params_override</span><span class="o">=</span><span class="n">params_override</span><span class="p">,</span>
                <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nf">return </span><span class="p">(</span><span class="n">text</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,)</span>
        <span class="k">except</span> <span class="n">UserCancelledError</span><span class="p">:</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">[OpenAIChatNode] Interrupted by user.</span><span class="sh">"</span><span class="p">,)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nf">return </span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[OpenAIChatNode] Error: </span><span class="si">{</span><span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">,)</span>

<span class="c1"># =========================
# ComfyUI registration
# =========================
</span>
<span class="n">NODE_CLASS_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">OpenAIChatNode</span><span class="sh">"</span><span class="p">:</span> <span class="n">OpenAIChatNode</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">OpenAIToolNode</span><span class="sh">"</span><span class="p">:</span> <span class="n">OpenAIToolNode</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">OpenAICustomProviderNode</span><span class="sh">"</span><span class="p">:</span> <span class="n">OpenAICustomProviderNode</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">OpenAIAdvancedOptionsNode</span><span class="sh">"</span><span class="p">:</span> <span class="n">OpenAIAdvancedOptionsNode</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">NODE_DISPLAY_NAME_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">OpenAIChatNode</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">OpenAI Chat (Async)</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">OpenAIToolNode</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">OpenAI Tool Builder</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">OpenAICustomProviderNode</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">OpenAI Custom Provider</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">OpenAIAdvancedOptionsNode</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">OpenAI Advanced Options</span><span class="sh">"</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div>

<p>빠른 사용 가이드</p>

<ol>
  <li>
    <p>ComfyUI/custom_nodes/ 아래에 파일 저장 후 재시작.</p>
  </li>
  <li>
    <p>config.toml 예시</p>
  </li>
</ol>

<div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[[api_provider]</span><span class="err">]</span>
<span class="py">name</span> <span class="p">=</span> <span class="s">"OSS GPT (Responses + Flat)"</span>
<span class="py">model</span> <span class="p">=</span> <span class="s">"gpt-4.1-mini"</span>
<span class="py">base_url</span> <span class="p">=</span> <span class="s">"https://api.openai.com/v1"</span>
<span class="py">api_key_env</span> <span class="p">=</span> <span class="s">"OPENAI_API_KEY"</span>
<span class="py">api</span> <span class="p">=</span> <span class="s">"responses"</span>
<span class="py">tool_json</span> <span class="p">=</span> <span class="s">"flat"</span>
<span class="py">parameters</span> <span class="p">=</span> <span class="s">"""
  tool_choice: auto
  max_output_tokens: 1024
  temperature: 0.7
  top_p: 0.9
"""</span>
</code></pre></div></div>

<ol>
  <li>워크플로우에서 AdvancedOptions의 parameters에</li>
</ol>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">reasoning</span><span class="pi">:</span> <span class="pi">{</span><span class="nv">effort</span><span class="pi">:</span> <span class="nv">high</span><span class="pi">}</span>
<span class="na">stop</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">END</span><span class="pi">,</span> <span class="c1">###]</span>
</code></pre></div></div>

<p>같이 넣으면 그대로 **kwargs로 API에 전달돼. 필요한 필드는 모델/엔드포인트 문서 기준으로 자유롭게 넣으면 된다.</p>

<p class="chat--user">

BuiltIn Tools로 다 선언하지 말고 각각 Tool 노드에서 툴을 만들게 하고 싶어. 예를 들어 추가적인 입력(예를 들어 경로라든지)를 노드에서 받아서 dynamic하게 만드는게 더 좋을 것 같아. call back을 통해 ui 업데이트 같은거도 넣고싶고. 

</p>

<p>좋아. “빌트인 툴”을 없애고, 각 Tool 노드에서 동적으로 툴을 만들도록 전체 구조를 바꿨다. 아래 코드는 다음을 포함한다.</p>

<ul>
  <li>
    <p>OpenAIChatNode (async): provider + tools + parameters로 호출, 툴 콜 처리 루프 포함</p>
  </li>
  <li>
    <p>OpenAIToolNode: 선택한 tool_type과 추가 입력(예: base_dir, encoding 등)으로 동적 ToolSpec 생성하여 리스트에 추가</p>
  </li>
  <li>
    <p>OpenAICustomProviderNode: provider를 UI에서 직접 생성 (parameters를 그대로 **kwargs로 전달)</p>
  </li>
  <li>
    <p>OpenAIAdvancedOptionsNode: tools, custom provider, system prompt, parameters를 하나로 묶음</p>
  </li>
  <li>
    <p>OpenAICallbackNode: 간단한 콜백 핸들; 툴 실행 시 emit(event, payload) 호출로 UI/로그 업데이트 훅 제공</p>
  </li>
</ul>

<p>파라미터는 config/Advanced에서 받은 문자열을 느슨 파싱(엄격 JSON 또는 key: value 라인) 후 그대로 **kwargs로 API에 전달한다. arg_adapter/NeutralParams는 완전히 제거했다. Tool JSON 형식(flat/nested)과 Responses/Completions 모두 지원한다.</p>

<p>파일: ComfyUI/custom_nodes/openai_comfy_nodes.py</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># openai_comfy_nodes.py
# Python 3.10+
# Dependencies:
#   pip install --upgrade openai httpx
#
# Nodes:
#   1) OpenAIChatNode (async)
#   2) OpenAIToolNode  (dynamic tool builder; appends to list)
#   3) OpenAICustomProviderNode
#   4) OpenAIAdvancedOptionsNode
#   5) OpenAICallbackNode (optional callback sink)
#
# Design:
# - Async-only (AsyncOpenAI + httpx.AsyncClient).
# - Provider chosen by name from config.toml (OPENAI_PROVIDER_CONFIG or ./config.toml),
#   or overridden via AdvancedOptions.
# - Parameters are parsed permissively and forwarded verbatim as **kwargs.
# - Tools are created per Tool node (no built-ins registry). Each node builds a ToolSpec
#   with a closure that can capture node inputs (e.g., base_dir, encoding) and an optional callback.
# - Tool JSON: flat or nested.
# - Tool calls are executed locally; responses/completions loop until no tool calls.
</span>
<span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">re</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">signal</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Protocol</span>

<span class="c1"># TOML loader
</span><span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomllib</span>  <span class="c1"># Py3.11+
</span><span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">tomllib</span> <span class="o">=</span> <span class="bp">None</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomli</span>     <span class="c1"># Fallback
</span><span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">tomli</span> <span class="o">=</span> <span class="bp">None</span>

<span class="kn">import</span> <span class="n">httpx</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">AsyncOpenAI</span>

<span class="c1"># =========================
# Interrupt helpers
# =========================
</span>
<span class="k">class</span> <span class="nc">UserCancelledError</span><span class="p">(</span><span class="nb">Exception</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Raised when the user has interrupted the processing.</span><span class="sh">"""</span>

<span class="k">class</span> <span class="nc">InterruptUser</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Cooperative interrupt controller.</span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_event</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Event</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">trigger_interrupt</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_event</span><span class="p">.</span><span class="nf">set</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">processing_interrupted</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_event</span><span class="p">.</span><span class="nf">is_set</span><span class="p">()</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">call_with_interrupt</span><span class="p">(</span><span class="n">awaitable</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="n">InterruptUser</span><span class="p">,</span> <span class="n">poll</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Await an I/O while polling interruption; cancel if interrupted.</span><span class="sh">"""</span>
    <span class="n">task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="n">awaitable</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">({</span><span class="n">task</span><span class="p">},</span> <span class="n">timeout</span><span class="o">=</span><span class="n">poll</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">task</span><span class="p">.</span><span class="nf">result</span><span class="p">()</span>
            <span class="k">if</span> <span class="k">await</span> <span class="n">user</span><span class="p">.</span><span class="nf">processing_interrupted</span><span class="p">():</span>
                <span class="n">task</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">task</span>
                <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">raise</span> <span class="nc">UserCancelledError</span><span class="p">(</span><span class="sh">"</span><span class="s">Interrupted by user.</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">raise</span>

<span class="c1"># =========================
# Permissive parameters parsing
# =========================
</span>
<span class="k">def</span> <span class="nf">_try_json_loads</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">_parse_scalar</span><span class="p">(</span><span class="n">v</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">t</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">false</span><span class="sh">"</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">t</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="o">==</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span>
    <span class="k">if</span> <span class="n">t</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">null</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">none</span><span class="sh">"</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">re</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">^-?\d+$</span><span class="sh">"</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
            <span class="k">return</span> <span class="nf">int</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">re</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">^-?\d+\.\d+$</span><span class="sh">"</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
            <span class="k">return</span> <span class="nf">float</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="nf">if </span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">[</span><span class="sh">"</span><span class="p">)</span> <span class="ow">and</span> <span class="n">t</span><span class="p">.</span><span class="nf">endswith</span><span class="p">(</span><span class="sh">"</span><span class="s">]</span><span class="sh">"</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">{</span><span class="sh">"</span><span class="p">)</span> <span class="ow">and</span> <span class="n">t</span><span class="p">.</span><span class="nf">endswith</span><span class="p">(</span><span class="sh">"</span><span class="s">}</span><span class="sh">"</span><span class="p">)):</span>
        <span class="n">j</span> <span class="o">=</span> <span class="nf">_try_json_loads</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">j</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">j</span>
    <span class="k">if</span> <span class="sh">"</span><span class="s">,</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">t</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="p">)]</span>
        <span class="k">return</span> <span class="p">[</span><span class="nf">_parse_scalar</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">t</span>

<span class="k">def</span> <span class="nf">parse_loose_params</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">
    1) Try strict JSON.
    2) Else parse lines like </span><span class="sh">"</span><span class="s">key: value</span><span class="sh">"</span><span class="s"> or </span><span class="sh">"</span><span class="s">key = value</span><span class="sh">"</span><span class="s"> with auto-typing.
       Ignores empty lines and comment lines starting with # // ;
    </span><span class="sh">"""</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">text</span><span class="p">.</span><span class="nf">strip</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">{}</span>
    <span class="n">j</span> <span class="o">=</span> <span class="nf">_try_json_loads</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">j</span>

    <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">raw</span> <span class="ow">in</span> <span class="n">text</span><span class="p">.</span><span class="nf">splitlines</span><span class="p">():</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">raw</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">line</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">#</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">line</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">//</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">line</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">;</span><span class="sh">"</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">\s+#</span><span class="sh">"</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nf">strip</span><span class="p">()</span>  <span class="c1"># strip trailing comment after '#'
</span>        <span class="n">parts</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">\s*[:=]\s*</span><span class="sh">"</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">strip</span><span class="p">(),</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">norm_key</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">sub</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">[\s\-]+</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">_</span><span class="sh">"</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="nf">lower</span><span class="p">())</span>
        <span class="n">out</span><span class="p">[</span><span class="n">norm_key</span><span class="p">]</span> <span class="o">=</span> <span class="nf">_parse_scalar</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="c1"># =========================
# Provider config
# =========================
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ProviderProfile</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">model</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">api</span><span class="p">:</span> <span class="nb">str</span>          <span class="c1"># "responses" | "completions"
</span>    <span class="n">tool_json</span><span class="p">:</span> <span class="nb">str</span>    <span class="c1"># "flat" | "nested"
</span>    <span class="n">default_parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># forwarded as **kwargs
</span>
<span class="k">def</span> <span class="nf">_load_toml_bytes</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
    <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">load_providers_from_config</span><span class="p">(</span><span class="n">config_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ProviderProfile</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">
    [[api_provider]]
    name = </span><span class="sh">"</span><span class="s">OSS GPT (Responses + Flat)</span><span class="sh">"</span><span class="s">
    model = </span><span class="sh">"</span><span class="s">gpt-4.1-mini</span><span class="sh">"</span><span class="s">
    base_url = </span><span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="s">
    api_key_env = </span><span class="sh">"</span><span class="s">OPENAI_API_KEY</span><span class="sh">"</span><span class="s">   # or api_key = </span><span class="sh">"</span><span class="s">sk-...</span><span class="sh">"</span><span class="s">
    api = </span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="s">                # </span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="s"> | </span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="s">
    tool_json = </span><span class="sh">"</span><span class="s">flat</span><span class="sh">"</span><span class="s">               # </span><span class="sh">"</span><span class="s">flat</span><span class="sh">"</span><span class="s"> | </span><span class="sh">"</span><span class="s">nested</span><span class="sh">"</span><span class="s">
    parameters = </span><span class="sh">'''</span><span class="s">
      tool_choice: auto
      max_output_tokens: 1024
      temperature: 0.7
      top_p: 0.9
    </span><span class="sh">'''</span><span class="s">
    </span><span class="sh">"""</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">config_path</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="n">raw</span> <span class="o">=</span> <span class="nf">_load_toml_bytes</span><span class="p">(</span><span class="n">config_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">config_path</span><span class="p">.</span><span class="nf">lower</span><span class="p">().</span><span class="nf">endswith</span><span class="p">(</span><span class="sh">"</span><span class="s">.toml</span><span class="sh">"</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">tomllib</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">tomllib</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">tomli</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">tomli</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">TOML parser not available. Use Python 3.11+ or `pip install tomli`.</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">))</span>

    <span class="n">providers_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">api_provider</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">api_providers</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">providers_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ProviderProfile</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">providers_data</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">base_url</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">api_key_env</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">api_key_env</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">api</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">api</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">tool_json</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_json</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">raw_params</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">model</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">base_url</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">api</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">tool_json</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">api_key</span> <span class="ow">and</span> <span class="n">api_key_env</span><span class="p">:</span>
            <span class="n">api_key</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="n">api_key_env</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">api_key</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">raw_params</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">params_dict</span> <span class="o">=</span> <span class="nf">parse_loose_params</span><span class="p">(</span><span class="n">raw_params</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">raw_params</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">params_dict</span> <span class="o">=</span> <span class="n">raw_params</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">params_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">out</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nc">ProviderProfile</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">base_url</span><span class="o">=</span><span class="n">base_url</span><span class="p">,</span>
            <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
            <span class="n">api</span><span class="o">=</span><span class="n">api</span><span class="p">,</span>
            <span class="n">tool_json</span><span class="o">=</span><span class="n">tool_json</span><span class="p">,</span>
            <span class="n">default_parameters</span><span class="o">=</span><span class="n">params_dict</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="n">DEFAULT_CONFIG_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_PROVIDER_CONFIG</span><span class="sh">"</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="nf">getcwd</span><span class="p">(),</span> <span class="sh">"</span><span class="s">config.toml</span><span class="sh">"</span><span class="p">))</span>
<span class="n">PROVIDER_CATALOG</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ProviderProfile</span><span class="p">]</span> <span class="o">=</span> <span class="nf">load_providers_from_config</span><span class="p">(</span><span class="n">DEFAULT_CONFIG_PATH</span><span class="p">)</span>

<span class="c1"># =========================
# Tool layer (dynamic, per-node)
# =========================
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ToolSpec</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="n">func</span><span class="p">:</span> <span class="n">Any</span>  <span class="c1"># Callable[[Dict[str, Any]], Any]
</span>
<span class="k">class</span> <span class="nc">ToolJSONBuilder</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="bp">...</span>

<span class="k">class</span> <span class="nc">FlatToolJSONBuilder</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="k">return</span> <span class="p">[{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">description</span><span class="p">,</span> <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">parameters</span><span class="p">}</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">NestedToolJSONBuilder</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="k">return</span> <span class="p">[{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">description</span><span class="p">,</span> <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">parameters</span><span class="p">}}</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">select_tool_builder</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ToolJSONBuilder</span><span class="p">:</span>
    <span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="n">kind</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">).</span><span class="nf">strip</span><span class="p">().</span><span class="nf">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="sh">"</span><span class="s">flat</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="nc">FlatToolJSONBuilder</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="sh">"</span><span class="s">nested</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="nc">NestedToolJSONBuilder</span><span class="p">()</span>
    <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool_json: </span><span class="si">{</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># =========================
# Optional callback sink
# =========================
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">CallbackSink</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Lightweight event sink. You can attach a UI listener to consume .events.</span><span class="sh">"""</span>
    <span class="n">label</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OpenAI</span><span class="sh">"</span>
    <span class="n">events</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">events</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">events</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">emit</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
        <span class="n">rec</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">event</span><span class="sh">"</span><span class="p">:</span> <span class="n">event</span><span class="p">,</span> <span class="sh">"</span><span class="s">payload</span><span class="sh">"</span><span class="p">:</span> <span class="n">payload</span><span class="p">}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">events</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span>
        <span class="c1"># Basic side-effect for visibility; replace with your UI integration if needed
</span>        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">label</span><span class="si">}</span><span class="s">] </span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">payload</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># =========================
# Protocol runners (async), **kwargs passthrough
# =========================
</span>
<span class="k">class</span> <span class="nc">ResponsesRunner</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Async Responses loop; tool calls executed locally.</span><span class="sh">"""</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_collect_text</span><span class="p">(</span><span class="n">resp</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
            <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]:</span>
                    <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
            <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
        <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">texts</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_collect_calls</span><span class="p">(</span><span class="n">resp</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="sh">"</span><span class="s">function_call</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                        <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                              <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                              <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{}})</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">inner</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">inner</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">inner</span><span class="p">:</span>
                        <span class="n">nm</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                        <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                                <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                                      <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">nm</span><span class="p">,</span>
                                      <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{}})</span>
        <span class="k">return</span> <span class="n">calls</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">tools</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">:</span> <span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">_exec_tool</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">spec</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">spec</span><span class="p">.</span><span class="nf">func</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">client</span><span class="p">:</span> <span class="n">AsyncOpenAI</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">tools_json</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">user</span><span class="p">:</span> <span class="n">InterruptUser</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">base</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span> <span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools_json</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_choice</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">}</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">base</span><span class="p">,</span> <span class="o">**</span><span class="p">(</span><span class="n">params</span> <span class="ow">or</span> <span class="p">{})}</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">call_with_interrupt</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">),</span> <span class="n">user</span><span class="p">)</span>

        <span class="n">chunks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">_collect_text</span><span class="p">(</span><span class="n">resp</span><span class="p">))</span>
            <span class="n">calls</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_collect_calls</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
                <span class="k">if</span> <span class="k">await</span> <span class="n">user</span><span class="p">.</span><span class="nf">processing_interrupted</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="nc">UserCancelledError</span><span class="p">(</span><span class="sh">"</span><span class="s">Interrupted by user.</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_exec_tool</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
                <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function_call_output</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">[</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)})</span>

            <span class="n">base</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span> <span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools_json</span><span class="p">}</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">base</span><span class="p">,</span> <span class="o">**</span><span class="p">(</span><span class="n">params</span> <span class="ow">or</span> <span class="p">{})}</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">call_with_interrupt</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">),</span> <span class="n">user</span><span class="p">)</span>

        <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">chunks</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

<span class="k">class</span> <span class="nc">CompletionsRunner</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Async Chat Completions loop; tool calls executed locally.</span><span class="sh">"""</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">tools</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">:</span> <span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">_exec_tool</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">spec</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">spec</span><span class="p">.</span><span class="nf">func</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">client</span><span class="p">:</span> <span class="n">AsyncOpenAI</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">tools_json</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">user</span><span class="p">:</span> <span class="n">InterruptUser</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">base</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools_json</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_choice</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">}</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">base</span><span class="p">,</span> <span class="o">**</span><span class="p">(</span><span class="n">params</span> <span class="ow">or</span> <span class="p">{})}</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">call_with_interrupt</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">),</span> <span class="n">user</span><span class="p">)</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
        <span class="n">chunks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">]</span>
        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">tool_msgs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="k">if</span> <span class="k">await</span> <span class="n">user</span><span class="p">.</span><span class="nf">processing_interrupted</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="nc">UserCancelledError</span><span class="p">(</span><span class="sh">"</span><span class="s">Interrupted by user.</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">fn</span> <span class="o">=</span> <span class="n">tc</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">tc</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_exec_tool</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>
                <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">tc</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)})</span>

            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">]})</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

            <span class="n">base</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">}</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">base</span><span class="p">,</span> <span class="o">**</span><span class="p">(</span><span class="n">params</span> <span class="ow">or</span> <span class="p">{})}</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">call_with_interrupt</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">),</span> <span class="n">user</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
            <span class="k">if</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">content</span><span class="p">)</span>

        <span class="k">return</span> <span class="sh">"</span><span class="se">\n\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">chunks</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

<span class="c1"># =========================
# Orchestrator
# =========================
</span>
<span class="k">def</span> <span class="nf">build_payload</span><span class="p">(</span><span class="n">provider</span><span class="p">:</span> <span class="n">ProviderProfile</span><span class="p">,</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">builder</span> <span class="o">=</span> <span class="nf">select_tool_builder</span><span class="p">(</span><span class="n">provider</span><span class="p">.</span><span class="n">tool_json</span><span class="p">)</span>
    <span class="n">tools_json</span> <span class="o">=</span> <span class="n">builder</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">tools_json</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools_json</span><span class="p">,</span> <span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">:</span> <span class="nf">dict</span><span class="p">(</span><span class="n">provider</span><span class="p">.</span><span class="n">default_parameters</span> <span class="ow">or</span> <span class="p">{})}</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_with_provider</span><span class="p">(</span>
    <span class="n">provider</span><span class="p">:</span> <span class="n">ProviderProfile</span><span class="p">,</span>
    <span class="n">system_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">user_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">],</span>
    <span class="n">params_override</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">user</span><span class="p">:</span> <span class="n">InterruptUser</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">system_prompt</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_prompt</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="n">built</span> <span class="o">=</span> <span class="nf">build_payload</span><span class="p">(</span><span class="n">provider</span><span class="p">,</span> <span class="n">tools</span><span class="p">)</span>
    <span class="n">tools_json</span> <span class="o">=</span> <span class="n">built</span><span class="p">[</span><span class="sh">"</span><span class="s">tools_json</span><span class="sh">"</span><span class="p">]</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">built</span><span class="p">[</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">params_override</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">params</span><span class="p">,</span> <span class="o">**</span><span class="n">params_override</span><span class="p">}</span>  <span class="c1"># right wins
</span>
    <span class="n">hooks</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">:</span> <span class="p">[],</span> <span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">httpx</span><span class="p">.</span><span class="nc">AsyncClient</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">httpx</span><span class="p">.</span><span class="nc">Timeout</span><span class="p">(</span><span class="mf">60.0</span><span class="p">),</span> <span class="n">event_hooks</span><span class="o">=</span><span class="n">hooks</span><span class="p">)</span> <span class="k">as</span> <span class="n">http_client</span><span class="p">:</span>
        <span class="k">async</span> <span class="k">with</span> <span class="nc">AsyncOpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">provider</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">provider</span><span class="p">.</span><span class="n">api_key</span><span class="p">,</span> <span class="n">http_client</span><span class="o">=</span><span class="n">http_client</span><span class="p">)</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">provider</span><span class="p">.</span><span class="n">api</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">runner</span> <span class="o">=</span> <span class="nc">ResponsesRunner</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">provider</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="n">messages</span><span class="p">,</span> <span class="n">tools_json</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">runner</span> <span class="o">=</span> <span class="nc">CompletionsRunner</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">provider</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="n">messages</span><span class="p">,</span> <span class="n">tools_json</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>

<span class="c1"># =========================
# Nodes
# =========================
</span>
<span class="c1"># -- Provider
</span>
<span class="k">class</span> <span class="nc">OpenAICustomProviderNode</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Create a provider profile directly from UI inputs; parameters forwarded verbatim as **kwargs.</span><span class="sh">"""</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">gpt-4.1-mini</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">api</span><span class="sh">"</span><span class="p">:</span> <span class="p">([</span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">],),</span>
                <span class="sh">"</span><span class="s">tool_json</span><span class="sh">"</span><span class="p">:</span> <span class="p">([</span><span class="sh">"</span><span class="s">flat</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">nested</span><span class="sh">"</span><span class="p">],),</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">optional</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool_choice: auto</span><span class="se">\n</span><span class="s">max_output_tokens: 1024</span><span class="se">\n</span><span class="s">temperature: 0.7</span><span class="se">\n</span><span class="s">top_p: 0.9</span><span class="se">\n</span><span class="sh">"</span>
                <span class="p">}),</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_PROVIDER</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">provider</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">build</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OpenAI/Provider</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tool_json</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">parameters</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span><span class="p">):</span>
        <span class="n">params_dict</span> <span class="o">=</span> <span class="nf">parse_loose_params</span><span class="p">(</span><span class="n">parameters</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">)</span>
        <span class="n">provider</span> <span class="o">=</span> <span class="nc">ProviderProfile</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="s">custom::</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">base_url</span><span class="o">=</span><span class="n">base_url</span><span class="p">,</span>
            <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
            <span class="n">api</span><span class="o">=</span><span class="n">api</span><span class="p">,</span>
            <span class="n">tool_json</span><span class="o">=</span><span class="n">tool_json</span><span class="p">,</span>
            <span class="n">default_parameters</span><span class="o">=</span><span class="n">params_dict</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">provider</span><span class="p">,)</span>

<span class="c1"># -- Callback sink
</span>
<span class="k">class</span> <span class="nc">OpenAICallbackNode</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Create a simple callback sink. Tools can emit(event, payload) to this sink.</span><span class="sh">"""</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">optional</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">label</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">OpenAI</span><span class="sh">"</span><span class="p">}),</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_CALLBACK</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">callback</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">build</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OpenAI/Utils</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">label</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OpenAI</span><span class="sh">"</span><span class="p">):</span>
        <span class="nf">return </span><span class="p">(</span><span class="nc">CallbackSink</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">),)</span>

<span class="c1"># -- Dynamic Tool Builder
</span>
<span class="k">class</span> <span class="nc">OpenAIToolNode</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Build a dynamic tool and append to an incoming tool list.
    Supported tool_type:
      - list_files_in_folder
      - read_text_file
    Extra inputs are captured in the tool closure (e.g., base_dir, encoding, callback).
    </span><span class="sh">"""</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">tool_type</span><span class="sh">"</span><span class="p">:</span> <span class="p">([</span><span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">],),</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List files or read text file.</span><span class="sh">"</span><span class="p">}),</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">optional</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">tools_in</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_TOOLS</span><span class="sh">"</span><span class="p">,),</span>  <span class="c1"># existing list to append to
</span>                <span class="sh">"</span><span class="s">base_dir</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">return_full_paths</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">BOOLEAN</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">encoding</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">}),</span>  <span class="c1"># for read_text_file
</span>                <span class="sh">"</span><span class="s">callback</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_CALLBACK</span><span class="sh">"</span><span class="p">,),</span>              <span class="c1"># optional
</span>            <span class="p">}</span>
        <span class="p">}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_TOOLS</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">append_tool</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OpenAI/Tools</span><span class="sh">"</span>

    <span class="c1"># ---- helpers
</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_safe_join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">Resolve path under base_dir to avoid traversal; return None if outside.</span><span class="sh">"""</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">base_dir</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">base_dir</span><span class="p">)</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">target</span> <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">commonpath</span><span class="p">([</span><span class="n">base</span><span class="p">,</span> <span class="n">target</span><span class="p">])</span> <span class="o">==</span> <span class="n">base</span> <span class="k">else</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">_make_list_files_tool</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">description</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">return_full_paths</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">cb</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CallbackSink</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ToolSpec</span><span class="p">:</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Folder path (relative to base_dir if provided).</span><span class="sh">"</span><span class="p">},</span>
                <span class="sh">"</span><span class="s">pattern</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Optional glob pattern, e.g., *.txt</span><span class="sh">"</span><span class="p">},</span>
                <span class="sh">"</span><span class="s">absolute</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">boolean</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Return absolute paths (overrides node default).</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">}</span>

        <span class="k">def</span> <span class="nf">_impl</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
            <span class="n">folder</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">)</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">pattern</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">)</span>
            <span class="n">absolute</span> <span class="o">=</span> <span class="nf">bool</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">absolute</span><span class="sh">"</span><span class="p">,</span> <span class="n">return_full_paths</span><span class="p">))</span>

            <span class="n">folder_resolved</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_safe_join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">folder</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">folder_resolved</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isdir</span><span class="p">(</span><span class="n">folder_resolved</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">cb</span><span class="p">:</span> <span class="n">cb</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_error</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">reason</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">invalid_folder</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">folder</span><span class="sh">"</span><span class="p">:</span> <span class="n">folder</span><span class="p">})</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>

            <span class="kn">import</span> <span class="n">glob</span>
            <span class="n">glob_target</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">folder_resolved</span><span class="p">,</span> <span class="n">pattern</span><span class="p">)</span> <span class="k">if</span> <span class="n">pattern</span> <span class="k">else</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">folder_resolved</span><span class="p">,</span> <span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">.</span><span class="nf">glob</span><span class="p">(</span><span class="n">glob_target</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">p</span><span class="p">)]</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">if</span> <span class="n">absolute</span> <span class="k">else</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">basename</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">cb</span><span class="p">:</span> <span class="n">cb</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_done</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">count</span><span class="sh">"</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">out</span><span class="p">)})</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">out</span><span class="p">)}</span>

        <span class="k">return</span> <span class="nc">ToolSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">_impl</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_make_read_text_tool</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">description</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">cb</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CallbackSink</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ToolSpec</span><span class="p">:</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">File path (relative to base_dir if provided).</span><span class="sh">"</span><span class="p">},</span>
                <span class="sh">"</span><span class="s">encoding</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Optional override for text encoding.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">}</span>

        <span class="k">def</span> <span class="nf">_impl</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">)</span>
            <span class="n">enc</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">encoding</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="p">)</span> <span class="ow">or</span> <span class="n">encoding</span><span class="p">)</span>
            <span class="n">file_resolved</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_safe_join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">file_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">file_resolved</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">file_resolved</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">cb</span><span class="p">:</span> <span class="n">cb</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_error</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">reason</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">invalid_file</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="p">:</span> <span class="n">file_path</span><span class="p">})</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">file_resolved</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">enc</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">cb</span><span class="p">:</span> <span class="n">cb</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_done</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">text</span><span class="p">)})</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="n">text</span><span class="p">}</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cb</span><span class="p">:</span> <span class="n">cb</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_error</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">reason</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_failed</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">)})</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}</span>

        <span class="k">return</span> <span class="nc">ToolSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">_impl</span><span class="p">)</span>

    <span class="c1"># ---- core
</span>
    <span class="k">def</span> <span class="nf">append_tool</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">tool_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">description</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">tools_in</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">base_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span><span class="p">,</span>
        <span class="n">return_full_paths</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">callback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CallbackSink</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="p">):</span>
        <span class="n">speclist</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]</span> <span class="o">=</span> <span class="n">tools_in</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">tools_in</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">tool_type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_make_list_files_tool</span><span class="p">(</span><span class="n">name</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">,</span> <span class="n">return_full_paths</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">tool_type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_make_read_text_tool</span><span class="p">(</span><span class="n">name</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">,</span> <span class="n">encoding</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Unknown tool type -&gt; no-op append
</span>            <span class="nf">return </span><span class="p">(</span><span class="n">speclist</span><span class="p">,)</span>

        <span class="nf">return </span><span class="p">(</span><span class="n">speclist</span> <span class="o">+</span> <span class="p">[</span><span class="n">spec</span><span class="p">],)</span>

<span class="c1"># -- Advanced options aggregator
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">AdvancedOptions</span><span class="p">:</span>
    <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]</span>
    <span class="n">custom_provider</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ProviderProfile</span><span class="p">]</span>
    <span class="n">system_prompt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># forwarded as **kwargs
</span>
<span class="k">class</span> <span class="nc">OpenAIAdvancedOptionsNode</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Aggregate tools, custom provider, system prompt, and parameters (verbatim **kwargs).</span><span class="sh">"""</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">optional</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_TOOLS</span><span class="sh">"</span><span class="p">,),</span>
                <span class="sh">"</span><span class="s">custom_provider</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_PROVIDER</span><span class="sh">"</span><span class="p">,),</span>
                <span class="sh">"</span><span class="s">system_prompt</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool_choice: auto</span><span class="se">\n</span><span class="s"># e.g., max_tokens / max_output_tokens / top_p / temperature / stop</span><span class="se">\n</span><span class="sh">"</span>
                <span class="p">}),</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_ADVANCED</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">advanced</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">build</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OpenAI/Options</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">custom_provider</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">system_prompt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span><span class="p">,</span> <span class="n">parameters</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span><span class="p">):</span>
        <span class="n">tlist</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]</span> <span class="o">=</span> <span class="n">tools</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">tools</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="n">provider</span> <span class="o">=</span> <span class="n">custom_provider</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">custom_provider</span><span class="p">,</span> <span class="n">ProviderProfile</span><span class="p">)</span> <span class="k">else</span> <span class="bp">None</span>
        <span class="n">sys_prompt</span> <span class="o">=</span> <span class="n">system_prompt</span> <span class="nf">if </span><span class="p">(</span><span class="n">system_prompt</span> <span class="ow">and</span> <span class="n">system_prompt</span><span class="p">.</span><span class="nf">strip</span><span class="p">())</span> <span class="k">else</span> <span class="bp">None</span>
        <span class="n">params_dict</span> <span class="o">=</span> <span class="nf">parse_loose_params</span><span class="p">(</span><span class="n">parameters</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">)</span>
        <span class="nf">return </span><span class="p">(</span><span class="nc">AdvancedOptions</span><span class="p">(</span><span class="n">tlist</span><span class="p">,</span> <span class="n">provider</span><span class="p">,</span> <span class="n">sys_prompt</span><span class="p">,</span> <span class="n">params_dict</span><span class="p">),)</span>

<span class="c1"># -- Chat
</span>
<span class="k">class</span> <span class="nc">OpenAIChatNode</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Async chat node:
      - Provider chosen by name from config.toml (auto-refreshed), overrideable via AdvancedOptions.custom_provider
      - Parameters: provider.default_parameters merged with AdvancedOptions.parameters (right wins)
      - Executes tool-calling loop and returns final text
    </span><span class="sh">"""</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_provider_names</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">global</span> <span class="n">PROVIDER_CATALOG</span>
        <span class="n">PROVIDER_CATALOG</span> <span class="o">=</span> <span class="nf">load_providers_from_config</span><span class="p">(</span><span class="n">DEFAULT_CONFIG_PATH</span><span class="p">)</span>
        <span class="k">return</span> <span class="nf">list</span><span class="p">(</span><span class="n">PROVIDER_CATALOG</span><span class="p">.</span><span class="nf">keys</span><span class="p">())</span> <span class="ow">or</span> <span class="p">[</span><span class="sh">"</span><span class="s">&lt;no providers in config&gt;</span><span class="sh">"</span><span class="p">]</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="n">provider_list</span> <span class="o">=</span> <span class="n">cls</span><span class="p">.</span><span class="nf">_provider_names</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">user_prompt</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List files under ./samples, choose one text file, read it, and summarize in 2-3 sentences.</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">provider_name</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="n">provider_list</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="n">provider_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]}),</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">optional</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">advanced</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_ADVANCED</span><span class="sh">"</span><span class="p">,),</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">response_text</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">run</span><span class="sh">"</span>
    <span class="n">OUTPUT_NODE</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OpenAI/Chat</span><span class="sh">"</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">user_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">provider_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">advanced</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="c1"># Resolve provider
</span>        <span class="k">global</span> <span class="n">PROVIDER_CATALOG</span>
        <span class="n">provider</span> <span class="o">=</span> <span class="n">PROVIDER_CATALOG</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">provider_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">advanced</span> <span class="ow">and</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">advanced</span><span class="p">,</span> <span class="n">AdvancedOptions</span><span class="p">)</span> <span class="ow">and</span> <span class="n">advanced</span><span class="p">.</span><span class="n">custom_provider</span><span class="p">:</span>
            <span class="n">provider</span> <span class="o">=</span> <span class="n">advanced</span><span class="p">.</span><span class="n">custom_provider</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">provider</span><span class="p">:</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">[OpenAIChatNode] Error: provider not found. Check config.toml or AdvancedOptions.</span><span class="sh">"</span><span class="p">,)</span>

        <span class="c1"># System prompt
</span>        <span class="n">system_prompt</span> <span class="o">=</span> <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed.</span><span class="sh">"</span>
        <span class="k">if</span> <span class="n">advanced</span> <span class="ow">and</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">advanced</span><span class="p">,</span> <span class="n">AdvancedOptions</span><span class="p">)</span> <span class="ow">and</span> <span class="n">advanced</span><span class="p">.</span><span class="n">system_prompt</span><span class="p">:</span>
            <span class="n">system_prompt</span> <span class="o">=</span> <span class="n">advanced</span><span class="p">.</span><span class="n">system_prompt</span>

        <span class="c1"># Tools
</span>        <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">advanced</span> <span class="ow">and</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">advanced</span><span class="p">,</span> <span class="n">AdvancedOptions</span><span class="p">)</span> <span class="ow">and</span> <span class="n">advanced</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
            <span class="n">tools</span> <span class="o">=</span> <span class="n">advanced</span><span class="p">.</span><span class="n">tools</span>

        <span class="c1"># Merge parameters: provider defaults overridden by advanced
</span>        <span class="n">params_override</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">advanced</span> <span class="ow">and</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">advanced</span><span class="p">,</span> <span class="n">AdvancedOptions</span><span class="p">)</span> <span class="ow">and</span> <span class="n">advanced</span><span class="p">.</span><span class="n">parameters</span><span class="p">:</span>
            <span class="n">params_override</span> <span class="o">=</span> <span class="n">advanced</span><span class="p">.</span><span class="n">parameters</span>

        <span class="c1"># Interrupt
</span>        <span class="n">user</span> <span class="o">=</span> <span class="nc">InterruptUser</span><span class="p">()</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_running_loop</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">loop</span><span class="p">.</span><span class="nf">add_signal_handler</span><span class="p">(</span><span class="n">signal</span><span class="p">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">user</span><span class="p">.</span><span class="n">trigger_interrupt</span><span class="p">)</span>
            <span class="n">loop</span><span class="p">.</span><span class="nf">add_signal_handler</span><span class="p">(</span><span class="n">signal</span><span class="p">.</span><span class="n">SIGTERM</span><span class="p">,</span> <span class="n">user</span><span class="p">.</span><span class="n">trigger_interrupt</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">run_with_provider</span><span class="p">(</span>
                <span class="n">provider</span><span class="o">=</span><span class="n">provider</span><span class="p">,</span>
                <span class="n">system_prompt</span><span class="o">=</span><span class="n">system_prompt</span><span class="p">,</span>
                <span class="n">user_prompt</span><span class="o">=</span><span class="n">user_prompt</span><span class="p">,</span>
                <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
                <span class="n">params_override</span><span class="o">=</span><span class="n">params_override</span><span class="p">,</span>
                <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nf">return </span><span class="p">(</span><span class="n">text</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,)</span>
        <span class="k">except</span> <span class="n">UserCancelledError</span><span class="p">:</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">[OpenAIChatNode] Interrupted by user.</span><span class="sh">"</span><span class="p">,)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nf">return </span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[OpenAIChatNode] Error: </span><span class="si">{</span><span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">,)</span>

<span class="c1"># =========================
# ComfyUI registration
# =========================
</span>
<span class="n">NODE_CLASS_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">OpenAIChatNode</span><span class="sh">"</span><span class="p">:</span> <span class="n">OpenAIChatNode</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">OpenAIToolNode</span><span class="sh">"</span><span class="p">:</span> <span class="n">OpenAIToolNode</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">OpenAICustomProviderNode</span><span class="sh">"</span><span class="p">:</span> <span class="n">OpenAICustomProviderNode</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">OpenAIAdvancedOptionsNode</span><span class="sh">"</span><span class="p">:</span> <span class="n">OpenAIAdvancedOptionsNode</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">OpenAICallbackNode</span><span class="sh">"</span><span class="p">:</span> <span class="n">OpenAICallbackNode</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">NODE_DISPLAY_NAME_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">OpenAIChatNode</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">OpenAI Chat (Async)</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">OpenAIToolNode</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">OpenAI Tool Builder (Dynamic)</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">OpenAICustomProviderNode</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">OpenAI Custom Provider</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">OpenAIAdvancedOptionsNode</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">OpenAI Advanced Options</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">OpenAICallbackNode</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">OpenAI Callback Sink</span><span class="sh">"</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div>

<p>어떻게 쓰면 되나</p>

<ol>
  <li>Tool 만들기<br />
OpenAIToolNode를 여러 개 배치해서 각기 다른 툴을 만든다. 예를 들어:</li>
</ol>

<ul>
  <li>
    <p>tool_type = list_files_in_folder, base_dir = ./data, return_full_paths = True, callback 연결</p>
  </li>
  <li>
    <p>tool_type = read_text_file, base_dir = ./data, encoding = utf-8, 같은 callback 연결<br />
각 Tool 노드는 입력 tools_in으로 이전 툴 리스트를 받아 이어 붙인다.</p>
  </li>
</ul>

<ol>
  <li>
    <p>Callback 연결<br />
OpenAICallbackNode를 하나 만들고, Tool 노드의 callback 입력에 연결하면 툴 실행 때마다 emit이 호출되어 콘솔/이벤트 리스트가 갱신된다. 필요하면 이 Sink를 받아 다른 노드에서 이벤트를 확인하는 확장도 가능하다.</p>
  </li>
  <li>
    <p>AdvancedOptions</p>
  </li>
</ol>

<ul>
  <li>
    <p>tools: 위에서 만든 툴 리스트 연결</p>
  </li>
  <li>
    <p>custom_provider: 필요 시 OpenAICustomProviderNode의 출력을 연결</p>
  </li>
  <li>
    <p>system_prompt: 멀티라인</p>
  </li>
  <li>
    <p>parameters: JSON 또는 느슨한 key: value 형식으로 입력. 여기 적은 값은 그대로 **kwargs로 API 호출에 전달된다. 예:<br />
tool_choice: auto<br />
max_output_tokens: 1024<br />
temperature: 0.7<br />
top_p: 0.9<br />
stop: ["END"]</p>
  </li>
</ul>

<ol>
  <li>Chat 실행<br />
OpenAIChatNode에서 provider_name을 config.toml의 이름으로 선택하거나, AdvancedOptions에서 custom_provider를 넘겨 덮어쓴다. user_prompt를 입력하고 실행하면 된다.</li>
</ol>

<p>확장 팁</p>

<ul>
  <li>
    <p>Tool 종류 추가: OpenAIToolNode.<em>make</em> * 함수를 추가하고 INPUT_TYPES에 필요한 옵션을 늘리면 된다. 파라미터 스키마는 tool JSON에 그대로 들어가고, 실행 로직은 클로저로 캡처된다.</p>
  </li>
  <li>
    <p>UI 업데이트: 콜백 Sink의 emit에서 print 대신 소켓/파일/전역 상태 갱신 등 원하는 방식으로 확장 가능하다.</p>
  </li>
  <li>
    <p>보안: _safe_join으로 base_dir 밖 파일 접근을 차단한다. 더 강한 샌드박스가 필요하면 여기서 강화하면 된다.</p>
  </li>
</ul>

<p class="chat--user">

지금 코드는 하나의 노드에서 모두 다 하려고 하는 것 같아(툴). 나는 파일 읽는 툴 노드, 파일 쓰는 툴 노드, 파일 리스트 보는 툴 노드 다 따로 하는 걸 생각했는데, 어떤게 더 나을것 같아? 그런데 툴 노드는 하나라도 위의 3개 기능을 구현하려면 3개 툴을 넣긴 해야하는건가? 하나의 툴에서 3가지를 다 하게 할 수도 있나?

</p>

<p>한마디로 정리하면, 둘 다 가능하고 장단이 뚜렷해. 기본값으로는 “기능별(읽기/쓰기/리스트)로 나눈 원자적 툴”을 추천하고, 필요하면 “하나의 툴로 액션을 분기”하는 번들형을 보조로 두는 하이브리드가 가장 관리가 쉬워.</p>

<p>왜 원자적 툴(읽기=1, 쓰기=1, 리스트=1)을 추천하나</p>

<ol>
  <li>
    <p>모델 라우팅 정확도<br />
툴 명과 파라미터가 명확할수록 LLM이 올바른 툴을 고르는 확률이 높아져. 하나의 툴에 action 필드를 두면 모델이 잘못된 파라미터 조합을 넣거나 action을 틀리게 고를 가능성이 증가.</p>
  </li>
  <li>
    <p>스키마 단순성/검증 용이성<br />
각 툴이 자기 파라미터만 엄격히 받으니 검증이 간단하고, 에러 메시지도 명확해.</p>
  </li>
  <li>
    <p>권한/보안 제어<br />
예를 들어 프로덕션에서는 쓰기 툴만 막고 싶을 수 있어. 툴이 분리돼 있으면 선택적으로 비활성화하기 쉽다.</p>
  </li>
  <li>
    <p>병렬성/성능<br />
리스트→여러 파일 읽기 같은 플로우에서 모델이 병렬 툴 콜을 만들 수도 있어. 액션 하나짜리 거대 툴보다 병렬화가 자연스럽다.</p>
  </li>
</ol>

<p>언제 단일 멀티액션 툴이 나은가</p>

<ol>
  <li>
    <p>툴 갯수 제한이 빡빡한 모델/플랫폼을 쓰는 경우<br />
한 개 툴로 액션을 분기하면 툴 수를 줄일 수 있어.</p>
  </li>
  <li>
    <p>액션들이 강하게 결합되어 있거나 같은 전처리를 공유하는 경우<br />
예를 들어 동일한 권한·캐시·세션 핸들러를 반드시 공유해야 한다면 하나로 묶어 이점이 있다.</p>
  </li>
  <li>
    <p>그래프 단순화가 중요한 경우<br />
UI 배선이 복잡해지는 걸 피하고 싶다면 번들형이 깔끔하다.</p>
  </li>
</ol>

<p>결론 제안<br />
기본은 기능별로 3개 툴 노드(FileListToolNode, FileReadToolNode, FileWriteToolNode) + ToolsMergeNode로 합치는 구조를 쓰자. 보조로 FileManagerToolNode(단일 멀티액션)를 제공해, 툴 수 제한이 있는 프로바이더나 간단한 워크플로우에서 선택적으로 사용하도록 하자.</p>

<p>아래는 네가 이미 가진 코드베이스에 바로 추가/교체해서 쓸 수 있는 최소 구현 예시들이야. 기존 OpenAIChatNode, OpenAIAdvancedOptionsNode 등은 그대로 두고, 툴 관련 부분만 이 클래스들을 추가해서 쓰면 된다.</p>

<p>ToolsMergeNode: 여러 툴 리스트를 합치는 유틸 노드</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ToolsMergeNode</span><span class="p">:</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">optional</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">tools_a</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_TOOLS</span><span class="sh">"</span><span class="p">,),</span>
                <span class="sh">"</span><span class="s">tools_b</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_TOOLS</span><span class="sh">"</span><span class="p">,),</span>
                <span class="sh">"</span><span class="s">tools_c</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_TOOLS</span><span class="sh">"</span><span class="p">,),</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_TOOLS</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">merge</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OpenAI/Tools</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tools_a</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">tools_b</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">tools_c</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">(</span><span class="n">tools_a</span><span class="p">,</span> <span class="n">tools_b</span><span class="p">,</span> <span class="n">tools_c</span><span class="p">):</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">out</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">out</span><span class="p">,)</span>
</code></pre></div></div>

<p>원자적 툴 1: 파일 리스트</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">FileListToolNode</span><span class="p">:</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List files in a folder.</span><span class="sh">"</span><span class="p">}),</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">optional</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">tools_in</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_TOOLS</span><span class="sh">"</span><span class="p">,),</span>
                <span class="sh">"</span><span class="s">base_dir</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">return_full_paths</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">BOOLEAN</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">callback</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_CALLBACK</span><span class="sh">"</span><span class="p">,),</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_TOOLS</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">append_tool</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OpenAI/Tools</span><span class="sh">"</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_safe_join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">base_dir</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">base_dir</span><span class="p">)</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">target</span> <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">commonpath</span><span class="p">([</span><span class="n">base</span><span class="p">,</span> <span class="n">target</span><span class="p">])</span> <span class="o">==</span> <span class="n">base</span> <span class="k">else</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">append_tool</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">tools_in</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">base_dir</span><span class="o">=</span><span class="sh">""</span><span class="p">,</span> <span class="n">return_full_paths</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Folder path (relative to base_dir if set).</span><span class="sh">"</span><span class="p">},</span>
                <span class="sh">"</span><span class="s">pattern</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Optional glob, e.g. *.txt</span><span class="sh">"</span><span class="p">},</span>
                <span class="sh">"</span><span class="s">absolute</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">boolean</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Force absolute paths override.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">}</span>

        <span class="k">def</span> <span class="nf">_impl</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
            <span class="n">folder</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">))</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">pattern</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">))</span>
            <span class="n">absolute</span> <span class="o">=</span> <span class="nf">bool</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">absolute</span><span class="sh">"</span><span class="p">,</span> <span class="n">return_full_paths</span><span class="p">))</span>
            <span class="n">resolved</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_safe_join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">folder</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">resolved</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isdir</span><span class="p">(</span><span class="n">resolved</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">callback</span><span class="p">:</span> <span class="n">callback</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_error</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">reason</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">invalid_folder</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">folder</span><span class="sh">"</span><span class="p">:</span> <span class="n">folder</span><span class="p">})</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
            <span class="kn">import</span> <span class="n">glob</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">resolved</span><span class="p">,</span> <span class="n">pattern</span><span class="p">)</span> <span class="k">if</span> <span class="n">pattern</span> <span class="k">else</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">resolved</span><span class="p">,</span> <span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">.</span><span class="nf">glob</span><span class="p">(</span><span class="n">g</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">p</span><span class="p">)]</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">if</span> <span class="n">absolute</span> <span class="k">else</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">basename</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">callback</span><span class="p">:</span> <span class="n">callback</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_done</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">count</span><span class="sh">"</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">out</span><span class="p">)})</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">out</span><span class="p">)}</span>

        <span class="n">spec</span> <span class="o">=</span> <span class="nc">ToolSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">_impl</span><span class="p">)</span>
        <span class="nf">return </span><span class="p">((</span><span class="n">tools_in</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">tools_in</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[])</span> <span class="o">+</span> <span class="p">[</span><span class="n">spec</span><span class="p">],)</span>
</code></pre></div></div>

<p>원자적 툴 2: 파일 읽기</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">FileReadToolNode</span><span class="p">:</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a UTF-8 text file.</span><span class="sh">"</span><span class="p">}),</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">optional</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">tools_in</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_TOOLS</span><span class="sh">"</span><span class="p">,),</span>
                <span class="sh">"</span><span class="s">base_dir</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">encoding</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">callback</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_CALLBACK</span><span class="sh">"</span><span class="p">,),</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_TOOLS</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">append_tool</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OpenAI/Tools</span><span class="sh">"</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_safe_join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">base_dir</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">base_dir</span><span class="p">)</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">target</span> <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">commonpath</span><span class="p">([</span><span class="n">base</span><span class="p">,</span> <span class="n">target</span><span class="p">])</span> <span class="o">==</span> <span class="n">base</span> <span class="k">else</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">append_tool</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">tools_in</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">base_dir</span><span class="o">=</span><span class="sh">""</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">File path (relative to base_dir if set).</span><span class="sh">"</span><span class="p">},</span>
                <span class="sh">"</span><span class="s">encoding</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Override encoding.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">}</span>
        <span class="k">def</span> <span class="nf">_impl</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">))</span>
            <span class="n">enc</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">encoding</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="p">))</span>
            <span class="n">resolved</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_safe_join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">resolved</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">resolved</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">callback</span><span class="p">:</span> <span class="n">callback</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_error</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">reason</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">invalid_file</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="p">:</span> <span class="n">path</span><span class="p">})</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">resolved</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">enc</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">callback</span><span class="p">:</span> <span class="n">callback</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_done</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">text</span><span class="p">)})</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="n">text</span><span class="p">}</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">callback</span><span class="p">:</span> <span class="n">callback</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_error</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">reason</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_failed</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">)})</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}</span>

        <span class="n">spec</span> <span class="o">=</span> <span class="nc">ToolSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">_impl</span><span class="p">)</span>
        <span class="nf">return </span><span class="p">((</span><span class="n">tools_in</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">tools_in</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[])</span> <span class="o">+</span> <span class="p">[</span><span class="n">spec</span><span class="p">],)</span>
</code></pre></div></div>

<p>원자적 툴 3: 파일 쓰기</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">FileWriteToolNode</span><span class="p">:</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">write_text_file</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Write text to a file (creates dirs).</span><span class="sh">"</span><span class="p">}),</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">optional</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">tools_in</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_TOOLS</span><span class="sh">"</span><span class="p">,),</span>
                <span class="sh">"</span><span class="s">base_dir</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">encoding</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">append</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">BOOLEAN</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">callback</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_CALLBACK</span><span class="sh">"</span><span class="p">,),</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_TOOLS</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">append_tool</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OpenAI/Tools</span><span class="sh">"</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_safe_join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">base_dir</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">base_dir</span><span class="p">)</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">target</span> <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">commonpath</span><span class="p">([</span><span class="n">base</span><span class="p">,</span> <span class="n">target</span><span class="p">])</span> <span class="o">==</span> <span class="n">base</span> <span class="k">else</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">append_tool</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">tools_in</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">base_dir</span><span class="o">=</span><span class="sh">""</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">File path (relative to base_dir if set).</span><span class="sh">"</span><span class="p">},</span>
                <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Text content to write.</span><span class="sh">"</span><span class="p">},</span>
                <span class="sh">"</span><span class="s">encoding</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Override encoding.</span><span class="sh">"</span><span class="p">},</span>
                <span class="sh">"</span><span class="s">append</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">boolean</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Append to file instead of overwrite.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">}</span>
        <span class="k">def</span> <span class="nf">_impl</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">))</span>
            <span class="n">content</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">))</span>
            <span class="n">enc</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">encoding</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="p">))</span>
            <span class="n">do_append</span> <span class="o">=</span> <span class="nf">bool</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">append</span><span class="sh">"</span><span class="p">,</span> <span class="n">append</span><span class="p">))</span>
            <span class="n">resolved</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_safe_join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">resolved</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">callback</span><span class="p">:</span> <span class="n">callback</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_error</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">reason</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">invalid_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="p">:</span> <span class="n">path</span><span class="p">})</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">resolved</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="sh">"</span><span class="s">a</span><span class="sh">"</span> <span class="k">if</span> <span class="n">do_append</span> <span class="k">else</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span>
                <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">resolved</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">enc</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">callback</span><span class="p">:</span> <span class="n">callback</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_done</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">bytes</span><span class="sh">"</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">content</span><span class="p">)})</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">callback</span><span class="p">:</span> <span class="n">callback</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_error</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">reason</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">write_failed</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">)})</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">}</span>

        <span class="n">spec</span> <span class="o">=</span> <span class="nc">ToolSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">_impl</span><span class="p">)</span>
        <span class="nf">return </span><span class="p">((</span><span class="n">tools_in</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">tools_in</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[])</span> <span class="o">+</span> <span class="p">[</span><span class="n">spec</span><span class="p">],)</span>
</code></pre></div></div>

<p>번들형 툴: 하나의 툴로 list/read/write를 모두 처리</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">FileManagerToolNode</span><span class="p">:</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">file_manager</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List, read, or write files via action.</span><span class="sh">"</span><span class="p">}),</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">optional</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">tools_in</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_TOOLS</span><span class="sh">"</span><span class="p">,),</span>
                <span class="sh">"</span><span class="s">base_dir</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">default_encoding</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">return_full_paths</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">BOOLEAN</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">callback</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_CALLBACK</span><span class="sh">"</span><span class="p">,),</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_TOOLS</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">append_tool</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OpenAI/Tools</span><span class="sh">"</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_safe_join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">base_dir</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">base_dir</span><span class="p">)</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">target</span> <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">commonpath</span><span class="p">([</span><span class="n">base</span><span class="p">,</span> <span class="n">target</span><span class="p">])</span> <span class="o">==</span> <span class="n">base</span> <span class="k">else</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">append_tool</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">tools_in</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">base_dir</span><span class="o">=</span><span class="sh">""</span><span class="p">,</span> <span class="n">default_encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="n">return_full_paths</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="c1"># Note: oneOf를 모델들이 충실히 따르지 않는 경우가 많아, action + 선택적 필드로 설계하고 런타임에서 검증
</span>        <span class="n">schema</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">action</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">enum</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">list</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">read</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">write</span><span class="sh">"</span><span class="p">]},</span>
                <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">},</span>
                <span class="sh">"</span><span class="s">pattern</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">},</span>
                <span class="sh">"</span><span class="s">absolute</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">boolean</span><span class="sh">"</span><span class="p">},</span>
                <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">},</span>
                <span class="sh">"</span><span class="s">encoding</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">},</span>
                <span class="sh">"</span><span class="s">append</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">boolean</span><span class="sh">"</span><span class="p">},</span>
                <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">action</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">}</span>

        <span class="k">def</span> <span class="nf">_impl</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
            <span class="n">action</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">action</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="sh">"</span><span class="s">list</span><span class="sh">"</span><span class="p">:</span>
                    <span class="n">folder</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">))</span>
                    <span class="n">pattern</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">pattern</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">))</span>
                    <span class="n">absolute</span> <span class="o">=</span> <span class="nf">bool</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">absolute</span><span class="sh">"</span><span class="p">,</span> <span class="n">return_full_paths</span><span class="p">))</span>
                    <span class="n">resolved</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_safe_join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">folder</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">resolved</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isdir</span><span class="p">(</span><span class="n">resolved</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">callback</span><span class="p">:</span> <span class="n">callback</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_error</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">reason</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">invalid_folder</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">folder</span><span class="sh">"</span><span class="p">:</span> <span class="n">folder</span><span class="p">})</span>
                        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
                    <span class="kn">import</span> <span class="n">glob</span>
                    <span class="n">g</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">resolved</span><span class="p">,</span> <span class="n">pattern</span><span class="p">)</span> <span class="k">if</span> <span class="n">pattern</span> <span class="k">else</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">resolved</span><span class="p">,</span> <span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="p">)</span>
                    <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">.</span><span class="nf">glob</span><span class="p">(</span><span class="n">g</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">p</span><span class="p">)]</span>
                    <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">if</span> <span class="n">absolute</span> <span class="k">else</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">basename</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">callback</span><span class="p">:</span> <span class="n">callback</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_done</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">action</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">count</span><span class="sh">"</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">out</span><span class="p">)})</span>
                    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">out</span><span class="p">)}</span>

                <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="sh">"</span><span class="s">read</span><span class="sh">"</span><span class="p">:</span>
                    <span class="n">file_path</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">))</span>
                    <span class="n">enc</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">encoding</span><span class="sh">"</span><span class="p">,</span> <span class="n">default_encoding</span><span class="p">))</span>
                    <span class="n">resolved</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_safe_join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">file_path</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">resolved</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">resolved</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">callback</span><span class="p">:</span> <span class="n">callback</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_error</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">reason</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">invalid_file</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="p">:</span> <span class="n">file_path</span><span class="p">})</span>
                        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}</span>
                    <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">resolved</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">enc</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">text</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">callback</span><span class="p">:</span> <span class="n">callback</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_done</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">action</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">text</span><span class="p">)})</span>
                    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="n">text</span><span class="p">}</span>

                <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="sh">"</span><span class="s">write</span><span class="sh">"</span><span class="p">:</span>
                    <span class="n">file_path</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">))</span>
                    <span class="n">content</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">))</span>
                    <span class="n">enc</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">encoding</span><span class="sh">"</span><span class="p">,</span> <span class="n">default_encoding</span><span class="p">))</span>
                    <span class="n">do_append</span> <span class="o">=</span> <span class="nf">bool</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">append</span><span class="sh">"</span><span class="p">,</span> <span class="bp">False</span><span class="p">))</span>
                    <span class="n">resolved</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_safe_join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">file_path</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">resolved</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">callback</span><span class="p">:</span> <span class="n">callback</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_error</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">reason</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">invalid_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="p">:</span> <span class="n">file_path</span><span class="p">})</span>
                        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">}</span>
                    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">resolved</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                    <span class="n">mode</span> <span class="o">=</span> <span class="sh">"</span><span class="s">a</span><span class="sh">"</span> <span class="k">if</span> <span class="n">do_append</span> <span class="k">else</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span>
                    <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">resolved</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">enc</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">callback</span><span class="p">:</span> <span class="n">callback</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_done</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">action</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">write</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">bytes</span><span class="sh">"</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">content</span><span class="p">)})</span>
                    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>

                <span class="k">if</span> <span class="n">callback</span><span class="p">:</span> <span class="n">callback</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_error</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">reason</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">unknown_action</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">action</span><span class="sh">"</span><span class="p">:</span> <span class="n">action</span><span class="p">})</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span><span class="p">}</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">callback</span><span class="p">:</span> <span class="n">callback</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_error</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">reason</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">exception</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">)})</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span><span class="p">}</span>

        <span class="n">spec</span> <span class="o">=</span> <span class="nc">ToolSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">_impl</span><span class="p">)</span>
        <span class="nf">return </span><span class="p">((</span><span class="n">tools_in</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">tools_in</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[])</span> <span class="o">+</span> <span class="p">[</span><span class="n">spec</span><span class="p">],)</span>
</code></pre></div></div>

<p>추천 워크플로</p>

<ol>
  <li>
    <p>보안/정확도가 최우선이면 FileListToolNode + FileReadToolNode(+ 필요시 FileWriteToolNode)를 각각 만들고 ToolsMergeNode로 합친 뒤 AdvancedOptions.tools에 넣는다.</p>
  </li>
  <li>
    <p>툴 제한이나 배선 단순화가 중요하면 FileManagerToolNode 하나만 넣어 action 기반으로 처리한다.</p>
  </li>
  <li>
    <p>둘을 동시에 제공해, 같은 그래프에서 쉽게 교체해 비교할 수 있게 해두면 운영 중에도 유연하다.</p>
  </li>
</ol>

<p>이렇게 하면 네가 말한 “툴 노드는 각자 입력을 받아 동적 생성”도 충족하고, 필요 시 콜백을 통해 UI 업데이트도 받을 수 있어.</p>

<p class="chat--user">

어차피 리스트로 줄줄이 넣을거라서 MergeNode는 필요없을거 같고 노드들만 개별로 추가해서 전체 코드 다시 정리해줘

</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># openai_comfy_nodes.py
# Python 3.10+
# Dependencies:
#   pip install --upgrade openai httpx
#
# Nodes:
#   1) OpenAIChatNode (async)
#   2) OpenAICustomProviderNode
#   3) OpenAIAdvancedOptionsNode
#   4) OpenAICallbackNode (optional)
#   5) FileListToolNode
#   6) FileReadToolNode
#   7) FileWriteToolNode
#
# Design:
# - Async-only (AsyncOpenAI + httpx.AsyncClient).
# - Provider chosen by name from config.toml (OPENAI_PROVIDER_CONFIG or ./config.toml),
#   or overridden via AdvancedOptions.
# - Parameters are parsed permissively (JSON or loose "key: value") and forwarded verbatim as **kwargs.
# - Tools are created per Tool node (no built-ins registry). Each node builds a ToolSpec
#   with a closure that captures node inputs (e.g., base_dir, encoding) and optional callback.
# - Tool JSON shape: flat or nested (set in provider).
# - Tool calls are executed locally; responses/completions loop until no tool calls.
#
# Security notes:
# - File tools use _safe_join with an optional base_dir to avoid path traversal outside base_dir.
# - If you pass an empty base_dir, absolute paths are permitted (use with care).
</span>
<span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">re</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">signal</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Protocol</span>

<span class="c1"># TOML loader
</span><span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomllib</span>  <span class="c1"># Py3.11+
</span><span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">tomllib</span> <span class="o">=</span> <span class="bp">None</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomli</span>     <span class="c1"># Fallback
</span><span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">tomli</span> <span class="o">=</span> <span class="bp">None</span>

<span class="kn">import</span> <span class="n">httpx</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">AsyncOpenAI</span>

<span class="c1"># =========================
# Interrupt helpers
# =========================
</span>
<span class="k">class</span> <span class="nc">UserCancelledError</span><span class="p">(</span><span class="nb">Exception</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Raised when the user has interrupted the processing.</span><span class="sh">"""</span>

<span class="k">class</span> <span class="nc">InterruptUser</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Cooperative interrupt controller.</span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_event</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Event</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">trigger_interrupt</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_event</span><span class="p">.</span><span class="nf">set</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">processing_interrupted</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_event</span><span class="p">.</span><span class="nf">is_set</span><span class="p">()</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">call_with_interrupt</span><span class="p">(</span><span class="n">awaitable</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="n">InterruptUser</span><span class="p">,</span> <span class="n">poll</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Await an I/O while polling interruption; cancel if interrupted.</span><span class="sh">"""</span>
    <span class="n">task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="n">awaitable</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">({</span><span class="n">task</span><span class="p">},</span> <span class="n">timeout</span><span class="o">=</span><span class="n">poll</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">task</span><span class="p">.</span><span class="nf">result</span><span class="p">()</span>
            <span class="k">if</span> <span class="k">await</span> <span class="n">user</span><span class="p">.</span><span class="nf">processing_interrupted</span><span class="p">():</span>
                <span class="n">task</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">task</span>
                <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">raise</span> <span class="nc">UserCancelledError</span><span class="p">(</span><span class="sh">"</span><span class="s">Interrupted by user.</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">raise</span>

<span class="c1"># =========================
# Permissive parameters parsing
# =========================
</span>
<span class="k">def</span> <span class="nf">_try_json_loads</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">_parse_scalar</span><span class="p">(</span><span class="n">v</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">t</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">false</span><span class="sh">"</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">t</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="o">==</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span>
    <span class="k">if</span> <span class="n">t</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">null</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">none</span><span class="sh">"</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">re</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">^-?\d+$</span><span class="sh">"</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
            <span class="k">return</span> <span class="nf">int</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">re</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">^-?\d+\.\d+$</span><span class="sh">"</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
            <span class="k">return</span> <span class="nf">float</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="nf">if </span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">[</span><span class="sh">"</span><span class="p">)</span> <span class="ow">and</span> <span class="n">t</span><span class="p">.</span><span class="nf">endswith</span><span class="p">(</span><span class="sh">"</span><span class="s">]</span><span class="sh">"</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">{</span><span class="sh">"</span><span class="p">)</span> <span class="ow">and</span> <span class="n">t</span><span class="p">.</span><span class="nf">endswith</span><span class="p">(</span><span class="sh">"</span><span class="s">}</span><span class="sh">"</span><span class="p">)):</span>
        <span class="n">j</span> <span class="o">=</span> <span class="nf">_try_json_loads</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">j</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">j</span>
    <span class="k">if</span> <span class="sh">"</span><span class="s">,</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">t</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="p">)]</span>
        <span class="k">return</span> <span class="p">[</span><span class="nf">_parse_scalar</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">t</span>

<span class="k">def</span> <span class="nf">parse_loose_params</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">
    1) Try strict JSON.
    2) Else parse lines like </span><span class="sh">"</span><span class="s">key: value</span><span class="sh">"</span><span class="s"> or </span><span class="sh">"</span><span class="s">key = value</span><span class="sh">"</span><span class="s"> with auto-typing.
       Ignores empty lines and comment lines starting with # // ;
    </span><span class="sh">"""</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">text</span><span class="p">.</span><span class="nf">strip</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">{}</span>
    <span class="n">j</span> <span class="o">=</span> <span class="nf">_try_json_loads</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">j</span>

    <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">raw</span> <span class="ow">in</span> <span class="n">text</span><span class="p">.</span><span class="nf">splitlines</span><span class="p">():</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">raw</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">line</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">#</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">line</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">//</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">line</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">;</span><span class="sh">"</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">\s+#</span><span class="sh">"</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nf">strip</span><span class="p">()</span>  <span class="c1"># strip trailing comment after '#'
</span>        <span class="n">parts</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">\s*[:=]\s*</span><span class="sh">"</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">strip</span><span class="p">(),</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">norm_key</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">sub</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">[\s\-]+</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">_</span><span class="sh">"</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="nf">lower</span><span class="p">())</span>
        <span class="n">out</span><span class="p">[</span><span class="n">norm_key</span><span class="p">]</span> <span class="o">=</span> <span class="nf">_parse_scalar</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="c1"># =========================
# Provider config
# =========================
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ProviderProfile</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">model</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">api</span><span class="p">:</span> <span class="nb">str</span>          <span class="c1"># "responses" | "completions"
</span>    <span class="n">tool_json</span><span class="p">:</span> <span class="nb">str</span>    <span class="c1"># "flat" | "nested"
</span>    <span class="n">default_parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># forwarded as **kwargs
</span>
<span class="k">def</span> <span class="nf">_load_toml_bytes</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
    <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">load_providers_from_config</span><span class="p">(</span><span class="n">config_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ProviderProfile</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">
    [[api_provider]]
    name = </span><span class="sh">"</span><span class="s">OSS GPT (Responses + Flat)</span><span class="sh">"</span><span class="s">
    model = </span><span class="sh">"</span><span class="s">gpt-4.1-mini</span><span class="sh">"</span><span class="s">
    base_url = </span><span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="s">
    api_key_env = </span><span class="sh">"</span><span class="s">OPENAI_API_KEY</span><span class="sh">"</span><span class="s">   # or api_key = </span><span class="sh">"</span><span class="s">sk-...</span><span class="sh">"</span><span class="s">
    api = </span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="s">                # </span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="s"> | </span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="s">
    tool_json = </span><span class="sh">"</span><span class="s">flat</span><span class="sh">"</span><span class="s">               # </span><span class="sh">"</span><span class="s">flat</span><span class="sh">"</span><span class="s"> | </span><span class="sh">"</span><span class="s">nested</span><span class="sh">"</span><span class="s">
    parameters = </span><span class="sh">'''</span><span class="s">
      tool_choice: auto
      max_output_tokens: 1024
      temperature: 0.7
      top_p: 0.9
    </span><span class="sh">'''</span><span class="s">
    </span><span class="sh">"""</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">config_path</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="n">raw</span> <span class="o">=</span> <span class="nf">_load_toml_bytes</span><span class="p">(</span><span class="n">config_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">config_path</span><span class="p">.</span><span class="nf">lower</span><span class="p">().</span><span class="nf">endswith</span><span class="p">(</span><span class="sh">"</span><span class="s">.toml</span><span class="sh">"</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">tomllib</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">tomllib</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">tomli</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">tomli</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">TOML parser not available. Use Python 3.11+ or `pip install tomli`.</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">))</span>

    <span class="n">providers_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">api_provider</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">api_providers</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">providers_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ProviderProfile</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">providers_data</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">base_url</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">api_key_env</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">api_key_env</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">api</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">api</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">tool_json</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_json</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">raw_params</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">model</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">base_url</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">api</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">tool_json</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">api_key</span> <span class="ow">and</span> <span class="n">api_key_env</span><span class="p">:</span>
            <span class="n">api_key</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="n">api_key_env</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">api_key</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">raw_params</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">params_dict</span> <span class="o">=</span> <span class="nf">parse_loose_params</span><span class="p">(</span><span class="n">raw_params</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">raw_params</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">params_dict</span> <span class="o">=</span> <span class="n">raw_params</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">params_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">out</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nc">ProviderProfile</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">base_url</span><span class="o">=</span><span class="n">base_url</span><span class="p">,</span>
            <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
            <span class="n">api</span><span class="o">=</span><span class="n">api</span><span class="p">,</span>
            <span class="n">tool_json</span><span class="o">=</span><span class="n">tool_json</span><span class="p">,</span>
            <span class="n">default_parameters</span><span class="o">=</span><span class="n">params_dict</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="n">DEFAULT_CONFIG_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_PROVIDER_CONFIG</span><span class="sh">"</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="nf">getcwd</span><span class="p">(),</span> <span class="sh">"</span><span class="s">config.toml</span><span class="sh">"</span><span class="p">))</span>
<span class="n">PROVIDER_CATALOG</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ProviderProfile</span><span class="p">]</span> <span class="o">=</span> <span class="nf">load_providers_from_config</span><span class="p">(</span><span class="n">DEFAULT_CONFIG_PATH</span><span class="p">)</span>

<span class="c1"># =========================
# Tool layer (dynamic, per-node)
# =========================
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ToolSpec</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="n">func</span><span class="p">:</span> <span class="n">Any</span>  <span class="c1"># Callable[[Dict[str, Any]], Any]
</span>
<span class="k">class</span> <span class="nc">ToolJSONBuilder</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="bp">...</span>

<span class="k">class</span> <span class="nc">FlatToolJSONBuilder</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="k">return</span> <span class="p">[{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">description</span><span class="p">,</span> <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">parameters</span><span class="p">}</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">NestedToolJSONBuilder</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="k">return</span> <span class="p">[{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">description</span><span class="p">,</span> <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">parameters</span><span class="p">}}</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">select_tool_builder</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ToolJSONBuilder</span><span class="p">:</span>
    <span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="n">kind</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">).</span><span class="nf">strip</span><span class="p">().</span><span class="nf">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="sh">"</span><span class="s">flat</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="nc">FlatToolJSONBuilder</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="sh">"</span><span class="s">nested</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="nc">NestedToolJSONBuilder</span><span class="p">()</span>
    <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool_json: </span><span class="si">{</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># =========================
# Optional callback sink
# =========================
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">CallbackSink</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Lightweight event sink. You can attach a UI listener to consume .events.</span><span class="sh">"""</span>
    <span class="n">label</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OpenAI</span><span class="sh">"</span>
    <span class="n">events</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">events</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">events</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">emit</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
        <span class="n">rec</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">event</span><span class="sh">"</span><span class="p">:</span> <span class="n">event</span><span class="p">,</span> <span class="sh">"</span><span class="s">payload</span><span class="sh">"</span><span class="p">:</span> <span class="n">payload</span><span class="p">}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">events</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">label</span><span class="si">}</span><span class="s">] </span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">payload</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># =========================
# Protocol runners (async), **kwargs passthrough
# =========================
</span>
<span class="k">class</span> <span class="nc">ResponsesRunner</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Async Responses loop; tool calls executed locally.</span><span class="sh">"""</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_collect_text</span><span class="p">(</span><span class="n">resp</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
            <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]:</span>
                    <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
            <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
        <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">texts</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_collect_calls</span><span class="p">(</span><span class="n">resp</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="sh">"</span><span class="s">function_call</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                        <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                              <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                              <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{}})</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">inner</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">inner</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">inner</span><span class="p">:</span>
                        <span class="n">nm</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                        <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                                <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                                      <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">nm</span><span class="p">,</span>
                                      <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{}})</span>
        <span class="k">return</span> <span class="n">calls</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">tools</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">:</span> <span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">_exec_tool</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">spec</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">spec</span><span class="p">.</span><span class="nf">func</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">client</span><span class="p">:</span> <span class="n">AsyncOpenAI</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">tools_json</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">user</span><span class="p">:</span> <span class="n">InterruptUser</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">base</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span> <span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools_json</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_choice</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">}</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">base</span><span class="p">,</span> <span class="o">**</span><span class="p">(</span><span class="n">params</span> <span class="ow">or</span> <span class="p">{})}</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">call_with_interrupt</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">),</span> <span class="n">user</span><span class="p">)</span>

        <span class="n">chunks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">_collect_text</span><span class="p">(</span><span class="n">resp</span><span class="p">))</span>
            <span class="n">calls</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_collect_calls</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
                <span class="k">if</span> <span class="k">await</span> <span class="n">user</span><span class="p">.</span><span class="nf">processing_interrupted</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="nc">UserCancelledError</span><span class="p">(</span><span class="sh">"</span><span class="s">Interrupted by user.</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_exec_tool</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
                <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function_call_output</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">[</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)})</span>

            <span class="n">base</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span> <span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools_json</span><span class="p">}</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">base</span><span class="p">,</span> <span class="o">**</span><span class="p">(</span><span class="n">params</span> <span class="ow">or</span> <span class="p">{})}</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">call_with_interrupt</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">),</span> <span class="n">user</span><span class="p">)</span>

        <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">chunks</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

<span class="k">class</span> <span class="nc">CompletionsRunner</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Async Chat Completions loop; tool calls executed locally.</span><span class="sh">"""</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">tools</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">:</span> <span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">_exec_tool</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">spec</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">spec</span><span class="p">.</span><span class="nf">func</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">client</span><span class="p">:</span> <span class="n">AsyncOpenAI</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">tools_json</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">user</span><span class="p">:</span> <span class="n">InterruptUser</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">base</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools_json</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_choice</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">}</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">base</span><span class="p">,</span> <span class="o">**</span><span class="p">(</span><span class="n">params</span> <span class="ow">or</span> <span class="p">{})}</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">call_with_interrupt</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">),</span> <span class="n">user</span><span class="p">)</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
        <span class="n">chunks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">]</span>
        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">tool_msgs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="k">if</span> <span class="k">await</span> <span class="n">user</span><span class="p">.</span><span class="nf">processing_interrupted</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="nc">UserCancelledError</span><span class="p">(</span><span class="sh">"</span><span class="s">Interrupted by user.</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">fn</span> <span class="o">=</span> <span class="n">tc</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">tc</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_exec_tool</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>
                <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">tc</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)})</span>

            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">]})</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

            <span class="n">base</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">}</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">base</span><span class="p">,</span> <span class="o">**</span><span class="p">(</span><span class="n">params</span> <span class="ow">or</span> <span class="p">{})}</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">call_with_interrupt</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">),</span> <span class="n">user</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
            <span class="k">if</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">content</span><span class="p">)</span>

        <span class="k">return</span> <span class="sh">"</span><span class="se">\n\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">chunks</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

<span class="c1"># =========================
# Orchestrator
# =========================
</span>
<span class="k">def</span> <span class="nf">build_payload</span><span class="p">(</span><span class="n">provider</span><span class="p">:</span> <span class="n">ProviderProfile</span><span class="p">,</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">builder</span> <span class="o">=</span> <span class="nf">select_tool_builder</span><span class="p">(</span><span class="n">provider</span><span class="p">.</span><span class="n">tool_json</span><span class="p">)</span>
    <span class="n">tools_json</span> <span class="o">=</span> <span class="n">builder</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">tools_json</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools_json</span><span class="p">,</span> <span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">:</span> <span class="nf">dict</span><span class="p">(</span><span class="n">provider</span><span class="p">.</span><span class="n">default_parameters</span> <span class="ow">or</span> <span class="p">{})}</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_with_provider</span><span class="p">(</span>
    <span class="n">provider</span><span class="p">:</span> <span class="n">ProviderProfile</span><span class="p">,</span>
    <span class="n">system_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">user_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">],</span>
    <span class="n">params_override</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">user</span><span class="p">:</span> <span class="n">InterruptUser</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">system_prompt</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_prompt</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="n">built</span> <span class="o">=</span> <span class="nf">build_payload</span><span class="p">(</span><span class="n">provider</span><span class="p">,</span> <span class="n">tools</span><span class="p">)</span>
    <span class="n">tools_json</span> <span class="o">=</span> <span class="n">built</span><span class="p">[</span><span class="sh">"</span><span class="s">tools_json</span><span class="sh">"</span><span class="p">]</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">built</span><span class="p">[</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">params_override</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">params</span><span class="p">,</span> <span class="o">**</span><span class="n">params_override</span><span class="p">}</span>  <span class="c1"># right wins
</span>
    <span class="n">hooks</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">:</span> <span class="p">[],</span> <span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">httpx</span><span class="p">.</span><span class="nc">AsyncClient</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">httpx</span><span class="p">.</span><span class="nc">Timeout</span><span class="p">(</span><span class="mf">60.0</span><span class="p">),</span> <span class="n">event_hooks</span><span class="o">=</span><span class="n">hooks</span><span class="p">)</span> <span class="k">as</span> <span class="n">http_client</span><span class="p">:</span>
        <span class="k">async</span> <span class="k">with</span> <span class="nc">AsyncOpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">provider</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">provider</span><span class="p">.</span><span class="n">api_key</span><span class="p">,</span> <span class="n">http_client</span><span class="o">=</span><span class="n">http_client</span><span class="p">)</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">provider</span><span class="p">.</span><span class="n">api</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">runner</span> <span class="o">=</span> <span class="nc">ResponsesRunner</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">provider</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="n">messages</span><span class="p">,</span> <span class="n">tools_json</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">runner</span> <span class="o">=</span> <span class="nc">CompletionsRunner</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">provider</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="n">messages</span><span class="p">,</span> <span class="n">tools_json</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>

<span class="c1"># =========================
# Nodes
# =========================
</span>
<span class="c1"># -- Provider
</span>
<span class="k">class</span> <span class="nc">OpenAICustomProviderNode</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Create a provider profile directly from UI inputs; parameters forwarded verbatim as **kwargs.</span><span class="sh">"""</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">gpt-4.1-mini</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">api</span><span class="sh">"</span><span class="p">:</span> <span class="p">([</span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">],),</span>
                <span class="sh">"</span><span class="s">tool_json</span><span class="sh">"</span><span class="p">:</span> <span class="p">([</span><span class="sh">"</span><span class="s">flat</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">nested</span><span class="sh">"</span><span class="p">],),</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">optional</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool_choice: auto</span><span class="se">\n</span><span class="s">max_output_tokens: 1024</span><span class="se">\n</span><span class="s">temperature: 0.7</span><span class="se">\n</span><span class="s">top_p: 0.9</span><span class="se">\n</span><span class="sh">"</span>
                <span class="p">}),</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_PROVIDER</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">provider</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">build</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OpenAI/Provider</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tool_json</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">parameters</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span><span class="p">):</span>
        <span class="n">params_dict</span> <span class="o">=</span> <span class="nf">parse_loose_params</span><span class="p">(</span><span class="n">parameters</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">)</span>
        <span class="n">provider</span> <span class="o">=</span> <span class="nc">ProviderProfile</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="s">custom::</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">base_url</span><span class="o">=</span><span class="n">base_url</span><span class="p">,</span>
            <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
            <span class="n">api</span><span class="o">=</span><span class="n">api</span><span class="p">,</span>
            <span class="n">tool_json</span><span class="o">=</span><span class="n">tool_json</span><span class="p">,</span>
            <span class="n">default_parameters</span><span class="o">=</span><span class="n">params_dict</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">provider</span><span class="p">,)</span>

<span class="c1"># -- Callback sink
</span>
<span class="k">class</span> <span class="nc">OpenAICallbackNode</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Create a simple callback sink. Tools can emit(event, payload) to this sink.</span><span class="sh">"""</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">optional</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">label</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">OpenAI</span><span class="sh">"</span><span class="p">})}}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_CALLBACK</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">callback</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">build</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OpenAI/Utils</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">label</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OpenAI</span><span class="sh">"</span><span class="p">):</span>
        <span class="nf">return </span><span class="p">(</span><span class="nc">CallbackSink</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">),)</span>

<span class="c1"># -- File tools (each is a separate node)
</span>
<span class="k">class</span> <span class="nc">FileListToolNode</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Create a </span><span class="sh">'</span><span class="s">list files</span><span class="sh">'</span><span class="s"> tool. Chain multiple tool nodes by passing previous tools into tools_in.
    </span><span class="sh">"""</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List files in a folder.</span><span class="sh">"</span><span class="p">}),</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">optional</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">tools_in</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_TOOLS</span><span class="sh">"</span><span class="p">,),</span>
                <span class="sh">"</span><span class="s">base_dir</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">return_full_paths</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">BOOLEAN</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">callback</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_CALLBACK</span><span class="sh">"</span><span class="p">,),</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_TOOLS</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">append_tool</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OpenAI/Tools</span><span class="sh">"</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_safe_join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">base_dir</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">base_dir</span><span class="p">)</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">target</span> <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">commonpath</span><span class="p">([</span><span class="n">base</span><span class="p">,</span> <span class="n">target</span><span class="p">])</span> <span class="o">==</span> <span class="n">base</span> <span class="k">else</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">append_tool</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">tools_in</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">base_dir</span><span class="o">=</span><span class="sh">""</span><span class="p">,</span> <span class="n">return_full_paths</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Folder path (relative to base_dir if set).</span><span class="sh">"</span><span class="p">},</span>
                <span class="sh">"</span><span class="s">pattern</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Optional glob, e.g. *.txt</span><span class="sh">"</span><span class="p">},</span>
                <span class="sh">"</span><span class="s">absolute</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">boolean</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Force absolute paths override.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">}</span>

        <span class="k">def</span> <span class="nf">_impl</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
            <span class="n">folder</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">))</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">pattern</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">))</span>
            <span class="n">absolute</span> <span class="o">=</span> <span class="nf">bool</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">absolute</span><span class="sh">"</span><span class="p">,</span> <span class="n">return_full_paths</span><span class="p">))</span>
            <span class="n">resolved</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_safe_join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">folder</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">resolved</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isdir</span><span class="p">(</span><span class="n">resolved</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">callback</span><span class="p">:</span> <span class="n">callback</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_error</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">reason</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">invalid_folder</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">folder</span><span class="sh">"</span><span class="p">:</span> <span class="n">folder</span><span class="p">})</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
            <span class="kn">import</span> <span class="n">glob</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">resolved</span><span class="p">,</span> <span class="n">pattern</span><span class="p">)</span> <span class="k">if</span> <span class="n">pattern</span> <span class="k">else</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">resolved</span><span class="p">,</span> <span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">.</span><span class="nf">glob</span><span class="p">(</span><span class="n">g</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">p</span><span class="p">)]</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">if</span> <span class="n">absolute</span> <span class="k">else</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">basename</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">callback</span><span class="p">:</span> <span class="n">callback</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_done</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">count</span><span class="sh">"</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">out</span><span class="p">)})</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">out</span><span class="p">)}</span>

        <span class="n">spec</span> <span class="o">=</span> <span class="nc">ToolSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">_impl</span><span class="p">)</span>
        <span class="nf">return </span><span class="p">((</span><span class="n">tools_in</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">tools_in</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[])</span> <span class="o">+</span> <span class="p">[</span><span class="n">spec</span><span class="p">],)</span>

<span class="k">class</span> <span class="nc">FileReadToolNode</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Create a </span><span class="sh">'</span><span class="s">read text file</span><span class="sh">'</span><span class="s"> tool. Chain multiple tool nodes by passing previous tools into tools_in.
    </span><span class="sh">"""</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a UTF-8 text file.</span><span class="sh">"</span><span class="p">}),</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">optional</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">tools_in</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_TOOLS</span><span class="sh">"</span><span class="p">,),</span>
                <span class="sh">"</span><span class="s">base_dir</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">encoding</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">callback</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_CALLBACK</span><span class="sh">"</span><span class="p">,),</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_TOOLS</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">append_tool</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OpenAI/Tools</span><span class="sh">"</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_safe_join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">base_dir</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">base_dir</span><span class="p">)</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">target</span> <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">commonpath</span><span class="p">([</span><span class="n">base</span><span class="p">,</span> <span class="n">target</span><span class="p">])</span> <span class="o">==</span> <span class="n">base</span> <span class="k">else</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">append_tool</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">tools_in</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">base_dir</span><span class="o">=</span><span class="sh">""</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">File path (relative to base_dir if set).</span><span class="sh">"</span><span class="p">},</span>
                <span class="sh">"</span><span class="s">encoding</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Override encoding.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">}</span>

        <span class="k">def</span> <span class="nf">_impl</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">))</span>
            <span class="n">enc</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">encoding</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="p">))</span>
            <span class="n">resolved</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_safe_join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">resolved</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">resolved</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">callback</span><span class="p">:</span> <span class="n">callback</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_error</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">reason</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">invalid_file</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="p">:</span> <span class="n">path</span><span class="p">})</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">resolved</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">enc</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">callback</span><span class="p">:</span> <span class="n">callback</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_done</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">text</span><span class="p">)})</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="n">text</span><span class="p">}</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">callback</span><span class="p">:</span> <span class="n">callback</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_error</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">reason</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_failed</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">)})</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}</span>

        <span class="n">spec</span> <span class="o">=</span> <span class="nc">ToolSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">_impl</span><span class="p">)</span>
        <span class="nf">return </span><span class="p">((</span><span class="n">tools_in</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">tools_in</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[])</span> <span class="o">+</span> <span class="p">[</span><span class="n">spec</span><span class="p">],)</span>

<span class="k">class</span> <span class="nc">FileWriteToolNode</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Create a </span><span class="sh">'</span><span class="s">write text file</span><span class="sh">'</span><span class="s"> tool. Chain multiple tool nodes by passing previous tools into tools_in.
    </span><span class="sh">"""</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">write_text_file</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Write text to a file (creates dirs).</span><span class="sh">"</span><span class="p">}),</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">optional</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">tools_in</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_TOOLS</span><span class="sh">"</span><span class="p">,),</span>
                <span class="sh">"</span><span class="s">base_dir</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">encoding</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">append</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">BOOLEAN</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">callback</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_CALLBACK</span><span class="sh">"</span><span class="p">,),</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_TOOLS</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">append_tool</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OpenAI/Tools</span><span class="sh">"</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_safe_join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">base_dir</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">base_dir</span><span class="p">)</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">target</span> <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">commonpath</span><span class="p">([</span><span class="n">base</span><span class="p">,</span> <span class="n">target</span><span class="p">])</span> <span class="o">==</span> <span class="n">base</span> <span class="k">else</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">append_tool</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">tools_in</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">base_dir</span><span class="o">=</span><span class="sh">""</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">File path (relative to base_dir if set).</span><span class="sh">"</span><span class="p">},</span>
                <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Text content to write.</span><span class="sh">"</span><span class="p">},</span>
                <span class="sh">"</span><span class="s">encoding</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Override encoding.</span><span class="sh">"</span><span class="p">},</span>
                <span class="sh">"</span><span class="s">append</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">boolean</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Append to file instead of overwrite.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">}</span>

        <span class="k">def</span> <span class="nf">_impl</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">))</span>
            <span class="n">content</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">))</span>
            <span class="n">enc</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">encoding</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="p">))</span>
            <span class="n">do_append</span> <span class="o">=</span> <span class="nf">bool</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">append</span><span class="sh">"</span><span class="p">,</span> <span class="n">append</span><span class="p">))</span>
            <span class="n">resolved</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_safe_join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">resolved</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">callback</span><span class="p">:</span> <span class="n">callback</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_error</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">reason</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">invalid_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="p">:</span> <span class="n">path</span><span class="p">})</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">resolved</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="sh">"</span><span class="s">a</span><span class="sh">"</span> <span class="k">if</span> <span class="n">do_append</span> <span class="k">else</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span>
                <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">resolved</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">enc</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">callback</span><span class="p">:</span> <span class="n">callback</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_done</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">bytes</span><span class="sh">"</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">content</span><span class="p">)})</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">callback</span><span class="p">:</span> <span class="n">callback</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_error</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">reason</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">write_failed</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">)})</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">}</span>

        <span class="n">spec</span> <span class="o">=</span> <span class="nc">ToolSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">_impl</span><span class="p">)</span>
        <span class="nf">return </span><span class="p">((</span><span class="n">tools_in</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">tools_in</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[])</span> <span class="o">+</span> <span class="p">[</span><span class="n">spec</span><span class="p">],)</span>

<span class="c1"># -- Advanced options aggregator
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">AdvancedOptions</span><span class="p">:</span>
    <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]</span>
    <span class="n">custom_provider</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ProviderProfile</span><span class="p">]</span>
    <span class="n">system_prompt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># forwarded as **kwargs
</span>
<span class="k">class</span> <span class="nc">OpenAIAdvancedOptionsNode</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Aggregate tools, custom provider, system prompt, and parameters (verbatim **kwargs).</span><span class="sh">"""</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">optional</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_TOOLS</span><span class="sh">"</span><span class="p">,),</span>
                <span class="sh">"</span><span class="s">custom_provider</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_PROVIDER</span><span class="sh">"</span><span class="p">,),</span>
                <span class="sh">"</span><span class="s">system_prompt</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool_choice: auto</span><span class="se">\n</span><span class="s"># e.g., max_tokens / max_output_tokens / top_p / temperature / stop</span><span class="se">\n</span><span class="sh">"</span>
                <span class="p">}),</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_ADVANCED</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">advanced</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">build</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OpenAI/Options</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">custom_provider</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">system_prompt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span><span class="p">,</span> <span class="n">parameters</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span><span class="p">):</span>
        <span class="n">tlist</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]</span> <span class="o">=</span> <span class="n">tools</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">tools</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="n">provider</span> <span class="o">=</span> <span class="n">custom_provider</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">custom_provider</span><span class="p">,</span> <span class="n">ProviderProfile</span><span class="p">)</span> <span class="k">else</span> <span class="bp">None</span>
        <span class="n">sys_prompt</span> <span class="o">=</span> <span class="n">system_prompt</span> <span class="nf">if </span><span class="p">(</span><span class="n">system_prompt</span> <span class="ow">and</span> <span class="n">system_prompt</span><span class="p">.</span><span class="nf">strip</span><span class="p">())</span> <span class="k">else</span> <span class="bp">None</span>
        <span class="n">params_dict</span> <span class="o">=</span> <span class="nf">parse_loose_params</span><span class="p">(</span><span class="n">parameters</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">)</span>
        <span class="nf">return </span><span class="p">(</span><span class="nc">AdvancedOptions</span><span class="p">(</span><span class="n">tlist</span><span class="p">,</span> <span class="n">provider</span><span class="p">,</span> <span class="n">sys_prompt</span><span class="p">,</span> <span class="n">params_dict</span><span class="p">),)</span>

<span class="c1"># -- Chat
</span>
<span class="k">class</span> <span class="nc">OpenAIChatNode</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Async chat node:
      - Provider chosen by name from config.toml (auto-refreshed), overrideable via AdvancedOptions.custom_provider
      - Parameters: provider.default_parameters merged with AdvancedOptions.parameters (right wins)
      - Executes tool-calling loop and returns final text
    </span><span class="sh">"""</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_provider_names</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">global</span> <span class="n">PROVIDER_CATALOG</span>
        <span class="n">PROVIDER_CATALOG</span> <span class="o">=</span> <span class="nf">load_providers_from_config</span><span class="p">(</span><span class="n">DEFAULT_CONFIG_PATH</span><span class="p">)</span>
        <span class="k">return</span> <span class="nf">list</span><span class="p">(</span><span class="n">PROVIDER_CATALOG</span><span class="p">.</span><span class="nf">keys</span><span class="p">())</span> <span class="ow">or</span> <span class="p">[</span><span class="sh">"</span><span class="s">&lt;no providers in config&gt;</span><span class="sh">"</span><span class="p">]</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="n">provider_list</span> <span class="o">=</span> <span class="n">cls</span><span class="p">.</span><span class="nf">_provider_names</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">user_prompt</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List files under ./samples, choose one text file, read it, and summarize in 2-3 sentences.</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">provider_name</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="n">provider_list</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="n">provider_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]}),</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">optional</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">advanced</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_ADVANCED</span><span class="sh">"</span><span class="p">,),</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">response_text</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">run</span><span class="sh">"</span>
    <span class="n">OUTPUT_NODE</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OpenAI/Chat</span><span class="sh">"</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">user_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">provider_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">advanced</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="c1"># Resolve provider
</span>        <span class="k">global</span> <span class="n">PROVIDER_CATALOG</span>
        <span class="n">provider</span> <span class="o">=</span> <span class="n">PROVIDER_CATALOG</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">provider_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">advanced</span> <span class="ow">and</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">advanced</span><span class="p">,</span> <span class="n">AdvancedOptions</span><span class="p">)</span> <span class="ow">and</span> <span class="n">advanced</span><span class="p">.</span><span class="n">custom_provider</span><span class="p">:</span>
            <span class="n">provider</span> <span class="o">=</span> <span class="n">advanced</span><span class="p">.</span><span class="n">custom_provider</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">provider</span><span class="p">:</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">[OpenAIChatNode] Error: provider not found. Check config.toml or AdvancedOptions.</span><span class="sh">"</span><span class="p">,)</span>

        <span class="c1"># System prompt
</span>        <span class="n">system_prompt</span> <span class="o">=</span> <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed.</span><span class="sh">"</span>
        <span class="k">if</span> <span class="n">advanced</span> <span class="ow">and</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">advanced</span><span class="p">,</span> <span class="n">AdvancedOptions</span><span class="p">)</span> <span class="ow">and</span> <span class="n">advanced</span><span class="p">.</span><span class="n">system_prompt</span><span class="p">:</span>
            <span class="n">system_prompt</span> <span class="o">=</span> <span class="n">advanced</span><span class="p">.</span><span class="n">system_prompt</span>

        <span class="c1"># Tools
</span>        <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">advanced</span> <span class="ow">and</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">advanced</span><span class="p">,</span> <span class="n">AdvancedOptions</span><span class="p">)</span> <span class="ow">and</span> <span class="n">advanced</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
            <span class="n">tools</span> <span class="o">=</span> <span class="n">advanced</span><span class="p">.</span><span class="n">tools</span>

        <span class="c1"># Merge parameters: provider defaults overridden by advanced
</span>        <span class="n">params_override</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">advanced</span> <span class="ow">and</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">advanced</span><span class="p">,</span> <span class="n">AdvancedOptions</span><span class="p">)</span> <span class="ow">and</span> <span class="n">advanced</span><span class="p">.</span><span class="n">parameters</span><span class="p">:</span>
            <span class="n">params_override</span> <span class="o">=</span> <span class="n">advanced</span><span class="p">.</span><span class="n">parameters</span>

        <span class="c1"># Interrupt
</span>        <span class="n">user</span> <span class="o">=</span> <span class="nc">InterruptUser</span><span class="p">()</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_running_loop</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">loop</span><span class="p">.</span><span class="nf">add_signal_handler</span><span class="p">(</span><span class="n">signal</span><span class="p">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">user</span><span class="p">.</span><span class="n">trigger_interrupt</span><span class="p">)</span>
            <span class="n">loop</span><span class="p">.</span><span class="nf">add_signal_handler</span><span class="p">(</span><span class="n">signal</span><span class="p">.</span><span class="n">SIGTERM</span><span class="p">,</span> <span class="n">user</span><span class="p">.</span><span class="n">trigger_interrupt</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">run_with_provider</span><span class="p">(</span>
                <span class="n">provider</span><span class="o">=</span><span class="n">provider</span><span class="p">,</span>
                <span class="n">system_prompt</span><span class="o">=</span><span class="n">system_prompt</span><span class="p">,</span>
                <span class="n">user_prompt</span><span class="o">=</span><span class="n">user_prompt</span><span class="p">,</span>
                <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
                <span class="n">params_override</span><span class="o">=</span><span class="n">params_override</span><span class="p">,</span>
                <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nf">return </span><span class="p">(</span><span class="n">text</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,)</span>
        <span class="k">except</span> <span class="n">UserCancelledError</span><span class="p">:</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">[OpenAIChatNode] Interrupted by user.</span><span class="sh">"</span><span class="p">,)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nf">return </span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[OpenAIChatNode] Error: </span><span class="si">{</span><span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">,)</span>

<span class="c1"># =========================
# ComfyUI registration
# =========================
</span>
<span class="n">NODE_CLASS_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">OpenAIChatNode</span><span class="sh">"</span><span class="p">:</span> <span class="n">OpenAIChatNode</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">OpenAICustomProviderNode</span><span class="sh">"</span><span class="p">:</span> <span class="n">OpenAICustomProviderNode</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">OpenAIAdvancedOptionsNode</span><span class="sh">"</span><span class="p">:</span> <span class="n">OpenAIAdvancedOptionsNode</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">OpenAICallbackNode</span><span class="sh">"</span><span class="p">:</span> <span class="n">OpenAICallbackNode</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">FileListToolNode</span><span class="sh">"</span><span class="p">:</span> <span class="n">FileListToolNode</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">FileReadToolNode</span><span class="sh">"</span><span class="p">:</span> <span class="n">FileReadToolNode</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">FileWriteToolNode</span><span class="sh">"</span><span class="p">:</span> <span class="n">FileWriteToolNode</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">NODE_DISPLAY_NAME_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">OpenAIChatNode</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">OpenAI Chat (Async)</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">OpenAICustomProviderNode</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">OpenAI Custom Provider</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">OpenAIAdvancedOptionsNode</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">OpenAI Advanced Options</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">OpenAICallbackNode</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">OpenAI Callback Sink</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">FileListToolNode</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Tool: List Files</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">FileReadToolNode</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Tool: Read Text File</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">FileWriteToolNode</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Tool: Write Text File</span><span class="sh">"</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div>

<p class="chat--user">

근데 processing_interrupted()라고 인터럽트 여부 확인하는 함수가 이미 있어. 근데 이건 async 함수는 아니야. 그럴 경우 그냥 is_set 부분 대신 processing_interrupted() 를 넣어서 리턴해버려도 되나

</p>

<p>짧은 답: 네. 그 함수가 동기(synchronous)로 즉시 bool을 돌려주는 형태라면, 이벤트 루프를 막지 않으므로 그대로 호출해서 판정해도 됩니다. 핵심은 “절대 블로킹하지 않는 빠른 함수”여야 한다는 점뿐이에요.</p>

<p>실전 적용 방법은 두 가지가 있습니다.</p>

<ol>
  <li>인터럽트 체커를 인자로 주입하는 방식(추천)</li>
</ol>

<ul>
  <li>call_with_interrupt와 러너 루프가 공통으로 쓸 수 있는 동기 체크 함수를 받도록 바꿉니다.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 1) interrupt checker signature: Callable[[], bool]
</span><span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Callable</span>

<span class="k">class</span> <span class="nc">UserCancelledError</span><span class="p">(</span><span class="nb">Exception</span><span class="p">):</span> <span class="bp">...</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">call_with_interrupt</span><span class="p">(</span><span class="n">awaitable</span><span class="p">,</span> <span class="n">is_interrupted</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="nb">bool</span><span class="p">],</span> <span class="n">poll</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">):</span>
    <span class="n">task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="n">awaitable</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">({</span><span class="n">task</span><span class="p">},</span> <span class="n">timeout</span><span class="o">=</span><span class="n">poll</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">task</span><span class="p">.</span><span class="nf">result</span><span class="p">()</span>
            <span class="k">if</span> <span class="nf">is_interrupted</span><span class="p">():</span>                 <span class="c1"># sync check
</span>                <span class="n">task</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">task</span>
                <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">raise</span> <span class="nc">UserCancelledError</span><span class="p">(</span><span class="sh">"</span><span class="s">Interrupted by user.</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">raise</span>
</code></pre></div></div>

<p>사용 예시:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 어디선가 제공되는 동기 함수라고 가정
# def processing_interrupted() -&gt; bool: ...
</span>
<span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">call_with_interrupt</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">),</span> <span class="n">is_interrupted</span><span class="o">=</span><span class="n">processing_interrupted</span><span class="p">)</span>

<span class="c1"># 루프 내부도 동일하게
</span><span class="k">if</span> <span class="nf">is_interrupted</span><span class="p">():</span>
    <span class="k">raise</span> <span class="nc">UserCancelledError</span><span class="p">(...)</span>
</code></pre></div></div>

<p>러너 클래스 내부 수정 포인트:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ResponsesRunner</span><span class="p">:</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(...,</span> <span class="n">is_interrupted</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="nb">bool</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">call_with_interrupt</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">),</span> <span class="n">is_interrupted</span><span class="p">)</span>
        <span class="bp">...</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
            <span class="k">if</span> <span class="nf">is_interrupted</span><span class="p">():</span>                 <span class="c1"># 동기 호출
</span>                <span class="k">raise</span> <span class="nc">UserCancelledError</span><span class="p">(...)</span>
            <span class="bp">...</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">call_with_interrupt</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">),</span> <span class="n">is_interrupted</span><span class="p">)</span>
</code></pre></div></div>

<p>CompletionsRunner도 동일하게 <code class="language-plaintext highlighter-rouge">if is_interrupted(): ...</code>로 바꾸면 됩니다.</p>

<ol>
  <li>기존 구조 유지하면서 얇은 래퍼로 통일하기</li>
</ol>

<ul>
  <li>이미 <code class="language-plaintext highlighter-rouge">await user.processing_interrupted()</code> 형태로 호출하는 코드가 곳곳에 있다면, 동기 함수를 감싸는 작은 어댑터를 만들어 비동기처럼 보이게 만들 수도 있습니다.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">inspect</span>

<span class="k">def</span> <span class="nf">make_async_checker</span><span class="p">(</span><span class="n">sync_fn</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">_check</span><span class="p">():</span>
        <span class="k">return</span> <span class="nf">bool</span><span class="p">(</span><span class="nf">sync_fn</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">_check</span>

<span class="c1"># 주입 시
</span><span class="n">async_is_interrupted</span> <span class="o">=</span> <span class="nf">make_async_checker</span><span class="p">(</span><span class="n">processing_interrupted</span><span class="p">)</span>

<span class="c1"># 기존 코드 유지 가능:
</span><span class="k">if</span> <span class="k">await</span> <span class="nf">async_is_interrupted</span><span class="p">():</span>
    <span class="bp">...</span>
<span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">call_with_interrupt</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">),</span> <span class="n">user</span><span class="o">=</span><span class="nc">SomeUser</span><span class="p">(</span><span class="n">async_is_interrupted</span><span class="p">))</span>
</code></pre></div></div>

<p>하지만 첫 번째 방법처럼 “동기 체크 함수를 그대로 받는” 형태가 더 단순하고, 오타 없이 일관되게 쓰기 쉬워서 권장합니다.</p>

<p>주의사항</p>

<ul>
  <li>
    <p>processing_interrupted()는 반드시 논블로킹이어야 합니다. 파일 I/O나 락 대기 같은 동작이 들어가면 이벤트 루프가 멈춥니다.</p>
  </li>
  <li>
    <p>다른 스레드에서 인터럽트를 건다면, 내부 상태는 스레드 세이프하게 관리하세요. 가장 쉬운 구현은 <code class="language-plaintext highlighter-rouge">threading.Event</code>를 쓰고 <code class="language-plaintext highlighter-rouge">.is_set()</code>를 반환하는 래퍼를 두는 것입니다.</p>
  </li>
  <li>
    <p>체크 주기(poll 간격)는 200ms 정도가 적당하지만, 더 민감하게 끊고 싶으면 <code class="language-plaintext highlighter-rouge">poll=0.05</code> 등으로 조절하면 됩니다.</p>
  </li>
</ul>

<p>정리하면, 네. <code class="language-plaintext highlighter-rouge">is_set()</code> 대신 <code class="language-plaintext highlighter-rouge">processing_interrupted()</code>를 그대로 호출해도 되고, 그 방향이 오히려 깔끔합니다. 위의 패턴대로 <code class="language-plaintext highlighter-rouge">call_with_interrupt</code>와 루프 내부의 인터럽트 체크를 동기 호출로 바꿔주면 됩니다.</p>

<p class="chat--user">

모델별로 기본 system 프롬프트를 넣어두는게 더 성능이 좋을까? 

</p>

<p>짧은 결론부터 말하면, “모델별 기본 system 프롬프트”를 가볍게라도 넣어두면 일관성과 도구 호출 정확도가 꽤 올라가는 경우가 많습니다. 다만 무겁고 장황한 프롬프트는 역효과가 날 수 있어요. 그래서 모델 특성에 맞춘 짧은 기본 프롬프트를 두고, 작업마다 필요할 때만 덧붙이는 방식을 권합니다.</p>

<p>왜 도움이 되나</p>

<ol>
  <li>
    <p>도구 호출 안정화: 툴을 언제 써야 하는지, 파라미터를 어떻게 채워야 하는지 명시하면 잘못된 함수 호출이 줄어듭니다.</p>
  </li>
  <li>
    <p>톤·형식 일관성: 응답 길이, 언어, 형식(예: 코드 우선, 간결 요약 등)을 통제해 재시도를 덜 합니다.</p>
  </li>
  <li>
    <p>모델 편차 흡수: 같은 요청이라도 모델마다 안전·형식 기본값이 다른데, 기본 규칙을 박아두면 편차가 줄어요.</p>
  </li>
</ol>

<p>언제 해가 되나</p>

<ol>
  <li>
    <p>너무 길고 일반적인 프롬프트: 토큰 낭비 + 모델이 핵심 규칙을 놓칩니다.</p>
  </li>
  <li>
    <p>작업별 요구와 충돌: 기본 프롬프트가 “간결 요약”인데 사용자가 “장문 설명”을 원하면 품질이 떨어집니다.</p>
  </li>
  <li>
    <p>벤더의 내부 프롬프트와 충돌: 지나치게 규제하면 모델이 과도하게 방어적이 되기도 합니다.</p>
  </li>
</ol>

<p>실전 가이드라인</p>

<ol>
  <li>
    <p>길이는 짧게: 3~6문장 수준으로 핵심 규칙만.</p>
  </li>
  <li>
    <p>툴 사용 규칙을 분명히: “파일 읽기/쓰기/리스트 도구를 우선 사용, 추측 금지, 파라미터는 스키마대로”.</p>
  </li>
  <li>
    <p>출력 규칙을 분명히: “한국어로 간결히”, “중간 사고과정 노출 금지”, “필요 시 단계적 요약”.</p>
  </li>
  <li>
    <p>모델별 미세 튜닝:</p>

    <ul>
      <li>
        <p>Responses 계열: “툴 호출 후 추가 질의가 필요하면 후속 호출 제안” 같이 대화 루프를 의식.</p>
      </li>
      <li>
        <p>Chat Completions 계열: 메시지·tool_calls 포맷을 더 엄격히 지시.</p>
      </li>
    </ul>
  </li>
  <li>
    <p>태스크별 오버레이: 기본 프롬프트는 최소 규칙, 작업별 요구는 AdvancedOptions.system_prompt로 덧붙이기.</p>
  </li>
</ol>

<p>추천 템플릿 예시(가볍게)</p>

<ul>
  <li>
    <p>공통 최소 템플릿</p>

    <ol>
      <li>
        <p>사용 가능한 도구: list_files_in_folder, read_text_file, write_text_file.</p>
      </li>
      <li>
        <p>추측 금지: 파일 내용이 필요하면 반드시 read_text_file을 호출.</p>
      </li>
      <li>
        <p>보안: base_dir 밖 경로는 요청하지 않음.</p>
      </li>
      <li>
        <p>출력: 한국어, 간결, 불필요한 사족 금지, 사고과정 노출 금지.</p>
      </li>
    </ol>
  </li>
  <li>
    <p>Responses 모델용 기본 템플릿 샘플<br />
“너는 파일 도구를 적시에 호출하는 조력자다. 파일 내용을 추측하지 말고, 필요하면 list→read→요약 순으로 툴을 호출해라. base_dir 밖 경로는 사용하지 않는다. 답변은 한국어로 간결하게 작성한다. 중간 사고과정은 노출하지 말고 최종 답만 제공한다.”</p>
  </li>
  <li>
    <p>Chat Completions 모델용 기본 템플릿 샘플<br />
“너는 함수 호출 중심으로 작업한다. 도구의 매개변수는 스키마에 맞게 채워라. 파일 내용이 필요하면 반드시 read_text_file을 호출한 뒤 그 결과로만 답해라. base_dir 밖 경로는 사용하지 않는다. 한국어로 간결히 답하고, 불필요한 설명은 생략한다.”</p>
  </li>
</ul>

<p>구조에 넣는 방법(지금 네 노드 설계 기준)</p>

<ol>
  <li>
    <p>config.toml에 provider별 기본 system_prompt_default를 추가해 두고, OpenAIChatNode에서 우선순위를 정합니다.<br />
우선순위 권장: AdvancedOptions.system_prompt &gt; Chat 노드 입력 &gt; Provider.system_prompt_default &gt; 아주 짧은 내장 디폴트.</p>
  </li>
  <li>
    <p>모델별로 다른 기본 프롬프트를 설정해 두세요. 예: Qwen(Completions)은 도구 파라미터 엄격, GPT-OSS(Responses)는 대화 루프와 후속 호출 안내를 더 명시.</p>
  </li>
</ol>

<p>config.toml 예시</p>
<div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[[api_provider]</span><span class="err">]</span>
<span class="py">name</span> <span class="p">=</span> <span class="s">"OSS GPT (Responses + Flat)"</span>
<span class="py">model</span> <span class="p">=</span> <span class="s">"gpt-4.1-mini"</span>
<span class="py">base_url</span> <span class="p">=</span> <span class="s">"https://api.openai.com/v1"</span>
<span class="py">api_key_env</span> <span class="p">=</span> <span class="s">"OPENAI_API_KEY"</span>
<span class="py">api</span> <span class="p">=</span> <span class="s">"responses"</span>
<span class="py">tool_json</span> <span class="p">=</span> <span class="s">"flat"</span>
<span class="py">system_prompt_default</span> <span class="p">=</span> <span class="s">"""
도구를 적시에 호출하고, 파일 내용을 추측하지 않는다.
base_dir 밖 경로는 사용하지 않는다.
한국어로 간결히, 사고과정은 노출하지 않는다.
"""</span>

<span class="nn">[[api_provider]</span><span class="err">]</span>
<span class="py">name</span> <span class="p">=</span> <span class="s">"Qwen (Completions + Nested)"</span>
<span class="py">model</span> <span class="p">=</span> <span class="s">"qwen-plus"</span>
<span class="py">base_url</span> <span class="p">=</span> <span class="s">"https://api.somevendor.com/v1"</span>
<span class="py">api_key_env</span> <span class="p">=</span> <span class="s">"QWEN_API_KEY"</span>
<span class="py">api</span> <span class="p">=</span> <span class="s">"completions"</span>
<span class="py">tool_json</span> <span class="p">=</span> <span class="s">"nested"</span>
<span class="py">system_prompt_default</span> <span class="p">=</span> <span class="s">"""
함수 호출 중심으로 작업한다. 파라미터는 스키마에 정확히 맞춘다.
파일 내용이 필요하면 반드시 read_text_file을 호출한다.
한국어로 간결히, 사고과정은 노출하지 않는다.
"""</span>
</code></pre></div></div>

<p>A/B 체크 포인트</p>

<ol>
  <li>
    <p>툴 호출 정확도: 잘못된 함수명·누락 파라미터 비율</p>
  </li>
  <li>
    <p>재시도율/라운드 수: 후속 호출 횟수</p>
  </li>
  <li>
    <p>토큰 사용량과 지연시간: 기본 프롬프트 길이에 민감</p>
  </li>
  <li>
    <p>사람 선호도: 작업별 짧은 평가 폼으로 수집</p>
  </li>
</ol>

<p>최종 권장</p>

<ul>
  <li>
    <p>네. 모델별 기본 system 프롬프트를 “짧고 규칙 위주”로 두는 게 보통 더 좋습니다.</p>
  </li>
  <li>
    <p>길게 쓰지 말고, 툴 사용 정책·보안·출력 형식만 고정하세요.</p>
  </li>
  <li>
    <p>작업 특화 요구는 AdvancedOptions.system_prompt로 얹는 2단 구성으로 운용하면, 모델 교체·추가가 생겨도 유지 관리가 쉽습니다.</p>
  </li>
</ul>

<p class="chat--user">

너무 지금 툴 세팅에 편향된 내용 같은데, 실제론 수많은 툴이 사용될 수 있어 그때그때

</p>

<p>좋은 포인트야. “툴이 몇 개 정해져 있다”는 가정에서 벗어나서, 툴이 수십·수백 개로 늘어나고 매 호출마다 달라지는 상황을 견디는 구조로 바꿨어. 핵심은 두 가지야.</p>

<ol>
  <li>모델/작업에 의존하지 않는 툴-불가지론 설계</li>
</ol>

<ul>
  <li>
    <p>툴은 노드별로 동적으로 생성. 파일 툴뿐 아니라 임의의 파이썬 함수도 툴로 래핑(PythonCallableToolNode).</p>
  </li>
  <li>
    <p>ToolSpec에 메타데이터(category, tags)를 추가해 대규모 툴을 분류·선별 가능.</p>
  </li>
</ul>

<ol>
  <li>런타임 자동 최적화(프롬프트/툴 단):</li>
</ol>

<ul>
  <li>
    <p>툴이 너무 많을 때 모델에 모두 던지지 않고, user_prompt 기반 휴리스틱으로 관련 툴만 선별(tool_filter).</p>
  </li>
  <li>
    <p>시스템 프롬프트에 툴 전체를 붙이지 않고, “자동 툴 브리핑(auto_tool_brief)”로 상위 몇 개만 짧게 요약해 첨부.</p>
  </li>
  <li>
    <p>이 두 기능은 AdvancedOptions에서 온/오프로 제어.</p>
  </li>
</ul>

<p>아래는 전체 코드(기존 노드 + 일반화 + 자동 브리핑/선별 + 임의 파이썬 툴 래퍼 포함). 그대로 교체해서 쓸 수 있어.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># openai_comfy_nodes.py
# Python 3.10+
# Dependencies:
#   pip install --upgrade openai httpx
#
# Nodes:
#   1) OpenAIChatNode (async)
#   2) OpenAICustomProviderNode
#   3) OpenAIAdvancedOptionsNode
#   4) OpenAICallbackNode (optional)
#   5) FileListToolNode
#   6) FileReadToolNode
#   7) FileWriteToolNode
#   8) PythonCallableToolNode  &lt;- generic: wrap any module:function as a tool
#
# What changed (tool-agnostic &amp; scalable):
# - ToolSpec now has metadata (category, tags).
# - Heuristic tool filtering: choose K most relevant tools to the prompt.
# - Auto tool briefing: short, model-friendly summary of selected tools is appended
#   to the system prompt to stabilize tool use without bloating the prompt.
# - Parameters from config/advanced are forwarded verbatim as **kwargs (no adapters).
# - Optional callback sink receives tool lifecycle events.
</span>
<span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">re</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">signal</span>
<span class="kn">import</span> <span class="n">importlib</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Protocol</span><span class="p">,</span> <span class="n">Callable</span>

<span class="c1"># TOML loader
</span><span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomllib</span>  <span class="c1"># Py3.11+
</span><span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">tomllib</span> <span class="o">=</span> <span class="bp">None</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomli</span>     <span class="c1"># Fallback
</span><span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">tomli</span> <span class="o">=</span> <span class="bp">None</span>

<span class="kn">import</span> <span class="n">httpx</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">AsyncOpenAI</span>

<span class="c1"># =========================
# Interrupt helpers
# =========================
</span>
<span class="k">class</span> <span class="nc">UserCancelledError</span><span class="p">(</span><span class="nb">Exception</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Raised when the user has interrupted the processing.</span><span class="sh">"""</span>

<span class="k">class</span> <span class="nc">InterruptUser</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Cooperative interrupt controller.</span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_event</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Event</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">trigger_interrupt</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_event</span><span class="p">.</span><span class="nf">set</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">processing_interrupted</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_event</span><span class="p">.</span><span class="nf">is_set</span><span class="p">()</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">call_with_interrupt</span><span class="p">(</span><span class="n">awaitable</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="n">InterruptUser</span><span class="p">,</span> <span class="n">poll</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Await an I/O while polling interruption; cancel if interrupted.</span><span class="sh">"""</span>
    <span class="n">task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="n">awaitable</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">({</span><span class="n">task</span><span class="p">},</span> <span class="n">timeout</span><span class="o">=</span><span class="n">poll</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">task</span><span class="p">.</span><span class="nf">result</span><span class="p">()</span>
            <span class="k">if</span> <span class="k">await</span> <span class="n">user</span><span class="p">.</span><span class="nf">processing_interrupted</span><span class="p">():</span>
                <span class="n">task</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">task</span>
                <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">raise</span> <span class="nc">UserCancelledError</span><span class="p">(</span><span class="sh">"</span><span class="s">Interrupted by user.</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">raise</span>

<span class="c1"># =========================
# Permissive parameters parsing
# =========================
</span>
<span class="k">def</span> <span class="nf">_try_json_loads</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">_parse_scalar</span><span class="p">(</span><span class="n">v</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">t</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">false</span><span class="sh">"</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">t</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="o">==</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span>
    <span class="k">if</span> <span class="n">t</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">null</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">none</span><span class="sh">"</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">re</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">^-?\d+$</span><span class="sh">"</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
            <span class="k">return</span> <span class="nf">int</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">re</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">^-?\d+\.\d+$</span><span class="sh">"</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
            <span class="k">return</span> <span class="nf">float</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="nf">if </span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">[</span><span class="sh">"</span><span class="p">)</span> <span class="ow">and</span> <span class="n">t</span><span class="p">.</span><span class="nf">endswith</span><span class="p">(</span><span class="sh">"</span><span class="s">]</span><span class="sh">"</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">{</span><span class="sh">"</span><span class="p">)</span> <span class="ow">and</span> <span class="n">t</span><span class="p">.</span><span class="nf">endswith</span><span class="p">(</span><span class="sh">"</span><span class="s">}</span><span class="sh">"</span><span class="p">)):</span>
        <span class="n">j</span> <span class="o">=</span> <span class="nf">_try_json_loads</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">j</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">j</span>
    <span class="k">if</span> <span class="sh">"</span><span class="s">,</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">t</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="p">)]</span>
        <span class="k">return</span> <span class="p">[</span><span class="nf">_parse_scalar</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">t</span>

<span class="k">def</span> <span class="nf">parse_loose_params</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">
    1) Try strict JSON.
    2) Else parse lines like </span><span class="sh">"</span><span class="s">key: value</span><span class="sh">"</span><span class="s"> or </span><span class="sh">"</span><span class="s">key = value</span><span class="sh">"</span><span class="s"> with auto-typing.
       Ignores empty lines and comment lines starting with # // ;
    </span><span class="sh">"""</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">text</span><span class="p">.</span><span class="nf">strip</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">{}</span>
    <span class="n">j</span> <span class="o">=</span> <span class="nf">_try_json_loads</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">j</span>

    <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">raw</span> <span class="ow">in</span> <span class="n">text</span><span class="p">.</span><span class="nf">splitlines</span><span class="p">():</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">raw</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">line</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">#</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">line</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">//</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">line</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">;</span><span class="sh">"</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">\s+#</span><span class="sh">"</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nf">strip</span><span class="p">()</span>  <span class="c1"># strip trailing comment after '#'
</span>        <span class="n">parts</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">\s*[:=]\s*</span><span class="sh">"</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">strip</span><span class="p">(),</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">norm_key</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">sub</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">[\s\-]+</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">_</span><span class="sh">"</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="nf">lower</span><span class="p">())</span>
        <span class="n">out</span><span class="p">[</span><span class="n">norm_key</span><span class="p">]</span> <span class="o">=</span> <span class="nf">_parse_scalar</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="c1"># =========================
# Provider config
# =========================
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ProviderProfile</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">model</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">api</span><span class="p">:</span> <span class="nb">str</span>          <span class="c1"># "responses" | "completions"
</span>    <span class="n">tool_json</span><span class="p">:</span> <span class="nb">str</span>    <span class="c1"># "flat" | "nested"
</span>    <span class="n">default_parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># forwarded as **kwargs
</span>    <span class="n">system_prompt_default</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c1"># per-model default system prompt
</span>
<span class="k">def</span> <span class="nf">_load_toml_bytes</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
    <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">load_providers_from_config</span><span class="p">(</span><span class="n">config_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ProviderProfile</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">
    [[api_provider]]
    name = </span><span class="sh">"</span><span class="s">OSS GPT (Responses + Flat)</span><span class="sh">"</span><span class="s">
    model = </span><span class="sh">"</span><span class="s">gpt-4.1-mini</span><span class="sh">"</span><span class="s">
    base_url = </span><span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="s">
    api_key_env = </span><span class="sh">"</span><span class="s">OPENAI_API_KEY</span><span class="sh">"</span><span class="s">   # or api_key = </span><span class="sh">"</span><span class="s">sk-...</span><span class="sh">"</span><span class="s">
    api = </span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="s">                # </span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="s"> | </span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="s">
    tool_json = </span><span class="sh">"</span><span class="s">flat</span><span class="sh">"</span><span class="s">               # </span><span class="sh">"</span><span class="s">flat</span><span class="sh">"</span><span class="s"> | </span><span class="sh">"</span><span class="s">nested</span><span class="sh">"</span><span class="s">
    parameters = </span><span class="sh">'''</span><span class="s">
      tool_choice: auto
      temperature: 0.5
    </span><span class="sh">'''</span><span class="s">
    system_prompt_default = </span><span class="sh">"""</span>
<span class="n">파일</span><span class="err">·</span><span class="n">네트워크</span> <span class="n">등</span> <span class="n">다양한</span> <span class="n">도구를</span> <span class="n">적시에</span> <span class="n">호출하되</span><span class="p">,</span> <span class="n">스키마에</span> <span class="n">맞게</span> <span class="n">파라미터를</span> <span class="n">채운다</span><span class="p">.</span>
<span class="n">출력은</span> <span class="n">간결한</span> <span class="n">한국어로</span> <span class="n">제공한다</span><span class="p">.</span> <span class="n">사고과정은</span> <span class="n">노출하지</span> <span class="n">말고</span> <span class="n">최종</span> <span class="n">답을</span> <span class="n">제공한다</span><span class="p">.</span>
<span class="sh">"""</span><span class="s">
    </span><span class="sh">"""</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">config_path</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="n">raw</span> <span class="o">=</span> <span class="nf">_load_toml_bytes</span><span class="p">(</span><span class="n">config_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">config_path</span><span class="p">.</span><span class="nf">lower</span><span class="p">().</span><span class="nf">endswith</span><span class="p">(</span><span class="sh">"</span><span class="s">.toml</span><span class="sh">"</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">tomllib</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">tomllib</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">tomli</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">tomli</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">TOML parser not available. Use Python 3.11+ or `pip install tomli`.</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">))</span>

    <span class="n">providers_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">api_provider</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">api_providers</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">providers_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ProviderProfile</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">providers_data</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">base_url</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">api_key_env</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">api_key_env</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">api</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">api</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">tool_json</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_json</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">raw_params</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">sys_default</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">system_prompt_default</span><span class="sh">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">model</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">base_url</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">api</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">tool_json</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">api_key</span> <span class="ow">and</span> <span class="n">api_key_env</span><span class="p">:</span>
            <span class="n">api_key</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="n">api_key_env</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">api_key</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">raw_params</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">params_dict</span> <span class="o">=</span> <span class="nf">parse_loose_params</span><span class="p">(</span><span class="n">raw_params</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">raw_params</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">params_dict</span> <span class="o">=</span> <span class="n">raw_params</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">params_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">out</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nc">ProviderProfile</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">base_url</span><span class="o">=</span><span class="n">base_url</span><span class="p">,</span>
            <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
            <span class="n">api</span><span class="o">=</span><span class="n">api</span><span class="p">,</span>
            <span class="n">tool_json</span><span class="o">=</span><span class="n">tool_json</span><span class="p">,</span>
            <span class="n">default_parameters</span><span class="o">=</span><span class="n">params_dict</span><span class="p">,</span>
            <span class="n">system_prompt_default</span><span class="o">=</span><span class="n">sys_default</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="n">DEFAULT_CONFIG_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_PROVIDER_CONFIG</span><span class="sh">"</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="nf">getcwd</span><span class="p">(),</span> <span class="sh">"</span><span class="s">config.toml</span><span class="sh">"</span><span class="p">))</span>
<span class="n">PROVIDER_CATALOG</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ProviderProfile</span><span class="p">]</span> <span class="o">=</span> <span class="nf">load_providers_from_config</span><span class="p">(</span><span class="n">DEFAULT_CONFIG_PATH</span><span class="p">)</span>

<span class="c1"># =========================
# Tool layer (dynamic, per-node)
# =========================
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ToolSpec</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="n">func</span><span class="p">:</span> <span class="n">Any</span>  <span class="c1"># Callable[[Dict[str, Any]], Any]
</span>    <span class="n">category</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">tags</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">class</span> <span class="nc">ToolJSONBuilder</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="bp">...</span>

<span class="k">class</span> <span class="nc">FlatToolJSONBuilder</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">:</span>
            <span class="n">item</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">description</span><span class="p">,</span> <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">parameters</span><span class="p">}</span>
            <span class="n">items</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">items</span>

<span class="k">class</span> <span class="nc">NestedToolJSONBuilder</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">:</span>
            <span class="n">item</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">description</span><span class="p">,</span> <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">parameters</span><span class="p">}}</span>
            <span class="n">items</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">items</span>

<span class="k">def</span> <span class="nf">select_tool_builder</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ToolJSONBuilder</span><span class="p">:</span>
    <span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="n">kind</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">).</span><span class="nf">strip</span><span class="p">().</span><span class="nf">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="sh">"</span><span class="s">flat</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="nc">FlatToolJSONBuilder</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="sh">"</span><span class="s">nested</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="nc">NestedToolJSONBuilder</span><span class="p">()</span>
    <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool_json: </span><span class="si">{</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># =========================
# Optional callback sink
# =========================
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">CallbackSink</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Lightweight event sink. Attach a UI listener to consume .events if needed.</span><span class="sh">"""</span>
    <span class="n">label</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OpenAI</span><span class="sh">"</span>
    <span class="n">events</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">events</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">events</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">emit</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
        <span class="n">rec</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">event</span><span class="sh">"</span><span class="p">:</span> <span class="n">event</span><span class="p">,</span> <span class="sh">"</span><span class="s">payload</span><span class="sh">"</span><span class="p">:</span> <span class="n">payload</span><span class="p">}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">events</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">label</span><span class="si">}</span><span class="s">] </span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">payload</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># =========================
# Tool scaling utilities (filter + briefing)
# =========================
</span>
<span class="k">def</span> <span class="nf">_tokenize</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">re</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">[^a-zA-Z0-9가-힣_]+</span><span class="sh">"</span><span class="p">,</span> <span class="p">(</span><span class="n">text</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">).</span><span class="nf">lower</span><span class="p">())</span> <span class="k">if</span> <span class="n">t</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">score_tool_relevance</span><span class="p">(</span><span class="n">user_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tool</span><span class="p">:</span> <span class="n">ToolSpec</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="c1"># Simple lexical overlap on name, description, parameter keys, category, tags
</span>    <span class="n">uq</span> <span class="o">=</span> <span class="nf">set</span><span class="p">(</span><span class="nf">_tokenize</span><span class="p">(</span><span class="n">user_prompt</span><span class="p">))</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">tool</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
        <span class="n">tool</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>
        <span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="n">tool</span><span class="p">.</span><span class="n">parameters</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}).</span><span class="nf">keys</span><span class="p">())</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">tool</span><span class="p">.</span><span class="n">parameters</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="p">[]),</span>
        <span class="n">tool</span><span class="p">.</span><span class="n">category</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span>
        <span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">tool</span><span class="p">.</span><span class="n">tags</span> <span class="ow">or</span> <span class="p">[]),</span>
    <span class="p">]</span>
    <span class="n">ut</span> <span class="o">=</span> <span class="nf">set</span><span class="p">(</span><span class="nf">_tokenize</span><span class="p">(</span><span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">fields</span><span class="p">)))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">uq</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">ut</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0</span>
    <span class="n">inter</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">uq</span><span class="p">.</span><span class="nf">intersection</span><span class="p">(</span><span class="n">ut</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">inter</span> <span class="o">/</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">uq</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="nf">len</span><span class="p">(</span><span class="n">ut</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">filter_tools</span><span class="p">(</span><span class="n">user_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">],</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_tools</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">none</span><span class="sh">"</span> <span class="ow">or</span> <span class="n">max_tools</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nf">len</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">max_tools</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">tools</span>
    <span class="n">scored</span> <span class="o">=</span> <span class="p">[(</span><span class="nf">score_tool_relevance</span><span class="p">(</span><span class="n">user_prompt</span><span class="p">,</span> <span class="n">t</span><span class="p">),</span> <span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">]</span>
    <span class="n">scored</span><span class="p">.</span><span class="nf">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="c1"># Keep at least those with positive scores; if all zero, fall back to first max_tools
</span>    <span class="n">positives</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">scored</span> <span class="k">if</span> <span class="n">s</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">positives</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">positives</span><span class="p">[:</span><span class="n">max_tools</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">scored</span><span class="p">[:</span><span class="n">max_tools</span><span class="p">]]</span>

<span class="k">def</span> <span class="nf">build_tool_briefing</span><span class="p">(</span><span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">],</span> <span class="n">max_lines</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">12</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="c1"># Very short, model-friendly overview to reduce confusion.
</span>    <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">tools</span><span class="p">[:</span><span class="n">max_lines</span><span class="p">],</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">required</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">req</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="n">parameters</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">required</span> <span class="o">=</span> <span class="n">req</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">req_preview</span> <span class="o">=</span> <span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">required</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">cat</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[</span><span class="si">{</span><span class="n">t</span><span class="p">.</span><span class="n">category</span><span class="si">}</span><span class="s">] </span><span class="sh">"</span> <span class="k">if</span> <span class="n">t</span><span class="p">.</span><span class="n">category</span> <span class="k">else</span> <span class="sh">""</span>
        <span class="n">line</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s">. </span><span class="si">{</span><span class="n">cat</span><span class="si">}{</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">t</span><span class="p">.</span><span class="n">description</span><span class="si">}</span><span class="sh">"</span>
        <span class="k">if</span> <span class="n">req_preview</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="sa">f</span><span class="sh">"</span><span class="s"> (required: </span><span class="si">{</span><span class="n">req_preview</span><span class="si">}</span><span class="s">)</span><span class="sh">"</span>
        <span class="n">lines</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">return</span> <span class="sh">""</span>
    <span class="nf">return </span><span class="p">(</span>
        <span class="sh">"</span><span class="s">TOOL BRIEFING (auto-generated)</span><span class="se">\n</span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">- Use only when needed. Fill parameters exactly per schema.</span><span class="se">\n</span><span class="sh">"</span>
        <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">+</span>
        <span class="sh">"</span><span class="se">\n</span><span class="s">END TOOL BRIEFING</span><span class="sh">"</span>
    <span class="p">)</span>

<span class="c1"># =========================
# Protocol runners (async), **kwargs passthrough
# =========================
</span>
<span class="k">class</span> <span class="nc">ResponsesRunner</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Async Responses loop; tool calls executed locally.</span><span class="sh">"""</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_collect_text</span><span class="p">(</span><span class="n">resp</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
            <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]:</span>
                    <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
            <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
        <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">texts</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_collect_calls</span><span class="p">(</span><span class="n">resp</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="sh">"</span><span class="s">function_call</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                        <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                              <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                              <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{}})</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">inner</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">inner</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">inner</span><span class="p">:</span>
                        <span class="n">nm</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                        <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                                <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                                      <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">nm</span><span class="p">,</span>
                                      <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{}})</span>
        <span class="k">return</span> <span class="n">calls</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">tools</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">:</span> <span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">_exec_tool</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">spec</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">spec</span><span class="p">.</span><span class="nf">func</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">client</span><span class="p">:</span> <span class="n">AsyncOpenAI</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">tools_json</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">user</span><span class="p">:</span> <span class="n">InterruptUser</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">base</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span> <span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools_json</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_choice</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">}</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">base</span><span class="p">,</span> <span class="o">**</span><span class="p">(</span><span class="n">params</span> <span class="ow">or</span> <span class="p">{})}</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">call_with_interrupt</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">),</span> <span class="n">user</span><span class="p">)</span>

        <span class="n">chunks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">_collect_text</span><span class="p">(</span><span class="n">resp</span><span class="p">))</span>
            <span class="n">calls</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_collect_calls</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
                <span class="k">if</span> <span class="k">await</span> <span class="n">user</span><span class="p">.</span><span class="nf">processing_interrupted</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="nc">UserCancelledError</span><span class="p">(</span><span class="sh">"</span><span class="s">Interrupted by user.</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_exec_tool</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
                <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function_call_output</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">[</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)})</span>

            <span class="n">base</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span> <span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools_json</span><span class="p">}</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">base</span><span class="p">,</span> <span class="o">**</span><span class="p">(</span><span class="n">params</span> <span class="ow">or</span> <span class="p">{})}</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">call_with_interrupt</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">),</span> <span class="n">user</span><span class="p">)</span>

        <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">chunks</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

<span class="k">class</span> <span class="nc">CompletionsRunner</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Async Chat Completions loop; tool calls executed locally.</span><span class="sh">"""</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">tools</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">:</span> <span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">_exec_tool</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">spec</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">spec</span><span class="p">.</span><span class="nf">func</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">client</span><span class="p">:</span> <span class="n">AsyncOpenAI</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">tools_json</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">user</span><span class="p">:</span> <span class="n">InterruptUser</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">base</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools_json</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_choice</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">}</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">base</span><span class="p">,</span> <span class="o">**</span><span class="p">(</span><span class="n">params</span> <span class="ow">or</span> <span class="p">{})}</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">call_with_interrupt</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">),</span> <span class="n">user</span><span class="p">)</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
        <span class="n">chunks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">]</span>
        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">tool_msgs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="k">if</span> <span class="k">await</span> <span class="n">user</span><span class="p">.</span><span class="nf">processing_interrupted</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="nc">UserCancelledError</span><span class="p">(</span><span class="sh">"</span><span class="s">Interrupted by user.</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">fn</span> <span class="o">=</span> <span class="n">tc</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">tc</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_exec_tool</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>
                <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">tc</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)})</span>

            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">]})</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

            <span class="n">base</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">}</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">base</span><span class="p">,</span> <span class="o">**</span><span class="p">(</span><span class="n">params</span> <span class="ow">or</span> <span class="p">{})}</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">call_with_interrupt</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">),</span> <span class="n">user</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
            <span class="k">if</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">content</span><span class="p">)</span>

        <span class="k">return</span> <span class="sh">"</span><span class="se">\n\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">chunks</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

<span class="c1"># =========================
# Orchestrator (filter + auto briefing + **kwargs passthrough)
# =========================
</span>
<span class="k">def</span> <span class="nf">build_payload</span><span class="p">(</span><span class="n">provider</span><span class="p">:</span> <span class="n">ProviderProfile</span><span class="p">,</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">builder</span> <span class="o">=</span> <span class="nf">select_tool_builder</span><span class="p">(</span><span class="n">provider</span><span class="p">.</span><span class="n">tool_json</span><span class="p">)</span>
    <span class="n">tools_json</span> <span class="o">=</span> <span class="n">builder</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">tools_json</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools_json</span><span class="p">,</span> <span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">:</span> <span class="nf">dict</span><span class="p">(</span><span class="n">provider</span><span class="p">.</span><span class="n">default_parameters</span> <span class="ow">or</span> <span class="p">{})}</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_with_provider</span><span class="p">(</span>
    <span class="n">provider</span><span class="p">:</span> <span class="n">ProviderProfile</span><span class="p">,</span>
    <span class="n">system_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">user_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">],</span>
    <span class="n">params_override</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">user</span><span class="p">:</span> <span class="n">InterruptUser</span><span class="p">,</span>
    <span class="n">tool_filter_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">none</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">tool_filter_max</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
    <span class="n">auto_tool_brief</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
    <span class="n">max_brief_tools</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="c1"># 1) Tool shortlist (heuristic) to avoid sending hundreds of tools.
</span>    <span class="n">selected_tools</span> <span class="o">=</span> <span class="nf">filter_tools</span><span class="p">(</span><span class="n">user_prompt</span><span class="p">,</span> <span class="n">tools</span><span class="p">,</span> <span class="n">tool_filter_mode</span><span class="p">,</span> <span class="n">tool_filter_max</span><span class="p">)</span>

    <span class="c1"># 2) Auto tool briefing text (short summary) to stabilize usage.
</span>    <span class="n">system_prompt_final</span> <span class="o">=</span> <span class="n">system_prompt</span> <span class="ow">or</span> <span class="n">provider</span><span class="p">.</span><span class="n">system_prompt_default</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">You are a helpful assistant.</span><span class="sh">"</span>
    <span class="k">if</span> <span class="n">auto_tool_brief</span><span class="p">:</span>
        <span class="n">brief</span> <span class="o">=</span> <span class="nf">build_tool_briefing</span><span class="p">(</span><span class="n">selected_tools</span><span class="p">,</span> <span class="n">max_lines</span><span class="o">=</span><span class="n">max_brief_tools</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">brief</span><span class="p">:</span>
            <span class="n">system_prompt_final</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">system_prompt_final</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span><span class="si">}</span><span class="se">\n\n</span><span class="si">{</span><span class="n">brief</span><span class="si">}</span><span class="sh">"</span>

    <span class="c1"># 3) Messages
</span>    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">system_prompt_final</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_prompt</span><span class="p">},</span>
    <span class="p">]</span>

    <span class="c1"># 4) Build payload for selected tools
</span>    <span class="n">builder</span> <span class="o">=</span> <span class="nf">select_tool_builder</span><span class="p">(</span><span class="n">provider</span><span class="p">.</span><span class="n">tool_json</span><span class="p">)</span>
    <span class="n">tools_json</span> <span class="o">=</span> <span class="n">builder</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="n">selected_tools</span><span class="p">)</span>

    <span class="c1"># 5) Merge parameters
</span>    <span class="n">params</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span><span class="n">provider</span><span class="p">.</span><span class="n">default_parameters</span> <span class="ow">or</span> <span class="p">{})</span>
    <span class="k">if</span> <span class="n">params_override</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">params</span><span class="p">,</span> <span class="o">**</span><span class="n">params_override</span><span class="p">}</span>

    <span class="c1"># 6) Run
</span>    <span class="n">hooks</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">:</span> <span class="p">[],</span> <span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">httpx</span><span class="p">.</span><span class="nc">AsyncClient</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">httpx</span><span class="p">.</span><span class="nc">Timeout</span><span class="p">(</span><span class="mf">60.0</span><span class="p">),</span> <span class="n">event_hooks</span><span class="o">=</span><span class="n">hooks</span><span class="p">)</span> <span class="k">as</span> <span class="n">http_client</span><span class="p">:</span>
        <span class="k">async</span> <span class="k">with</span> <span class="nc">AsyncOpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">provider</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">provider</span><span class="p">.</span><span class="n">api_key</span><span class="p">,</span> <span class="n">http_client</span><span class="o">=</span><span class="n">http_client</span><span class="p">)</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">provider</span><span class="p">.</span><span class="n">api</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">runner</span> <span class="o">=</span> <span class="nc">ResponsesRunner</span><span class="p">(</span><span class="n">selected_tools</span><span class="p">)</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">provider</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="n">messages</span><span class="p">,</span> <span class="n">tools_json</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">runner</span> <span class="o">=</span> <span class="nc">CompletionsRunner</span><span class="p">(</span><span class="n">selected_tools</span><span class="p">)</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">provider</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="n">messages</span><span class="p">,</span> <span class="n">tools_json</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>

<span class="c1"># =========================
# Nodes
# =========================
</span>
<span class="c1"># -- Provider
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">AdvancedOptions</span><span class="p">:</span>
    <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]</span>
    <span class="n">custom_provider</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ProviderProfile</span><span class="p">]</span>
    <span class="n">system_prompt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># forwarded as **kwargs
</span>    <span class="c1"># scaling options:
</span>    <span class="n">tool_filter_mode</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">tool_filter_max</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">auto_tool_brief</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">max_brief_tools</span><span class="p">:</span> <span class="nb">int</span>

<span class="k">class</span> <span class="nc">OpenAICustomProviderNode</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Create a provider profile directly from UI inputs; parameters forwarded verbatim as **kwargs.</span><span class="sh">"""</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">gpt-4.1-mini</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">api</span><span class="sh">"</span><span class="p">:</span> <span class="p">([</span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">],),</span>
                <span class="sh">"</span><span class="s">tool_json</span><span class="sh">"</span><span class="p">:</span> <span class="p">([</span><span class="sh">"</span><span class="s">flat</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">nested</span><span class="sh">"</span><span class="p">],),</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">optional</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool_choice: auto</span><span class="se">\n</span><span class="s">temperature: 0.5</span><span class="se">\n</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">system_prompt_default</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}),</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_PROVIDER</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">provider</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">build</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OpenAI/Provider</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tool_json</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">parameters</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span><span class="p">,</span> <span class="n">system_prompt_default</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span><span class="p">):</span>
        <span class="n">params_dict</span> <span class="o">=</span> <span class="nf">parse_loose_params</span><span class="p">(</span><span class="n">parameters</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">)</span>
        <span class="n">provider</span> <span class="o">=</span> <span class="nc">ProviderProfile</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="s">custom::</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">base_url</span><span class="o">=</span><span class="n">base_url</span><span class="p">,</span>
            <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
            <span class="n">api</span><span class="o">=</span><span class="n">api</span><span class="p">,</span>
            <span class="n">tool_json</span><span class="o">=</span><span class="n">tool_json</span><span class="p">,</span>
            <span class="n">default_parameters</span><span class="o">=</span><span class="n">params_dict</span><span class="p">,</span>
            <span class="n">system_prompt_default</span><span class="o">=</span><span class="n">system_prompt_default</span> <span class="k">if</span> <span class="n">system_prompt_default</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">provider</span><span class="p">,)</span>

<span class="c1"># -- Callback sink
</span>
<span class="k">class</span> <span class="nc">OpenAICallbackNode</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Create a simple callback sink. Tools can emit(event, payload) to this sink.</span><span class="sh">"""</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">optional</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">label</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">OpenAI</span><span class="sh">"</span><span class="p">})}}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_CALLBACK</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">callback</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">build</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OpenAI/Utils</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">label</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OpenAI</span><span class="sh">"</span><span class="p">):</span>
        <span class="nf">return </span><span class="p">(</span><span class="nc">CallbackSink</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">),)</span>

<span class="c1"># -- File tools (each is a separate node)
</span>
<span class="k">class</span> <span class="nc">FileListToolNode</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Create a </span><span class="sh">'</span><span class="s">list files</span><span class="sh">'</span><span class="s"> tool.</span><span class="sh">"""</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List files in a folder.</span><span class="sh">"</span><span class="p">}),</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">optional</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">tools_in</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_TOOLS</span><span class="sh">"</span><span class="p">,),</span>
                <span class="sh">"</span><span class="s">base_dir</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">return_full_paths</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">BOOLEAN</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">category</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">filesystem</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">tags</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list,files</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">callback</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_CALLBACK</span><span class="sh">"</span><span class="p">,),</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_TOOLS</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">append_tool</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OpenAI/Tools</span><span class="sh">"</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_safe_join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">base_dir</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">base_dir</span><span class="p">)</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">target</span> <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">commonpath</span><span class="p">([</span><span class="n">base</span><span class="p">,</span> <span class="n">target</span><span class="p">])</span> <span class="o">==</span> <span class="n">base</span> <span class="k">else</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">append_tool</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">tools_in</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">base_dir</span><span class="o">=</span><span class="sh">""</span><span class="p">,</span> <span class="n">return_full_paths</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="sh">"</span><span class="s">filesystem</span><span class="sh">"</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="sh">"</span><span class="s">list,files</span><span class="sh">"</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Folder path (relative to base_dir if set).</span><span class="sh">"</span><span class="p">},</span>
                <span class="sh">"</span><span class="s">pattern</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Optional glob, e.g. *.txt</span><span class="sh">"</span><span class="p">},</span>
                <span class="sh">"</span><span class="s">absolute</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">boolean</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Force absolute paths override.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">}</span>

        <span class="k">def</span> <span class="nf">_impl</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
            <span class="n">folder</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">))</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">pattern</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">))</span>
            <span class="n">absolute</span> <span class="o">=</span> <span class="nf">bool</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">absolute</span><span class="sh">"</span><span class="p">,</span> <span class="n">return_full_paths</span><span class="p">))</span>
            <span class="n">resolved</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_safe_join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">folder</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">resolved</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isdir</span><span class="p">(</span><span class="n">resolved</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">callback</span><span class="p">:</span> <span class="n">callback</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_error</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">reason</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">invalid_folder</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">folder</span><span class="sh">"</span><span class="p">:</span> <span class="n">folder</span><span class="p">})</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
            <span class="kn">import</span> <span class="n">glob</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">resolved</span><span class="p">,</span> <span class="n">pattern</span><span class="p">)</span> <span class="k">if</span> <span class="n">pattern</span> <span class="k">else</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">resolved</span><span class="p">,</span> <span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">.</span><span class="nf">glob</span><span class="p">(</span><span class="n">g</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">p</span><span class="p">)]</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">if</span> <span class="n">absolute</span> <span class="k">else</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">basename</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">callback</span><span class="p">:</span> <span class="n">callback</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_done</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">count</span><span class="sh">"</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">out</span><span class="p">)})</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">out</span><span class="p">)}</span>

        <span class="n">spec</span> <span class="o">=</span> <span class="nc">ToolSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">_impl</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">category</span> <span class="ow">or</span> <span class="bp">None</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="n">t</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="p">)]</span> <span class="k">if</span> <span class="n">tags</span> <span class="k">else</span> <span class="bp">None</span><span class="p">)</span>
        <span class="nf">return </span><span class="p">((</span><span class="n">tools_in</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">tools_in</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[])</span> <span class="o">+</span> <span class="p">[</span><span class="n">spec</span><span class="p">],)</span>

<span class="k">class</span> <span class="nc">FileReadToolNode</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Create a </span><span class="sh">'</span><span class="s">read text file</span><span class="sh">'</span><span class="s"> tool.</span><span class="sh">"""</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a UTF-8 text file.</span><span class="sh">"</span><span class="p">}),</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">optional</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">tools_in</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_TOOLS</span><span class="sh">"</span><span class="p">,),</span>
                <span class="sh">"</span><span class="s">base_dir</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">encoding</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">category</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">filesystem</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">tags</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read,file,text</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">callback</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_CALLBACK</span><span class="sh">"</span><span class="p">,),</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_TOOLS</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">append_tool</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OpenAI/Tools</span><span class="sh">"</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_safe_join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">base_dir</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">base_dir</span><span class="p">)</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">target</span> <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">commonpath</span><span class="p">([</span><span class="n">base</span><span class="p">,</span> <span class="n">target</span><span class="p">])</span> <span class="o">==</span> <span class="n">base</span> <span class="k">else</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">append_tool</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">tools_in</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">base_dir</span><span class="o">=</span><span class="sh">""</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="sh">"</span><span class="s">filesystem</span><span class="sh">"</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="sh">"</span><span class="s">read,file,text</span><span class="sh">"</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">File path (relative to base_dir if set).</span><span class="sh">"</span><span class="p">},</span>
                <span class="sh">"</span><span class="s">encoding</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Override encoding.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">}</span>

        <span class="k">def</span> <span class="nf">_impl</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">))</span>
            <span class="n">enc</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">encoding</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="p">))</span>
            <span class="n">resolved</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_safe_join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">resolved</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">resolved</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">callback</span><span class="p">:</span> <span class="n">callback</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_error</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">reason</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">invalid_file</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="p">:</span> <span class="n">path</span><span class="p">})</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">resolved</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">enc</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">callback</span><span class="p">:</span> <span class="n">callback</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_done</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">text</span><span class="p">)})</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="n">text</span><span class="p">}</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">callback</span><span class="p">:</span> <span class="n">callback</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_error</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">reason</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_failed</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">)})</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}</span>

        <span class="n">spec</span> <span class="o">=</span> <span class="nc">ToolSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">_impl</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">category</span> <span class="ow">or</span> <span class="bp">None</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="n">t</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="p">)]</span> <span class="k">if</span> <span class="n">tags</span> <span class="k">else</span> <span class="bp">None</span><span class="p">)</span>
        <span class="nf">return </span><span class="p">((</span><span class="n">tools_in</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">tools_in</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[])</span> <span class="o">+</span> <span class="p">[</span><span class="n">spec</span><span class="p">],)</span>

<span class="k">class</span> <span class="nc">FileWriteToolNode</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Create a </span><span class="sh">'</span><span class="s">write text file</span><span class="sh">'</span><span class="s"> tool.</span><span class="sh">"""</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">write_text_file</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Write text to a file (creates dirs).</span><span class="sh">"</span><span class="p">}),</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">optional</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">tools_in</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_TOOLS</span><span class="sh">"</span><span class="p">,),</span>
                <span class="sh">"</span><span class="s">base_dir</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">encoding</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">append</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">BOOLEAN</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">category</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">filesystem</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">tags</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">write,file,text</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">callback</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_CALLBACK</span><span class="sh">"</span><span class="p">,),</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_TOOLS</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">append_tool</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OpenAI/Tools</span><span class="sh">"</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_safe_join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">base_dir</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">base_dir</span><span class="p">)</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">target</span> <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">commonpath</span><span class="p">([</span><span class="n">base</span><span class="p">,</span> <span class="n">target</span><span class="p">])</span> <span class="o">==</span> <span class="n">base</span> <span class="k">else</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">append_tool</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">tools_in</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">base_dir</span><span class="o">=</span><span class="sh">""</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="sh">"</span><span class="s">filesystem</span><span class="sh">"</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="sh">"</span><span class="s">write,file,text</span><span class="sh">"</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">File path (relative to base_dir if set).</span><span class="sh">"</span><span class="p">},</span>
                <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Text content to write.</span><span class="sh">"</span><span class="p">},</span>
                <span class="sh">"</span><span class="s">encoding</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Override encoding.</span><span class="sh">"</span><span class="p">},</span>
                <span class="sh">"</span><span class="s">append</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">boolean</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Append to file instead of overwrite.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">}</span>

        <span class="k">def</span> <span class="nf">_impl</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">))</span>
            <span class="n">content</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">))</span>
            <span class="n">enc</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">encoding</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="p">))</span>
            <span class="n">do_append</span> <span class="o">=</span> <span class="nf">bool</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">append</span><span class="sh">"</span><span class="p">,</span> <span class="n">append</span><span class="p">))</span>
            <span class="n">resolved</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_safe_join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">resolved</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">callback</span><span class="p">:</span> <span class="n">callback</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_error</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">reason</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">invalid_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="p">:</span> <span class="n">path</span><span class="p">})</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">resolved</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="sh">"</span><span class="s">a</span><span class="sh">"</span> <span class="k">if</span> <span class="n">do_append</span> <span class="k">else</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span>
                <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">resolved</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">enc</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">callback</span><span class="p">:</span> <span class="n">callback</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_done</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">bytes</span><span class="sh">"</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">content</span><span class="p">)})</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">callback</span><span class="p">:</span> <span class="n">callback</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_error</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">reason</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">write_failed</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">)})</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">}</span>

        <span class="n">spec</span> <span class="o">=</span> <span class="nc">ToolSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">_impl</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">category</span> <span class="ow">or</span> <span class="bp">None</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="n">t</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="p">)]</span> <span class="k">if</span> <span class="n">tags</span> <span class="k">else</span> <span class="bp">None</span><span class="p">)</span>
        <span class="nf">return </span><span class="p">((</span><span class="n">tools_in</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">tools_in</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[])</span> <span class="o">+</span> <span class="p">[</span><span class="n">spec</span><span class="p">],)</span>

<span class="c1"># -- Generic: wrap any python module:function as a tool
</span>
<span class="k">class</span> <span class="nc">PythonCallableToolNode</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Wrap a Python callable (module:function) as a tool.
    The callable must accept a single dict argument and return a JSON-serializable dict.
    </span><span class="sh">"""</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">my_python_tool</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Generic Python callable tool.</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">module_function</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">mypackage.mymodule:myfunc</span><span class="sh">"</span><span class="p">}),</span>  <span class="c1"># "pkg.mod:fn"
</span>                <span class="sh">"</span><span class="s">parameters_json</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span>
                        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">x</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">number</span><span class="sh">"</span><span class="p">},</span> <span class="sh">"</span><span class="s">y</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">number</span><span class="sh">"</span><span class="p">}},</span>
                        <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">x</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">y</span><span class="sh">"</span><span class="p">],</span>
                        <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
                    <span class="p">},</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="p">}),</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">optional</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">tools_in</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_TOOLS</span><span class="sh">"</span><span class="p">,),</span>
                <span class="sh">"</span><span class="s">category</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">generic</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">tags</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">python,custom</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">preset_args</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}),</span>  <span class="c1"># loose "k: v" merged into args
</span>                <span class="sh">"</span><span class="s">callback</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_CALLBACK</span><span class="sh">"</span><span class="p">,),</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_TOOLS</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">append_tool</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OpenAI/Tools</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">append_tool</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">module_function</span><span class="p">,</span> <span class="n">parameters_json</span><span class="p">,</span> <span class="n">tools_in</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="sh">"</span><span class="s">generic</span><span class="sh">"</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="sh">"</span><span class="s">python,custom</span><span class="sh">"</span><span class="p">,</span> <span class="n">preset_args</span><span class="o">=</span><span class="sh">""</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">schema</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">parameters_json</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="n">schema</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{},</span> <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>

        <span class="c1"># Resolve module:function
</span>        <span class="k">if</span> <span class="sh">"</span><span class="s">:</span><span class="sh">"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">module_function</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">module_function must be in </span><span class="sh">'</span><span class="s">package.module:function</span><span class="sh">'</span><span class="s"> format</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">mod_name</span><span class="p">,</span> <span class="n">fn_name</span> <span class="o">=</span> <span class="n">module_function</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">mod</span> <span class="o">=</span> <span class="n">importlib</span><span class="p">.</span><span class="nf">import_module</span><span class="p">(</span><span class="n">mod_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">fn_name</span><span class="p">):</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Function </span><span class="sh">'</span><span class="si">{</span><span class="n">fn_name</span><span class="si">}</span><span class="sh">'</span><span class="s"> not found in module </span><span class="sh">'</span><span class="si">{</span><span class="n">mod_name</span><span class="si">}</span><span class="sh">'"</span><span class="p">)</span>
        <span class="n">target_fn</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">fn_name</span><span class="p">)</span>
        <span class="n">preset</span> <span class="o">=</span> <span class="nf">parse_loose_params</span><span class="p">(</span><span class="n">preset_args</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_impl</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">merged</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">preset</span><span class="p">,</span> <span class="o">**</span><span class="p">(</span><span class="n">args</span> <span class="ow">or</span> <span class="p">{})}</span>
                <span class="n">result</span> <span class="o">=</span> <span class="nf">target_fn</span><span class="p">(</span><span class="n">merged</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">callback</span><span class="p">:</span> <span class="n">callback</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_done</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">})</span>
                <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">result</span>
                <span class="c1"># Normalize to dict
</span>                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="n">result</span><span class="p">}</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">callback</span><span class="p">:</span> <span class="n">callback</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_error</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">reason</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">exception</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">)})</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

        <span class="n">spec</span> <span class="o">=</span> <span class="nc">ToolSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">_impl</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">category</span> <span class="ow">or</span> <span class="bp">None</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="n">t</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="p">)]</span> <span class="k">if</span> <span class="n">tags</span> <span class="k">else</span> <span class="bp">None</span><span class="p">)</span>
        <span class="nf">return </span><span class="p">((</span><span class="n">tools_in</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">tools_in</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[])</span> <span class="o">+</span> <span class="p">[</span><span class="n">spec</span><span class="p">],)</span>

<span class="c1"># -- Advanced options aggregator
</span>
<span class="k">class</span> <span class="nc">OpenAIAdvancedOptionsNode</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Aggregate tools, custom provider, system prompt, and parameters (verbatim **kwargs),
    plus scaling controls for large tool sets.
    </span><span class="sh">"""</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">optional</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_TOOLS</span><span class="sh">"</span><span class="p">,),</span>
                <span class="sh">"</span><span class="s">custom_provider</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_PROVIDER</span><span class="sh">"</span><span class="p">,),</span>
                <span class="sh">"</span><span class="s">system_prompt</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool_choice: auto</span><span class="se">\n</span><span class="s"># e.g., max_tokens / max_output_tokens / top_p / temperature / stop</span><span class="se">\n</span><span class="sh">"</span>
                <span class="p">}),</span>
                <span class="sh">"</span><span class="s">tool_filter_mode</span><span class="sh">"</span><span class="p">:</span> <span class="p">([</span><span class="sh">"</span><span class="s">none</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">heuristic</span><span class="sh">"</span><span class="p">],</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">heuristic</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">tool_filter_max</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">INT</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span> <span class="sh">"</span><span class="s">min</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="sh">"</span><span class="s">max</span><span class="sh">"</span><span class="p">:</span> <span class="mi">512</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">auto_tool_brief</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">BOOLEAN</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">max_brief_tools</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">INT</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> <span class="sh">"</span><span class="s">min</span><span class="sh">"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="sh">"</span><span class="s">max</span><span class="sh">"</span><span class="p">:</span> <span class="mi">100</span><span class="p">}),</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_ADVANCED</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">advanced</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">build</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OpenAI/Options</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">tools</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">custom_provider</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">system_prompt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span><span class="p">,</span>
        <span class="n">parameters</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span><span class="p">,</span>
        <span class="n">tool_filter_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">heuristic</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">tool_filter_max</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
        <span class="n">auto_tool_brief</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">max_brief_tools</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">tlist</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]</span> <span class="o">=</span> <span class="n">tools</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">tools</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="n">provider</span> <span class="o">=</span> <span class="n">custom_provider</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">custom_provider</span><span class="p">,</span> <span class="n">ProviderProfile</span><span class="p">)</span> <span class="k">else</span> <span class="bp">None</span>
        <span class="n">sys_prompt</span> <span class="o">=</span> <span class="n">system_prompt</span> <span class="nf">if </span><span class="p">(</span><span class="n">system_prompt</span> <span class="ow">and</span> <span class="n">system_prompt</span><span class="p">.</span><span class="nf">strip</span><span class="p">())</span> <span class="k">else</span> <span class="bp">None</span>
        <span class="n">params_dict</span> <span class="o">=</span> <span class="nf">parse_loose_params</span><span class="p">(</span><span class="n">parameters</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">)</span>
        <span class="n">adv</span> <span class="o">=</span> <span class="nc">AdvancedOptions</span><span class="p">(</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">tlist</span><span class="p">,</span>
            <span class="n">custom_provider</span><span class="o">=</span><span class="n">provider</span><span class="p">,</span>
            <span class="n">system_prompt</span><span class="o">=</span><span class="n">sys_prompt</span><span class="p">,</span>
            <span class="n">parameters</span><span class="o">=</span><span class="n">params_dict</span><span class="p">,</span>
            <span class="n">tool_filter_mode</span><span class="o">=</span><span class="n">tool_filter_mode</span><span class="p">,</span>
            <span class="n">tool_filter_max</span><span class="o">=</span><span class="n">tool_filter_max</span><span class="p">,</span>
            <span class="n">auto_tool_brief</span><span class="o">=</span><span class="n">auto_tool_brief</span><span class="p">,</span>
            <span class="n">max_brief_tools</span><span class="o">=</span><span class="n">max_brief_tools</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">adv</span><span class="p">,)</span>

<span class="c1"># -- Chat
</span>
<span class="k">class</span> <span class="nc">OpenAIChatNode</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Async chat node with scalable tool handling:
      - Provider chosen by name from config.toml (auto-refreshed), overrideable via AdvancedOptions.custom_provider
      - Parameters: provider.default_parameters merged with AdvancedOptions.parameters (right wins)
      - Tool filtering + auto-briefing to keep prompts lean and tool usage stable
    </span><span class="sh">"""</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_provider_names</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">global</span> <span class="n">PROVIDER_CATALOG</span>
        <span class="n">PROVIDER_CATALOG</span> <span class="o">=</span> <span class="nf">load_providers_from_config</span><span class="p">(</span><span class="n">DEFAULT_CONFIG_PATH</span><span class="p">)</span>
        <span class="k">return</span> <span class="nf">list</span><span class="p">(</span><span class="n">PROVIDER_CATALOG</span><span class="p">.</span><span class="nf">keys</span><span class="p">())</span> <span class="ow">or</span> <span class="p">[</span><span class="sh">"</span><span class="s">&lt;no providers in config&gt;</span><span class="sh">"</span><span class="p">]</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="n">provider_list</span> <span class="o">=</span> <span class="n">cls</span><span class="p">.</span><span class="nf">_provider_names</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">user_prompt</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">예시: 문서에서 핵심을 추출하고 요약해줘.</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">provider_name</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="n">provider_list</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="n">provider_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]}),</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">optional</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">advanced</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_ADVANCED</span><span class="sh">"</span><span class="p">,),</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">response_text</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">run</span><span class="sh">"</span>
    <span class="n">OUTPUT_NODE</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OpenAI/Chat</span><span class="sh">"</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">user_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">provider_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">advanced</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="c1"># Resolve provider
</span>        <span class="k">global</span> <span class="n">PROVIDER_CATALOG</span>
        <span class="n">provider</span> <span class="o">=</span> <span class="n">PROVIDER_CATALOG</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">provider_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">advanced</span> <span class="ow">and</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">advanced</span><span class="p">,</span> <span class="n">AdvancedOptions</span><span class="p">)</span> <span class="ow">and</span> <span class="n">advanced</span><span class="p">.</span><span class="n">custom_provider</span><span class="p">:</span>
            <span class="n">provider</span> <span class="o">=</span> <span class="n">advanced</span><span class="p">.</span><span class="n">custom_provider</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">provider</span><span class="p">:</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">[OpenAIChatNode] Error: provider not found. Check config.toml or AdvancedOptions.</span><span class="sh">"</span><span class="p">,)</span>

        <span class="c1"># System prompt
</span>        <span class="n">system_prompt</span> <span class="o">=</span> <span class="n">provider</span><span class="p">.</span><span class="n">system_prompt_default</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">You are a helpful assistant.</span><span class="sh">"</span>
        <span class="k">if</span> <span class="n">advanced</span> <span class="ow">and</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">advanced</span><span class="p">,</span> <span class="n">AdvancedOptions</span><span class="p">)</span> <span class="ow">and</span> <span class="n">advanced</span><span class="p">.</span><span class="n">system_prompt</span><span class="p">:</span>
            <span class="n">system_prompt</span> <span class="o">=</span> <span class="n">advanced</span><span class="p">.</span><span class="n">system_prompt</span>

        <span class="c1"># Tools
</span>        <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">advanced</span> <span class="ow">and</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">advanced</span><span class="p">,</span> <span class="n">AdvancedOptions</span><span class="p">)</span> <span class="ow">and</span> <span class="n">advanced</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
            <span class="n">tools</span> <span class="o">=</span> <span class="n">advanced</span><span class="p">.</span><span class="n">tools</span>

        <span class="c1"># Parameters merge
</span>        <span class="n">params_override</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">advanced</span> <span class="ow">and</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">advanced</span><span class="p">,</span> <span class="n">AdvancedOptions</span><span class="p">)</span> <span class="ow">and</span> <span class="n">advanced</span><span class="p">.</span><span class="n">parameters</span><span class="p">:</span>
            <span class="n">params_override</span> <span class="o">=</span> <span class="n">advanced</span><span class="p">.</span><span class="n">parameters</span>

        <span class="c1"># Scaling controls
</span>        <span class="n">tool_filter_mode</span> <span class="o">=</span> <span class="sh">"</span><span class="s">none</span><span class="sh">"</span>
        <span class="n">tool_filter_max</span> <span class="o">=</span> <span class="mi">32</span>
        <span class="n">auto_tool_brief</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">max_brief_tools</span> <span class="o">=</span> <span class="mi">12</span>
        <span class="k">if</span> <span class="n">advanced</span> <span class="ow">and</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">advanced</span><span class="p">,</span> <span class="n">AdvancedOptions</span><span class="p">):</span>
            <span class="n">tool_filter_mode</span> <span class="o">=</span> <span class="n">advanced</span><span class="p">.</span><span class="n">tool_filter_mode</span>
            <span class="n">tool_filter_max</span> <span class="o">=</span> <span class="n">advanced</span><span class="p">.</span><span class="n">tool_filter_max</span>
            <span class="n">auto_tool_brief</span> <span class="o">=</span> <span class="n">advanced</span><span class="p">.</span><span class="n">auto_tool_brief</span>
            <span class="n">max_brief_tools</span> <span class="o">=</span> <span class="n">advanced</span><span class="p">.</span><span class="n">max_brief_tools</span>

        <span class="c1"># Interrupt
</span>        <span class="n">user</span> <span class="o">=</span> <span class="nc">InterruptUser</span><span class="p">()</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_running_loop</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">loop</span><span class="p">.</span><span class="nf">add_signal_handler</span><span class="p">(</span><span class="n">signal</span><span class="p">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">user</span><span class="p">.</span><span class="n">trigger_interrupt</span><span class="p">)</span>
            <span class="n">loop</span><span class="p">.</span><span class="nf">add_signal_handler</span><span class="p">(</span><span class="n">signal</span><span class="p">.</span><span class="n">SIGTERM</span><span class="p">,</span> <span class="n">user</span><span class="p">.</span><span class="n">trigger_interrupt</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">run_with_provider</span><span class="p">(</span>
                <span class="n">provider</span><span class="o">=</span><span class="n">provider</span><span class="p">,</span>
                <span class="n">system_prompt</span><span class="o">=</span><span class="n">system_prompt</span><span class="p">,</span>
                <span class="n">user_prompt</span><span class="o">=</span><span class="n">user_prompt</span><span class="p">,</span>
                <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
                <span class="n">params_override</span><span class="o">=</span><span class="n">params_override</span><span class="p">,</span>
                <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
                <span class="n">tool_filter_mode</span><span class="o">=</span><span class="n">tool_filter_mode</span><span class="p">,</span>
                <span class="n">tool_filter_max</span><span class="o">=</span><span class="n">tool_filter_max</span><span class="p">,</span>
                <span class="n">auto_tool_brief</span><span class="o">=</span><span class="n">auto_tool_brief</span><span class="p">,</span>
                <span class="n">max_brief_tools</span><span class="o">=</span><span class="n">max_brief_tools</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nf">return </span><span class="p">(</span><span class="n">text</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,)</span>
        <span class="k">except</span> <span class="n">UserCancelledError</span><span class="p">:</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">[OpenAIChatNode] Interrupted by user.</span><span class="sh">"</span><span class="p">,)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nf">return </span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[OpenAIChatNode] Error: </span><span class="si">{</span><span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">,)</span>

<span class="c1"># =========================
# ComfyUI registration
# =========================
</span>
<span class="n">NODE_CLASS_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">OpenAIChatNode</span><span class="sh">"</span><span class="p">:</span> <span class="n">OpenAIChatNode</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">OpenAICustomProviderNode</span><span class="sh">"</span><span class="p">:</span> <span class="n">OpenAICustomProviderNode</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">OpenAIAdvancedOptionsNode</span><span class="sh">"</span><span class="p">:</span> <span class="n">OpenAIAdvancedOptionsNode</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">OpenAICallbackNode</span><span class="sh">"</span><span class="p">:</span> <span class="n">OpenAICallbackNode</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">FileListToolNode</span><span class="sh">"</span><span class="p">:</span> <span class="n">FileListToolNode</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">FileReadToolNode</span><span class="sh">"</span><span class="p">:</span> <span class="n">FileReadToolNode</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">FileWriteToolNode</span><span class="sh">"</span><span class="p">:</span> <span class="n">FileWriteToolNode</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">PythonCallableToolNode</span><span class="sh">"</span><span class="p">:</span> <span class="n">PythonCallableToolNode</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">NODE_DISPLAY_NAME_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">OpenAIChatNode</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">OpenAI Chat (Async)</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">OpenAICustomProviderNode</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">OpenAI Custom Provider</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">OpenAIAdvancedOptionsNode</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">OpenAI Advanced Options</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">OpenAICallbackNode</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">OpenAI Callback Sink</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">FileListToolNode</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Tool: List Files</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">FileReadToolNode</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Tool: Read Text File</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">FileWriteToolNode</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Tool: Write Text File</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">PythonCallableToolNode</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Tool: Python Callable</span><span class="sh">"</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div>

<p>요약</p>

<ul>
  <li>
    <p>도메인에 묶이지 않게 툴을 일반화했고, 노드마다 어떤 툴이든 만들 수 있어.</p>
  </li>
  <li>
    <p>툴이 많아져도 자동 선별과 짧은 브리핑으로 모델 혼란과 프롬프트 길이를 제어.</p>
  </li>
  <li>
    <p>시스템 프롬프트는 “툴-불가지론”으로 짧게, 작업별로 AdvancedOptions.system_prompt로 얹는 2단 구성.</p>
  </li>
  <li>
    <p>나중에 벤더나 모델이 늘어나도, 툴 정의/메타데이터와 선별·브리핑 로직만 유지하면 확장 가능해.</p>
  </li>
</ul>

<p class="chat--user">

질문. 툴에 대한 내용을 시스템 프롬프트에 넣어야 하나? (그래야 성능이 더 좋나?)

</p>

<p>짧은 결론: “툴 정보 전부”를 시스템 프롬프트에 넣을 필요는 없고, 오히려 성능·비용에 악영향이 납니다. 대신 다음 원칙이 가장 안정적입니다.</p>

<ol>
  <li>시스템 프롬프트에는 “툴 사용 정책”만 짧게 넣기</li>
</ol>

<ul>
  <li>
    <p>언제 툴을 써야 하는지, 출력 형식, 보안 제약, 오류 처리 같은 규칙을 3–6문장으로 명시합니다.</p>
  </li>
  <li>
    <p>예: 파일 내용이 필요하면 반드시 read_text_file을 호출, base_dir 밖 접근 금지, 추측 금지, 한국어로 간결히 등.</p>
  </li>
</ul>

<ol>
  <li>구체적인 툴 스키마/설명은 tools 파라미터로만 전달</li>
</ol>

<ul>
  <li>모델은 tools에 있는 JSON 스키마를 근거로 파라미터를 채웁니다. 같은 내용을 시스템 프롬프트에 중복하면 토큰만 낭비됩니다.</li>
</ul>

<ol>
  <li>툴이 많을 때는 “짧은 브리핑”만 추가</li>
</ol>

<ul>
  <li>
    <p>매 요청마다 관련 Top-K 툴만 선별해, 이름·한줄설명·필수 파라미터만 1~2줄씩 요약한 브리핑을 시스템 프롬프트 뒤에 덧붙이면 선택 정확도가 올라갑니다.</p>
  </li>
  <li>
    <p>길이 가이드: 6~12개 이하, 줄당 1문장, 총 10~15줄 이내.</p>
  </li>
</ul>

<ol>
  <li>언제 브리핑도 생략하나</li>
</ol>

<ul>
  <li>
    <p>툴 수가 적고 이름·설명이 명확할 때.</p>
  </li>
  <li>
    <p>컨텍스트가 촉박하거나 응답 지연을 최소화해야 할 때.</p>
  </li>
  <li>
    <p>이미 이전 턴들에서 모델이 올바르게 툴을 사용 중일 때.</p>
  </li>
</ul>

<p>추천 기본 셋업(지금 노드 설계 기준)</p>

<ul>
  <li>
    <p>시스템 프롬프트 기본값: 아주 짧은 정책 4줄 정도.</p>
  </li>
  <li>
    <p>tools 파라미터: 모든 툴의 JSON 스키마.</p>
  </li>
  <li>
    <p>자동 브리핑: Heuristic Top-K로 6~12개만, 한 줄 요약.</p>
  </li>
  <li>
    <p>겹치는 정보(스키마 본문)를 시스템 프롬프트에 복붙하지 않기.</p>
  </li>
</ul>

<p>샘플 시스템 프롬프트(짧은 정책 템플릿)</p>

<ul>
  <li>
    <p>필요 시에만 툴을 사용한다. 파일/네트워크 등 내용이 필요하면 반드시 해당 툴을 호출하고 추측하지 않는다.</p>
  </li>
  <li>
    <p>툴 파라미터는 스키마에 맞게 정확히 채운다. base_dir 밖 경로는 요청하지 않는다.</p>
  </li>
  <li>
    <p>오류가 나면 원인과 다음 시도를 간결히 제안한다(예: 경로 수정·인코딩 변경 등).</p>
  </li>
  <li>
    <p>출력은 한국어로 간결하게, 중간 사고과정은 노출하지 않는다.</p>
  </li>
</ul>

<p>샘플 브리핑(자동 생성 예)</p>

<ol>
  <li>
    <p>list_files_in_folder: 폴더의 파일명을 나열 (required: folder_path)</p>
  </li>
  <li>
    <p>read_text_file: 텍스트 파일을 읽어 반환 (required: file_path)</p>
  </li>
  <li>
    <p>write_text_file: 텍스트를 파일로 저장 (required: file_path, content)</p>
  </li>
</ol>

<p>실무 팁</p>

<ul>
  <li>
    <p>브리핑의 효과는 “툴 선택 정확도↑, 재시도↓”에서 가장 큽니다. 다만 브리핑이 길어지면 반대로 혼란/비용이 늘 수 있으니 Top-K로 제한하세요.</p>
  </li>
  <li>
    <p>모델을 바꿔도 이 원칙은 유효합니다. 시스템 프롬프트에는 규칙, tools에는 스키마, 브리핑은 짧게 필요한 것만.</p>
  </li>
  <li>
    <p>여러분이 만든 자동 필터링/브리핑 옵션을 기본 ON, 길이는 보수적으로 두고(예: 8~12개) 상황에 맞게만 확장하세요.</p>
  </li>
</ul>

<p class="chat--user">

그럼 유저가 안 써도 기본적으로 다 넣는게 좋단 말인가? 그냥 api 에만 툴 선언하고 쓰면 안돼?

</p>

<p>짧게 답하면: “API에 툴만 등록해도 보통 잘 동작한다.” 다만 기본적인 “툴 사용 정책” 3–5줄을 시스템 프롬프트에 항상 얹어두면, 모델/툴이 많아질수록 선택 정확도와 안정성이 올라가는 편이야. 툴 스키마 자체를 시스템 프롬프트에 복붙하는 건 비효율이니 피하고.</p>

<p>권장 기본 전략</p>

<ol>
  <li>
    <p>항상 API의 tools 파라미터로 스키마를 전달한다. 여기서가 진짜 근거다.</p>
  </li>
  <li>
    <p>시스템 프롬프트에는 정책만 아주 짧게 넣는다. 예시:</p>

    <ul>
      <li>
        <p>필요한 경우에만 툴을 호출한다.</p>
      </li>
      <li>
        <p>파일/네트워크 등 내용이 필요하면 추측하지 말고 해당 툴을 호출한다.</p>
      </li>
      <li>
        <p>툴 파라미터는 스키마에 맞춘다.</p>
      </li>
      <li>
        <p>보안 제약(예: base_dir 밖 접근 금지)을 지킨다.</p>
      </li>
      <li>
        <p>한국어로 간결히 답한다.</p>
      </li>
    </ul>
  </li>
  <li>
    <p>툴이 많을 때만 짧은 브리핑을 자동으로 추가한다. Top-K 이름+한줄 설명+필수 파라미터 정도로 6–12줄. 스키마 중복 금지.</p>
  </li>
  <li>
    <p>툴이 5개 이하면 브리핑 생략해도 무방하다.</p>
  </li>
</ol>

<p>언제 “API에만 툴 선언”으로 충분하나</p>

<ul>
  <li>
    <p>툴 수가 적고 이름·설명이 명확할 때</p>
  </li>
  <li>
    <p>반복 사용 중이라 모델이 이미 올바르게 호출하는 패턴이 잡혔을 때</p>
  </li>
  <li>
    <p>지연시간·토큰 비용을 최소화해야 할 때</p>
  </li>
</ul>

<p>언제 “짧은 정책 + 브리핑”이 체감 효과가 크나</p>

<ul>
  <li>
    <p>툴이 10개 이상으로 늘고, 일부가 이름/설명이 비슷할 때</p>
  </li>
  <li>
    <p>외부 모델(벤더별)로 바꾸면서 도구 호출 성향이 달라질 때</p>
  </li>
  <li>
    <p>사용자가 모호한 요청을 자주 던질 때</p>
  </li>
</ul>

<p>지금 네 노드 설계에 바로 적용하는 디폴트</p>

<ul>
  <li>
    <p>Provider의 system_prompt_default에 3–5줄 정책을 넣는다.</p>
  </li>
  <li>
    <p>AdvancedOptions 기본값을 다음처럼 두는 걸 추천.</p>

    <ul>
      <li>
        <p>tool_filter_mode: heuristic</p>
      </li>
      <li>
        <p>tool_filter_max: 32</p>
      </li>
      <li>
        <p>auto_tool_brief: True</p>
      </li>
      <li>
        <p>max_brief_tools: 8~12</p>
      </li>
    </ul>
  </li>
  <li>
    <p>툴이 5개 이하이면 auto_tool_brief를 False로 꺼도 좋다.</p>
  </li>
</ul>

<p>운영 중 점검 지표</p>

<ul>
  <li>
    <p>잘못된 툴 호출율(없는 툴명, 누락된 required 파라미터)</p>
  </li>
  <li>
    <p>평균 라운드 수(재시도 횟수)</p>
  </li>
  <li>
    <p>토큰/지연시간</p>
  </li>
  <li>
    <p>작업 성공률(휴먼 평가)</p>
  </li>
</ul>

<p>정리<br />
그냥 tools만 API로 넘겨도 “대체로” 된다. 하지만 기본 정책 몇 줄은 싸게 가져가는 품질 보험이고, 툴이 많아지는 순간 짧은 브리핑이 유효하다. 결론적으로 “툴 스키마는 API에, 정책은 시스템 프롬프트에, 브리핑은 필요할 때만”이 가장 비용 대비 성과가 좋은 셋업이다.</p>

<p class="chat--user">

dataclass와 pydandic model 차이

</p>

<p>다음은 Python 표준 <code class="language-plaintext highlighter-rouge">dataclass</code>와 Pydantic의 <code class="language-plaintext highlighter-rouge">BaseModel</code>(v2 기준)을 비교·정리한 거야. 실무에서 어느 걸 쓰면 좋은지까지 짚었어.</p>

<h1 id="핵심-차이-요약">핵심 차이 요약</h1>

<table>
  <thead>
    <tr>
      <th>항목</th>
      <th>dataclass (표준 라이브러리)</th>
      <th>Pydantic BaseModel (외부 패키지)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>목적</td>
      <td>경량 데이터 컨테이너</td>
      <td>입력 검증·변환 + 직렬화·스키마</td>
    </tr>
    <tr>
      <td>타입 체크</td>
      <td>정적 힌트만, 런타임 검증 없음</td>
      <td>런타임 검증·변환(엄격/관대한 모드)</td>
    </tr>
    <tr>
      <td>기본값</td>
      <td><code class="language-plaintext highlighter-rouge">field(default, default_factory)</code></td>
      <td><code class="language-plaintext highlighter-rouge">Field(default, default_factory, alias, description…)</code></td>
    </tr>
    <tr>
      <td>불변/슬롯</td>
      <td><code class="language-plaintext highlighter-rouge">frozen=True</code>, <code class="language-plaintext highlighter-rouge">slots=True</code> 지원</td>
      <td><code class="language-plaintext highlighter-rouge">ConfigDict(frozen=True)</code> 등 설정</td>
    </tr>
    <tr>
      <td>직렬화</td>
      <td><code class="language-plaintext highlighter-rouge">asdict</code>, <code class="language-plaintext highlighter-rouge">astuple</code></td>
      <td><code class="language-plaintext highlighter-rouge">model_dump</code>, <code class="language-plaintext highlighter-rouge">model_dump_json</code>, 별칭/필드제외 등 풍부</td>
    </tr>
    <tr>
      <td>스키마</td>
      <td>없음</td>
      <td>JSON Schema 자동 생성</td>
    </tr>
    <tr>
      <td>중첩 모델</td>
      <td>가능(검증 없음)</td>
      <td>깊은 중첩 검증·변환</td>
    </tr>
    <tr>
      <td>밸리데이터</td>
      <td>직접 코드 작성</td>
      <td><code class="language-plaintext highlighter-rouge">@field_validator</code>, <code class="language-plaintext highlighter-rouge">@model_validator</code></td>
    </tr>
    <tr>
      <td>성능/오버헤드</td>
      <td>매우 적음</td>
      <td>검증 비용 존재(대신 안전성↑)</td>
    </tr>
    <tr>
      <td>설정/환경</td>
      <td>없음</td>
      <td>설정용 모델(pydantic-settings)과 궁합</td>
    </tr>
  </tbody>
</table>

<h1 id="사용-기준-한-줄-가이드">사용 기준 한 줄 가이드</h1>

<ul>
  <li>
    <p>“신뢰된 내부 데이터, 간단한 DTO” → dataclass.</p>
  </li>
  <li>
    <p>“외부 입력(요청 바디/환경변수/파일/DB) 검증 필요” → Pydantic.</p>
  </li>
</ul>

<h1 id="코드-비교">코드 비교</h1>

<p>간단 예시: 사용자 입력을 받아 나이와 이메일을 담는다.</p>

<p>dataclass: 타입 힌트는 있지만 잘못된 값이 들어와도 자동 검증 안 함.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">asdict</span>

<span class="nd">@dataclass</span><span class="p">(</span><span class="n">slots</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">User</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">age</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">email</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="nf">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="sh">""</span><span class="p">)</span>

<span class="n">u</span> <span class="o">=</span> <span class="nc">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">Alice</span><span class="sh">"</span><span class="p">,</span> <span class="n">age</span><span class="o">=</span><span class="sh">"</span><span class="s">20</span><span class="sh">"</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="sh">"</span><span class="s">alice@example.com</span><span class="sh">"</span><span class="p">)</span>  <span class="c1"># 런타임 검증 없음. age는 str 들어와도 그대로.
</span><span class="nf">print</span><span class="p">(</span><span class="nf">asdict</span><span class="p">(</span><span class="n">u</span><span class="p">))</span>  <span class="c1"># {'name': 'Alice', 'age': '20', 'email': 'alice@example.com'}
</span></code></pre></div></div>

<p>Pydantic: 자동 변환·검증, 제약 조건·밸리데이터를 쉽게 부착.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span><span class="p">,</span> <span class="n">EmailStr</span><span class="p">,</span> <span class="n">ConfigDict</span><span class="p">,</span> <span class="n">field_validator</span>

<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">model_config</span> <span class="o">=</span> <span class="nc">ConfigDict</span><span class="p">(</span><span class="n">validate_assignment</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">str_strip_whitespace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">age</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
    <span class="n">email</span><span class="p">:</span> <span class="n">EmailStr</span> <span class="o">=</span> <span class="sh">""</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">non_empty</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">name must not be empty</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>

<span class="n">u</span> <span class="o">=</span> <span class="nc">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">  Alice  </span><span class="sh">"</span><span class="p">,</span> <span class="n">age</span><span class="o">=</span><span class="sh">"</span><span class="s">20</span><span class="sh">"</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="sh">"</span><span class="s">alice@example.com</span><span class="sh">"</span><span class="p">)</span>  <span class="c1"># "20" → 20으로 변환
</span><span class="nf">print</span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">())</span>  <span class="c1"># {'name': 'Alice', 'age': 20, 'email': 'alice@example.com'}
</span><span class="n">u</span><span class="p">.</span><span class="n">age</span> <span class="o">=</span> <span class="mi">999</span>  <span class="c1"># validate_assignment로 즉시 오류 발생
</span></code></pre></div></div>

<h1 id="직렬화스키마별칭">직렬화·스키마·별칭</h1>

<ul>
  <li>
    <p>dataclass: 기본 <code class="language-plaintext highlighter-rouge">asdict</code>만. 필드 숨김/별칭, JSON 스키마는 직접 구현해야 함.</p>
  </li>
  <li>
    <p>Pydantic:</p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">model_dump(exclude=…, by_alias=True)</code> 같은 고급 옵션.</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">model_json_schema()</code>로 OpenAPI/JSON Schema 생성.</p>
      </li>
      <li>
        <p>필드 별칭, 설명, 예시 등 문서화 메타데이터 손쉽게 부여.</p>
      </li>
    </ul>
  </li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>

<span class="k">class</span> <span class="nc">Item</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">alias</span><span class="o">=</span><span class="sh">"</span><span class="s">item_id</span><span class="sh">"</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Public ID</span><span class="sh">"</span><span class="p">)</span>

<span class="n">item</span> <span class="o">=</span> <span class="nc">Item</span><span class="p">(</span><span class="n">item_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">(</span><span class="n">by_alias</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>  <span class="c1"># {'item_id': 1}
</span><span class="nf">print</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="nf">model_json_schema</span><span class="p">()[</span><span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">item_id</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">])</span>
</code></pre></div></div>

<h1 id="불변성슬롯성능">불변성/슬롯/성능</h1>

<ul>
  <li>
    <p>dataclass는 <code class="language-plaintext highlighter-rouge">frozen=True</code>, <code class="language-plaintext highlighter-rouge">slots=True</code>로 매우 가볍게 동작.</p>
  </li>
  <li>
    <p>Pydantic도 <code class="language-plaintext highlighter-rouge">ConfigDict(frozen=True)</code> 가능하지만, 검증/변환 코스트가 있어 순수한 속도는 dataclass가 유리.</p>
  </li>
</ul>

<h1 id="혼합-사용-팁">혼합 사용 팁</h1>

<ul>
  <li>Pydantic v2는 <code class="language-plaintext highlighter-rouge">pydantic.dataclasses.dataclass</code> 데코레이터도 제공해서 dataclass에 검증을 입힐 수 있어.<br />
“대부분 dataclass지만 몇 필드만 검증 필요” 같은 케이스에 유용.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">pydantic.dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">ConfigDict</span>

<span class="nd">@dataclass</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="nc">ConfigDict</span><span class="p">(</span><span class="n">validate_assignment</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
<span class="k">class</span> <span class="nc">Config</span><span class="p">:</span>
    <span class="n">port</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">host</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">127.0.0.1</span><span class="sh">"</span>

<span class="n">c</span> <span class="o">=</span> <span class="nc">Config</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="sh">"</span><span class="s">8000</span><span class="sh">"</span><span class="p">)</span>  <span class="c1"># "8000" → 8000으로 변환
</span></code></pre></div></div>

<h1 id="결정-트리">결정 트리</h1>

<ol>
  <li>외부 입력을 받아야 하나?</li>
</ol>

<ul>
  <li>예: API 바디, 폼, ENV, 파일, 메시지 큐 → Pydantic</li>
</ul>

<ol>
  <li>내부에서 생성·소비되는 단순 DTO인가?</li>
</ol>

<ul>
  <li>성능·단순성이 중요 → dataclass</li>
</ul>

<ol>
  <li>문서화/스키마/별칭/엄격한 제약이 필요한가?</li>
</ol>

<ul>
  <li>필요 → Pydantic</li>
</ul>

<ol>
  <li>둘 다 쓰고 싶다?</li>
</ol>

<ul>
  <li>기본은 dataclass, 경계(입출력)에서만 Pydantic으로 검증 후 내부로는 dataclass 변환 사용도 좋다.</li>
</ul>

<p>정리하면, dataclass는 “가볍고 빠른 컨테이너”, Pydantic은 “신뢰할 수 있는 입력계 검증기 + 직렬화 도구”야. 프로젝트에서 외부 데이터와 맞닿는 부분만 Pydantic으로 감싸고, 내부 도메인 모델은 dataclass로 두면 유지보수와 성능 균형이 잘 맞는 경우가 많다.</p>

<p class="chat--user">

아니 근데 ToolSpec에 category랑 tag는 왜 넣어놨어? 이게 LLM이 전달이 되는 것도 아닌것 같은데

</p>

<p>짧게 말하면, 맞아요. <code class="language-plaintext highlighter-rouge">category</code>와 <code class="language-plaintext highlighter-rouge">tags</code>는 기본 <code class="language-plaintext highlighter-rouge">tools</code> JSON에는 안 들어가서 LLM에 “직접” 전달되진 않아요. 넣어둔 이유는 런타임 오케스트레이션(사전 선택·정책·로깅)과 “간접 전달(브리핑)”에 쓰려고 했기 때문이에요.</p>

<p>왜 필요하냐</p>

<ol>
  <li>대규모 툴 셋 선별</li>
</ol>

<ul>
  <li>
    <p>툴이 10~100개로 늘면 전부 모델에 던지기보단, 사용자 프롬프트와의 간단한 유사도 점수로 Top-K만 고르는 게 안정적이에요. 이때 툴 이름·설명만 쓰면 구분이 부족해서, <code class="language-plaintext highlighter-rouge">category/tags</code>까지 가중치에 포함하면 선별 정확도가 올라가요.</p>
  </li>
  <li>
    <p>코드에서 <code class="language-plaintext highlighter-rouge">score_tool_relevance()</code>가 name/description/parameters 외에 <code class="language-plaintext highlighter-rouge">category/tags</code>도 함께 사용합니다.</p>
  </li>
</ul>

<ol>
  <li>정책·권한·보안 게이팅</li>
</ol>

<ul>
  <li>
    <p>운영/프로덕션에서 “filesystem:write” 카테고리는 막고 “filesystem:read”만 허용 같은 정책을 쉽게 걸 수 있어요. 툴 메타가 있으면 allowlist/denylist가 간단해집니다.</p>
  </li>
  <li>
    <p>예: <code class="language-plaintext highlighter-rouge">allowed_categories = {"filesystem:read","analytics"}</code>로 필터링.</p>
  </li>
</ul>

<ol>
  <li>브리핑으로 간접 전달</li>
</ol>

<ul>
  <li>시스템 프롬프트에 “툴 전체 스키마”를 복붙하지는 않지만, 자동 툴 브리핑을 만들 때 <code class="language-plaintext highlighter-rouge">[filesystem] list_files_in_folder: …</code>처럼 <code class="language-plaintext highlighter-rouge">category</code>를 표시해서 모델이 선택을 덜 헷갈리게 합니다. 즉, <code class="language-plaintext highlighter-rouge">category/tags</code>는 “브리핑 텍스트”에 녹아 LLM에 간접적으로 전달됩니다.</li>
</ul>

<ol>
  <li>운영 가시성·로깅·A/B</li>
</ol>

<ul>
  <li>호출 로그에서 “어떤 카테고리의 툴을 얼마나 선택했는지”를 바로 집계할 수 있어요. 카테고리 기반으로 성공/실패율, 재시도율, 토큰 비용 등을 비교하기 좋습니다.</li>
</ul>

<p>원한다면 LLM에 직접 태그를 “보이게” 만드는 방법</p>

<ul>
  <li>
    <p>가장 간단한 방법은 빌드 타이밍에 description에 합쳐 넣는 거예요. 예: <code class="language-plaintext highlighter-rouge">description = f"[{category}] {description} (tags: {', '.join(tags)})"</code>. 이렇게 하면 tools JSON 자체에 반영되어 모델이 그대로 봅니다.</p>
  </li>
  <li>
    <p>혹은 자동 브리핑에 태그까지 노출하도록 한 줄을 바꾸면 됩니다. 지금 코드는 <code class="language-plaintext highlighter-rouge">[category]</code>만 넣지만 <code class="language-plaintext highlighter-rouge">tags</code>도 덧붙이도록 해도 돼요.</p>
  </li>
</ul>

<p>원치 않으면 지워도 되나</p>

<ul>
  <li>네. 툴이 몇 개 안 되고, 정책/선별/로깅 요구가 없으면 <code class="language-plaintext highlighter-rouge">category/tags</code>를 빼도 됩니다. 그 대신 나중에 커질 때를 대비해 <code class="language-plaintext highlighter-rouge">metadata: dict</code> 하나만 남겨 두는 것도 방법입니다.</li>
</ul>

<p>작게 손보는 예시</p>

<ul>
  <li>브리핑에 태그까지 보여 주기:</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">build_tool_briefing</span><span class="p">(</span><span class="n">tools</span><span class="p">,</span> <span class="n">max_lines</span><span class="o">=</span><span class="mi">12</span><span class="p">):</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">tools</span><span class="p">[:</span><span class="n">max_lines</span><span class="p">],</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">parameters</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">parameters</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">cat</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[</span><span class="si">{</span><span class="n">t</span><span class="p">.</span><span class="n">category</span><span class="si">}</span><span class="s">] </span><span class="sh">"</span> <span class="k">if</span> <span class="n">t</span><span class="p">.</span><span class="n">category</span> <span class="k">else</span> <span class="sh">""</span>
        <span class="n">tagline</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s"> tags=</span><span class="si">{</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">tags</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span> <span class="k">if</span> <span class="n">t</span><span class="p">.</span><span class="n">tags</span> <span class="k">else</span> <span class="sh">""</span>
        <span class="n">line</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s">. </span><span class="si">{</span><span class="n">cat</span><span class="si">}{</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">t</span><span class="p">.</span><span class="n">description</span><span class="si">}{</span><span class="n">tagline</span><span class="si">}</span><span class="sh">"</span>
        <span class="k">if</span> <span class="n">req</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="sa">f</span><span class="sh">"</span><span class="s"> (required: </span><span class="si">{</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">req</span><span class="p">[</span><span class="si">:</span><span class="mi">3</span><span class="p">])</span><span class="si">}</span><span class="s">)</span><span class="sh">"</span>
        <span class="n">lines</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="k">return</span> <span class="sh">"</span><span class="s">TOOL BRIEFING</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="s">END TOOL BRIEFING</span><span class="sh">"</span> <span class="k">if</span> <span class="n">lines</span> <span class="k">else</span> <span class="sh">""</span>
</code></pre></div></div>

<ul>
  <li>정책 게이팅(예: 쓰기 금지):</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">gate_tools</span><span class="p">(</span><span class="n">tools</span><span class="p">,</span> <span class="n">deny_categories</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">filesystem:write</span><span class="sh">"</span><span class="p">}):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span> <span class="nf">if </span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">category</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">deny_categories</span><span class="p">]</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">run_with_provider()</code> 들어가기 전에 <code class="language-plaintext highlighter-rouge">tools = gate_tools(tools)</code> 한 줄이면 끝.</p>

<p>정리</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">category/tags</code>는 LLM에 “직접” 가는 필드는 아니고, 툴 선별·정책·로깅·브리핑을 위한 메타데이터입니다.</p>
  </li>
  <li>
    <p>브리핑을 쓰면 간접적으로 모델 판단에 도움을 주고, 필요하면 description에 합쳐 “직접” 보이게도 만들 수 있어요.</p>
  </li>
  <li>
    <p>요구가 단순하면 빼도 무방하지만, 툴이 늘어날수록 이 메타가 운영 품질과 유지보수에 큰 도움이 됩니다.</p>
  </li>
</ul>

<p class="chat--user">

넣었다쳐도 그걸 입력으로 받는건 좀 많이 이상하지 않아?

</p>

<p>맞아, 툴을 만드는 노드에서 <code class="language-plaintext highlighter-rouge">category</code>/<code class="language-plaintext highlighter-rouge">tags</code>를 “사용자 입력”으로 받는 건 UX상 어색해. 그 필드는 LLM에 직접 전달되지도 않고, 주로 오케스트레이션(선별·정책·로그) 용 메타데이터라서 내부적으로 자동 추론하거나 필요할 때만 별도 주석 노드로 덧씌우는 게 깔끔해.</p>

<p>정리</p>

<ol>
  <li>
    <p>툴 노드에서는 <code class="language-plaintext highlighter-rouge">category</code>/<code class="language-plaintext highlighter-rouge">tags</code> 입력을 아예 없앤다.</p>
  </li>
  <li>
    <p>노드 내부에서 도구명·설명·스키마를 기반으로 가벼운 휴리스틱으로 자동 추론한다.<br />
예: <code class="language-plaintext highlighter-rouge">read_*/list_*</code> → <code class="language-plaintext highlighter-rouge">filesystem:read</code>, <code class="language-plaintext highlighter-rouge">write_*/save_*</code> → <code class="language-plaintext highlighter-rouge">filesystem:write</code> 등.</p>
  </li>
  <li>
    <p>정말 필요할 때만 “주석(annotate) 노드”로 선택 툴에 메타데이터를 덧입힌다.<br />
이렇게 하면 기본 흐름은 단순하고, 규모가 커질 때만 메타 관리가 개입된다.</p>
  </li>
</ol>

<p>아래는 그렇게 바꾸는 최소 변경 코드 조각이야. 전체 파일 갈아엎을 필요 없이 이 부분만 교체하면 돼.</p>

<p>코드: 메타 자동 추론 유틸</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># --- put near ToolSpec definition ---
</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Tuple</span>

<span class="k">def</span> <span class="nf">infer_tool_metadata</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">description</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">parameters</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">default_category</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]:</span>
    <span class="n">nm</span> <span class="o">=</span> <span class="p">(</span><span class="n">name</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">).</span><span class="nf">lower</span><span class="p">()</span>
    <span class="n">desc</span> <span class="o">=</span> <span class="p">(</span><span class="n">description</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">).</span><span class="nf">lower</span><span class="p">()</span>
    <span class="n">cat</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c1"># very light heuristics
</span>    <span class="k">if</span> <span class="n">nm</span><span class="p">.</span><span class="nf">startswith</span><span class="p">((</span><span class="sh">"</span><span class="s">read_</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">list_</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">stat_</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">head_</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">get_</span><span class="sh">"</span><span class="p">)):</span>
        <span class="n">cat</span> <span class="o">=</span> <span class="sh">"</span><span class="s">filesystem:read</span><span class="sh">"</span>
    <span class="k">elif</span> <span class="n">nm</span><span class="p">.</span><span class="nf">startswith</span><span class="p">((</span><span class="sh">"</span><span class="s">write_</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">save_</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">append_</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">put_</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">delete_</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">remove_</span><span class="sh">"</span><span class="p">)):</span>
        <span class="n">cat</span> <span class="o">=</span> <span class="sh">"</span><span class="s">filesystem:write</span><span class="sh">"</span>
    <span class="k">elif</span> <span class="sh">"</span><span class="s">http</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">nm</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">fetch</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">nm</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">download</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">nm</span><span class="p">:</span>
        <span class="n">cat</span> <span class="o">=</span> <span class="sh">"</span><span class="s">network</span><span class="sh">"</span>
    <span class="k">if</span> <span class="n">default_category</span><span class="p">:</span>
        <span class="n">cat</span> <span class="o">=</span> <span class="n">default_category</span>

    <span class="c1"># tags: few words from description + required keys
</span>    <span class="n">req</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">req</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">findall</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">[a-z0-9_]+</span><span class="sh">"</span><span class="p">,</span> <span class="n">desc</span><span class="p">)</span>
    <span class="n">tags</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="nb">dict</span><span class="p">.</span><span class="nf">fromkeys</span><span class="p">((</span><span class="n">tokens</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span> <span class="o">+</span> <span class="nf">list</span><span class="p">(</span><span class="n">req</span><span class="p">)[:</span><span class="mi">4</span><span class="p">])))</span>  <span class="c1"># keep order, unique, short
</span>    <span class="k">return</span> <span class="n">cat</span><span class="p">,</span> <span class="p">(</span><span class="n">tags</span> <span class="ow">or</span> <span class="bp">None</span><span class="p">)</span>
</code></pre></div></div>

<p>코드: 브리핑은 있으면만 보여 주도록 유지</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">build_tool_briefing</span><span class="p">(</span><span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">],</span> <span class="n">max_lines</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">12</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">tools</span><span class="p">[:</span><span class="n">max_lines</span><span class="p">],</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">req</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">parameters</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">parameters</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])[:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">cat</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[</span><span class="si">{</span><span class="n">t</span><span class="p">.</span><span class="n">category</span><span class="si">}</span><span class="s">] </span><span class="sh">"</span> <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">category</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">else</span> <span class="sh">""</span>
        <span class="n">line</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s">. </span><span class="si">{</span><span class="n">cat</span><span class="si">}{</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">t</span><span class="p">.</span><span class="n">description</span><span class="si">}</span><span class="sh">"</span>
        <span class="k">if</span> <span class="n">req</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="sa">f</span><span class="sh">"</span><span class="s"> (required: </span><span class="si">{</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">req</span><span class="p">)</span><span class="si">}</span><span class="s">)</span><span class="sh">"</span>
        <span class="n">lines</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="k">return</span> <span class="sh">"</span><span class="s">TOOL BRIEFING</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="s">END TOOL BRIEFING</span><span class="sh">"</span> <span class="k">if</span> <span class="n">lines</span> <span class="k">else</span> <span class="sh">""</span>
</code></pre></div></div>

<p>코드: 파일 툴 노드들에서 입력 항목에서 category/tags 제거, 내부 자동 추론 적용</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">FileListToolNode</span><span class="p">:</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List files in a folder.</span><span class="sh">"</span><span class="p">}),</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">optional</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">tools_in</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_TOOLS</span><span class="sh">"</span><span class="p">,),</span>
                <span class="sh">"</span><span class="s">base_dir</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">return_full_paths</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">BOOLEAN</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">callback</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_CALLBACK</span><span class="sh">"</span><span class="p">,),</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="bp">...</span>
    <span class="k">def</span> <span class="nf">append_tool</span><span class="p">(...):</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>  <span class="c1"># 동일
</span>        <span class="k">def</span> <span class="nf">_impl</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span> <span class="bp">...</span>
        <span class="n">cat</span><span class="p">,</span> <span class="n">tags</span> <span class="o">=</span> <span class="nf">infer_tool_metadata</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">default_category</span><span class="o">=</span><span class="sh">"</span><span class="s">filesystem:read</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="nc">ToolSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">sc</span> <span class="n">hema</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">_impl</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">cat</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">)</span>
        <span class="nf">return </span><span class="p">((</span><span class="n">tools_in</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">tools_in</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[])</span> <span class="o">+</span> <span class="p">[</span><span class="n">spec</span><span class="p">],)</span>
</code></pre></div></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">FileReadToolNode</span><span class="p">:</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a UTF-8 text file.</span><span class="sh">"</span><span class="p">}),</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">optional</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">tools_in</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_TOOLS</span><span class="sh">"</span><span class="p">,),</span>
                <span class="sh">"</span><span class="s">base_dir</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">encoding</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">callback</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_CALLBACK</span><span class="sh">"</span><span class="p">,),</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="bp">...</span>
    <span class="k">def</span> <span class="nf">append_tool</span><span class="p">(...):</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
        <span class="k">def</span> <span class="nf">_impl</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span> <span class="bp">...</span>
        <span class="n">cat</span><span class="p">,</span> <span class="n">tags</span> <span class="o">=</span> <span class="nf">infer_tool_metadata</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">default_category</span><span class="o">=</span><span class="sh">"</span><span class="s">filesystem:read</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="nc">ToolSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">_impl</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">cat</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">)</span>
        <span class="nf">return </span><span class="p">((</span><span class="n">tools_in</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">tools_in</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[])</span> <span class="o">+</span> <span class="p">[</span><span class="n">spec</span><span class="p">],)</span>
</code></pre></div></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">FileWriteToolNode</span><span class="p">:</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">write_text_file</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Write text to a file (creates dirs).</span><span class="sh">"</span><span class="p">}),</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">optional</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">tools_in</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_TOOLS</span><span class="sh">"</span><span class="p">,),</span>
                <span class="sh">"</span><span class="s">base_dir</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">encoding</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">append</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">BOOLEAN</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">callback</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_CALLBACK</span><span class="sh">"</span><span class="p">,),</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="bp">...</span>
    <span class="k">def</span> <span class="nf">append_tool</span><span class="p">(...):</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
        <span class="k">def</span> <span class="nf">_impl</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span> <span class="bp">...</span>
        <span class="n">cat</span><span class="p">,</span> <span class="n">tags</span> <span class="o">=</span> <span class="nf">infer_tool_metadata</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">default_category</span><span class="o">=</span><span class="sh">"</span><span class="s">filesystem:write</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="nc">ToolSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">_impl</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">cat</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">)</span>
        <span class="nf">return </span><span class="p">((</span><span class="n">tools_in</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">tools_in</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[])</span> <span class="o">+</span> <span class="p">[</span><span class="n">spec</span><span class="p">],)</span>
</code></pre></div></div>

<p>선택 사항: 필요 시에만 메타데이터를 덧입히는 주석 노드</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">OpenAIToolAnnotateNode</span><span class="p">:</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">tools_in</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_TOOLS</span><span class="sh">"</span><span class="p">,),</span>
                <span class="sh">"</span><span class="s">name_regex</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">.*</span><span class="sh">"</span><span class="p">}),</span>         <span class="c1"># 대상 선택
</span>            <span class="p">},</span>
            <span class="sh">"</span><span class="s">optional</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">category</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">tags_csv</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}),</span>             <span class="c1"># "foo,bar,baz"
</span>            <span class="p">}</span>
        <span class="p">}</span>
    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_TOOLS</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">annotate</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OpenAI/Tools</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">annotate</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tools_in</span><span class="p">,</span> <span class="n">name_regex</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="sh">""</span><span class="p">,</span> <span class="n">tags_csv</span><span class="o">=</span><span class="sh">""</span><span class="p">):</span>
        <span class="kn">import</span> <span class="n">re</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">tools_in</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="nf">return </span><span class="p">([],)</span>
        <span class="n">rx</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="n">name_regex</span><span class="p">)</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tags_csv</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="p">)]</span> <span class="k">if</span> <span class="n">tags_csv</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span> <span class="k">else</span> <span class="bp">None</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools_in</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">rx</span><span class="p">.</span><span class="nf">fullmatch</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">category</span><span class="p">.</span><span class="nf">strip</span><span class="p">():</span>
                    <span class="n">t</span><span class="p">.</span><span class="n">category</span> <span class="o">=</span> <span class="n">category</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">tags</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">t</span><span class="p">.</span><span class="n">tags</span> <span class="o">=</span> <span class="n">tags</span> <span class="ow">or</span> <span class="bp">None</span>
            <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">out</span><span class="p">,)</span>
</code></pre></div></div>

<p>왜 이게 좋은가</p>

<ol>
  <li>
    <p>기본 UX가 단순해진다. 툴 노드는 본질 입력만 받고, 메타는 자동으로 붙는다.</p>
  </li>
  <li>
    <p>메타는 운영 기능(선별·정책·로그)에만 쓰이며 LLM에 강제 노출되지 않는다.</p>
  </li>
  <li>
    <p>필요할 때만 주석 노드로 덧씌울 수 있어 확장이 쉽다.</p>
  </li>
  <li>
    <p>메타가 없어도 기존 휴리스틱(이름·설명·스키마 기반 Top-K 선별)이 돌아가므로 안전한 디폴트다.</p>
  </li>
</ol>

<p>요약</p>

<ul>
  <li>
    <p>네 말이 맞다. category/tags를 “노드 입력”으로 받는 건 과도하다.</p>
  </li>
  <li>
    <p>코어 툴 노드에서는 입력에서 제거하고, 내부에서 자동 추론하자.</p>
  </li>
  <li>
    <p>정말 필요한 경우에만 별도 “Annotate” 노드로 주석을 덧입히는 하이브리드가 가장 깔끔하고 운영 친화적이다.</p>
  </li>
</ul>

<p class="chat--user">

아니 name이랑 description도 그래. 그걸 왜 입력으로 받냐고

</p>

<p>맞아. 일반 사용자에게 name/description을 매번 입력시키는 건 UX상 불필요하고, 실수도 유발해. 툴은 노드의 설정으로부터 자동으로 “함수 이름”과 “짧은 설명”을 만들고, 정말 필요할 때만 덮어쓰는 옵셔널 입력을 두는 게 가장 깔끔해.</p>

<p>아래처럼 바꾸면 돼.</p>

<ol>
  <li>원칙</li>
</ol>

<ul>
  <li>
    <p>LLM이 실제로 선택하는 건 툴의 function name이므로, 이름은 안정적·고유해야 한다.</p>
  </li>
  <li>
    <p>이름과 설명은 노드 입력에서 제거하고, 노드 설정값을 해시해 자동 생성한다.</p>
  </li>
  <li>
    <p>필요 시에만 optional override를 제공한다(없으면 전부 자동값 사용).</p>
  </li>
  <li>
    <p>이름은 짧고 스키마 중심, 설명은 한 줄 요약만. 상세는 tools JSON의 parameters가 담당.</p>
  </li>
</ul>

<ol>
  <li>자동 생성 규칙</li>
</ol>

<ul>
  <li>
    <p>이름: {prefix}_{short_hash(config)} 형식, 소문자+숫자+밑줄만, 길이 제한.</p>
  </li>
  <li>
    <p>설명: 동작 1문장 + 중요 파라미터 힌트 1문장.</p>
  </li>
  <li>
    <p>해시는 base_dir·encoding·append 등 노드 설정을 json.dumps(sort_keys=True) 후 SHA1 8자.</p>
  </li>
</ul>

<ol>
  <li>코드 변경점만 제시<br />
아래 조각을 기존 파일에 추가/교체하면 된다. 다른 부분은 그대로 유지해도 된다.</li>
</ol>

<p>헬퍼: 이름/설명 생성</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">hashlib</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">re</span>

<span class="k">def</span> <span class="nf">_slug_fn_name</span><span class="p">(</span><span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">max_len</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">48</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">raw</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span> <span class="ow">or</span> <span class="p">{},</span> <span class="n">sort_keys</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">hashlib</span><span class="p">.</span><span class="nf">sha1</span><span class="p">(</span><span class="n">raw</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)).</span><span class="nf">hexdigest</span><span class="p">()[:</span><span class="mi">8</span><span class="p">]</span>
    <span class="n">base</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="n">h</span><span class="si">}</span><span class="sh">"</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span>
    <span class="n">base</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">sub</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">[^a-z0-9_]</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">_</span><span class="sh">"</span><span class="p">,</span> <span class="n">base</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">base</span><span class="p">[:</span><span class="n">max_len</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">_auto_desc</span><span class="p">(</span><span class="n">base</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">hints</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="n">base</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">hints</span><span class="p">:</span>
        <span class="n">parts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">h</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hints</span> <span class="k">if</span> <span class="n">h</span><span class="p">]))</span>
    <span class="k">return</span> <span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">parts</span><span class="p">).</span><span class="nf">strip</span><span class="p">()</span>
</code></pre></div></div>

<p>FileListToolNode: name/description 입력 제거, 자동 생성 + 선택적 override</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">FileListToolNode</span><span class="p">:</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{},</span>
            <span class="sh">"</span><span class="s">optional</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">tools_in</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_TOOLS</span><span class="sh">"</span><span class="p">,),</span>
                <span class="sh">"</span><span class="s">base_dir</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">return_full_paths</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">BOOLEAN</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">callback</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_CALLBACK</span><span class="sh">"</span><span class="p">,),</span>
                <span class="sh">"</span><span class="s">function_name_override</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">description_override</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}),</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_TOOLS</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">append_tool</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OpenAI/Tools</span><span class="sh">"</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_safe_join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">base_dir</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">base_dir</span><span class="p">)</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">target</span> <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">commonpath</span><span class="p">([</span><span class="n">base</span><span class="p">,</span> <span class="n">target</span><span class="p">])</span> <span class="o">==</span> <span class="n">base</span> <span class="k">else</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">append_tool</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tools_in</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">base_dir</span><span class="o">=</span><span class="sh">""</span><span class="p">,</span> <span class="n">return_full_paths</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                    <span class="n">function_name_override</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span><span class="p">,</span> <span class="n">description_override</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span><span class="p">):</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Folder path (relative to base_dir if set).</span><span class="sh">"</span><span class="p">},</span>
                <span class="sh">"</span><span class="s">pattern</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Optional glob, e.g. *.txt</span><span class="sh">"</span><span class="p">},</span>
                <span class="sh">"</span><span class="s">absolute</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">boolean</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Force absolute paths override.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">}</span>

        <span class="k">def</span> <span class="nf">_impl</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
            <span class="n">folder</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">))</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">pattern</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">))</span>
            <span class="n">absolute</span> <span class="o">=</span> <span class="nf">bool</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">absolute</span><span class="sh">"</span><span class="p">,</span> <span class="n">return_full_paths</span><span class="p">))</span>
            <span class="n">resolved</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_safe_join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">folder</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">resolved</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isdir</span><span class="p">(</span><span class="n">resolved</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">callback</span><span class="p">:</span> <span class="n">callback</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_error</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span> <span class="sh">"</span><span class="s">reason</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">invalid_folder</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">folder</span><span class="sh">"</span><span class="p">:</span> <span class="n">folder</span><span class="p">})</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
            <span class="kn">import</span> <span class="n">glob</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">resolved</span><span class="p">,</span> <span class="n">pattern</span><span class="p">)</span> <span class="k">if</span> <span class="n">pattern</span> <span class="k">else</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">resolved</span><span class="p">,</span> <span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">.</span><span class="nf">glob</span><span class="p">(</span><span class="n">g</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">p</span><span class="p">)]</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">if</span> <span class="n">absolute</span> <span class="k">else</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">basename</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">callback</span><span class="p">:</span> <span class="n">callback</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_done</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span> <span class="sh">"</span><span class="s">count</span><span class="sh">"</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">out</span><span class="p">)})</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">out</span><span class="p">)}</span>

        <span class="n">auto_name_payload</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">base_dir</span><span class="sh">"</span><span class="p">:</span> <span class="n">base_dir</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">return_full_paths</span><span class="sh">"</span><span class="p">:</span> <span class="nf">bool</span><span class="p">(</span><span class="n">return_full_paths</span><span class="p">),</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list</span><span class="sh">"</span><span class="p">}</span>
        <span class="n">fn_name</span> <span class="o">=</span> <span class="n">function_name_override</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span> <span class="ow">or</span> <span class="nf">_slug_fn_name</span><span class="p">(</span><span class="sh">"</span><span class="s">list_files</span><span class="sh">"</span><span class="p">,</span> <span class="n">auto_name_payload</span><span class="p">)</span>
        <span class="n">desc</span> <span class="o">=</span> <span class="n">description_override</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span> <span class="ow">or</span> <span class="nf">_auto_desc</span><span class="p">(</span>
            <span class="sh">"</span><span class="s">List files in a folder.</span><span class="sh">"</span><span class="p">,</span>
            <span class="p">[</span><span class="sa">f</span><span class="sh">"</span><span class="s">Returns </span><span class="si">{</span><span class="sh">'</span><span class="s">absolute</span><span class="sh">'</span> <span class="k">if</span> <span class="n">return_full_paths</span> <span class="k">else</span> <span class="sh">'</span><span class="s">basename</span><span class="sh">'</span><span class="si">}</span><span class="s"> paths.</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">Required: folder_path.</span><span class="sh">"</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># 메타 자동 추론(선택): 읽기 카테고리
</span>        <span class="n">cat</span><span class="p">,</span> <span class="n">tags</span> <span class="o">=</span> <span class="sh">"</span><span class="s">filesystem:read</span><span class="sh">"</span><span class="p">,</span> <span class="p">[</span><span class="sh">"</span><span class="s">list</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">folder</span><span class="sh">"</span><span class="p">]</span>

        <span class="n">spec</span> <span class="o">=</span> <span class="nc">ToolSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">desc</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">_impl</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">cat</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">)</span>
        <span class="nf">return </span><span class="p">((</span><span class="n">tools_in</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">tools_in</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[])</span> <span class="o">+</span> <span class="p">[</span><span class="n">spec</span><span class="p">],)</span>
</code></pre></div></div>

<p>FileReadToolNode: 자동 생성</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">FileReadToolNode</span><span class="p">:</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{},</span>
            <span class="sh">"</span><span class="s">optional</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">tools_in</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_TOOLS</span><span class="sh">"</span><span class="p">,),</span>
                <span class="sh">"</span><span class="s">base_dir</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">encoding</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">callback</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_CALLBACK</span><span class="sh">"</span><span class="p">,),</span>
                <span class="sh">"</span><span class="s">function_name_override</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">description_override</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}),</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="n">RETURN_TYPES</span><span class="p">,</span> <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_TOOLS</span><span class="sh">"</span><span class="p">,),</span> <span class="p">(</span><span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span><span class="p">,</span> <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">append_tool</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">OpenAI/Tools</span><span class="sh">"</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_safe_join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">base_dir</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">base_dir</span><span class="p">)</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">target</span> <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">commonpath</span><span class="p">([</span><span class="n">base</span><span class="p">,</span> <span class="n">target</span><span class="p">])</span> <span class="o">==</span> <span class="n">base</span> <span class="k">else</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">append_tool</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tools_in</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">base_dir</span><span class="o">=</span><span class="sh">""</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                    <span class="n">function_name_override</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span><span class="p">,</span> <span class="n">description_override</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span><span class="p">):</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">File path (relative to base_dir if set).</span><span class="sh">"</span><span class="p">},</span>
                <span class="sh">"</span><span class="s">encoding</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Override encoding.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">}</span>

        <span class="k">def</span> <span class="nf">_impl</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">))</span>
            <span class="n">enc</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">encoding</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="p">))</span>
            <span class="n">resolved</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_safe_join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">resolved</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">resolved</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">callback</span><span class="p">:</span> <span class="n">callback</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_error</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span> <span class="sh">"</span><span class="s">reason</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">invalid_file</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="p">:</span> <span class="n">path</span><span class="p">})</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">resolved</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">enc</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">callback</span><span class="p">:</span> <span class="n">callback</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_done</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span> <span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">text</span><span class="p">)})</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="n">text</span><span class="p">}</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">callback</span><span class="p">:</span> <span class="n">callback</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_error</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span> <span class="sh">"</span><span class="s">reason</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_failed</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">)})</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}</span>

        <span class="n">auto_name_payload</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">base_dir</span><span class="sh">"</span><span class="p">:</span> <span class="n">base_dir</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">encoding</span><span class="sh">"</span><span class="p">:</span> <span class="n">encoding</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read</span><span class="sh">"</span><span class="p">}</span>
        <span class="n">fn_name</span> <span class="o">=</span> <span class="n">function_name_override</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span> <span class="ow">or</span> <span class="nf">_slug_fn_name</span><span class="p">(</span><span class="sh">"</span><span class="s">read_text</span><span class="sh">"</span><span class="p">,</span> <span class="n">auto_name_payload</span><span class="p">)</span>
        <span class="n">desc</span> <span class="o">=</span> <span class="n">description_override</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span> <span class="ow">or</span> <span class="nf">_auto_desc</span><span class="p">(</span>
            <span class="sh">"</span><span class="s">Read a UTF-8 text file.</span><span class="sh">"</span><span class="p">,</span>
            <span class="p">[</span><span class="sa">f</span><span class="sh">"</span><span class="s">Default encoding=</span><span class="si">{</span><span class="n">encoding</span><span class="si">}</span><span class="s">.</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">Required: file_path.</span><span class="sh">"</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="n">cat</span><span class="p">,</span> <span class="n">tags</span> <span class="o">=</span> <span class="sh">"</span><span class="s">filesystem:read</span><span class="sh">"</span><span class="p">,</span> <span class="p">[</span><span class="sh">"</span><span class="s">read</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">]</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="nc">ToolSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">desc</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">_impl</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">cat</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">)</span>
        <span class="nf">return </span><span class="p">((</span><span class="n">tools_in</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">tools_in</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[])</span> <span class="o">+</span> <span class="p">[</span><span class="n">spec</span><span class="p">],)</span>
</code></pre></div></div>

<p>FileWriteToolNode: 자동 생성</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">FileWriteToolNode</span><span class="p">:</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{},</span>
            <span class="sh">"</span><span class="s">optional</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">tools_in</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_TOOLS</span><span class="sh">"</span><span class="p">,),</span>
                <span class="sh">"</span><span class="s">base_dir</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">encoding</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">append</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">BOOLEAN</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">callback</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_CALLBACK</span><span class="sh">"</span><span class="p">,),</span>
                <span class="sh">"</span><span class="s">function_name_override</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">description_override</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}),</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="n">RETURN_TYPES</span><span class="p">,</span> <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_TOOLS</span><span class="sh">"</span><span class="p">,),</span> <span class="p">(</span><span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span><span class="p">,</span> <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">append_tool</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">OpenAI/Tools</span><span class="sh">"</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_safe_join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">base_dir</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">base_dir</span><span class="p">)</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">target</span> <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">commonpath</span><span class="p">([</span><span class="n">base</span><span class="p">,</span> <span class="n">target</span><span class="p">])</span> <span class="o">==</span> <span class="n">base</span> <span class="k">else</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">append_tool</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tools_in</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">base_dir</span><span class="o">=</span><span class="sh">""</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                    <span class="n">function_name_override</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span><span class="p">,</span> <span class="n">description_override</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span><span class="p">):</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">File path (relative to base_dir if set).</span><span class="sh">"</span><span class="p">},</span>
                <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Text content to write.</span><span class="sh">"</span><span class="p">},</span>
                <span class="sh">"</span><span class="s">encoding</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Override encoding.</span><span class="sh">"</span><span class="p">},</span>
                <span class="sh">"</span><span class="s">append</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">boolean</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Append to file instead of overwrite.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">}</span>

        <span class="k">def</span> <span class="nf">_impl</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">))</span>
            <span class="n">content</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">))</span>
            <span class="n">enc</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">encoding</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="p">))</span>
            <span class="n">do_append</span> <span class="o">=</span> <span class="nf">bool</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">append</span><span class="sh">"</span><span class="p">,</span> <span class="n">append</span><span class="p">))</span>
            <span class="n">resolved</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_safe_join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">resolved</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">callback</span><span class="p">:</span> <span class="n">callback</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_error</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span> <span class="sh">"</span><span class="s">reason</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">invalid_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="p">:</span> <span class="n">path</span><span class="p">})</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">resolved</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="sh">"</span><span class="s">a</span><span class="sh">"</span> <span class="k">if</span> <span class="n">do_append</span> <span class="k">else</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span>
                <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">resolved</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">enc</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">callback</span><span class="p">:</span> <span class="n">callback</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_done</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span> <span class="sh">"</span><span class="s">bytes</span><span class="sh">"</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">content</span><span class="p">)})</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">callback</span><span class="p">:</span> <span class="n">callback</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_error</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span> <span class="sh">"</span><span class="s">reason</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">write_failed</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">)})</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">}</span>

        <span class="n">auto_name_payload</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">base_dir</span><span class="sh">"</span><span class="p">:</span> <span class="n">base_dir</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">encoding</span><span class="sh">"</span><span class="p">:</span> <span class="n">encoding</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">append</span><span class="sh">"</span><span class="p">:</span> <span class="nf">bool</span><span class="p">(</span><span class="n">append</span><span class="p">),</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">write</span><span class="sh">"</span><span class="p">}</span>
        <span class="n">fn_name</span> <span class="o">=</span> <span class="n">function_name_override</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span> <span class="ow">or</span> <span class="nf">_slug_fn_name</span><span class="p">(</span><span class="sh">"</span><span class="s">write_text</span><span class="sh">"</span><span class="p">,</span> <span class="n">auto_name_payload</span><span class="p">)</span>
        <span class="n">desc</span> <span class="o">=</span> <span class="n">description_override</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span> <span class="ow">or</span> <span class="nf">_auto_desc</span><span class="p">(</span>
            <span class="sh">"</span><span class="s">Write text to a file.</span><span class="sh">"</span><span class="p">,</span>
            <span class="p">[</span><span class="sa">f</span><span class="sh">"</span><span class="s">Default encoding=</span><span class="si">{</span><span class="n">encoding</span><span class="si">}</span><span class="s">. Append=</span><span class="si">{</span><span class="n">append</span><span class="si">}</span><span class="s">.</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">Required: file_path, content.</span><span class="sh">"</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="n">cat</span><span class="p">,</span> <span class="n">tags</span> <span class="o">=</span> <span class="sh">"</span><span class="s">filesystem:write</span><span class="sh">"</span><span class="p">,</span> <span class="p">[</span><span class="sh">"</span><span class="s">write</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">]</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="nc">ToolSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">desc</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">_impl</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">cat</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">)</span>
        <span class="nf">return </span><span class="p">((</span><span class="n">tools_in</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">tools_in</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[])</span> <span class="o">+</span> <span class="p">[</span><span class="n">spec</span><span class="p">],)</span>
</code></pre></div></div>

<p>정리</p>

<ul>
  <li>
    <p>기본값: 사용자에게 name/description을 요구하지 않는다.</p>
  </li>
  <li>
    <p>노드 설정을 기반으로 안정적이고 고유한 함수명을 자동 생성한다.</p>
  </li>
  <li>
    <p>설명도 자동으로 한 줄 생성한다.</p>
  </li>
  <li>
    <p>아주 특별한 사유로 바꾸고 싶을 때만 override 입력을 쓴다(비워두면 무시).</p>
  </li>
  <li>
    <p>이렇게 하면 UX는 단순해지고, LLM 측에는 여전히 좋은 품질의 이름/설명이 전달된다.</p>
  </li>
</ul>

<p class="chat--user">

지금 뭔가 노드랑 실제 tool 함수랑 헷갈리고 있는 것 같아.

</p>

<p>좋은 지적이야. “노드(Node)”와 “툴 함수(모델이 호출하는 function)”가 섞여 보일 수 있어. 딱 잘라 구분하자.</p>

<ol>
  <li>개념 정리</li>
</ol>

<ul>
  <li>
    <p>노드(Node): ComfyUI에서 유저가 배선하는 에디터 컴포넌트. 입력을 받아 “툴 정의”를 만들어 내는 팩토리일 뿐이야. 노드 이름/메서드명은 모델에 안 보임.</p>
  </li>
  <li>
    <p>모델 툴(Model tool): 모델에 전달되는 JSON 스펙. 핵심 키는 tool_name(모델이 호출할 문자열 식별자), description, parameters(JSON Schema). 이게 tools 파라미터로 API에 들어감.</p>
  </li>
  <li>
    <p>실행기(Executor): 실제로 OS에서 파일 읽기/쓰기 등을 수행하는 파이썬 callable. 모델이 툴을 호출하면, 런타임이 tool_name → executor 매핑을 찾아 실행해 줘.</p>
  </li>
</ul>

<ol>
  <li>데이터 흐름</li>
</ol>

<ul>
  <li>
    <p>각 Tool 노드 → ModelTool 객체(툴 정의) + ExecRegistry 등록(tool_name → executor)</p>
  </li>
  <li>
    <p>Chat 노드 → 선택된 ModelTool들을 JSON으로 변환(tools_json)하여 API 호출</p>
  </li>
  <li>
    <p>모델 응답(tool_calls) → tool_name과 arguments만 들어옴</p>
  </li>
  <li>
    <p>러너가 ExecRegistrytool_name 실행 → 결과를 function_call_output/tool 메시지로 재주입</p>
  </li>
</ul>

<ol>
  <li>헷갈리지 않게 필드명 바꾸기(핵심만)</li>
</ol>

<ul>
  <li>
    <p>기존 ToolSpec(name, description, parameters, func)을 아래처럼 명확히 분리:</p>

    <ul>
      <li>
        <p>ModelTool.tool_name: 모델이 보는 이름(문자열)</p>
      </li>
      <li>
        <p>ModelTool.tool_desc: 모델이 보는 설명</p>
      </li>
      <li>
        <p>ModelTool.json_schema: 모델이 보는 파라미터 스키마</p>
      </li>
      <li>
        <p>executor: 파이썬 콜러블(LLM은 못 봄)</p>
      </li>
    </ul>
  </li>
  <li>
    <p>ExecRegistry: dict[str, Callable]로 별도 보관</p>
  </li>
</ul>

<ol>
  <li>최소 코드 변경 예시</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">List</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ModelTool</span><span class="p">:</span>
    <span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">tool_desc</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">json_schema</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>

<span class="c1"># Local registry that runtime uses to execute tool calls
</span><span class="k">class</span> <span class="nc">ExecRegistry</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_map</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">executor</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]):</span>
        <span class="k">if</span> <span class="n">tool_name</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_map</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Duplicate tool_name: </span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_map</span><span class="p">[</span><span class="n">tool_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">executor</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_map</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">tool_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fn</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool: </span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nf">fn</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

<span class="c1"># Tool JSON builders (what the model actually sees)
</span><span class="k">def</span> <span class="nf">build_tools_json_flat</span><span class="p">(</span><span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ModelTool</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="k">return</span> <span class="p">[{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">tool_name</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">tool_desc</span><span class="p">,</span> <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">json_schema</span><span class="p">}</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">build_tools_json_nested</span><span class="p">(</span><span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ModelTool</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="k">return</span> <span class="p">[{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">tool_name</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">tool_desc</span><span class="p">,</span> <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">json_schema</span><span class="p">}}</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">]</span>
</code></pre></div></div>

<p>툴 노드가 하는 일은 “ModelTool + executor”를 만드는 것뿐이야. 예를 들어 FileReadToolNode는 자동 생성된 tool_name/read_text_xxxxx와 짧은 tool_desc, json_schema를 만든 다음, 파일을 읽는 executor를 ExecRegistry에 등록해 준다. Chat 노드는 ModelTool들만 모아 tools_json을 만들고 API에 넣는다. 모델이 tool_name으로 호출하면 러너가 ExecRegistry.run(tool_name, args)로 실행한다.</p>

<ol>
  <li>왜 이렇게 나누면 좋은가</li>
</ol>

<ul>
  <li>
    <p>노드 이름/설정과 모델 툴 이름을 혼동하지 않게 된다.</p>
  </li>
  <li>
    <p>LLM에 보이는 것(ModelTool)과 로컬 실행기(Executor) 사이 경계가 선명해져 디버깅이 쉽다.</p>
  </li>
  <li>
    <p>동일 툴 JSON을 여러 프로바이더에 쓰되, 실행기는 환경별로 바꾸는 것도 간단하다.</p>
  </li>
  <li>
    <p>나중에 번들형 노드(여러 ModelTool 생성)나 주석 노드(메타 덧입히기)도 자연스럽게 얹을 수 있다.</p>
  </li>
</ul>

<p>정리하면, 노드는 “툴 정의의 생산자”, 모델에 보이는 건 ModelTool의 JSON만, 실행은 ExecRegistry가 담당. 이렇게 용어와 타입을 쪼개면 지금 느낀 혼동이 사라질 거야.</p>

<p class="chat--user">

응 ToolSpec에는 name, description, parameters, func만 저장해. Optional: OPENAI_TOOLS required: 기타 사용자가 툴 노드 선언할 때 선언해줄만한 정보들 - base_dir 등 파일 append 유무 같은건 node 인풋이 아니라 사용할 때 LLM이 결정해야하는것에 가까우니 그건 schema(parameters)에 들어가는게 더 맞는 것 같은데? 잘 생각해서 Tool Node들만 잘 만들어줘 

</p>

<p>좋아. ToolSpec에는 name, description, parameters, func 네 가지만 두고, 각 Tool 노드는 사용자가 선언할 만한 환경 정보만(required) 받도록 단순화했다. append, encoding 같은 실행 옵션은 전부 툴의 parameters(JSON Schema)에 넣어 LLM이 호출 시 결정하도록 했다. 아래 3개 노드만 붙이면 된다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># tool_nodes.py
# Minimal, focused Tool nodes for ComfyUI
# - ToolSpec: name, description, parameters, func
# - FileListToolNode: 폴더 내 파일 목록
# - FileReadToolNode: 텍스트 파일 읽기
# - FileWriteToolNode: 텍스트 파일 쓰기 (append 여부 등은 호출 시 결정)
#
# Note:
# - 각 노드는 required로 base_dir만 입력받고, tools_in은 선택(optional).
# - 스키마(parameters)에 실행 옵션을 정의하고, LLM이 호출 시 결정한다.
# - 안전을 위해 base_dir 밖 접근은 차단(_safe_join).
</span>
<span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">glob</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>

<span class="c1"># -----------------------
# Core spec
# -----------------------
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ToolSpec</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="n">func</span><span class="p">:</span> <span class="n">Any</span>  <span class="c1"># Callable[[Dict[str, Any]], Dict[str, Any]]
</span>
<span class="c1"># -----------------------
# Common helpers
# -----------------------
</span>
<span class="k">def</span> <span class="nf">_safe_join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">Join and assert the target stays under base_dir. Returns None if invalid.</span><span class="sh">"""</span>
    <span class="n">base</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">base_dir</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">)</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">path</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">common</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">commonpath</span><span class="p">([</span><span class="n">base</span><span class="p">,</span> <span class="n">target</span><span class="p">])</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">return</span> <span class="n">target</span> <span class="nf">if </span><span class="p">(</span><span class="n">base</span> <span class="ow">and</span> <span class="n">common</span> <span class="o">==</span> <span class="n">base</span><span class="p">)</span> <span class="k">else</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">_normalize_bool</span><span class="p">(</span><span class="n">v</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">v</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
        <span class="k">return</span> <span class="nf">bool</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="nf">strip</span><span class="p">().</span><span class="nf">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">{</span><span class="sh">"</span><span class="s">1</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">yes</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">y</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">t</span><span class="sh">"</span><span class="p">}:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">{</span><span class="sh">"</span><span class="s">0</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">false</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">no</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">n</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">f</span><span class="sh">"</span><span class="p">}:</span>
            <span class="k">return</span> <span class="bp">False</span>
    <span class="k">return</span> <span class="n">default</span>

<span class="c1"># -----------------------
# Tool Nodes
# -----------------------
</span>
<span class="k">class</span> <span class="nc">FileListToolNode</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Build a </span><span class="sh">'</span><span class="s">list files in folder</span><span class="sh">'</span><span class="s"> tool.
    Required: base_dir (sandbox root)
    Optional: tools_in (existing tool list to append)
    </span><span class="sh">"""</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">base_dir</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">./</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">}),</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">optional</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">tools_in</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_TOOLS</span><span class="sh">"</span><span class="p">,),</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_TOOLS</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">append_tool</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OpenAI/Tools</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">append_tool</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tools_in</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span>
        <span class="n">description</span> <span class="o">=</span> <span class="sh">"</span><span class="s">List files in a folder under the configured base_dir. Does not traverse outside base_dir.</span><span class="sh">"</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Relative path from base_dir to list.</span><span class="sh">"</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">pattern</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Optional glob pattern (e.g., </span><span class="sh">'</span><span class="s">*.txt</span><span class="sh">'</span><span class="s">). If empty, lists all files.</span><span class="sh">"</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">absolute</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">boolean</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">If true, return absolute paths; otherwise return basenames.</span><span class="sh">"</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">}</span>

        <span class="k">def</span> <span class="nf">_impl</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
            <span class="n">folder</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">)</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">pattern</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">)</span>
            <span class="n">absolute</span> <span class="o">=</span> <span class="nf">_normalize_bool</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">absolute</span><span class="sh">"</span><span class="p">),</span> <span class="bp">False</span><span class="p">)</span>

            <span class="n">resolved</span> <span class="o">=</span> <span class="nf">_safe_join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">folder</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">resolved</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isdir</span><span class="p">(</span><span class="n">resolved</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">invalid_folder</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>

            <span class="n">target</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">resolved</span><span class="p">,</span> <span class="n">pattern</span><span class="p">)</span> <span class="k">if</span> <span class="n">pattern</span> <span class="k">else</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">resolved</span><span class="p">,</span> <span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">.</span><span class="nf">glob</span><span class="p">(</span><span class="n">target</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">p</span><span class="p">)]</span>
            <span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">if</span> <span class="n">absolute</span> <span class="k">else</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">basename</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">items</span><span class="p">)}</span>

        <span class="n">spec</span> <span class="o">=</span> <span class="nc">ToolSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">_impl</span><span class="p">)</span>
        <span class="n">tool_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]</span> <span class="o">=</span> <span class="n">tools_in</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">tools_in</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">tool_list</span> <span class="o">+</span> <span class="p">[</span><span class="n">spec</span><span class="p">],)</span>

<span class="k">class</span> <span class="nc">FileReadToolNode</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Build a </span><span class="sh">'</span><span class="s">read text file</span><span class="sh">'</span><span class="s"> tool.
    Required: base_dir
    Optional: tools_in
    Execution options (encoding 등)는 parameters에 정의되어 LLM이 호출 시 결정.
    </span><span class="sh">"""</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">base_dir</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">./</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">}),</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">optional</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">tools_in</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_TOOLS</span><span class="sh">"</span><span class="p">,),</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_TOOLS</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">append_tool</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OpenAI/Tools</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">append_tool</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tools_in</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span>
        <span class="n">description</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Read a UTF-8 (or specified encoding) text file under base_dir. Blocks path traversal.</span><span class="sh">"</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Relative path from base_dir to the file.</span><span class="sh">"</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">encoding</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Text encoding (default </span><span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span><span class="s">).</span><span class="sh">"</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">max_bytes</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">integer</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Optional safety limit in bytes; if set and file is larger, it will be truncated.</span><span class="sh">"</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">}</span>

        <span class="k">def</span> <span class="nf">_impl</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">)</span>
            <span class="n">encoding</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">encoding</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">max_bytes</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">max_bytes</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">max_bytes</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">max_bytes</span><span class="p">)</span> <span class="k">if</span> <span class="n">max_bytes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="bp">None</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="n">max_bytes</span> <span class="o">=</span> <span class="bp">None</span>

            <span class="n">resolved</span> <span class="o">=</span> <span class="nf">_safe_join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">file_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">resolved</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">resolved</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">invalid_file</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">max_bytes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">max_bytes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># Read with size cap
</span>                    <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">resolved</span><span class="p">,</span> <span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">fb</span><span class="p">:</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">fb</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="n">max_bytes</span><span class="p">)</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">resolved</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">text</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="n">text</span><span class="p">}</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}</span>

        <span class="n">spec</span> <span class="o">=</span> <span class="nc">ToolSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">_impl</span><span class="p">)</span>
        <span class="n">tool_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]</span> <span class="o">=</span> <span class="n">tools_in</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">tools_in</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">tool_list</span> <span class="o">+</span> <span class="p">[</span><span class="n">spec</span><span class="p">],)</span>

<span class="k">class</span> <span class="nc">FileWriteToolNode</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Build a </span><span class="sh">'</span><span class="s">write text file</span><span class="sh">'</span><span class="s"> tool.
    Required: base_dir
    Optional: tools_in
    append/encoding 등은 parameters로 받고 LLM이 호출 시 결정.
    </span><span class="sh">"""</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">base_dir</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">./</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">}),</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">optional</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">tools_in</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_TOOLS</span><span class="sh">"</span><span class="p">,),</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_TOOLS</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">append_tool</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OpenAI/Tools</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">append_tool</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tools_in</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="sh">"</span><span class="s">write_text_file</span><span class="sh">"</span>
        <span class="n">description</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Write text content to a file under base_dir. Creates parent dirs if needed. Blocks path traversal.</span><span class="sh">"</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Relative path from base_dir to the file to write.</span><span class="sh">"</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Text content to write.</span><span class="sh">"</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">encoding</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Text encoding for writing (default </span><span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span><span class="s">).</span><span class="sh">"</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">append</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">boolean</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">If true, append to the file; otherwise overwrite.</span><span class="sh">"</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">}</span>

        <span class="k">def</span> <span class="nf">_impl</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">)</span>
            <span class="n">content</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">)</span>
            <span class="n">encoding</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">encoding</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">do_append</span> <span class="o">=</span> <span class="nf">_normalize_bool</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">append</span><span class="sh">"</span><span class="p">),</span> <span class="bp">False</span><span class="p">)</span>

            <span class="n">resolved</span> <span class="o">=</span> <span class="nf">_safe_join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">file_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">resolved</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">invalid_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">}</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">resolved</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="sh">"</span><span class="s">a</span><span class="sh">"</span> <span class="k">if</span> <span class="n">do_append</span> <span class="k">else</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span>
                <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">resolved</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">}</span>

        <span class="n">spec</span> <span class="o">=</span> <span class="nc">ToolSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">_impl</span><span class="p">)</span>
        <span class="n">tool_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]</span> <span class="o">=</span> <span class="n">tools_in</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">tools_in</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">tool_list</span> <span class="o">+</span> <span class="p">[</span><span class="n">spec</span><span class="p">],)</span>

<span class="c1"># -----------------------
# ComfyUI export
# -----------------------
</span>
<span class="n">NODE_CLASS_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">FileListToolNode</span><span class="sh">"</span><span class="p">:</span> <span class="n">FileListToolNode</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">FileReadToolNode</span><span class="sh">"</span><span class="p">:</span> <span class="n">FileReadToolNode</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">FileWriteToolNode</span><span class="sh">"</span><span class="p">:</span> <span class="n">FileWriteToolNode</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">NODE_DISPLAY_NAME_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">FileListToolNode</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Tool: List Files (base_dir)</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">FileReadToolNode</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Tool: Read Text (base_dir)</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">FileWriteToolNode</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Tool: Write Text (base_dir)</span><span class="sh">"</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div>

<p>설명 요약</p>

<ol>
  <li>
    <p>각 노드는 base_dir만 필수 입력으로 받고 tools_in은 옵션이며, 전달된 리스트 뒤에 ToolSpec 하나를 추가해 반환한다.</p>
  </li>
  <li>
    <p>읽기/쓰기에서 append, encoding 같은 실행 세부는 node 입력이 아닌 parameters에 포함되어 LLM이 호출 시 결정한다.</p>
  </li>
  <li>
    <p>모든 파일 경로는 base_dir 하위로만 접근하도록 _safe_join으로 보호했다.</p>
  </li>
  <li>
    <p>반환 객체는 항상 JSON 직렬화 가능한 딕셔너리다.</p>
  </li>
  <li>
    <p>이름과 설명은 고정 문자열로 제공한다. 필요하면 상위 레벨에서 다른 이름의 툴 노드를 추가로 만들면 된다.</p>
  </li>
</ol>

<p class="chat--user">

scheme를 pydantic model에서 자동 생성하던데(주석 포함) 그 방법도 소개해줘

</p>

<p>좋아. Pydantic(v2) 모델에서 JSON Schema를 자동 생성해, OpenAI function calling의 parameters로 바로 쓰는 방법을 정리해줄게. “주석 포함”은 런타임에서 코드 주석을 읽을 수는 없고, Field의 description/title/examples 같은 메타데이터로 스키마에 녹여 넣는 방식이 표준이야.</p>

<p>핵심 흐름</p>

<ol>
  <li>
    <p>Pydantic 모델 정의에 Field(description, examples 등)로 메타를 단다.</p>
  </li>
  <li>
    <p>model.model_json_schema()로 JSON Schema를 만든다.</p>
  </li>
  <li>
    <p>OpenAI 툴 파라미터는 전체 JSON Schema를 다 지원하진 않으므로, $defs/$ref를 인라인하고 불필요 키를 정리해 “간소 스키마”로 변환한다.</p>
  </li>
  <li>
    <p>그 결과를 ToolSpec.parameters에 넣는다.</p>
  </li>
</ol>

<p>예제 코드(헬퍼 + 사용법)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># pydantic_schema_tools.py
# Python 3.10+, Pydantic v2
</span><span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Type</span><span class="p">,</span> <span class="n">get_origin</span><span class="p">,</span> <span class="n">get_args</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span><span class="p">,</span> <span class="n">ConfigDict</span>
<span class="kn">from</span> <span class="n">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">import</span> <span class="n">copy</span>

<span class="c1"># 1) 예시: 파일 툴용 파라미터 모델들
</span>
<span class="k">class</span> <span class="nc">ListFilesParams</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">model_config</span> <span class="o">=</span> <span class="nc">ConfigDict</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="sh">"</span><span class="s">List files in a folder</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">json_schema_extra</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List files under base_dir with optional glob pattern.</span><span class="sh">"</span><span class="p">},</span>
    <span class="p">)</span>
    <span class="n">folder_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(...,</span> <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Relative path from base_dir to list.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">pattern</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Optional glob pattern, e.g. </span><span class="sh">'</span><span class="s">*.txt</span><span class="sh">'</span><span class="s">. If omitted, list all files.</span><span class="sh">"</span>
    <span class="p">)</span>
    <span class="n">absolute</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">If true, return absolute paths; otherwise return file basenames.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">json_schema_extra</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">examples</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="bp">False</span><span class="p">]}</span>
    <span class="p">)</span>

<span class="k">class</span> <span class="nc">ReadFileParams</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">model_config</span> <span class="o">=</span> <span class="nc">ConfigDict</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="sh">"</span><span class="s">Read text file</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">json_schema_extra</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a text file under base_dir.</span><span class="sh">"</span><span class="p">},</span>
    <span class="p">)</span>
    <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(...,</span> <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Relative path from base_dir to the file.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Text encoding, default </span><span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span><span class="s">.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">max_bytes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Optional safety limit in bytes to truncate large files.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">ge</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>

<span class="k">class</span> <span class="nc">WriteMode</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
    <span class="n">overwrite</span> <span class="o">=</span> <span class="sh">"</span><span class="s">overwrite</span><span class="sh">"</span>
    <span class="n">append</span> <span class="o">=</span> <span class="sh">"</span><span class="s">append</span><span class="sh">"</span>

<span class="k">class</span> <span class="nc">WriteFileParams</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">model_config</span> <span class="o">=</span> <span class="nc">ConfigDict</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="sh">"</span><span class="s">Write text file</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">json_schema_extra</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Write text content to a file under base_dir.</span><span class="sh">"</span><span class="p">},</span>
    <span class="p">)</span>
    <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(...,</span> <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Relative path from base_dir to write to.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(...,</span> <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Text content to write.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Text encoding, default </span><span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span><span class="s">.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">mode</span><span class="p">:</span> <span class="n">WriteMode</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">WriteMode</span><span class="p">.</span><span class="n">overwrite</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Write mode: overwrite or append.</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># 2) 변환기: Pydantic schema -&gt; OpenAI function parameters용 간소 스키마
# - $defs/$ref 인라인
# - OpenAI가 안 쓰는/문제되는 키 제거
# - 필요한 키만 남김: type, properties, required, additionalProperties, items, enum, description, minimum/maximum, minItems/maxItems, pattern, format 등
</span>
<span class="n">_ALLOWED_KEYS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">items</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">enum</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">minimum</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">maximum</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">exclusiveMinimum</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">exclusiveMaximum</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">minLength</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">maxLength</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">pattern</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">minItems</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">maxItems</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">format</span><span class="sh">"</span><span class="p">,</span>  <span class="c1"># 일부 모델은 format을 쓰기도 함
</span>    <span class="sh">"</span><span class="s">anyOf</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">oneOf</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">allOf</span><span class="sh">"</span><span class="p">,</span>  <span class="c1"># 가급적 피하되, 필요한 경우 유지
</span>    <span class="sh">"</span><span class="s">const</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">def</span> <span class="nf">_inline_refs</span><span class="p">(</span><span class="n">schema</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">schema</span> <span class="o">=</span> <span class="n">copy</span><span class="p">.</span><span class="nf">deepcopy</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>
    <span class="n">defs</span> <span class="o">=</span> <span class="n">schema</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="sh">"</span><span class="s">$defs</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
    <span class="k">def</span> <span class="nf">resolve</span><span class="p">(</span><span class="n">node</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">if</span> <span class="sh">"</span><span class="s">$ref</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">node</span><span class="p">:</span>
                <span class="n">ref</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="sh">"</span><span class="s">$ref</span><span class="sh">"</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">ref</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">#/$defs/</span><span class="sh">"</span><span class="p">):</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">ref</span><span class="p">[</span><span class="nf">len</span><span class="p">(</span><span class="sh">"</span><span class="s">#/$defs/</span><span class="sh">"</span><span class="p">):]</span>
                    <span class="n">target</span> <span class="o">=</span> <span class="n">copy</span><span class="p">.</span><span class="nf">deepcopy</span><span class="p">(</span><span class="n">defs</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">target</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="c1"># dangling ref; fallback to empty schema
</span>                        <span class="n">target</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">return</span> <span class="nf">resolve</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
                <span class="c1"># Unknown ref: drop
</span>                <span class="k">return</span> <span class="p">{}</span>
            <span class="c1"># recurse
</span>            <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nf">resolve</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">node</span><span class="p">.</span><span class="nf">items</span><span class="p">()}</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="nf">resolve</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">node</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">node</span>
    <span class="k">return</span> <span class="nf">resolve</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_prune_keys</span><span class="p">(</span><span class="n">node</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">keep</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">node</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">_ALLOWED_KEYS</span><span class="p">:</span>
                <span class="n">keep</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nf">_prune_keys</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="c1"># additional cleanup: if properties present but empty, ensure dict
</span>        <span class="k">if</span> <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">keep</span> <span class="ow">and</span> <span class="n">keep</span><span class="p">[</span><span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">keep</span><span class="p">[</span><span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="n">keep</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="nf">_prune_keys</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">node</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">node</span>

<span class="k">def</span> <span class="nf">pydantic_to_tool_parameters</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">raw</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">model_json_schema</span><span class="p">()</span>  <span class="c1"># full JSON Schema with $defs/$ref
</span>    <span class="n">inlined</span> <span class="o">=</span> <span class="nf">_inline_refs</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
    <span class="n">pruned</span> <span class="o">=</span> <span class="nf">_prune_keys</span><span class="p">(</span><span class="n">inlined</span><span class="p">)</span>
    <span class="c1"># Ensure top-level 'type'/'properties' exist per OpenAI expectations
</span>    <span class="k">if</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pruned</span> <span class="ow">and</span> <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">pruned</span><span class="p">:</span>
        <span class="n">pruned</span><span class="p">[</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span>
    <span class="k">if</span> <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pruned</span><span class="p">:</span>
        <span class="n">pruned</span><span class="p">[</span><span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">return</span> <span class="n">pruned</span>

<span class="c1"># 3) 사용 예: ToolSpec.parameters에 그대로 주입
#    아래는 앞서 만든 도구 파라미터 모델을 OpenAI function parameters로 바꾸는 예시.
</span><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="kn">from</span> <span class="n">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">ListFilesParams -&gt; tool parameters</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">pprint</span><span class="p">(</span><span class="nf">pydantic_to_tool_parameters</span><span class="p">(</span><span class="n">ListFilesParams</span><span class="p">))</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">ReadFileParams -&gt; tool parameters</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">pprint</span><span class="p">(</span><span class="nf">pydantic_to_tool_parameters</span><span class="p">(</span><span class="n">ReadFileParams</span><span class="p">))</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">WriteFileParams -&gt; tool parameters</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">pprint</span><span class="p">(</span><span class="nf">pydantic_to_tool_parameters</span><span class="p">(</span><span class="n">WriteFileParams</span><span class="p">))</span>
</code></pre></div></div>

<p>툴 노드에서의 활용 예</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># tool_nodes_pydantic_integration.py
</span><span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">List</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">pydantic_schema_tools</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">pydantic_to_tool_parameters</span><span class="p">,</span>
    <span class="n">ListFilesParams</span><span class="p">,</span> <span class="n">ReadFileParams</span><span class="p">,</span> <span class="n">WriteFileParams</span>
<span class="p">)</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ToolSpec</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="n">func</span><span class="p">:</span> <span class="n">Any</span>  <span class="c1"># Callable[[Dict[str, Any]], Dict[str, Any]]
</span>
<span class="c1"># 각 노드에서 base_dir 등 환경만 필수 입력으로 받고, parameters는 위 변환기로 만든다.
</span>
<span class="k">class</span> <span class="nc">FileListToolNode</span><span class="p">:</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">base_dir</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">./</span><span class="sh">"</span><span class="p">})},</span> <span class="sh">"</span><span class="s">optional</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">tools_in</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_TOOLS</span><span class="sh">"</span><span class="p">,)}}</span>
    <span class="n">RETURN_TYPES</span><span class="p">,</span> <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_TOOLS</span><span class="sh">"</span><span class="p">,),</span> <span class="p">(</span><span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span><span class="p">,</span> <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">append_tool</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">OpenAI/Tools</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">append_tool</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tools_in</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="nf">pydantic_to_tool_parameters</span><span class="p">(</span><span class="n">ListFilesParams</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">_impl</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
            <span class="c1"># args는 Pydantic 모델과 동일 구조로 들어옴
</span>            <span class="n">folder</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">pattern</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">""</span>
            <span class="n">absolute</span> <span class="o">=</span> <span class="nf">bool</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">absolute</span><span class="sh">"</span><span class="p">,</span> <span class="bp">False</span><span class="p">))</span>
            <span class="c1"># ... base_dir 안전 처리 + 결과 반환 ...
</span>            <span class="c1"># 생략: 이전에 작성했던 _safe_join/실행 코드 재사용
</span>            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="nc">ToolSpec</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">List files in a folder under the configured base_dir.</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">,</span>
            <span class="n">func</span><span class="o">=</span><span class="n">_impl</span>
        <span class="p">)</span>
        <span class="nf">return </span><span class="p">((</span><span class="n">tools_in</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">tools_in</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[])</span> <span class="o">+</span> <span class="p">[</span><span class="n">spec</span><span class="p">],)</span>

<span class="c1"># Read/Write 노드도 동일하게 pydantic_to_tool_parameters(ReadFileParams / WriteFileParams) 사용
</span></code></pre></div></div>

<p>필수 포인트</p>

<ol>
  <li>
    <p>“주석 포함”에 해당하는 설명은 Field(description=…), model_config.json_schema_extra={"description": "…"}로 넣는다. 소스 코드의 주석(# …)은 런타임에서 자동 반영되지 않는다.</p>
  </li>
  <li>
    <p>Enum, Literal, Union(Optional 포함), 제약조건(ge/le, minLength 등)은 Pydantic이 JSON Schema로 내보내며, 변환기에서 그대로 보존한다.</p>
  </li>
  <li>
    <p>OpenAI의 function calling은 JSON Schema의 모든 키를 지원하지 않는다. $ref/$defs를 제거하고 필요한 키만 남기는 정리가 안정적이다. 위 헬퍼를 그대로 쓰면 된다.</p>
  </li>
  <li>
    <p>중첩 모델도 model_json_schema()가 $defs/$ref로 생성하므로, 변환기에서 인라인되어 하나의 parameters로 들어간다.</p>
  </li>
</ol>

<p>추가 팁</p>

<ul>
  <li>
    <p>필드 예시를 보여주고 싶으면 Field(json_schema_extra={"examples": […]})로 넣으면 schema에 노출된다.</p>
  </li>
  <li>
    <p>모델 레벨 title/description은 model_config에 둔다(ConfigDict).</p>
  </li>
  <li>
    <p>컬렉션 타입의 스키마가 필요하면 TypeAdapter를 쓸 수 있다. 예: <code class="language-plaintext highlighter-rouge">TypeAdapter(list[ReadFileParams]).json_schema()</code>. 다만 function parameters 최상위는 보통 object를 기대하므로 직접 적합한 형태로 감싸는 게 안전하다.</p>
  </li>
  <li>
    <p>v1을 쓴다면 BaseModel.schema()가 동등 역할을 하지만, v2로 통일하는 걸 추천.</p>
  </li>
</ul>

<p>이렇게 만들면, 필드 설명과 예시까지 담긴 Pydantic 기반 스키마를 안전하게 툴 parameters로 사용할 수 있어.</p>

<p class="chat--user">

별로 자동으로 해주는게 아닌가&gt;

</p>

<p>맞아. Pydantic만 “그냥 쓰면” 완전히 자동은 아니야. 하지만 함수의 타입 힌트와 docstring을 읽어 JSON Schema와 ToolSpec을 자동 생성하도록 래퍼를 두면 사실상 “함수만 쓰면 툴이 생기는” 수준까지 갈 수 있어. 아래 코드는 그걸 해주는 최소 구현이야.</p>

<p>핵심 아이디어</p>

<ol>
  <li>
    <p>함수 시그니처(type hints) → 동적 Pydantic 모델 생성(create_model)</p>
  </li>
  <li>
    <p>docstring(요약/파라미터 설명) → description/Field.description에 주입</p>
  </li>
  <li>
    <p>Pydantic의 model_json_schema()를 OpenAI에 맞게 정리($defs 인라인 등)</p>
  </li>
  <li>
    <p>base_dir 같은 “환경 파라미터”는 스키마에서 제외(exclude)하고, 실행시에만 주입</p>
  </li>
</ol>

<p>코드 한 방에 끝</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># auto_toolgen.py
# Python 3.10+, Pydantic v2
</span><span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">re</span>
<span class="kn">import</span> <span class="n">glob</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">inspect</span>
<span class="kn">import</span> <span class="n">copy</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Type</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span><span class="p">,</span> <span class="n">ConfigDict</span><span class="p">,</span> <span class="n">create_model</span>
<span class="k">except</span> <span class="nb">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">Pydantic v2가 필요합니다. `pip install pydantic&gt;=2`</span><span class="sh">"</span><span class="p">)</span> <span class="k">from</span> <span class="n">e</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">docstring_parser</span>  <span class="c1"># optional, 없으면 설명은 최소화
</span><span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">docstring_parser</span> <span class="o">=</span> <span class="bp">None</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ToolSpec</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="n">func</span><span class="p">:</span> <span class="n">Any</span>  <span class="c1"># Callable[[Dict[str, Any]], Dict[str, Any]]
</span>
<span class="c1"># ---------- JSON Schema helpers (OpenAI function parameters용 간소화) ----------
</span>
<span class="n">_ALLOWED_KEYS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">items</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">enum</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">minimum</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">maximum</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">exclusiveMinimum</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">exclusiveMaximum</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">minLength</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">maxLength</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">pattern</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">minItems</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">maxItems</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">format</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">const</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">oneOf</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">anyOf</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">allOf</span><span class="sh">"</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">def</span> <span class="nf">_inline_refs</span><span class="p">(</span><span class="n">schema</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">schema</span> <span class="o">=</span> <span class="n">copy</span><span class="p">.</span><span class="nf">deepcopy</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>
    <span class="n">defs</span> <span class="o">=</span> <span class="n">schema</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="sh">"</span><span class="s">$defs</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
    <span class="k">def</span> <span class="nf">resolve</span><span class="p">(</span><span class="n">node</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">if</span> <span class="sh">"</span><span class="s">$ref</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">node</span><span class="p">:</span>
                <span class="n">ref</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="sh">"</span><span class="s">$ref</span><span class="sh">"</span><span class="p">]</span>
                <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ref</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">#/$defs/</span><span class="sh">"</span><span class="p">):</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">ref</span><span class="p">[</span><span class="nf">len</span><span class="p">(</span><span class="sh">"</span><span class="s">#/$defs/</span><span class="sh">"</span><span class="p">):]</span>
                    <span class="k">return</span> <span class="nf">resolve</span><span class="p">(</span><span class="n">copy</span><span class="p">.</span><span class="nf">deepcopy</span><span class="p">(</span><span class="n">defs</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">{})))</span>
                <span class="k">return</span> <span class="p">{}</span>  <span class="c1"># unknown ref → drop
</span>            <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nf">resolve</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">node</span><span class="p">.</span><span class="nf">items</span><span class="p">()}</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="nf">resolve</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">node</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">node</span>
    <span class="k">return</span> <span class="nf">resolve</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_prune_keys</span><span class="p">(</span><span class="n">node</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">keep</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">node</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">_ALLOWED_KEYS</span><span class="p">:</span>
                <span class="n">keep</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nf">_prune_keys</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">if</span> <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">keep</span> <span class="ow">and</span> <span class="n">keep</span><span class="p">[</span><span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">keep</span><span class="p">[</span><span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="n">keep</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="nf">_prune_keys</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">node</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">node</span>

<span class="k">def</span> <span class="nf">pydantic_to_tool_parameters</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">raw</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">model_json_schema</span><span class="p">()</span>
    <span class="n">inlined</span> <span class="o">=</span> <span class="nf">_inline_refs</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
    <span class="n">pruned</span> <span class="o">=</span> <span class="nf">_prune_keys</span><span class="p">(</span><span class="n">inlined</span><span class="p">)</span>
    <span class="k">if</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pruned</span> <span class="ow">and</span> <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">pruned</span><span class="p">:</span>
        <span class="n">pruned</span><span class="p">[</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span>
    <span class="k">if</span> <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pruned</span><span class="p">:</span>
        <span class="n">pruned</span><span class="p">[</span><span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">return</span> <span class="n">pruned</span>

<span class="c1"># ---------- Docstring parsing ----------
</span>
<span class="k">def</span> <span class="nf">parse_docstring</span><span class="p">(</span><span class="n">fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
    <span class="sh">"""</span><span class="s">
    returns: (short_description, {param_name: description})
    </span><span class="sh">"""</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">inspect</span><span class="p">.</span><span class="nf">getdoc</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">""</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">doc</span> <span class="ow">or</span> <span class="n">docstring_parser</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="sh">""</span><span class="p">,</span> <span class="p">{}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">parsed</span> <span class="o">=</span> <span class="n">docstring_parser</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
        <span class="n">short</span> <span class="o">=</span> <span class="p">(</span><span class="n">parsed</span><span class="p">.</span><span class="n">short_description</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">).</span><span class="nf">strip</span><span class="p">()</span>
        <span class="n">pmap</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="p">.</span><span class="n">arg_name</span><span class="p">:</span> <span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">description</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">).</span><span class="nf">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">parsed</span><span class="p">.</span><span class="n">params</span> <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="n">arg_name</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">short</span><span class="p">,</span> <span class="n">pmap</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="sh">""</span><span class="p">,</span> <span class="p">{}</span>

<span class="c1"># ---------- Dynamic model builder from a function signature ----------
</span>
<span class="k">def</span> <span class="nf">model_from_signature</span><span class="p">(</span>
    <span class="n">fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
    <span class="n">exclude</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">param_docs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">title</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">top_description</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">
    Build a Pydantic model from fn(**kwargs), excluding some params (env-only).
    - exclude: names not exposed to LLM (예: base_dir)
    - param_docs: per-param descriptions
    - title/top_description: model-level title/description
    </span><span class="sh">"""</span>
    <span class="n">exclude</span> <span class="o">=</span> <span class="n">exclude</span> <span class="ow">or</span> <span class="nf">set</span><span class="p">()</span>
    <span class="n">hints</span> <span class="o">=</span> <span class="n">typing</span><span class="p">.</span><span class="nf">get_type_hints</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">include_extras</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="p">.</span><span class="nf">signature</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>

    <span class="n">fields</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">sig</span><span class="p">.</span><span class="n">parameters</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">ann</span> <span class="o">=</span> <span class="n">hints</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">Any</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="n">default</span> <span class="ow">is</span> <span class="n">inspect</span><span class="p">.</span><span class="n">Parameter</span><span class="p">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">default</span> <span class="o">=</span> <span class="bp">...</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">default</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">default</span>
        <span class="n">desc</span> <span class="o">=</span> <span class="p">(</span><span class="n">param_docs</span> <span class="ow">or</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">desc</span><span class="p">:</span>
            <span class="n">fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ann</span><span class="p">,</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">desc</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ann</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>

    <span class="n">model_config</span> <span class="o">=</span> <span class="nc">ConfigDict</span><span class="p">()</span>
    <span class="n">schema_extra</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">top_description</span><span class="p">:</span>
        <span class="n">schema_extra</span><span class="p">[</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">top_description</span>
    <span class="n">model_config</span><span class="p">[</span><span class="sh">"</span><span class="s">title</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">title</span> <span class="ow">or</span> <span class="p">(</span><span class="n">fn</span><span class="p">.</span><span class="n">__name__</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="sh">"</span><span class="s">_</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="p">).</span><span class="nf">title</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">schema_extra</span><span class="p">:</span>
        <span class="n">model_config</span><span class="p">[</span><span class="sh">"</span><span class="s">json_schema_extra</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">schema_extra</span>

    <span class="n">M</span> <span class="o">=</span> <span class="nf">create_model</span><span class="p">(</span>
        <span class="n">fn</span><span class="p">.</span><span class="n">__name__</span><span class="p">.</span><span class="nf">title</span><span class="p">()</span> <span class="o">+</span> <span class="sh">"</span><span class="s">Params</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">__config__</span><span class="o">=</span><span class="n">model_config</span><span class="p">,</span>
        <span class="o">**</span><span class="n">fields</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">M</span>

<span class="c1"># ---------- Tool factory: function -&gt; ToolSpec ----------
</span>
<span class="k">def</span> <span class="nf">tool_from_callable</span><span class="p">(</span>
    <span class="n">fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">description</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">exclude_params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ToolSpec</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Turn a Python callable into ToolSpec.
    - name/description 미지정 시: 함수명/도큐스트링으로 자동 결정
    - exclude_params: schema에서 빼되 실행 시 env로 주입할 파라미터
    - env: 실행 시 강제 주입할 값들(예: base_dir)
    </span><span class="sh">"""</span>
    <span class="n">short</span><span class="p">,</span> <span class="n">pdocs</span> <span class="o">=</span> <span class="nf">parse_docstring</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="nf">model_from_signature</span><span class="p">(</span>
        <span class="n">fn</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="n">exclude_params</span><span class="p">,</span> <span class="n">param_docs</span><span class="o">=</span><span class="n">pdocs</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="p">(</span><span class="n">description</span> <span class="ow">or</span> <span class="n">short</span> <span class="ow">or</span> <span class="n">fn</span><span class="p">.</span><span class="n">__name__</span><span class="p">),</span>
        <span class="n">top_description</span><span class="o">=</span><span class="p">(</span><span class="n">description</span> <span class="ow">or</span> <span class="n">short</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">params</span> <span class="o">=</span> <span class="nf">pydantic_to_tool_parameters</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="n">tool_name</span> <span class="o">=</span> <span class="n">name</span> <span class="ow">or</span> <span class="n">fn</span><span class="p">.</span><span class="n">__name__</span>
    <span class="n">tool_desc</span> <span class="o">=</span> <span class="n">description</span> <span class="ow">or</span> <span class="n">short</span> <span class="ow">or</span> <span class="p">(</span><span class="n">fn</span><span class="p">.</span><span class="n">__name__</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="sh">"</span><span class="s">_</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="p">).</span><span class="nf">capitalize</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">executor</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">kwargs</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">args</span> <span class="ow">or</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="n">env</span><span class="p">:</span>
                <span class="c1"># env keys override task args
</span>                <span class="n">kwargs</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nf">fn</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">result</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="n">result</span><span class="p">}</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

    <span class="k">return</span> <span class="nc">ToolSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">tool_name</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">tool_desc</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">executor</span><span class="p">)</span>

<span class="c1"># ---------- Safe filesystem primitives (예시 함수들) ----------
</span>
<span class="k">def</span> <span class="nf">_safe_join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="n">base</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">base_dir</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">)</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">path</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">common</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">commonpath</span><span class="p">([</span><span class="n">base</span><span class="p">,</span> <span class="n">target</span><span class="p">])</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">return</span> <span class="n">target</span> <span class="nf">if </span><span class="p">(</span><span class="n">base</span> <span class="ow">and</span> <span class="n">common</span> <span class="o">==</span> <span class="n">base</span><span class="p">)</span> <span class="k">else</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">list_files_in_folder</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">folder_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pattern</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">absolute</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    List files in a folder under base_dir.
    Args:
        folder_path: Relative path from base_dir to list.
        pattern: Optional glob pattern like </span><span class="sh">'</span><span class="s">*.txt</span><span class="sh">'</span><span class="s">.
        absolute: If true, return absolute paths; otherwise basenames.
        base_dir: Environment-provided root directory. Not exposed to the LLM schema.
    </span><span class="sh">"""</span>
    <span class="n">resolved</span> <span class="o">=</span> <span class="nf">_safe_join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">folder_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">resolved</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isdir</span><span class="p">(</span><span class="n">resolved</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">invalid_folder</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">resolved</span><span class="p">,</span> <span class="n">pattern</span><span class="p">)</span> <span class="k">if</span> <span class="n">pattern</span> <span class="k">else</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">resolved</span><span class="p">,</span> <span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">.</span><span class="nf">glob</span><span class="p">(</span><span class="n">target</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">p</span><span class="p">)]</span>
    <span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">if</span> <span class="n">absolute</span> <span class="k">else</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">basename</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">items</span><span class="p">)}</span>

<span class="k">def</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="n">max_bytes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Read a text file under base_dir.
    Args:
        file_path: Relative path from base_dir to the file.
        encoding: Text encoding, default </span><span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span><span class="s">.
        max_bytes: Optional safety limit in bytes; if set, truncates.
        base_dir: Environment-provided root directory. Not exposed to the LLM schema.
    </span><span class="sh">"""</span>
    <span class="n">resolved</span> <span class="o">=</span> <span class="nf">_safe_join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">file_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">resolved</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">resolved</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">invalid_file</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">max_bytes</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">max_bytes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">resolved</span><span class="p">,</span> <span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">fb</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">fb</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="n">max_bytes</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">resolved</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="n">text</span><span class="p">}</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">write_text_file</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">overwrite</span><span class="sh">"</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Write text content to a file under base_dir.
    Args:
        file_path: Relative path from base_dir to write to.
        content: Text content to write.
        encoding: Text encoding, default </span><span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span><span class="s">.
        mode: </span><span class="sh">'</span><span class="s">overwrite</span><span class="sh">'</span><span class="s"> or </span><span class="sh">'</span><span class="s">append</span><span class="sh">'</span><span class="s">.
        base_dir: Environment-provided root directory. Not exposed to the LLM schema.
    </span><span class="sh">"""</span>
    <span class="n">resolved</span> <span class="o">=</span> <span class="nf">_safe_join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">file_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">resolved</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">invalid_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">resolved</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="sh">"</span><span class="s">a</span><span class="sh">"</span> <span class="k">if</span> <span class="nf">str</span><span class="p">(</span><span class="n">mode</span><span class="p">).</span><span class="nf">lower</span><span class="p">()</span> <span class="o">==</span> <span class="sh">"</span><span class="s">append</span><span class="sh">"</span> <span class="k">else</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">resolved</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">}</span>

<span class="c1"># ---------- Example: generate ToolSpecs automatically ----------
</span>
<span class="k">def</span> <span class="nf">build_filesystem_tools</span><span class="p">(</span><span class="n">base_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]:</span>
    <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># base_dir는 스키마에서 제외하고 실행시에 env로 주입
</span>    <span class="n">env</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">base_dir</span><span class="sh">"</span><span class="p">:</span> <span class="n">base_dir</span><span class="p">}</span>
    <span class="n">exclude</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">base_dir</span><span class="sh">"</span><span class="p">}</span>

    <span class="n">tools</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">tool_from_callable</span><span class="p">(</span>
        <span class="n">list_files_in_folder</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">exclude_params</span><span class="o">=</span><span class="n">exclude</span><span class="p">,</span>
        <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span>
    <span class="p">))</span>
    <span class="n">tools</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">tool_from_callable</span><span class="p">(</span>
        <span class="n">read_text_file</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">exclude_params</span><span class="o">=</span><span class="n">exclude</span><span class="p">,</span>
        <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span>
    <span class="p">))</span>
    <span class="n">tools</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">tool_from_callable</span><span class="p">(</span>
        <span class="n">write_text_file</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">write_text_file</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">exclude_params</span><span class="o">=</span><span class="n">exclude</span><span class="p">,</span>
        <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span>
    <span class="p">))</span>
    <span class="k">return</span> <span class="n">tools</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="c1"># 데모: JSON Schema 미리보기
</span>    <span class="n">tlist</span> <span class="o">=</span> <span class="nf">build_filesystem_tools</span><span class="p">(</span><span class="sh">"</span><span class="s">./samples</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tlist</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">---</span><span class="sh">"</span><span class="p">,</span> <span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">---</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">description:</span><span class="sh">"</span><span class="p">,</span> <span class="n">t</span><span class="p">.</span><span class="n">description</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">parameters</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
</code></pre></div></div>

<p>이게 “자동으로 해주는가?”에 대한 현실적인 해답이야.</p>

<ul>
  <li>
    <p>함수에 타입 힌트와 간단한 docstring만 달면 ToolSpec(parameters 포함)이 자동 생성된다.</p>
  </li>
  <li>
    <p>base_dir 같은 환경값은 exclude_params로 스키마에서 숨기고 env로 주입된다.</p>
  </li>
  <li>
    <p>docstring_parser가 있으면 파라미터 설명까지 스키마에 들어가고, 없으면 타입 힌트 기반 최소 스키마만 만들어진다.</p>
  </li>
</ul>

<p>운영 팁</p>

<ul>
  <li>
    <p>파라미터 설명을 확실히 넣고 싶으면 Google/Numpy 스타일 docstring을 권장.</p>
  </li>
  <li>
    <p>Enum, Literal, Optional, list[str] 같은 타입 힌트를 적극 사용하면 스키마 품질이 올라간다.</p>
  </li>
  <li>
    <p>더 자동화하고 싶으면, 함수 이름으로 name을 그대로 쓰되 prefix를 붙이는 규칙 정도만 추가하면 된다.</p>
  </li>
</ul>

        
      </section>

      <footer class="page__meta">
        
        


  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      <a href="/categories/#llm" class="page__taxonomy-item p-category" rel="tag">llm</a>
    
    </span>
  </p>


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time class="dt-published" datetime="2025-10-27T15:55:08+09:00">2025-10-27</time></p>

      </footer>

      

      
  <nav class="pagination">
    
      <a href="/llm/openai-function-call-examples/" class="pagination--pager" title="ComfyUI LLM Tool Call">Previous</a>
    
    
      <a href="/python/file-memory-cache/" class="pagination--pager" title="파일 캐시 패키지 추천">Next</a>
    
  </nav>


    </div>

    
  </article>

  
  
    
<div class="page__related">
  
  <h2 class="page__related-title">You may also enjoy</h2>
  <div class="grid__wrapper">
    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/2025-08-19-python-repr-vs-str/" rel="permalink">
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <!-- hvppyarchive: remove date icon
        <i class="far fa-calendar-alt" aria-hidden="true"></i> 
        -->
        
        <time datetime="2025-10-30T16:07:11+09:00">2025-10-30</time>
      </span>
    

    

    
  </p>


    <p class="archive__item-excerpt" itemprop="description">
</p>
  </article>
</div>

    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/comfyui/comfyui-connection-color/" rel="permalink">ComfyUI 타입 색상 추가
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <!-- hvppyarchive: remove date icon
        <i class="far fa-calendar-alt" aria-hidden="true"></i> 
        -->
        
        <time datetime="2025-10-30T16:07:05+09:00">2025-10-30</time>
      </span>
    

    

    
  </p>


    <p class="archive__item-excerpt" itemprop="description">

</p>
  </article>
</div>

    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/llm/npx-command-line-config/" rel="permalink">npx 설정 변경 방법
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <!-- hvppyarchive: remove date icon
        <i class="far fa-calendar-alt" aria-hidden="true"></i> 
        -->
        
        <time datetime="2025-10-30T13:40:18+09:00">2025-10-30</time>
      </span>
    

    

    
  </p>


    <p class="archive__item-excerpt" itemprop="description">

</p>
  </article>
</div>

    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/llm/unified-mcp-interface/" rel="permalink">Python MCP 연결 방법
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <!-- hvppyarchive: remove date icon
        <i class="far fa-calendar-alt" aria-hidden="true"></i> 
        -->
        
        <time datetime="2025-10-30T09:53:10+09:00">2025-10-30</time>
      </span>
    

    

    
  </p>


    <p class="archive__item-excerpt" itemprop="description">

</p>
  </article>
</div>

    
  </div>
</div>

  
  
</div>

      
    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';" role="search">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        

<div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
      
        
      
        
      
        
      
        
      
        
      
    

    
  </ul>
</div>


<div class="page__footer-copyright">&copy; 2013 - 2025 <a href="https://hvppyarchive.github.io">ARCHIVE</a>. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/jekyll-themes/minimal-mistakes/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>






  </body>
</html>
