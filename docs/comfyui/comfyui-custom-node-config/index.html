<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.27.1 by Michael Rose
  Copyright 2013-2025 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->

<html lang="en-US" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>ComfyUI 설정 파일 개발 - ARCHIVE</title>
<meta name="description" content="">


  <meta name="author" content="hvppyarchive">
  
  <meta property="article:author" content="hvppyarchive">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="ARCHIVE">
<meta property="og:title" content="ComfyUI 설정 파일 개발">
<meta property="og:url" content="https://hvppyarchive.github.io/comfyui/comfyui-custom-node-config/">


  <meta property="og:description" content="">







  <meta property="article:published_time" content="2025-10-02T13:39:43+09:00">





  

  


<link rel="canonical" href="https://hvppyarchive.github.io/comfyui/comfyui-custom-node-config/">












<!-- end _includes/seo.html -->


<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
  
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css"></noscript>



    <!-- start custom head snippets -->
<!-- hvppyarchive: add fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@200..900&display=swap" rel="stylesheet">

<!-- insert favicons. use https://realfavicongenerator.net/ -->
 <!-- hvppyarchive: add favicons -->
<link rel="icon" type="image/png" href="/assets/favicon/favicon-96x96.png" sizes="96x96" />
<link rel="icon" type="image/svg+xml" href="/assets/favicon/favicon.svg" />
<link rel="shortcut icon" href="/assets/favicon/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon/apple-touch-icon.png" />
<link rel="manifest" href="/assets/favicon/site.webmanifest" />

<!-- end custom head snippets -->

  </head>

  <body class="layout--single" dir="ltr">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          ARCHIVE
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a
                href="/year-archive/"
                
                
              >Posts</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <i class="fas fa-search"></i>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      





<div id="main" role="main">
  


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="ComfyUI 설정 파일 개발">
    <meta itemprop="description" content="">
    <meta itemprop="datePublished" content="2025-10-02T13:39:43+09:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">
            <a href="https://hvppyarchive.github.io/comfyui/comfyui-custom-node-config/" itemprop="url">ComfyUI 설정 파일 개발
</a>
          </h1>
          

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <!-- hvppyarchive: remove date icon
        <i class="far fa-calendar-alt" aria-hidden="true"></i> 
        -->
        
        <time datetime="2025-10-02T13:39:43+09:00">2025-10-02</time>
      </span>
    

    

    
  </p>


        </header>
      

      <section class="page__content" itemprop="text">
        
        <p class="chat--user">

ComfyUI Custom Node의 Config들을 저장 파일을 개발해줘. config 파일을 사람이 수정하기 쉬운 파일 형식으로 수정 해줘. 파일을 저장하지 않고 설정을 읽기만 하는 readonly 모드로 동작하면 돼. 여러 설정을 저장할거지만 주 용도는 LLM 엔드포인트 정보를 담을거야. 각 LLM Model 별로 (디스플레이용 모델명, 실제 모델명(request시), base url, api key)를 저장하면 돼. Config 정보에 관한 요청이 들어오면(e.g. api 날릴 때 등) 해당하는 값을 리턴하면 돼. 이 때 config 파일이 초기 read했을 때와 바뀌었을 수도 있어. 조금 반영이 늦더라도 1분 이내에는 변경된 값을 리턴해야해. 

</p>

<p>좋아요! “사람이 직접 수정하기 쉬운 설정 파일” + “읽기 전용(파일 저장 X)” + “최대 1분 내 최신값 반영” 조건을 만족하는 ComfyUI 커스텀 노드 패키지를 설계/구현해 드릴게요.<br />
아래 그대로 복사해 넣으면 바로 동작합니다.</p>

<hr />

<h1 id="1-파일-구조">1) 파일 구조</h1>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ComfyUI/
└─ custom_nodes/
   └─ comfyui_llm_config_reader/
      ├─ __init__.py
      ├─ llm_config_reader.py     <span class="c"># 커스텀 노드 + 설정 로더</span>
      └─ llm_config.toml          <span class="c"># 사람이 읽고 수정하기 쉬운 TOML 설정 파일</span>
</code></pre></div></div>

<blockquote>
  <p>기본 경로는 <code class="language-plaintext highlighter-rouge">llm_config.toml</code> 이고, <code class="language-plaintext highlighter-rouge">LLM_CONFIG_PATH</code> 환경변수로 바꿀 수 있어요.</p>
</blockquote>

<hr />

<h1 id="2-설정-파일-예시-toml">2) 설정 파일 예시 (TOML)</h1>

<p>사람이 손으로 편집하기 쉽고, 주석도 넣기 좋은 TOML을 사용합니다.<br />
(API Key는 깃에 올리지 않도록 환경변수 치환도 지원해요.)</p>

<p><code class="language-plaintext highlighter-rouge">llm_config.toml</code></p>
<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 버전 정보(선택)</span>
<span class="py">version</span> <span class="p">=</span> <span class="mi">1</span>

<span class="nn">[settings]</span>
<span class="c"># 파일 변경 반영 주기(초). 60초 이내 최신값 요구이므로 기본 30초로 여유 있게.</span>
<span class="py">refresh_interval_seconds</span> <span class="p">=</span> <span class="mi">30</span>

<span class="nn">[llm_models."gpt-4o-mini"]</span>
<span class="py">display_name</span>  <span class="p">=</span> <span class="s">"GPT-4o mini"</span>
<span class="py">request_model</span> <span class="p">=</span> <span class="s">"gpt-4o-mini"</span>
<span class="py">base_url</span>      <span class="p">=</span> <span class="s">"https://api.openai.com/v1"</span>
<span class="py">api_key</span>       <span class="p">=</span> <span class="s">"${OPENAI_API_KEY}"</span>   <span class="c"># 환경변수로 안전하게 주입</span>

<span class="nn">[llm_models."claude-3-5-sonnet"]</span>
<span class="py">display_name</span>  <span class="p">=</span> <span class="s">"Claude 3.5 Sonnet"</span>
<span class="py">request_model</span> <span class="p">=</span> <span class="s">"claude-3-5-sonnet"</span>
<span class="py">base_url</span>      <span class="p">=</span> <span class="s">"https://api.anthropic.com"</span>
<span class="py">api_key</span>       <span class="p">=</span> <span class="s">"${ANTHROPIC_API_KEY}"</span>

<span class="c"># 원하는 만큼 모델을 계속 추가</span>
<span class="c"># [llm_models."문자열키"] ...</span>
</code></pre></div></div>

<ul>
  <li>
    <p>키 선택 규칙: <code class="language-plaintext highlighter-rouge">llm_models."&lt;키&gt;"</code> 의 <code class="language-plaintext highlighter-rouge">&lt;키&gt;</code> 는 자유로운 문자열입니다.<br />
조회 시 <code class="language-plaintext highlighter-rouge">&lt;키&gt;</code>, <code class="language-plaintext highlighter-rouge">display_name</code>, <code class="language-plaintext highlighter-rouge">request_model</code> 셋 중 어느 걸로 입력해도 매칭되도록 했어요.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">${ENV_NAME}</code> 형태는 환경변수로 치환됩니다.</p>
  </li>
</ul>

<hr />

<h1 id="3-커스텀-노드로더-코드">3) 커스텀 노드/로더 코드</h1>

<p><code class="language-plaintext highlighter-rouge">comfyui_llm_config_reader/llm_config_reader.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="n">threading</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="c1"># Python 3.11+ tomllib, 3.10 이하면 tomli 사용
</span><span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomllib</span>  <span class="c1"># type: ignore
</span>    <span class="n">_TOML_LOADS</span> <span class="o">=</span> <span class="n">tomllib</span><span class="p">.</span><span class="n">loads</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomli</span>  <span class="c1"># type: ignore
</span>    <span class="n">_TOML_LOADS</span> <span class="o">=</span> <span class="n">tomli</span><span class="p">.</span><span class="n">loads</span>

<span class="k">def</span> <span class="nf">_expand_env_vars</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">문자열 내 ${ENV} 패턴을 환경변수로 치환. 그 외 타입은 그대로 반환.</span><span class="sh">"""</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="sh">""</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nf">len</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">${</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">value</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">env_name</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">env_name</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">out</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nf">_expand_env_vars</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">.</span><span class="nf">items</span><span class="p">()}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="nf">_expand_env_vars</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">value</span>

<span class="k">def</span> <span class="nf">_normalize_key</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">매칭 편의를 위한 정규화(소문자, 앞뒤 공백 제거).</span><span class="sh">"""</span>
    <span class="k">return</span> <span class="n">s</span><span class="p">.</span><span class="nf">strip</span><span class="p">().</span><span class="nf">lower</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">ReadOnlyConfig</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    - TOML 설정을 읽어서 메모리에 캐시
    - 파일이 바뀌었거나 refresh_interval이 지났으면 재로드
    - 쓰기는 절대 하지 않음 (read-only)
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span>
            <span class="sh">"</span><span class="s">LLM_CONFIG_PATH</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">),</span> <span class="sh">"</span><span class="s">llm_config.toml</span><span class="sh">"</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_refresh_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span>  <span class="c1"># 기본 30초(&lt;= 60초 요구 충족)
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_index</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># 정규화 키 -&gt; 모델 dict
</span>
    <span class="k">def</span> <span class="nf">_read_text</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">().</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_build_index</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_index</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>
        <span class="n">models</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">llm_models</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">model_key</span><span class="p">,</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">models</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="c1"># 환경변수 치환
</span>            <span class="n">cfg</span> <span class="o">=</span> <span class="nf">_expand_env_vars</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>

            <span class="c1"># 필수 필드 체크
</span>            <span class="n">required</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">request_model</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]</span>
            <span class="n">missing</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">required</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cfg</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="n">k</span><span class="p">]).</span><span class="nf">strip</span><span class="p">()]</span>
            <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
                <span class="c1"># 불완전한 엔트리는 스킵 (명확한 로그가 필요하면 print 가능)
</span>                <span class="k">continue</span>

            <span class="c1"># 모델 접근을 위한 다양한 키들 인덱싱
</span>            <span class="n">candidates</span> <span class="o">=</span> <span class="p">{</span>
                <span class="nf">str</span><span class="p">(</span><span class="n">model_key</span><span class="p">),</span>
                <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)),</span>
                <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">request_model</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)),</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">candidates</span><span class="p">):</span>
                <span class="n">self</span><span class="p">.</span><span class="n">_index</span><span class="p">[</span><span class="nf">_normalize_key</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">]),</span>
                    <span class="sh">"</span><span class="s">request_model</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">request_model</span><span class="sh">"</span><span class="p">]),</span>
                    <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">]),</span>
                    <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]),</span>
                <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_reload_locked</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_text</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nf">_TOML_LOADS</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>
        <span class="c1"># settings.refresh_interval_seconds 반영 (최소 5초, 최대 60초로 가드)
</span>        <span class="n">refresh</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span>
            <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">settings</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">refresh_interval_seconds</span><span class="sh">"</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">refresh</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="n">refresh</span><span class="p">))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_refresh_interval</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span>
            <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">LLM_CONFIG_REFRESH_SECONDS</span><span class="sh">"</span><span class="p">,</span> <span class="n">refresh</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_raw</span> <span class="o">=</span> <span class="nf">_expand_env_vars</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_build_index</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_stale_or_changed</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mtime</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">mtime</span> <span class="o">!=</span> <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">_refresh_interval</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_ensure_loaded</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">self</span><span class="p">.</span><span class="nf">_stale_or_changed</span><span class="p">():</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_reload_locked</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_model</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">key는 모델 키/표시명/요청용 모델명 중 아무거나 가능.</span><span class="sh">"""</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nf">str</span><span class="p">(</span><span class="n">key</span><span class="p">).</span><span class="nf">strip</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sh">"</span><span class="s">model key is empty</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">hit</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_index</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_normalize_key</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
            <span class="c1"># 최신 반영 지연 가능성을 고려해 한 번 더 강제 리로드 후 재시도
</span>            <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_reload_locked</span><span class="p">()</span>
                <span class="n">hit</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_index</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_normalize_key</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">model not found: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hit</span>

    <span class="k">def</span> <span class="nf">list_models</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
        <span class="sh">"""</span><span class="s">디버그/인스펙션용: (표시명, 요청모델, base_url만 노출하는 안전 리스트).</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># 역으로 display_name 기준 집계
</span>        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_index</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="n">dn</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">]</span>
            <span class="n">out</span><span class="p">[</span><span class="n">dn</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">request_model</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">request_model</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">],</span>
                <span class="c1"># api_key는 보안상 미노출
</span>            <span class="p">}</span>
        <span class="k">return</span> <span class="n">out</span>

<span class="c1"># 전역 싱글톤 로더 (ComfyUI 노드들이 공유)
</span><span class="n">_CONFIG</span> <span class="o">=</span> <span class="nc">ReadOnlyConfig</span><span class="p">()</span>

<span class="c1"># ===== ComfyUI Custom Nodes =====
</span><span class="k">class</span> <span class="nc">LLMConfigLookup</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    입력: model_key (문자열)  — 예: </span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="s"> 또는 </span><span class="sh">"</span><span class="s">GPT-4o mini</span><span class="sh">"</span><span class="s"> 또는 </span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="s">(request_model)
    출력: display_name, request_model, base_url, api_key (모두 STRING)
    </span><span class="sh">"""</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">model_key</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">}),</span>
            <span class="p">},</span>
        <span class="p">}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">request_model</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">lookup</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">LLM/Config</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">lookup</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">_CONFIG</span><span class="p">.</span><span class="nf">get_model</span><span class="p">(</span><span class="n">model_key</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># ComfyUI에서 에러가 보이도록 예외 전달
</span>            <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[LLMConfigLookup] </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">],</span> <span class="n">m</span><span class="p">[</span><span class="sh">"</span><span class="s">request_model</span><span class="sh">"</span><span class="p">],</span> <span class="n">m</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">],</span> <span class="n">m</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">])</span>

<span class="k">class</span> <span class="nc">LLMConfigListModels</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    디버그용: 사용 가능한 모델들의 (표시명, 요청모델, base_url) JSON을 반환.
    </span><span class="sh">"""</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">models_json</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">list_models</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">LLM/Config</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">list_models</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="n">json</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">_CONFIG</span><span class="p">.</span><span class="nf">list_models</span><span class="p">()</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">),)</span>

<span class="c1"># ComfyUI 등록용 매핑
</span><span class="n">NODE_CLASS_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">LLMConfigLookup</span><span class="sh">"</span><span class="p">:</span> <span class="n">LLMConfigLookup</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">LLMConfigListModels</span><span class="sh">"</span><span class="p">:</span> <span class="n">LLMConfigListModels</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">NODE_DISPLAY_NAME_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">LLMConfigLookup</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">LLM: Config Lookup (ReadOnly)</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">LLMConfigListModels</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">LLM: List Models (ReadOnly)</span><span class="sh">"</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">comfyui_llm_config_reader/__init__.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 빈 파일이면 충분합니다. (패키지 인식용)
</span></code></pre></div></div>

<hr />

<h1 id="4-동작-보장요구사항-매핑">4) 동작 보장(요구사항 매핑)</h1>

<ol>
  <li>
    <p><strong>사람이 수정하기 쉬운 포맷</strong> : TOML 사용 + 주석 가능 + 간결한 키/값 구조.</p>
  </li>
  <li>
    <p><strong>읽기 전용</strong> : 코드 어디에서도 파일을 쓰지 않음. 오직 읽기/파싱만 수행.</p>
  </li>
  <li>
    <p><strong>다중 설정(특히 LLM 엔드포인트)</strong> : <code class="language-plaintext highlighter-rouge">llm_models."&lt;키&gt;"</code>마다</p>

    <ul>
      <li><code class="language-plaintext highlighter-rouge">display_name</code>, <code class="language-plaintext highlighter-rouge">request_model</code>, <code class="language-plaintext highlighter-rouge">base_url</code>, <code class="language-plaintext highlighter-rouge">api_key</code> 저장.</li>
    </ul>
  </li>
  <li>
    <p><strong>요청 시 해당 값 리턴</strong> : <code class="language-plaintext highlighter-rouge">LLMConfigLookup</code> 노드가 입력 <code class="language-plaintext highlighter-rouge">model_key</code>로 검색하여 4개 값을 출력.</p>

    <ul>
      <li><code class="language-plaintext highlighter-rouge">&lt;키&gt;</code> / <code class="language-plaintext highlighter-rouge">display_name</code> / <code class="language-plaintext highlighter-rouge">request_model</code> 중 무엇으로 넣어도 매칭됨.</li>
    </ul>
  </li>
  <li>
    <p><strong>변경 반영(최대 1분)</strong> :</p>

    <ul>
      <li>
        <p>파일 <code class="language-plaintext highlighter-rouge">mtime</code> 변화 감지 + <code class="language-plaintext highlighter-rouge">refresh_interval_seconds</code>(기본 30초) 또는 <code class="language-plaintext highlighter-rouge">LLM_CONFIG_REFRESH_SECONDS</code>(env) 기준 TTL 캐시.</p>
      </li>
      <li>
        <p>호출 시마다 <strong>stale 또는 변경</strong> 이면 즉시 재로드 → <strong>최대 60초 이내</strong> 최신값 보장.</p>
      </li>
      <li>
        <p>신규 항목이 추가된 직후에도, 다음 호출 때 최대 TTL 뒤에는 반영.</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>보안 고려</strong> :</p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">${ENV}</code> 치환 지원으로 API Key를 환경변수에서 주입 가능.</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">ListModels</code> 노드에서는 API Key 미노출.</p>
      </li>
    </ul>
  </li>
</ol>

<hr />

<h1 id="5-사용-방법-간단">5) 사용 방법 (간단)</h1>

<ol>
  <li>
    <p>위 파일 구조대로 복사 → ComfyUI 재실행.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">llm_config.toml</code> 에 모델들을 추가/수정.</p>
  </li>
  <li>
    <p>워크플로우에서 <strong>LLM: Config Lookup (ReadOnly)</strong> 노드 배치 → <code class="language-plaintext highlighter-rouge">model_key</code> 입력(예: <code class="language-plaintext highlighter-rouge">gpt-4o-mini</code>).</p>
  </li>
  <li>
    <p>노드 출력 4개(표시명/요청모델/base_url/api_key)를 원하는 LLM 호출 노드에 연결.</p>
  </li>
  <li>
    <p>설정 파일을 수정하면, <strong>최대 30초(기본) 내</strong> 새 값이 자동 반영됩니다. (환경변수로 5~60초 사이 튜닝 가능)</p>
  </li>
</ol>

<hr />

<h1 id="6-커스터마이징-팁">6) 커스터마이징 팁</h1>

<ul>
  <li>
    <p><strong>YAML 선호 시</strong> : <code class="language-plaintext highlighter-rouge">tomllib</code> 대신 <code class="language-plaintext highlighter-rouge">yaml.safe_load</code>로 바꾸고 파일 확장자만 <code class="language-plaintext highlighter-rouge">.yaml</code>로 바꾸면 됩니다.</p>
  </li>
  <li>
    <p><strong>모델 키 자동 드롭다운</strong> : ComfyUI의 동적 입력 UI가 필요하면, <code class="language-plaintext highlighter-rouge">INPUT_TYPES</code>를 주기적으로 재구성하는 커스텀 프론트엔드가 필요합니다. 기본 구현은 문자열 입력으로 단순/견고하게 처리했습니다.</p>
  </li>
  <li>
    <p><strong>필드 확장</strong> : per-model 타임아웃, 헤더 등 추가 필드가 필요하면 TOML에 키를 늘리고 <code class="language-plaintext highlighter-rouge">_build_index</code>에서 그대로 통과시켜 출력을 늘리면 됩니다.</p>
  </li>
</ul>

<hr />

<p>원하시면 YAML 버전 또는 특정 LLM 호출 노드(예: OpenAI/Anthropic 커넥터)까지 바로 연결되는 노드도 추가로 만들어 드릴게요.</p>

<p class="chat--user">

좋은데 LLM 말고도 다른 설정들도 저장할 수 있는 범용적 config 파일이라서 파일명을 바꿔주면 좋겠어

</p>

<p>좋은 포인트예요! 범용 설정 파일로 쓰기 좋게 <strong>파일명을 <code class="language-plaintext highlighter-rouge">config.toml</code></strong>로 바꾸고, 코드/환경변수도 <strong>일반화</strong> 했습니다. (이전 <code class="language-plaintext highlighter-rouge">llm_config.toml</code>·<code class="language-plaintext highlighter-rouge">LLM_CONFIG_PATH</code>도 자동 하위 호환)</p>

<p>아래 그대로 교체/추가하면 됩니다.</p>

<hr />

<h1 id="변경-요약-step-by-step">변경 요약 (step-by-step)</h1>

<ol>
  <li>
    <p>설정 파일 기본명을 <code class="language-plaintext highlighter-rouge">config.toml</code>로 변경</p>
  </li>
  <li>
    <p>경로 환경변수도 일반화: <strong><code class="language-plaintext highlighter-rouge">COMFY_CONFIG_PATH</code></strong> (구 <code class="language-plaintext highlighter-rouge">LLM_CONFIG_PATH</code>도 인식)</p>
  </li>
  <li>
    <p>새로고침 주기 환경변수: <strong><code class="language-plaintext highlighter-rouge">COMFY_CONFIG_REFRESH_SECONDS</code></strong> (구 <code class="language-plaintext highlighter-rouge">LLM_CONFIG_REFRESH_SECONDS</code>도 인식)</p>
  </li>
  <li>
    <p>코드가 <code class="language-plaintext highlighter-rouge">config.toml</code>을 우선 사용, 없으면 기존 <code class="language-plaintext highlighter-rouge">llm_config.toml</code> 자동 폴백</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">[llm_models]</code> 외에 임의 섹션(<code class="language-plaintext highlighter-rouge">[feature_flags]</code>, <code class="language-plaintext highlighter-rouge">[storage]</code> 등) 자유 확장 가능</p>
  </li>
</ol>

<hr />

<h1 id="디렉토리-구조">디렉토리 구조</h1>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ComfyUI/
└─ custom_nodes/
   └─ comfyui_llm_config_reader/
      ├─ __init__.py
      ├─ llm_config_reader.py     <span class="c"># (교체본) 범용 config 로더 + LLM 조회 노드</span>
      └─ config.toml              <span class="c"># ← 새 기본 설정 파일명 (범용)</span>
      <span class="c"># └─ llm_config.toml        # (선택) 기존 파일명도 계속 동작(폴백)</span>
</code></pre></div></div>

<hr />

<h1 id="예시-configtoml-범용">예시 <code class="language-plaintext highlighter-rouge">config.toml</code> (범용)</h1>
<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">version</span> <span class="p">=</span> <span class="mi">1</span>

<span class="nn">[settings]</span>
<span class="c"># 파일 변경 반영 주기(초). 1분 이내 요구 → 기본 30초.</span>
<span class="py">refresh_interval_seconds</span> <span class="p">=</span> <span class="mi">30</span>

<span class="c"># ── LLM 엔드포인트들 ──────────────────────────────────────────────</span>
<span class="nn">[llm_models."gpt-4o-mini"]</span>
<span class="py">display_name</span>  <span class="p">=</span> <span class="s">"GPT-4o mini"</span>
<span class="py">request_model</span> <span class="p">=</span> <span class="s">"gpt-4o-mini"</span>
<span class="py">base_url</span>      <span class="p">=</span> <span class="s">"https://api.openai.com/v1"</span>
<span class="py">api_key</span>       <span class="p">=</span> <span class="s">"${OPENAI_API_KEY}"</span>

<span class="nn">[llm_models."claude-3-5-sonnet"]</span>
<span class="py">display_name</span>  <span class="p">=</span> <span class="s">"Claude 3.5 Sonnet"</span>
<span class="py">request_model</span> <span class="p">=</span> <span class="s">"claude-3-5-sonnet"</span>
<span class="py">base_url</span>      <span class="p">=</span> <span class="s">"https://api.anthropic.com"</span>
<span class="py">api_key</span>       <span class="p">=</span> <span class="s">"${ANTHROPIC_API_KEY}"</span>

<span class="c"># ── (예) 다른 범용 설정 섹션들 ───────────────────────────────────</span>
<span class="nn">[feature_flags]</span>
<span class="py">use_cache</span> <span class="p">=</span> <span class="kc">true</span>
<span class="py">show_beta</span> <span class="p">=</span> <span class="kc">false</span>

<span class="nn">[storage.s3]</span>
<span class="py">bucket</span> <span class="p">=</span> <span class="s">"my-bucket"</span>
<span class="py">region</span> <span class="p">=</span> <span class="s">"ap-northeast-2"</span>
<span class="py">access_key</span> <span class="p">=</span> <span class="s">"${S3_ACCESS_KEY}"</span>
<span class="py">secret_key</span> <span class="p">=</span> <span class="s">"${S3_SECRET_KEY}"</span>
</code></pre></div></div>

<ul>
  <li>
    <p>임의 섹션은 <strong>그대로 저장</strong> 되며, LLM 노드는 <code class="language-plaintext highlighter-rouge">[llm_models]</code>만 사용합니다.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">${ENV}</code> 표기값은 환경변수로 치환됩니다.</p>
  </li>
</ul>

<hr />

<h1 id="교체본-코드-llm_config_readerpy">교체본 코드: <code class="language-plaintext highlighter-rouge">llm_config_reader.py</code></h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="n">threading</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>

<span class="c1"># Python 3.11+ tomllib, 3.10 이하면 tomli 사용
</span><span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomllib</span>  <span class="c1"># type: ignore
</span>    <span class="n">_TOML_LOADS</span> <span class="o">=</span> <span class="n">tomllib</span><span class="p">.</span><span class="n">loads</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomli</span>  <span class="c1"># type: ignore
</span>    <span class="n">_TOML_LOADS</span> <span class="o">=</span> <span class="n">tomli</span><span class="p">.</span><span class="n">loads</span>

<span class="k">def</span> <span class="nf">_expand_env_vars</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">문자열 내 ${ENV} 패턴을 환경변수로 치환. 그 외 타입은 그대로.</span><span class="sh">"""</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">out</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="sh">""</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nf">len</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">${</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">value</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">env_name</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">env_name</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">out</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nf">_expand_env_vars</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">.</span><span class="nf">items</span><span class="p">()}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="nf">_expand_env_vars</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">value</span>

<span class="k">def</span> <span class="nf">_normalize_key</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="nf">str</span><span class="p">(</span><span class="n">s</span><span class="p">).</span><span class="nf">strip</span><span class="p">().</span><span class="nf">lower</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">ReadOnlyConfig</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    - TOML 설정을 읽어 메모리 캐시
    - 파일 mtime/TTL(최소 5s, 최대 60s) 기반 자동 재로드
    - 절대 쓰기 없음 (read-only)
    - 파일명 일반화:
        * 우선순위: COMFY_CONFIG_PATH &gt; LLM_CONFIG_PATH(하위호환) &gt;
                    ./config.toml &gt; ./llm_config.toml(하위호환)
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="c1"># 1) 명시적 인자
</span>        <span class="n">explicit</span> <span class="o">=</span> <span class="n">path</span>

        <span class="c1"># 2) 환경변수 (일반화 + 하위호환)
</span>        <span class="n">env_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">COMFY_CONFIG_PATH</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">LLM_CONFIG_PATH</span><span class="sh">"</span><span class="p">)</span>

        <span class="c1"># 3) 기본 경로 탐색 (우선 config.toml, 없으면 llm_config.toml)
</span>        <span class="n">here</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">)</span>
        <span class="n">default_primary</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">here</span><span class="p">,</span> <span class="sh">"</span><span class="s">config.toml</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">default_legacy</span>  <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">here</span><span class="p">,</span> <span class="sh">"</span><span class="s">llm_config.toml</span><span class="sh">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">explicit</span><span class="p">:</span>
            <span class="n">chosen</span> <span class="o">=</span> <span class="n">explicit</span>
        <span class="k">elif</span> <span class="n">env_path</span><span class="p">:</span>
            <span class="n">chosen</span> <span class="o">=</span> <span class="n">env_path</span>
        <span class="k">elif</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">default_primary</span><span class="p">):</span>
            <span class="n">chosen</span> <span class="o">=</span> <span class="n">default_primary</span>
        <span class="k">elif</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">default_legacy</span><span class="p">):</span>
            <span class="n">chosen</span> <span class="o">=</span> <span class="n">default_legacy</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># 파일이 아직 없을 수 있으니 새 표준명으로 고정
</span>            <span class="n">chosen</span> <span class="o">=</span> <span class="n">default_primary</span>

        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">chosen</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_refresh_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span>  <span class="c1"># 기본 30초 (&lt;=60초 요구 충족)
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_index</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># 정규화 키 -&gt; LLM 모델 dict
</span>
    <span class="k">def</span> <span class="nf">_read_text</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">().</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_build_index_llm</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">[llm_models] 섹션만 인덱싱. 다른 섹션은 그대로 self._raw에 보존.</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_index</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>
        <span class="n">models</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">llm_models</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">model_key</span><span class="p">,</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">models</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="c1"># 환경변수 치환
</span>            <span class="n">cfg</span> <span class="o">=</span> <span class="nf">_expand_env_vars</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>

            <span class="c1"># 필수 필드 체크
</span>            <span class="n">required</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">request_model</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]</span>
            <span class="n">missing</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">required</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cfg</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="n">k</span><span class="p">]).</span><span class="nf">strip</span><span class="p">()]</span>
            <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
                <span class="c1"># 불완전 항목은 스킵
</span>                <span class="k">continue</span>

            <span class="c1"># 접근 키(모델키/표시명/요청모델) 인덱싱
</span>            <span class="n">candidates</span> <span class="o">=</span> <span class="p">{</span>
                <span class="nf">str</span><span class="p">(</span><span class="n">model_key</span><span class="p">),</span>
                <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)),</span>
                <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">request_model</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)),</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">candidates</span><span class="p">):</span>
                <span class="n">self</span><span class="p">.</span><span class="n">_index</span><span class="p">[</span><span class="nf">_normalize_key</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">]),</span>
                    <span class="sh">"</span><span class="s">request_model</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">request_model</span><span class="sh">"</span><span class="p">]),</span>
                    <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">]),</span>
                    <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]),</span>
                <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_reload_locked</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_text</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nf">_TOML_LOADS</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>

        <span class="c1"># refresh_interval_seconds (최소 5, 최대 60) + env override(일반/하위호환)
</span>        <span class="n">conf_val</span> <span class="o">=</span> <span class="nf">int</span><span class="p">((</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">settings</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">refresh_interval_seconds</span><span class="sh">"</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
        <span class="n">conf_val</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="n">conf_val</span><span class="p">))</span>
        <span class="n">env_override</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">COMFY_CONFIG_REFRESH_SECONDS</span><span class="sh">"</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">LLM_CONFIG_REFRESH_SECONDS</span><span class="sh">"</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">env_override</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">conf_val</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="nf">int</span><span class="p">(</span><span class="n">env_override</span><span class="p">)))</span>
            <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="n">self</span><span class="p">.</span><span class="n">_refresh_interval</span> <span class="o">=</span> <span class="n">conf_val</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_raw</span> <span class="o">=</span> <span class="nf">_expand_env_vars</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_build_index_llm</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>

    <span class="k">def</span> <span class="nf">_stale_or_changed</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mtime</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">mtime</span> <span class="o">!=</span> <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">_refresh_interval</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_ensure_loaded</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">self</span><span class="p">.</span><span class="nf">_stale_or_changed</span><span class="p">():</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_reload_locked</span><span class="p">()</span>

    <span class="c1"># ── LLM 전용 헬퍼 (기존 API 유지) ─────────────────────────────
</span>    <span class="k">def</span> <span class="nf">get_llm_model</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nf">str</span><span class="p">(</span><span class="n">key</span><span class="p">).</span><span class="nf">strip</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sh">"</span><span class="s">model key is empty</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">hit</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_index</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_normalize_key</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
            <span class="c1"># 갱신 지연 가능성 → 강제 리로드 1회 재시도
</span>            <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_reload_locked</span><span class="p">()</span>
                <span class="n">hit</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_index</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_normalize_key</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">model not found: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hit</span>

    <span class="k">def</span> <span class="nf">list_llm_models</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_index</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="n">dn</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">]</span>
            <span class="n">out</span><span class="p">[</span><span class="n">dn</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">request_model</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">request_model</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">],</span>
                <span class="c1"># api_key는 보안상 미노출
</span>            <span class="p">}</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="c1"># ── 범용 접근(옵션): 원본 트리에서 임의 섹션 읽기 ─────────────
</span>    <span class="k">def</span> <span class="nf">get_raw_config</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">전체 설정 트리를 그대로(ENV 확장 후) 반환. 읽기 전용.</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_raw</span>

<span class="c1"># 전역 싱글톤
</span><span class="n">_CONFIG</span> <span class="o">=</span> <span class="nc">ReadOnlyConfig</span><span class="p">()</span>

<span class="c1"># ===== ComfyUI Custom Nodes =====
</span><span class="k">class</span> <span class="nc">LLMConfigLookup</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    입력: model_key (문자열) — </span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="s"> / </span><span class="sh">"</span><span class="s">GPT-4o mini</span><span class="sh">"</span><span class="s"> / </span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="s">(request_model)
    출력: display_name, request_model, base_url, api_key
    </span><span class="sh">"""</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">model_key</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">})}}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">request_model</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">lookup</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">LLM/Config</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">lookup</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">_CONFIG</span><span class="p">.</span><span class="nf">get_llm_model</span><span class="p">(</span><span class="n">model_key</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[LLMConfigLookup] </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">],</span> <span class="n">m</span><span class="p">[</span><span class="sh">"</span><span class="s">request_model</span><span class="sh">"</span><span class="p">],</span> <span class="n">m</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">],</span> <span class="n">m</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">])</span>

<span class="k">class</span> <span class="nc">LLMConfigListModels</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">디버그용: 사용 가능한 LLM 모델 목록(JSON) 반환 (API Key 미포함).</span><span class="sh">"""</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">models_json</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">list_models</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">LLM/Config</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">list_models</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="n">json</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">_CONFIG</span><span class="p">.</span><span class="nf">list_llm_models</span><span class="p">()</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">),)</span>

<span class="c1"># (선택) 범용 조회 노드: 임의 경로를 JSONPath 유사 키로 조회하고 STRING 반환
</span><span class="k">class</span> <span class="nc">ConfigGetRawJSON</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    예) path=</span><span class="sh">"</span><span class="s">feature_flags.use_cache</span><span class="sh">"</span><span class="s"> → </span><span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="s">
        path=</span><span class="sh">"</span><span class="s">storage.s3.region</span><span class="sh">"</span><span class="s"> → </span><span class="sh">"</span><span class="s">ap-northeast-2</span><span class="sh">"</span><span class="s">
    </span><span class="sh">"""</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">})}}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">get_raw</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">LLM/Config</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">get_raw</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="kn">import</span> <span class="n">json</span>
        <span class="k">def</span> <span class="nf">get_in</span><span class="p">(</span><span class="n">d</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">dotted</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">cur</span> <span class="o">=</span> <span class="n">d</span>
            <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">dotted</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">)):</span>
                <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">cur</span><span class="p">:</span>
                    <span class="n">cur</span> <span class="o">=</span> <span class="n">cur</span><span class="p">[</span><span class="n">part</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">config path not found: </span><span class="si">{</span><span class="n">dotted</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">cur</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">raw</span> <span class="o">=</span> <span class="n">_CONFIG</span><span class="p">.</span><span class="nf">get_raw_config</span><span class="p">()</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nf">get_in</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span> <span class="k">if</span> <span class="n">path</span> <span class="k">else</span> <span class="n">raw</span>
            <span class="c1"># 스칼라면 문자열화, 그 외엔 JSON 문자열로 반환
</span>            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">bool</span><span class="p">))</span> <span class="ow">or</span> <span class="n">val</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="nf">return </span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">val</span><span class="p">),)</span>
            <span class="nf">return </span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">),)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[ConfigGetRawJSON] </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="n">NODE_CLASS_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">LLMConfigLookup</span><span class="sh">"</span><span class="p">:</span> <span class="n">LLMConfigLookup</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">LLMConfigListModels</span><span class="sh">"</span><span class="p">:</span> <span class="n">LLMConfigListModels</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">ConfigGetRawJSON</span><span class="sh">"</span><span class="p">:</span> <span class="n">ConfigGetRawJSON</span><span class="p">,</span>  <span class="c1"># ← 범용 읽기 노드(선택)
</span><span class="p">}</span>

<span class="n">NODE_DISPLAY_NAME_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">LLMConfigLookup</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">LLM: Config Lookup (ReadOnly)</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">LLMConfigListModels</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">LLM: List Models (ReadOnly)</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">ConfigGetRawJSON</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Config: Get Raw JSON (ReadOnly)</span><span class="sh">"</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div>

<blockquote>
  <p>노드/패키지명은 그대로 두고, <strong>파일명/환경변수/로더</strong> 만 일반화했습니다. 원하시면 패키지/노드 이름도 <code class="language-plaintext highlighter-rouge">comfyui_config_reader</code>로 리네임해 드릴 수 있어요.</p>
</blockquote>

<hr />

<h1 id="사용-방법-요약">사용 방법 (요약)</h1>

<ol>
  <li>
    <p><code class="language-plaintext highlighter-rouge">config.toml</code>로 설정 저장(범용 섹션 자유 추가 가능).</p>
  </li>
  <li>
    <p>필요 시 경로 오버라이드: <code class="language-plaintext highlighter-rouge">COMFY_CONFIG_PATH=/abs/path/to/config.toml</code></p>
  </li>
  <li>
    <p>새로고침 주기 조정: <code class="language-plaintext highlighter-rouge">COMFY_CONFIG_REFRESH_SECONDS=10</code> (5~60 유효)</p>
  </li>
  <li>
    <p>ComfyUI에서</p>

    <ul>
      <li>
        <p><strong>LLM: Config Lookup</strong> → LLM 엔드포인트 4종 값 출력</p>
      </li>
      <li>
        <p><strong>Config: Get Raw JSON</strong> → 임의 설정 값 읽기 (예: <code class="language-plaintext highlighter-rouge">feature_flags.use_cache</code>)</p>
      </li>
    </ul>
  </li>
  <li>
    <p>파일을 수정하면 <strong>최대 1분 내</strong>(기본 30초) 반영됩니다.</p>
  </li>
</ol>

<p>필요하면 폴더/노드 이름까지 “LLM”을 빼고 전면 리네이밍한 버전도 만들어 드릴게요.</p>

<p class="chat--user">

응 다 빼줘

</p>

<p>좋아—이제 “LLM” 흔적 전부 뺐어요. 패키지/노드/환경변수/카테고리/필드 이름까지 전부 <strong>범용(config/endpoint)</strong>으로 바꾼 최종본을 드립니다. 그대로 넣으면 작동합니다.</p>

<hr />

<h1 id="0-한눈에-보기-step-by-step">0) 한눈에 보기 (step-by-step)</h1>

<ol>
  <li>
    <p><strong>폴더명 변경</strong> : <code class="language-plaintext highlighter-rouge">comfyui_config_reader</code> (이전 폴더 삭제해도 됨)</p>
  </li>
  <li>
    <p><strong>설정 파일명</strong> : <code class="language-plaintext highlighter-rouge">config.toml</code></p>
  </li>
  <li>
    <p><strong>환경변수</strong> :</p>

    <ul>
      <li>
        <p>경로: <code class="language-plaintext highlighter-rouge">COMFY_CONFIG_PATH</code></p>
      </li>
      <li>
        <p>새로고침: <code class="language-plaintext highlighter-rouge">COMFY_CONFIG_REFRESH_SECONDS</code> (5~60초)</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>섹션 이름</strong> : <code class="language-plaintext highlighter-rouge">[endpoints."&lt;키&gt;"]</code> (필드: <code class="language-plaintext highlighter-rouge">display_name</code>, <code class="language-plaintext highlighter-rouge">request_name</code>, <code class="language-plaintext highlighter-rouge">base_url</code>, <code class="language-plaintext highlighter-rouge">api_key</code>)</p>
  </li>
  <li>
    <p><strong>노드 이름</strong> :</p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">ConfigEndpointLookup</code> (엔드포인트 4종 값 반환)</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">ConfigListEndpoints</code> (엔드포인트 목록 JSON)</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">ConfigGetValue</code> (임의 경로 값 가져오기)</p>
      </li>
    </ul>
  </li>
</ol>

<hr />

<h1 id="1-디렉토리-구조">1) 디렉토리 구조</h1>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ComfyUI/
└─ custom_nodes/
   └─ comfyui_config_reader/
      ├─ __init__.py
      ├─ config_reader.py       <span class="c"># 커스텀 노드 + 읽기 전용 로더</span>
      └─ config.toml            <span class="c"># 사람이 편집하기 쉬운 TOML</span>
</code></pre></div></div>

<hr />

<h1 id="2-예시-configtoml-범용">2) 예시 <code class="language-plaintext highlighter-rouge">config.toml</code> (범용)</h1>
<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">version</span> <span class="p">=</span> <span class="mi">1</span>

<span class="nn">[settings]</span>
<span class="c"># 파일 변경 반영 주기(초). "1분 내 반영" 요건 → 기본 30초.</span>
<span class="py">refresh_interval_seconds</span> <span class="p">=</span> <span class="mi">30</span>

<span class="c"># ── 엔드포인트(예: 텍스트 모델, 임베딩 서비스, 사내 API 등) ─────────────</span>
<span class="nn">[endpoints."text-model-a"]</span>
<span class="py">display_name</span>  <span class="p">=</span> <span class="s">"Text Model A"</span>
<span class="py">request_name</span>  <span class="p">=</span> <span class="s">"gpt-4o-mini"</span>         <span class="c"># 실제 요청에 쓸 식별자/모델명/버전 등</span>
<span class="py">base_url</span>      <span class="p">=</span> <span class="s">"https://api.openai.com/v1"</span>
<span class="py">api_key</span>       <span class="p">=</span> <span class="s">"${OPENAI_API_KEY}"</span>   <span class="c"># 환경변수 치환 지원</span>

<span class="nn">[endpoints."text-model-b"]</span>
<span class="py">display_name</span>  <span class="p">=</span> <span class="s">"Text Model B"</span>
<span class="py">request_name</span>  <span class="p">=</span> <span class="s">"claude-3-5-sonnet"</span>
<span class="py">base_url</span>      <span class="p">=</span> <span class="s">"https://api.anthropic.com"</span>
<span class="py">api_key</span>       <span class="p">=</span> <span class="s">"${ANTHROPIC_API_KEY}"</span>

<span class="c"># ── 다른 범용 설정들 ────────────────────────────────────────────────</span>
<span class="nn">[feature_flags]</span>
<span class="py">use_cache</span> <span class="p">=</span> <span class="kc">true</span>
<span class="py">show_beta</span> <span class="p">=</span> <span class="kc">false</span>

<span class="nn">[storage.s3]</span>
<span class="py">bucket</span> <span class="p">=</span> <span class="s">"my-bucket"</span>
<span class="py">region</span> <span class="p">=</span> <span class="s">"ap-northeast-2"</span>
<span class="py">access_key</span> <span class="p">=</span> <span class="s">"${S3_ACCESS_KEY}"</span>
<span class="py">secret_key</span> <span class="p">=</span> <span class="s">"${S3_SECRET_KEY}"</span>
</code></pre></div></div>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">${ENV}</code> 표기는 환경변수로 자동 치환됩니다.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">endpoints."&lt;키&gt;"</code>의 <code class="language-plaintext highlighter-rouge">&lt;키&gt;</code>로, <code class="language-plaintext highlighter-rouge">display_name</code>·<code class="language-plaintext highlighter-rouge">request_name</code> 까지 <strong>모두 조회 키</strong> 로 사용할 수 있어요.</p>
  </li>
</ul>

<hr />

<h1 id="3-코드-config_readerpy">3) 코드: <code class="language-plaintext highlighter-rouge">config_reader.py</code></h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="n">threading</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>

<span class="c1"># Python 3.11+ tomllib / 3.10-: tomli
</span><span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomllib</span>  <span class="c1"># type: ignore
</span>    <span class="n">_TOML_LOADS</span> <span class="o">=</span> <span class="n">tomllib</span><span class="p">.</span><span class="n">loads</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomli</span>  <span class="c1"># type: ignore
</span>    <span class="n">_TOML_LOADS</span> <span class="o">=</span> <span class="n">tomli</span><span class="p">.</span><span class="n">loads</span>

<span class="k">def</span> <span class="nf">_expand_env_vars</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">문자열 내 ${ENV} 패턴을 환경변수로 치환. 그 외 타입은 그대로.</span><span class="sh">"""</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">out</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="sh">""</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nf">len</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">${</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">value</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">env_name</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">env_name</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">out</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nf">_expand_env_vars</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">.</span><span class="nf">items</span><span class="p">()}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="nf">_expand_env_vars</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">value</span>

<span class="k">def</span> <span class="nf">_norm</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="nf">str</span><span class="p">(</span><span class="n">s</span><span class="p">).</span><span class="nf">strip</span><span class="p">().</span><span class="nf">lower</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">ReadOnlyConfig</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    - TOML을 읽어 메모리에 캐시
    - mtime/TTL(최소 5s, 최대 60s)로 자동 재로드
    - 파일 쓰기 없음(read-only)
    - 파일 결정 우선순위:  (1) 인자 path &gt; (2) COMFY_CONFIG_PATH &gt; (3) ./config.toml
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">here</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">)</span>
        <span class="n">chosen</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">path</span>
            <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">COMFY_CONFIG_PATH</span><span class="sh">"</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">here</span><span class="p">,</span> <span class="sh">"</span><span class="s">config.toml</span><span class="sh">"</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">chosen</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_refresh_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span>  <span class="c1"># 기본 30초(&lt;=60s 요건 충족)
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_endpoint_index</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># 정규화 키 -&gt; endpoint dict
</span>
    <span class="k">def</span> <span class="nf">_read_text</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">().</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_build_index_endpoints</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_endpoint_index</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>
        <span class="n">eps</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">endpoints</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">eps</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">ep_key</span><span class="p">,</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">eps</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">cfg</span> <span class="o">=</span> <span class="nf">_expand_env_vars</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>

            <span class="c1"># 필수 필드
</span>            <span class="n">required</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]</span>
            <span class="n">missing</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">required</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cfg</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="n">k</span><span class="p">]).</span><span class="nf">strip</span><span class="p">()]</span>
            <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
                <span class="c1"># 불완전 항목은 스킵
</span>                <span class="k">continue</span>

            <span class="c1"># 접근 키: 정의 키 / display_name / request_name
</span>            <span class="n">candidates</span> <span class="o">=</span> <span class="p">{</span>
                <span class="nf">str</span><span class="p">(</span><span class="n">ep_key</span><span class="p">),</span>
                <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)),</span>
                <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)),</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">candidates</span><span class="p">):</span>
                <span class="n">self</span><span class="p">.</span><span class="n">_endpoint_index</span><span class="p">[</span><span class="nf">_norm</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">]),</span>
                    <span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">]),</span>
                    <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">]),</span>
                    <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]),</span>
                <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_reload_locked</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_text</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nf">_TOML_LOADS</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>

        <span class="c1"># refresh_interval_seconds (5~60) + env override
</span>        <span class="n">conf_val</span> <span class="o">=</span> <span class="nf">int</span><span class="p">((</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">settings</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">refresh_interval_seconds</span><span class="sh">"</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
        <span class="n">conf_val</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="n">conf_val</span><span class="p">))</span>
        <span class="n">env_override</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">COMFY_CONFIG_REFRESH_SECONDS</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">env_override</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">conf_val</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="nf">int</span><span class="p">(</span><span class="n">env_override</span><span class="p">)))</span>
            <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="n">self</span><span class="p">.</span><span class="n">_refresh_interval</span> <span class="o">=</span> <span class="n">conf_val</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_raw</span> <span class="o">=</span> <span class="nf">_expand_env_vars</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_build_index_endpoints</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>

    <span class="k">def</span> <span class="nf">_stale_or_changed</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mtime</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">mtime</span> <span class="o">!=</span> <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">_refresh_interval</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_ensure_loaded</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">self</span><span class="p">.</span><span class="nf">_stale_or_changed</span><span class="p">():</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_reload_locked</span><span class="p">()</span>

    <span class="c1"># ── Endpoints 전용 API ─────────────────────────────────────────
</span>    <span class="k">def</span> <span class="nf">get_endpoint</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nf">str</span><span class="p">(</span><span class="n">key</span><span class="p">).</span><span class="nf">strip</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sh">"</span><span class="s">endpoint key is empty</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">hit</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_endpoint_index</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_norm</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
            <span class="c1"># 갱신 지연 가능성 → 강제 리로드 1회 재시도
</span>            <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_reload_locked</span><span class="p">()</span>
                <span class="n">hit</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_endpoint_index</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_norm</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">endpoint not found: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hit</span>

    <span class="k">def</span> <span class="nf">list_endpoints</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_endpoint_index</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="n">dn</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">]</span>
            <span class="n">out</span><span class="p">[</span><span class="n">dn</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">],</span>
                <span class="c1"># api_key는 보안상 미노출
</span>            <span class="p">}</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="c1"># ── 범용 읽기 ──────────────────────────────────────────────────
</span>    <span class="k">def</span> <span class="nf">get_raw</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_raw</span>

<span class="c1"># 전역 싱글톤
</span><span class="n">_CONFIG</span> <span class="o">=</span> <span class="nc">ReadOnlyConfig</span><span class="p">()</span>

<span class="c1"># ===== ComfyUI Custom Nodes =====
</span><span class="k">class</span> <span class="nc">ConfigEndpointLookup</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    입력: key — </span><span class="sh">"</span><span class="s">text-model-a</span><span class="sh">"</span><span class="s"> / </span><span class="sh">"</span><span class="s">Text Model A</span><span class="sh">"</span><span class="s"> / </span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="s">(request_name)
    출력: display_name, request_name, base_url, api_key (모두 STRING)
    </span><span class="sh">"""</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">key</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">})}}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">lookup</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Config/Endpoints (ReadOnly)</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">lookup</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ep</span> <span class="o">=</span> <span class="n">_CONFIG</span><span class="p">.</span><span class="nf">get_endpoint</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[ConfigEndpointLookup] </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">ep</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">],</span> <span class="n">ep</span><span class="p">[</span><span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">],</span> <span class="n">ep</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">],</span> <span class="n">ep</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">])</span>

<span class="k">class</span> <span class="nc">ConfigListEndpoints</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">디버그/인스펙션용: 엔드포인트 목록(JSON, api_key 미포함).</span><span class="sh">"""</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">endpoints_json</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">list_endpoints</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Config/Endpoints (ReadOnly)</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">list_endpoints</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="n">json</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">_CONFIG</span><span class="p">.</span><span class="nf">list_endpoints</span><span class="p">()</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">),)</span>

<span class="k">class</span> <span class="nc">ConfigGetValue</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    임의 경로 값 읽기 (</span><span class="sh">'</span><span class="s">.</span><span class="sh">'</span><span class="s"> 구분)
    예) path=</span><span class="sh">"</span><span class="s">feature_flags.use_cache</span><span class="sh">"</span><span class="s">  → </span><span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="s">
        path=</span><span class="sh">"</span><span class="s">storage.s3.region</span><span class="sh">"</span><span class="s">        → </span><span class="sh">"</span><span class="s">ap-northeast-2</span><span class="sh">"</span><span class="s">
        path=</span><span class="sh">"</span><span class="s">endpoints.text-model-a</span><span class="sh">"</span><span class="s">   → 해당 엔드포인트 JSON
    </span><span class="sh">"""</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">})}}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">get_value</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Config/General (ReadOnly)</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">get_value</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="kn">import</span> <span class="n">json</span>
        <span class="k">def</span> <span class="nf">get_in</span><span class="p">(</span><span class="n">d</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">dotted</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">cur</span> <span class="o">=</span> <span class="n">d</span>
            <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">dotted</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">)):</span>
                <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">cur</span><span class="p">:</span>
                    <span class="n">cur</span> <span class="o">=</span> <span class="n">cur</span><span class="p">[</span><span class="n">part</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">config path not found: </span><span class="si">{</span><span class="n">dotted</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">cur</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">raw</span> <span class="o">=</span> <span class="n">_CONFIG</span><span class="p">.</span><span class="nf">get_raw</span><span class="p">()</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nf">get_in</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span> <span class="k">if</span> <span class="n">path</span> <span class="k">else</span> <span class="n">raw</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">bool</span><span class="p">))</span> <span class="ow">or</span> <span class="n">val</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="nf">return </span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">val</span><span class="p">),)</span>
            <span class="nf">return </span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">),)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[ConfigGetValue] </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="n">NODE_CLASS_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">ConfigEndpointLookup</span><span class="sh">"</span><span class="p">:</span> <span class="n">ConfigEndpointLookup</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">ConfigListEndpoints</span><span class="sh">"</span><span class="p">:</span>  <span class="n">ConfigListEndpoints</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">ConfigGetValue</span><span class="sh">"</span><span class="p">:</span>       <span class="n">ConfigGetValue</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">NODE_DISPLAY_NAME_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">ConfigEndpointLookup</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Config: Endpoint Lookup</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">ConfigListEndpoints</span><span class="sh">"</span><span class="p">:</span>  <span class="sh">"</span><span class="s">Config: List Endpoints</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">ConfigGetValue</span><span class="sh">"</span><span class="p">:</span>       <span class="sh">"</span><span class="s">Config: Get Value</span><span class="sh">"</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">__init__.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 패키지 인식용 (비워두면 됩니다)
</span></code></pre></div></div>

<hr />

<h1 id="4-요구사항-대응-체크">4) 요구사항 대응 체크</h1>

<ul>
  <li>
    <p>사람이 편집하기 쉬움: <strong>TOML + 주석 가능</strong></p>
  </li>
  <li>
    <p>읽기 전용: <strong>파일 쓰기 없음</strong></p>
  </li>
  <li>
    <p>주요 용도(모델/서비스 엔드포인트): <strong><code class="language-plaintext highlighter-rouge">endpoints</code> 섹션 표준화</strong></p>
  </li>
  <li>
    <p>필요한 값 반환: <code class="language-plaintext highlighter-rouge">ConfigEndpointLookup</code>가 <strong>display_name, request_name, base_url, api_key</strong> 출력</p>
  </li>
  <li>
    <p>변경 반영: <strong>mtime + TTL(기본 30초, 5~60초 조정)</strong> → <strong>최대 1분 내 반영</strong> 보장</p>
  </li>
  <li>
    <p>보안: <strong>환경변수 치환</strong> , 목록 노드에서 <strong>api_key 미노출</strong></p>
  </li>
</ul>

<hr />

<h1 id="5-마이그레이션-가이드">5) 마이그레이션 가이드</h1>

<ul>
  <li>
    <p>예전 파일/이름을 쓰셨다면:</p>

    <ul>
      <li>
        <p>폴더: <code class="language-plaintext highlighter-rouge">custom_nodes/comfyui_llm_config_reader</code> → <strong>삭제</strong> 또는 보관</p>
      </li>
      <li>
        <p>설정: <code class="language-plaintext highlighter-rouge">[llm_models]</code> → <strong><code class="language-plaintext highlighter-rouge">[endpoints]</code> 로 바꾸고 <code class="language-plaintext highlighter-rouge">request_model</code> → <code class="language-plaintext highlighter-rouge">request_name</code></strong></p>
      </li>
      <li>
        <p>노드: 기존 워크플로우에선 새 노드로 교체</p>

        <ul>
          <li>
            <p><code class="language-plaintext highlighter-rouge">LLMConfigLookup</code> → <strong><code class="language-plaintext highlighter-rouge">ConfigEndpointLookup</code></strong></p>
          </li>
          <li>
            <p><code class="language-plaintext highlighter-rouge">LLMConfigListModels</code> → <strong><code class="language-plaintext highlighter-rouge">ConfigListEndpoints</code></strong></p>
          </li>
          <li>
            <p><code class="language-plaintext highlighter-rouge">ConfigGetRawJSON</code> → <strong><code class="language-plaintext highlighter-rouge">ConfigGetValue</code></strong></p>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<hr />

<p>필요하면, 기존 워크플로우 자동 변환 스크립트(YAML/JSON 경로 교체)도 만들어 드릴게요.</p>

<p class="chat--user">

다른 노드 “파일들”에서 설정을 읽어야하는데 이건 어떻게 해? 싱글톤 인터페이스가 좀 어색해보여

</p>

<p>좋은 피드백! “여러 노드/파일에서 자연스럽게 읽는” 패턴으로 바꿔줄게요.<br />
싱글톤 대신 <strong>경로별 Multiton 레지스트리 + 얇은 함수형 API</strong> 를 제공합니다.<br />
즉, 어디서든 <code class="language-plaintext highlighter-rouge">from comfyui_config_reader.config import endpoint, get</code>만 임포트해 쓰면 됩니다.</p>

<p>아래 세 파일만 추가/교체하면 끝!</p>

<hr />

<h1 id="1-구조">1) 구조</h1>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ComfyUI/
└─ custom_nodes/
   └─ comfyui_config_reader/
      ├─ __init__.py
      ├─ config_core.py     <span class="c"># 핵심: ReadOnlyStore (경로별 캐시/자동 리로드)</span>
      ├─ config.py          <span class="c"># 공용 API: endpoint()/get()/get_store()</span>
      └─ config_nodes.py    <span class="c"># (옵션) 데모 노드들: Lookup/List/Get</span>
</code></pre></div></div>

<hr />

<h1 id="2-핵심-스토어-경로별-multiton-아님--인스턴스형-thread-safe">2) 핵심 스토어 (경로별 Multiton 아님 — “인스턴스형”, thread-safe)</h1>

<p><code class="language-plaintext highlighter-rouge">config_core.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="n">threading</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>

<span class="c1"># Python 3.11+: tomllib / 이하: tomli
</span><span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomllib</span>  <span class="c1"># type: ignore
</span>    <span class="n">_TOML_LOADS</span> <span class="o">=</span> <span class="n">tomllib</span><span class="p">.</span><span class="n">loads</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomli</span>  <span class="c1"># type: ignore
</span>    <span class="n">_TOML_LOADS</span> <span class="o">=</span> <span class="n">tomli</span><span class="p">.</span><span class="n">loads</span>

<span class="k">def</span> <span class="nf">_expand_env_vars</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">out</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="sh">""</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nf">len</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">${</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">value</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">env_name</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">env_name</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">out</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nf">_expand_env_vars</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">.</span><span class="nf">items</span><span class="p">()}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="nf">_expand_env_vars</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">value</span>

<span class="k">def</span> <span class="nf">_norm</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="nf">str</span><span class="p">(</span><span class="n">s</span><span class="p">).</span><span class="nf">strip</span><span class="p">().</span><span class="nf">lower</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">ReadOnlyStore</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    - TOML 읽기 전용 스토어
    - mtime/TTL(5~60s) 기반 자동 재로드 → </span><span class="sh">'</span><span class="s">1분 내 반영</span><span class="sh">'</span><span class="s"> 보장
    - 엔드포인트 인덱싱 + 임의 경로 접근
    - 파일 쓰기 없음
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_refresh_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span>  <span class="c1"># 기본 30s
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_endpoint_index</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_version</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># 리로드마다 증가
</span>
    <span class="c1"># ---------- 내부 로딩 ----------
</span>    <span class="k">def</span> <span class="nf">_read_text</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">().</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_build_index_endpoints</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_endpoint_index</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>
        <span class="n">eps</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">endpoints</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">eps</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">ep_key</span><span class="p">,</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">eps</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">cfg</span> <span class="o">=</span> <span class="nf">_expand_env_vars</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
            <span class="n">required</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]</span>
            <span class="k">if</span> <span class="nf">any</span><span class="p">(</span><span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cfg</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="n">k</span><span class="p">]).</span><span class="nf">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">required</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">{</span><span class="nf">str</span><span class="p">(</span><span class="n">ep_key</span><span class="p">),</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)),</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">))}:</span>
                <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">_endpoint_index</span><span class="p">[</span><span class="nf">_norm</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">]),</span>
                        <span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">]),</span>
                        <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">]),</span>
                        <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]),</span>
                    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_reload_locked</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_text</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nf">_TOML_LOADS</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>
        <span class="c1"># refresh_interval_seconds (5~60) + env override
</span>        <span class="n">conf_val</span> <span class="o">=</span> <span class="nf">int</span><span class="p">((</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">settings</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">refresh_interval_seconds</span><span class="sh">"</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
        <span class="n">conf_val</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="n">conf_val</span><span class="p">))</span>
        <span class="n">env_override</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">COMFY_CONFIG_REFRESH_SECONDS</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">env_override</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">conf_val</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="nf">int</span><span class="p">(</span><span class="n">env_override</span><span class="p">)))</span>
            <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="n">self</span><span class="p">.</span><span class="n">_refresh_interval</span> <span class="o">=</span> <span class="n">conf_val</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_raw</span> <span class="o">=</span> <span class="nf">_expand_env_vars</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_build_index_endpoints</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_version</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">_stale_or_changed</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mtime</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">mtime</span> <span class="o">!=</span> <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">_refresh_interval</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_ensure_loaded</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">self</span><span class="p">.</span><span class="nf">_stale_or_changed</span><span class="p">():</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_reload_locked</span><span class="p">()</span>

    <span class="c1"># ---------- 퍼블릭 API ----------
</span>    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">version</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_version</span>

    <span class="k">def</span> <span class="nf">snapshot</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">ENV 치환 후 전체 트리의 </span><span class="sh">'</span><span class="s">일관된 스냅샷</span><span class="sh">'</span><span class="s">을 반환(얕은 복사).</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="k">return</span> <span class="nf">dict</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_value</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">dotted_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_raw</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">dotted_path</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">cur</span><span class="p">:</span>
                <span class="n">cur</span> <span class="o">=</span> <span class="n">cur</span><span class="p">[</span><span class="n">part</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">config path not found: </span><span class="si">{</span><span class="n">dotted_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cur</span>

    <span class="k">def</span> <span class="nf">get_endpoint</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nf">str</span><span class="p">(</span><span class="n">key</span><span class="p">).</span><span class="nf">strip</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sh">"</span><span class="s">endpoint key is empty</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">hit</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_endpoint_index</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_norm</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
            <span class="c1"># 갱신 지연 가능성 → 강제 리로드 1회 재시도
</span>            <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_reload_locked</span><span class="p">()</span>
                <span class="n">hit</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_endpoint_index</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_norm</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">endpoint not found: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hit</span>

    <span class="k">def</span> <span class="nf">list_endpoints</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_endpoint_index</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="n">dn</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">]</span>
            <span class="n">out</span><span class="p">[</span><span class="n">dn</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">],</span>
                <span class="c1"># api_key는 미노출
</span>            <span class="p">}</span>
        <span class="k">return</span> <span class="n">out</span>
</code></pre></div></div>

<hr />

<h1 id="3-공용-api-어디서든-임포트해-쓰는-함수형-인터페이스">3) 공용 API (어디서든 임포트해 쓰는 “함수형” 인터페이스)</h1>

<p><code class="language-plaintext highlighter-rouge">config.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">os</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">from</span> <span class="n">.config_core</span> <span class="kn">import</span> <span class="n">ReadOnlyStore</span>

<span class="c1"># 경로별 Multiton 레지스트리
</span><span class="n">_REGISTRY</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ReadOnlyStore</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">def</span> <span class="nf">_default_path</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">here</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">COMFY_CONFIG_PATH</span><span class="sh">"</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">here</span><span class="p">,</span> <span class="sh">"</span><span class="s">config.toml</span><span class="sh">"</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">get_store</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ReadOnlyStore</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    - 경로별로 ReadOnlyStore 인스턴스를 재사용(멀티톤)
    - 명시 path 없으면 COMFY_CONFIG_PATH 또는 패키지 기본 config.toml
    </span><span class="sh">"""</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">path</span> <span class="ow">or</span> <span class="nf">_default_path</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">p</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_REGISTRY</span><span class="p">:</span>
        <span class="n">_REGISTRY</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="nc">ReadOnlyStore</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_REGISTRY</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>

<span class="c1"># ---- 얇은 함수형 헬퍼들 (권장) ----
</span><span class="k">def</span> <span class="nf">endpoint</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">엔드포인트 dict 반환: display_name, request_name, base_url, api_key</span><span class="sh">"""</span>
    <span class="k">return</span> <span class="nf">get_store</span><span class="p">(</span><span class="n">path</span><span class="p">).</span><span class="nf">get_endpoint</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">endpoints</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
    <span class="sh">"""</span><span class="s">엔드포인트 목록(JSON용)</span><span class="sh">"""</span>
    <span class="k">return</span> <span class="nf">get_store</span><span class="p">(</span><span class="n">path</span><span class="p">).</span><span class="nf">list_endpoints</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">dotted_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">임의 설정값 반환: </span><span class="sh">'</span><span class="s">section.sub.key</span><span class="sh">'"""</span>
    <span class="k">return</span> <span class="nf">get_store</span><span class="p">(</span><span class="n">path</span><span class="p">).</span><span class="nf">get_value</span><span class="p">(</span><span class="n">dotted_path</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">snapshot</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">전체 트리 스냅샷</span><span class="sh">"""</span>
    <span class="k">return</span> <span class="nf">get_store</span><span class="p">(</span><span class="n">path</span><span class="p">).</span><span class="nf">snapshot</span><span class="p">()</span>
</code></pre></div></div>

<blockquote>
  <p>포인트: <strong>다른 노드 파일</strong> 에서는 <code class="language-plaintext highlighter-rouge">config.endpoint()</code>, <code class="language-plaintext highlighter-rouge">config.get()</code> 같은 <strong>함수형 API만</strong> 쓰면 됩니다.<br />
 내부적으로는 경로별 인스턴스를 재사용하지만, 노드 코드에서는 싱글톤에 의존하지 않습니다.</p>
</blockquote>

<hr />

<h1 id="4-옵션-데모-노드--기존-노드를-이-api로-얇게-래핑">4) (옵션) 데모 노드 — 기존 노드를 이 API로 얇게 래핑</h1>

<p><code class="language-plaintext highlighter-rouge">config_nodes.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">.config</span> <span class="kn">import</span> <span class="n">endpoint</span> <span class="k">as</span> <span class="n">_endpoint</span><span class="p">,</span> <span class="n">endpoints</span> <span class="k">as</span> <span class="n">_endpoints</span><span class="p">,</span> <span class="n">get</span> <span class="k">as</span> <span class="n">_get</span>
<span class="kn">import</span> <span class="n">json</span>

<span class="k">class</span> <span class="nc">ConfigEndpointLookup</span><span class="p">:</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">key</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">}),</span>
                             <span class="sh">"</span><span class="s">config_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">})}}</span>
    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">lookup</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Config/Endpoints (ReadOnly)</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">lookup</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">config_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">config_path</span> <span class="ow">or</span> <span class="bp">None</span>
        <span class="n">ep</span> <span class="o">=</span> <span class="nf">_endpoint</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">ep</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">],</span> <span class="n">ep</span><span class="p">[</span><span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">],</span> <span class="n">ep</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">],</span> <span class="n">ep</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">])</span>

<span class="k">class</span> <span class="nc">ConfigListEndpoints</span><span class="p">:</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">config_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">})}}</span>
    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">endpoints_json</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">list_endpoints</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Config/Endpoints (ReadOnly)</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">list_endpoints</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">config_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">config_path</span> <span class="ow">or</span> <span class="bp">None</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nf">_endpoints</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">),)</span>

<span class="k">class</span> <span class="nc">ConfigGetValue</span><span class="p">:</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">}),</span>
                             <span class="sh">"</span><span class="s">config_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">})}}</span>
    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">get_value</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Config/General (ReadOnly)</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">get_value</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">config_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">config_path</span> <span class="ow">or</span> <span class="bp">None</span>
        <span class="n">val</span> <span class="o">=</span> <span class="nf">_get</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">bool</span><span class="p">))</span> <span class="ow">or</span> <span class="n">val</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="nf">return </span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">val</span><span class="p">),)</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">),)</span>

<span class="n">NODE_CLASS_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">ConfigEndpointLookup</span><span class="sh">"</span><span class="p">:</span> <span class="n">ConfigEndpointLookup</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">ConfigListEndpoints</span><span class="sh">"</span><span class="p">:</span>  <span class="n">ConfigListEndpoints</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">ConfigGetValue</span><span class="sh">"</span><span class="p">:</span>       <span class="n">ConfigGetValue</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">NODE_DISPLAY_NAME_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">ConfigEndpointLookup</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Config: Endpoint Lookup</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">ConfigListEndpoints</span><span class="sh">"</span><span class="p">:</span>  <span class="sh">"</span><span class="s">Config: List Endpoints</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">ConfigGetValue</span><span class="sh">"</span><span class="p">:</span>       <span class="sh">"</span><span class="s">Config: Get Value</span><span class="sh">"</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h1 id="5-다른-노드-파일들에서-쓰는-법-가장-깔끔한-패턴">5) 다른 노드 “파일들”에서 쓰는 법 (가장 깔끔한 패턴)</h1>

<p>다른 플러그인/노드 파일 어디에서든:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 예: OpenAI 호출 노드 파일 내부
</span><span class="kn">from</span> <span class="n">comfyui_config_reader.config</span> <span class="kn">import</span> <span class="n">endpoint</span><span class="p">,</span> <span class="n">get</span>

<span class="k">def</span> <span class="nf">_prepare_client</span><span class="p">():</span>
    <span class="n">ep</span> <span class="o">=</span> <span class="nf">endpoint</span><span class="p">(</span><span class="sh">"</span><span class="s">text-model-a</span><span class="sh">"</span><span class="p">)</span>   <span class="c1"># 또는 display_name / request_name로 조회
</span>    <span class="n">api_key</span> <span class="o">=</span> <span class="n">ep</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]</span>
    <span class="n">base_url</span> <span class="o">=</span> <span class="n">ep</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">]</span>
    <span class="c1"># ... 클라이언트 생성
</span>    <span class="k">return</span> <span class="n">api_key</span><span class="p">,</span> <span class="n">base_url</span>

<span class="k">def</span> <span class="nf">_s3_settings</span><span class="p">():</span>
    <span class="n">region</span> <span class="o">=</span> <span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">storage.s3.region</span><span class="sh">"</span><span class="p">)</span>    <span class="c1"># 범용 설정 접근
</span>    <span class="n">bucket</span> <span class="o">=</span> <span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">storage.s3.bucket</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">region</span><span class="p">,</span> <span class="n">bucket</span>
</code></pre></div></div>

<ul>
  <li>
    <p>기본 경로는 <code class="language-plaintext highlighter-rouge">COMFY_CONFIG_PATH</code> 또는 <code class="language-plaintext highlighter-rouge">comfyui_config_reader/config.toml</code>.</p>
  </li>
  <li>
    <p>특정 파일을 쓰고 싶으면 <code class="language-plaintext highlighter-rouge">endpoint("text-model-a", path="/abs/path/to/config.toml")</code>처럼 <strong>함수 인자</strong> 로 주면 됩니다.</p>
  </li>
  <li>
    <p>내부는 <strong>경로별 레지스트리(Multiton)</strong>라 같은 경로는 인스턴스를 공유(성능↑)하지만, 호출부는 <strong>함수형</strong> 이라 싱글톤에 종속되지 않아요.</p>
  </li>
</ul>

<hr />

<h1 id="6-요건-체크">6) 요건 체크</h1>

<ul>
  <li>
    <p>여러 노드/파일에서 공통 사용: <strong>함수형 API</strong> 로 간단 임포트</p>
  </li>
  <li>
    <p>싱글톤 어색함 제거: <strong>경로별 Multiton + helper 함수</strong> → 명시적 DI도 가능(<code class="language-plaintext highlighter-rouge">get_store(path)</code>)</p>
  </li>
  <li>
    <p>읽기 전용 + 1분 내 반영: <strong>mtime + 5~60s TTL(기본 30s)</strong></p>
  </li>
  <li>
    <p>사람이 편집 쉬움: <strong>TOML + ENV 치환</strong></p>
  </li>
  <li>
    <p>엔드포인트 4필드: <code class="language-plaintext highlighter-rouge">display_name, request_name, base_url, api_key</code></p>
  </li>
</ul>

<hr />

<p>필요하면 <code class="language-plaintext highlighter-rouge">get_store(path)</code>로 <strong>명시적 의존성 주입(DI)</strong>도 가능해요. 예컨대 프레임워크 초기화 시:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">comfyui_config_reader.config</span> <span class="kn">import</span> <span class="n">get_store</span>
<span class="n">STORE</span> <span class="o">=</span> <span class="nf">get_store</span><span class="p">(</span><span class="sh">"</span><span class="s">/path/to/config.toml</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># 이후 어디서든:
</span><span class="n">ep</span> <span class="o">=</span> <span class="n">STORE</span><span class="p">.</span><span class="nf">get_endpoint</span><span class="p">(</span><span class="sh">"</span><span class="s">text-model-a</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<p>이렇게 하면 아예 전역 함수도 안 쓰고, “내가 주입한 스토어”만 참조하는 형태로 완전히 분리할 수 있습니다.</p>

<p class="chat--user">

아니 싱글톤은 괜찮은데 외부에서 접근이 쉽지 않아보여서. 싱글톤이 낫지 않아?

</p>

<p>좋아, <strong>싱글톤으로 단순·직관 접근</strong> 가능하게 정리해줄게.<br />
외부 노드 “파일들” 어디서든 한 줄 임포트로 바로 쓰는 형태야:</p>

<ul>
  <li>
    <p>함수형: <code class="language-plaintext highlighter-rouge">from comfyui_config_reader import endpoint, get</code></p>
  </li>
  <li>
    <p>객체형: <code class="language-plaintext highlighter-rouge">from comfyui_config_reader import CONFIG</code></p>
  </li>
</ul>

<p>둘 다 같은 싱글톤 인스턴스를 뒤에서 사용해. (thread-safe, read-only, 1분 내 반영)</p>

<hr />

<h1 id="1-파일-구조-심플">1) 파일 구조 (심플)</h1>
<div class="language-markdown highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ComfyUI/
└─ custom_nodes/
   └─ comfyui_config_reader/
      ├─ __init__.py
      ├─ config_singleton.py   # 싱글톤 본체
      └─ config.toml
</code></pre></div></div>

<hr />

<h1 id="2-configtoml-예시-범용">2) <code class="language-plaintext highlighter-rouge">config.toml</code> 예시 (범용)</h1>
<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">version</span> <span class="p">=</span> <span class="mi">1</span>

<span class="nn">[settings]</span>
<span class="py">refresh_interval_seconds</span> <span class="p">=</span> <span class="mi">30</span>  <span class="c"># 5~60 사이 권장</span>

<span class="nn">[endpoints."text-model-a"]</span>
<span class="py">display_name</span>  <span class="p">=</span> <span class="s">"Text Model A"</span>
<span class="py">request_name</span>  <span class="p">=</span> <span class="s">"gpt-4o-mini"</span>
<span class="py">base_url</span>      <span class="p">=</span> <span class="s">"https://api.openai.com/v1"</span>
<span class="py">api_key</span>       <span class="p">=</span> <span class="s">"${OPENAI_API_KEY}"</span>

<span class="nn">[feature_flags]</span>
<span class="py">use_cache</span> <span class="p">=</span> <span class="kc">true</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">${ENV}</code> 는 환경변수 치환됨.</li>
</ul>

<hr />

<h1 id="3-싱글톤-구현-config_singletonpy">3) 싱글톤 구현: <code class="language-plaintext highlighter-rouge">config_singleton.py</code></h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="n">threading</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>

<span class="c1"># Python 3.11+: tomllib / 이하: tomli
</span><span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomllib</span>  <span class="c1"># type: ignore
</span>    <span class="n">_TOML_LOADS</span> <span class="o">=</span> <span class="n">tomllib</span><span class="p">.</span><span class="n">loads</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomli</span>  <span class="c1"># type: ignore
</span>    <span class="n">_TOML_LOADS</span> <span class="o">=</span> <span class="n">tomli</span><span class="p">.</span><span class="n">loads</span>

<span class="k">def</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">v</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">out</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="sh">""</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nf">len</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">${</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span><span class="n">j</span><span class="p">],</span> <span class="sh">""</span><span class="p">)</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">out</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">v</span><span class="p">.</span><span class="nf">items</span><span class="p">()}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="nf">_expand_env</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">v</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">v</span>

<span class="k">def</span> <span class="nf">_norm</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="nf">str</span><span class="p">(</span><span class="n">s</span><span class="p">).</span><span class="nf">strip</span><span class="p">().</span><span class="nf">lower</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">_ReadOnlyConfig</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    - TOML 파일 읽기 전용
    - mtime 변경 + TTL(5~60s, 기본 30s) 자동 재로드
    - endpoints 4필드 인덱싱(display_name, request_name, base_url, api_key)
    - 임의 경로 접근 가능 (</span><span class="sh">'</span><span class="s">.</span><span class="sh">'</span><span class="s"> 구분)
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_refresh</span> <span class="o">=</span> <span class="mi">30</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_ep_index</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># -------- 내부 로딩 --------
</span>    <span class="k">def</span> <span class="nf">_read_text</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">().</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_build_index</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_ep_index</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>
        <span class="n">eps</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">endpoints</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">eps</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span> <span class="k">return</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">eps</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span> <span class="k">continue</span>
            <span class="n">cfg</span> <span class="o">=</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
            <span class="n">req</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]</span>
            <span class="k">if</span> <span class="nf">any</span><span class="p">(</span><span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cfg</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="n">k</span><span class="p">]).</span><span class="nf">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">req</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">{</span><span class="nf">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)),</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">))}:</span>
                <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">_ep_index</span><span class="p">[</span><span class="nf">_norm</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">]),</span>
                        <span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">]),</span>
                        <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">]),</span>
                        <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]),</span>
                    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_reload_locked</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_text</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nf">_TOML_LOADS</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>
        <span class="c1"># refresh_interval_seconds (5~60) + env override
</span>        <span class="n">r</span> <span class="o">=</span> <span class="nf">int</span><span class="p">((</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">settings</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">refresh_interval_seconds</span><span class="sh">"</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
        <span class="n">r</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="n">r</span><span class="p">))</span>
        <span class="n">env_r</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">COMFY_CONFIG_REFRESH_SECONDS</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">env_r</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span> <span class="n">r</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="nf">int</span><span class="p">(</span><span class="n">env_r</span><span class="p">)))</span>
            <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span> <span class="k">pass</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_refresh</span> <span class="o">=</span> <span class="n">r</span>

        <span class="n">self</span><span class="p">.</span><span class="n">_raw</span> <span class="o">=</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_build_index</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>

    <span class="k">def</span> <span class="nf">_stale_or_changed</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">m</span> <span class="o">!=</span> <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">_refresh</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_ensure_loaded</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">self</span><span class="p">.</span><span class="nf">_stale_or_changed</span><span class="p">():</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_reload_locked</span><span class="p">()</span>

    <span class="c1"># -------- 퍼블릭 API --------
</span>    <span class="k">def</span> <span class="nf">endpoint</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nf">str</span><span class="p">(</span><span class="n">key</span><span class="p">).</span><span class="nf">strip</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sh">"</span><span class="s">endpoint key is empty</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">hit</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_ep_index</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_norm</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
            <span class="c1"># 즉시 재시도(갱신 지연 보정)
</span>            <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_reload_locked</span><span class="p">()</span>
                <span class="n">hit</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_ep_index</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_norm</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">endpoint not found: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hit</span>

    <span class="k">def</span> <span class="nf">endpoints</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_ep_index</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="n">out</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">],</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="n">out</span>  <span class="c1"># api_key 미노출
</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">dotted</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_raw</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">dotted</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">cur</span><span class="p">:</span>
                <span class="n">cur</span> <span class="o">=</span> <span class="n">cur</span><span class="p">[</span><span class="n">part</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">config path not found: </span><span class="si">{</span><span class="n">dotted</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cur</span>

    <span class="k">def</span> <span class="nf">snapshot</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="k">return</span> <span class="nf">dict</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">)</span>

<span class="c1"># ===== 모듈 전역 싱글톤 =====
</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
<span class="n">_instance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_ReadOnlyConfig</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">_default_path</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c1"># configure()로 지정 가능
</span>
<span class="k">def</span> <span class="nf">_resolve_default_path</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">here</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_default_path</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">COMFY_CONFIG_PATH</span><span class="sh">"</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">here</span><span class="p">,</span> <span class="sh">"</span><span class="s">config.toml</span><span class="sh">"</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">_get_instance</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">_ReadOnlyConfig</span><span class="p">:</span>
    <span class="k">global</span> <span class="n">_instance</span>
    <span class="k">if</span> <span class="n">_instance</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_instance</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">_instance</span> <span class="o">=</span> <span class="nf">_ReadOnlyConfig</span><span class="p">(</span><span class="nf">_resolve_default_path</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">_instance</span>

<span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">refresh_seconds</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    싱글톤 설정(선택): 경로/TTL 오버라이드.
    - 가능한 한 </span><span class="sh">'</span><span class="s">초기화 시 1회</span><span class="sh">'</span><span class="s">만 호출 추천.
    - 이후에도 호출 가능하며, 새 인스턴스로 교체됨( thread-safe ).
    </span><span class="sh">"""</span>
    <span class="k">global</span> <span class="n">_instance</span><span class="p">,</span> <span class="n">_default_path</span>
    <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
        <span class="n">_default_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">refresh_seconds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="sh">"</span><span class="s">COMFY_CONFIG_REFRESH_SECONDS</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">refresh_seconds</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">_lock</span><span class="p">:</span>
        <span class="n">_instance</span> <span class="o">=</span> <span class="nf">_ReadOnlyConfig</span><span class="p">(</span><span class="nf">_resolve_default_path</span><span class="p">())</span>

<span class="c1"># ---- 외부에 노출할 얇은 API (가장 쉬운 접근) ----
</span><span class="k">def</span> <span class="nf">endpoint</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
    <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">endpoint</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">endpoints</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
    <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">endpoints</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">dotted</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">get</span><span class="p">(</span><span class="n">dotted</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">snapshot</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">snapshot</span><span class="p">()</span>

<span class="c1"># ---- 객체형 접근을 위한 프록시(CONFIG) ----
</span><span class="k">class</span> <span class="nc">_ConfigProxy</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="c1"># CONFIG.endpoint(...), CONFIG.get(...) 형태 지원
</span>        <span class="k">return</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">_get_instance</span><span class="p">(),</span> <span class="n">name</span><span class="p">)</span>

<span class="n">CONFIG</span> <span class="o">=</span> <span class="nf">_ConfigProxy</span><span class="p">()</span>
</code></pre></div></div>

<hr />

<h1 id="4-__init__py-한-줄-임포트-지원">4) <code class="language-plaintext highlighter-rouge">__init__.py</code> (한 줄 임포트 지원)</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 외부에서 아주 간단히 접근 가능하게 re-export
</span><span class="kn">from</span> <span class="n">.config_singleton</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CONFIG</span><span class="p">,</span>        <span class="c1"># 객체형: CONFIG.endpoint(...), CONFIG.get(...)
</span>    <span class="n">configure</span><span class="p">,</span>     <span class="c1"># 선택: 초기화 시 경로/TTL 지정
</span>    <span class="n">endpoint</span><span class="p">,</span>      <span class="c1"># 함수형: endpoint("text-model-a")
</span>    <span class="n">endpoints</span><span class="p">,</span>
    <span class="n">get</span><span class="p">,</span>
    <span class="n">snapshot</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div>

<hr />

<h1 id="5-외부-노드-파일들에서-쓰는-법">5) 외부 노드 “파일들”에서 쓰는 법</h1>

<h2 id="가장-간단-함수형">가장 간단 (함수형)</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">comfyui_config_reader</span> <span class="kn">import</span> <span class="n">endpoint</span><span class="p">,</span> <span class="n">get</span>

<span class="k">def</span> <span class="nf">build_client</span><span class="p">():</span>
    <span class="n">ep</span> <span class="o">=</span> <span class="nf">endpoint</span><span class="p">(</span><span class="sh">"</span><span class="s">text-model-a</span><span class="sh">"</span><span class="p">)</span>  <span class="c1"># 키 / display_name / request_name 중 아무거나 OK
</span>    <span class="n">base_url</span> <span class="o">=</span> <span class="n">ep</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">]</span>
    <span class="n">api_key</span>  <span class="o">=</span> <span class="n">ep</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]</span>
    <span class="c1"># ... 클라이언트 생성
</span></code></pre></div></div>

<h2 id="객체형이-익숙하다면">객체형이 익숙하다면</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">comfyui_config_reader</span> <span class="kn">import</span> <span class="n">CONFIG</span>

<span class="k">def</span> <span class="nf">build_client</span><span class="p">():</span>
    <span class="n">ep</span> <span class="o">=</span> <span class="n">CONFIG</span><span class="p">.</span><span class="nf">endpoint</span><span class="p">(</span><span class="sh">"</span><span class="s">text-model-a</span><span class="sh">"</span><span class="p">)</span>
    <span class="c1"># CONFIG.get("storage.s3.region") 등도 동일
</span></code></pre></div></div>

<h2 id="시작-시-경로ttl-지정선택">시작 시 경로/TTL 지정(선택)</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 예: __init__ 혹은 ComfyUI 부팅 초기에 한 번
</span><span class="kn">from</span> <span class="n">comfyui_config_reader</span> <span class="kn">import</span> <span class="n">configure</span>
<span class="nf">configure</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="sh">"</span><span class="s">/abs/path/to/config.toml</span><span class="sh">"</span><span class="p">,</span> <span class="n">refresh_seconds</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>  <span class="c1"># 5~60 사이
</span></code></pre></div></div>

<ul>
  <li>이후 모든 모듈에서 같은 싱글톤을 사용하고, 파일 변경은 <strong>최대 1분 내</strong> 반영돼요(기본 30초, env/설정으로 조절).</li>
</ul>

<hr />

<h1 id="6-요건-재확인">6) 요건 재확인</h1>

<ul>
  <li>
    <p>✅ 외부 접근 쉬움: <code class="language-plaintext highlighter-rouge">from comfyui_config_reader import endpoint</code> 또는 <code class="language-plaintext highlighter-rouge">CONFIG.endpoint</code></p>
  </li>
  <li>
    <p>✅ 싱글톤: 모듈 전역 한 개 인스턴스, thread-safe lazy init</p>
  </li>
  <li>
    <p>✅ 읽기 전용: 쓰기 없음</p>
  </li>
  <li>
    <p>✅ 1분 내 반영: mtime + TTL(기본 30s, 5~60s)</p>
  </li>
  <li>
    <p>✅ 사람이 편집 쉬움: TOML + <code class="language-plaintext highlighter-rouge">${ENV}</code> 치환</p>
  </li>
  <li>
    <p>✅ 엔드포인트 4필드: <code class="language-plaintext highlighter-rouge">display_name</code>, <code class="language-plaintext highlighter-rouge">request_name</code>, <code class="language-plaintext highlighter-rouge">base_url</code>, <code class="language-plaintext highlighter-rouge">api_key</code></p>
  </li>
</ul>

<p>필요하면, 지금 구조 위에 “엔드포인트 호출용 노드”도 바로 얹어줄게.</p>

<p class="chat--user">

endpoint 말고 좀 더 좋은 용어 선정해줘. 그리고 model configuration (parameter 등도 설정에 같이 포함시키면 좋겠어)

</p>

<p>좋아! “endpoint” 대신 더 자연스러운 용어로 <strong>profile(프로필)</strong> 을 쓰고, 여기에 <strong>model configuration(파라미터 등)</strong> 까지 함께 담는 방향으로 정리했어.<br />
외부 노드/파일에서는 <strong>싱글톤</strong> 을 아주 간단히 쓰면 되고, 기존 endpoint 명칭은 <strong>하위 호환 별칭</strong> 도 제공해둘게.</p>

<hr />

<h1 id="1-용어-선정-step-by-step">1) 용어 선정 (step-by-step)</h1>

<ol>
  <li>
    <p><strong>profile (프로필)</strong> — 사람이 이해하기 쉬움. “연결 정보 + 호출 규칙 + 모델 파라미터 묶음”을 한 세트로 보기에 적합.</p>
  </li>
  <li>
    <p>대안(참고): provider, backend, connector, target.</p>

    <ul>
      <li>기술적으로는 <em>backend</em> 도 괜찮지만, “설정 묶음” 뉘앙스는 <em>profile</em> 이 가장 직관적.</li>
    </ul>
  </li>
  <li>
    <p>결론: <strong>profiles</strong> 섹션으로 표준화하고, <strong>endpoints</strong> 는 자동 인식(하위 호환) 유지.</p>
  </li>
</ol>

<hr />

<h1 id="2-configtoml-스키마-모델-파라미터-포함">2) config.toml 스키마 (모델 파라미터 포함)</h1>
<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">version</span> <span class="p">=</span> <span class="mi">1</span>

<span class="nn">[settings]</span>
<span class="c"># 파일 변경 감지 주기(초). 5~60 권장. "1분 내 반영" 요건 만족.</span>
<span class="py">refresh_interval_seconds</span> <span class="p">=</span> <span class="mi">30</span>

<span class="c"># 모든 프로필에 공통 적용될 기본값(선택)</span>
<span class="nn">[defaults.params]</span>
<span class="py">temperature</span> <span class="p">=</span> <span class="mf">0.3</span>
<span class="py">max_tokens</span>  <span class="p">=</span> <span class="mi">2048</span>

<span class="nn">[defaults.http]</span>
<span class="py">timeout_seconds</span> <span class="p">=</span> <span class="mi">30</span>
<span class="nn">[defaults.http.headers]</span>
<span class="py">User-Agent</span> <span class="p">=</span> <span class="s">"ComfyUI-ConfigReader/1.0"</span>
<span class="nn">[defaults.http.query]</span>
<span class="c"># 공통 쿼리 파라미터가 필요하면 여기에</span>

<span class="c"># ── 프로필들 ─────────────────────────────────────────────</span>
<span class="nn">[profiles."text-model-a"]</span>
<span class="py">display_name</span>  <span class="p">=</span> <span class="s">"Text Model A"</span>
<span class="py">request_name</span>  <span class="p">=</span> <span class="s">"gpt-4o-mini"</span>
<span class="py">base_url</span>      <span class="p">=</span> <span class="s">"https://api.openai.com/v1"</span>
<span class="py">api_key</span>       <span class="p">=</span> <span class="s">"${OPENAI_API_KEY}"</span>

<span class="c"># 이 프로필의 모델 파라미터(기본값 위에 덮어쓰기)</span>
<span class="nn">[profiles."text-model-a".params]</span>
<span class="py">temperature</span> <span class="p">=</span> <span class="mf">0.2</span>
<span class="py">top_p</span>       <span class="p">=</span> <span class="mf">0.9</span>
<span class="py">stop</span>        <span class="p">=</span> <span class="p">[</span><span class="s">"</span><span class="se">\n\n</span><span class="s">Human:"</span><span class="p">,</span> <span class="s">"</span><span class="se">\n\n</span><span class="s">Assistant:"</span><span class="p">]</span>

<span class="c"># HTTP 관련(선택): 헤더, 타임아웃, 쿼리 등</span>
<span class="nn">[profiles."text-model-a".http]</span>
<span class="py">timeout_seconds</span> <span class="p">=</span> <span class="mi">20</span>
<span class="nn">[profiles."text-model-a".http.headers]</span>
<span class="py">X-Org-Id</span> <span class="p">=</span> <span class="s">"${ORG_ID}"</span>
<span class="nn">[profiles."text-model-a".http.query]</span>
<span class="py">apiVersion</span> <span class="p">=</span> <span class="s">"2024-06-01"</span>

<span class="nn">[profiles."text-model-b"]</span>
<span class="py">display_name</span>  <span class="p">=</span> <span class="s">"Text Model B"</span>
<span class="py">request_name</span>  <span class="p">=</span> <span class="s">"claude-3-5-sonnet"</span>
<span class="py">base_url</span>      <span class="p">=</span> <span class="s">"https://api.anthropic.com"</span>
<span class="py">api_key</span>       <span class="p">=</span> <span class="s">"${ANTHROPIC_API_KEY}"</span>
<span class="c"># params/http 섹션이 없으면 defaults만 적용</span>
</code></pre></div></div>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">${ENV}</code> 는 환경변수 치환됨.</p>
  </li>
  <li>
    <p><strong>params</strong> : temperature/top_p/max_tokens/stop/seed 등 원하는 파라미터 자유 확장.</p>
  </li>
  <li>
    <p><strong>http</strong> : timeout_seconds / headers / query 등 요청 관련 옵션.</p>
  </li>
  <li>
    <p>상단의 <strong>[defaults]</strong> 는 모든 프로필에 <strong>병합(merge)</strong> 되어 기본값 역할.</p>
  </li>
</ul>

<hr />

<h1 id="3-싱글톤-api-drop-in-profile--params--http">3) 싱글톤 API (drop-in): profile + params + http</h1>

<p>외부 어디서든 한 줄로 접근:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">comfyui_config_reader</span> <span class="kn">import</span> <span class="n">profile</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">http</span><span class="p">,</span> <span class="n">get</span>
<span class="c1"># 또는 객체형:
</span><span class="kn">from</span> <span class="n">comfyui_config_reader</span> <span class="kn">import</span> <span class="n">CONFIG</span>
</code></pre></div></div>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">profile(key)</code> → 연결정보 + 모델파라미터 + http 설정까지 <strong>한 번에</strong></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">params(key)</code> → 해당 프로필의 <strong>모델 파라미터 dict</strong></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">http(key)</code> → 해당 프로필의 <strong>HTTP 옵션 dict</strong></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">get("storage.s3.region")</code> 처럼 범용 키 접근도 유지</p>
  </li>
  <li>
    <p>하위 호환: <code class="language-plaintext highlighter-rouge">endpoint</code>, <code class="language-plaintext highlighter-rouge">endpoints</code> 별칭도 남겨둠(기존 코드 안깨짐)</p>
  </li>
</ul>

<hr />

<h1 id="4-교체본-코드-config_singletonpy">4) 교체본 코드 (<code class="language-plaintext highlighter-rouge">config_singleton.py</code>)</h1>

<p>아래 파일 하나로 기존 싱글톤 구현을 대체하면 돼. (기능: profiles + defaults 병합 + params/http 지원 + legacy <code class="language-plaintext highlighter-rouge">endpoints</code> 인식)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="n">threading</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>

<span class="c1"># Python 3.11+: tomllib / 이하: tomli
</span><span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomllib</span>  <span class="c1"># type: ignore
</span>    <span class="n">_TOML_LOADS</span> <span class="o">=</span> <span class="n">tomllib</span><span class="p">.</span><span class="n">loads</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomli</span>  <span class="c1"># type: ignore
</span>    <span class="n">_TOML_LOADS</span> <span class="o">=</span> <span class="n">tomli</span><span class="p">.</span><span class="n">loads</span>

<span class="k">def</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">v</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">out</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="sh">""</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nf">len</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">${</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span><span class="n">j</span><span class="p">],</span> <span class="sh">""</span><span class="p">)</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">out</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">v</span><span class="p">.</span><span class="nf">items</span><span class="p">()}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="nf">_expand_env</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">v</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">v</span>

<span class="k">def</span> <span class="nf">_norm</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="nf">str</span><span class="p">(</span><span class="n">s</span><span class="p">).</span><span class="nf">strip</span><span class="p">().</span><span class="nf">lower</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_deep_merge</span><span class="p">(</span><span class="n">base</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">over</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">얕은 dict update가 아닌, 중첩 dict까지 병합.</span><span class="sh">"""</span>
    <span class="n">out</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="n">over</span> <span class="ow">or</span> <span class="p">{}).</span><span class="nf">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">out</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nf">_deep_merge</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="k">class</span> <span class="nc">_ReadOnlyConfig</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    - 읽기 전용 TOML
    - mtime + TTL(5~60s, 기본 30s) 자동 재로드 → 1분 내 변경 반영
    - </span><span class="sh">'</span><span class="s">profiles</span><span class="sh">'</span><span class="s"> 표준 + </span><span class="sh">'</span><span class="s">endpoints</span><span class="sh">'</span><span class="s"> 레거시도 자동 인식
    - 각 profile에:
        * display_name, request_name, base_url, api_key (필수)
        * params(dict)  : 모델 파라미터
        * http(dict)    : timeout_seconds, headers{}, query{}
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_refresh</span> <span class="o">=</span> <span class="mi">30</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># 정규화 키 -&gt; profile dict
</span>
    <span class="c1"># -------- 내부 로딩 --------
</span>    <span class="k">def</span> <span class="nf">_read_text</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">().</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_extract_profiles_table</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="c1"># 표준 'profiles' 우선, 없으면 'endpoints'(하위 호환)
</span>        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">profiles</span><span class="sh">"</span><span class="p">),</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">profiles</span><span class="sh">"</span><span class="p">]</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">endpoints</span><span class="sh">"</span><span class="p">),</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">endpoints</span><span class="sh">"</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_build_index</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>

        <span class="c1"># defaults (ENV 확장 포함)
</span>        <span class="n">defaults</span> <span class="o">=</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">defaults</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="n">defaults_params</span> <span class="o">=</span> <span class="n">defaults</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">defaults_http</span>   <span class="o">=</span> <span class="n">defaults</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">http</span><span class="sh">"</span><span class="p">)</span>   <span class="ow">or</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">defaults_http</span><span class="p">:</span> <span class="n">defaults_http</span><span class="p">[</span><span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="sh">"</span><span class="s">query</span><span class="sh">"</span>   <span class="ow">not</span> <span class="ow">in</span> <span class="n">defaults_http</span><span class="p">:</span> <span class="n">defaults_http</span><span class="p">[</span><span class="sh">"</span><span class="s">query</span><span class="sh">"</span><span class="p">]</span>   <span class="o">=</span> <span class="p">{}</span>

        <span class="n">profiles_tbl</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_extract_profiles_table</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">profiles_tbl</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">raw_cfg</span> <span class="ow">in</span> <span class="n">profiles_tbl</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">raw_cfg</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">cfg</span> <span class="o">=</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">raw_cfg</span><span class="p">)</span>  <span class="c1"># ENV 치환
</span>            <span class="c1"># 필수 필드
</span>            <span class="n">req</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]</span>
            <span class="k">if</span> <span class="nf">any</span><span class="p">(</span><span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cfg</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="n">k</span><span class="p">]).</span><span class="nf">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">req</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="c1"># params/http 병합 (defaults → profile override)
</span>            <span class="n">p_params</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
            <span class="n">p_http</span>   <span class="o">=</span> <span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">http</span><span class="sh">"</span><span class="p">)</span>   <span class="ow">or</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">p_http</span><span class="p">:</span> <span class="n">p_http</span><span class="p">[</span><span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="sh">"</span><span class="s">query</span><span class="sh">"</span>   <span class="ow">not</span> <span class="ow">in</span> <span class="n">p_http</span><span class="p">:</span> <span class="n">p_http</span><span class="p">[</span><span class="sh">"</span><span class="s">query</span><span class="sh">"</span><span class="p">]</span>   <span class="o">=</span> <span class="p">{}</span>

            <span class="n">merged_params</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">defaults_params</span><span class="p">,</span> <span class="o">**</span><span class="n">p_params</span><span class="p">}</span>
            <span class="n">merged_http</span>   <span class="o">=</span> <span class="nf">_deep_merge</span><span class="p">(</span><span class="n">defaults_http</span><span class="p">,</span> <span class="n">p_http</span><span class="p">)</span>

            <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">]),</span>
                <span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">]),</span>
                <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span>     <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">]),</span>
                <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">:</span>      <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]),</span>
                <span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">:</span>       <span class="n">merged_params</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">http</span><span class="sh">"</span><span class="p">:</span>         <span class="n">merged_http</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="c1"># 접근 키: 정의 키 / display_name / request_name
</span>            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">{</span><span class="nf">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)),</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">))}:</span>
                <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">[</span><span class="nf">_norm</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span> <span class="o">=</span> <span class="n">entry</span>

    <span class="k">def</span> <span class="nf">_reload_locked</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_text</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nf">_TOML_LOADS</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>

        <span class="c1"># refresh_interval_seconds (5~60) + env override
</span>        <span class="n">r</span> <span class="o">=</span> <span class="nf">int</span><span class="p">((</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">settings</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">refresh_interval_seconds</span><span class="sh">"</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
        <span class="n">r</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="n">r</span><span class="p">))</span>
        <span class="n">env_r</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">COMFY_CONFIG_REFRESH_SECONDS</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">env_r</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span> <span class="n">r</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="nf">int</span><span class="p">(</span><span class="n">env_r</span><span class="p">)))</span>
            <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span> <span class="k">pass</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_refresh</span> <span class="o">=</span> <span class="n">r</span>

        <span class="n">self</span><span class="p">.</span><span class="n">_raw</span> <span class="o">=</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_build_index</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>

    <span class="k">def</span> <span class="nf">_stale_or_changed</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">m</span> <span class="o">!=</span> <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">_refresh</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_ensure_loaded</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">self</span><span class="p">.</span><span class="nf">_stale_or_changed</span><span class="p">():</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_reload_locked</span><span class="p">()</span>

    <span class="c1"># -------- 퍼블릭 API --------
</span>    <span class="k">def</span> <span class="nf">profile</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nf">str</span><span class="p">(</span><span class="n">key</span><span class="p">).</span><span class="nf">strip</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sh">"</span><span class="s">profile key is empty</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">hit</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_norm</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
            <span class="c1"># 즉시 재시도(갱신 지연 보정)
</span>            <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_reload_locked</span><span class="p">()</span>
                <span class="n">hit</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_norm</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">profile not found: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hit</span>

    <span class="k">def</span> <span class="nf">profiles</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="sh">"""</span><span class="s">api_key는 숨기고, 나머지 메타/params/http는 노출.</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="nf">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="n">dn</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">dn</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>  <span class="c1"># display_name 중복 키 방지
</span>                <span class="k">continue</span>
            <span class="n">seen</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">dn</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="n">dn</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span>     <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">:</span>       <span class="n">v</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span>
                <span class="sh">"</span><span class="s">http</span><span class="sh">"</span><span class="p">:</span>         <span class="n">v</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">http</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">params</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nf">dict</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">profile</span><span class="p">(</span><span class="n">key</span><span class="p">).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}))</span>

    <span class="k">def</span> <span class="nf">http</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nf">dict</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">profile</span><span class="p">(</span><span class="n">key</span><span class="p">).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">http</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}))</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">dotted</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_raw</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">dotted</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">cur</span><span class="p">:</span>
                <span class="n">cur</span> <span class="o">=</span> <span class="n">cur</span><span class="p">[</span><span class="n">part</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">config path not found: </span><span class="si">{</span><span class="n">dotted</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cur</span>

    <span class="k">def</span> <span class="nf">snapshot</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="k">return</span> <span class="nf">dict</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">)</span>

<span class="c1"># ===== 모듈 전역 싱글톤 =====
</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
<span class="n">_instance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_ReadOnlyConfig</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">_default_path</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c1"># configure()로 지정 가능
</span>
<span class="k">def</span> <span class="nf">_resolve_default_path</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">here</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_default_path</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">COMFY_CONFIG_PATH</span><span class="sh">"</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">here</span><span class="p">,</span> <span class="sh">"</span><span class="s">config.toml</span><span class="sh">"</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">_get_instance</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">_ReadOnlyConfig</span><span class="p">:</span>
    <span class="k">global</span> <span class="n">_instance</span>
    <span class="k">if</span> <span class="n">_instance</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_instance</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">_instance</span> <span class="o">=</span> <span class="nf">_ReadOnlyConfig</span><span class="p">(</span><span class="nf">_resolve_default_path</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">_instance</span>

<span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">refresh_seconds</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">선택: 경로/TTL 오버라이드(초기화 시 1회 권장).</span><span class="sh">"""</span>
    <span class="k">global</span> <span class="n">_instance</span><span class="p">,</span> <span class="n">_default_path</span>
    <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
        <span class="n">_default_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">refresh_seconds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="sh">"</span><span class="s">COMFY_CONFIG_REFRESH_SECONDS</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">refresh_seconds</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">_lock</span><span class="p">:</span>
        <span class="n">_instance</span> <span class="o">=</span> <span class="nf">_ReadOnlyConfig</span><span class="p">(</span><span class="nf">_resolve_default_path</span><span class="p">())</span>

<span class="c1"># ---- 외부에 노출할 간단 API ----
</span><span class="k">def</span> <span class="nf">profile</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">profile</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">profiles</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">profiles</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">params</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">params</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">http</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">http</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">dotted</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">get</span><span class="p">(</span><span class="n">dotted</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">snapshot</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">snapshot</span><span class="p">()</span>

<span class="c1"># ---- 하위 호환 별칭 (endpoint*) ----
</span><span class="k">def</span> <span class="nf">endpoint</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">return</span> <span class="nf">profile</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">endpoints</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="k">return</span> <span class="nf">profiles</span><span class="p">()</span>

<span class="c1"># ---- 객체형 접근 프록시(CONFIG) ----
</span><span class="k">class</span> <span class="nc">_ConfigProxy</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">_get_instance</span><span class="p">(),</span> <span class="n">name</span><span class="p">)</span>

<span class="n">CONFIG</span> <span class="o">=</span> <span class="nf">_ConfigProxy</span><span class="p">()</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">__init__.py</code> (re-export)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">.config_singleton</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CONFIG</span><span class="p">,</span>
    <span class="n">configure</span><span class="p">,</span>
    <span class="n">profile</span><span class="p">,</span> <span class="n">profiles</span><span class="p">,</span>
    <span class="n">params</span><span class="p">,</span> <span class="n">http</span><span class="p">,</span>
    <span class="n">get</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">,</span>
    <span class="c1"># legacy alias
</span>    <span class="n">endpoint</span><span class="p">,</span> <span class="n">endpoints</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div>

<hr />

<h1 id="5-외부에서-쓰는-법-예시">5) 외부에서 쓰는 법 (예시)</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">comfyui_config_reader</span> <span class="kn">import</span> <span class="n">profile</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">http</span>

<span class="c1"># (1) 한 번에 전부 받기
</span><span class="n">cfg</span> <span class="o">=</span> <span class="nf">profile</span><span class="p">(</span><span class="sh">"</span><span class="s">Text Model A</span><span class="sh">"</span><span class="p">)</span>  <span class="c1"># 또는 "text-model-a" / "gpt-4o-mini"
</span><span class="n">api_key</span>   <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]</span>
<span class="n">base_url</span>  <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">]</span>
<span class="n">req_name</span>  <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">]</span>
<span class="n">p</span>         <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">]</span>      <span class="c1"># dict (temperature/top_p/...)
</span><span class="n">h</span>         <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">http</span><span class="sh">"</span><span class="p">]</span>        <span class="c1"># dict (timeout_seconds/headers/query)
</span>
<span class="c1"># (2) 필요만 따로
</span><span class="n">p</span> <span class="o">=</span> <span class="nf">params</span><span class="p">(</span><span class="sh">"</span><span class="s">text-model-a</span><span class="sh">"</span><span class="p">)</span>
<span class="n">h</span> <span class="o">=</span> <span class="nf">http</span><span class="p">(</span><span class="sh">"</span><span class="s">text-model-a</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<h1 id="6-포인트-정리">6) 포인트 정리</h1>

<ul>
  <li>
    <p>“endpoint” → <strong>“profile”</strong> 로 명확화 (설정 묶음)</p>
  </li>
  <li>
    <p><strong>model configuration(params)</strong> 을 프로필 내부에 포함, <strong>defaults</strong> 로 공통값 지원</p>
  </li>
  <li>
    <p>싱글톤 그대로 유지 + <strong>외부 접근 간단화</strong>(함수/객체형 모두)</p>
  </li>
  <li>
    <p>하위 호환: <code class="language-plaintext highlighter-rouge">endpoint(s)</code> 별칭 제공</p>
  </li>
  <li>
    <p>파일 변경은 <strong>최대 1분 내 반영</strong>(mtime + TTL 5~60s, 기본 30s)</p>
  </li>
</ul>

<p>원하면, ComfyUI 노드(시각적)도 <code class="language-plaintext highlighter-rouge">params/http</code>를 JSON으로 같이 내보내는 <code class="language-plaintext highlighter-rouge">ConfigProfileLookup</code> 노드 버전도 바로 만들어 줄게!</p>

<p class="chat--user">

profile은 좀 너무 범용적인데

</p>

<p>좋아, “profile”이 너무 범용적으로 느껴진다면 더 목적에 딱 맞는 <strong>preset(프리셋)</strong> 으로 용어를 좁히자고 제안할게. “프리셋”은 <em>모델 연결 정보 + 요청 식별자 + 모델 파라미터 + HTTP 옵션</em> 을 한 세트로 담는 의미가 분명하고, UI/워크플로우에서도 흔히 쓰이는 표현이라 직관적이야.<br />
아래는 <strong>용어/스키마/코드 전부 ‘preset’으로 정리한 최종본</strong> 이야. (기존 <code class="language-plaintext highlighter-rouge">profile(s)</code>/<code class="language-plaintext highlighter-rouge">endpoint(s)</code>는 하위 호환 별칭 유지)</p>

<hr />

<h1 id="1-이름--스키마-결정-step-by-step">1) 이름 · 스키마 결정 (step-by-step)</h1>

<ul>
  <li>
    <p>섹션명: <strong><code class="language-plaintext highlighter-rouge">[presets."키"]</code></strong></p>
  </li>
  <li>
    <p>필수 필드: <code class="language-plaintext highlighter-rouge">display_name</code>, <code class="language-plaintext highlighter-rouge">request_name</code>, <code class="language-plaintext highlighter-rouge">base_url</code>, <code class="language-plaintext highlighter-rouge">api_key</code></p>
  </li>
  <li>
    <p>선택 필드: <code class="language-plaintext highlighter-rouge">params</code>(모델 파라미터), <code class="language-plaintext highlighter-rouge">http</code>(timeout/headers/query 등)</p>
  </li>
  <li>
    <p>공통 기본값 병합: <code class="language-plaintext highlighter-rouge">defaults.params</code>, <code class="language-plaintext highlighter-rouge">defaults.http</code>를 각 프리셋에 <strong>머지</strong></p>
  </li>
</ul>

<p>예시 <code class="language-plaintext highlighter-rouge">config.toml</code></p>
<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">version</span> <span class="p">=</span> <span class="mi">1</span>

<span class="nn">[settings]</span>
<span class="py">refresh_interval_seconds</span> <span class="p">=</span> <span class="mi">30</span>  <span class="c"># (5~60) 1분 내 반영 요건 충족</span>

<span class="c"># 모든 프리셋 공통 기본값(선택)</span>
<span class="nn">[defaults.params]</span>
<span class="py">temperature</span> <span class="p">=</span> <span class="mf">0.3</span>
<span class="py">max_tokens</span>  <span class="p">=</span> <span class="mi">2048</span>

<span class="nn">[defaults.http]</span>
<span class="py">timeout_seconds</span> <span class="p">=</span> <span class="mi">30</span>
<span class="nn">[defaults.http.headers]</span>
<span class="py">User-Agent</span> <span class="p">=</span> <span class="s">"ComfyUI-ConfigReader/1.0"</span>

<span class="c"># ── 프리셋들 ─────────────────────────────────────────────────────</span>
<span class="nn">[presets."text-model-a"]</span>
<span class="py">display_name</span>  <span class="p">=</span> <span class="s">"Text Model A"</span>
<span class="py">request_name</span>  <span class="p">=</span> <span class="s">"gpt-4o-mini"</span>
<span class="py">base_url</span>      <span class="p">=</span> <span class="s">"https://api.openai.com/v1"</span>
<span class="py">api_key</span>       <span class="p">=</span> <span class="s">"${OPENAI_API_KEY}"</span>

<span class="nn">[presets."text-model-a".params]</span>
<span class="py">temperature</span> <span class="p">=</span> <span class="mf">0.2</span>
<span class="py">top_p</span>       <span class="p">=</span> <span class="mf">0.9</span>

<span class="nn">[presets."text-model-a".http]</span>
<span class="py">timeout_seconds</span> <span class="p">=</span> <span class="mi">20</span>
<span class="nn">[presets."text-model-a".http.headers]</span>
<span class="py">X-Org-Id</span> <span class="p">=</span> <span class="s">"${ORG_ID}"</span>

<span class="nn">[presets."text-model-b"]</span>
<span class="py">display_name</span>  <span class="p">=</span> <span class="s">"Text Model B"</span>
<span class="py">request_name</span>  <span class="p">=</span> <span class="s">"claude-3-5-sonnet"</span>
<span class="py">base_url</span>      <span class="p">=</span> <span class="s">"https://api.anthropic.com"</span>
<span class="py">api_key</span>       <span class="p">=</span> <span class="s">"${ANTHROPIC_API_KEY}"</span>

<span class="c"># ── 다른 일반 설정 섹션들도 자유롭게 ─────────────────────────────</span>
<span class="nn">[feature_flags]</span>
<span class="py">use_cache</span> <span class="p">=</span> <span class="kc">true</span>
</code></pre></div></div>

<blockquote>
  <p><code class="language-plaintext highlighter-rouge">${ENV}</code> 표기는 환경변수로 치환돼.<br />
 <strong>하위 호환</strong> : <code class="language-plaintext highlighter-rouge">[profiles]</code>나 <code class="language-plaintext highlighter-rouge">[endpoints]</code>를 써도 자동 인식(내부에서 <code class="language-plaintext highlighter-rouge">presets</code>로 취급).</p>
</blockquote>

<hr />

<h1 id="2-외부-접근-api-싱글톤-한-줄로-끝">2) 외부 접근 API (싱글톤, 한 줄로 끝)</h1>

<ul>
  <li>
    <p>함수형:<br />
<code class="language-plaintext highlighter-rouge">from comfyui_config_reader import preset, presets, params, http, get</code></p>
  </li>
  <li>
    <p>객체형(원하면):<br />
<code class="language-plaintext highlighter-rouge">from comfyui_config_reader import CONFIG</code> → <code class="language-plaintext highlighter-rouge">CONFIG.preset("...")</code></p>
  </li>
</ul>

<h3 id="사용-예">사용 예</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">comfyui_config_reader</span> <span class="kn">import</span> <span class="n">preset</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">http</span><span class="p">,</span> <span class="n">get</span>

<span class="n">cfg</span> <span class="o">=</span> <span class="nf">preset</span><span class="p">(</span><span class="sh">"</span><span class="s">text-model-a</span><span class="sh">"</span><span class="p">)</span>  <span class="c1"># "키" / "display_name" / "request_name" 아무거나 OK
</span><span class="n">api_key</span>   <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]</span>
<span class="n">base_url</span>  <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">]</span>
<span class="n">req_name</span>  <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">]</span>
<span class="n">p</span>         <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">]</span>   <span class="c1"># 모델 파라미터 dict
</span><span class="n">h</span>         <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">http</span><span class="sh">"</span><span class="p">]</span>     <span class="c1"># HTTP 옵션 dict
</span>
<span class="n">temperature</span> <span class="o">=</span> <span class="nf">params</span><span class="p">(</span><span class="sh">"</span><span class="s">text-model-a</span><span class="sh">"</span><span class="p">).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">temperature</span><span class="sh">"</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">)</span>
<span class="n">timeout</span>     <span class="o">=</span> <span class="nf">http</span><span class="p">(</span><span class="sh">"</span><span class="s">text-model-a</span><span class="sh">"</span><span class="p">).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">timeout_seconds</span><span class="sh">"</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>

<span class="n">region</span> <span class="o">=</span> <span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">feature_flags.use_cache</span><span class="sh">"</span><span class="p">)</span>  <span class="c1"># 범용 키 접근
</span></code></pre></div></div>

<hr />

<h1 id="3-드롭인-교체-코드">3) 드롭인 교체 코드</h1>

<p>아래 두 파일만 교체하면 끝이야.</p>

<h2 id="custom_nodescomfyui_config_reader__init__py"><code class="language-plaintext highlighter-rouge">custom_nodes/comfyui_config_reader/__init__.py</code></h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">.config_singleton</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CONFIG</span><span class="p">,</span>
    <span class="n">configure</span><span class="p">,</span>
    <span class="n">preset</span><span class="p">,</span> <span class="n">presets</span><span class="p">,</span>
    <span class="n">params</span><span class="p">,</span> <span class="n">http</span><span class="p">,</span>
    <span class="n">get</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">,</span>
    <span class="c1"># legacy alias (하위 호환)
</span>    <span class="n">profile</span> <span class="k">as</span> <span class="n">profile</span><span class="p">,</span> <span class="n">profiles</span> <span class="k">as</span> <span class="n">profiles</span><span class="p">,</span>
    <span class="n">endpoint</span> <span class="k">as</span> <span class="n">endpoint</span><span class="p">,</span> <span class="n">endpoints</span> <span class="k">as</span> <span class="n">endpoints</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div>

<h2 id="custom_nodescomfyui_config_readerconfig_singletonpy"><code class="language-plaintext highlighter-rouge">custom_nodes/comfyui_config_reader/config_singleton.py</code></h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">threading</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomllib</span>  <span class="c1"># py3.11+
</span>    <span class="n">_TOML_LOADS</span> <span class="o">=</span> <span class="n">tomllib</span><span class="p">.</span><span class="n">loads</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomli</span>     <span class="c1"># py3.10-
</span>    <span class="n">_TOML_LOADS</span> <span class="o">=</span> <span class="n">tomli</span><span class="p">.</span><span class="n">loads</span>

<span class="k">def</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">v</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">out</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="sh">""</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nf">len</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">${</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span><span class="n">j</span><span class="p">],</span> <span class="sh">""</span><span class="p">);</span> <span class="n">i</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">out</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>  <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">v</span><span class="p">.</span><span class="nf">items</span><span class="p">()}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>  <span class="k">return</span> <span class="p">[</span><span class="nf">_expand_env</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">v</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">v</span>

<span class="k">def</span> <span class="nf">_norm</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="nf">str</span><span class="p">(</span><span class="n">s</span><span class="p">).</span><span class="nf">strip</span><span class="p">().</span><span class="nf">lower</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_deep_merge</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">b</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">out</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="n">b</span> <span class="ow">or</span> <span class="p">{}).</span><span class="nf">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">out</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nf">_deep_merge</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="k">class</span> <span class="nc">_ReadOnlyConfig</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    - 읽기 전용 TOML (파일 쓰기 없음)
    - mtime + TTL(5~60s, 기본 30s) 자동 재로드 → 1분 내 변경 반영
    - 표준: [presets]; 레거시: [profiles], [endpoints] 자동 인식
    - preset 필수 필드: display_name, request_name, base_url, api_key
      + params(dict), http(dict: timeout_seconds, headers{}, query{})
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_refresh</span> <span class="o">=</span> <span class="mi">30</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># --- 내부 로딩 ---
</span>    <span class="k">def</span> <span class="nf">_read_text</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">().</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_extract_presets_table</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">presets</span><span class="sh">"</span><span class="p">),</span> <span class="nb">dict</span><span class="p">):</span>   <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">presets</span><span class="sh">"</span><span class="p">]</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">profiles</span><span class="sh">"</span><span class="p">),</span> <span class="nb">dict</span><span class="p">):</span>  <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">profiles</span><span class="sh">"</span><span class="p">]</span>   <span class="c1"># legacy
</span>        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">endpoints</span><span class="sh">"</span><span class="p">),</span> <span class="nb">dict</span><span class="p">):</span> <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">endpoints</span><span class="sh">"</span><span class="p">]</span>  <span class="c1"># legacy
</span>        <span class="k">return</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_build_index</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>
        <span class="c1"># defaults
</span>        <span class="n">defaults</span> <span class="o">=</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">defaults</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="n">d_params</span> <span class="o">=</span> <span class="n">defaults</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">d_http</span>   <span class="o">=</span> <span class="n">defaults</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">http</span><span class="sh">"</span><span class="p">)</span>   <span class="ow">or</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d_http</span><span class="p">:</span> <span class="n">d_http</span><span class="p">[</span><span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="sh">"</span><span class="s">query</span><span class="sh">"</span>   <span class="ow">not</span> <span class="ow">in</span> <span class="n">d_http</span><span class="p">:</span> <span class="n">d_http</span><span class="p">[</span><span class="sh">"</span><span class="s">query</span><span class="sh">"</span><span class="p">]</span>   <span class="o">=</span> <span class="p">{}</span>

        <span class="n">tbl</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_extract_presets_table</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span> <span class="k">return</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">raw</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span> <span class="k">continue</span>
            <span class="n">cfg</span> <span class="o">=</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
            <span class="n">req</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]</span>
            <span class="k">if</span> <span class="nf">any</span><span class="p">(</span><span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cfg</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="n">k</span><span class="p">]).</span><span class="nf">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">req</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">p_params</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
            <span class="n">p_http</span>   <span class="o">=</span> <span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">http</span><span class="sh">"</span><span class="p">)</span>   <span class="ow">or</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">p_http</span><span class="p">:</span> <span class="n">p_http</span><span class="p">[</span><span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="sh">"</span><span class="s">query</span><span class="sh">"</span>   <span class="ow">not</span> <span class="ow">in</span> <span class="n">p_http</span><span class="p">:</span> <span class="n">p_http</span><span class="p">[</span><span class="sh">"</span><span class="s">query</span><span class="sh">"</span><span class="p">]</span>   <span class="o">=</span> <span class="p">{}</span>

            <span class="n">merged_params</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">d_params</span><span class="p">,</span> <span class="o">**</span><span class="n">p_params</span><span class="p">}</span>
            <span class="n">merged_http</span>   <span class="o">=</span> <span class="nf">_deep_merge</span><span class="p">(</span><span class="n">d_http</span><span class="p">,</span> <span class="n">p_http</span><span class="p">)</span>

            <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">]),</span>
                <span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">]),</span>
                <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span>     <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">]),</span>
                <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">:</span>      <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]),</span>
                <span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">:</span>       <span class="n">merged_params</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">http</span><span class="sh">"</span><span class="p">:</span>         <span class="n">merged_http</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">{</span><span class="nf">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)),</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">))}:</span>
                <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">[</span><span class="nf">_norm</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span> <span class="o">=</span> <span class="n">entry</span>

    <span class="k">def</span> <span class="nf">_reload_locked</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_text</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nf">_TOML_LOADS</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="nf">int</span><span class="p">((</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">settings</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">refresh_interval_seconds</span><span class="sh">"</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
        <span class="n">r</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="n">r</span><span class="p">))</span>
        <span class="n">env_r</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">COMFY_CONFIG_REFRESH_SECONDS</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">env_r</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span> <span class="n">r</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="nf">int</span><span class="p">(</span><span class="n">env_r</span><span class="p">)))</span>
            <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span> <span class="k">pass</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_refresh</span> <span class="o">=</span> <span class="n">r</span>

        <span class="n">self</span><span class="p">.</span><span class="n">_raw</span> <span class="o">=</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_build_index</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>

    <span class="k">def</span> <span class="nf">_stale_or_changed</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">m</span> <span class="o">!=</span> <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">_refresh</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_ensure_loaded</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">self</span><span class="p">.</span><span class="nf">_stale_or_changed</span><span class="p">():</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_reload_locked</span><span class="p">()</span>

    <span class="c1"># --- 퍼블릭 API ---
</span>    <span class="k">def</span> <span class="nf">preset</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nf">str</span><span class="p">(</span><span class="n">key</span><span class="p">).</span><span class="nf">strip</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sh">"</span><span class="s">preset key is empty</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">hit</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_norm</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_reload_locked</span><span class="p">()</span>
                <span class="n">hit</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_norm</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">preset not found: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hit</span>

    <span class="k">def</span> <span class="nf">presets</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="nf">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="n">dn</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">dn</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">seen</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">dn</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="n">dn</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span>     <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">:</span>       <span class="n">v</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span>
                <span class="sh">"</span><span class="s">http</span><span class="sh">"</span><span class="p">:</span>         <span class="n">v</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">http</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">params</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nf">dict</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">preset</span><span class="p">(</span><span class="n">key</span><span class="p">).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}))</span>

    <span class="k">def</span> <span class="nf">http</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nf">dict</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">preset</span><span class="p">(</span><span class="n">key</span><span class="p">).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">http</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}))</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">dotted</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_raw</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">dotted</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">cur</span><span class="p">:</span>
                <span class="n">cur</span> <span class="o">=</span> <span class="n">cur</span><span class="p">[</span><span class="n">part</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">config path not found: </span><span class="si">{</span><span class="n">dotted</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cur</span>

    <span class="k">def</span> <span class="nf">snapshot</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="k">return</span> <span class="nf">dict</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">)</span>

<span class="c1"># ----- 싱글톤 -----
</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
<span class="n">_instance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_ReadOnlyConfig</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">_default_path</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">_resolve_default_path</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">here</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_default_path</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">COMFY_CONFIG_PATH</span><span class="sh">"</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">here</span><span class="p">,</span> <span class="sh">"</span><span class="s">config.toml</span><span class="sh">"</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">_get_instance</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">_ReadOnlyConfig</span><span class="p">:</span>
    <span class="k">global</span> <span class="n">_instance</span>
    <span class="k">if</span> <span class="n">_instance</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_instance</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">_instance</span> <span class="o">=</span> <span class="nf">_ReadOnlyConfig</span><span class="p">(</span><span class="nf">_resolve_default_path</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">_instance</span>

<span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">refresh_seconds</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">global</span> <span class="n">_instance</span><span class="p">,</span> <span class="n">_default_path</span>
    <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
        <span class="n">_default_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">refresh_seconds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="sh">"</span><span class="s">COMFY_CONFIG_REFRESH_SECONDS</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">refresh_seconds</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">_lock</span><span class="p">:</span>
        <span class="n">_instance</span> <span class="o">=</span> <span class="nf">_ReadOnlyConfig</span><span class="p">(</span><span class="nf">_resolve_default_path</span><span class="p">())</span>

<span class="c1"># ---- 외부 API ----
</span><span class="k">def</span> <span class="nf">preset</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>     <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">preset</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">presets</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span> <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">presets</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">params</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>     <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">params</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">http</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>       <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">http</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">dotted</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>                <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">get</span><span class="p">(</span><span class="n">dotted</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">snapshot</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>           <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">snapshot</span><span class="p">()</span>

<span class="c1"># ---- 하위 호환 별칭 ----
</span><span class="k">def</span> <span class="nf">profile</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>    <span class="k">return</span> <span class="nf">preset</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">profiles</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span><span class="k">return</span> <span class="nf">presets</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">endpoint</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>   <span class="k">return</span> <span class="nf">preset</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">endpoints</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span> <span class="k">return</span> <span class="nf">presets</span><span class="p">()</span>

<span class="c1"># ---- 객체형 프록시 ----
</span><span class="k">class</span> <span class="nc">_ConfigProxy</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">_get_instance</span><span class="p">(),</span> <span class="n">name</span><span class="p">)</span>
<span class="n">CONFIG</span> <span class="o">=</span> <span class="nf">_ConfigProxy</span><span class="p">()</span>
</code></pre></div></div>

<hr />

<h1 id="4-원하면-comfyui-노드도-용어-맞춰-변경">4) (원하면) ComfyUI 노드도 용어 맞춰 변경</h1>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">ConfigPresetLookup</code> : <code class="language-plaintext highlighter-rouge">display_name</code>, <code class="language-plaintext highlighter-rouge">request_name</code>, <code class="language-plaintext highlighter-rouge">base_url</code>, <code class="language-plaintext highlighter-rouge">api_key</code>, <code class="language-plaintext highlighter-rouge">params(json)</code>, <code class="language-plaintext highlighter-rouge">http(json)</code> 출력</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">ConfigListPresets</code> : 모든 프리셋 JSON</p>
  </li>
</ul>

<p>원하시면 바로 생성해 줄게.</p>

<hr />

<h1 id="5-마이그레이션-정리">5) 마이그레이션 정리</h1>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">profile(s)</code> / <code class="language-plaintext highlighter-rouge">endpoint(s)</code> 호출 코드는 그대로 동작(별칭 제공).</p>
  </li>
  <li>
    <p>설정 파일에서 <code class="language-plaintext highlighter-rouge">[profiles]</code>/<code class="language-plaintext highlighter-rouge">[endpoints]</code> 유지해도 인식하지만, 앞으로는 <strong><code class="language-plaintext highlighter-rouge">[presets]</code> 권장</strong>.</p>
  </li>
  <li>
    <p>모델 파라미터/HTTP 옵션은 프리셋 내부(<code class="language-plaintext highlighter-rouge">params</code>/<code class="language-plaintext highlighter-rouge">http</code>)에 넣으면 되고, 공통값은 <code class="language-plaintext highlighter-rouge">defaults</code>에 두면 자동 병합돼.</p>
  </li>
</ul>

<hr />

<p>필요하면 “preset” 대신 <strong><code class="language-plaintext highlighter-rouge">deployment</code></strong> , <strong><code class="language-plaintext highlighter-rouge">model_preset</code></strong> 같은 더 구체적인 대안도 줄 수 있어. 하지만 <em>모델 호출용 세팅 묶음</em> 이라는 관점에서 사용자/오퍼레이터 모두에게 가장 익숙하고 짧은 용어는 “preset”이라 이걸 기본 권장으로 뒀어.</p>

<p class="chat--user">

아니 llm endpoint 라는 느낌이 전혀 안들어서

</p>

<p>오케이—“LLM 엔드포인트” 느낌을 확실히 주도록 <strong>용어를 <code class="language-plaintext highlighter-rouge">llm_endpoints</code></strong>로 표준화했어요.<br />
(이전 <code class="language-plaintext highlighter-rouge">presets</code>/<code class="language-plaintext highlighter-rouge">profiles</code>/<code class="language-plaintext highlighter-rouge">endpoints</code>는 <strong>자동 하위 호환</strong> 으로 계속 읽습니다.)</p>

<p>아래 두 파일만 교체하면 끝! 외부에서는 <code class="language-plaintext highlighter-rouge">llm_endpoint(...)</code>, <code class="language-plaintext highlighter-rouge">llm_params(...)</code> 같은 이름으로 바로 씁니다.</p>

<hr />

<h1 id="1-스키마-configtoml">1) 스키마 (config.toml)</h1>
<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">version</span> <span class="p">=</span> <span class="mi">1</span>

<span class="nn">[settings]</span>
<span class="c"># 파일 변경 감지 주기(초) — 5~60 권장. "1분 이내 반영" 요건 충족.</span>
<span class="py">refresh_interval_seconds</span> <span class="p">=</span> <span class="mi">30</span>

<span class="c"># 공통 기본값(선택): 모든 LLM 엔드포인트에 병합됨</span>
<span class="nn">[defaults.params]</span>
<span class="py">temperature</span> <span class="p">=</span> <span class="mf">0.3</span>
<span class="py">max_tokens</span>  <span class="p">=</span> <span class="mi">2048</span>

<span class="nn">[defaults.http]</span>
<span class="py">timeout_seconds</span> <span class="p">=</span> <span class="mi">30</span>
<span class="nn">[defaults.http.headers]</span>
<span class="py">User-Agent</span> <span class="p">=</span> <span class="s">"ComfyUI-ConfigReader/1.0"</span>

<span class="c"># ── LLM 엔드포인트들 ─────────────────────────────────────────</span>
<span class="nn">[llm_endpoints."gpt-4o-mini-a"]</span>
<span class="py">display_name</span> <span class="p">=</span> <span class="s">"OpenAI GPT-4o mini A"</span>
<span class="py">model</span>        <span class="p">=</span> <span class="s">"gpt-4o-mini"</span>             <span class="c"># (= request_name 별칭)</span>
<span class="py">base_url</span>     <span class="p">=</span> <span class="s">"https://api.openai.com/v1"</span>
<span class="py">api_key</span>      <span class="p">=</span> <span class="s">"${OPENAI_API_KEY}"</span>

<span class="nn">[llm_endpoints."gpt-4o-mini-a".params]</span>
<span class="py">temperature</span> <span class="p">=</span> <span class="mf">0.2</span>
<span class="py">top_p</span>       <span class="p">=</span> <span class="mf">0.9</span>

<span class="nn">[llm_endpoints."gpt-4o-mini-a".http]</span>
<span class="py">timeout_seconds</span> <span class="p">=</span> <span class="mi">20</span>
<span class="nn">[llm_endpoints."gpt-4o-mini-a".http.headers]</span>
<span class="py">X-Org-Id</span> <span class="p">=</span> <span class="s">"${ORG_ID}"</span>

<span class="nn">[llm_endpoints."claude-sonnet"]</span>
<span class="py">display_name</span> <span class="p">=</span> <span class="s">"Anthropic Claude 3.5 Sonnet"</span>
<span class="py">model</span>        <span class="p">=</span> <span class="s">"claude-3-5-sonnet"</span>
<span class="py">base_url</span>     <span class="p">=</span> <span class="s">"https://api.anthropic.com"</span>
<span class="py">api_key</span>      <span class="p">=</span> <span class="s">"${ANTHROPIC_API_KEY}"</span>

<span class="c"># ── 다른 일반 설정도 자유롭게 ────────────────────────────────</span>
<span class="nn">[feature_flags]</span>
<span class="py">use_cache</span> <span class="p">=</span> <span class="kc">true</span>
</code></pre></div></div>

<ul>
  <li>
    <p>필수: <code class="language-plaintext highlighter-rouge">display_name</code>, <code class="language-plaintext highlighter-rouge">model(=request_name)</code>, <code class="language-plaintext highlighter-rouge">base_url</code>, <code class="language-plaintext highlighter-rouge">api_key</code></p>
  </li>
  <li>
    <p>선택: <code class="language-plaintext highlighter-rouge">params</code>(모델 파라미터), <code class="language-plaintext highlighter-rouge">http</code>(timeout/headers/query 등)</p>
  </li>
  <li>
    <p><strong>병합 규칙</strong> : <code class="language-plaintext highlighter-rouge">defaults.params</code>/<code class="language-plaintext highlighter-rouge">defaults.http</code> → 각 엔드포인트의 <code class="language-plaintext highlighter-rouge">params</code>/<code class="language-plaintext highlighter-rouge">http</code>에 <strong>덮어쓰기 병합</strong></p>
  </li>
</ul>

<blockquote>
  <p>하위 호환: <code class="language-plaintext highlighter-rouge">[presets]</code>, <code class="language-plaintext highlighter-rouge">[profiles]</code>, <code class="language-plaintext highlighter-rouge">[endpoints]</code>도 자동 인식합니다.<br />
 필드도 <code class="language-plaintext highlighter-rouge">request_name</code>/<code class="language-plaintext highlighter-rouge">request_model</code>/<code class="language-plaintext highlighter-rouge">model</code> 중 아무거나 써도 OK(내부에서 <code class="language-plaintext highlighter-rouge">model</code>로 통일).</p>
</blockquote>

<hr />

<h1 id="2-외부-접근-api-싱글톤-직관적">2) 외부 접근 API (싱글톤, 직관적)</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">comfyui_config_reader</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">llm_endpoint</span><span class="p">,</span> <span class="n">llm_endpoints</span><span class="p">,</span>   <span class="c1"># 메타 + 연결 정보
</span>    <span class="n">llm_params</span><span class="p">,</span> <span class="n">llm_http</span><span class="p">,</span>          <span class="c1"># 모델 파라미터 / HTTP 옵션만
</span>    <span class="n">get</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">,</span>                   <span class="c1"># 범용 키 접근 / 객체형 접근
</span><span class="p">)</span>
</code></pre></div></div>

<p>사용 예:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cfg</span> <span class="o">=</span> <span class="nf">llm_endpoint</span><span class="p">(</span><span class="sh">"</span><span class="s">gpt-4o-mini-a</span><span class="sh">"</span><span class="p">)</span>     <span class="c1"># 키 / display_name / model 아무거나
</span><span class="n">api_key</span>  <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]</span>
<span class="n">base_url</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">]</span>
<span class="n">model</span>    <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">]</span>
<span class="n">params</span>   <span class="o">=</span> <span class="nf">llm_params</span><span class="p">(</span><span class="sh">"</span><span class="s">gpt-4o-mini-a</span><span class="sh">"</span><span class="p">)</span>  <span class="c1"># {"temperature": 0.2, "top_p": 0.9, ...}
</span><span class="n">http</span>     <span class="o">=</span> <span class="nf">llm_http</span><span class="p">(</span><span class="sh">"</span><span class="s">gpt-4o-mini-a</span><span class="sh">"</span><span class="p">)</span>    <span class="c1"># {"timeout_seconds": ..., "headers": {...}, ...}
</span>
<span class="c1"># 범용 설정
</span><span class="n">use_cache</span> <span class="o">=</span> <span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">feature_flags.use_cache</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<h1 id="3-드롭인-교체-코드-1">3) 드롭인 교체 코드</h1>

<h2 id="custom_nodescomfyui_config_reader__init__py-1"><code class="language-plaintext highlighter-rouge">custom_nodes/comfyui_config_reader/__init__.py</code></h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">.config_singleton</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CONFIG</span><span class="p">,</span>
    <span class="n">configure</span><span class="p">,</span>
    <span class="n">llm_endpoint</span><span class="p">,</span> <span class="n">llm_endpoints</span><span class="p">,</span>
    <span class="n">llm_params</span><span class="p">,</span> <span class="n">llm_http</span><span class="p">,</span>
    <span class="n">get</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">,</span>
    <span class="c1"># legacy alias (하위 호환)
</span>    <span class="n">preset</span> <span class="k">as</span> <span class="n">preset</span><span class="p">,</span> <span class="n">presets</span> <span class="k">as</span> <span class="n">presets</span><span class="p">,</span>
    <span class="n">profile</span> <span class="k">as</span> <span class="n">profile</span><span class="p">,</span> <span class="n">profiles</span> <span class="k">as</span> <span class="n">profiles</span><span class="p">,</span>
    <span class="n">endpoint</span> <span class="k">as</span> <span class="n">endpoint</span><span class="p">,</span> <span class="n">endpoints</span> <span class="k">as</span> <span class="n">endpoints</span><span class="p">,</span>
    <span class="n">params</span> <span class="k">as</span> <span class="n">params</span><span class="p">,</span> <span class="n">http</span> <span class="k">as</span> <span class="n">http</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div>

<h2 id="custom_nodescomfyui_config_readerconfig_singletonpy-1"><code class="language-plaintext highlighter-rouge">custom_nodes/comfyui_config_reader/config_singleton.py</code></h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">threading</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomllib</span>  <span class="c1"># py3.11+
</span>    <span class="n">_TOML_LOADS</span> <span class="o">=</span> <span class="n">tomllib</span><span class="p">.</span><span class="n">loads</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomli</span>     <span class="c1"># py3.10-
</span>    <span class="n">_TOML_LOADS</span> <span class="o">=</span> <span class="n">tomli</span><span class="p">.</span><span class="n">loads</span>

<span class="k">def</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">v</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">out</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="sh">""</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nf">len</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">${</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span><span class="n">j</span><span class="p">],</span> <span class="sh">""</span><span class="p">);</span> <span class="n">i</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">out</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>  <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">v</span><span class="p">.</span><span class="nf">items</span><span class="p">()}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>  <span class="k">return</span> <span class="p">[</span><span class="nf">_expand_env</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">v</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">v</span>

<span class="k">def</span> <span class="nf">_norm</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="nf">str</span><span class="p">(</span><span class="n">s</span><span class="p">).</span><span class="nf">strip</span><span class="p">().</span><span class="nf">lower</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_deep_merge</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">b</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">out</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="n">b</span> <span class="ow">or</span> <span class="p">{}).</span><span class="nf">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">out</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nf">_deep_merge</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="c1"># --- 필드 별칭 정규화 (model / request_name / request_model) ---
</span><span class="k">def</span> <span class="nf">_normalize_model_field</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">request_model</span><span class="sh">"</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">cfg</span> <span class="ow">and</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="n">k</span><span class="p">]).</span><span class="nf">strip</span><span class="p">():</span>
            <span class="k">return</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="n">k</span><span class="p">]).</span><span class="nf">strip</span><span class="p">()</span>
    <span class="k">return</span> <span class="sh">""</span>

<span class="k">class</span> <span class="nc">_ReadOnlyConfig</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    - 읽기 전용 TOML
    - mtime + TTL(5~60s, 기본 30s) 자동 재로드 → 1분 내 변경 반영
    - 표준 섹션: [llm_endpoints]
      (하위 호환: [presets], [profiles], [endpoints] 도 자동 인식)
    - 각 엔드포인트:
        * display_name, model(=request_name/… 별칭), base_url, api_key
        * params(dict), http(dict: timeout_seconds, headers{}, query{})
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_refresh</span> <span class="o">=</span> <span class="mi">30</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># --- 내부 로딩 ---
</span>    <span class="k">def</span> <span class="nf">_read_text</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">().</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_extract_llm_table</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="c1"># 1순위 표준
</span>        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">llm_endpoints</span><span class="sh">"</span><span class="p">),</span> <span class="nb">dict</span><span class="p">):</span> <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">llm_endpoints</span><span class="sh">"</span><span class="p">]</span>
        <span class="c1"># 하위 호환
</span>        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">presets</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">profiles</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">endpoints</span><span class="sh">"</span><span class="p">):</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="nb">dict</span><span class="p">):</span> <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_build_index</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>

        <span class="c1"># defaults
</span>        <span class="n">defaults</span> <span class="o">=</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">defaults</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="n">d_params</span> <span class="o">=</span> <span class="n">defaults</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">d_http</span>   <span class="o">=</span> <span class="n">defaults</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">http</span><span class="sh">"</span><span class="p">)</span>   <span class="ow">or</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d_http</span><span class="p">:</span> <span class="n">d_http</span><span class="p">[</span><span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="sh">"</span><span class="s">query</span><span class="sh">"</span>   <span class="ow">not</span> <span class="ow">in</span> <span class="n">d_http</span><span class="p">:</span> <span class="n">d_http</span><span class="p">[</span><span class="sh">"</span><span class="s">query</span><span class="sh">"</span><span class="p">]</span>   <span class="o">=</span> <span class="p">{}</span>

        <span class="n">tbl</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_extract_llm_table</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span> <span class="k">return</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">raw</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span> <span class="k">continue</span>
            <span class="n">cfg</span> <span class="o">=</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>

            <span class="n">display</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)).</span><span class="nf">strip</span><span class="p">()</span>
            <span class="n">model</span>   <span class="o">=</span> <span class="nf">_normalize_model_field</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
            <span class="n">base</span>    <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)).</span><span class="nf">strip</span><span class="p">()</span>
            <span class="n">api</span>     <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)).</span><span class="nf">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">display</span> <span class="ow">and</span> <span class="n">model</span> <span class="ow">and</span> <span class="n">base</span> <span class="ow">and</span> <span class="n">api</span><span class="p">):</span>
                <span class="k">continue</span>  <span class="c1"># 필수 누락은 스킵
</span>
            <span class="n">p_params</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
            <span class="n">p_http</span>   <span class="o">=</span> <span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">http</span><span class="sh">"</span><span class="p">)</span>   <span class="ow">or</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">p_http</span><span class="p">:</span> <span class="n">p_http</span><span class="p">[</span><span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="sh">"</span><span class="s">query</span><span class="sh">"</span>   <span class="ow">not</span> <span class="ow">in</span> <span class="n">p_http</span><span class="p">:</span> <span class="n">p_http</span><span class="p">[</span><span class="sh">"</span><span class="s">query</span><span class="sh">"</span><span class="p">]</span>   <span class="o">=</span> <span class="p">{}</span>

            <span class="n">merged_params</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">d_params</span><span class="p">,</span> <span class="o">**</span><span class="n">p_params</span><span class="p">}</span>
            <span class="n">merged_http</span>   <span class="o">=</span> <span class="nf">_deep_merge</span><span class="p">(</span><span class="n">d_http</span><span class="p">,</span> <span class="n">p_http</span><span class="p">)</span>

            <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">display</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span>        <span class="n">model</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span>     <span class="n">base</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">:</span>      <span class="n">api</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">:</span>       <span class="n">merged_params</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">http</span><span class="sh">"</span><span class="p">:</span>         <span class="n">merged_http</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="c1"># 접근 키: 정의 키 / display_name / model
</span>            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">{</span><span class="nf">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">display</span><span class="p">,</span> <span class="n">model</span><span class="p">}:</span>
                <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">[</span><span class="nf">_norm</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span> <span class="o">=</span> <span class="n">entry</span>

    <span class="k">def</span> <span class="nf">_reload_locked</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_text</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nf">_TOML_LOADS</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="nf">int</span><span class="p">((</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">settings</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">refresh_interval_seconds</span><span class="sh">"</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
        <span class="n">r</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="n">r</span><span class="p">))</span>
        <span class="n">env_r</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">COMFY_CONFIG_REFRESH_SECONDS</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">env_r</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span> <span class="n">r</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="nf">int</span><span class="p">(</span><span class="n">env_r</span><span class="p">)))</span>
            <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span> <span class="k">pass</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_refresh</span> <span class="o">=</span> <span class="n">r</span>

        <span class="n">self</span><span class="p">.</span><span class="n">_raw</span> <span class="o">=</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_build_index</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>

    <span class="k">def</span> <span class="nf">_stale_or_changed</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">m</span> <span class="o">!=</span> <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">_refresh</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_ensure_loaded</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">self</span><span class="p">.</span><span class="nf">_stale_or_changed</span><span class="p">():</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_reload_locked</span><span class="p">()</span>

    <span class="c1"># --- 퍼블릭 API ---
</span>    <span class="k">def</span> <span class="nf">llm_endpoint</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nf">str</span><span class="p">(</span><span class="n">key</span><span class="p">).</span><span class="nf">strip</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sh">"</span><span class="s">llm_endpoint key is empty</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">hit</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_norm</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_reload_locked</span><span class="p">()</span>
                <span class="n">hit</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_norm</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">llm_endpoint not found: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hit</span>

    <span class="k">def</span> <span class="nf">llm_endpoints</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="nf">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="n">dn</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">dn</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">seen</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">dn</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="n">dn</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span>        <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span>     <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">:</span>       <span class="n">v</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span>
                <span class="sh">"</span><span class="s">http</span><span class="sh">"</span><span class="p">:</span>         <span class="n">v</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">http</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">llm_params</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nf">dict</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">llm_endpoint</span><span class="p">(</span><span class="n">key</span><span class="p">).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}))</span>

    <span class="k">def</span> <span class="nf">llm_http</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nf">dict</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">llm_endpoint</span><span class="p">(</span><span class="n">key</span><span class="p">).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">http</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}))</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">dotted</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_raw</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">dotted</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">cur</span><span class="p">:</span>
                <span class="n">cur</span> <span class="o">=</span> <span class="n">cur</span><span class="p">[</span><span class="n">part</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">config path not found: </span><span class="si">{</span><span class="n">dotted</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cur</span>

    <span class="k">def</span> <span class="nf">snapshot</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="k">return</span> <span class="nf">dict</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">)</span>

<span class="c1"># ----- 싱글톤 -----
</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
<span class="n">_instance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_ReadOnlyConfig</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">_default_path</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">_resolve_default_path</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">here</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_default_path</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">COMFY_CONFIG_PATH</span><span class="sh">"</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">here</span><span class="p">,</span> <span class="sh">"</span><span class="s">config.toml</span><span class="sh">"</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">_get_instance</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">_ReadOnlyConfig</span><span class="p">:</span>
    <span class="k">global</span> <span class="n">_instance</span>
    <span class="k">if</span> <span class="n">_instance</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_instance</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">_instance</span> <span class="o">=</span> <span class="nf">_ReadOnlyConfig</span><span class="p">(</span><span class="nf">_resolve_default_path</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">_instance</span>

<span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">refresh_seconds</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">global</span> <span class="n">_instance</span><span class="p">,</span> <span class="n">_default_path</span>
    <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
        <span class="n">_default_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">refresh_seconds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="sh">"</span><span class="s">COMFY_CONFIG_REFRESH_SECONDS</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">refresh_seconds</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">_lock</span><span class="p">:</span>
        <span class="n">_instance</span> <span class="o">=</span> <span class="nf">_ReadOnlyConfig</span><span class="p">(</span><span class="nf">_resolve_default_path</span><span class="p">())</span>

<span class="c1"># ---- 외부 API ----
</span><span class="k">def</span> <span class="nf">llm_endpoint</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>     <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">llm_endpoint</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">llm_endpoints</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span> <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">llm_endpoints</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">llm_params</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>       <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">llm_params</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">llm_http</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>         <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">llm_http</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">dotted</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>                      <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">get</span><span class="p">(</span><span class="n">dotted</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">snapshot</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>                 <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">snapshot</span><span class="p">()</span>

<span class="c1"># ---- 하위 호환 별칭 (필요 시 기존 코드 그대로 동작) ----
</span><span class="k">def</span> <span class="nf">preset</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span>   <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>         <span class="k">return</span> <span class="nf">llm_endpoint</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">presets</span><span class="p">()</span>          <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span> <span class="k">return</span> <span class="nf">llm_endpoints</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">profile</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span>  <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>         <span class="k">return</span> <span class="nf">llm_endpoint</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">profiles</span><span class="p">()</span>         <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span> <span class="k">return</span> <span class="nf">llm_endpoints</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">endpoint</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>         <span class="k">return</span> <span class="nf">llm_endpoint</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">endpoints</span><span class="p">()</span>        <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span> <span class="k">return</span> <span class="nf">llm_endpoints</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">params</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span>   <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>         <span class="k">return</span> <span class="nf">llm_params</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">http</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span>     <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>         <span class="k">return</span> <span class="nf">llm_http</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

<span class="c1"># ---- 객체형 프록시 ----
</span><span class="k">class</span> <span class="nc">_ConfigProxy</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">_get_instance</span><span class="p">(),</span> <span class="n">name</span><span class="p">)</span>
<span class="n">CONFIG</span> <span class="o">=</span> <span class="nf">_ConfigProxy</span><span class="p">()</span>
</code></pre></div></div>

<hr />

<h1 id="4-왜-이게-좋은가-짧게">4) 왜 이게 좋은가 (짧게)</h1>

<ul>
  <li>
    <p>이름부터 <strong>LLM 엔드포인트</strong> 임이 분명 (<code class="language-plaintext highlighter-rouge">llm_endpoints</code>)</p>
  </li>
  <li>
    <p>모델 파라미터/HTTP 옵션을 <strong>같은 묶음</strong> 에서 관리 (<code class="language-plaintext highlighter-rouge">params</code>, <code class="language-plaintext highlighter-rouge">http</code>)</p>
  </li>
  <li>
    <p>기존 설정/코드 <strong>안 깨짐</strong>(자동 호환)</p>
  </li>
  <li>
    <p>읽기 전용 + mtime/TTL(5~60s)로 <strong>최대 1분 내 변경 반영</strong></p>
  </li>
  <li>
    <p>외부 사용은 <strong>한 줄 임포트</strong> 로 끝: <code class="language-plaintext highlighter-rouge">llm_endpoint("...")</code></p>
  </li>
</ul>

<p>원하면 ComfyUI 노드 이름도 <code class="language-plaintext highlighter-rouge">Config: LLM Endpoint Lookup</code>, <code class="language-plaintext highlighter-rouge">Config: List LLM Endpoints</code>로 맞춰서 출력(파라미터/HTTP JSON 포함) 버전까지 바로 만들어줄게!</p>

<p class="chat--user">

api_providers display_name, model_id, base_url, api_key 이걸로 해줘.

</p>

<p>좋아! <strong>이름은<code class="language-plaintext highlighter-rouge">api_providers</code></strong>, 필드는 <strong><code class="language-plaintext highlighter-rouge">display_name</code>, <code class="language-plaintext highlighter-rouge">model_id</code>, <code class="language-plaintext highlighter-rouge">base_url</code>, <code class="language-plaintext highlighter-rouge">api_key</code></strong>로 딱 맞춰서 정리했어.<br />
(읽기 전용 · 최대 1분 내 변경 반영 · 다른 노드/파일에서 한 줄로 접근)</p>

<p>아래 코드/예시 그대로 교체하면 동작해.</p>

<hr />

<h1 id="1-configtoml-스키마">1) <code class="language-plaintext highlighter-rouge">config.toml</code> 스키마</h1>
<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">version</span> <span class="p">=</span> <span class="mi">1</span>

<span class="nn">[settings]</span>
<span class="c"># 파일 변경 감지 주기(초) — 5~60 권장. "1분 이내 반영" 요건 충족.</span>
<span class="py">refresh_interval_seconds</span> <span class="p">=</span> <span class="mi">30</span>

<span class="c"># ── API Providers ─────────────────────────────────────</span>
<span class="nn">[api_providers."openai-mini"]</span>
<span class="py">display_name</span> <span class="p">=</span> <span class="s">"OpenAI GPT-4o mini"</span>
<span class="py">model_id</span>     <span class="p">=</span> <span class="s">"gpt-4o-mini"</span>
<span class="py">base_url</span>     <span class="p">=</span> <span class="s">"https://api.openai.com/v1"</span>
<span class="py">api_key</span>      <span class="p">=</span> <span class="s">"${OPENAI_API_KEY}"</span>

<span class="nn">[api_providers."anthropic-sonnet"]</span>
<span class="py">display_name</span> <span class="p">=</span> <span class="s">"Anthropic Claude 3.5 Sonnet"</span>
<span class="py">model_id</span>     <span class="p">=</span> <span class="s">"claude-3-5-sonnet"</span>
<span class="py">base_url</span>     <span class="p">=</span> <span class="s">"https://api.anthropic.com"</span>
<span class="py">api_key</span>      <span class="p">=</span> <span class="s">"${ANTHROPIC_API_KEY}"</span>

<span class="c"># ── 다른 범용 설정도 자유롭게 ─────────────────────────</span>
<span class="nn">[feature_flags]</span>
<span class="py">use_cache</span> <span class="p">=</span> <span class="kc">true</span>
</code></pre></div></div>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">${ENV}</code> 표기는 환경변수로 치환.</p>
  </li>
  <li>
    <p>조회 키는 <strong>정의 키 /<code class="language-plaintext highlighter-rouge">display_name</code> / <code class="language-plaintext highlighter-rouge">model_id</code></strong> 중 아무거나 사용 가능.</p>
  </li>
</ul>

<hr />

<h1 id="2-외부에서-쓰는-법-싱글톤-한-줄">2) 외부에서 쓰는 법 (싱글톤, 한 줄)</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">comfyui_config_reader</span> <span class="kn">import</span> <span class="n">api_provider</span><span class="p">,</span> <span class="n">api_providers</span><span class="p">,</span> <span class="n">get</span>

<span class="n">cfg</span> <span class="o">=</span> <span class="nf">api_provider</span><span class="p">(</span><span class="sh">"</span><span class="s">openai-mini</span><span class="sh">"</span><span class="p">)</span>   <span class="c1"># 또는 "OpenAI GPT-4o mini" / "gpt-4o-mini"
</span><span class="n">api_key</span>  <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]</span>
<span class="n">base_url</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">]</span>
<span class="n">model_id</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">model_id</span><span class="sh">"</span><span class="p">]</span>

<span class="n">listing</span> <span class="o">=</span> <span class="nf">api_providers</span><span class="p">()</span>           <span class="c1"># {display_name: {display_name, model_id, base_url}}
</span><span class="n">use_cache</span> <span class="o">=</span> <span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">feature_flags.use_cache</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<p>선택(초기화 시 한 번):</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">comfyui_config_reader</span> <span class="kn">import</span> <span class="n">configure</span>
<span class="nf">configure</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="sh">"</span><span class="s">/abs/path/to/config.toml</span><span class="sh">"</span><span class="p">,</span> <span class="n">refresh_seconds</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>  <span class="c1"># 5~60
</span></code></pre></div></div>

<hr />

<h1 id="3-드롭인-코드">3) 드롭인 코드</h1>

<h2 id="custom_nodescomfyui_config_reader__init__py-2"><code class="language-plaintext highlighter-rouge">custom_nodes/comfyui_config_reader/__init__.py</code></h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">.config_singleton</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CONFIG</span><span class="p">,</span>
    <span class="n">configure</span><span class="p">,</span>
    <span class="n">api_provider</span><span class="p">,</span> <span class="n">api_providers</span><span class="p">,</span>
    <span class="n">get</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div>

<h2 id="custom_nodescomfyui_config_readerconfig_singletonpy-2"><code class="language-plaintext highlighter-rouge">custom_nodes/comfyui_config_reader/config_singleton.py</code></h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">threading</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomllib</span>  <span class="c1"># py3.11+
</span>    <span class="n">_TOML_LOADS</span> <span class="o">=</span> <span class="n">tomllib</span><span class="p">.</span><span class="n">loads</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomli</span>     <span class="c1"># py3.10-
</span>    <span class="n">_TOML_LOADS</span> <span class="o">=</span> <span class="n">tomli</span><span class="p">.</span><span class="n">loads</span>

<span class="k">def</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">v</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">out</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="sh">""</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nf">len</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">${</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span><span class="n">j</span><span class="p">],</span> <span class="sh">""</span><span class="p">);</span> <span class="n">i</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">out</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>  <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">v</span><span class="p">.</span><span class="nf">items</span><span class="p">()}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>  <span class="k">return</span> <span class="p">[</span><span class="nf">_expand_env</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">v</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">v</span>

<span class="k">def</span> <span class="nf">_norm</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="nf">str</span><span class="p">(</span><span class="n">s</span><span class="p">).</span><span class="nf">strip</span><span class="p">().</span><span class="nf">lower</span><span class="p">()</span>

<span class="c1"># 레거시 필드 호환: model_id 대신 model/request_name/request_model 이 들어와도 인식
</span><span class="k">def</span> <span class="nf">_normalize_model_id</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">model_id</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">request_model</span><span class="sh">"</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">cfg</span> <span class="ow">and</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="n">k</span><span class="p">]).</span><span class="nf">strip</span><span class="p">():</span>
            <span class="k">return</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="n">k</span><span class="p">]).</span><span class="nf">strip</span><span class="p">()</span>
    <span class="k">return</span> <span class="sh">""</span>

<span class="k">class</span> <span class="nc">_ReadOnlyConfig</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    - 읽기 전용 TOML 로더 (파일 쓰기 없음)
    - mtime + TTL(5~60s, 기본 30s) 자동 재로드 → 1분 내 변경 반영
    - 표준 섹션: [api_providers]
      (참고: 원하면 하위 호환 섹션을 추가로 인식하도록 확장 가능)
    - 각 provider 필수 필드: display_name, model_id, base_url, api_key
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_refresh</span> <span class="o">=</span> <span class="mi">30</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># --- 내부 로딩 ---
</span>    <span class="k">def</span> <span class="nf">_read_text</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">().</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_providers_table</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">tbl</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">api_providers</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tbl</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_build_index</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>
        <span class="n">tbl</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_providers_table</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span> <span class="k">return</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">raw</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span> <span class="k">continue</span>
            <span class="n">cfg</span> <span class="o">=</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>

            <span class="n">display</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)).</span><span class="nf">strip</span><span class="p">()</span>
            <span class="n">model</span>   <span class="o">=</span> <span class="nf">_normalize_model_id</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
            <span class="n">base</span>    <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)).</span><span class="nf">strip</span><span class="p">()</span>
            <span class="n">api</span>     <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)).</span><span class="nf">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">display</span> <span class="ow">and</span> <span class="n">model</span> <span class="ow">and</span> <span class="n">base</span> <span class="ow">and</span> <span class="n">api</span><span class="p">):</span>
                <span class="k">continue</span>  <span class="c1"># 필수 누락은 스킵
</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">display</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">model_id</span><span class="sh">"</span><span class="p">:</span>     <span class="n">model</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span>     <span class="n">base</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">:</span>      <span class="n">api</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="c1"># 접근 키: 정의 키 / display_name / model_id
</span>            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">{</span><span class="nf">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">display</span><span class="p">,</span> <span class="n">model</span><span class="p">}:</span>
                <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">[</span><span class="nf">_norm</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span> <span class="o">=</span> <span class="n">entry</span>

    <span class="k">def</span> <span class="nf">_reload_locked</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_text</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nf">_TOML_LOADS</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>

        <span class="n">r</span> <span class="o">=</span> <span class="nf">int</span><span class="p">((</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">settings</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">refresh_interval_seconds</span><span class="sh">"</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
        <span class="n">r</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="n">r</span><span class="p">))</span>
        <span class="n">env_r</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">COMFY_CONFIG_REFRESH_SECONDS</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">env_r</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span> <span class="n">r</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="nf">int</span><span class="p">(</span><span class="n">env_r</span><span class="p">)))</span>
            <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span> <span class="k">pass</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_refresh</span> <span class="o">=</span> <span class="n">r</span>

        <span class="n">self</span><span class="p">.</span><span class="n">_raw</span> <span class="o">=</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_build_index</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>

    <span class="k">def</span> <span class="nf">_stale_or_changed</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">m</span> <span class="o">!=</span> <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">_refresh</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_ensure_loaded</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">self</span><span class="p">.</span><span class="nf">_stale_or_changed</span><span class="p">():</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_reload_locked</span><span class="p">()</span>

    <span class="c1"># --- 퍼블릭 API ---
</span>    <span class="k">def</span> <span class="nf">api_provider</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nf">str</span><span class="p">(</span><span class="n">key</span><span class="p">).</span><span class="nf">strip</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sh">"</span><span class="s">api_provider key is empty</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">hit</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_norm</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_reload_locked</span><span class="p">()</span>
                <span class="n">hit</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_norm</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">api_provider not found: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hit</span>

    <span class="k">def</span> <span class="nf">api_providers</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
        <span class="sh">"""</span><span class="s">API Key는 목록에선 숨김.</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="nf">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="n">dn</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">dn</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">seen</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">dn</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="n">dn</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">model_id</span><span class="sh">"</span><span class="p">:</span>     <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">model_id</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span>     <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">],</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">dotted</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_raw</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">dotted</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">cur</span><span class="p">:</span>
                <span class="n">cur</span> <span class="o">=</span> <span class="n">cur</span><span class="p">[</span><span class="n">part</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">config path not found: </span><span class="si">{</span><span class="n">dotted</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cur</span>

    <span class="k">def</span> <span class="nf">snapshot</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="k">return</span> <span class="nf">dict</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">)</span>

<span class="c1"># ----- 싱글톤 -----
</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
<span class="n">_instance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_ReadOnlyConfig</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">_default_path</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">_resolve_default_path</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">here</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_default_path</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">COMFY_CONFIG_PATH</span><span class="sh">"</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">here</span><span class="p">,</span> <span class="sh">"</span><span class="s">config.toml</span><span class="sh">"</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">_get_instance</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">_ReadOnlyConfig</span><span class="p">:</span>
    <span class="k">global</span> <span class="n">_instance</span>
    <span class="k">if</span> <span class="n">_instance</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_instance</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">_instance</span> <span class="o">=</span> <span class="nf">_ReadOnlyConfig</span><span class="p">(</span><span class="nf">_resolve_default_path</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">_instance</span>

<span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">refresh_seconds</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">global</span> <span class="n">_instance</span><span class="p">,</span> <span class="n">_default_path</span>
    <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
        <span class="n">_default_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">refresh_seconds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="sh">"</span><span class="s">COMFY_CONFIG_REFRESH_SECONDS</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">refresh_seconds</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">_lock</span><span class="p">:</span>
        <span class="n">_instance</span> <span class="o">=</span> <span class="nf">_ReadOnlyConfig</span><span class="p">(</span><span class="nf">_resolve_default_path</span><span class="p">())</span>

<span class="c1"># ---- 외부 API ----
</span><span class="k">def</span> <span class="nf">api_provider</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>         <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">api_provider</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">api_providers</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>     <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">api_providers</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">dotted</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>                          <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">get</span><span class="p">(</span><span class="n">dotted</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">snapshot</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>                     <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">snapshot</span><span class="p">()</span>

<span class="c1"># ---- 객체형 프록시 ----
</span><span class="k">class</span> <span class="nc">_ConfigProxy</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">_get_instance</span><span class="p">(),</span> <span class="n">name</span><span class="p">)</span>
<span class="n">CONFIG</span> <span class="o">=</span> <span class="nf">_ConfigProxy</span><span class="p">()</span>
</code></pre></div></div>

<hr />

<h1 id="4-선택-comfyui-노드도-용어-맞춰-제공">4) (선택) ComfyUI 노드도 용어 맞춰 제공</h1>

<p>원한다면 <code class="language-plaintext highlighter-rouge">custom_nodes/comfyui_config_reader/config_nodes.py</code>에 아래처럼:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">.config_singleton</span> <span class="kn">import</span> <span class="n">api_provider</span><span class="p">,</span> <span class="n">api_providers</span>
<span class="kn">import</span> <span class="n">json</span>

<span class="k">class</span> <span class="nc">ConfigAPIProviderLookup</span><span class="p">:</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">key</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">})}}</span>
    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">model_id</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">lookup</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Config/API Providers (ReadOnly)</span><span class="sh">"</span>
    <span class="k">def</span> <span class="nf">lookup</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="nf">api_provider</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="sh">"</span><span class="s">model_id</span><span class="sh">"</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">])</span>

<span class="k">class</span> <span class="nc">ConfigListAPIProviders</span><span class="p">:</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}}</span>
    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">providers_json</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">list_providers</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Config/API Providers (ReadOnly)</span><span class="sh">"</span>
    <span class="k">def</span> <span class="nf">list_providers</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="nf">api_providers</span><span class="p">(),</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">),)</span>

<span class="n">NODE_CLASS_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">ConfigAPIProviderLookup</span><span class="sh">"</span><span class="p">:</span> <span class="n">ConfigAPIProviderLookup</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">ConfigListAPIProviders</span><span class="sh">"</span><span class="p">:</span>  <span class="n">ConfigListAPIProviders</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">NODE_DISPLAY_NAME_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">ConfigAPIProviderLookup</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Config: API Provider Lookup</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">ConfigListAPIProviders</span><span class="sh">"</span><span class="p">:</span>  <span class="sh">"</span><span class="s">Config: List API Providers</span><span class="sh">"</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h1 id="5-체크리스트">5) 체크리스트</h1>

<ul>
  <li>
    <p>✅ 섹션/필드명: <strong><code class="language-plaintext highlighter-rouge">api_providers</code> / (display_name, model_id, base_url, api_key)</strong></p>
  </li>
  <li>
    <p>✅ 읽기 전용 + 파일 변경 <strong>최대 1분 내 반영</strong> (mtime + TTL 5~60, 기본 30)</p>
  </li>
  <li>
    <p>✅ 어디서든 간단 접근: <code class="language-plaintext highlighter-rouge">api_provider("키|표시명|model_id")</code></p>
  </li>
  <li>
    <p>✅ 사람이 편집 쉬운 TOML + <code class="language-plaintext highlighter-rouge">${ENV}</code> 치환</p>
  </li>
  <li>
    <p>✅ 목록 노드는 <strong>api_key 비노출</strong></p>
  </li>
</ul>

<p>필요하면, 기존 워크플로우(노드 그래프)에서 자동으로 이 이름들로 바꿔주는 스크립트도 만들어줄게.</p>

<p class="chat--user">

아 params도 포함해줘. 그런데 [api_providers."anthropic-sonnet"] 이 안에 parameters를 dictionary로 넣을 수 없나? 따로 항목을 빼니까 보기가 불편한데 이런건 yaml에서만 가능?

</p>

<p>좋아, <strong>TOML에서도 딕셔너리(맵)를 한 섹션 안에</strong> 넣을 수 있어.<br />
YAML만 되는 게 아니고, TOML은 두 가지 방법을 지원해:</p>

<ol>
  <li>
    <p><strong>인라인 테이블</strong> : 한 줄 <code class="language-plaintext highlighter-rouge">{ ... }</code> 로 딕셔너리 값을 넣기</p>
  </li>
  <li>
    <p><strong>점 표기(dotted keys)</strong> : <code class="language-plaintext highlighter-rouge">parameters.temperature = 0.7</code> 처럼 같은 섹션 안에서 키를 점으로 이어 쓰기</p>
  </li>
</ol>

<p>아래에 둘 다 예시 + 코드를 싱글톤 API에 반영해줄게. <code class="language-plaintext highlighter-rouge">api_providers</code> 항목 안에 <code class="language-plaintext highlighter-rouge">parameters</code>를 그대로 넣고, 기본값 병합도 지원해.</p>

<hr />

<h1 id="1-toml-작성법-step-by-step">1) TOML 작성법 (step-by-step)</h1>

<h2 id="a-인라인-테이블깔끔-한-줄">A. 인라인 테이블(깔끔, 한 줄)</h2>
<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[api_providers."anthropic-sonnet"]</span>
<span class="py">display_name</span> <span class="p">=</span> <span class="s">"Anthropic Claude 3.5 Sonnet"</span>
<span class="py">model_id</span>     <span class="p">=</span> <span class="s">"claude-3-5-sonnet"</span>
<span class="py">base_url</span>     <span class="p">=</span> <span class="s">"https://api.anthropic.com"</span>
<span class="py">api_key</span>      <span class="p">=</span> <span class="s">"${ANTHROPIC_API_KEY}"</span>
<span class="py">parameters</span>   <span class="o">=</span> <span class="p">{</span> <span class="py">temperature</span> <span class="p">=</span> <span class="mf">0.2</span><span class="p">,</span> <span class="py">top_p</span> <span class="p">=</span> <span class="mf">0.9</span><span class="p">,</span> <span class="py">stop</span> <span class="p">=</span> <span class="p">[</span><span class="s">"</span><span class="se">\n\n</span><span class="s">Human:"</span><span class="p">,</span> <span class="s">"</span><span class="se">\n\n</span><span class="s">Assistant:"</span><span class="p">]</span> <span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>
    <p>장점: 한눈에 보기 좋음.</p>
  </li>
  <li>
    <p>유의: <strong>TOML 1.0 스펙상 인라인 테이블은 한 줄</strong> 이어야 해. (줄바꿈/주석 넣기 어려움)</p>
  </li>
</ul>

<h2 id="b-점-표기dotted-keys-같은-섹션-내부-다줄">B. 점 표기(dotted keys, 같은 섹션 내부 다줄)</h2>
<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[api_providers."anthropic-sonnet"]</span>
<span class="py">display_name</span> <span class="p">=</span> <span class="s">"Anthropic Claude 3.5 Sonnet"</span>
<span class="py">model_id</span>     <span class="p">=</span> <span class="s">"claude-3-5-sonnet"</span>
<span class="py">base_url</span>     <span class="p">=</span> <span class="s">"https://api.anthropic.com"</span>
<span class="py">api_key</span>      <span class="p">=</span> <span class="s">"${ANTHROPIC_API_KEY}"</span>
<span class="py">parameters.temperature</span> <span class="p">=</span> <span class="mf">0.2</span>
<span class="py">parameters.top_p</span>       <span class="p">=</span> <span class="mf">0.9</span>
<span class="py">parameters.stop</span>        <span class="p">=</span> <span class="p">[</span><span class="s">"</span><span class="se">\n\n</span><span class="s">Human:"</span><span class="p">,</span> <span class="s">"</span><span class="se">\n\n</span><span class="s">Assistant:"</span><span class="p">]</span>  <span class="c"># ← 주석 OK</span>
</code></pre></div></div>

<ul>
  <li>
    <p>장점: 여러 줄로 읽기 편하고 <strong>주석 가능</strong>.</p>
  </li>
  <li>
    <p>내부적으로는 딕셔너리로 파싱됨. (YAML 필요 없음)</p>
  </li>
</ul>

<h2 id="선택-공통-기본값-병합">(선택) 공통 기본값 병합</h2>
<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[defaults.parameters]</span>
<span class="py">temperature</span> <span class="p">=</span> <span class="mf">0.3</span>
<span class="py">max_tokens</span>  <span class="p">=</span> <span class="mi">2048</span>
</code></pre></div></div>

<ul>
  <li>각 provider의 <code class="language-plaintext highlighter-rouge">parameters</code> 위에 <strong>덮어쓰기 병합</strong> 돼서 최종값이 만들어져.</li>
</ul>

<hr />

<h1 id="2-전체-예시-configtoml">2) 전체 예시 <code class="language-plaintext highlighter-rouge">config.toml</code></h1>
<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">version</span> <span class="p">=</span> <span class="mi">1</span>

<span class="nn">[settings]</span>
<span class="py">refresh_interval_seconds</span> <span class="p">=</span> <span class="mi">30</span>  <span class="c"># 5~60(요구: 1분 내 반영)</span>

<span class="nn">[defaults.parameters]</span>
<span class="py">temperature</span> <span class="p">=</span> <span class="mf">0.3</span>
<span class="py">max_tokens</span>  <span class="p">=</span> <span class="mi">2048</span>

<span class="c"># ── OpenAI (인라인 테이블) ───────────────────────────</span>
<span class="nn">[api_providers."openai-mini"]</span>
<span class="py">display_name</span> <span class="p">=</span> <span class="s">"OpenAI GPT-4o mini"</span>
<span class="py">model_id</span>     <span class="p">=</span> <span class="s">"gpt-4o-mini"</span>
<span class="py">base_url</span>     <span class="p">=</span> <span class="s">"https://api.openai.com/v1"</span>
<span class="py">api_key</span>      <span class="p">=</span> <span class="s">"${OPENAI_API_KEY}"</span>
<span class="py">parameters</span>   <span class="o">=</span> <span class="p">{</span> <span class="py">temperature</span> <span class="p">=</span> <span class="mf">0.25</span><span class="p">,</span> <span class="py">top_p</span> <span class="p">=</span> <span class="mf">0.95</span> <span class="p">}</span>

<span class="c"># ── Anthropic (점 표기) ───────────────────────────────</span>
<span class="nn">[api_providers."anthropic-sonnet"]</span>
<span class="py">display_name</span> <span class="p">=</span> <span class="s">"Anthropic Claude 3.5 Sonnet"</span>
<span class="py">model_id</span>     <span class="p">=</span> <span class="s">"claude-3-5-sonnet"</span>
<span class="py">base_url</span>     <span class="p">=</span> <span class="s">"https://api.anthropic.com"</span>
<span class="py">api_key</span>      <span class="p">=</span> <span class="s">"${ANTHROPIC_API_KEY}"</span>
<span class="py">parameters.temperature</span> <span class="p">=</span> <span class="mf">0.2</span>
<span class="py">parameters.top_p</span>       <span class="p">=</span> <span class="mf">0.9</span>
<span class="py">parameters.stop</span>        <span class="p">=</span> <span class="p">[</span><span class="s">"</span><span class="se">\n\n</span><span class="s">Human:"</span><span class="p">,</span> <span class="s">"</span><span class="se">\n\n</span><span class="s">Assistant:"</span><span class="p">]</span>
</code></pre></div></div>

<hr />

<h1 id="3-외부-사용-방법-그대로--parameters-지원">3) 외부 사용 방법 (그대로, + <code class="language-plaintext highlighter-rouge">parameters</code> 지원)</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">comfyui_config_reader</span> <span class="kn">import</span> <span class="n">api_provider</span><span class="p">,</span> <span class="n">api_providers</span><span class="p">,</span> <span class="n">api_parameters</span><span class="p">,</span> <span class="n">get</span>

<span class="n">cfg</span> <span class="o">=</span> <span class="nf">api_provider</span><span class="p">(</span><span class="sh">"</span><span class="s">anthropic-sonnet</span><span class="sh">"</span><span class="p">)</span>   <span class="c1"># 키 / display_name / model_id 아무거나
</span><span class="nf">print</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">model_id</span><span class="sh">"</span><span class="p">],</span> <span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">],</span> <span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">])</span>
<span class="nf">print</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">])</span>                  <span class="c1"># ← 최종 병합된 dict
</span>
<span class="c1"># 파라미터만 바로
</span><span class="n">params</span> <span class="o">=</span> <span class="nf">api_parameters</span><span class="p">(</span><span class="sh">"</span><span class="s">openai-mini</span><span class="sh">"</span><span class="p">)</span>    <span class="c1"># {"temperature": 0.25, "top_p": 0.95, "max_tokens": 2048}
</span><span class="n">use_cache</span> <span class="o">=</span> <span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">feature_flags.use_cache</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<h1 id="4-드롭인-교체-코드">4) 드롭인 교체 코드</h1>

<h2 id="custom_nodescomfyui_config_reader__init__py-3"><code class="language-plaintext highlighter-rouge">custom_nodes/comfyui_config_reader/__init__.py</code></h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">.config_singleton</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CONFIG</span><span class="p">,</span>
    <span class="n">configure</span><span class="p">,</span>
    <span class="n">api_provider</span><span class="p">,</span> <span class="n">api_providers</span><span class="p">,</span>
    <span class="n">api_parameters</span><span class="p">,</span>                  <span class="c1"># ← 추가
</span>    <span class="n">get</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div>

<h2 id="custom_nodescomfyui_config_readerconfig_singletonpy-3"><code class="language-plaintext highlighter-rouge">custom_nodes/comfyui_config_reader/config_singleton.py</code></h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">threading</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomllib</span>  <span class="c1"># py3.11+
</span>    <span class="n">_TOML_LOADS</span> <span class="o">=</span> <span class="n">tomllib</span><span class="p">.</span><span class="n">loads</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomli</span>     <span class="c1"># py3.10-
</span>    <span class="n">_TOML_LOADS</span> <span class="o">=</span> <span class="n">tomli</span><span class="p">.</span><span class="n">loads</span>

<span class="k">def</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">v</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">out</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="sh">""</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nf">len</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">${</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span><span class="n">j</span><span class="p">],</span> <span class="sh">""</span><span class="p">);</span> <span class="n">i</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">out</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>  <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">v</span><span class="p">.</span><span class="nf">items</span><span class="p">()}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>  <span class="k">return</span> <span class="p">[</span><span class="nf">_expand_env</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">v</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">v</span>

<span class="k">def</span> <span class="nf">_norm</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="nf">str</span><span class="p">(</span><span class="n">s</span><span class="p">).</span><span class="nf">strip</span><span class="p">().</span><span class="nf">lower</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_normalize_model_id</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">model_id</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">request_model</span><span class="sh">"</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">cfg</span> <span class="ow">and</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="n">k</span><span class="p">]).</span><span class="nf">strip</span><span class="p">():</span>
            <span class="k">return</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="n">k</span><span class="p">]).</span><span class="nf">strip</span><span class="p">()</span>
    <span class="k">return</span> <span class="sh">""</span>

<span class="k">def</span> <span class="nf">_deep_merge</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">b</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">out</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="n">b</span> <span class="ow">or</span> <span class="p">{}).</span><span class="nf">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">out</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nf">_deep_merge</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="k">class</span> <span class="nc">_ReadOnlyConfig</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    - 읽기 전용 TOML
    - mtime + TTL(5~60s, 기본 30s) 자동 재로드 → 1분 내 변경 반영
    - 표준 섹션: [api_providers]
    - 각 provider 필수: display_name, model_id, base_url, api_key
      + 선택: parameters(dict)  # 인라인 테이블 또는 dotted keys 모두 지원
    - [defaults.parameters] 병합 지원(개별 provider.parameters가 우선)
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_refresh</span> <span class="o">=</span> <span class="mi">30</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># --- 내부 로딩 ---
</span>    <span class="k">def</span> <span class="nf">_read_text</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">().</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_providers_table</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">tbl</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">api_providers</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tbl</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_build_index</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>

        <span class="c1"># defaults.parameters (alias: defaults.params도 지원)
</span>        <span class="n">defaults</span> <span class="o">=</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">defaults</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="n">d_params</span> <span class="o">=</span> <span class="n">defaults</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">defaults</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>

        <span class="n">tbl</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_providers_table</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span> <span class="k">return</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">raw</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span> <span class="k">continue</span>
            <span class="n">cfg</span> <span class="o">=</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>

            <span class="n">display</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)).</span><span class="nf">strip</span><span class="p">()</span>
            <span class="n">model</span>   <span class="o">=</span> <span class="nf">_normalize_model_id</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
            <span class="n">base</span>    <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)).</span><span class="nf">strip</span><span class="p">()</span>
            <span class="n">api</span>     <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)).</span><span class="nf">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">display</span> <span class="ow">and</span> <span class="n">model</span> <span class="ow">and</span> <span class="n">base</span> <span class="ow">and</span> <span class="n">api</span><span class="p">):</span>
                <span class="k">continue</span>  <span class="c1"># 필수 누락 스킵
</span>
            <span class="c1"># provider.parameters (alias: params) 추출 + defaults 병합
</span>            <span class="n">p_params</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">p_params</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">p_params</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">)</span>  <span class="c1"># 과거 명칭 호환
</span>            <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">p_params</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">p_params</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="n">merged_params</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">d_params</span><span class="p">,</span> <span class="o">**</span><span class="n">p_params</span><span class="p">}</span>

            <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">display</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">model_id</span><span class="sh">"</span><span class="p">:</span>     <span class="n">model</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span>     <span class="n">base</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">:</span>      <span class="n">api</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span>   <span class="n">merged_params</span><span class="p">,</span>  <span class="c1"># ← 포함
</span>            <span class="p">}</span>

            <span class="c1"># 접근 키: 정의 키 / display_name / model_id
</span>            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">{</span><span class="nf">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">display</span><span class="p">,</span> <span class="n">model</span><span class="p">}:</span>
                <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">[</span><span class="nf">_norm</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span> <span class="o">=</span> <span class="n">entry</span>

    <span class="k">def</span> <span class="nf">_reload_locked</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_text</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nf">_TOML_LOADS</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>

        <span class="n">r</span> <span class="o">=</span> <span class="nf">int</span><span class="p">((</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">settings</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">refresh_interval_seconds</span><span class="sh">"</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
        <span class="n">r</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="n">r</span><span class="p">))</span>
        <span class="n">env_r</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">COMFY_CONFIG_REFRESH_SECONDS</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">env_r</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span> <span class="n">r</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="nf">int</span><span class="p">(</span><span class="n">env_r</span><span class="p">)))</span>
            <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span> <span class="k">pass</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_refresh</span> <span class="o">=</span> <span class="n">r</span>

        <span class="n">self</span><span class="p">.</span><span class="n">_raw</span> <span class="o">=</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_build_index</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>

    <span class="k">def</span> <span class="nf">_stale_or_changed</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">m</span> <span class="o">!=</span> <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">_refresh</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_ensure_loaded</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">self</span><span class="p">.</span><span class="nf">_stale_or_changed</span><span class="p">():</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_reload_locked</span><span class="p">()</span>

    <span class="c1"># --- 퍼블릭 API ---
</span>    <span class="k">def</span> <span class="nf">api_provider</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nf">str</span><span class="p">(</span><span class="n">key</span><span class="p">).</span><span class="nf">strip</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sh">"</span><span class="s">api_provider key is empty</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">hit</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_norm</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_reload_locked</span><span class="p">()</span>
                <span class="n">hit</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_norm</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">api_provider not found: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hit</span>

    <span class="k">def</span> <span class="nf">api_providers</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="sh">"""</span><span class="s">목록에서는 api_key 숨김, parameters는 노출.</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="nf">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="n">dn</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">dn</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">seen</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">dn</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="n">dn</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">model_id</span><span class="sh">"</span><span class="p">:</span>     <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">model_id</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span>     <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span>   <span class="n">v</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">api_parameters</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nf">dict</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">api_provider</span><span class="p">(</span><span class="n">key</span><span class="p">).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}))</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">dotted</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_raw</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">dotted</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">cur</span><span class="p">:</span>
                <span class="n">cur</span> <span class="o">=</span> <span class="n">cur</span><span class="p">[</span><span class="n">part</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">config path not found: </span><span class="si">{</span><span class="n">dotted</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cur</span>

    <span class="k">def</span> <span class="nf">snapshot</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="k">return</span> <span class="nf">dict</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">)</span>

<span class="c1"># ----- 싱글톤 -----
</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
<span class="n">_instance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_ReadOnlyConfig</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">_default_path</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">_resolve_default_path</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">here</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_default_path</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">COMFY_CONFIG_PATH</span><span class="sh">"</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">here</span><span class="p">,</span> <span class="sh">"</span><span class="s">config.toml</span><span class="sh">"</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">_get_instance</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">_ReadOnlyConfig</span><span class="p">:</span>
    <span class="k">global</span> <span class="n">_instance</span>
    <span class="k">if</span> <span class="n">_instance</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_instance</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">_instance</span> <span class="o">=</span> <span class="nf">_ReadOnlyConfig</span><span class="p">(</span><span class="nf">_resolve_default_path</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">_instance</span>

<span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">refresh_seconds</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">global</span> <span class="n">_instance</span><span class="p">,</span> <span class="n">_default_path</span>
    <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
        <span class="n">_default_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">refresh_seconds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="sh">"</span><span class="s">COMFY_CONFIG_REFRESH_SECONDS</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">refresh_seconds</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">_lock</span><span class="p">:</span>
        <span class="n">_instance</span> <span class="o">=</span> <span class="nf">_ReadOnlyConfig</span><span class="p">(</span><span class="nf">_resolve_default_path</span><span class="p">())</span>

<span class="c1"># ---- 외부 API ----
</span><span class="k">def</span> <span class="nf">api_provider</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>         <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">api_provider</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">api_providers</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>     <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">api_providers</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">api_parameters</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>       <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">api_parameters</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">dotted</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>                          <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">get</span><span class="p">(</span><span class="n">dotted</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">snapshot</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>                     <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">snapshot</span><span class="p">()</span>

<span class="c1"># ---- 객체형 프록시 ----
</span><span class="k">class</span> <span class="nc">_ConfigProxy</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">_get_instance</span><span class="p">(),</span> <span class="n">name</span><span class="p">)</span>
<span class="n">CONFIG</span> <span class="o">=</span> <span class="nf">_ConfigProxy</span><span class="p">()</span>
</code></pre></div></div>

<hr />

<h1 id="5-정리">5) 정리</h1>

<ul>
  <li>
    <p>✅ <strong>TOML에서도 딕셔너리 가능</strong> : 인라인 테이블 <code class="language-plaintext highlighter-rouge">{...}</code> 또는 점 표기 <code class="language-plaintext highlighter-rouge">parameters.foo =</code></p>
  </li>
  <li>
    <p>✅ <code class="language-plaintext highlighter-rouge">api_providers</code> 각 항목에 <strong><code class="language-plaintext highlighter-rouge">parameters</code> 포함</strong> 지원 (인라인/점표기 모두 OK)</p>
  </li>
  <li>
    <p>✅ <code class="language-plaintext highlighter-rouge">defaults.parameters</code>로 공통값 병합</p>
  </li>
  <li>
    <p>✅ 외부 접근: <code class="language-plaintext highlighter-rouge">api_provider("키")["parameters"]</code> 또는 <code class="language-plaintext highlighter-rouge">api_parameters("키")</code></p>
  </li>
  <li>
    <p>✅ 읽기 전용 + 파일 변경 <strong>최대 1분 내 반영</strong></p>
  </li>
</ul>

<p>원하면 <code class="language-plaintext highlighter-rouge">parameters</code> 외에 <code class="language-plaintext highlighter-rouge">http</code> 같은 섹션도 같은 방식으로 붙여서 병합 지원해줄 수 있어!</p>

<p class="chat--user">

Pydantic 이용해서 api provider 클래스를 만들고 이걸 리스트로 리턴하는 함수가 있으면 좋겠어. 리스트는 api_provider_id 를 사용해서 정렬된 상태로 리턴하고 싶어. 예시에서 "anthropic-sonnet" 이걸 id로 할거야.

</p>

<p>좋다—<strong>Pydantic 모델</strong> 로 <code class="language-plaintext highlighter-rouge">ApiProvider</code> 클래스를 정의하고, 이를 <strong><code class="language-plaintext highlighter-rouge">api_provider_id</code>(예: <code class="language-plaintext highlighter-rouge">"anthropic-sonnet"</code>)로 정렬</strong>해서 리턴하는 함수까지 깔끔하게 붙였어.<br />
기존 싱글톤/<code class="language-plaintext highlighter-rouge">api_providers</code> 스키마와 100% 호환되며, <code class="language-plaintext highlighter-rouge">parameters</code>(dict)도 동일하게 지원/병합돼.</p>

<p>아래 3개만 넣으면 끝:</p>

<hr />

<h1 id="1-configtoml-예시">1) <code class="language-plaintext highlighter-rouge">config.toml</code> (예시)</h1>
<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">version</span> <span class="p">=</span> <span class="mi">1</span>

<span class="nn">[settings]</span>
<span class="py">refresh_interval_seconds</span> <span class="p">=</span> <span class="mi">30</span>

<span class="nn">[defaults.parameters]</span>
<span class="py">temperature</span> <span class="p">=</span> <span class="mf">0.3</span>
<span class="py">max_tokens</span>  <span class="p">=</span> <span class="mi">2048</span>

<span class="nn">[api_providers."openai-mini"]</span>
<span class="py">display_name</span> <span class="p">=</span> <span class="s">"OpenAI GPT-4o mini"</span>
<span class="py">model_id</span>     <span class="p">=</span> <span class="s">"gpt-4o-mini"</span>
<span class="py">base_url</span>     <span class="p">=</span> <span class="s">"https://api.openai.com/v1"</span>
<span class="py">api_key</span>      <span class="p">=</span> <span class="s">"${OPENAI_API_KEY}"</span>
<span class="py">parameters</span>   <span class="o">=</span> <span class="p">{</span> <span class="py">temperature</span> <span class="p">=</span> <span class="mf">0.25</span><span class="p">,</span> <span class="py">top_p</span> <span class="p">=</span> <span class="mf">0.95</span> <span class="p">}</span>

<span class="nn">[api_providers."anthropic-sonnet"]</span>
<span class="py">display_name</span> <span class="p">=</span> <span class="s">"Anthropic Claude 3.5 Sonnet"</span>
<span class="py">model_id</span>     <span class="p">=</span> <span class="s">"claude-3-5-sonnet"</span>
<span class="py">base_url</span>     <span class="p">=</span> <span class="s">"https://api.anthropic.com"</span>
<span class="py">api_key</span>      <span class="p">=</span> <span class="s">"${ANTHROPIC_API_KEY}"</span>
<span class="c"># TOML dotted-keys로 dict 채우기</span>
<span class="py">parameters.temperature</span> <span class="p">=</span> <span class="mf">0.2</span>
<span class="py">parameters.top_p</span>       <span class="p">=</span> <span class="mf">0.9</span>
<span class="py">parameters.stop</span>        <span class="p">=</span> <span class="p">[</span><span class="s">"</span><span class="se">\n\n</span><span class="s">Human:"</span><span class="p">,</span> <span class="s">"</span><span class="se">\n\n</span><span class="s">Assistant:"</span><span class="p">]</span>
</code></pre></div></div>

<hr />

<h1 id="2-custom_nodescomfyui_config_readermodelspy">2) <code class="language-plaintext highlighter-rouge">custom_nodes/comfyui_config_reader/models.py</code></h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>

<span class="k">class</span> <span class="nc">ApiProvider</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    단일 API Provider 엔트리 (정렬 키: api_provider_id)
    </span><span class="sh">"""</span>
    <span class="n">api_provider_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(...,</span> <span class="n">description</span><span class="o">=</span><span class="sh">'</span><span class="s">예: </span><span class="sh">"</span><span class="s">anthropic-sonnet</span><span class="sh">"'</span><span class="p">)</span>
    <span class="n">display_name</span><span class="p">:</span>   <span class="nb">str</span>
    <span class="n">model_id</span><span class="p">:</span>       <span class="nb">str</span>
    <span class="n">base_url</span><span class="p">:</span>       <span class="nb">str</span>
    <span class="n">api_key</span><span class="p">:</span>        <span class="nb">str</span>
    <span class="n">parameters</span><span class="p">:</span>     <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<h1 id="3-custom_nodescomfyui_config_readerconfig_singletonpy-드롭인-교체본">3) <code class="language-plaintext highlighter-rouge">custom_nodes/comfyui_config_reader/config_singleton.py</code> (드롭인 교체본)</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">threading</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomllib</span>  <span class="c1"># py3.11+
</span>    <span class="n">_TOML_LOADS</span> <span class="o">=</span> <span class="n">tomllib</span><span class="p">.</span><span class="n">loads</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomli</span>     <span class="c1"># py3.10-
</span>    <span class="n">_TOML_LOADS</span> <span class="o">=</span> <span class="n">tomli</span><span class="p">.</span><span class="n">loads</span>

<span class="kn">from</span> <span class="n">.models</span> <span class="kn">import</span> <span class="n">ApiProvider</span>  <span class="c1"># ← Pydantic 모델
</span>
<span class="k">def</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">v</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">out</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="sh">""</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nf">len</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">${</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span><span class="n">j</span><span class="p">],</span> <span class="sh">""</span><span class="p">);</span> <span class="n">i</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">out</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>  <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">v</span><span class="p">.</span><span class="nf">items</span><span class="p">()}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>  <span class="k">return</span> <span class="p">[</span><span class="nf">_expand_env</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">v</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">v</span>

<span class="k">def</span> <span class="nf">_norm</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="nf">str</span><span class="p">(</span><span class="n">s</span><span class="p">).</span><span class="nf">strip</span><span class="p">().</span><span class="nf">lower</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_normalize_model_id</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">model_id</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">request_model</span><span class="sh">"</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">cfg</span> <span class="ow">and</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="n">k</span><span class="p">]).</span><span class="nf">strip</span><span class="p">():</span>
            <span class="k">return</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="n">k</span><span class="p">]).</span><span class="nf">strip</span><span class="p">()</span>
    <span class="k">return</span> <span class="sh">""</span>

<span class="k">def</span> <span class="nf">_deep_merge</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">b</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">out</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="n">b</span> <span class="ow">or</span> <span class="p">{}).</span><span class="nf">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">out</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nf">_deep_merge</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="k">class</span> <span class="nc">_ReadOnlyConfig</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    - 읽기 전용 TOML
    - mtime + TTL(5~60s, 기본 30s) 자동 재로드 → 1분 내 변경 반영
    - 표준 섹션: [api_providers]
    - 각 provider 필수: display_name, model_id, base_url, api_key
      + 선택: parameters(dict)  — 인라인 테이블/점 표기 모두 지원
    - [defaults.parameters] 병합 지원 (provider.parameters가 우선)
    - Pydantic 모델(ApiProvider) 변환/정렬 지원
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_refresh</span> <span class="o">=</span> <span class="mi">30</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># 키(조회 식별자: id/display_name/model_id) → provider entry
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># 고유 id → provider entry (중복 제거/정렬 용)
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_by_id</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># --- 내부 로딩 ---
</span>    <span class="k">def</span> <span class="nf">_read_text</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">().</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_providers_table</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">tbl</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">api_providers</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tbl</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_build_index</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_by_id</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>

        <span class="c1"># defaults.parameters (alias: defaults.params)
</span>        <span class="n">defaults</span> <span class="o">=</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">defaults</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="n">d_params</span> <span class="o">=</span> <span class="n">defaults</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">defaults</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>

        <span class="n">tbl</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_providers_table</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span> <span class="k">return</span>

        <span class="k">for</span> <span class="n">provider_id</span><span class="p">,</span> <span class="n">raw</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span> <span class="k">continue</span>
            <span class="n">cfg</span> <span class="o">=</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>

            <span class="n">display</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)).</span><span class="nf">strip</span><span class="p">()</span>
            <span class="n">model</span>   <span class="o">=</span> <span class="nf">_normalize_model_id</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
            <span class="n">base</span>    <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)).</span><span class="nf">strip</span><span class="p">()</span>
            <span class="n">api</span>     <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)).</span><span class="nf">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">display</span> <span class="ow">and</span> <span class="n">model</span> <span class="ow">and</span> <span class="n">base</span> <span class="ow">and</span> <span class="n">api</span><span class="p">):</span>
                <span class="k">continue</span>  <span class="c1"># 필수 누락 스킵
</span>
            <span class="c1"># provider.parameters (alias: params) + defaults 병합
</span>            <span class="n">p_params</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">p_params</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">p_params</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">p_params</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">p_params</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">merged_parameters</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">d_params</span><span class="p">,</span> <span class="o">**</span><span class="n">p_params</span><span class="p">}</span>

            <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">api_provider_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">provider_id</span><span class="p">),</span>   <span class="c1"># ← 원본 TOML 키
</span>                <span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">:</span>    <span class="n">display</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">model_id</span><span class="sh">"</span><span class="p">:</span>        <span class="n">model</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span>        <span class="n">base</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">:</span>         <span class="n">api</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span>      <span class="n">merged_parameters</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="c1"># 고유 id 사전
</span>            <span class="n">self</span><span class="p">.</span><span class="n">_by_id</span><span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="n">provider_id</span><span class="p">)]</span> <span class="o">=</span> <span class="n">entry</span>
            <span class="c1"># 조회 인덱스(여러 키로 접근 가능: id / display_name / model_id)
</span>            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">{</span><span class="nf">str</span><span class="p">(</span><span class="n">provider_id</span><span class="p">),</span> <span class="n">display</span><span class="p">,</span> <span class="n">model</span><span class="p">}:</span>
                <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">[</span><span class="nf">_norm</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span> <span class="o">=</span> <span class="n">entry</span>

    <span class="k">def</span> <span class="nf">_reload_locked</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_text</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nf">_TOML_LOADS</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>

        <span class="n">r</span> <span class="o">=</span> <span class="nf">int</span><span class="p">((</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">settings</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">refresh_interval_seconds</span><span class="sh">"</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
        <span class="n">r</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="n">r</span><span class="p">))</span>
        <span class="n">env_r</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">COMFY_CONFIG_REFRESH_SECONDS</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">env_r</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span> <span class="n">r</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="nf">int</span><span class="p">(</span><span class="n">env_r</span><span class="p">)))</span>
            <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span> <span class="k">pass</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_refresh</span> <span class="o">=</span> <span class="n">r</span>

        <span class="n">self</span><span class="p">.</span><span class="n">_raw</span> <span class="o">=</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_build_index</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>

    <span class="k">def</span> <span class="nf">_stale_or_changed</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">m</span> <span class="o">!=</span> <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">_refresh</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_ensure_loaded</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">self</span><span class="p">.</span><span class="nf">_stale_or_changed</span><span class="p">():</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_reload_locked</span><span class="p">()</span>

    <span class="c1"># --- 퍼블릭 키-값 API ---
</span>    <span class="k">def</span> <span class="nf">api_provider</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nf">str</span><span class="p">(</span><span class="n">key</span><span class="p">).</span><span class="nf">strip</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sh">"</span><span class="s">api_provider key is empty</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">hit</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_norm</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_reload_locked</span><span class="p">()</span>
                <span class="n">hit</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_norm</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">api_provider not found: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hit</span>

    <span class="k">def</span> <span class="nf">api_providers</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="sh">"""</span><span class="s">목록(요약): api_key는 숨기고 parameters는 노출.</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">pid</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_by_id</span><span class="p">.</span><span class="nf">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">kv</span><span class="p">:</span> <span class="n">kv</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">out</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">model_id</span><span class="sh">"</span><span class="p">:</span>     <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">model_id</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span>     <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span>   <span class="n">v</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="c1"># --- Pydantic 모델 API ---
</span>    <span class="k">def</span> <span class="nf">api_provider_models</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ApiProvider</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">ApiProvider 리스트(정렬: api_provider_id). api_key 포함 — 로깅 유의!</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">models</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ApiProvider</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nc">ApiProvider</span><span class="p">(</span><span class="o">**</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_by_id</span><span class="p">.</span><span class="nf">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">kv</span><span class="p">:</span> <span class="n">kv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">models</span>

    <span class="k">def</span> <span class="nf">api_provider_model</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">api_provider_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ApiProvider</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">entry</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_by_id</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">api_provider_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">entry</span><span class="p">:</span>
            <span class="c1"># 다른 키로 들어왔을 수도 있으니 인덱스도 조회
</span>            <span class="n">entry</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_norm</span><span class="p">(</span><span class="n">api_provider_id</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">entry</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">api_provider not found: </span><span class="si">{</span><span class="n">api_provider_id</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="nc">ApiProvider</span><span class="p">(</span><span class="o">**</span><span class="n">entry</span><span class="p">)</span>

    <span class="c1"># --- 범용 ---
</span>    <span class="k">def</span> <span class="nf">api_parameters</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nf">dict</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">api_provider</span><span class="p">(</span><span class="n">key</span><span class="p">).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}))</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">dotted</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_raw</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">dotted</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">cur</span><span class="p">:</span>
                <span class="n">cur</span> <span class="o">=</span> <span class="n">cur</span><span class="p">[</span><span class="n">part</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">config path not found: </span><span class="si">{</span><span class="n">dotted</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cur</span>

    <span class="k">def</span> <span class="nf">snapshot</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="k">return</span> <span class="nf">dict</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">)</span>

<span class="c1"># ----- 싱글톤 -----
</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
<span class="n">_instance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_ReadOnlyConfig</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">_default_path</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">_resolve_default_path</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">here</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_default_path</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">COMFY_CONFIG_PATH</span><span class="sh">"</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">here</span><span class="p">,</span> <span class="sh">"</span><span class="s">config.toml</span><span class="sh">"</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">_get_instance</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">_ReadOnlyConfig</span><span class="p">:</span>
    <span class="k">global</span> <span class="n">_instance</span>
    <span class="k">if</span> <span class="n">_instance</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_instance</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">_instance</span> <span class="o">=</span> <span class="nf">_ReadOnlyConfig</span><span class="p">(</span><span class="nf">_resolve_default_path</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">_instance</span>

<span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">refresh_seconds</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">global</span> <span class="n">_instance</span><span class="p">,</span> <span class="n">_default_path</span>
    <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
        <span class="n">_default_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">refresh_seconds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="sh">"</span><span class="s">COMFY_CONFIG_REFRESH_SECONDS</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">refresh_seconds</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">_lock</span><span class="p">:</span>
        <span class="n">_instance</span> <span class="o">=</span> <span class="nf">_ReadOnlyConfig</span><span class="p">(</span><span class="nf">_resolve_default_path</span><span class="p">())</span>

<span class="c1"># ---- 외부 API (함수형) ----
</span><span class="k">def</span> <span class="nf">api_provider</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>             <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">api_provider</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">api_providers</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>         <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">api_providers</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">api_parameters</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>           <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">api_parameters</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">api_provider_models</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ApiProvider</span><span class="p">]:</span>           <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">api_provider_models</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">api_provider_model</span><span class="p">(</span><span class="n">api_provider_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ApiProvider</span><span class="p">:</span> <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">api_provider_model</span><span class="p">(</span><span class="n">api_provider_id</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">dotted</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>                              <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">get</span><span class="p">(</span><span class="n">dotted</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">snapshot</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>                         <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">snapshot</span><span class="p">()</span>

<span class="c1"># ---- 객체형 프록시 ----
</span><span class="k">class</span> <span class="nc">_ConfigProxy</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">_get_instance</span><span class="p">(),</span> <span class="n">name</span><span class="p">)</span>
<span class="n">CONFIG</span> <span class="o">=</span> <span class="nf">_ConfigProxy</span><span class="p">()</span>
</code></pre></div></div>

<hr />

<h1 id="4-custom_nodescomfyui_config_reader__init__py-re-export">4) <code class="language-plaintext highlighter-rouge">custom_nodes/comfyui_config_reader/__init__.py</code> (re-export)</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">.config_singleton</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CONFIG</span><span class="p">,</span>
    <span class="n">configure</span><span class="p">,</span>
    <span class="n">api_provider</span><span class="p">,</span> <span class="n">api_providers</span><span class="p">,</span> <span class="n">api_parameters</span><span class="p">,</span>
    <span class="n">api_provider_model</span><span class="p">,</span> <span class="n">api_provider_models</span><span class="p">,</span>
    <span class="n">get</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div>

<hr />

<h2 id="사용-예-간단">사용 예 (간단)</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">comfyui_config_reader</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">api_provider_models</span><span class="p">,</span> <span class="n">api_provider_model</span><span class="p">,</span>
    <span class="n">api_provider</span><span class="p">,</span> <span class="n">api_parameters</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># 전체 Pydantic 리스트 (정렬: api_provider_id)
</span><span class="n">providers</span> <span class="o">=</span> <span class="nf">api_provider_models</span><span class="p">()</span>
<span class="c1"># ex) ["anthropic-sonnet", "openai-mini", ...] 순서
</span><span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">providers</span><span class="p">:</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">api_provider_id</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">model_id</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">parameters</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">temperature</span><span class="sh">"</span><span class="p">))</span>

<span class="c1"># 단건 조회(Pydantic)
</span><span class="n">sonnet</span> <span class="o">=</span> <span class="nf">api_provider_model</span><span class="p">(</span><span class="sh">"</span><span class="s">anthropic-sonnet</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">sonnet</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">())</span>  <span class="c1"># pydantic v2 / v1은 .dict()
</span>
<span class="c1"># 키/표시명/모델ID 아무거나로 접근(딕셔너리)
</span><span class="n">cfg</span> <span class="o">=</span> <span class="nf">api_provider</span><span class="p">(</span><span class="sh">"</span><span class="s">OpenAI GPT-4o mini</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">],</span> <span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">])</span>

<span class="c1"># 파라미터만
</span><span class="n">params</span> <span class="o">=</span> <span class="nf">api_parameters</span><span class="p">(</span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<h3 id="비고">비고</h3>

<ul>
  <li>
    <p><strong>보안 주의</strong> : <code class="language-plaintext highlighter-rouge">api_provider_models()</code>는 객체에 <code class="language-plaintext highlighter-rouge">api_key</code>가 포함돼요. 로깅/디버깅 시 마스킹하세요.</p>
  </li>
  <li>
    <p><strong>TOML 파라미터 입력</strong> : 인라인 테이블(<code class="language-plaintext highlighter-rouge">{...}</code>) 또는 점 표기(<code class="language-plaintext highlighter-rouge">parameters.x = ...</code>) 둘 다 OK.</p>
  </li>
  <li>
    <p><strong>정렬 보장</strong> : 리스트는 <strong>항상<code class="language-plaintext highlighter-rouge">api_provider_id</code>(TOML 키)</strong> 기준 오름차순.</p>
  </li>
  <li>
    <p><strong>성능/일관성</strong> : mtime + TTL(기본 30s) 캐시 → “최대 1분 내 변경 반영” 요건 충족.</p>
  </li>
</ul>

<p>필요하면 같은 방식으로 <code class="language-plaintext highlighter-rouge">http</code> 섹션(헤더/쿼리/타임아웃)도 병합해서 모델에 넣을 수 있게 확장해줄게!</p>

        
      </section>

      <footer class="page__meta">
        
        


  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      <a href="/categories/#comfyui" class="page__taxonomy-item p-category" rel="tag">comfyui</a>
    
    </span>
  </p>


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time class="dt-published" datetime="2025-10-02T13:39:43+09:00">2025-10-02</time></p>

      </footer>

      

      
  <nav class="pagination">
    
      <a href="/python/openai-package-data-hook/" class="pagination--pager" title="openai api Raw 데이터 확인 방법">Previous</a>
    
    
      <a href="/comfyui/async-request/" class="pagination--pager" title="Async request 취소 처리">Next</a>
    
  </nav>


    </div>

    
  </article>

  
  
    
<div class="page__related">
  
  <h2 class="page__related-title">You may also enjoy</h2>
  <div class="grid__wrapper">
    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/2025-08-19-python-repr-vs-str/" rel="permalink">
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <!-- hvppyarchive: remove date icon
        <i class="far fa-calendar-alt" aria-hidden="true"></i> 
        -->
        
        <time datetime="2025-10-19T11:48:01+09:00">2025-10-19</time>
      </span>
    

    

    
  </p>


    <p class="archive__item-excerpt" itemprop="description">
</p>
  </article>
</div>

    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/llm/vllm-responses/" rel="permalink">vLLM 툴 호출 예제
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <!-- hvppyarchive: remove date icon
        <i class="far fa-calendar-alt" aria-hidden="true"></i> 
        -->
        
        <time datetime="2025-10-19T11:47:56+09:00">2025-10-19</time>
      </span>
    

    

    
  </p>


    <p class="archive__item-excerpt" itemprop="description">

</p>
  </article>
</div>

    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/llm/local-mcp/" rel="permalink">LLM Local MCP
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <!-- hvppyarchive: remove date icon
        <i class="far fa-calendar-alt" aria-hidden="true"></i> 
        -->
        
        <time datetime="2025-10-17T19:56:32+09:00">2025-10-17</time>
      </span>
    

    

    
  </p>


    <p class="archive__item-excerpt" itemprop="description">

</p>
  </article>
</div>

    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/circuit/circuit-optimization-example/" rel="permalink">아날로그 회로 최적화 데모
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <!-- hvppyarchive: remove date icon
        <i class="far fa-calendar-alt" aria-hidden="true"></i> 
        -->
        
        <time datetime="2025-10-17T15:03:52+09:00">2025-10-17</time>
      </span>
    

    

    
  </p>


    <p class="archive__item-excerpt" itemprop="description">

</p>
  </article>
</div>

    
  </div>
</div>

  
  
</div>

      
    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';" role="search">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        

<div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
      
        
      
        
      
        
      
        
      
        
      
    

    
  </ul>
</div>


<div class="page__footer-copyright">&copy; 2013 - 2025 <a href="https://hvppyarchive.github.io">ARCHIVE</a>. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/jekyll-themes/minimal-mistakes/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>






  </body>
</html>
