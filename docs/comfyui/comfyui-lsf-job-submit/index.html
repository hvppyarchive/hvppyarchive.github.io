<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.27.1 by Michael Rose
  Copyright 2013-2025 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->

<html lang="en-US" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>ComfyUI LSF Job Submit - ARCHIVE</title>
<meta name="description" content="">


  <meta name="author" content="hvppyarchive">
  
  <meta property="article:author" content="hvppyarchive">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="ARCHIVE">
<meta property="og:title" content="ComfyUI LSF Job Submit">
<meta property="og:url" content="https://hvppyarchive.github.io/comfyui/comfyui-lsf-job-submit/">


  <meta property="og:description" content="">







  <meta property="article:published_time" content="2025-10-10T19:44:39+09:00">





  

  


<link rel="canonical" href="https://hvppyarchive.github.io/comfyui/comfyui-lsf-job-submit/">












<!-- end _includes/seo.html -->


<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
  
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css"></noscript>



    <!-- start custom head snippets -->
<!-- hvppyarchive: add fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@200..900&display=swap" rel="stylesheet">

<!-- insert favicons. use https://realfavicongenerator.net/ -->
 <!-- hvppyarchive: add favicons -->
<link rel="icon" type="image/png" href="/assets/favicon/favicon-96x96.png" sizes="96x96" />
<link rel="icon" type="image/svg+xml" href="/assets/favicon/favicon.svg" />
<link rel="shortcut icon" href="/assets/favicon/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon/apple-touch-icon.png" />
<link rel="manifest" href="/assets/favicon/site.webmanifest" />

<!-- end custom head snippets -->

  </head>

  <body class="layout--single" dir="ltr">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          ARCHIVE
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a
                href="/year-archive/"
                
                
              >Posts</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <i class="fas fa-search"></i>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      





<div id="main" role="main">
  


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="ComfyUI LSF Job Submit">
    <meta itemprop="description" content="">
    <meta itemprop="datePublished" content="2025-10-10T19:44:39+09:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">
            <a href="https://hvppyarchive.github.io/comfyui/comfyui-lsf-job-submit/" itemprop="url">ComfyUI LSF Job Submit
</a>
          </h1>
          

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <!-- hvppyarchive: remove date icon
        <i class="far fa-calendar-alt" aria-hidden="true"></i> 
        -->
        
        <time datetime="2025-10-10T19:44:39+09:00">2025-10-10</time>
      </span>
    

    

    
  </p>


        </header>
      

      <section class="page__content" itemprop="text">
        
        <p class="chat--user">

ComfyUI에서 LSF Job을 Submit하고 이를 끝날 때까지 기다리는 Custom node를 개발하고 싶어. 요구 조건 1. main execute 함수를 async하게 구현해야 함(최신 ComfyUI에서는 async 노드 동작을 지원함) 2. Polling하며 bjobs 커맨드를 이용해 상태를 체크해야 함. 이 때 bjobs 커맨드가 다른 걸로 바뀌더라도 쉽게 변경할 수 있게 구조를 유연하게 짜줘. 3. 이 때 여러 노드가 동시에 돌 수도 있으며, bjobs를 너무 자주 치는 것을 방지하기 위해 파일시스템에 캐싱하는 로직이 있으면 좋을 것 같음. 4. 입력은 커맨드, cwd 2개 스트링임. 커맨드는 멀티라인으로 여러 bsub 커맨드가 들어올 수 도 있음을 명심할 것. bsub 커맨드 자체도 async하게 멀티로 뿌리도록 하면 좋을 것 같음(단 너무 한 번에 많은 job이 들어가지 않도록 배치 사이즈 조절은 필요할 것 같음) 5. 이 자체가 output 노드이면서 끝나면 적절한 아웃풋(뭐가 될지는 추천해줘)도 뱉도록 하자. 

</p>

<p>좋아! 요구사항을 모두 만족하는 <strong>ComfyUI용 LSF Submit &amp; Wait 커스텀 노드</strong> 설계를 깔끔하게 정리한 뒤, 바로 붙여 넣어 쓸 수 있는 완전한 코드를 드릴게요.</p>

<h1 id="설계-개요">설계 개요</h1>

<ul>
  <li>
    <p><strong>Async 노드</strong> : <code class="language-plaintext highlighter-rouge">SUPPORTS_ASYNC = True</code>, <code class="language-plaintext highlighter-rouge">async def run(...)</code> 구현.</p>
  </li>
  <li>
    <p><strong>멀티라인 bsub 제출</strong> : 입력 <code class="language-plaintext highlighter-rouge">commands</code>의 각 비어있지 않은 라인을 독립 명령으로 비동기 제출. 동시 제출 개수는 배치 크기로 제한.</p>
  </li>
  <li>
    <p><strong>Polling 구조/유연성</strong> : <code class="language-plaintext highlighter-rouge">StatusBackend</code> 인터페이스와 <code class="language-plaintext highlighter-rouge">LSFBjobsBackend</code> 기본 구현. <code class="language-plaintext highlighter-rouge">status_cmd_template</code>(예: <code class="language-plaintext highlighter-rouge">bjobs -noheader -o "jobid stat" {job_ids}</code>)을 바꾸기만 하면 다른 커맨드로 쉽게 전환.</p>
  </li>
  <li>
    <p><strong>파일시스템 캐시</strong> : 여러 노드가 동시에 돌아도 <code class="language-plaintext highlighter-rouge">status_cache.json</code>(잠금 포함)로 <strong>TTL 기반</strong> 캐싱. 너무 자주 <code class="language-plaintext highlighter-rouge">bjobs</code>를 치지 않도록 함.</p>
  </li>
  <li><strong>입력</strong> : <code class="language-plaintext highlighter-rouge">commands</code>(멀티라인 문자열), <code class="language-plaintext highlighter-rouge">cwd</code>(작업 디렉토리).<br />
추가 파라미터는 <strong>인라인 지시문</strong> 으로 조절:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># LSF: batch_size=4 poll_interval_s=10 status_ttl_s=15</span>
</code></pre></div>    </div>

    <ul>
      <li><code class="language-plaintext highlighter-rouge">batch_size</code>(동시 제출 개수), <code class="language-plaintext highlighter-rouge">poll_interval_s</code>(폴링 주기), <code class="language-plaintext highlighter-rouge">status_ttl_s</code>(캐시 TTL),<br />
<code class="language-plaintext highlighter-rouge">status_cmd_template</code>(상태 조회 커맨드 템플릿) 등 지원.</li>
    </ul>
  </li>
  <li>
    <p><strong>출력(OUTPUT 노드)</strong> :</p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">job_ids</code>: 제출된 Job ID들의 콤마 구분 문자열</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">results_json</code>: 요약 JSON 문자열(최종 상태/성공여부/결과 파일 경로 등)</p>
      </li>
    </ul>
  </li>
  <li><strong>터미널 상태</strong> : 기본 <code class="language-plaintext highlighter-rouge">{"DONE","EXIT"}</code>. 필요시 코드 내 상수로 확장 가능.</li>
</ul>

<hr />

<h1 id="설치사용법">설치/사용법</h1>

<ol>
  <li>
    <p>아래 코드를 <code class="language-plaintext highlighter-rouge">ComfyUI/custom_nodes/lsf_submit_and_wait.py</code> 로 저장 후 ComfyUI 재시작.</p>
  </li>
  <li>워크플로에서 이 노드를 마지막에 두고, <code class="language-plaintext highlighter-rouge">commands</code>에 여러 줄 <code class="language-plaintext highlighter-rouge">bsub ...</code>들을 넣으면 됨.<br />
옵션은 맨 위에 한 줄의 인라인 지시문으로 조절:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># LSF: batch_size=3 poll_interval_s=15 status_ttl_s=30</span>
bsub <span class="nt">-q</span> short <span class="nt">-J</span> test1 <span class="nb">sleep </span>5
bsub <span class="nt">-q</span> short <span class="nt">-J</span> test2 <span class="nb">sleep </span>8
bsub <span class="nt">-q</span> short <span class="nt">-J</span> test3 <span class="nb">sleep </span>2
</code></pre></div>    </div>
  </li>
  <li>결과는 <code class="language-plaintext highlighter-rouge">job_ids</code>와 <code class="language-plaintext highlighter-rouge">results_json</code>(요약/결과 파일 경로 포함)으로 반환됩니다.</li>
</ol>

<hr />

<h1 id="코드-그대로-사용-가능">코드 (그대로 사용 가능)</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># File: custom_nodes/lsf_submit_and_wait.py
</span><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">re</span>
<span class="kn">import</span> <span class="n">shlex</span>
<span class="kn">import</span> <span class="n">tempfile</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="c1"># fcntl (POSIX) 잠금: Windows에선 graceful degrade
</span><span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">fcntl</span>  <span class="c1"># type: ignore
</span><span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">fcntl</span> <span class="o">=</span> <span class="bp">None</span>

<span class="c1"># ---------- 유틸 ----------
</span>
<span class="n">JOB_ID_REGEX</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">Job\s*&lt;(\d+)&gt;</span><span class="sh">"</span><span class="p">,</span> <span class="n">re</span><span class="p">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
<span class="n">TERMINAL_STATES</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">DONE</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">EXIT</span><span class="sh">"</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">iso_now</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">datetime</span><span class="p">.</span><span class="nf">utcnow</span><span class="p">().</span><span class="nf">isoformat</span><span class="p">(</span><span class="n">timespec</span><span class="o">=</span><span class="sh">"</span><span class="s">seconds</span><span class="sh">"</span><span class="p">)</span> <span class="o">+</span> <span class="sh">"</span><span class="s">Z</span><span class="sh">"</span>

<span class="k">def</span> <span class="nf">default_cache_dir</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span>
        <span class="sh">"</span><span class="s">COMFYUI_LSF_CACHE_DIR</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">tempfile</span><span class="p">.</span><span class="nf">gettempdir</span><span class="p">(),</span> <span class="sh">"</span><span class="s">comfyui_lsf_cache</span><span class="sh">"</span><span class="p">)</span>
    <span class="p">)</span>

<span class="k">def</span> <span class="nf">ensure_dir</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">d</span>

<span class="k">def</span> <span class="nf">parse_inline_options_and_commands</span><span class="p">(</span><span class="n">commands_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    첫 줄(들)에 </span><span class="sh">'</span><span class="s"># LSF: key=value key=value ...</span><span class="sh">'</span><span class="s"> 형식의 인라인 옵션을 허용.
    반환: (options_dict, command_lines)
    </span><span class="sh">"""</span>
    <span class="n">options</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">ln</span> <span class="k">for</span> <span class="n">ln</span> <span class="ow">in</span> <span class="n">commands_text</span><span class="p">.</span><span class="nf">splitlines</span><span class="p">()]</span>
    <span class="n">clean_lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ln</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">^\s*#\s*LSF:\s*(.+)$</span><span class="sh">"</span><span class="p">,</span> <span class="n">ln</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
            <span class="c1"># key=value ... 파싱(따옴표 허용)
</span>            <span class="n">kvs</span> <span class="o">=</span> <span class="n">shlex</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">posix</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">kv</span> <span class="ow">in</span> <span class="n">kvs</span><span class="p">:</span>
                <span class="k">if</span> <span class="sh">"</span><span class="s">=</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">kv</span><span class="p">:</span>
                    <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">kv</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">=</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="c1"># 숫자형 자동 캐스팅
</span>                    <span class="k">if</span> <span class="n">v</span><span class="p">.</span><span class="nf">isdigit</span><span class="p">():</span>
                        <span class="n">v</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># true/false
</span>                        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">v</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">false</span><span class="sh">"</span><span class="p">):</span>
                            <span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="o">==</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">)</span>
                    <span class="n">options</span><span class="p">[</span><span class="n">k</span><span class="p">.</span><span class="nf">strip</span><span class="p">()]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">continue</span>
        <span class="n">clean_lines</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">ln</span><span class="p">)</span>
    <span class="c1"># 비어있는 라인 제거
</span>    <span class="n">clean_lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">ln</span> <span class="k">for</span> <span class="n">ln</span> <span class="ow">in</span> <span class="n">clean_lines</span> <span class="k">if</span> <span class="n">ln</span><span class="p">.</span><span class="nf">strip</span><span class="p">()]</span>
    <span class="k">return</span> <span class="n">options</span><span class="p">,</span> <span class="n">clean_lines</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_shell</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">cwd</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
    <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_shell</span><span class="p">(</span>
        <span class="n">cmd</span><span class="p">,</span>
        <span class="n">cwd</span><span class="o">=</span><span class="n">cwd</span> <span class="k">if</span> <span class="n">cwd</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
        <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">out_b</span><span class="p">,</span> <span class="n">err_b</span> <span class="o">=</span> <span class="k">await</span> <span class="n">proc</span><span class="p">.</span><span class="nf">communicate</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">proc</span><span class="p">.</span><span class="n">returncode</span><span class="p">,</span> <span class="n">out_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">ignore</span><span class="sh">"</span><span class="p">),</span> <span class="n">err_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">ignore</span><span class="sh">"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">extract_job_ids_from_bsub_output</span><span class="p">(</span><span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="c1"># LSF 표준: "Job &lt;12345&gt; is submitted to queue &lt;...&gt;."
</span>    <span class="k">return</span> <span class="n">JOB_ID_REGEX</span><span class="p">.</span><span class="nf">findall</span><span class="p">(</span><span class="n">stdout</span><span class="p">)</span>

<span class="c1"># ---------- 상태 백엔드/캐시 ----------
</span>
<span class="k">class</span> <span class="nc">StatusBackend</span><span class="p">:</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">query</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">job_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="nb">NotImplementedError</span>

<span class="k">class</span> <span class="nc">LSFBjobsBackend</span><span class="p">(</span><span class="n">StatusBackend</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    status_cmd_template 예:
      </span><span class="sh">'</span><span class="s">bjobs -noheader -o </span><span class="sh">"</span><span class="s">jobid stat</span><span class="sh">"</span><span class="s"> {job_ids}</span><span class="sh">'</span><span class="s">
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">status_cmd_template</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">status_cmd_template</span><span class="p">:</span>
            <span class="n">status_cmd_template</span> <span class="o">=</span> <span class="sh">'</span><span class="s">bjobs -noheader -o </span><span class="sh">"</span><span class="s">jobid stat</span><span class="sh">"</span><span class="s"> {job_ids}</span><span class="sh">'</span>
        <span class="n">self</span><span class="p">.</span><span class="n">template</span> <span class="o">=</span> <span class="n">status_cmd_template</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">query</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">job_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">job_ids</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">template</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">job_ids</span><span class="o">=</span><span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">job_ids</span><span class="p">))</span>
        <span class="n">rc</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">run_shell</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># 실패 시 빈 딕트 반환 (상위 로직에서 재시도/캐시 사용)
</span>            <span class="k">return</span> <span class="p">{}</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># 기대 포맷: "&lt;jobid&gt; &lt;state&gt;"
</span>        <span class="k">for</span> <span class="n">ln</span> <span class="ow">in</span> <span class="n">out</span><span class="p">.</span><span class="nf">splitlines</span><span class="p">():</span>
            <span class="n">ln</span> <span class="o">=</span> <span class="n">ln</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ln</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">ln</span><span class="p">.</span><span class="nf">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">parts</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">jid</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nf">upper</span><span class="p">()</span>
            <span class="n">result</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span>
        <span class="k">return</span> <span class="n">result</span>

<span class="k">class</span> <span class="nc">SharedJSONCache</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    여러 프로세스/노드 간 공유되는 JSON 캐시 (TTL 적용).
    파일 잠금 사용(가능 시).
    구조: { job_id: {</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">RUN</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="s">: epoch_seconds}, ... }
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cache_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ttl_s</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cache_file</span> <span class="o">=</span> <span class="n">cache_file</span>
        <span class="n">self</span><span class="p">.</span><span class="n">ttl_s</span> <span class="o">=</span> <span class="n">ttl_s</span>
        <span class="nf">ensure_dir</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">cache_file</span><span class="p">))</span>
        <span class="c1"># 파일 초기화
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">cache_file</span><span class="p">):</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">cache_file</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">({},</span> <span class="n">f</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_lock</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">fh</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">fcntl</span><span class="p">:</span>
            <span class="n">fcntl</span><span class="p">.</span><span class="nf">flock</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">fcntl</span><span class="p">.</span><span class="n">LOCK_EX</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_unlock</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">fh</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">fcntl</span><span class="p">:</span>
            <span class="n">fcntl</span><span class="p">.</span><span class="nf">flock</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">fcntl</span><span class="p">.</span><span class="n">LOCK_UN</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_read</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cache_file</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_write</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">cache_file</span> <span class="o">+</span> <span class="sh">"</span><span class="s">.tmp</span><span class="sh">"</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">cache_file</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_statuses</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">job_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">backend</span><span class="p">:</span> <span class="n">StatusBackend</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>

        <span class="c1"># 1) 읽기 잠금
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">fh</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cache_file</span><span class="p">,</span> <span class="sh">"</span><span class="s">r+</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="nf">ensure_dir</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cache_file</span><span class="p">))</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cache_file</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">({},</span> <span class="n">f</span><span class="p">)</span>
            <span class="n">fh</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cache_file</span><span class="p">,</span> <span class="sh">"</span><span class="s">r+</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_lock</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fh</span><span class="p">.</span><span class="nf">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c1"># 캐시 히트/미스 결정
</span>            <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">to_query</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">:</span>
                <span class="n">entry</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">entry</span> <span class="ow">and</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="nf">float</span><span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">ttl_s</span><span class="p">):</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">to_query</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_unlock</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
            <span class="n">fh</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>

        <span class="c1"># 2) 미스 대상 조회 (잠금 없이)
</span>        <span class="n">fresh</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">to_query</span><span class="p">:</span>
            <span class="n">fresh</span> <span class="o">=</span> <span class="k">await</span> <span class="n">backend</span><span class="p">.</span><span class="nf">query</span><span class="p">(</span><span class="n">to_query</span><span class="p">)</span>

        <span class="c1"># 3) 쓰기 잠금하여 병합 반영
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">fh</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cache_file</span><span class="p">,</span> <span class="sh">"</span><span class="s">r+</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_lock</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fh</span><span class="p">.</span><span class="nf">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">data2</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="n">data2</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">updated</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">jid</span><span class="p">,</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">fresh</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
                <span class="n">prev</span> <span class="o">=</span> <span class="n">data2</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">prev</span> <span class="ow">or</span> <span class="n">prev</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">)</span> <span class="o">!=</span> <span class="n">st</span> <span class="ow">or</span> <span class="p">(</span><span class="n">ts</span> <span class="o">-</span> <span class="nf">float</span><span class="p">(</span><span class="n">prev</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">data2</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">:</span> <span class="n">st</span><span class="p">,</span> <span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">ts</span><span class="p">}</span>
                    <span class="n">updated</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="n">updated</span><span class="p">:</span>
                <span class="n">fh</span><span class="p">.</span><span class="nf">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">fh</span><span class="p">.</span><span class="nf">truncate</span><span class="p">()</span>
                <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">data2</span><span class="p">,</span> <span class="n">fh</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_unlock</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
            <span class="n">fh</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>

        <span class="c1"># 결괏값 구성 (fresh 우선)
</span>        <span class="n">result</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">fresh</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

<span class="c1"># ---------- 제출 &amp; 대기 ----------
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">submit_commands_multiline</span><span class="p">(</span><span class="n">commands</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">cwd</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    각 라인을 독립 커맨드로 제출. bsub 출력에서 Job ID 추출.
    동시 제출 개수를 batch_size로 제한.
    </span><span class="sh">"""</span>
    <span class="n">sem</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Semaphore</span><span class="p">(</span><span class="nf">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nf">int</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)))</span>
    <span class="n">submissions</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_submit_one</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">sem</span><span class="p">:</span>
            <span class="n">rc</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">run_shell</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">cwd</span><span class="p">)</span>
            <span class="n">jids</span> <span class="o">=</span> <span class="nf">extract_job_ids_from_bsub_output</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">:</span> <span class="n">cmd</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="n">rc</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="n">out</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="n">err</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">:</span> <span class="n">jids</span><span class="p">,</span>
            <span class="p">}</span>

    <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">_submit_one</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">commands</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">as_completed</span><span class="p">(</span><span class="n">tasks</span><span class="p">):</span>
        <span class="n">submissions</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="k">await</span> <span class="n">t</span><span class="p">)</span>
    <span class="c1"># 추출된 Job ID 평탄화
</span>    <span class="n">job_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">jid</span> <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">submissions</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">sub</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])]</span>
    <span class="k">return</span> <span class="n">job_ids</span><span class="p">,</span> <span class="n">submissions</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">wait_until_done</span><span class="p">(</span><span class="n">job_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                          <span class="n">poll_interval_s</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                          <span class="n">status_cache</span><span class="p">:</span> <span class="n">SharedJSONCache</span><span class="p">,</span>
                          <span class="n">backend</span><span class="p">:</span> <span class="n">StatusBackend</span><span class="p">,</span>
                          <span class="n">max_wait_s</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    모든 job이 TERMINAL_STATES(DONE/EXIT)에 도달할 때까지 폴링.
    max_wait_s 지정시 해당 시간 초과하면 중단.
    </span><span class="sh">"""</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
    <span class="n">final</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">statuses</span> <span class="o">=</span> <span class="k">await</span> <span class="n">status_cache</span><span class="p">.</span><span class="nf">get_statuses</span><span class="p">(</span><span class="n">job_ids</span><span class="p">,</span> <span class="n">backend</span><span class="p">)</span>
        <span class="n">final</span> <span class="o">=</span> <span class="p">{</span><span class="n">jid</span><span class="p">:</span> <span class="n">statuses</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">}</span>
        <span class="c1"># 모두 터미널 상태?
</span>        <span class="k">if</span> <span class="nf">all</span><span class="p">((</span><span class="n">st</span> <span class="ow">in</span> <span class="n">TERMINAL_STATES</span><span class="p">)</span> <span class="ow">and</span> <span class="n">st</span> <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">final</span><span class="p">.</span><span class="nf">values</span><span class="p">()):</span>
            <span class="k">break</span>
        <span class="c1"># 타임아웃?
</span>        <span class="k">if</span> <span class="n">max_wait_s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">max_wait_s</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="nf">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nf">int</span><span class="p">(</span><span class="n">poll_interval_s</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">final</span><span class="p">,</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>

<span class="c1"># ---------- ComfyUI 노드 ----------
</span>
<span class="k">class</span> <span class="nc">LSFSubmitAndWait</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    입력:
      - commands (STRING, multiline): 여러 줄 bsub 커맨드
        * 인라인 옵션: </span><span class="sh">'</span><span class="s"># LSF: batch_size=4 poll_interval_s=10 status_ttl_s=15
                         status_cmd_template=</span><span class="sh">"</span><span class="s">bjobs -noheader -o </span><span class="se">\"</span><span class="s">jobid stat</span><span class="se">\"</span><span class="s"> {job_ids}</span><span class="sh">"'</span><span class="s">
      - cwd (STRING): 실행 디렉토리

    출력(OUTPUT 노드):
      - job_ids (STRING): 콤마 구분 목록
      - results_json (STRING): 요약 JSON 문자열
    </span><span class="sh">"""</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">LSF</span><span class="sh">"</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">run</span><span class="sh">"</span>
    <span class="n">OUTPUT_NODE</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">SUPPORTS_ASYNC</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">results_json</span><span class="sh">"</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">commands</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">bsub -q short sleep 3</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">cwd</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">}),</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">commands</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">cwd</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="c1"># 0) 인라인 옵션/명령 파싱
</span>        <span class="n">opts</span><span class="p">,</span> <span class="n">lines</span> <span class="o">=</span> <span class="nf">parse_inline_options_and_commands</span><span class="p">(</span><span class="n">commands</span><span class="p">)</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">opts</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">batch_size</span><span class="sh">"</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
        <span class="n">poll_interval_s</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">opts</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">poll_interval_s</span><span class="sh">"</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
        <span class="n">status_ttl_s</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">opts</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">status_ttl_s</span><span class="sh">"</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
        <span class="n">status_cmd_template</span> <span class="o">=</span> <span class="n">opts</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">status_cmd_template</span><span class="sh">"</span><span class="p">,</span> <span class="sh">'</span><span class="s">bjobs -noheader -o </span><span class="sh">"</span><span class="s">jobid stat</span><span class="sh">"</span><span class="s"> {job_ids}</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">max_wait_s</span> <span class="o">=</span> <span class="n">opts</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">max_wait_s</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">max_wait_s</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">max_wait_s</span><span class="p">.</span><span class="nf">isdigit</span><span class="p">():</span>
            <span class="n">max_wait_s</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">max_wait_s</span><span class="p">)</span>

        <span class="c1"># 1) 제출
</span>        <span class="n">submitted_at</span> <span class="o">=</span> <span class="nf">iso_now</span><span class="p">()</span>
        <span class="n">job_ids</span><span class="p">,</span> <span class="n">submissions</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">submit_commands_multiline</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">cwd</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>

        <span class="c1"># 2) 상태 백엔드/캐시
</span>        <span class="n">cache_dir</span> <span class="o">=</span> <span class="nf">ensure_dir</span><span class="p">(</span><span class="nf">default_cache_dir</span><span class="p">())</span>
        <span class="n">cache_file</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">status_cache.json</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">status_cache</span> <span class="o">=</span> <span class="nc">SharedJSONCache</span><span class="p">(</span><span class="n">cache_file</span><span class="p">,</span> <span class="n">ttl_s</span><span class="o">=</span><span class="n">status_ttl_s</span><span class="p">)</span>
        <span class="n">backend</span> <span class="o">=</span> <span class="nc">LSFBjobsBackend</span><span class="p">(</span><span class="n">status_cmd_template</span><span class="o">=</span><span class="n">status_cmd_template</span><span class="p">)</span>

        <span class="c1"># 3) 완료까지 대기
</span>        <span class="n">final_statuses</span><span class="p">,</span> <span class="n">waited_sec</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">wait_until_done</span><span class="p">(</span>
            <span class="n">job_ids</span><span class="p">,</span> <span class="n">poll_interval_s</span><span class="p">,</span> <span class="n">status_cache</span><span class="p">,</span> <span class="n">backend</span><span class="p">,</span> <span class="n">max_wait_s</span><span class="o">=</span><span class="n">max_wait_s</span>
        <span class="p">)</span>

        <span class="n">completed_at</span> <span class="o">=</span> <span class="nf">iso_now</span><span class="p">()</span>
        <span class="n">all_done</span> <span class="o">=</span> <span class="nf">all</span><span class="p">((</span><span class="n">st</span> <span class="ow">in</span> <span class="n">TERMINAL_STATES</span><span class="p">)</span> <span class="ow">and</span> <span class="n">st</span> <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">final_statuses</span><span class="p">.</span><span class="nf">values</span><span class="p">())</span>

        <span class="c1"># 실패 제출 수집
</span>        <span class="n">failed_submissions</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">:</span> <span class="n">sub</span><span class="p">[</span><span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="n">sub</span><span class="p">[</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="n">sub</span><span class="p">[</span><span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="n">sub</span><span class="p">[</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">],</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">submissions</span>
            <span class="k">if</span> <span class="n">sub</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">sub</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="c1"># 4) 결과 요약/로그 파일 저장
</span>        <span class="n">session_tag</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="nf">utcnow</span><span class="p">().</span><span class="nf">strftime</span><span class="p">(</span><span class="sh">"</span><span class="s">%Y%m%d_%H%M%S</span><span class="sh">"</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="sh">"</span><span class="s">_</span><span class="si">{</span><span class="n">os</span><span class="p">.</span><span class="nf">getpid</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">results_dir</span> <span class="o">=</span> <span class="nf">ensure_dir</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">runs</span><span class="sh">"</span><span class="p">))</span>
        <span class="n">results_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">results_dir</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">result_</span><span class="si">{</span><span class="n">session_tag</span><span class="si">}</span><span class="s">.json</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">result_payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">submitted_at</span><span class="sh">"</span><span class="p">:</span> <span class="n">submitted_at</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">completed_at</span><span class="sh">"</span><span class="p">:</span> <span class="n">completed_at</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">duration_sec</span><span class="sh">"</span><span class="p">:</span> <span class="nf">round</span><span class="p">(</span><span class="n">waited_sec</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">:</span> <span class="n">job_ids</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">final_status</span><span class="sh">"</span><span class="p">:</span> <span class="n">final_statuses</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">all_done</span><span class="sh">"</span><span class="p">:</span> <span class="n">all_done</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">failed_submissions</span><span class="sh">"</span><span class="p">:</span> <span class="n">failed_submissions</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">cwd</span><span class="sh">"</span><span class="p">:</span> <span class="n">cwd</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">options</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">batch_size</span><span class="sh">"</span><span class="p">:</span> <span class="n">batch_size</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">poll_interval_s</span><span class="sh">"</span><span class="p">:</span> <span class="n">poll_interval_s</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">status_ttl_s</span><span class="sh">"</span><span class="p">:</span> <span class="n">status_ttl_s</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">status_cmd_template</span><span class="sh">"</span><span class="p">:</span> <span class="n">status_cmd_template</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">max_wait_s</span><span class="sh">"</span><span class="p">:</span> <span class="n">max_wait_s</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">results_file</span><span class="sh">"</span><span class="p">:</span> <span class="n">results_path</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">results_path</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">result_payload</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="c1"># 파일에 못 쓴다고 해도 반환은 계속
</span>            <span class="k">pass</span>

        <span class="n">job_ids_str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">job_ids</span><span class="p">)</span>
        <span class="n">results_json_str</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result_payload</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">job_ids_str</span><span class="p">,</span> <span class="n">results_json_str</span><span class="p">)</span>

<span class="c1"># ComfyUI 노드 등록
</span><span class="n">NODE_CLASS_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">LSFSubmitAndWait</span><span class="sh">"</span><span class="p">:</span> <span class="n">LSFSubmitAndWait</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">NODE_DISPLAY_NAME_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">LSFSubmitAndWait</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">LSF: Submit &amp; Wait</span><span class="sh">"</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h2 id="사용-팁--커스터마이즈">사용 팁 &amp; 커스터마이즈</h2>

<ul>
  <li>
    <p><strong>배치 크기 조절</strong> : 제출이 너무 몰리면 큐가 잠길 수 있으니 <code class="language-plaintext highlighter-rouge"># LSF: batch_size=4</code>처럼 적절히 제한하세요.</p>
  </li>
  <li>
    <p><strong>폴링/캐시</strong> : <code class="language-plaintext highlighter-rouge">poll_interval_s</code>는 폴링 주기, <code class="language-plaintext highlighter-rouge">status_ttl_s</code>는 캐시 TTL(초). 여러 노드가 돌더라도 <code class="language-plaintext highlighter-rouge">/tmp/comfyui_lsf_cache</code>(기본) 공유 캐시로 <code class="language-plaintext highlighter-rouge">bjobs</code> 호출 빈도를 크게 줄입니다. 경로는 <code class="language-plaintext highlighter-rouge">COMFYUI_LSF_CACHE_DIR</code> 환경변수로 바꿀 수 있어요.</p>
  </li>
  <li>
    <p><strong>상태 커맨드 교체</strong> : LSF 외 다른 시스템으로 바꾸고 싶다면 인라인에</p>
    <div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp"># LSF: status_cmd_template="bjobs -noheader -o \"jobid stat\" {job_ids}"</span>
</code></pre></div>    </div>
  </li>
</ul>

<p>처럼 명령 템플릿을 전달하세요. <code class="language-plaintext highlighter-rouge">{job_ids}</code> 플레이스홀더는 반드시 포함되어야 합니다.<br />
(예시) 커스텀 스크립트로 바꿀 때:<br />
<code class="language-plaintext highlighter-rouge"># LSF: status_cmd_template="/opt/cluster/bin/my_bjobs --format jobid,status {job_ids}"</code></p>

<ul>
  <li>
    <p><strong>타임아웃</strong> : 전체 대기 시간 제한이 필요하면 <code class="language-plaintext highlighter-rouge"># LSF: max_wait_s=7200</code> 처럼 넣으세요.</p>
  </li>
  <li>
    <p><strong>터미널 상태 확장</strong> : 필요하면 코드 상단의 <code class="language-plaintext highlighter-rouge">TERMINAL_STATES</code>를 편집(예: <code class="language-plaintext highlighter-rouge">{"DONE","EXIT","FINISHED"}</code>).</p>
  </li>
</ul>

<hr />

<h2 id="출력-포맷-제안">출력 포맷 제안</h2>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">job_ids</code> : <code class="language-plaintext highlighter-rouge">"123,124,125"</code></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">results_json</code> :</p>
    <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"submitted_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2025-10-10T00:00:00Z"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"completed_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2025-10-10T00:03:12Z"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"duration_sec"</span><span class="p">:</span><span class="w"> </span><span class="mf">192.4</span><span class="p">,</span><span class="w">
  </span><span class="nl">"job_ids"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"123"</span><span class="p">,</span><span class="s2">"124"</span><span class="p">,</span><span class="s2">"125"</span><span class="p">],</span><span class="w">
  </span><span class="nl">"final_status"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nl">"123"</span><span class="p">:</span><span class="s2">"DONE"</span><span class="p">,</span><span class="nl">"124"</span><span class="p">:</span><span class="s2">"DONE"</span><span class="p">,</span><span class="nl">"125"</span><span class="p">:</span><span class="s2">"EXIT"</span><span class="p">},</span><span class="w">
  </span><span class="nl">"all_done"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
  </span><span class="nl">"failed_submissions"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
  </span><span class="nl">"cwd"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/work/exp1"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"options"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">...</span><span class="p">},</span><span class="w">
  </span><span class="nl">"results_file"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/tmp/comfyui_lsf_cache/runs/result_20251010_000000_12345.json"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>    </div>
  </li>
</ul>

<p>필요하면 <code class="language-plaintext highlighter-rouge">status_cmd_template</code>를 SLURM 등으로 바꾸는 예시도 추가로 드릴게요. 원하는 추가 기능(예: 실패 시 재시도, 백오프, 개별 job 로그 추적) 있으면 말만 해줘요!</p>

<p class="chat--user">

개선 요청: 노드 자체도 async로 동작할 수 있음, 즉, 이와 동일한 다른 노드들이 있을 수 있고 그 노드들과도 cache를 공유해야 더욱 효율적일 것 같음.(bjobs할 때 job id를 제한하면 안 될 것 같고, bjobs -a 로 봐야할 것 같음) 이 때 추가 고려 사항: Node1이 만든 cache를 Node2가 참고할 수 있는데, 이 때 Node2에서 방금 bsub한 job id는 cache에 없을 수도 있음(TTL이 안돼서). 이 코너 케이스도 고려할 것

</p>

<p>좋은 포인트! 요구하신 “다중 노드 동시 동작 + 전역 캐시 공유 + <code class="language-plaintext highlighter-rouge">bjobs -a</code> 기반 전체 스냅샷”으로 구조를 업그레이드했습니다. 특히 <strong>Node2가 방금 제출한 잡이 캐시에 아직 없을 수 있는 코너 케이스</strong> 를 해결하기 위해, <strong>제출 직후 캐시에<code class="language-plaintext highlighter-rouge">SUBMITTED</code> 상태로 시드(seeding)</strong> 하고, 상태 캐시는 <strong>‘전체 목록’(bjobs -a) 스냅샷</strong> 을 TTL/락 기반으로 갱신하도록 바꿨습니다.</p>

<p>아래는 변경 요약 → 바로 쓸 수 있는 전체 코드 순서로 드립니다.</p>

<hr />

<h1 id="변경설계-포인트-step-by-step">변경/설계 포인트 (step-by-step)</h1>

<ol>
  <li>
    <p><strong>폴링 백엔드 전면 개편</strong></p>

    <ul>
      <li>
        <p>기존: <code class="language-plaintext highlighter-rouge">bjobs {job_ids}</code> 특정 잡만 조회</p>
      </li>
      <li>
        <p>변경: <strong>기본값을<code class="language-plaintext highlighter-rouge">bjobs -a -noheader -o "jobid stat"</code>로 전체 조회</strong>→ 한 번의 호출로 모든 잡 상태를 받아 전역 캐시에 저장.</p>
      </li>
      <li>
        <p>템플릿은 <code class="language-plaintext highlighter-rouge">full_status_cmd_template</code>로 교체(여전히 옵션으로 바꿀 수 있음).</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>전역 공유 캐시(파일) 구조 개선</strong></p>

    <ul>
      <li>단일 파일에 전체 스냅샷 보관:
        <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"jobs"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"123"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nl">"status"</span><span class="p">:</span><span class="s2">"PEND"</span><span class="p">,</span><span class="nl">"ts"</span><span class="p">:</span><span class="mi">169</span><span class="err">...</span><span class="p">},</span><span class="w"> </span><span class="err">...</span><span class="w"> </span><span class="p">},</span><span class="w">
  </span><span class="nl">"last_full_refresh_ts"</span><span class="p">:</span><span class="w"> </span><span class="mi">169</span><span class="err">...</span><span class="p">,</span><span class="w">
  </span><span class="nl">"meta"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">...</span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>        </div>
      </li>
      <li>
        <p><strong>TTL(<code class="language-plaintext highlighter-rouge">full_ttl_s</code>)</strong> + <strong>최소 리프레시 간격(<code class="language-plaintext highlighter-rouge">min_refresh_gap_s</code>)</strong> + <strong>락 파일(가능 시 fcntl)</strong> 로 <strong>-a 호출 폭주 방지</strong>.</p>
      </li>
      <li>다중 노드가 동시에 접근해도 <strong>읽기/쓰기 잠금</strong> 적용.</li>
    </ul>
  </li>
  <li>
    <p><strong>코너 케이스 처리(방금 제출한 잡 미반영)</strong></p>

    <ul>
      <li>
        <p><strong>제출 직후</strong> 해당 잡들을 <strong>캐시에 ‘SUBMITTED’</strong> 상태로 <strong>시드(seeding)</strong> → 다른 노드도 즉시 이 JobID를 “알고” 있어서 불필요한 강제 리프레시가 줄어듦.</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">get_statuses()</code>에서 <strong>요청한 JobID가 캐시에 없거나 오래되면</strong> ,</p>

        <ul>
          <li>
            <p>TTL 만료이거나 <code class="language-plaintext highlighter-rouge">force_refresh_on_miss=True</code>이고 <code class="language-plaintext highlighter-rouge">min_refresh_gap_s</code> 이상 경과 시 <strong>한 노드만</strong> <code class="language-plaintext highlighter-rouge">-a</code>를 실행해 <strong>새 스냅샷</strong> 작성(락으로 단일화).</p>
          </li>
          <li>
            <p>그 외에는 다음 폴링 주기에 자연스럽게 반영.</p>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>완전한 async 지원 + 다중 제출 제어</strong></p>

    <ul>
      <li>
        <p>노드 자체는 <code class="language-plaintext highlighter-rouge">SUPPORTS_ASYNC = True</code>, 비동기 제출/대기.</p>
      </li>
      <li>
        <p>멀티라인 <code class="language-plaintext highlighter-rouge">bsub</code>를 <strong>배치 크기 제한(<code class="language-plaintext highlighter-rouge">batch_size</code>)</strong>으로 병렬 제출.</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>출력/로그</strong></p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">job_ids</code>(콤마 문자열), <code class="language-plaintext highlighter-rouge">results_json</code>(요약 JSON).</p>
      </li>
      <li>
        <p>실행 결과는 <code class="language-plaintext highlighter-rouge">/tmp/comfyui_lsf_cache/runs/result_*.json</code>에도 저장.</p>
      </li>
    </ul>
  </li>
</ol>

<hr />

<h1 id="코드-교체추가-없이-그대로-사용">코드 (교체/추가 없이 그대로 사용)</h1>

<p><code class="language-plaintext highlighter-rouge">ComfyUI/custom_nodes/lsf_submit_and_wait.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">re</span>
<span class="kn">import</span> <span class="n">shlex</span>
<span class="kn">import</span> <span class="n">tempfile</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="c1"># fcntl (POSIX) 잠금: Windows에선 graceful degrade
</span><span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">fcntl</span>  <span class="c1"># type: ignore
</span><span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">fcntl</span> <span class="o">=</span> <span class="bp">None</span>

<span class="c1"># ---------- 상수/유틸 ----------
</span>
<span class="n">JOB_ID_REGEX</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">Job\s*&lt;(\d+)&gt;</span><span class="sh">"</span><span class="p">,</span> <span class="n">re</span><span class="p">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
<span class="n">TERMINAL_STATES</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">DONE</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">EXIT</span><span class="sh">"</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">iso_now</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">datetime</span><span class="p">.</span><span class="nf">utcnow</span><span class="p">().</span><span class="nf">isoformat</span><span class="p">(</span><span class="n">timespec</span><span class="o">=</span><span class="sh">"</span><span class="s">seconds</span><span class="sh">"</span><span class="p">)</span> <span class="o">+</span> <span class="sh">"</span><span class="s">Z</span><span class="sh">"</span>

<span class="k">def</span> <span class="nf">default_cache_dir</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span>
        <span class="sh">"</span><span class="s">COMFYUI_LSF_CACHE_DIR</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">tempfile</span><span class="p">.</span><span class="nf">gettempdir</span><span class="p">(),</span> <span class="sh">"</span><span class="s">comfyui_lsf_cache</span><span class="sh">"</span><span class="p">)</span>
    <span class="p">)</span>

<span class="k">def</span> <span class="nf">ensure_dir</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">d</span>

<span class="k">def</span> <span class="nf">parse_inline_options_and_commands</span><span class="p">(</span><span class="n">commands_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    첫 줄(들)에 </span><span class="sh">'</span><span class="s"># LSF: key=value key=value ...</span><span class="sh">'</span><span class="s"> 형식의 인라인 옵션을 허용.
    반환: (options_dict, command_lines)
    </span><span class="sh">"""</span>
    <span class="n">options</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">ln</span> <span class="k">for</span> <span class="n">ln</span> <span class="ow">in</span> <span class="n">commands_text</span><span class="p">.</span><span class="nf">splitlines</span><span class="p">()]</span>
    <span class="n">clean_lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ln</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">^\s*#\s*LSF:\s*(.+)$</span><span class="sh">"</span><span class="p">,</span> <span class="n">ln</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
            <span class="n">kvs</span> <span class="o">=</span> <span class="n">shlex</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">posix</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">kv</span> <span class="ow">in</span> <span class="n">kvs</span><span class="p">:</span>
                <span class="k">if</span> <span class="sh">"</span><span class="s">=</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">kv</span><span class="p">:</span>
                    <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">kv</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">=</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">v</span><span class="p">.</span><span class="nf">isdigit</span><span class="p">():</span>
                        <span class="n">v</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">v</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">false</span><span class="sh">"</span><span class="p">):</span>
                            <span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="o">==</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">)</span>
                    <span class="n">options</span><span class="p">[</span><span class="n">k</span><span class="p">.</span><span class="nf">strip</span><span class="p">()]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">continue</span>
        <span class="n">clean_lines</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">ln</span><span class="p">)</span>
    <span class="n">clean_lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">ln</span> <span class="k">for</span> <span class="n">ln</span> <span class="ow">in</span> <span class="n">clean_lines</span> <span class="k">if</span> <span class="n">ln</span><span class="p">.</span><span class="nf">strip</span><span class="p">()]</span>
    <span class="k">return</span> <span class="n">options</span><span class="p">,</span> <span class="n">clean_lines</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_shell</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">cwd</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
    <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_shell</span><span class="p">(</span>
        <span class="n">cmd</span><span class="p">,</span>
        <span class="n">cwd</span><span class="o">=</span><span class="n">cwd</span> <span class="k">if</span> <span class="n">cwd</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
        <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">out_b</span><span class="p">,</span> <span class="n">err_b</span> <span class="o">=</span> <span class="k">await</span> <span class="n">proc</span><span class="p">.</span><span class="nf">communicate</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">proc</span><span class="p">.</span><span class="n">returncode</span><span class="p">,</span> <span class="n">out_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">ignore</span><span class="sh">"</span><span class="p">),</span> <span class="n">err_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">ignore</span><span class="sh">"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">extract_job_ids_from_bsub_output</span><span class="p">(</span><span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="c1"># LSF 표준: "Job &lt;12345&gt; is submitted to queue &lt;...&gt;."
</span>    <span class="k">return</span> <span class="n">JOB_ID_REGEX</span><span class="p">.</span><span class="nf">findall</span><span class="p">(</span><span class="n">stdout</span><span class="p">)</span>

<span class="c1"># ---------- 상태 백엔드 (전체 스냅샷) ----------
</span>
<span class="k">class</span> <span class="nc">StatusBackend</span><span class="p">:</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">query_full</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="nb">NotImplementedError</span>

<span class="k">class</span> <span class="nc">LSFBjobsFullBackend</span><span class="p">(</span><span class="n">StatusBackend</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    전체 스냅샷 기반 백엔드.
    full_status_cmd_template 기본값:
      </span><span class="sh">'</span><span class="s">bjobs -a -noheader -o </span><span class="sh">"</span><span class="s">jobid stat</span><span class="sh">"'</span><span class="s">
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">full_status_cmd_template</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">full_status_cmd_template</span><span class="p">:</span>
            <span class="n">full_status_cmd_template</span> <span class="o">=</span> <span class="sh">'</span><span class="s">bjobs -a -noheader -o </span><span class="sh">"</span><span class="s">jobid stat</span><span class="sh">"'</span>
        <span class="n">self</span><span class="p">.</span><span class="n">template</span> <span class="o">=</span> <span class="n">full_status_cmd_template</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">query_full</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="n">rc</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">run_shell</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">template</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># 기대 포맷: "&lt;jobid&gt; &lt;state&gt;"
</span>        <span class="k">for</span> <span class="n">ln</span> <span class="ow">in</span> <span class="n">out</span><span class="p">.</span><span class="nf">splitlines</span><span class="p">():</span>
            <span class="n">ln</span> <span class="o">=</span> <span class="n">ln</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ln</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">ln</span><span class="p">.</span><span class="nf">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">parts</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">jid</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nf">upper</span><span class="p">()</span>
            <span class="n">result</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span>
        <span class="k">return</span> <span class="n">result</span>

<span class="c1"># ---------- 전역 공유 캐시 (전체 목록 + TTL + 락) ----------
</span>
<span class="k">class</span> <span class="nc">FullListSharedCache</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    파일 하나에 전체 job 상태 스냅샷을 저장/공유.
    구조:
    {
      </span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="s">: { job_id: {</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="s">: epoch}, ... },
      </span><span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="s">: epoch,
      </span><span class="sh">"</span><span class="s">meta</span><span class="sh">"</span><span class="s">: { </span><span class="sh">"</span><span class="s">source</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="s">, ... }
    }
    정책:
      - full_ttl_s: 전체 스냅샷 TTL
      - min_refresh_gap_s: -a 재실행 최소 간격
      - force_refresh_on_miss: 필요한 job_id가 없으면 TTL 무시하고(단 최소 간격은 존중) 조기 갱신 시도
      - SUBMITTED 시드: 제출 직후 캐시에 넣어 코너 케이스 완화
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cache_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">full_ttl_s</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
                 <span class="n">min_refresh_gap_s</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
                 <span class="n">force_refresh_on_miss</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cache_file</span> <span class="o">=</span> <span class="n">cache_file</span>
        <span class="n">self</span><span class="p">.</span><span class="n">full_ttl_s</span> <span class="o">=</span> <span class="n">full_ttl_s</span>
        <span class="n">self</span><span class="p">.</span><span class="n">min_refresh_gap_s</span> <span class="o">=</span> <span class="n">min_refresh_gap_s</span>
        <span class="n">self</span><span class="p">.</span><span class="n">force_refresh_on_miss</span> <span class="o">=</span> <span class="n">force_refresh_on_miss</span>
        <span class="nf">ensure_dir</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">cache_file</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">cache_file</span><span class="p">):</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">cache_file</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">({</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">:</span> <span class="p">{},</span> <span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="sh">"</span><span class="s">meta</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}},</span> <span class="n">f</span><span class="p">)</span>

    <span class="c1"># ---- 락 유틸 ----
</span>    <span class="k">def</span> <span class="nf">_lock_fd</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">nonblock</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
        <span class="n">fh</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">a+</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fcntl</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fcntl</span><span class="p">.</span><span class="nf">flock</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">fcntl</span><span class="p">.</span><span class="n">LOCK_EX</span> <span class="o">|</span> <span class="p">(</span><span class="n">fcntl</span><span class="p">.</span><span class="n">LOCK_NB</span> <span class="k">if</span> <span class="n">nonblock</span> <span class="k">else</span> <span class="mi">0</span><span class="p">))</span>
            <span class="k">except</span> <span class="nb">BlockingIOError</span><span class="p">:</span>
                <span class="n">fh</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
                <span class="k">return</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="n">fh</span>

    <span class="k">def</span> <span class="nf">_unlock_fd</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">fh</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">fcntl</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fcntl</span><span class="p">.</span><span class="nf">flock</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">fcntl</span><span class="p">.</span><span class="n">LOCK_UN</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fh</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_read_cache</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cache_file</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">:</span> <span class="p">{},</span> <span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="sh">"</span><span class="s">meta</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}}</span>

    <span class="k">def</span> <span class="nf">_write_cache</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">cache_file</span> <span class="o">+</span> <span class="sh">"</span><span class="s">.tmp</span><span class="sh">"</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">cache_file</span><span class="p">)</span>

    <span class="c1"># ---- 공개 API ----
</span>    <span class="k">def</span> <span class="nf">seed_submitted</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">job_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
        <span class="sh">"""</span><span class="s">제출 직후 SUBMITTED 상태로 캐시에 시드(코너 케이스 완화).</span><span class="sh">"""</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="c1"># 쓰기 락
</span>        <span class="n">fh</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_lock_fd</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cache_file</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_cache</span><span class="p">()</span>
            <span class="n">jobs</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">:</span>
                <span class="c1"># 이미 있으면 건드리지 않음(경쟁 상태에서 더 최신 값 보호)
</span>                <span class="k">if</span> <span class="n">jid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">:</span>
                    <span class="n">jobs</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">SUBMITTED</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">now</span><span class="p">}</span>
            <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">jobs</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_write_cache</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_unlock_fd</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">maybe_refresh_full</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">backend</span><span class="p">:</span> <span class="n">StatusBackend</span><span class="p">,</span> <span class="n">reason</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">
        - TTL 또는 miss 사유로 전체 스냅샷을 갱신할지 판단/실행
        - 동시성: refresh 락 파일을 non-blocking으로 획득한 단 하나의 프로세스만 실제로 -a 실행
        </span><span class="sh">"""</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_cache</span><span class="p">()</span>
        <span class="n">last_ts</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="c1"># 최소 간격 체크
</span>        <span class="nf">if </span><span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">last_ts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nf">float</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">min_refresh_gap_s</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="c1"># refresh 락(별도 파일) 획득 시도(실패하면 다른 노드가 수행 중)
</span>        <span class="n">lock_path</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">cache_file</span> <span class="o">+</span> <span class="sh">"</span><span class="s">.refresh.lock</span><span class="sh">"</span>
        <span class="n">lock_fh</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_lock_fd</span><span class="p">(</span><span class="n">lock_path</span><span class="p">,</span> <span class="n">nonblock</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lock_fh</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># 한 번 더 최신화 검사(경쟁 회피)
</span>            <span class="n">data2</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_cache</span><span class="p">()</span>
            <span class="n">last_ts2</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">data2</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="nf">if </span><span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">last_ts2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nf">float</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">min_refresh_gap_s</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">False</span>

            <span class="c1"># 실제 -a 실행
</span>            <span class="n">snapshot</span> <span class="o">=</span> <span class="k">await</span> <span class="n">backend</span><span class="p">.</span><span class="nf">query_full</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">snapshot</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>  <span class="c1"># 실패 시 그대로 유지
</span>
            <span class="n">now2</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
            <span class="c1"># 쓰기 락(캐시 파일)
</span>            <span class="n">fh</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_lock_fd</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cache_file</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">base</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_cache</span><span class="p">()</span>
                <span class="n">jobs</span> <span class="o">=</span> <span class="n">base</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                <span class="c1"># 새 스냅샷 반영
</span>                <span class="n">ts</span> <span class="o">=</span> <span class="n">now2</span>
                <span class="k">for</span> <span class="n">jid</span><span class="p">,</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">snapshot</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
                    <span class="n">jobs</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">:</span> <span class="n">st</span><span class="p">,</span> <span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">ts</span><span class="p">}</span>
                <span class="n">base</span><span class="p">[</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">jobs</span>
                <span class="n">base</span><span class="p">[</span><span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">now2</span>
                <span class="n">meta</span> <span class="o">=</span> <span class="n">base</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">meta</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">meta</span><span class="p">[</span><span class="sh">"</span><span class="s">reason</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">reason</span>
                <span class="n">meta</span><span class="p">[</span><span class="sh">"</span><span class="s">refreshed_at</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">iso_now</span><span class="p">()</span>
                <span class="n">base</span><span class="p">[</span><span class="sh">"</span><span class="s">meta</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">meta</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_write_cache</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_unlock_fd</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_unlock_fd</span><span class="p">(</span><span class="n">lock_fh</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_statuses</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">job_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">backend</span><span class="p">:</span> <span class="n">StatusBackend</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">
        - 캐시에서 먼저 조회
        - 필요 시 maybe_refresh_full()을 통해 -a 스냅샷 갱신
        - 최종적으로 요청 job_ids에 대한 상태 dict 반환(없으면 </span><span class="sh">""</span><span class="s">)
        </span><span class="sh">"""</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_cache</span><span class="p">()</span>
        <span class="n">jobs</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">last_ts</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">_fresh</span><span class="p">(</span><span class="n">jid</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="n">ent</span> <span class="o">=</span> <span class="n">jobs</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ent</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
            <span class="c1"># 엔트리가 SUBMITTED 라도 '신선한' 것으로 취급(바로 직전 제출 케이스 완화)
</span>            <span class="n">age</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="nf">float</span><span class="p">(</span><span class="n">ent</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">age</span> <span class="o">&lt;=</span> <span class="nf">float</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">full_ttl_s</span><span class="p">)</span>

        <span class="n">need_refresh</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="c1"># 1) TTL 만료 또는 miss 여부 판단
</span>        <span class="nf">if </span><span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">last_ts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nf">float</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">full_ttl_s</span><span class="p">):</span>
            <span class="n">need_refresh</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="c1"># miss 검사: 요청한 job이 캐시에 없거나 stale
</span>        <span class="n">miss</span> <span class="o">=</span> <span class="p">[</span><span class="n">jid</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span> <span class="k">if</span> <span class="ow">not</span> <span class="nf">_fresh</span><span class="p">(</span><span class="n">jid</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">miss</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="n">force_refresh_on_miss</span><span class="p">:</span>
            <span class="n">need_refresh</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="c1"># 2) 필요 시 전체 리프레시 시도(한 프로세스만 실행)
</span>        <span class="k">if</span> <span class="n">need_refresh</span><span class="p">:</span>
            <span class="n">reason</span> <span class="o">=</span> <span class="sh">"</span><span class="s">ttl_expired</span><span class="sh">"</span> <span class="nf">if </span><span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">last_ts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nf">float</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">full_ttl_s</span><span class="p">)</span> <span class="k">else</span> <span class="sh">"</span><span class="s">miss</span><span class="sh">"</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">maybe_refresh_full</span><span class="p">(</span><span class="n">backend</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="n">reason</span><span class="p">)</span>
            <span class="c1"># 갱신 후 최신 데이터 재로딩
</span>            <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_cache</span><span class="p">()</span>
            <span class="n">jobs</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>

        <span class="c1"># 3) 결과 구성
</span>        <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">:</span>
            <span class="n">ent</span> <span class="o">=</span> <span class="n">jobs</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ent</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="k">if</span> <span class="n">ent</span> <span class="k">else</span> <span class="sh">""</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>

<span class="c1"># ---------- 제출 &amp; 대기 ----------
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">submit_commands_multiline</span><span class="p">(</span><span class="n">commands</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">cwd</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    각 라인을 독립 커맨드로 제출. bsub 출력에서 Job ID 추출.
    동시 제출 개수를 batch_size로 제한.
    </span><span class="sh">"""</span>
    <span class="n">sem</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Semaphore</span><span class="p">(</span><span class="nf">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nf">int</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)))</span>
    <span class="n">submissions</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_submit_one</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">sem</span><span class="p">:</span>
            <span class="n">rc</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">run_shell</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">cwd</span><span class="p">)</span>
            <span class="n">jids</span> <span class="o">=</span> <span class="nf">extract_job_ids_from_bsub_output</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">:</span> <span class="n">cmd</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="n">rc</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="n">out</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="n">err</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">:</span> <span class="n">jids</span><span class="p">,</span>
            <span class="p">}</span>

    <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">_submit_one</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">commands</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">as_completed</span><span class="p">(</span><span class="n">tasks</span><span class="p">):</span>
        <span class="n">submissions</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="k">await</span> <span class="n">t</span><span class="p">)</span>
    <span class="n">job_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">jid</span> <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">submissions</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">sub</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])]</span>
    <span class="k">return</span> <span class="n">job_ids</span><span class="p">,</span> <span class="n">submissions</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">wait_until_done</span><span class="p">(</span><span class="n">job_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                          <span class="n">poll_interval_s</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                          <span class="n">full_cache</span><span class="p">:</span> <span class="n">FullListSharedCache</span><span class="p">,</span>
                          <span class="n">backend</span><span class="p">:</span> <span class="n">StatusBackend</span><span class="p">,</span>
                          <span class="n">max_wait_s</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
    <span class="n">final</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">statuses</span> <span class="o">=</span> <span class="k">await</span> <span class="n">full_cache</span><span class="p">.</span><span class="nf">get_statuses</span><span class="p">(</span><span class="n">job_ids</span><span class="p">,</span> <span class="n">backend</span><span class="p">)</span>
        <span class="n">final</span> <span class="o">=</span> <span class="p">{</span><span class="n">jid</span><span class="p">:</span> <span class="n">statuses</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">}</span>
        <span class="k">if</span> <span class="nf">all</span><span class="p">((</span><span class="n">st</span> <span class="ow">in</span> <span class="n">TERMINAL_STATES</span><span class="p">)</span> <span class="ow">and</span> <span class="n">st</span> <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">final</span><span class="p">.</span><span class="nf">values</span><span class="p">()):</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="n">max_wait_s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">max_wait_s</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="nf">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nf">int</span><span class="p">(</span><span class="n">poll_interval_s</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">final</span><span class="p">,</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>

<span class="c1"># ---------- ComfyUI 노드 ----------
</span>
<span class="k">class</span> <span class="nc">LSFSubmitAndWait</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    입력:
      - commands (STRING, multiline): 여러 줄 bsub 커맨드
        * 인라인 옵션: </span><span class="sh">'</span><span class="s"># LSF: batch_size=4 poll_interval_s=10 full_ttl_s=15
                         full_status_cmd_template=</span><span class="sh">"</span><span class="s">bjobs -a -noheader -o </span><span class="se">\"</span><span class="s">jobid stat</span><span class="se">\"</span><span class="sh">"</span><span class="s">
                         min_refresh_gap_s=5 force_refresh_on_miss=true max_wait_s=7200</span><span class="sh">'</span><span class="s">
      - cwd (STRING): 실행 디렉토리

    출력(OUTPUT 노드):
      - job_ids (STRING): 콤마 구분 목록
      - results_json (STRING): 요약 JSON 문자열
    </span><span class="sh">"""</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">LSF</span><span class="sh">"</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">run</span><span class="sh">"</span>
    <span class="n">OUTPUT_NODE</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">SUPPORTS_ASYNC</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">results_json</span><span class="sh">"</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">commands</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">bsub -q short sleep 3</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">cwd</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">}),</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">commands</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">cwd</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="c1"># 0) 인라인 옵션/명령 파싱
</span>        <span class="n">opts</span><span class="p">,</span> <span class="n">lines</span> <span class="o">=</span> <span class="nf">parse_inline_options_and_commands</span><span class="p">(</span><span class="n">commands</span><span class="p">)</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">opts</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">batch_size</span><span class="sh">"</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
        <span class="n">poll_interval_s</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">opts</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">poll_interval_s</span><span class="sh">"</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
        <span class="c1"># backward compat: status_ttl_s -&gt; full_ttl_s
</span>        <span class="n">full_ttl_s</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">opts</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">full_ttl_s</span><span class="sh">"</span><span class="p">,</span> <span class="n">opts</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">status_ttl_s</span><span class="sh">"</span><span class="p">,</span> <span class="mi">10</span><span class="p">)))</span>
        <span class="n">min_refresh_gap_s</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">opts</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">min_refresh_gap_s</span><span class="sh">"</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        <span class="n">force_refresh_on_miss</span> <span class="o">=</span> <span class="nf">bool</span><span class="p">(</span><span class="n">opts</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">force_refresh_on_miss</span><span class="sh">"</span><span class="p">,</span> <span class="bp">True</span><span class="p">))</span>
        <span class="n">full_status_cmd_template</span> <span class="o">=</span> <span class="n">opts</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">full_status_cmd_template</span><span class="sh">"</span><span class="p">,</span>
                                            <span class="sh">'</span><span class="s">bjobs -a -noheader -o </span><span class="sh">"</span><span class="s">jobid stat</span><span class="sh">"'</span><span class="p">)</span>
        <span class="n">max_wait_s</span> <span class="o">=</span> <span class="n">opts</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">max_wait_s</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">max_wait_s</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">max_wait_s</span><span class="p">.</span><span class="nf">isdigit</span><span class="p">():</span>
            <span class="n">max_wait_s</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">max_wait_s</span><span class="p">)</span>

        <span class="c1"># 1) 제출
</span>        <span class="n">submitted_at</span> <span class="o">=</span> <span class="nf">iso_now</span><span class="p">()</span>
        <span class="n">job_ids</span><span class="p">,</span> <span class="n">submissions</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">submit_commands_multiline</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">cwd</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>

        <span class="c1"># 2) 전역 캐시/백엔드
</span>        <span class="n">cache_dir</span> <span class="o">=</span> <span class="nf">ensure_dir</span><span class="p">(</span><span class="nf">default_cache_dir</span><span class="p">())</span>
        <span class="n">cache_file</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">status_full_cache.json</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">full_cache</span> <span class="o">=</span> <span class="nc">FullListSharedCache</span><span class="p">(</span>
            <span class="n">cache_file</span><span class="p">,</span>
            <span class="n">full_ttl_s</span><span class="o">=</span><span class="n">full_ttl_s</span><span class="p">,</span>
            <span class="n">min_refresh_gap_s</span><span class="o">=</span><span class="n">min_refresh_gap_s</span><span class="p">,</span>
            <span class="n">force_refresh_on_miss</span><span class="o">=</span><span class="n">force_refresh_on_miss</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">backend</span> <span class="o">=</span> <span class="nc">LSFBjobsFullBackend</span><span class="p">(</span><span class="n">full_status_cmd_template</span><span class="o">=</span><span class="n">full_status_cmd_template</span><span class="p">)</span>

        <span class="c1"># 2-1) 코너 케이스 완화: 방금 제출한 잡을 캐시에 시드
</span>        <span class="k">if</span> <span class="n">job_ids</span><span class="p">:</span>
            <span class="n">full_cache</span><span class="p">.</span><span class="nf">seed_submitted</span><span class="p">(</span><span class="n">job_ids</span><span class="p">)</span>

        <span class="c1"># 3) 완료까지 대기
</span>        <span class="n">final_statuses</span><span class="p">,</span> <span class="n">waited_sec</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">wait_until_done</span><span class="p">(</span>
            <span class="n">job_ids</span><span class="p">,</span> <span class="n">poll_interval_s</span><span class="p">,</span> <span class="n">full_cache</span><span class="p">,</span> <span class="n">backend</span><span class="p">,</span> <span class="n">max_wait_s</span><span class="o">=</span><span class="n">max_wait_s</span>
        <span class="p">)</span>

        <span class="n">completed_at</span> <span class="o">=</span> <span class="nf">iso_now</span><span class="p">()</span>
        <span class="n">all_done</span> <span class="o">=</span> <span class="nf">all</span><span class="p">((</span><span class="n">st</span> <span class="ow">in</span> <span class="n">TERMINAL_STATES</span><span class="p">)</span> <span class="ow">and</span> <span class="n">st</span> <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">final_statuses</span><span class="p">.</span><span class="nf">values</span><span class="p">())</span>

        <span class="n">failed_submissions</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">:</span> <span class="n">sub</span><span class="p">[</span><span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="n">sub</span><span class="p">[</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="n">sub</span><span class="p">[</span><span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="n">sub</span><span class="p">[</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">],</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">submissions</span>
            <span class="k">if</span> <span class="n">sub</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">sub</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="c1"># 4) 결과 파일 저장
</span>        <span class="n">session_tag</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="nf">utcnow</span><span class="p">().</span><span class="nf">strftime</span><span class="p">(</span><span class="sh">"</span><span class="s">%Y%m%d_%H%M%S</span><span class="sh">"</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="sh">"</span><span class="s">_</span><span class="si">{</span><span class="n">os</span><span class="p">.</span><span class="nf">getpid</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">results_dir</span> <span class="o">=</span> <span class="nf">ensure_dir</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">runs</span><span class="sh">"</span><span class="p">))</span>
        <span class="n">results_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">results_dir</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">result_</span><span class="si">{</span><span class="n">session_tag</span><span class="si">}</span><span class="s">.json</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">result_payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">submitted_at</span><span class="sh">"</span><span class="p">:</span> <span class="n">submitted_at</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">completed_at</span><span class="sh">"</span><span class="p">:</span> <span class="n">completed_at</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">duration_sec</span><span class="sh">"</span><span class="p">:</span> <span class="nf">round</span><span class="p">(</span><span class="n">waited_sec</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">:</span> <span class="n">job_ids</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">final_status</span><span class="sh">"</span><span class="p">:</span> <span class="n">final_statuses</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">all_done</span><span class="sh">"</span><span class="p">:</span> <span class="n">all_done</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">failed_submissions</span><span class="sh">"</span><span class="p">:</span> <span class="n">failed_submissions</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">cwd</span><span class="sh">"</span><span class="p">:</span> <span class="n">cwd</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">options</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">batch_size</span><span class="sh">"</span><span class="p">:</span> <span class="n">batch_size</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">poll_interval_s</span><span class="sh">"</span><span class="p">:</span> <span class="n">poll_interval_s</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">full_ttl_s</span><span class="sh">"</span><span class="p">:</span> <span class="n">full_ttl_s</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">min_refresh_gap_s</span><span class="sh">"</span><span class="p">:</span> <span class="n">min_refresh_gap_s</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">force_refresh_on_miss</span><span class="sh">"</span><span class="p">:</span> <span class="n">force_refresh_on_miss</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">full_status_cmd_template</span><span class="sh">"</span><span class="p">:</span> <span class="n">full_status_cmd_template</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">max_wait_s</span><span class="sh">"</span><span class="p">:</span> <span class="n">max_wait_s</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">results_file</span><span class="sh">"</span><span class="p">:</span> <span class="n">results_path</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">results_path</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">result_payload</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="n">job_ids_str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">job_ids</span><span class="p">)</span>
        <span class="n">results_json_str</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result_payload</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">job_ids_str</span><span class="p">,</span> <span class="n">results_json_str</span><span class="p">)</span>

<span class="c1"># ComfyUI 노드 등록
</span><span class="n">NODE_CLASS_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">LSFSubmitAndWait</span><span class="sh">"</span><span class="p">:</span> <span class="n">LSFSubmitAndWait</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">NODE_DISPLAY_NAME_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">LSFSubmitAndWait</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">LSF: Submit &amp; Wait</span><span class="sh">"</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h2 id="사용-방법옵션-예시">사용 방법/옵션 예시</h2>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vbnet

# LSF: batch_size=4 poll_interval_s=10 full_ttl_s=15 min_refresh_gap_s=5 force_refresh_on_miss=true
# LSF: full_status_cmd_template="bjobs -a -noheader -o \"jobid stat\""
bsub -q short -J test1 sleep 5
bsub -q short -J test2 sleep 8
bsub -q short -J test3 sleep 2
</code></pre></div></div>

<ul>
  <li>
    <p><strong>full_ttl_s</strong> : 전체 스냅샷의 TTL.</p>
  </li>
  <li>
    <p><strong>min_refresh_gap_s</strong> : <code class="language-plaintext highlighter-rouge">-a</code> 재호출 최소 간격(모든 노드 공통).</p>
  </li>
  <li>
    <p><strong>force_refresh_on_miss</strong> : 요청 Job이 캐시에 없을 때 TTL 관계없이 조기 갱신 시도(단 최소 간격은 지킴).</p>
  </li>
  <li>
    <p><strong>full_status_cmd_template</strong> : 다른 시스템/형식으로 교체 가능(예: 커스텀 스크립트).</p>
  </li>
</ul>

<hr />

<h2 id="코너-케이스가-해결되는-흐름요약">코너 케이스가 해결되는 흐름(요약)</h2>

<ol>
  <li>
    <p>Node1·Node2가 각각 잡 제출 → <strong>각자 제출 직후 캐시에 SUBMITTED로 시드</strong>.</p>
  </li>
  <li>
    <p>폴링 시, <strong>요청한 JobID가 캐시에 이미 존재</strong> → <code class="language-plaintext highlighter-rouge">SUBMITTED</code>라도 <strong>신선</strong> 으로 간주되어 불필요한 조기 <code class="language-plaintext highlighter-rouge">-a</code> 호출 방지.</p>
  </li>
  <li>
    <p>TTL 만료 또는 miss+최소 간격 충족 시, <strong>한 노드만</strong> <code class="language-plaintext highlighter-rouge">-a</code> 실행(락) → 전체 스냅샷 업데이트.</p>
  </li>
  <li>
    <p>모든 노드는 <strong>같은 캐시 파일</strong> 을 보며 효율적으로 상태 동기화.</p>
  </li>
</ol>

<hr />

<p>원하시면:</p>

<ul>
  <li>
    <p><strong>지수 백오프/폴링 주기 자동 튜닝</strong> ,</p>
  </li>
  <li>
    <p><strong>추가 상태 매핑(예: ZOMBI/PSUSP 등)</strong> ,</p>
  </li>
  <li>
    <p><strong>SLURM 등 다른 스케줄러 템플릿</strong> 도 바로 붙여드릴게요.</p>
  </li>
</ul>

<p class="chat--user">

질문 1. 파일 read access를 계속하는거야? 그렇다면 대신에 singleton으로 된 cache 클래스에 저장된 정보를 사용하는 건 어때? 질문 2. job id | 커맨드 | job 상태 | 를 노드에 계속 업데이트하며 보여줄 순 없나? 좀 고급 기능 같기는한데 되면 참 좋을듯

</p>

<p>좋은 질문! 핵심만 “실무적으로” 정리하고, 바로 쓸 수 있는 코드 조각(추가/패치용)도 드릴게요.</p>

<hr />

<h1 id="q1-파일-read-access를-계속하나요--대신-프로세스-내-싱글톤-캐시-쓰면-어때요">Q1. “파일 read access를 계속하나요? → 대신 프로세스 내 싱글톤 캐시 쓰면 어때요?”</h1>

<h2 id="결론-step-by-step">결론 (step-by-step)</h2>

<ol>
  <li>
    <p><strong>맞아요.</strong> 전역 공유를 위해 파일 캐시를 쓰면 여러 노드에서 읽기/쓰기 경쟁이 생깁니다.</p>
  </li>
  <li>
    <p><strong>해법은 2-계층 캐시</strong> :</p>

    <ul>
      <li>
        <p><strong>프로세스 내 싱글톤 메모리 스냅샷</strong>(초저지연·락 포함)</p>
      </li>
      <li>
        <p><strong>프로세스 간 공유 파일 캐시</strong>(TTL+락)</p>
      </li>
    </ul>
  </li>
  <li>
    <p>조회 흐름:</p>

    <ul>
      <li>
        <p><strong>메모리 스냅샷이 신선(TTL 이내)</strong> → 파일 읽기 없이 <strong>즉시 반환</strong>.</p>
      </li>
      <li>
        <p>신선하지 않으면 <strong>파일을 1회 읽어 메모리 갱신</strong>.</p>
      </li>
      <li>
        <p>TTL 만료·MISS·최소 간격 충족 시 <strong>한 프로세스만</strong> <code class="language-plaintext highlighter-rouge">bjobs -a</code> 수행해 파일/메모리 동시 갱신.</p>
      </li>
    </ul>
  </li>
  <li>
    <p>제출 직후 <strong>SUBMITTED 시드</strong> 는 <strong>메모리와 파일 모두</strong> 에 반영 → Node2 코너 케이스(방금 제출한 잡이 캐시에 아직 없음) 해소.</p>
  </li>
</ol>

<h3 id="적용-코드-기존-fulllistsharedcache-위에-얹는-싱글톤-계층">적용 코드 (기존 <code class="language-plaintext highlighter-rouge">FullListSharedCache</code> 위에 얹는 싱글톤 계층)</h3>

<p>아래 블록만 <strong>추가/치환</strong> 하세요. (나머지 로직은 그대로 동작)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># --- 싱글톤 메모리 스냅샷 계층 ---
</span><span class="k">class</span> <span class="nc">_MemSnap</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">jobs</span> <span class="o">=</span> <span class="p">{}</span>                  <span class="c1"># {job_id: {"status": str, "ts": float}, ...}
</span>        <span class="n">self</span><span class="p">.</span><span class="n">last_full_refresh_ts</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="c1"># float epoch
</span>        <span class="n">self</span><span class="p">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">FullListSharedCache</span><span class="p">:</span>
    <span class="n">_mem</span> <span class="o">=</span> <span class="nf">_MemSnap</span><span class="p">()</span>  <span class="c1"># 프로세스 단일 인스턴스
</span>
    <span class="c1"># ... (기존 __init__, _lock_fd 등은 그대로)
</span>
    <span class="k">def</span> <span class="nf">_mem_is_fresh</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">now</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">ttl</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="nf">float</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">.</span><span class="n">last_full_refresh_ts</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="nf">float</span><span class="p">(</span><span class="n">ttl</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_mem_update_from_dict</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">.</span><span class="n">jobs</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">.</span><span class="n">last_full_refresh_ts</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_persist_and_update_mem</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_write_cache</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="c1"># 파일 쓰기와 동시에 메모리 스냅샷 최신화
</span>        <span class="n">self</span><span class="p">.</span><span class="nf">_mem_update_from_dict</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">seed_submitted</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">job_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">meta</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">제출 직후 SUBMITTED 상태를 메모리/파일 모두에 시드.</span><span class="sh">"""</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="c1"># 메모리 업데이트
</span>        <span class="c1"># (동시에 들어와도 무해; 최신 ts로 덮어써도 OK)
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">.</span><span class="n">jobs</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">.</span><span class="n">jobs</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">.</span><span class="n">jobs</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">SUBMITTED</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">now</span><span class="p">})</span>
        <span class="c1"># 파일 업데이트
</span>        <span class="n">fh</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_lock_fd</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cache_file</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_cache</span><span class="p">()</span>
            <span class="n">jobs</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">:</span>
                <span class="n">jobs</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">SUBMITTED</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">now</span><span class="p">})</span>
            <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">jobs</span>
            <span class="c1"># (선택) 커맨드 메타 저장
</span>            <span class="k">if</span> <span class="n">meta</span><span class="p">:</span>
                <span class="n">jm</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">jobs_meta</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">meta</span><span class="p">:</span>
                        <span class="n">jm</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span>
                <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">jobs_meta</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">jm</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_persist_and_update_mem</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_unlock_fd</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">maybe_refresh_full</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">backend</span><span class="p">:</span> <span class="n">StatusBackend</span><span class="p">,</span> <span class="n">reason</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="c1"># 최소 간격·락 처리 동일
</span>        <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_cache</span><span class="p">()</span>
        <span class="n">last_ts</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="nf">if </span><span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">last_ts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nf">float</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">min_refresh_gap_s</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="n">lock_path</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">cache_file</span> <span class="o">+</span> <span class="sh">"</span><span class="s">.refresh.lock</span><span class="sh">"</span>
        <span class="n">lock_fh</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_lock_fd</span><span class="p">(</span><span class="n">lock_path</span><span class="p">,</span> <span class="n">nonblock</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lock_fh</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data2</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_cache</span><span class="p">()</span>
            <span class="n">last_ts2</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">data2</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="nf">if </span><span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">last_ts2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nf">float</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">min_refresh_gap_s</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">False</span>
            <span class="n">snapshot</span> <span class="o">=</span> <span class="k">await</span> <span class="n">backend</span><span class="p">.</span><span class="nf">query_full</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">snapshot</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
            <span class="n">now2</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
            <span class="n">fh</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_lock_fd</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cache_file</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">base</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_cache</span><span class="p">()</span>
                <span class="n">jobs</span> <span class="o">=</span> <span class="n">base</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">ts</span> <span class="o">=</span> <span class="n">now2</span>
                <span class="k">for</span> <span class="n">jid</span><span class="p">,</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">snapshot</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
                    <span class="n">jobs</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">:</span> <span class="n">st</span><span class="p">,</span> <span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">ts</span><span class="p">}</span>
                <span class="n">base</span><span class="p">[</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">jobs</span>
                <span class="n">base</span><span class="p">[</span><span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">now2</span>
                <span class="n">meta</span> <span class="o">=</span> <span class="n">base</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">meta</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">meta</span><span class="p">[</span><span class="sh">"</span><span class="s">reason</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">reason</span>
                <span class="n">meta</span><span class="p">[</span><span class="sh">"</span><span class="s">refreshed_at</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">iso_now</span><span class="p">()</span>
                <span class="n">base</span><span class="p">[</span><span class="sh">"</span><span class="s">meta</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">meta</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_persist_and_update_mem</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>  <span class="c1"># 파일과 메모리 동시 갱신
</span>            <span class="k">finally</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_unlock_fd</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_unlock_fd</span><span class="p">(</span><span class="n">lock_fh</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_statuses</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">job_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">backend</span><span class="p">:</span> <span class="n">StatusBackend</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="c1"># 1) 메모리 스냅샷 우선
</span>        <span class="k">async</span> <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="n">mem_fresh</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_mem_is_fresh</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">full_ttl_s</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mem_fresh</span><span class="p">:</span>
                <span class="n">jobs</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">.</span><span class="n">jobs</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># 파일 1회 읽어 메모리 최신화
</span>                <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_cache</span><span class="p">()</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_mem_update_from_dict</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="n">jobs</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">.</span><span class="n">jobs</span>

        <span class="k">def</span> <span class="nf">_fresh</span><span class="p">(</span><span class="n">jid</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="n">ent</span> <span class="o">=</span> <span class="n">jobs</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ent</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
            <span class="nf">return </span><span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="nf">float</span><span class="p">(</span><span class="n">ent</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span> <span class="o">&lt;=</span> <span class="nf">float</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">full_ttl_s</span><span class="p">)</span>

        <span class="n">need_refresh</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="nf">_mem_is_fresh</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">full_ttl_s</span><span class="p">):</span>
            <span class="n">need_refresh</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">miss</span> <span class="o">=</span> <span class="p">[</span><span class="n">jid</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span> <span class="k">if</span> <span class="ow">not</span> <span class="nf">_fresh</span><span class="p">(</span><span class="n">jid</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">miss</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="n">force_refresh_on_miss</span><span class="p">:</span>
            <span class="n">need_refresh</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="n">need_refresh</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">maybe_refresh_full</span><span class="p">(</span><span class="n">backend</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="sh">"</span><span class="s">ttl_or_miss</span><span class="sh">"</span><span class="p">)</span>
            <span class="c1"># 리프레시 후 메모리에서 재조회
</span>            <span class="n">jobs</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">.</span><span class="n">jobs</span>

        <span class="k">return</span> <span class="p">{</span><span class="n">jid</span><span class="p">:</span> <span class="p">(</span><span class="n">jobs</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">}</span>
</code></pre></div></div>

<blockquote>
  <p>효과: <strong>동일 프로세스(=동일 ComfyUI 인스턴스)</strong> 에서 여러 노드가 돌아도, 대부분 <strong>파일 I/O 없이 메모리만</strong> 보게 됩니다. 그래도 다른 프로세스/머신과 공유가 필요하면 파일 스냅샷이 “사실상의 소스 오브 트루스”가 되고, 한 프로세스만 <code class="language-plaintext highlighter-rouge">-a</code>를 실행해 <strong>폭주 방지</strong> 가 유지됩니다.</p>
</blockquote>

<p>또한 제출 직후:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># submit 이후
</span><span class="n">jid_to_cmd</span> <span class="o">=</span> <span class="p">{</span><span class="n">jid</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">:</span> <span class="n">sub</span><span class="p">[</span><span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">submitted_at</span><span class="sh">"</span><span class="p">:</span> <span class="nf">iso_now</span><span class="p">()}</span> <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">submissions</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">sub</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])}</span>
<span class="n">full_cache</span><span class="p">.</span><span class="nf">seed_submitted</span><span class="p">(</span><span class="n">job_ids</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="n">jid_to_cmd</span><span class="p">)</span>  <span class="c1"># 메모리/파일 모두 시드 + 커맨드 메타 저장
</span></code></pre></div></div>

<hr />

<h1 id="q2-job-id--커맨드--상태를-노드에-계속-업데이트해서-보여줄-수-있나요">Q2. “job id | 커맨드 | 상태”를 노드에 <strong>계속</strong> 업데이트해서 보여줄 수 있나요?</h1>

<h2 id="결론-step-by-step-1">결론 (step-by-step)</h2>

<ol>
  <li>
    <p><strong>ComfyUI 코어는 기본적으로</strong> 임의 노드가 실행 중에 <strong>UI를 실시간으로 갱신</strong> 하는 API를 제공하지 않습니다(최종 출력만 표시).</p>
  </li>
  <li>
    <p>대신 현실적인 두 가지 경로가 있습니다.</p>
  </li>
</ol>

<h3 id="a안프론트-수정-없이-노드만으로">A안(프론트 수정 없이, 노드만으로)</h3>

<ul>
  <li>
    <p><strong>보조 뷰어 노드</strong> 를 하나 더 만들어, 공유 캐시(<code class="language-plaintext highlighter-rouge">status_full_cache.json</code>) + <code class="language-plaintext highlighter-rouge">jobs_meta</code>에서 <strong>표를 생성(STRING 또는 이미지)</strong> 해서 보여줍니다.</p>
  </li>
  <li>
    <p>최신 상태를 보고 싶을 때 뷰어 노드를 <strong>다시 실행(Queue)</strong> 하면 표가 갱신됩니다.</p>
  </li>
  <li>
    <p>자동 리프레시는 <code class="language-plaintext highlighter-rouge">Loop/Repeat</code>류 확장 노드를 곁들이면 됩니다.</p>
  </li>
</ul>

<blockquote>
  <p>장점: ComfyUI 변경 없이 즉시 사용.<br />
 단점: “지속 스트리밍”은 아니고 <strong>수동/주기 재실행</strong>.</p>
</blockquote>

<h3 id="b안진짜-실시간-패널">B안(진짜 실시간 패널)</h3>

<ul>
  <li>
    <p>커스텀 노드 파일 안에 <strong>가벼운 HTTP GET 엔드포인트</strong> 를 추가(ComfyUI 서버에 라우트 등록) → 프론트에 작은 스크립트(또는 별도 플러그인)로 <strong>주기 폴링</strong> 하여 표를 갱신합니다.</p>
  </li>
  <li>
    <p>사실상 “실시간 대시보드”를 ComfyUI 안쪽 패널에 넣을 수 있습니다.</p>
  </li>
</ul>

<blockquote>
  <p>장점: 진짜 라이브.<br />
 단점: 프론트에 소폭 추가 작업 필요.</p>
</blockquote>

<hr />

<h2 id="바로-쓸-수-있는-뷰어-노드-a안">바로 쓸 수 있는 “뷰어 노드” (A안)</h2>

<p>아래 클래스를 같은 파일에 <strong>추가</strong> 하세요.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ====== 뷰어 노드: 상태 테이블 출력 ======
</span><span class="k">class</span> <span class="nc">LSFStatusBoard</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    입력:
      - job_ids (STRING): </span><span class="sh">"</span><span class="s">123,124,125</span><span class="sh">"</span><span class="s"> (비워두면 캐시에 있는 최근 N개를 보여줌)
      - top_k (INT): job_ids 비었을 때 최근 N개
      - width_limit (INT): 커맨드 컬럼 자르기 길이
    출력:
      - table_text (STRING): 모노스페이스 표 텍스트
    </span><span class="sh">"""</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">LSF</span><span class="sh">"</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">run</span><span class="sh">"</span>
    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">table_text</span><span class="sh">"</span><span class="p">,)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}),</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">optional</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">top_k</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">INT</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="sh">"</span><span class="s">min</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="sh">"</span><span class="s">max</span><span class="sh">"</span><span class="p">:</span> <span class="mi">500</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">width_limit</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">INT</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span> <span class="sh">"</span><span class="s">min</span><span class="sh">"</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="sh">"</span><span class="s">max</span><span class="sh">"</span><span class="p">:</span> <span class="mi">200</span><span class="p">}),</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_read_cache</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">cache_dir</span> <span class="o">=</span> <span class="nf">ensure_dir</span><span class="p">(</span><span class="nf">default_cache_dir</span><span class="p">())</span>
        <span class="n">cache_file</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">status_full_cache.json</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">cache_file</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">:</span> <span class="p">{},</span> <span class="sh">"</span><span class="s">jobs_meta</span><span class="sh">"</span><span class="p">:</span> <span class="p">{},</span> <span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">_short</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">limit</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">s</span> <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">limit</span> <span class="nf">else </span><span class="p">(</span><span class="n">s</span><span class="p">[:</span><span class="n">limit</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="sh">"</span><span class="s">…</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_fmt_table</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">rows</span><span class="p">):</span>
        <span class="c1"># 고정 폭 표 생성
</span>        <span class="n">jid_w</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="nf">max</span><span class="p">((</span><span class="nf">len</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">])</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="mi">6</span><span class="p">))</span>
        <span class="n">st_w</span>  <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">max</span><span class="p">((</span><span class="nf">len</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">])</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="mi">5</span><span class="p">))</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="sh">'</span><span class="s">JOBID</span><span class="sh">'</span><span class="si">:</span><span class="o">&lt;</span><span class="si">{</span><span class="n">jid_w</span><span class="si">}}</span><span class="s"> | </span><span class="si">{</span><span class="sh">'</span><span class="s">STATUS</span><span class="sh">'</span><span class="si">:</span><span class="o">&lt;</span><span class="si">{</span><span class="n">st_w</span><span class="si">}}</span><span class="s"> | CMD</span><span class="sh">"</span>
        <span class="n">sep</span> <span class="o">=</span> <span class="sh">"</span><span class="s">-</span><span class="sh">"</span><span class="o">*</span><span class="nf">len</span><span class="p">(</span><span class="n">hdr</span><span class="p">)</span>
        <span class="n">body</span> <span class="o">=</span> <span class="p">[</span><span class="n">hdr</span><span class="p">,</span> <span class="n">sep</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
            <span class="n">body</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="sh">'</span><span class="s">job_id</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="o">&lt;</span><span class="si">{</span><span class="n">jid_w</span><span class="si">}}</span><span class="s"> | </span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="sh">'</span><span class="s">status</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="o">&lt;</span><span class="si">{</span><span class="n">st_w</span><span class="si">}}</span><span class="s"> | </span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="sh">'</span><span class="s">cmd</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">job_ids</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">top_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">width_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">80</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_cache</span><span class="p">()</span>
        <span class="n">jobs</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">jobs_meta</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="n">job_ids</span><span class="p">.</span><span class="nf">strip</span><span class="p">():</span>
            <span class="n">jids</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="p">.</span><span class="nf">strip</span><span class="p">()]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># 최근 top_k (ts 기준 정렬)
</span>            <span class="n">jids</span> <span class="o">=</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">jobs</span><span class="p">.</span><span class="nf">keys</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">j</span><span class="p">:</span> <span class="n">jobs</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)[:</span><span class="n">top_k</span><span class="p">]</span>

        <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">jids</span><span class="p">:</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">jobs</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="n">meta</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
            <span class="n">rows</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">jid</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">:</span> <span class="n">st</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="nf">_short</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">width_limit</span><span class="p">),</span>
            <span class="p">})</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_fmt_table</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">table</span><span class="p">,)</span>

<span class="c1"># 등록
</span><span class="n">NODE_CLASS_MAPPINGS</span><span class="p">.</span><span class="nf">update</span><span class="p">({</span><span class="sh">"</span><span class="s">LSFStatusBoard</span><span class="sh">"</span><span class="p">:</span> <span class="n">LSFStatusBoard</span><span class="p">})</span>
<span class="n">NODE_DISPLAY_NAME_MAPPINGS</span><span class="p">.</span><span class="nf">update</span><span class="p">({</span><span class="sh">"</span><span class="s">LSFStatusBoard</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">LSF: Status Board</span><span class="sh">"</span><span class="p">})</span>
</code></pre></div></div>

<h3 id="제출-노드에서-커맨드-메타-저장한-줄-추가">제출 노드에서 커맨드 메타 저장(한 줄 추가)</h3>

<p>앞서 Q1 코드처럼 제출 직후 커맨드도 함께 시드합니다:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">jid_to_cmd</span> <span class="o">=</span> <span class="p">{</span><span class="n">jid</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">:</span> <span class="n">sub</span><span class="p">[</span><span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">submitted_at</span><span class="sh">"</span><span class="p">:</span> <span class="nf">iso_now</span><span class="p">()}</span> <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">submissions</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">sub</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])}</span>
<span class="n">full_cache</span><span class="p">.</span><span class="nf">seed_submitted</span><span class="p">(</span><span class="n">job_ids</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="n">jid_to_cmd</span><span class="p">)</span>
</code></pre></div></div>

<blockquote>
  <p>이제 뷰어 노드에서 <strong>JOBID | STATUS | CMD</strong> 를 깔끔히 볼 수 있습니다.<br />
 “계속” 갱신하려면 뷰어 노드를 <strong>주기적으로 재실행</strong>(직접 클릭 또는 반복 실행 노드 사용)하세요.</p>
</blockquote>

<hr />

<h2 id="진짜-실시간-패널-b안-선택">진짜 실시간 패널 (B안, 선택)</h2>

<ul>
  <li>
    <p>가능: 서버 라우트를 하나 노드 파일에 등록해 JSON을 내보내고, 프론트(간단 JS)에서 1~3초 간격 폴링.</p>
  </li>
  <li>
    <p>필요 코드(개요): <code class="language-plaintext highlighter-rouge">server.PromptServer</code> 이용해 <code class="language-plaintext highlighter-rouge">GET /lsf/status?job_ids=...</code> 엔드포인트 추가 → 위 <code class="language-plaintext highlighter-rouge">LSFStatusBoard</code>의 내부 로직을 재사용해 JSON 응답.</p>
  </li>
  <li>
    <p>원하시면 이 라우트 + 최소 HTML/JS 패널 코드를 바로 붙여드릴게요.</p>
  </li>
</ul>

<hr />

<h2 id="요약">요약</h2>

<ul>
  <li>
    <p><strong>Q1</strong> : 파일 남용 없이 <strong>“메모리 싱글톤 + 파일 스냅샷”</strong> 2-계층 캐시로 해결. 제출 직후 <strong>SUBMITTED 시드</strong> 로 Node2 코너 케이스도 해결.</p>
  </li>
  <li>
    <p><strong>Q2</strong> : 코어 UI는 중간 갱신이 어려우므로</p>

    <ul>
      <li>
        <p>바로 쓰려면 <strong>뷰어 노드(A안)</strong> 로 표를 재실행 갱신,</p>
      </li>
      <li>
        <p>진짜 라이브는 <strong>간단 라우트(B안)</strong> + 소형 패널.</p>
      </li>
    </ul>
  </li>
</ul>

<p>더 진한 기능(상태 아이콘/색상, 정렬/필터, EXIT 원인 추적, bjobs -a 추가 컬럼 파싱 등) 원하시면 이어서 확장해 드릴게요.</p>

<p class="chat--user">

impact node에서 아래 함수(js)와 PromptServer.instance.send_sync("impact-node-feedback", {"node_id": …, ”widget_name": …}) 이런 함수를 이용해서 런타임에서 위젯 업데이트를 하는 것 같은데 이런 참고해서 markdown table 형식으로 Jod ID, Status, Command 를 String widget에 계속 업데이트 해보자. function nodeFeedbackHandler(event) { let nodes = app.graph._nodes_by_id; let node = nodes[event.detail.node_id]; if(node) { const w = node.widgets.find((w) =&gt; event.detail.widget_name === w.name); if(w) { w.value = event.detail.value; } } } api.addEventListener("impact-node-feedback", nodeFeedbackHandler);

</p>

<p>좋아—“impact-node-feedback” 패턴을 그대로 활용해서, <strong>런타임에 String 위젯을 계속 갱신</strong>(마크다운 테이블 형태)하도록 노드를 확장해볼게. 아래는 <strong>step-by-step</strong> 로 정리한 구현 가이드 + 바로 붙여넣어 쓸 <strong>패치 코드</strong> 야.</p>

<hr />

<h1 id="어떻게-작동하나-step-by-step">어떻게 작동하나 (step-by-step)</h1>

<ol>
  <li>
    <p><strong>프론트엔드 리스너 등록</strong><br />
네가 준 핸들러 그대로 씀. <code class="language-plaintext highlighter-rouge">impact-node-feedback</code> 커스텀 메시지를 받으면 해당 노드의 특정 위젯 값을 갱신. 이 방식은 공식 문서의 <code class="language-plaintext highlighter-rouge">PromptServer.instance.send_sync()</code> 사용자 정의 메시지 가이드와 동일한 흐름이야. <a href="https://docs.comfy.org/development/comfyui-server/comms_messages">ComfyUI</a></p>
  </li>
  <li>
    <p><strong>노드에 “표시 전용” String 위젯 추가</strong><br />
예: <code class="language-plaintext highlighter-rouge">status_md</code> 라는 이름의 멀티라인 STRING 위젯. 노드 실행 중 서버에서 이 위젯의 값을 계속 바꿔치기 함(마크다운 표 텍스트).</p>
  </li>
  <li>
    <p><strong>node_id 확보(필수)</strong><br />
ComfyUI는 <code class="language-plaintext highlighter-rouge">INPUT_TYPES["hidden"]</code>에 <code class="language-plaintext highlighter-rouge">"UNIQUE_ID"</code>를 넣으면 런타임에서 <strong>노드 id</strong> 를 파라미터로 받을 수 있음. 이걸 payload에 실어 보내면, 프론트에서 정확한 노드의 해당 위젯만 업데이트 가능. <a href="https://docs.comfy.org/development/comfyui-server/comms_messages">ComfyUI+2</a></p>
  </li>
  <li>
    <p><strong>서버에서 주기적으로 send_sync 발사</strong><br />
폴링 루프 매 턴마다</p>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>arduino
     
PromptServer.instance.send_sync(
  "impact-node-feedback",
  {"node_id": node_id, "widget_name": "status_md", "value": table_md}
)
</code></pre></div>    </div>
  </li>
</ol>

<p>로 위젯 값을 푸시. (다수 예제들이 같은 패턴으로 상태를 실시간 알림) <a href="https://huggingface.co/spaces/Freak-ppa/ioatol/blob/b162d43c5cd550b037fb83fa04cc6301339f36f4/ComfyUI/custom_nodes/cg-use-everywhere/use_everywhere.py?utm_source=chatgpt.com">Hugging Face+2</a></p>

<hr />

<h1 id="0-프론트엔드웹-코드--리스너-등록">0) 프론트엔드(웹) 코드 — 리스너 등록</h1>

<p><code class="language-plaintext highlighter-rouge">ComfyUI/web/extensions/impact_node_feedback.js</code> (파일명은 임의)로 저장:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

function nodeFeedbackHandler(event) {
  let nodes = app.graph._nodes_by_id;
  let node = nodes[event.detail.node_id];
  if (node) {
    const w = node.widgets.find((w) =&gt; event.detail.widget_name === w.name);
    if (w) {
      w.value = event.detail.value;
      // UI 즉시 갱신
      if (w.callback) w.callback(w.value);
      node.setDirtyCanvas(true, true);
    }
  }
}
api.addEventListener("impact-node-feedback", nodeFeedbackHandler);
</code></pre></div></div>

<blockquote>
  <p>이건 ComfyUI의 커스텀 메시지 이벤트 처리 패턴과 1:1로 맞음. 서버에서 <code class="language-plaintext highlighter-rouge">send_sync</code>로 <code class="language-plaintext highlighter-rouge">"impact-node-feedback"</code>를 보낼 거야. <a href="https://docs.comfy.org/development/comfyui-server/comms_messages">ComfyUI</a></p>
</blockquote>

<hr />

<h1 id="1-파이썬-노드-패치--위젯node_id라이브업데이트-추가">1) 파이썬 노드 패치 — 위젯·node_id·라이브업데이트 추가</h1>

<p>아래 <strong>추가/수정 블록만</strong> 기존 노드 파일에 반영하면 돼. (이전 답변에서 만든 LSFSubmitAndWait 기준)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 상단 import에 추가
</span><span class="kn">from</span> <span class="n">server</span> <span class="kn">import</span> <span class="n">PromptServer</span>  <span class="c1"># send_sync를 위해
</span>
<span class="c1"># ----- 유틸: 마크다운 테이블 생성 -----
</span><span class="k">def</span> <span class="nf">_short</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">).</span><span class="nf">strip</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">s</span> <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">limit</span> <span class="nf">else </span><span class="p">(</span><span class="n">s</span><span class="p">[:</span><span class="n">limit</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="sh">"</span><span class="s">…</span><span class="sh">"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">make_status_markdown</span><span class="p">(</span><span class="n">job_rows</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="n">width_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">80</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    job_rows: [{</span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">123</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">RUN</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">bsub ...</span><span class="sh">"</span><span class="s">}, ...]
    </span><span class="sh">"""</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">lines</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">| JOB ID | STATUS | COMMAND |</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">lines</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">|------:|:------:|---------|</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">job_rows</span><span class="p">:</span>
        <span class="n">jid</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="n">st</span>  <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="nf">_short</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">),</span> <span class="n">width_limit</span><span class="p">)</span>
        <span class="c1"># 파이프 이스케이프는 단순히 백틱 감싸기로 회피
</span>        <span class="n">lines</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">| `</span><span class="si">{</span><span class="n">jid</span><span class="si">}</span><span class="s">` | `</span><span class="si">{</span><span class="n">st</span><span class="si">}</span><span class="s">` | `</span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s">` |</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

<span class="c1"># ----- LSFSubmitAndWait 클래스 변경 -----
</span><span class="k">class</span> <span class="nc">LSFSubmitAndWait</span><span class="p">:</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">LSF</span><span class="sh">"</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">run</span><span class="sh">"</span>
    <span class="n">OUTPUT_NODE</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">SUPPORTS_ASYNC</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">results_json</span><span class="sh">"</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">commands</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">bsub -q short sleep 3</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">cwd</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">}),</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">optional</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="c1"># 표시 전용 위젯(라이브 상태 보드)
</span>                <span class="sh">"</span><span class="s">status_md</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span>
                    <span class="sh">"</span><span class="s">| JOB ID | STATUS | COMMAND |</span><span class="se">\n</span><span class="s">|------:|:------:|---------|</span><span class="se">\n</span><span class="s">(실행 중 라이브로 갱신됩니다)</span><span class="sh">"</span><span class="p">}),</span>
                <span class="c1"># 줄 길이 제한(명령어 과도하게 길 때)
</span>                <span class="sh">"</span><span class="s">cmd_width_limit</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">INT</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="sh">"</span><span class="s">min</span><span class="sh">"</span><span class="p">:</span> <span class="mi">40</span><span class="p">,</span> <span class="sh">"</span><span class="s">max</span><span class="sh">"</span><span class="p">:</span> <span class="mi">200</span><span class="p">}),</span>
                <span class="c1"># 필요 시 끄기
</span>                <span class="sh">"</span><span class="s">live_update</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">BOOL</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">}),</span>
            <span class="p">},</span>
            <span class="c1"># node_id를 받기 위한 hidden 입력 (공식 문서 패턴)
</span>            <span class="sh">"</span><span class="s">hidden</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span> <span class="sh">"</span><span class="s">node_id</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">UNIQUE_ID</span><span class="sh">"</span> <span class="p">}</span>
        <span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span>
                  <span class="n">commands</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                  <span class="n">cwd</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                  <span class="n">status_md</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span><span class="p">,</span>
                  <span class="n">cmd_width_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
                  <span class="n">live_update</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
                  <span class="n">node_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="c1"># ... (기존 run 코드의 "옵션 파싱" 직후에 이어서) ...
</span>
        <span class="c1"># 1) 제출
</span>        <span class="n">submitted_at</span> <span class="o">=</span> <span class="nf">iso_now</span><span class="p">()</span>
        <span class="n">job_ids</span><span class="p">,</span> <span class="n">submissions</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">submit_commands_multiline</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">cwd</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>

        <span class="c1"># 제출한 커맨드 메타 맵 (job_id -&gt; cmd)
</span>        <span class="n">jid_to_cmd</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">submissions</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">sub</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="n">jid_to_cmd</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="n">sub</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>

        <span class="c1"># 2) 전역 캐시/백엔드
</span>        <span class="n">cache_dir</span> <span class="o">=</span> <span class="nf">ensure_dir</span><span class="p">(</span><span class="nf">default_cache_dir</span><span class="p">())</span>
        <span class="n">cache_file</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">status_full_cache.json</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">full_cache</span> <span class="o">=</span> <span class="nc">FullListSharedCache</span><span class="p">(</span>
            <span class="n">cache_file</span><span class="p">,</span>
            <span class="n">full_ttl_s</span><span class="o">=</span><span class="n">full_ttl_s</span><span class="p">,</span>
            <span class="n">min_refresh_gap_s</span><span class="o">=</span><span class="n">min_refresh_gap_s</span><span class="p">,</span>
            <span class="n">force_refresh_on_miss</span><span class="o">=</span><span class="n">force_refresh_on_miss</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">backend</span> <span class="o">=</span> <span class="nc">LSFBjobsFullBackend</span><span class="p">(</span><span class="n">full_status_cmd_template</span><span class="o">=</span><span class="n">full_status_cmd_template</span><span class="p">)</span>

        <span class="c1"># 2-1) 제출 직후 캐시 시드(커맨드 메타 포함)
</span>        <span class="k">if</span> <span class="n">job_ids</span><span class="p">:</span>
            <span class="c1"># seed_submitted가 meta를 파일/메모리 모두에 저장하도록 앞서 구현해둠
</span>            <span class="n">meta</span> <span class="o">=</span> <span class="p">{</span><span class="n">jid</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">:</span> <span class="n">jid_to_cmd</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="sh">""</span><span class="p">),</span> <span class="sh">"</span><span class="s">submitted_at</span><span class="sh">"</span><span class="p">:</span> <span class="n">submitted_at</span><span class="p">}</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">}</span>
            <span class="n">full_cache</span><span class="p">.</span><span class="nf">seed_submitted</span><span class="p">(</span><span class="n">job_ids</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="n">meta</span><span class="p">)</span>

        <span class="c1"># (신규) 초기 UI 업데이트 한번 수행
</span>        <span class="k">if</span> <span class="n">live_update</span> <span class="ow">and</span> <span class="n">node_id</span> <span class="ow">and</span> <span class="n">job_ids</span><span class="p">:</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="p">[{</span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">jid</span><span class="p">,</span> <span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">SUBMITTED</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">:</span> <span class="n">jid_to_cmd</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="sh">""</span><span class="p">)}</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">]</span>
            <span class="n">table_md</span> <span class="o">=</span> <span class="nf">make_status_markdown</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">width_limit</span><span class="o">=</span><span class="n">cmd_width_limit</span><span class="p">)</span>
            <span class="n">PromptServer</span><span class="p">.</span><span class="n">instance</span><span class="p">.</span><span class="nf">send_sync</span><span class="p">(</span><span class="sh">"</span><span class="s">impact-node-feedback</span><span class="sh">"</span><span class="p">,</span>
                                            <span class="p">{</span><span class="sh">"</span><span class="s">node_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">node_id</span><span class="p">,</span> <span class="sh">"</span><span class="s">widget_name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">status_md</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span> <span class="n">table_md</span><span class="p">})</span>

        <span class="c1"># 3) 완료까지 대기 + 주기적 UI 업데이트
</span>        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="n">final_statuses</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">waited_sec</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">statuses</span> <span class="o">=</span> <span class="k">await</span> <span class="n">full_cache</span><span class="p">.</span><span class="nf">get_statuses</span><span class="p">(</span><span class="n">job_ids</span><span class="p">,</span> <span class="n">backend</span><span class="p">)</span>
            <span class="n">final_statuses</span> <span class="o">=</span> <span class="p">{</span><span class="n">jid</span><span class="p">:</span> <span class="n">statuses</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">}</span>

            <span class="c1"># (신규) 라이브 업데이트
</span>            <span class="k">if</span> <span class="n">live_update</span> <span class="ow">and</span> <span class="n">node_id</span> <span class="ow">and</span> <span class="n">job_ids</span><span class="p">:</span>
                <span class="n">rows</span> <span class="o">=</span> <span class="p">[{</span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">jid</span><span class="p">,</span>
                         <span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">:</span> <span class="n">final_statuses</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">N/A</span><span class="sh">"</span><span class="p">,</span>
                         <span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">:</span> <span class="n">jid_to_cmd</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="sh">""</span><span class="p">)}</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">]</span>
                <span class="n">table_md</span> <span class="o">=</span> <span class="nf">make_status_markdown</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">width_limit</span><span class="o">=</span><span class="n">cmd_width_limit</span><span class="p">)</span>
                <span class="n">PromptServer</span><span class="p">.</span><span class="n">instance</span><span class="p">.</span><span class="nf">send_sync</span><span class="p">(</span><span class="sh">"</span><span class="s">impact-node-feedback</span><span class="sh">"</span><span class="p">,</span>
                                                <span class="p">{</span><span class="sh">"</span><span class="s">node_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">node_id</span><span class="p">,</span> <span class="sh">"</span><span class="s">widget_name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">status_md</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span> <span class="n">table_md</span><span class="p">})</span>

            <span class="k">if</span> <span class="nf">all</span><span class="p">((</span><span class="n">st</span> <span class="ow">in</span> <span class="n">TERMINAL_STATES</span><span class="p">)</span> <span class="ow">and</span> <span class="n">st</span> <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">final_statuses</span><span class="p">.</span><span class="nf">values</span><span class="p">()):</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">max_wait_s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">max_wait_s</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="nf">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nf">int</span><span class="p">(</span><span class="n">poll_interval_s</span><span class="p">)))</span>

        <span class="n">waited_sec</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
        <span class="n">completed_at</span> <span class="o">=</span> <span class="nf">iso_now</span><span class="p">()</span>
        <span class="n">all_done</span> <span class="o">=</span> <span class="nf">all</span><span class="p">((</span><span class="n">st</span> <span class="ow">in</span> <span class="n">TERMINAL_STATES</span><span class="p">)</span> <span class="ow">and</span> <span class="n">st</span> <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">final_statuses</span><span class="p">.</span><span class="nf">values</span><span class="p">())</span>

        <span class="c1"># (나머지 결과 저장/반환 로직은 기존 그대로)
</span>        <span class="c1"># ...
</span></code></pre></div></div>

<blockquote>
  <p>포인트</p>

  <ul>
    <li>
      <p><code class="language-plaintext highlighter-rouge">hidden</code>에 <code class="language-plaintext highlighter-rouge">"UNIQUE_ID"</code> 추가 → <code class="language-plaintext highlighter-rouge">run(..., node_id=...)</code>로 받을 수 있음. 서버에서 이 값을 payload에 담아 보냄. 프론트는 <code class="language-plaintext highlighter-rouge">node_id</code>로 해당 노드의 <code class="language-plaintext highlighter-rouge">status_md</code> 위젯만 갱신. <a href="https://docs.comfy.org/development/comfyui-server/comms_messages">ComfyUI</a></p>
    </li>
    <li>
      <p>메시지 발사는 <code class="language-plaintext highlighter-rouge">PromptServer.instance.send_sync(&lt;event&gt;, &lt;payload&gt;)</code> 형식. (여러 커스텀 노드들이 이 패턴으로 실시간 상태를 보내는 사례 다수) <a href="https://huggingface.co/spaces/Freak-ppa/ioatol/blob/b162d43c5cd550b037fb83fa04cc6301339f36f4/ComfyUI/custom_nodes/cg-use-everywhere/use_everywhere.py?utm_source=chatgpt.com">Hugging Face+1</a></p>
    </li>
  </ul>

</blockquote>

<hr />

<h2 id="결과-화면-예시-string-위젯-내용">결과 화면 예시 (String 위젯 내용)</h2>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">|</span> <span class="no">JOB</span> <span class="no">ID</span> <span class="o">|</span> <span class="no">STATUS</span> <span class="o">|</span> <span class="no">COMMAND</span> <span class="o">|</span>
<span class="o">|------</span><span class="ss">:|</span><span class="p">:</span><span class="o">------</span><span class="ss">:|</span><span class="o">---------|</span>
<span class="o">|</span> <span class="sb">`124578`</span> <span class="o">|</span> <span class="sb">`RUN`</span> <span class="o">|</span> <span class="sb">`bsub -q short -J test1 sleep 5`</span> <span class="o">|</span>
<span class="o">|</span> <span class="sb">`124579`</span> <span class="o">|</span> <span class="sb">`PEND`</span> <span class="o">|</span> <span class="sb">`bsub -q short -J test2 sleep 8`</span> <span class="o">|</span>
<span class="o">|</span> <span class="sb">`124580`</span> <span class="o">|</span> <span class="sb">`DONE`</span> <span class="o">|</span> <span class="sb">`bsub -q short -J test3 sleep 2`</span> <span class="o">|</span>
</code></pre></div></div>

<ul>
  <li>마크다운 테이블을 “렌더링”하지는 않지만, <strong>가독성 높은 텍스트 표</strong> 로 잘 보여줘. (String 위젯은 Markdown 해석을 안 하므로, 표 텍스트 형태로 보는 개념)</li>
</ul>

<hr />

<h2 id="추가-팁">추가 팁</h2>

<ul>
  <li>
    <p><strong>업데이트 빈도(스팸 방지)</strong><br />
<code class="language-plaintext highlighter-rouge">poll_interval_s</code>가 너무 작으면 UI도 그만큼 자주 갱신됨. 필요하면 “마지막 송신 시각”을 저장해 <strong>1~2초 쓰로틀</strong> 을 추가해도 좋음.</p>
  </li>
  <li>
    <p><strong>여러 클라이언트 탭 동시 접속</strong><br />
특정 탭만 갱신하고 싶다면 <code class="language-plaintext highlighter-rouge">send_sync(..., sid=PromptServer.instance.client_id)</code>로 <strong>현재 클라이언트에만</strong> 보내는 패턴도 있어. (여러 예제 노드가 이 방식 사용) <a href="https://gitee.com/failurejack/ComfyUI/blob/master/execution.py?utm_source=chatgpt.com">Gitee</a></p>
  </li>
  <li>
    <p><strong>명령어 길이</strong><br />
<code class="language-plaintext highlighter-rouge">cmd_width_limit</code>로 긴 커맨드를 줄여 보여줌. 필요하면 툴팁/별도 대시보드로 확장 가능.</p>
  </li>
</ul>

<hr />

<h2 id="요약-1">요약</h2>

<ul>
  <li>
    <p><strong>Q1</strong> : 파일 캐시 + 프로세스 내 싱글톤 메모리 캐시(이미 반영)로 <strong>bjobs -a 과다 호출 방지</strong> 및 <strong>동시 노드 안전</strong>.</p>
  </li>
  <li>
    <p><strong>Q2</strong> : <code class="language-plaintext highlighter-rouge">send_sync("impact-node-feedback", {...})</code> + <code class="language-plaintext highlighter-rouge">hidden UNIQUE_ID</code> + 표시용 <code class="language-plaintext highlighter-rouge">status_md</code> 위젯으로, <strong>런타임 라이브 상태판</strong> 구현 완료. (공식 문서의 커스텀 메시지/노드 id 전달 패턴 준수) <a href="https://docs.comfy.org/development/comfyui-server/comms_messages">ComfyUI</a></p>
  </li>
</ul>

<p>원하면 <strong>진짜 Markdown 렌더</strong>(HTML 패널)나 <strong>컬러 뱃지/아이콘</strong> , <strong>EXIT 원인/에러 로그</strong> 컬럼도 붙여줄 수 있어.</p>

<p class="chat--user">

전체 코드 정리해서 다시 써줘(파이썬 코드만 써주면 돼). 전체적으로 좀 기능에 비해 코드가 복잡한것 같은데 최적화할 수 있는 부분이 있으면 최적화하면 좋겠어.

</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># File: custom_nodes/lsf_submit_and_wait.py
# Purpose: ComfyUI Async OUTPUT node to submit LSF jobs (bsub), poll with bjobs -a,
#          share a lightweight global cache across nodes/processes, and live-update
#          a String widget (markdown-like table) during runtime via PromptServer.
#
# Key features (lean &amp; optimized):
# - Async node (SUPPORTS_ASYNC=True), batch-limited parallel bsub submissions.
# - Single, simplified "full list" cache refreshed by `bjobs -a` only when needed:
#     * 2-tier cache: in-process memory snapshot + cross-process JSON file.
#     * TTL &amp; minimal refresh gap + non-blocking refresh lock -&gt; prevents bjobs storms.
#     * Immediate "SUBMITTED" seeding for newly created job IDs (corner case solved).
# - Runtime UI feedback: PromptServer.instance.send_sync("impact-node-feedback", …)
#     * Updates a String widget named "status_md" with a compact markdown table.
#     * Throttled updates to avoid UI spam.
#
# Inputs:
#   - commands (STRING, multiline): multiple bsub lines. Optional inline directive:
#       # LSF: batch_size=4 poll_interval_s=10 full_ttl_s=15 min_refresh_gap_s=5
#       # LSF: ui_update_gap_s=1 max_wait_s=7200 full_status_cmd="bjobs -a -noheader -o \"jobid stat\""
#       (All keys optional; defaults are sensible.)
#   - cwd (STRING): working directory for submissions.
#   - status_md (STRING): display widget (auto-updated during run).
#   - cmd_width_limit (INT): truncate very long command strings in the table.
#   - live_update (BOOL): enable/disable live widget updates.
#   - hidden node_id (UNIQUE_ID): used to address the specific node widget.
#
# Outputs (OUTPUT node):
#   - job_ids (STRING): comma-separated list
#   - results_json (STRING): summary JSON (final status, timing, options, log file path)
#
# Minimal dependencies: Python stdlib + ComfyUI's PromptServer (bundled).
</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">re</span>
<span class="kn">import</span> <span class="n">shlex</span>
<span class="kn">import</span> <span class="n">tempfile</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="c1"># ComfyUI server for live widget updates
</span><span class="kn">from</span> <span class="n">server</span> <span class="kn">import</span> <span class="n">PromptServer</span>  <span class="c1"># noqa
</span>
<span class="c1"># fcntl (POSIX) for file locks. If unavailable (e.g. Windows), degrade gracefully.
</span><span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">fcntl</span>  <span class="c1"># type: ignore
</span><span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>  <span class="c1"># pragma: no cover
</span>    <span class="n">fcntl</span> <span class="o">=</span> <span class="bp">None</span>

<span class="c1"># ---------------------------- Basic utils ----------------------------
</span>
<span class="n">JOB_ID_REGEX</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">Job\s*&lt;(\d+)&gt;</span><span class="sh">"</span><span class="p">,</span> <span class="n">re</span><span class="p">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
<span class="n">TERMINAL_STATES</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">DONE</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">EXIT</span><span class="sh">"</span><span class="p">}</span>  <span class="c1"># Adjust if your cluster uses other terminal labels
</span>
<span class="k">def</span> <span class="nf">iso_now</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">datetime</span><span class="p">.</span><span class="nf">utcnow</span><span class="p">().</span><span class="nf">isoformat</span><span class="p">(</span><span class="n">timespec</span><span class="o">=</span><span class="sh">"</span><span class="s">seconds</span><span class="sh">"</span><span class="p">)</span> <span class="o">+</span> <span class="sh">"</span><span class="s">Z</span><span class="sh">"</span>

<span class="k">def</span> <span class="nf">default_cache_dir</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span>
        <span class="sh">"</span><span class="s">COMFYUI_LSF_CACHE_DIR</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">tempfile</span><span class="p">.</span><span class="nf">gettempdir</span><span class="p">(),</span> <span class="sh">"</span><span class="s">comfyui_lsf_cache</span><span class="sh">"</span><span class="p">)</span>
    <span class="p">)</span>

<span class="k">def</span> <span class="nf">ensure_dir</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">path</span>

<span class="k">def</span> <span class="nf">_short</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">).</span><span class="nf">strip</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">s</span> <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">limit</span> <span class="nf">else </span><span class="p">(</span><span class="n">s</span><span class="p">[:</span> <span class="nf">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">limit</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">+</span> <span class="sh">"</span><span class="s">…</span><span class="sh">"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">parse_inline_options_and_commands</span><span class="p">(</span><span class="n">commands_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Parse optional inline LSF options from leading lines:
      # LSF: key=value key=value ...
    Returns (options_dict, command_lines)
    </span><span class="sh">"""</span>
    <span class="n">options</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">raw_lines</span> <span class="o">=</span> <span class="n">commands_text</span><span class="p">.</span><span class="nf">splitlines</span><span class="p">()</span>
    <span class="n">cmd_lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ln</span> <span class="ow">in</span> <span class="n">raw_lines</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">^\s*#\s*LSF:\s*(.+)$</span><span class="sh">"</span><span class="p">,</span> <span class="n">ln</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">kv</span> <span class="ow">in</span> <span class="n">shlex</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">posix</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
                <span class="k">if</span> <span class="sh">"</span><span class="s">=</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">kv</span><span class="p">:</span>
                    <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">kv</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">=</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">v_strip</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="nf">strip</span><span class="p">().</span><span class="nf">lower</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">v_strip</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">false</span><span class="sh">"</span><span class="p">):</span>
                        <span class="n">options</span><span class="p">[</span><span class="n">k</span><span class="p">.</span><span class="nf">strip</span><span class="p">()]</span> <span class="o">=</span> <span class="p">(</span><span class="n">v_strip</span> <span class="o">==</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">options</span><span class="p">[</span><span class="n">k</span><span class="p">.</span><span class="nf">strip</span><span class="p">()]</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                            <span class="n">options</span><span class="p">[</span><span class="n">k</span><span class="p">.</span><span class="nf">strip</span><span class="p">()]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">continue</span>
        <span class="c1"># keep non-empty command lines, ignore other comments/empties
</span>        <span class="k">if</span> <span class="n">ln</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ln</span><span class="p">.</span><span class="nf">strip</span><span class="p">().</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s"># LSF:</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">cmd_lines</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">ln</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">options</span><span class="p">,</span> <span class="n">cmd_lines</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_shell</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">cwd</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
    <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_shell</span><span class="p">(</span>
        <span class="n">cmd</span><span class="p">,</span>
        <span class="n">cwd</span><span class="o">=</span><span class="n">cwd</span> <span class="k">if</span> <span class="n">cwd</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
        <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">out_b</span><span class="p">,</span> <span class="n">err_b</span> <span class="o">=</span> <span class="k">await</span> <span class="n">proc</span><span class="p">.</span><span class="nf">communicate</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">proc</span><span class="p">.</span><span class="n">returncode</span><span class="p">,</span> <span class="n">out_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">ignore</span><span class="sh">"</span><span class="p">),</span> <span class="n">err_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">ignore</span><span class="sh">"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">extract_job_ids_from_bsub_output</span><span class="p">(</span><span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="c1"># LSF standard: "Job &lt;12345&gt; is submitted to queue &lt;...&gt;."
</span>    <span class="k">return</span> <span class="n">JOB_ID_REGEX</span><span class="p">.</span><span class="nf">findall</span><span class="p">(</span><span class="n">stdout</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">)</span>

<span class="c1"># ---------------------------- LSF backend ----------------------------
</span>
<span class="k">class</span> <span class="nc">LSFBackend</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Minimal backend that fetches ONE full snapshot of job statuses via `bjobs -a`.</span><span class="sh">"""</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">full_status_cmd</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="c1"># default format: columns: jobid stat
</span>        <span class="n">self</span><span class="p">.</span><span class="n">full_status_cmd</span> <span class="o">=</span> <span class="n">full_status_cmd</span> <span class="ow">or</span> <span class="sh">'</span><span class="s">bjobs -a -noheader -o </span><span class="sh">"</span><span class="s">jobid stat</span><span class="sh">"'</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">full_snapshot</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="n">rc</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">run_shell</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">full_status_cmd</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">out</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">ln</span> <span class="ow">in</span> <span class="n">out</span><span class="p">.</span><span class="nf">splitlines</span><span class="p">():</span>
            <span class="n">ln</span> <span class="o">=</span> <span class="n">ln</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ln</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">ln</span><span class="p">.</span><span class="nf">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">parts</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">jid</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nf">upper</span><span class="p">()</span>
            <span class="n">result</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="n">st</span>
        <span class="k">return</span> <span class="n">result</span>

<span class="c1"># ---------------------------- Global cache (lean, 2-tier) ----------------------------
</span>
<span class="k">class</span> <span class="nc">LSFCache</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Lean 2-tier cache for job statuses (ALL jobs snapshot):
      - In-process memory snapshot (fast-path, avoids file I/O most of the time)
      - Cross-process JSON file snapshot (source of truth)
    Concurrency control:
      - Non-blocking refresh lock file ensures only one process runs `bjobs -a`
      - TTL + minimal refresh gap to throttle refreshes
    File structure:
      {
        </span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="s">: { </span><span class="sh">"</span><span class="s">&lt;jobid&gt;</span><span class="sh">"</span><span class="s">: {</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">RUN</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="s">: 169...}, ... },
        </span><span class="sh">"</span><span class="s">jobs_meta</span><span class="sh">"</span><span class="s">: { </span><span class="sh">"</span><span class="s">&lt;jobid&gt;</span><span class="sh">"</span><span class="s">: {</span><span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">submitted_at</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="s">}, ... },
        </span><span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="s">: 169...,
        </span><span class="sh">"</span><span class="s">meta</span><span class="sh">"</span><span class="s">: { </span><span class="sh">"</span><span class="s">refreshed_at</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">2025-...</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">reason</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">ttl_or_miss</span><span class="sh">"</span><span class="s"> }
      }
    </span><span class="sh">"""</span>

    <span class="n">_mem_jobs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">_mem_last_ts</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">_mem_lock</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>  <span class="c1"># protect _mem_jobs/_mem_last_ts
</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cache_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">full_ttl_s</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">min_refresh_gap_s</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cache_file</span> <span class="o">=</span> <span class="n">cache_file</span>
        <span class="n">self</span><span class="p">.</span><span class="n">full_ttl_s</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">full_ttl_s</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">min_refresh_gap_s</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">min_refresh_gap_s</span><span class="p">)</span>
        <span class="nf">ensure_dir</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">cache_file</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">cache_file</span><span class="p">):</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">cache_file</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">({</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">:</span> <span class="p">{},</span> <span class="sh">"</span><span class="s">jobs_meta</span><span class="sh">"</span><span class="p">:</span> <span class="p">{},</span> <span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="sh">"</span><span class="s">meta</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}},</span> <span class="n">f</span><span class="p">)</span>

    <span class="c1"># ---------- file lock helpers ----------
</span>    <span class="k">def</span> <span class="nf">_lock_fd</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">nonblock</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
        <span class="n">fh</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">a+</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fcntl</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fcntl</span><span class="p">.</span><span class="nf">flock</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">fcntl</span><span class="p">.</span><span class="n">LOCK_EX</span> <span class="o">|</span> <span class="p">(</span><span class="n">fcntl</span><span class="p">.</span><span class="n">LOCK_NB</span> <span class="k">if</span> <span class="n">nonblock</span> <span class="k">else</span> <span class="mi">0</span><span class="p">))</span>
            <span class="k">except</span> <span class="nb">BlockingIOError</span><span class="p">:</span>
                <span class="n">fh</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
                <span class="k">return</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="n">fh</span>

    <span class="k">def</span> <span class="nf">_unlock_fd</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">fh</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fh</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">fcntl</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fcntl</span><span class="p">.</span><span class="nf">flock</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">fcntl</span><span class="p">.</span><span class="n">LOCK_UN</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fh</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="c1"># ---------- file I/O ----------
</span>    <span class="k">def</span> <span class="nf">_read_file</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cache_file</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">:</span> <span class="p">{},</span> <span class="sh">"</span><span class="s">jobs_meta</span><span class="sh">"</span><span class="p">:</span> <span class="p">{},</span> <span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="sh">"</span><span class="s">meta</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}}</span>

    <span class="k">def</span> <span class="nf">_write_file_and_update_mem</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">cache_file</span> <span class="o">+</span> <span class="sh">"</span><span class="s">.tmp</span><span class="sh">"</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">cache_file</span><span class="p">)</span>
        <span class="c1"># keep memory in sync
</span>        <span class="nf">type</span><span class="p">(</span><span class="n">self</span><span class="p">).</span><span class="n">_mem_jobs</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
        <span class="nf">type</span><span class="p">(</span><span class="n">self</span><span class="p">).</span><span class="n">_mem_last_ts</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

    <span class="c1"># ---------- public API ----------
</span>    <span class="k">def</span> <span class="nf">seed_submitted</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">job_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">meta</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Immediately make new job IDs visible as SUBMITTED (fresh) in both memory and file.
        Useful for the edge case where another node asks before bjobs snapshot contains them.
        </span><span class="sh">"""</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>

        <span class="c1"># Update memory (fast path)
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_mem_jobs</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_mem_jobs</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_mem_jobs</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">SUBMITTED</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">now</span><span class="p">})</span>

        <span class="c1"># Merge into file (single short critical section)
</span>        <span class="n">fh</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_lock_fd</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cache_file</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_file</span><span class="p">()</span>
            <span class="n">jobs</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">:</span>
                <span class="n">jobs</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">SUBMITTED</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">now</span><span class="p">})</span>
            <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">jobs</span>
            <span class="k">if</span> <span class="n">meta</span><span class="p">:</span>
                <span class="n">jm</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">jobs_meta</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">meta</span><span class="p">:</span>
                        <span class="n">jm</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span>
                <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">jobs_meta</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">jm</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_write_file_and_update_mem</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_unlock_fd</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_maybe_refresh</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">backend</span><span class="p">:</span> <span class="n">LSFBackend</span><span class="p">,</span> <span class="n">reason</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">
        Refresh the full snapshot if nobody else is doing it, and minimal gap is respected.
        Non-blocking: returns False if someone else just refreshed or lock couldn</span><span class="sh">'</span><span class="s">t be taken.
        </span><span class="sh">"""</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_file</span><span class="p">()</span>
        <span class="n">last_ts</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="nf">if </span><span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">last_ts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">min_refresh_gap_s</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="c1"># Take a non-blocking refresh lock
</span>        <span class="n">lock_fh</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_lock_fd</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cache_file</span> <span class="o">+</span> <span class="sh">"</span><span class="s">.refresh.lock</span><span class="sh">"</span><span class="p">,</span> <span class="n">nonblock</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lock_fh</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Double-check gap again after taking the lock
</span>            <span class="n">data2</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_file</span><span class="p">()</span>
            <span class="n">last_ts2</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">data2</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="nf">if </span><span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">last_ts2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">min_refresh_gap_s</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>

            <span class="n">snapshot</span> <span class="o">=</span> <span class="k">await</span> <span class="n">backend</span><span class="p">.</span><span class="nf">full_snapshot</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">snapshot</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>

            <span class="n">now2</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
            <span class="n">fh</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_lock_fd</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cache_file</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">base</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_file</span><span class="p">()</span>
                <span class="n">jobs</span> <span class="o">=</span> <span class="n">base</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">ts</span> <span class="o">=</span> <span class="n">now2</span>
                <span class="k">for</span> <span class="n">jid</span><span class="p">,</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">snapshot</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
                    <span class="n">jobs</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">:</span> <span class="n">st</span><span class="p">,</span> <span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">ts</span><span class="p">}</span>
                <span class="n">base</span><span class="p">[</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">jobs</span>
                <span class="n">base</span><span class="p">[</span><span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">now2</span>
                <span class="n">meta</span> <span class="o">=</span> <span class="n">base</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">meta</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">meta</span><span class="p">[</span><span class="sh">"</span><span class="s">refreshed_at</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">iso_now</span><span class="p">()</span>
                <span class="n">meta</span><span class="p">[</span><span class="sh">"</span><span class="s">reason</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">reason</span>
                <span class="n">base</span><span class="p">[</span><span class="sh">"</span><span class="s">meta</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">meta</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_write_file_and_update_mem</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_unlock_fd</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_unlock_fd</span><span class="p">(</span><span class="n">lock_fh</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_statuses</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">job_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">backend</span><span class="p">:</span> <span class="n">LSFBackend</span><span class="p">,</span> <span class="n">force_on_miss</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">
        Return statuses for the given job_ids using 2-tier cache:
          1) If in-memory snapshot is fresh -&gt; read from memory (no file I/O).
          2) Else read file once and update memory.
          3) If TTL expired or we miss any job_id (and force_on_miss=True),
             try a single non-blocking full refresh (bjobs -a) if the minimal gap elapsed.
        </span><span class="sh">"""</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="c1"># Stage 1: memory fast-path
</span>        <span class="k">async</span> <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_mem_lock</span><span class="p">:</span>
            <span class="n">mem_is_fresh</span> <span class="o">=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">_mem_last_ts</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">full_ttl_s</span>
            <span class="k">if</span> <span class="n">mem_is_fresh</span><span class="p">:</span>
                <span class="n">jobs</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_mem_jobs</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_file</span><span class="p">()</span>
                <span class="nf">type</span><span class="p">(</span><span class="n">self</span><span class="p">).</span><span class="n">_mem_jobs</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                <span class="nf">type</span><span class="p">(</span><span class="n">self</span><span class="p">).</span><span class="n">_mem_last_ts</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                <span class="n">jobs</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_mem_jobs</span>

        <span class="c1"># Helper: check if entry is fresh enough
</span>        <span class="k">def</span> <span class="nf">fresh</span><span class="p">(</span><span class="n">jid</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="n">ent</span> <span class="o">=</span> <span class="n">jobs</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ent</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
            <span class="nf">return </span><span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="nf">float</span><span class="p">(</span><span class="n">ent</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span> <span class="o">&lt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">full_ttl_s</span>

        <span class="n">need_refresh</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">mem_is_fresh</span><span class="p">:</span>
            <span class="n">need_refresh</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="n">force_on_miss</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nf">fresh</span><span class="p">(</span><span class="n">jid</span><span class="p">):</span>
                    <span class="n">need_refresh</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">break</span>

        <span class="k">if</span> <span class="n">need_refresh</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_maybe_refresh</span><span class="p">(</span><span class="n">backend</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="sh">"</span><span class="s">ttl_or_miss</span><span class="sh">"</span><span class="p">)</span>
            <span class="c1"># Read from memory again (already updated if refresh happened)
</span>            <span class="n">jobs</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_mem_jobs</span>

        <span class="k">return</span> <span class="p">{</span><span class="n">jid</span><span class="p">:</span> <span class="n">jobs</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">}</span>

<span class="c1"># ---------------------------- Submission &amp; waiting ----------------------------
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">submit_commands_multiline</span><span class="p">(</span><span class="n">commands</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">cwd</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Submit each line (bsub ...) as an independent command. Limit concurrency by batch_size.
    Returns (job_ids, submissions_detail)
    </span><span class="sh">"""</span>
    <span class="n">sem</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Semaphore</span><span class="p">(</span><span class="nf">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nf">int</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)))</span>
    <span class="n">submissions</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_submit_one</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">sem</span><span class="p">:</span>
            <span class="n">rc</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">run_shell</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">cwd</span><span class="p">)</span>
            <span class="n">jids</span> <span class="o">=</span> <span class="nf">extract_job_ids_from_bsub_output</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">:</span> <span class="n">cmd</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="n">rc</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="n">out</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="n">err</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">:</span> <span class="n">jids</span><span class="p">,</span>
            <span class="p">}</span>

    <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">_submit_one</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">commands</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">as_completed</span><span class="p">(</span><span class="n">tasks</span><span class="p">):</span>
        <span class="n">submissions</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="k">await</span> <span class="n">t</span><span class="p">)</span>
    <span class="n">job_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">jid</span> <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">submissions</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">sub</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])]</span>
    <span class="k">return</span> <span class="n">job_ids</span><span class="p">,</span> <span class="n">submissions</span>

<span class="k">def</span> <span class="nf">make_status_markdown</span><span class="p">(</span><span class="n">job_rows</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="n">width_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Build a compact markdown-like table: JOB ID | STATUS | COMMAND
    (String widget does not render markdown; table is for readability.)
    </span><span class="sh">"""</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">lines</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">| JOB ID | STATUS | COMMAND |</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">lines</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">|------:|:------:|---------|</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">job_rows</span><span class="p">:</span>
        <span class="n">jid</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
        <span class="n">st</span>  <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="nf">_short</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)),</span> <span class="n">width_limit</span><span class="p">)</span>
        <span class="n">lines</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">| `</span><span class="si">{</span><span class="n">jid</span><span class="si">}</span><span class="s">` | `</span><span class="si">{</span><span class="n">st</span><span class="si">}</span><span class="s">` | `</span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s">` |</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

<span class="c1"># ---------------------------- ComfyUI Node ----------------------------
</span>
<span class="k">class</span> <span class="nc">LSFSubmitAndWait</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Async OUTPUT node that:
      - Submits multiple bsub jobs (batch-limited parallelism)
      - Polls statuses using a shared bjobs -a snapshot cache
      - Live-updates a String widget with JOB ID / STATUS / COMMAND
    </span><span class="sh">"""</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">LSF</span><span class="sh">"</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">run</span><span class="sh">"</span>
    <span class="n">OUTPUT_NODE</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">SUPPORTS_ASYNC</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">results_json</span><span class="sh">"</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">commands</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">bsub -q short -J test sleep 3</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">cwd</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">}),</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">optional</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">status_md</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span>
                    <span class="sh">"</span><span class="s">| JOB ID | STATUS | COMMAND |</span><span class="se">\n</span><span class="s">|------:|:------:|---------|</span><span class="se">\n</span><span class="s">(실행 중에 갱신됩니다)</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">cmd_width_limit</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">INT</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="sh">"</span><span class="s">min</span><span class="sh">"</span><span class="p">:</span> <span class="mi">40</span><span class="p">,</span> <span class="sh">"</span><span class="s">max</span><span class="sh">"</span><span class="p">:</span> <span class="mi">200</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">live_update</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">BOOL</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">}),</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">hidden</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="c1"># ComfyUI injects this; we'll use it to target the widget updates
</span>                <span class="sh">"</span><span class="s">node_id</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">UNIQUE_ID</span><span class="sh">"</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span>
                  <span class="n">commands</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                  <span class="n">cwd</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                  <span class="n">status_md</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span><span class="p">,</span>
                  <span class="n">cmd_width_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
                  <span class="n">live_update</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
                  <span class="n">node_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>

        <span class="c1"># ---- 1) Parse inline options &amp; clean command lines ----
</span>        <span class="n">opts</span><span class="p">,</span> <span class="n">lines</span> <span class="o">=</span> <span class="nf">parse_inline_options_and_commands</span><span class="p">(</span><span class="n">commands</span><span class="p">)</span>
        <span class="n">batch_size</span>         <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">opts</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">batch_size</span><span class="sh">"</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
        <span class="n">poll_interval_s</span>    <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">opts</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">poll_interval_s</span><span class="sh">"</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
        <span class="n">full_ttl_s</span>         <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">opts</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">full_ttl_s</span><span class="sh">"</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>                <span class="c1"># snapshot TTL
</span>        <span class="n">min_refresh_gap_s</span>  <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">opts</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">min_refresh_gap_s</span><span class="sh">"</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>           <span class="c1"># min gap between -a
</span>        <span class="n">full_status_cmd</span>    <span class="o">=</span> <span class="n">opts</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">full_status_cmd</span><span class="sh">"</span><span class="p">,</span> <span class="sh">'</span><span class="s">bjobs -a -noheader -o </span><span class="sh">"</span><span class="s">jobid stat</span><span class="sh">"'</span><span class="p">)</span>
        <span class="n">max_wait_s</span>         <span class="o">=</span> <span class="n">opts</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">max_wait_s</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">ui_update_gap_s</span>    <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">opts</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">ui_update_gap_s</span><span class="sh">"</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>         <span class="c1"># throttle UI pushes
</span>        <span class="n">force_on_miss</span>      <span class="o">=</span> <span class="nf">bool</span><span class="p">(</span><span class="n">opts</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">force_refresh_on_miss</span><span class="sh">"</span><span class="p">,</span> <span class="bp">True</span><span class="p">))</span>

        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">max_wait_s</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">max_wait_s</span><span class="p">.</span><span class="nf">isdigit</span><span class="p">():</span>
            <span class="n">max_wait_s</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">max_wait_s</span><span class="p">)</span>

        <span class="c1"># Filter out accidental empty command lines
</span>        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">ln</span> <span class="k">for</span> <span class="n">ln</span> <span class="ow">in</span> <span class="n">lines</span> <span class="k">if</span> <span class="n">ln</span><span class="p">.</span><span class="nf">strip</span><span class="p">()]</span>

        <span class="c1"># ---- 2) Submit jobs (async batch-limited) ----
</span>        <span class="n">submitted_at</span> <span class="o">=</span> <span class="nf">iso_now</span><span class="p">()</span>
        <span class="n">job_ids</span><span class="p">,</span> <span class="n">submissions</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">submit_commands_multiline</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">cwd</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>

        <span class="c1"># Map job_id -&gt; command (for UI &amp; logs)
</span>        <span class="n">jid_to_cmd</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">submissions</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">sub</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="n">jid_to_cmd</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="n">sub</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>

        <span class="c1"># ---- 3) Shared cache &amp; backend ----
</span>        <span class="n">cache_dir</span> <span class="o">=</span> <span class="nf">ensure_dir</span><span class="p">(</span><span class="nf">default_cache_dir</span><span class="p">())</span>
        <span class="n">cache_file</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">status_full_cache.json</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="nc">LSFCache</span><span class="p">(</span><span class="n">cache_file</span><span class="p">,</span> <span class="n">full_ttl_s</span><span class="o">=</span><span class="n">full_ttl_s</span><span class="p">,</span> <span class="n">min_refresh_gap_s</span><span class="o">=</span><span class="n">min_refresh_gap_s</span><span class="p">)</span>
        <span class="n">backend</span> <span class="o">=</span> <span class="nc">LSFBackend</span><span class="p">(</span><span class="n">full_status_cmd</span><span class="o">=</span><span class="n">full_status_cmd</span><span class="p">)</span>

        <span class="c1"># Seed newly submitted jobs to handle "just-submitted not in cache yet" edge
</span>        <span class="k">if</span> <span class="n">job_ids</span><span class="p">:</span>
            <span class="n">meta</span> <span class="o">=</span> <span class="p">{</span><span class="n">jid</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">:</span> <span class="n">jid_to_cmd</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="sh">""</span><span class="p">),</span> <span class="sh">"</span><span class="s">submitted_at</span><span class="sh">"</span><span class="p">:</span> <span class="n">submitted_at</span><span class="p">}</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">}</span>
            <span class="n">cache</span><span class="p">.</span><span class="nf">seed_submitted</span><span class="p">(</span><span class="n">job_ids</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="n">meta</span><span class="p">)</span>

        <span class="c1"># ---- 4) Initial live update (SUBMITTED) ----
</span>        <span class="k">def</span> <span class="nf">push_ui</span><span class="p">(</span><span class="n">rows</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">live_update</span> <span class="ow">and</span> <span class="n">node_id</span><span class="p">:</span>
                <span class="n">table</span> <span class="o">=</span> <span class="nf">make_status_markdown</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">width_limit</span><span class="o">=</span><span class="n">cmd_width_limit</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">PromptServer</span><span class="p">.</span><span class="n">instance</span><span class="p">.</span><span class="nf">send_sync</span><span class="p">(</span>
                        <span class="sh">"</span><span class="s">impact-node-feedback</span><span class="sh">"</span><span class="p">,</span>
                        <span class="p">{</span><span class="sh">"</span><span class="s">node_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">node_id</span><span class="p">,</span> <span class="sh">"</span><span class="s">widget_name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">status_md</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span> <span class="n">table</span><span class="p">}</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>  <span class="c1"># UI update failure should not impact job control
</span>
        <span class="k">if</span> <span class="n">job_ids</span><span class="p">:</span>
            <span class="n">init_rows</span> <span class="o">=</span> <span class="p">[{</span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">jid</span><span class="p">,</span> <span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">SUBMITTED</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">:</span> <span class="n">jid_to_cmd</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="sh">""</span><span class="p">)}</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">]</span>
            <span class="nf">push_ui</span><span class="p">(</span><span class="n">init_rows</span><span class="p">)</span>

        <span class="c1"># ---- 5) Poll loop until all terminal or timeout ----
</span>        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="n">last_ui</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">final_statuses</span> <span class="o">=</span> <span class="p">{</span><span class="n">jid</span><span class="p">:</span> <span class="sh">"</span><span class="s">SUBMITTED</span><span class="sh">"</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">}</span>

        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">statuses</span> <span class="o">=</span> <span class="k">await</span> <span class="n">cache</span><span class="p">.</span><span class="nf">get_statuses</span><span class="p">(</span><span class="n">job_ids</span><span class="p">,</span> <span class="n">backend</span><span class="p">,</span> <span class="n">force_on_miss</span><span class="o">=</span><span class="n">force_on_miss</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">:</span>
                <span class="n">st</span> <span class="o">=</span> <span class="p">(</span><span class="n">statuses</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span> <span class="ow">or</span> <span class="n">final_statuses</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">).</span><span class="nf">upper</span><span class="p">()</span>
                <span class="n">final_statuses</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="n">st</span> <span class="k">if</span> <span class="n">st</span> <span class="k">else</span> <span class="n">final_statuses</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>

            <span class="c1"># Throttled live UI update
</span>            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
            <span class="nf">if </span><span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">last_ui</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">ui_update_gap_s</span><span class="p">:</span>
                <span class="n">rows</span> <span class="o">=</span> <span class="p">[{</span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">jid</span><span class="p">,</span> <span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">:</span> <span class="n">final_statuses</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">N/A</span><span class="sh">"</span><span class="p">,</span>
                         <span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">:</span> <span class="n">jid_to_cmd</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="sh">""</span><span class="p">)}</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">]</span>
                <span class="nf">push_ui</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
                <span class="n">last_ui</span> <span class="o">=</span> <span class="n">now</span>

            <span class="c1"># All terminal?
</span>            <span class="k">if</span> <span class="n">job_ids</span> <span class="ow">and</span> <span class="nf">all</span><span class="p">((</span><span class="n">final_statuses</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="ow">in</span> <span class="n">TERMINAL_STATES</span><span class="p">)</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">):</span>
                <span class="k">break</span>

            <span class="c1"># Timeout?
</span>            <span class="k">if</span> <span class="n">max_wait_s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">max_wait_s</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="nf">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nf">int</span><span class="p">(</span><span class="n">poll_interval_s</span><span class="p">)))</span>

        <span class="n">completed_at</span> <span class="o">=</span> <span class="nf">iso_now</span><span class="p">()</span>
        <span class="n">waited_sec</span> <span class="o">=</span> <span class="nf">round</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">all_done</span> <span class="o">=</span> <span class="p">(</span><span class="n">job_ids</span> <span class="ow">and</span> <span class="nf">all</span><span class="p">((</span><span class="n">final_statuses</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="ow">in</span> <span class="n">TERMINAL_STATES</span><span class="p">)</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">))</span>

        <span class="c1"># Final UI update (non-throttled, shows last state)
</span>        <span class="k">if</span> <span class="n">job_ids</span><span class="p">:</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="p">[{</span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">jid</span><span class="p">,</span> <span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">:</span> <span class="n">final_statuses</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">N/A</span><span class="sh">"</span><span class="p">,</span>
                     <span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">:</span> <span class="n">jid_to_cmd</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="sh">""</span><span class="p">)}</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">]</span>
            <span class="nf">push_ui</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>

        <span class="c1"># ---- 6) Persist a concise run log (optional, handy for auditing) ----
</span>        <span class="n">results_dir</span> <span class="o">=</span> <span class="nf">ensure_dir</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">runs</span><span class="sh">"</span><span class="p">))</span>
        <span class="n">session_tag</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="nf">utcnow</span><span class="p">().</span><span class="nf">strftime</span><span class="p">(</span><span class="sh">"</span><span class="s">%Y%m%d_%H%M%S</span><span class="sh">"</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="sh">"</span><span class="s">_</span><span class="si">{</span><span class="n">os</span><span class="p">.</span><span class="nf">getpid</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">results_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">results_dir</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">result_</span><span class="si">{</span><span class="n">session_tag</span><span class="si">}</span><span class="s">.json</span><span class="sh">"</span><span class="p">)</span>

        <span class="n">failed_submissions</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">:</span> <span class="n">sub</span><span class="p">[</span><span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="n">sub</span><span class="p">[</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="n">sub</span><span class="p">[</span><span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="n">sub</span><span class="p">[</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">],</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">submissions</span>
            <span class="k">if</span> <span class="n">sub</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">sub</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">submitted_at</span><span class="sh">"</span><span class="p">:</span> <span class="n">submitted_at</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">completed_at</span><span class="sh">"</span><span class="p">:</span> <span class="n">completed_at</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">duration_sec</span><span class="sh">"</span><span class="p">:</span> <span class="n">waited_sec</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">:</span> <span class="n">job_ids</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">final_status</span><span class="sh">"</span><span class="p">:</span> <span class="n">final_statuses</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">all_done</span><span class="sh">"</span><span class="p">:</span> <span class="nf">bool</span><span class="p">(</span><span class="n">all_done</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">failed_submissions</span><span class="sh">"</span><span class="p">:</span> <span class="n">failed_submissions</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">cwd</span><span class="sh">"</span><span class="p">:</span> <span class="n">cwd</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">options</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">batch_size</span><span class="sh">"</span><span class="p">:</span> <span class="n">batch_size</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">poll_interval_s</span><span class="sh">"</span><span class="p">:</span> <span class="n">poll_interval_s</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">full_ttl_s</span><span class="sh">"</span><span class="p">:</span> <span class="n">full_ttl_s</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">min_refresh_gap_s</span><span class="sh">"</span><span class="p">:</span> <span class="n">min_refresh_gap_s</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">full_status_cmd</span><span class="sh">"</span><span class="p">:</span> <span class="n">full_status_cmd</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">max_wait_s</span><span class="sh">"</span><span class="p">:</span> <span class="n">max_wait_s</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">ui_update_gap_s</span><span class="sh">"</span><span class="p">:</span> <span class="n">ui_update_gap_s</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">force_refresh_on_miss</span><span class="sh">"</span><span class="p">:</span> <span class="n">force_on_miss</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">results_file</span><span class="sh">"</span><span class="p">:</span> <span class="n">results_path</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">results_path</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># ---- 7) Return outputs ----
</span>        <span class="n">job_ids_str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">job_ids</span><span class="p">)</span>
        <span class="n">results_json_str</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">job_ids_str</span><span class="p">,</span> <span class="n">results_json_str</span><span class="p">)</span>

<span class="c1"># ---------------------------- Node registration ----------------------------
</span>
<span class="n">NODE_CLASS_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">LSFSubmitAndWait</span><span class="sh">"</span><span class="p">:</span> <span class="n">LSFSubmitAndWait</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">NODE_DISPLAY_NAME_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">LSFSubmitAndWait</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">LSF: Submit &amp; Wait</span><span class="sh">"</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div>

        
      </section>

      <footer class="page__meta">
        
        


  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      <a href="/categories/#comfyui" class="page__taxonomy-item p-category" rel="tag">comfyui</a>
    
    </span>
  </p>


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time class="dt-published" datetime="2025-10-10T19:44:39+09:00">2025-10-10</time></p>

      </footer>

      

      
  <nav class="pagination">
    
      <a href="/python/python-async-subprocess/" class="pagination--pager" title="Python 비동기 서브프로세스 실행">Previous</a>
    
    
      <a href="/2025-08-19-python-repr-vs-str/" class="pagination--pager" title="">Next</a>
    
  </nav>


    </div>

    
  </article>

  
  
    
<div class="page__related">
  
  <h2 class="page__related-title">You may also enjoy</h2>
  <div class="grid__wrapper">
    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/2025-08-19-python-repr-vs-str/" rel="permalink">
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <!-- hvppyarchive: remove date icon
        <i class="far fa-calendar-alt" aria-hidden="true"></i> 
        -->
        
        <time datetime="2025-10-10T19:44:45+09:00">2025-10-10</time>
      </span>
    

    

    
  </p>


    <p class="archive__item-excerpt" itemprop="description">
</p>
  </article>
</div>

    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/python/python-async-subprocess/" rel="permalink">Python 비동기 서브프로세스 실행
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <!-- hvppyarchive: remove date icon
        <i class="far fa-calendar-alt" aria-hidden="true"></i> 
        -->
        
        <time datetime="2025-10-10T14:05:19+09:00">2025-10-10</time>
      </span>
    

    

    
  </p>


    <p class="archive__item-excerpt" itemprop="description">

</p>
  </article>
</div>

    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/comfyui/async-request-cancel/" rel="permalink">Async request 취소 처리
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <!-- hvppyarchive: remove date icon
        <i class="far fa-calendar-alt" aria-hidden="true"></i> 
        -->
        
        <time datetime="2025-10-10T11:53:02+09:00">2025-10-10</time>
      </span>
    

    

    
  </p>


    <p class="archive__item-excerpt" itemprop="description">

</p>
  </article>
</div>

    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/python/vscode-python-runtime-path/" rel="permalink">VS Code 경고 해결법
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <!-- hvppyarchive: remove date icon
        <i class="far fa-calendar-alt" aria-hidden="true"></i> 
        -->
        
        <time datetime="2025-10-10T10:52:16+09:00">2025-10-10</time>
      </span>
    

    

    
  </p>


    <p class="archive__item-excerpt" itemprop="description">

</p>
  </article>
</div>

    
  </div>
</div>

  
  
</div>

      
    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';" role="search">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        

<div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
      
        
      
        
      
        
      
        
      
        
      
    

    
  </ul>
</div>


<div class="page__footer-copyright">&copy; 2013 - 2025 <a href="https://hvppyarchive.github.io">ARCHIVE</a>. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/jekyll-themes/minimal-mistakes/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>






  </body>
</html>
